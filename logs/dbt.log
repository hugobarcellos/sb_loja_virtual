[0m01:00:57.656514 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b208c2d3-72f3-4f8d-99dc-0ea300622f74', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002443EC02550>]}
[0m01:00:57.656514 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (363.0 rows, 53.3 KiB processed)[0m in 2.86s]
[0m01:00:57.656514 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m01:00:57.672272 [debug] [MainThread]: Connection 'master' was properly closed.
[0m01:00:57.672272 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m01:00:57.672272 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m01:00:57.672272 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m01:00:57.672272 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m01:00:57.672272 [info ] [MainThread]: 
[0m01:00:57.672272 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.82 seconds (4.82s).
[0m01:00:57.672272 [debug] [MainThread]: Command end result
[0m01:00:57.688083 [info ] [MainThread]: 
[0m01:00:57.688083 [info ] [MainThread]: [32mCompleted successfully[0m
[0m01:00:57.688083 [info ] [MainThread]: 
[0m01:00:57.688083 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m01:00:57.688083 [debug] [MainThread]: Command `dbt run` succeeded at 01:00:57.688083 after 5.86 seconds
[0m01:00:57.688083 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002443A227430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244391AA310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244391B5BE0>]}
[0m01:00:57.688083 [debug] [MainThread]: Flushing usage events
[0m02:00:05.019767 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9293B4400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92835F640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92835FAC0>]}


============================== 02:00:05.019767 | c76b504b-5772-474f-b70b-462de7a796b5 ==============================
[0m02:00:05.019767 [info ] [MainThread]: Running with dbt=1.7.4
[0m02:00:05.019767 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --exclude tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m02:00:05.847389 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92B51AB20>]}
[0m02:00:05.895014 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92CB1CE50>]}
[0m02:00:05.895014 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m02:00:05.910939 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m02:00:05.959221 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:00:05.959221 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:00:05.959221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92CCFEE20>]}
[0m02:00:05.975414 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92CC3F040>]}
[0m02:00:05.975414 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m02:00:05.975414 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92CAA9F70>]}
[0m02:00:05.975414 [info ] [MainThread]: 
[0m02:00:05.975414 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m02:00:05.975414 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m02:00:05.975414 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:05.975414 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m02:00:05.991469 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:06.838604 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:07.490665 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m02:00:07.490665 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m02:00:07.490665 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:07.490665 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:08.115716 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m02:00:08.131592 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:08.147784 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m02:00:08.147784 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:08.773673 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92CAA94C0>]}
[0m02:00:08.773673 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m02:00:08.773673 [info ] [MainThread]: 
[0m02:00:08.773673 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:08.773673 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m02:00:08.773673 [info ] [Thread-1  ]: 1 of 13 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m02:00:08.789843 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m02:00:08.789843 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:08.773673 [info ] [Thread-2  ]: 2 of 13 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m02:00:08.789843 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m02:00:08.789843 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m02:00:08.789843 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m02:00:08.805897 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m02:00:08.805897 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 02:00:08.789843 => 02:00:08.805897
[0m02:00:08.805897 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:08.805897 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 02:00:08.789843 => 02:00:08.805897
[0m02:00:08.805897 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m02:00:08.821762 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m02:00:08.841218 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m02:00:08.841218 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m02:00:08.843230 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m02:00:08.853244 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m02:00:08.869179 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m02:00:09.692413 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ca8380cd-65ac-4d0f-b85f-720f88c9b0de&page=queryresults
[0m02:00:09.692413 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5550a23f-d74e-4bed-9924-81f2528be5e0&page=queryresults
[0m02:00:10.153882 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 02:00:08.805897 => 02:00:10.153882
[0m02:00:10.153882 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92DD90340>]}
[0m02:00:10.153882 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 02:00:08.805897 => 02:00:10.153882
[0m02:00:10.153882 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92DD80CD0>]}
[0m02:00:10.153882 [info ] [Thread-1  ]: 1 of 13 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m02:00:10.153882 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:10.153882 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m02:00:10.153882 [info ] [Thread-2  ]: 2 of 13 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m02:00:10.169920 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m02:00:10.169920 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m02:00:10.169920 [info ] [Thread-1  ]: 3 of 13 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m02:00:10.169920 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m02:00:10.169920 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m02:00:10.169920 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m02:00:10.169920 [info ] [Thread-2  ]: 4 of 13 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m02:00:10.169920 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m02:00:10.169920 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m02:00:10.185958 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m02:00:10.185958 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 02:00:10.169920 => 02:00:10.185958
[0m02:00:10.185958 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m02:00:10.185958 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m02:00:10.185958 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 02:00:10.169920 => 02:00:10.185958
[0m02:00:10.185958 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m02:00:10.201911 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m02:00:10.201911 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:10.201911 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m02:00:10.233795 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:10.233795 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m02:00:10.940866 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b00e7b0f-cadf-4e29-9aab-b9a339f0d0ae&page=queryresults
[0m02:00:10.972745 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bba94dcc-7fbe-47a5-ba57-ec9650684bbc&page=queryresults
[0m02:00:11.361040 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 02:00:10.185958 => 02:00:11.361040
[0m02:00:11.361040 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92DDF56D0>]}
[0m02:00:11.361040 [info ] [Thread-2  ]: 4 of 13 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m02:00:11.376937 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m02:00:11.376937 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m02:00:11.376937 [info ] [Thread-2  ]: 5 of 13 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m02:00:11.376937 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m02:00:11.376937 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m02:00:11.376937 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m02:00:11.376937 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 02:00:11.376937 => 02:00:11.376937
[0m02:00:11.376937 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m02:00:11.392866 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m02:00:11.392866 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:11.392866 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m02:00:11.424939 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 02:00:10.185958 => 02:00:11.424939
[0m02:00:11.424939 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92DDDE7C0>]}
[0m02:00:11.424939 [info ] [Thread-1  ]: 3 of 13 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m02:00:11.424939 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m02:00:11.424939 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m02:00:11.424939 [info ] [Thread-1  ]: 6 of 13 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m02:00:11.440931 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m02:00:11.440931 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m02:00:11.440931 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m02:00:11.440931 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 02:00:11.440931 => 02:00:11.440931
[0m02:00:11.440931 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m02:00:11.456823 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m02:00:11.456823 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:11.456823 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m02:00:12.298271 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:48b0a02f-b30b-4ae5-b62b-85ee0182edad&page=queryresults
[0m02:00:12.298271 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3ee5fc2c-49b1-4dca-b1f1-ddb3ff71755f&page=queryresults
[0m02:00:12.683882 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 02:00:11.440931 => 02:00:12.683882
[0m02:00:12.683882 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92DD806D0>]}
[0m02:00:12.683882 [info ] [Thread-1  ]: 6 of 13 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m02:00:12.683882 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m02:00:12.699999 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m02:00:12.699999 [info ] [Thread-1  ]: 7 of 13 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m02:00:12.699999 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_pedido)
[0m02:00:12.699999 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m02:00:12.699999 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m02:00:12.715031 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 02:00:12.699999 => 02:00:12.699999
[0m02:00:12.715031 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m02:00:12.716038 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m02:00:12.716038 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:12.716038 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_pedido
        ,nullif(trim(total), '')                     as vl_total_item
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m02:00:12.747723 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 02:00:11.376937 => 02:00:12.747723
[0m02:00:12.747723 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92DD72FD0>]}
[0m02:00:12.763783 [info ] [Thread-2  ]: 5 of 13 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m02:00:12.763783 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m02:00:12.763783 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m02:00:12.763783 [info ] [Thread-2  ]: 8 of 13 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m02:00:12.763783 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m02:00:12.763783 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m02:00:12.763783 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m02:00:12.763783 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 02:00:12.763783 => 02:00:12.763783
[0m02:00:12.763783 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m02:00:12.779761 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m02:00:12.779761 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:12.779761 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m02:00:13.485549 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:130a4e8d-0ea1-4e38-8cdd-1716200b4548&page=queryresults
[0m02:00:13.598502 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2d80f9a4-0ce9-4565-91c0-c58187142f2e&page=queryresults
[0m02:00:13.878604 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 02:00:12.716038 => 02:00:13.878604
[0m02:00:13.878604 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92DE5D640>]}
[0m02:00:13.878604 [info ] [Thread-1  ]: 7 of 13 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m02:00:13.878604 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m02:00:13.988683 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 02:00:12.763783 => 02:00:13.988683
[0m02:00:13.988683 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92DE8DF40>]}
[0m02:00:13.988683 [info ] [Thread-2  ]: 8 of 13 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m02:00:13.988683 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m02:00:13.988683 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m02:00:13.988683 [info ] [Thread-1  ]: 9 of 13 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m02:00:14.000696 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.dm_produto)
[0m02:00:14.002877 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m02:00:14.002877 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m02:00:14.002877 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 02:00:14.002877 => 02:00:14.002877
[0m02:00:14.002877 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m02:00:14.016822 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:14.642943 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m02:00:14.642943 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m02:00:15.369063 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:02d605e1-a860-4d1a-bfc2-5c43d98533d7&page=queryresults
[0m02:00:17.911974 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 02:00:14.002877 => 02:00:17.900918
[0m02:00:17.911974 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92DDA23A0>]}
[0m02:00:17.911974 [info ] [Thread-1  ]: 9 of 13 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 3.91s]
[0m02:00:17.911974 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m02:00:17.911974 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m02:00:17.916113 [info ] [Thread-2  ]: 10 of 13 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m02:00:17.918128 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m02:00:17.918128 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m02:00:17.924164 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m02:00:17.927928 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 02:00:17.918128 => 02:00:17.927928
[0m02:00:17.927928 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m02:00:17.931953 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:18.585556 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m02:00:18.587799 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m02:00:19.340795 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9adc95fd-42a4-4b4f-b625-75b3d3ffaeda&page=queryresults
[0m02:00:21.555901 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 02:00:17.927928 => 02:00:21.555901
[0m02:00:21.557922 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92DDA23A0>]}
[0m02:00:21.557922 [info ] [Thread-2  ]: 10 of 13 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 3.64s]
[0m02:00:21.559935 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m02:00:21.561948 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m02:00:21.561948 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m02:00:21.561948 [info ] [Thread-1  ]: 11 of 13 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m02:00:21.563960 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m02:00:21.565973 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m02:00:21.563960 [info ] [Thread-2  ]: 12 of 13 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m02:00:21.567986 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m02:00:21.567986 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m02:00:21.580263 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m02:00:21.580263 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m02:00:21.586225 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 02:00:21.580263 => 02:00:21.586225
[0m02:00:21.586225 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m02:00:21.586225 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:21.634397 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 02:00:21.565973 => 02:00:21.634397
[0m02:00:21.634397 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m02:00:21.634397 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:22.259575 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m02:00:22.259575 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m02:00:22.270409 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m02:00:22.274439 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m02:00:22.651534 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:52ed9708-c011-4aa1-8f6d-201363122613&page=queryresults
[0m02:00:22.872900 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5eda564c-3da2-4443-99e3-0efc0bb77ace&page=queryresults
[0m02:00:24.262255 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 02:00:21.586225 => 02:00:24.262255
[0m02:00:24.262255 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92DF281F0>]}
[0m02:00:24.262255 [info ] [Thread-2  ]: 12 of 13 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 77.2 KiB processed)[0m in 2.69s]
[0m02:00:24.278285 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m02:00:24.278285 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m02:00:24.278285 [info ] [Thread-2  ]: 13 of 13 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m02:00:24.278285 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_preco_produto)
[0m02:00:24.278285 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m02:00:24.278285 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m02:00:24.278285 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 02:00:24.278285 => 02:00:24.278285
[0m02:00:24.278285 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m02:00:24.294248 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:24.839703 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 02:00:21.634397 => 02:00:24.839703
[0m02:00:24.839703 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92DF219D0>]}
[0m02:00:24.839703 [info ] [Thread-1  ]: 11 of 13 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 3.28s]
[0m02:00:24.839703 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m02:00:24.953880 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m02:00:24.953880 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m02:00:25.560805 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b509c4a1-31dc-4eff-ba44-2d17abb0fe7f&page=queryresults
[0m02:00:28.118886 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 02:00:24.278285 => 02:00:28.118886
[0m02:00:28.120899 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c76b504b-5772-474f-b70b-462de7a796b5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92DD862E0>]}
[0m02:00:28.120899 [info ] [Thread-2  ]: 13 of 13 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 73.7 KiB processed)[0m in 3.84s]
[0m02:00:28.122913 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m02:00:28.125824 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:00:28.125824 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m02:00:28.125824 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m02:00:28.127837 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m02:00:28.127837 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m02:00:28.127837 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m02:00:28.127837 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m02:00:28.127837 [info ] [MainThread]: 
[0m02:00:28.129849 [info ] [MainThread]: Finished running 8 view models, 5 table models in 0 hours 0 minutes and 22.15 seconds (22.15s).
[0m02:00:28.131862 [debug] [MainThread]: Command end result
[0m02:00:28.155649 [info ] [MainThread]: 
[0m02:00:28.155649 [info ] [MainThread]: [32mCompleted successfully[0m
[0m02:00:28.157388 [info ] [MainThread]: 
[0m02:00:28.157388 [info ] [MainThread]: Done. PASS=13 WARN=0 ERROR=0 SKIP=0 TOTAL=13
[0m02:00:28.157388 [debug] [MainThread]: Command `dbt run` succeeded at 02:00:28.157388 after 23.21 seconds
[0m02:00:28.157388 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9293B4400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92C9C5CD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F92CD0BBB0>]}
[0m02:00:28.157388 [debug] [MainThread]: Flushing usage events
[0m02:00:31.851712 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218FB653400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218FA5D7910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218FA5D7B80>]}


============================== 02:00:31.867548 | de793aa8-a7b7-41fa-ae27-4174550222ad ==============================
[0m02:00:31.867548 [info ] [MainThread]: Running with dbt=1.7.4
[0m02:00:31.867548 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt snapshot', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m02:00:32.678654 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'de793aa8-a7b7-41fa-ae27-4174550222ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218FA5B9F70>]}
[0m02:00:32.758077 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'de793aa8-a7b7-41fa-ae27-4174550222ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218FECBB040>]}
[0m02:00:32.773873 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m02:00:32.776854 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m02:00:32.868782 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:00:32.868782 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:00:32.884613 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'de793aa8-a7b7-41fa-ae27-4174550222ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218FEF8D940>]}
[0m02:00:32.900261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'de793aa8-a7b7-41fa-ae27-4174550222ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218FEDE3460>]}
[0m02:00:32.900261 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m02:00:32.900261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'de793aa8-a7b7-41fa-ae27-4174550222ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218FEDE36A0>]}
[0m02:00:32.906077 [info ] [MainThread]: 
[0m02:00:32.906077 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m02:00:32.906077 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m02:00:32.906077 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:33.603081 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m02:00:33.603081 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m02:00:33.603081 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:33.603081 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:34.867742 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m02:00:34.867742 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:35.045537 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m02:00:35.045537 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:37.813856 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'de793aa8-a7b7-41fa-ae27-4174550222ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218FED3BF10>]}
[0m02:00:37.813856 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m02:00:37.813856 [info ] [MainThread]: 
[0m02:00:37.823096 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m02:00:37.823096 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m02:00:37.823096 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m02:00:37.823096 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m02:00:37.841091 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 02:00:37.823096 => 02:00:37.841091
[0m02:00:37.841091 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m02:00:37.903257 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m02:00:37.903257 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m02:00:38.823241 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fccba26d-0387-40d6-bfb5-ecf0cdaa4d6c&page=queryresults
[0m02:00:41.203855 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m02:00:41.663912 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:be8a11e6-433a-4b36-b2b0-cd19a1a3e8ab&page=queryresults
[0m02:00:44.051400 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m02:00:44.732061 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m02:00:44.736083 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m02:00:45.191158 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4f7bdfc8-d76d-4b68-8862-914d1ead8218&page=queryresults
[0m02:00:47.425170 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 02:00:37.841091 => 02:00:47.425170
[0m02:00:47.427186 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de793aa8-a7b7-41fa-ae27-4174550222ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218800114F0>]}
[0m02:00:47.427186 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 65.3 KiB processed)[0m in 9.60s]
[0m02:00:47.429197 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m02:00:47.429197 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:00:47.429197 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m02:00:47.429197 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m02:00:47.429197 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m02:00:47.429197 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m02:00:47.429197 [info ] [MainThread]: 
[0m02:00:47.429197 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 14.52 seconds (14.52s).
[0m02:00:47.429197 [debug] [MainThread]: Command end result
[0m02:00:47.449137 [info ] [MainThread]: 
[0m02:00:47.449137 [info ] [MainThread]: [32mCompleted successfully[0m
[0m02:00:47.449137 [info ] [MainThread]: 
[0m02:00:47.449137 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m02:00:47.449137 [debug] [MainThread]: Command `dbt snapshot` succeeded at 02:00:47.449137 after 15.66 seconds
[0m02:00:47.449137 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218FB653400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218FECBB040>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218FED3B7C0>]}
[0m02:00:47.461204 [debug] [MainThread]: Flushing usage events
[0m02:00:51.966893 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC3C53430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC2BD06D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC2BD0E20>]}


============================== 02:00:51.966893 | f92e1bcc-701f-415d-8cbb-ecc4d1c0cd4e ==============================
[0m02:00:51.966893 [info ] [MainThread]: Running with dbt=1.7.4
[0m02:00:51.966893 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m02:00:52.794001 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f92e1bcc-701f-415d-8cbb-ecc4d1c0cd4e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC2BC5940>]}
[0m02:00:52.857612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f92e1bcc-701f-415d-8cbb-ecc4d1c0cd4e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC72C1AC0>]}
[0m02:00:52.857612 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m02:00:52.873525 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m02:00:52.921282 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:00:52.921282 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:00:52.921282 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f92e1bcc-701f-415d-8cbb-ecc4d1c0cd4e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC757EEE0>]}
[0m02:00:52.937153 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f92e1bcc-701f-415d-8cbb-ecc4d1c0cd4e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC73E7D00>]}
[0m02:00:52.937153 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m02:00:52.937153 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f92e1bcc-701f-415d-8cbb-ecc4d1c0cd4e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC73E7E50>]}
[0m02:00:52.937153 [info ] [MainThread]: 
[0m02:00:52.937153 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m02:00:52.937153 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m02:00:52.937153 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:53.714558 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m02:00:53.714558 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m02:00:53.714558 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:53.714558 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:54.314056 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m02:00:54.324705 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m02:00:54.324705 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:54.324705 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:54.936381 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f92e1bcc-701f-415d-8cbb-ecc4d1c0cd4e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC7310550>]}
[0m02:00:54.936381 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m02:00:54.936381 [info ] [MainThread]: 
[0m02:00:54.936381 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m02:00:54.936381 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m02:00:54.952401 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m02:00:54.952401 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m02:00:54.952401 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m02:00:54.952401 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 02:00:54.952401 => 02:00:54.952401
[0m02:00:54.952401 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m02:00:54.968477 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m02:00:55.565884 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m02:00:55.565884 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m02:00:55.951505 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b24ada77-2041-4cff-9480-f1311d22d5ba&page=queryresults
[0m02:00:57.926503 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 02:00:54.952401 => 02:00:57.926503
[0m02:00:57.926503 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f92e1bcc-701f-415d-8cbb-ecc4d1c0cd4e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC86249D0>]}
[0m02:00:57.926503 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (363.0 rows, 53.3 KiB processed)[0m in 2.97s]
[0m02:00:57.926503 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m02:00:57.926503 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:00:57.942301 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m02:00:57.942301 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m02:00:57.942301 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m02:00:57.942301 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m02:00:57.942301 [info ] [MainThread]: 
[0m02:00:57.942301 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.01 seconds (5.01s).
[0m02:00:57.942301 [debug] [MainThread]: Command end result
[0m02:00:57.958479 [info ] [MainThread]: 
[0m02:00:57.958479 [info ] [MainThread]: [32mCompleted successfully[0m
[0m02:00:57.958479 [info ] [MainThread]: 
[0m02:00:57.958479 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m02:00:57.958479 [debug] [MainThread]: Command `dbt run` succeeded at 02:00:57.958479 after 6.07 seconds
[0m02:00:57.958479 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC3C53430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC8619E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029BC7350F10>]}
[0m02:00:57.958479 [debug] [MainThread]: Flushing usage events
[0m03:00:04.797195 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEA3C33D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AE93482E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AE9348760>]}


============================== 03:00:04.811684 | 85b78e30-30ff-4835-9375-9cd7b2a67bde ==============================
[0m03:00:04.811684 [info ] [MainThread]: Running with dbt=1.7.4
[0m03:00:04.811684 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --exclude tag:snaps', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m03:00:05.638504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEC50EAF0>]}
[0m03:00:05.701836 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AECD09430>]}
[0m03:00:05.701836 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m03:00:05.701836 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m03:00:05.749692 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m03:00:05.749692 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m03:00:05.749692 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEDCEEB20>]}
[0m03:00:05.765491 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEDC2E7C0>]}
[0m03:00:05.765491 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m03:00:05.765491 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEDC2E8B0>]}
[0m03:00:05.765491 [info ] [MainThread]: 
[0m03:00:05.765491 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m03:00:05.780900 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:00:05.780900 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:05.780900 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:00:05.796693 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:06.778880 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:07.444426 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m03:00:07.444426 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:07.444426 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m03:00:07.444426 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:08.112406 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m03:00:08.112406 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m03:00:08.128514 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:08.128514 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:08.755731 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEDD3A730>]}
[0m03:00:08.755731 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m03:00:08.755731 [info ] [MainThread]: 
[0m03:00:08.755731 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:08.755731 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m03:00:08.755731 [info ] [Thread-1  ]: 1 of 13 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m03:00:08.755731 [info ] [Thread-2  ]: 2 of 13 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m03:00:08.771571 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m03:00:08.771571 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m03:00:08.755731 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m03:00:08.771571 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m03:00:08.787706 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:08.787706 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m03:00:08.787706 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 03:00:08.771571 => 03:00:08.787706
[0m03:00:08.787706 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m03:00:08.787706 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 03:00:08.787706 => 03:00:08.787706
[0m03:00:08.803663 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:08.819517 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m03:00:08.841385 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m03:00:08.841385 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m03:00:08.843393 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m03:00:08.845399 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m03:00:08.867488 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m03:00:09.592452 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f72105cd-65b2-4ae7-9621-3a1849bb46dd&page=queryresults
[0m03:00:09.601600 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d6d36da6-5a59-47a0-a200-40d1cc2db076&page=queryresults
[0m03:00:10.041379 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 03:00:08.803663 => 03:00:10.041379
[0m03:00:10.041379 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 03:00:08.787706 => 03:00:10.041379
[0m03:00:10.057392 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEDD6D670>]}
[0m03:00:10.057392 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEED9D520>]}
[0m03:00:10.057392 [info ] [Thread-1  ]: 1 of 13 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m03:00:10.057392 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:10.057392 [info ] [Thread-2  ]: 2 of 13 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m03:00:10.057392 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m03:00:10.057392 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m03:00:10.057392 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m03:00:10.057392 [info ] [Thread-1  ]: 3 of 13 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m03:00:10.057392 [info ] [Thread-2  ]: 4 of 13 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m03:00:10.057392 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m03:00:10.057392 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m03:00:10.057392 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m03:00:10.073477 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m03:00:10.073477 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m03:00:10.073477 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m03:00:10.073477 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 03:00:10.073477 => 03:00:10.073477
[0m03:00:10.073477 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m03:00:10.089668 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 03:00:10.073477 => 03:00:10.073477
[0m03:00:10.089668 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m03:00:10.089668 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m03:00:10.101244 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m03:00:10.101244 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:10.105654 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m03:00:10.107668 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:10.121631 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m03:00:10.845381 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:58e97a7f-e4b1-4904-9f72-6245d70fc0b6&page=queryresults
[0m03:00:10.878564 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:47bc0a98-bd6c-4c2b-a86c-43899466220a&page=queryresults
[0m03:00:11.261484 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 03:00:10.089668 => 03:00:11.261484
[0m03:00:11.261484 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEED61EB0>]}
[0m03:00:11.261484 [info ] [Thread-2  ]: 4 of 13 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m03:00:11.261484 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m03:00:11.261484 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m03:00:11.261484 [info ] [Thread-2  ]: 5 of 13 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m03:00:11.269603 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m03:00:11.269603 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m03:00:11.269603 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m03:00:11.277203 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 03:00:11.269603 => 03:00:11.277203
[0m03:00:11.277203 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m03:00:11.284087 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 03:00:10.089668 => 03:00:11.282075
[0m03:00:11.284087 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEDD5C190>]}
[0m03:00:11.286099 [info ] [Thread-1  ]: 3 of 13 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m03:00:11.286099 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m03:00:11.286099 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m03:00:11.288108 [info ] [Thread-1  ]: 6 of 13 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m03:00:11.293194 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m03:00:11.295205 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m03:00:11.298947 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m03:00:11.300953 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 03:00:11.295205 => 03:00:11.300953
[0m03:00:11.302963 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m03:00:11.306988 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m03:00:11.309096 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m03:00:11.309096 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:11.309096 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:11.309096 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m03:00:11.360282 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m03:00:12.240005 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:69f2e6a6-e501-4a1d-a60f-d1776dc5cf8f&page=queryresults
[0m03:00:12.285217 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c10521b0-7e30-42dc-9d5d-d0ba925da9dd&page=queryresults
[0m03:00:12.658836 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 03:00:11.277203 => 03:00:12.656858
[0m03:00:12.658836 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEDD77B80>]}
[0m03:00:12.660850 [info ] [Thread-2  ]: 5 of 13 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.39s]
[0m03:00:12.660850 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m03:00:12.662862 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m03:00:12.662862 [info ] [Thread-2  ]: 7 of 13 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m03:00:12.664875 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_pedido)
[0m03:00:12.664875 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m03:00:12.668897 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m03:00:12.672661 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 03:00:12.664875 => 03:00:12.670908
[0m03:00:12.673170 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m03:00:12.677193 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m03:00:12.679203 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:12.679203 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_pedido
        ,nullif(trim(total), '')                     as vl_total_item
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m03:00:12.724468 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 03:00:11.302963 => 03:00:12.724468
[0m03:00:12.724468 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEDD5CD60>]}
[0m03:00:12.724468 [info ] [Thread-1  ]: 6 of 13 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.43s]
[0m03:00:12.724468 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m03:00:12.724468 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m03:00:12.724468 [info ] [Thread-1  ]: 8 of 13 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m03:00:12.724468 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m03:00:12.724468 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m03:00:12.740618 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m03:00:12.742624 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 03:00:12.724468 => 03:00:12.742624
[0m03:00:12.742624 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m03:00:12.746473 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m03:00:12.748484 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:12.748484 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m03:00:13.460281 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:20214fd6-80b6-4b7d-b307-d6a794176b90&page=queryresults
[0m03:00:13.688015 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b0a6ff79-91d1-4581-9540-907f30940f9c&page=queryresults
[0m03:00:13.889263 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 03:00:12.673170 => 03:00:13.889263
[0m03:00:13.889263 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEEEAB040>]}
[0m03:00:13.889263 [info ] [Thread-2  ]: 7 of 13 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m03:00:13.889263 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m03:00:14.338200 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 03:00:12.742624 => 03:00:14.336185
[0m03:00:14.338200 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEED74B20>]}
[0m03:00:14.340215 [info ] [Thread-1  ]: 8 of 13 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.61s]
[0m03:00:14.342229 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m03:00:14.342229 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m03:00:14.342229 [info ] [Thread-2  ]: 9 of 13 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m03:00:14.342229 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.dm_produto)
[0m03:00:14.342229 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m03:00:14.342229 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m03:00:14.342229 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 03:00:14.342229 => 03:00:14.342229
[0m03:00:14.342229 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m03:00:14.370321 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:15.010708 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m03:00:15.010708 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m03:00:15.682629 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5a6bf7af-cd4c-48bc-a689-af01ce6f0524&page=queryresults
[0m03:00:18.487804 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 03:00:14.342229 => 03:00:18.487804
[0m03:00:18.487804 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEEE1F190>]}
[0m03:00:18.489818 [info ] [Thread-2  ]: 9 of 13 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 4.15s]
[0m03:00:18.491832 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m03:00:18.491832 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m03:00:18.493845 [info ] [Thread-1  ]: 10 of 13 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m03:00:18.495602 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m03:00:18.495602 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m03:00:18.495602 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m03:00:18.495602 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 03:00:18.495602 => 03:00:18.495602
[0m03:00:18.495602 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m03:00:18.495602 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:19.102733 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m03:00:19.105756 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m03:00:19.799729 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d1a16393-8268-461f-a987-e16bbb0e4f53&page=queryresults
[0m03:00:22.067787 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 03:00:18.495602 => 03:00:22.067787
[0m03:00:22.069834 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEEDCD580>]}
[0m03:00:22.069834 [info ] [Thread-1  ]: 10 of 13 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 3.58s]
[0m03:00:22.071849 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m03:00:22.071849 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m03:00:22.071849 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m03:00:22.071849 [info ] [Thread-2  ]: 11 of 13 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m03:00:22.071849 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m03:00:22.071849 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m03:00:22.083860 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m03:00:22.071849 [info ] [Thread-1  ]: 12 of 13 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m03:00:22.085873 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m03:00:22.087884 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m03:00:22.091908 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m03:00:22.091908 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 03:00:22.087884 => 03:00:22.091908
[0m03:00:22.091908 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m03:00:22.091908 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:22.099856 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 03:00:22.071849 => 03:00:22.091908
[0m03:00:22.099856 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m03:00:22.111150 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:22.734383 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m03:00:22.738410 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m03:00:22.796880 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m03:00:22.796880 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m03:00:23.184345 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:badc32ae-1e86-41a0-8419-51f258c29f99&page=queryresults
[0m03:00:23.377161 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:daeec115-fe98-463d-a23c-d3485eb7c877&page=queryresults
[0m03:00:25.080330 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 03:00:22.091908 => 03:00:25.080330
[0m03:00:25.080330 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEEE7DC10>]}
[0m03:00:25.080330 [info ] [Thread-1  ]: 12 of 13 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 77.2 KiB processed)[0m in 2.99s]
[0m03:00:25.080330 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m03:00:25.080330 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m03:00:25.086678 [info ] [Thread-1  ]: 13 of 13 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m03:00:25.086678 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_preco_produto)
[0m03:00:25.086678 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m03:00:25.095552 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m03:00:25.097563 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 03:00:25.089518 => 03:00:25.097563
[0m03:00:25.097563 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m03:00:25.102126 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:25.626037 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 03:00:22.099856 => 03:00:25.626037
[0m03:00:25.626037 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEEEBFDF0>]}
[0m03:00:25.626037 [info ] [Thread-2  ]: 11 of 13 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 3.55s]
[0m03:00:25.626037 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m03:00:25.724890 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m03:00:25.726904 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m03:00:26.361301 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:440e5ded-365c-4560-904c-79446d75d8ee&page=queryresults
[0m03:00:29.423904 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 03:00:25.097563 => 03:00:29.423904
[0m03:00:29.423904 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85b78e30-30ff-4835-9375-9cd7b2a67bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEEEA6910>]}
[0m03:00:29.423904 [info ] [Thread-1  ]: 13 of 13 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 73.7 KiB processed)[0m in 4.34s]
[0m03:00:29.423904 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m03:00:29.437551 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:00:29.437551 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:00:29.437551 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:00:29.437551 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m03:00:29.437551 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m03:00:29.437551 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m03:00:29.437551 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m03:00:29.437551 [info ] [MainThread]: 
[0m03:00:29.437551 [info ] [MainThread]: Finished running 8 view models, 5 table models in 0 hours 0 minutes and 23.67 seconds (23.67s).
[0m03:00:29.446756 [debug] [MainThread]: Command end result
[0m03:00:29.462246 [info ] [MainThread]: 
[0m03:00:29.462246 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:00:29.464258 [info ] [MainThread]: 
[0m03:00:29.464258 [info ] [MainThread]: Done. PASS=13 WARN=0 ERROR=0 SKIP=0 TOTAL=13
[0m03:00:29.466272 [debug] [MainThread]: Command `dbt run` succeeded at 03:00:29.466272 after 24.72 seconds
[0m03:00:29.466272 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEA3C33D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEEE31280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AEEDB5A00>]}
[0m03:00:29.466272 [debug] [MainThread]: Flushing usage events
[0m03:00:34.020973 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB948E8430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB938639A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB93863D30>]}


============================== 03:00:34.020973 | aacfa61c-e02c-4c98-b7ec-97a6d0a9d1b1 ==============================
[0m03:00:34.020973 [info ] [MainThread]: Running with dbt=1.7.4
[0m03:00:34.020973 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt snapshot', 'send_anonymous_usage_stats': 'True'}
[0m03:00:34.767834 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aacfa61c-e02c-4c98-b7ec-97a6d0a9d1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB93863D90>]}
[0m03:00:34.831885 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aacfa61c-e02c-4c98-b7ec-97a6d0a9d1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB97F490A0>]}
[0m03:00:34.831885 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m03:00:34.847787 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m03:00:34.895483 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m03:00:34.895483 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m03:00:34.895483 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aacfa61c-e02c-4c98-b7ec-97a6d0a9d1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB9821D8B0>]}
[0m03:00:34.911265 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aacfa61c-e02c-4c98-b7ec-97a6d0a9d1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB98070580>]}
[0m03:00:34.911265 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m03:00:34.911265 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aacfa61c-e02c-4c98-b7ec-97a6d0a9d1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB98070550>]}
[0m03:00:34.911265 [info ] [MainThread]: 
[0m03:00:34.911265 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m03:00:34.911265 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:00:34.911265 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:35.664877 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m03:00:35.664877 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m03:00:35.664877 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:35.664877 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:37.344512 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m03:00:37.344512 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:38.260596 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m03:00:38.260596 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:41.403933 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aacfa61c-e02c-4c98-b7ec-97a6d0a9d1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB9821DD00>]}
[0m03:00:41.407328 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m03:00:41.407328 [info ] [MainThread]: 
[0m03:00:41.410168 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m03:00:41.410168 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m03:00:41.414540 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m03:00:41.414540 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m03:00:41.422577 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 03:00:41.416554 => 03:00:41.422577
[0m03:00:41.422577 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m03:00:41.506891 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m03:00:41.508900 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m03:00:42.357183 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f7f34218-4a36-472a-83aa-32819658ba7f&page=queryresults
[0m03:00:43.614258 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m03:00:44.507911 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2cb3487d-0db4-4b7c-8e5e-4d7df81352a7&page=queryresults
[0m03:00:46.902964 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m03:00:47.689492 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m03:00:47.705565 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m03:00:48.153041 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4bb967f4-86d0-41d9-b7fb-fc2ca16c9683&page=queryresults
[0m03:00:50.987101 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 03:00:41.422577 => 03:00:50.987101
[0m03:00:50.989115 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aacfa61c-e02c-4c98-b7ec-97a6d0a9d1b1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB9928BFA0>]}
[0m03:00:50.990128 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 65.3 KiB processed)[0m in 9.57s]
[0m03:00:50.990128 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m03:00:50.993602 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:00:50.993602 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:00:50.996209 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m03:00:50.996209 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m03:00:50.996209 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m03:00:50.996209 [info ] [MainThread]: 
[0m03:00:50.998221 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 16.08 seconds (16.08s).
[0m03:00:50.998221 [debug] [MainThread]: Command end result
[0m03:00:51.008014 [info ] [MainThread]: 
[0m03:00:51.014394 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:00:51.014394 [info ] [MainThread]: 
[0m03:00:51.014394 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:00:51.014394 [debug] [MainThread]: Command `dbt snapshot` succeeded at 03:00:51.014394 after 17.06 seconds
[0m03:00:51.014394 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB948E8430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB97EF1DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AB98296190>]}
[0m03:00:51.019276 [debug] [MainThread]: Flushing usage events
[0m03:00:55.109716 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001305D493460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001305C41F9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001305C41FD30>]}


============================== 03:00:55.109716 | ef186a61-5610-4dc0-8320-1eb64ae227d6 ==============================
[0m03:00:55.109716 [info ] [MainThread]: Running with dbt=1.7.4
[0m03:00:55.109716 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m03:00:55.952932 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ef186a61-5610-4dc0-8320-1eb64ae227d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001305F5DAB80>]}
[0m03:00:56.016974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ef186a61-5610-4dc0-8320-1eb64ae227d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013060B01A30>]}
[0m03:00:56.016974 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m03:00:56.032976 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m03:00:56.080796 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m03:00:56.080796 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m03:00:56.080796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ef186a61-5610-4dc0-8320-1eb64ae227d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013060DBEE50>]}
[0m03:00:56.080796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ef186a61-5610-4dc0-8320-1eb64ae227d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013060CFFA30>]}
[0m03:00:56.080796 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m03:00:56.080796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ef186a61-5610-4dc0-8320-1eb64ae227d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013060CFFAF0>]}
[0m03:00:56.096602 [info ] [MainThread]: 
[0m03:00:56.096602 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m03:00:56.096602 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:00:56.096602 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:56.744186 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m03:00:56.744186 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m03:00:56.744186 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:56.744186 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:57.369350 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m03:00:57.369350 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:57.401169 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m03:00:57.401169 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:58.002753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ef186a61-5610-4dc0-8320-1eb64ae227d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013060B54430>]}
[0m03:00:58.002753 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m03:00:58.002753 [info ] [MainThread]: 
[0m03:00:58.012316 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m03:00:58.012316 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m03:00:58.012316 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m03:00:58.012316 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m03:00:58.028416 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m03:00:58.028416 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 03:00:58.012316 => 03:00:58.028416
[0m03:00:58.028416 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m03:00:58.044189 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m03:00:58.675820 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m03:00:58.675820 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m03:00:59.059897 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:359ced37-42e6-472e-ac08-bbe4436593e2&page=queryresults
[0m03:01:01.876928 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 03:00:58.028416 => 03:01:01.876928
[0m03:01:01.876928 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ef186a61-5610-4dc0-8320-1eb64ae227d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013061E826A0>]}
[0m03:01:01.876928 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (363.0 rows, 53.3 KiB processed)[0m in 3.86s]
[0m03:01:01.876928 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m03:01:01.892972 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:01:01.892972 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:01:01.892972 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m03:01:01.892972 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m03:01:01.892972 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m03:01:01.892972 [info ] [MainThread]: 
[0m03:01:01.892972 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.80 seconds (5.80s).
[0m03:01:01.892972 [debug] [MainThread]: Command end result
[0m03:01:01.916044 [info ] [MainThread]: 
[0m03:01:01.916044 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:01:01.916044 [info ] [MainThread]: 
[0m03:01:01.916044 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:01:01.916044 [debug] [MainThread]: Command `dbt run` succeeded at 03:01:01.916044 after 6.87 seconds
[0m03:01:01.916044 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001305D493460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013060B54D00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013060A7DCD0>]}
[0m03:01:01.916044 [debug] [MainThread]: Flushing usage events
[0m04:00:14.383418 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE9CAE3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE9BA576D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE9BA57E20>]}


============================== 04:00:14.399270 | dff7c267-636b-418e-806f-091bde4d14ba ==============================
[0m04:00:14.399270 [info ] [MainThread]: Running with dbt=1.7.4
[0m04:00:14.399270 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m04:00:15.432670 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE9BA55070>]}
[0m04:00:15.496122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE9BA1FF10>]}
[0m04:00:15.496122 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m04:00:15.528212 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m04:00:18.965214 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:00:18.965214 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m04:00:18.981470 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA040EBB0>]}
[0m04:00:19.013271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA034E8B0>]}
[0m04:00:19.028979 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m04:00:19.028979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA034E910>]}
[0m04:00:19.028979 [info ] [MainThread]: 
[0m04:00:19.028979 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m04:00:19.028979 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:19.028979 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:19.028979 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:19.028979 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:19.911961 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:20.596944 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m04:00:20.596944 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m04:00:20.596944 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:20.596944 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:21.228374 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m04:00:21.228374 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:21.244272 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m04:00:21.260749 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:21.892091 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA01CA430>]}
[0m04:00:21.892091 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m04:00:21.892091 [info ] [MainThread]: 
[0m04:00:21.892091 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:21.892091 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m04:00:21.892091 [info ] [Thread-1  ]: 1 of 13 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m04:00:21.907942 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m04:00:21.907942 [info ] [Thread-2  ]: 2 of 13 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m04:00:21.907942 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:21.907942 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m04:00:21.923955 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m04:00:21.923955 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m04:00:21.923955 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m04:00:21.923955 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 04:00:21.923955 => 04:00:21.923955
[0m04:00:21.923955 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m04:00:21.923955 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 04:00:21.907942 => 04:00:21.923955
[0m04:00:21.939817 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:21.971765 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m04:00:21.987682 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m04:00:21.987682 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m04:00:21.987682 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m04:00:21.987682 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m04:00:22.019799 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m04:00:22.935915 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4a155182-1c28-4578-9105-0dd3e7bbb2c6&page=queryresults
[0m04:00:23.042970 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1f7c14f5-5a9a-4258-8f91-4f7fc1247b76&page=queryresults
[0m04:00:23.422952 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 04:00:21.923955 => 04:00:23.422952
[0m04:00:23.422952 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA048E220>]}
[0m04:00:23.422952 [info ] [Thread-2  ]: 2 of 13 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.52s]
[0m04:00:23.422952 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m04:00:23.422952 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m04:00:23.431836 [info ] [Thread-2  ]: 3 of 13 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m04:00:23.431836 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m04:00:23.431836 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m04:00:23.437868 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m04:00:23.438877 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 04:00:23.433846 => 04:00:23.438877
[0m04:00:23.438877 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m04:00:23.438877 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m04:00:23.438877 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 04:00:21.939817 => 04:00:23.438877
[0m04:00:23.438877 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA14B3370>]}
[0m04:00:23.438877 [info ] [Thread-1  ]: 1 of 13 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.53s]
[0m04:00:23.454750 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:23.455742 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m04:00:23.456757 [info ] [Thread-1  ]: 4 of 13 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m04:00:23.456757 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m04:00:23.456757 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m04:00:23.456757 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m04:00:23.456757 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 04:00:23.456757 => 04:00:23.456757
[0m04:00:23.456757 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m04:00:23.470508 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m04:00:23.470508 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:23.470508 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m04:00:23.495885 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:23.495885 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m04:00:24.343571 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b0a66c5e-de5f-4631-9d96-0938e5e43b4f&page=queryresults
[0m04:00:24.503057 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d2a93fa4-3094-42bc-a818-26921d7403c5&page=queryresults
[0m04:00:24.843787 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 04:00:23.456757 => 04:00:24.843787
[0m04:00:24.843787 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA1595370>]}
[0m04:00:24.843787 [info ] [Thread-1  ]: 4 of 13 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.39s]
[0m04:00:24.843787 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m04:00:24.843787 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m04:00:24.852482 [info ] [Thread-1  ]: 5 of 13 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m04:00:24.852482 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m04:00:24.854495 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m04:00:24.857516 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m04:00:24.857516 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 04:00:24.854495 => 04:00:24.857516
[0m04:00:24.857516 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m04:00:24.874981 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m04:00:24.878317 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:24.878317 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m04:00:24.925014 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 04:00:23.438877 => 04:00:24.925014
[0m04:00:24.937039 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA150CC40>]}
[0m04:00:24.937039 [info ] [Thread-2  ]: 3 of 13 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.51s]
[0m04:00:24.937039 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m04:00:24.942398 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:24.942398 [info ] [Thread-2  ]: 6 of 13 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m04:00:24.942398 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m04:00:24.942398 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:24.942398 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m04:00:24.942398 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 04:00:24.942398 => 04:00:24.942398
[0m04:00:24.952747 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:24.956772 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m04:00:24.958784 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:24.958784 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m04:00:25.623690 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1430850e-a03a-4019-a873-98a12a93834f&page=queryresults
[0m04:00:25.655533 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dad6d4b8-fbef-4fee-8cfc-8c7a7c37cb85&page=queryresults
[0m04:00:26.024602 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 04:00:24.862924 => 04:00:26.024602
[0m04:00:26.024602 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA045CF40>]}
[0m04:00:26.024602 [info ] [Thread-1  ]: 5 of 13 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m04:00:26.040563 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m04:00:26.040563 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m04:00:26.042577 [info ] [Thread-1  ]: 7 of 13 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m04:00:26.042577 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_pedido)
[0m04:00:26.044589 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m04:00:26.048613 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m04:00:26.050623 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 04:00:26.044589 => 04:00:26.050623
[0m04:00:26.050623 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m04:00:26.056545 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m04:00:26.058557 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:26.062238 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 04:00:24.952747 => 04:00:26.062238
[0m04:00:26.064251 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA155ACD0>]}
[0m04:00:26.064251 [info ] [Thread-2  ]: 6 of 13 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m04:00:26.066263 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:26.066263 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m04:00:26.066263 [info ] [Thread-2  ]: 8 of 13 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m04:00:26.066263 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m04:00:26.066263 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m04:00:26.072358 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m04:00:26.077989 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_pedido
        ,nullif(trim(total), '')                     as vl_total_item
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m04:00:26.104121 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 04:00:26.066263 => 04:00:26.104121
[0m04:00:26.120170 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m04:00:26.120170 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m04:00:26.120170 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:26.129019 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m04:00:26.841577 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ba67d7f7-46be-42f8-9c14-0a030bb381d2&page=queryresults
[0m04:00:26.876788 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:855ca8ce-412e-4de5-8e19-8fe6a0cf29cc&page=queryresults
[0m04:00:27.247376 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 04:00:26.050623 => 04:00:27.247376
[0m04:00:27.247376 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA1573F10>]}
[0m04:00:27.247376 [info ] [Thread-1  ]: 7 of 13 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m04:00:27.247376 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m04:00:27.447224 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 04:00:26.120170 => 04:00:27.447224
[0m04:00:27.449238 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA155B100>]}
[0m04:00:27.449238 [info ] [Thread-2  ]: 8 of 13 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.38s]
[0m04:00:27.451251 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m04:00:27.453264 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m04:00:27.453264 [info ] [Thread-1  ]: 9 of 13 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m04:00:27.453264 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.dm_produto)
[0m04:00:27.453264 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m04:00:27.453264 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m04:00:27.453264 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 04:00:27.453264 => 04:00:27.453264
[0m04:00:27.453264 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m04:00:27.479479 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:28.117391 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m04:00:28.117391 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m04:00:28.758313 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dfe63173-63b5-4feb-96af-67bdcf21769a&page=queryresults
[0m04:00:31.246133 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 04:00:27.453264 => 04:00:31.246133
[0m04:00:31.246133 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA15502B0>]}
[0m04:00:31.246133 [info ] [Thread-1  ]: 9 of 13 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 3.79s]
[0m04:00:31.246133 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m04:00:31.246133 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m04:00:31.258114 [info ] [Thread-2  ]: 10 of 13 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m04:00:31.258114 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m04:00:31.260129 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m04:00:31.261887 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m04:00:31.261887 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 04:00:31.260129 => 04:00:31.261887
[0m04:00:31.261887 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m04:00:31.272482 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:31.902884 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m04:00:31.904898 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m04:00:32.554300 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f0b6a240-1b2d-4f70-a3b9-f47341dba5eb&page=queryresults
[0m04:00:37.873672 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 04:00:31.261887 => 04:00:37.873672
[0m04:00:37.873672 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA155CB20>]}
[0m04:00:37.873672 [info ] [Thread-2  ]: 10 of 13 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 6.62s]
[0m04:00:37.873672 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m04:00:37.889832 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m04:00:37.891789 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m04:00:37.891789 [info ] [Thread-1  ]: 11 of 13 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m04:00:37.891789 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m04:00:37.891789 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m04:00:37.891789 [info ] [Thread-2  ]: 12 of 13 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m04:00:37.901091 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m04:00:37.905625 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m04:00:37.910448 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m04:00:37.919357 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m04:00:37.921373 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 04:00:37.905625 => 04:00:37.921373
[0m04:00:37.923782 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m04:00:37.927811 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:37.973154 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 04:00:37.897064 => 04:00:37.973154
[0m04:00:37.973154 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m04:00:37.973154 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:40.283450 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m04:00:40.285466 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m04:00:40.696351 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ca398989-a406-4634-8e53-ed8c0ca2b5ed&page=queryresults
[0m04:00:41.013246 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m04:00:41.015260 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m04:00:41.655627 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cab8f83a-08e8-4886-8178-16b12650e238&page=queryresults
[0m04:00:42.626838 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 04:00:37.923782 => 04:00:42.626838
[0m04:00:42.628852 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA048E220>]}
[0m04:00:42.628852 [info ] [Thread-2  ]: 12 of 13 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 77.2 KiB processed)[0m in 4.73s]
[0m04:00:42.630867 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m04:00:42.630867 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m04:00:42.632881 [info ] [Thread-2  ]: 13 of 13 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m04:00:42.634895 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_preco_produto)
[0m04:00:42.634895 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m04:00:42.640931 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m04:00:42.642942 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 04:00:42.634895 => 04:00:42.642942
[0m04:00:42.642942 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m04:00:42.647423 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:43.277341 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m04:00:43.277341 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m04:00:43.927690 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8751c9ae-e5bd-4900-bd6c-6bf9a84189e7&page=queryresults
[0m04:00:46.315452 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 04:00:37.973154 => 04:00:46.313295
[0m04:00:46.315452 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA155B100>]}
[0m04:00:46.317468 [info ] [Thread-1  ]: 11 of 13 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 8.42s]
[0m04:00:46.317468 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m04:00:46.430767 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 04:00:42.642942 => 04:00:46.430767
[0m04:00:46.432780 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dff7c267-636b-418e-806f-091bde4d14ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA155CB20>]}
[0m04:00:46.432780 [info ] [Thread-2  ]: 13 of 13 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 73.7 KiB processed)[0m in 3.80s]
[0m04:00:46.434791 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m04:00:46.436807 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:00:46.439372 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:00:46.439372 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:00:46.439372 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m04:00:46.439372 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m04:00:46.439372 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m04:00:46.441382 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m04:00:46.441382 [info ] [MainThread]: 
[0m04:00:46.442394 [info ] [MainThread]: Finished running 8 view models, 5 table models in 0 hours 0 minutes and 27.41 seconds (27.41s).
[0m04:00:46.445200 [debug] [MainThread]: Command end result
[0m04:00:46.466807 [info ] [MainThread]: 
[0m04:00:46.473970 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:00:46.473970 [info ] [MainThread]: 
[0m04:00:46.473970 [info ] [MainThread]: Done. PASS=13 WARN=0 ERROR=0 SKIP=0 TOTAL=13
[0m04:00:46.473970 [debug] [MainThread]: Command `dbt run` succeeded at 04:00:46.473970 after 32.24 seconds
[0m04:00:46.478744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE9CAE3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA01A7C70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AEA02184F0>]}
[0m04:00:46.478744 [debug] [MainThread]: Flushing usage events
[0m04:00:50.859289 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE75603460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE74586670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE74586D90>]}


============================== 04:00:50.859289 | e7941a93-b7e9-4c20-8f86-7422c0e5b5c4 ==============================
[0m04:00:50.859289 [info ] [MainThread]: Running with dbt=1.7.4
[0m04:00:50.859289 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m04:00:51.622365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e7941a93-b7e9-4c20-8f86-7422c0e5b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE7774AB80>]}
[0m04:00:51.686304 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e7941a93-b7e9-4c20-8f86-7422c0e5b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE78C5E640>]}
[0m04:00:51.688284 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m04:00:51.694462 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m04:00:51.733849 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:00:51.733849 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m04:00:51.733849 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e7941a93-b7e9-4c20-8f86-7422c0e5b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE78F2DCA0>]}
[0m04:00:51.749732 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e7941a93-b7e9-4c20-8f86-7422c0e5b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE78D859A0>]}
[0m04:00:51.749732 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m04:00:51.749732 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7941a93-b7e9-4c20-8f86-7422c0e5b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE78D85A00>]}
[0m04:00:51.749732 [info ] [MainThread]: 
[0m04:00:51.749732 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m04:00:51.749732 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:51.749732 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:52.455389 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m04:00:52.455389 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m04:00:52.455389 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:52.455389 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:53.210698 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m04:00:53.226674 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:53.354334 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m04:00:53.354334 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:53.933338 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7941a93-b7e9-4c20-8f86-7422c0e5b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE78CC8A30>]}
[0m04:00:53.933338 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m04:00:53.933338 [info ] [MainThread]: 
[0m04:00:53.948982 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m04:00:53.948982 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m04:00:53.948982 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m04:00:53.948982 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m04:00:53.948982 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 04:00:53.948982 => 04:00:53.948982
[0m04:00:53.948982 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m04:00:53.997044 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m04:00:53.997044 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m04:00:54.803612 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bdb12598-e010-4b62-bb75-495bb9c99099&page=queryresults
[0m04:00:56.003502 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m04:00:56.384271 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:66bc95ea-6c05-4a8e-8eb6-42e82542cc38&page=queryresults
[0m04:00:58.767386 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m04:00:59.443859 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m04:00:59.443859 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m04:00:59.884635 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b1408599-d1ce-4f49-8dec-c17bb4dab5c8&page=queryresults
[0m04:01:01.842892 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 04:00:53.948982 => 04:01:01.842892
[0m04:01:01.842892 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e7941a93-b7e9-4c20-8f86-7422c0e5b5c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE79FB24F0>]}
[0m04:01:01.842892 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 65.3 KiB processed)[0m in 7.89s]
[0m04:01:01.842892 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m04:01:01.853450 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:01:01.855465 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:01:01.855465 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m04:01:01.855465 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m04:01:01.855465 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m04:01:01.855465 [info ] [MainThread]: 
[0m04:01:01.855465 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.11 seconds (10.11s).
[0m04:01:01.855465 [debug] [MainThread]: Command end result
[0m04:01:01.867665 [info ] [MainThread]: 
[0m04:01:01.867665 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:01:01.867665 [info ] [MainThread]: 
[0m04:01:01.867665 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m04:01:01.867665 [debug] [MainThread]: Command `dbt snapshot` succeeded at 04:01:01.867665 after 11.07 seconds
[0m04:01:01.867665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE75603460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE78BD3670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AE78D35790>]}
[0m04:01:01.867665 [debug] [MainThread]: Flushing usage events
[0m04:01:05.947215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AEA952430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AE98DF6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AE98DFE50>]}


============================== 04:01:05.947215 | a38ce8b1-734b-43a1-b351-8ca0a04ce2e9 ==============================
[0m04:01:05.947215 [info ] [MainThread]: Running with dbt=1.7.4
[0m04:01:05.947215 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m04:01:06.727252 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a38ce8b1-734b-43a1-b351-8ca0a04ce2e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AEDEBEDF0>]}
[0m04:01:06.791409 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a38ce8b1-734b-43a1-b351-8ca0a04ce2e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AEDEABE80>]}
[0m04:01:06.807065 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m04:01:06.813221 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m04:01:06.855075 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:01:06.855075 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m04:01:06.855075 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a38ce8b1-734b-43a1-b351-8ca0a04ce2e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AEE282340>]}
[0m04:01:06.870870 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a38ce8b1-734b-43a1-b351-8ca0a04ce2e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AEDF58F40>]}
[0m04:01:06.870870 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m04:01:06.870870 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a38ce8b1-734b-43a1-b351-8ca0a04ce2e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AED2A0130>]}
[0m04:01:06.870870 [info ] [MainThread]: 
[0m04:01:06.870870 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m04:01:06.870870 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:01:06.870870 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:01:07.515639 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m04:01:07.515639 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m04:01:07.515639 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:01:07.515639 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:01:08.093144 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m04:01:08.093144 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:01:08.124885 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m04:01:08.124885 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:01:08.702307 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a38ce8b1-734b-43a1-b351-8ca0a04ce2e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AEE01A520>]}
[0m04:01:08.702307 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m04:01:08.702307 [info ] [MainThread]: 
[0m04:01:08.702307 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m04:01:08.702307 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m04:01:08.717985 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m04:01:08.717985 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m04:01:08.717985 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m04:01:08.733923 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 04:01:08.717985 => 04:01:08.733923
[0m04:01:08.733923 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m04:01:08.749721 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m04:01:09.377521 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m04:01:09.377521 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m04:01:09.797054 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a3f2fe15-4d9a-4f6f-8a7a-f82de1fdc4a5&page=queryresults
[0m04:01:11.767413 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 04:01:08.733923 => 04:01:11.767413
[0m04:01:11.767413 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a38ce8b1-734b-43a1-b351-8ca0a04ce2e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AEF328DF0>]}
[0m04:01:11.767413 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (363.0 rows, 53.3 KiB processed)[0m in 3.05s]
[0m04:01:11.767413 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m04:01:11.767413 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:01:11.767413 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:01:11.767413 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m04:01:11.767413 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m04:01:11.767413 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m04:01:11.767413 [info ] [MainThread]: 
[0m04:01:11.767413 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.90 seconds (4.90s).
[0m04:01:11.767413 [debug] [MainThread]: Command end result
[0m04:01:11.783507 [info ] [MainThread]: 
[0m04:01:11.783507 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:01:11.783507 [info ] [MainThread]: 
[0m04:01:11.783507 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m04:01:11.783507 [debug] [MainThread]: Command `dbt run` succeeded at 04:01:11.783507 after 5.89 seconds
[0m04:01:11.783507 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AEA952430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AEDEABE80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018AEDF58D00>]}
[0m04:01:11.783507 [debug] [MainThread]: Flushing usage events
[0m05:00:13.437234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9EE983430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9ED9039A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9ED903D30>]}


============================== 05:00:13.452938 | ea59508a-1c1f-4410-89b8-f5def0e6457b ==============================
[0m05:00:13.452938 [info ] [MainThread]: Running with dbt=1.7.4
[0m05:00:13.452938 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --exclude tag:snaps', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m05:00:14.454137 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9ED8F1B20>]}
[0m05:00:14.501514 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F1EE4790>]}
[0m05:00:14.501514 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m05:00:14.551919 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m05:00:17.974094 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:00:17.974094 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:00:17.974094 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F22AE880>]}
[0m05:00:18.033728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F21EA520>]}
[0m05:00:18.035744 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m05:00:18.035744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F1F721C0>]}
[0m05:00:18.037807 [info ] [MainThread]: 
[0m05:00:18.037807 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m05:00:18.037807 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:18.037807 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:18.037807 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:18.037807 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:18.838502 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:19.496362 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m05:00:19.496362 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m05:00:19.496362 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:19.496362 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:20.348131 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m05:00:20.348131 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:20.380039 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m05:00:20.380039 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:21.072188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F204EAF0>]}
[0m05:00:21.072188 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m05:00:21.088001 [info ] [MainThread]: 
[0m05:00:21.088001 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:21.088001 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m05:00:21.088001 [info ] [Thread-1  ]: 1 of 13 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m05:00:21.088001 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m05:00:21.088001 [info ] [Thread-2  ]: 2 of 13 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m05:00:21.088001 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:21.088001 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m05:00:21.103811 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m05:00:21.103811 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m05:00:21.103811 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m05:00:21.103811 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 05:00:21.103811 => 05:00:21.103811
[0m05:00:21.103811 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:21.119970 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 05:00:21.103811 => 05:00:21.103811
[0m05:00:21.119970 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m05:00:21.135924 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m05:00:21.135924 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m05:00:21.152048 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m05:00:21.152048 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m05:00:21.152048 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m05:00:21.167876 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m05:00:22.051208 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e951e8b3-c109-46c8-b388-7665274ae422&page=queryresults
[0m05:00:22.062068 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:651eea51-2219-4b15-a10f-1b22e586c11b&page=queryresults
[0m05:00:22.517903 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 05:00:21.103811 => 05:00:22.517903
[0m05:00:22.519912 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F22B9100>]}
[0m05:00:22.522932 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 05:00:21.119970 => 05:00:22.522932
[0m05:00:22.524942 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F22D8970>]}
[0m05:00:22.520922 [info ] [Thread-1  ]: 1 of 13 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.43s]
[0m05:00:22.524942 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:22.524942 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m05:00:22.524942 [info ] [Thread-2  ]: 2 of 13 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m05:00:22.524942 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m05:00:22.524942 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m05:00:22.524942 [info ] [Thread-1  ]: 3 of 13 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m05:00:22.531306 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m05:00:22.531306 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m05:00:22.536080 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m05:00:22.531306 [info ] [Thread-2  ]: 4 of 13 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m05:00:22.536080 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m05:00:22.536080 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m05:00:22.543261 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m05:00:22.545271 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 05:00:22.536080 => 05:00:22.545271
[0m05:00:22.545271 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m05:00:22.551964 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m05:00:22.551964 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 05:00:22.531306 => 05:00:22.551964
[0m05:00:22.551964 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m05:00:22.556687 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m05:00:22.558694 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:22.559342 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:22.559342 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m05:00:22.583075 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m05:00:23.305693 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ec940399-0536-495c-b04a-c2dc41539fd5&page=queryresults
[0m05:00:23.378087 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4e385d32-e4c9-40df-b169-bfe5c48ec41a&page=queryresults
[0m05:00:23.734475 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 05:00:22.554678 => 05:00:23.734475
[0m05:00:23.736488 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F3390DF0>]}
[0m05:00:23.736488 [info ] [Thread-1  ]: 3 of 13 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m05:00:23.738500 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m05:00:23.738500 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m05:00:23.740512 [info ] [Thread-1  ]: 5 of 13 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m05:00:23.740512 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m05:00:23.740512 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m05:00:23.747509 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m05:00:23.749517 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 05:00:23.743487 => 05:00:23.749517
[0m05:00:23.749517 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m05:00:23.766272 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m05:00:23.768288 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:23.772366 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m05:00:23.825939 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 05:00:22.545271 => 05:00:23.825939
[0m05:00:23.827949 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F332D400>]}
[0m05:00:23.827949 [info ] [Thread-2  ]: 4 of 13 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m05:00:23.827949 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m05:00:23.827949 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:23.827949 [info ] [Thread-2  ]: 6 of 13 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m05:00:23.832214 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m05:00:23.832214 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:23.835518 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m05:00:23.835518 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 05:00:23.832214 => 05:00:23.835518
[0m05:00:23.835518 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:23.841030 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m05:00:23.843036 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:23.843036 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m05:00:24.516956 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:36f199e6-80f9-4d31-854b-1ff721e8c7eb&page=queryresults
[0m05:00:24.541642 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:62dbcb34-e60f-44d5-b5d4-668dfe9a6ba1&page=queryresults
[0m05:00:24.934005 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 05:00:23.835518 => 05:00:24.934005
[0m05:00:24.936016 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F33FE8B0>]}
[0m05:00:24.937848 [info ] [Thread-2  ]: 6 of 13 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.10s]
[0m05:00:24.937848 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:24.937848 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m05:00:24.940987 [info ] [Thread-2  ]: 7 of 13 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m05:00:24.940987 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_pedido)
[0m05:00:24.940987 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m05:00:24.946049 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 05:00:23.749517 => 05:00:24.946049
[0m05:00:24.946049 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F33FEF70>]}
[0m05:00:24.950595 [info ] [Thread-1  ]: 5 of 13 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m05:00:24.950595 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m05:00:24.950595 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m05:00:24.952606 [info ] [Thread-1  ]: 8 of 13 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m05:00:24.960774 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m05:00:24.960774 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m05:00:24.966809 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m05:00:24.966809 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m05:00:24.970752 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 05:00:24.960774 => 05:00:24.966809
[0m05:00:24.970752 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m05:00:24.975891 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m05:00:24.975891 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 05:00:24.946049 => 05:00:24.975891
[0m05:00:24.975891 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m05:00:24.984554 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m05:00:24.986562 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:24.986562 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m05:00:25.015353 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:25.015353 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_pedido
        ,nullif(trim(total), '')                     as vl_total_item
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m05:00:25.760772 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5f413af9-6b0a-438a-ad1d-e1d3f9b3153b&page=queryresults
[0m05:00:25.760772 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:61dc20c8-c305-495a-9366-edbd884c728a&page=queryresults
[0m05:00:26.153529 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 05:00:24.970752 => 05:00:26.153529
[0m05:00:26.155601 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F3452370>]}
[0m05:00:26.155601 [info ] [Thread-1  ]: 8 of 13 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m05:00:26.155601 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m05:00:26.155601 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m05:00:26.155601 [info ] [Thread-1  ]: 9 of 13 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m05:00:26.155601 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m05:00:26.155601 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m05:00:26.155601 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m05:00:26.169624 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 05:00:26.155601 => 05:00:26.169624
[0m05:00:26.169624 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m05:00:26.187372 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 05:00:24.978523 => 05:00:26.187372
[0m05:00:26.189381 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F33FE5B0>]}
[0m05:00:26.189381 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:26.189381 [info ] [Thread-2  ]: 7 of 13 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m05:00:26.189381 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m05:00:26.942362 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m05:00:26.942362 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m05:00:27.505517 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5642edb6-6230-4cac-a3a9-617ef6b83941&page=queryresults
[0m05:00:30.069577 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 05:00:26.169624 => 05:00:30.069577
[0m05:00:30.069577 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F343F730>]}
[0m05:00:30.069577 [info ] [Thread-1  ]: 9 of 13 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 3.91s]
[0m05:00:30.069577 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m05:00:30.078739 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m05:00:30.078739 [info ] [Thread-2  ]: 10 of 13 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m05:00:30.080752 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.tb_produto)
[0m05:00:30.080752 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m05:00:30.086788 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m05:00:30.088799 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 05:00:30.080752 => 05:00:30.088799
[0m05:00:30.088799 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m05:00:30.088799 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:30.708632 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m05:00:30.708632 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m05:00:31.433341 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:751b4dae-9ff4-4774-bc56-a781f40a6d06&page=queryresults
[0m05:00:34.324248 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 05:00:30.088799 => 05:00:34.324248
[0m05:00:34.324248 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F33800A0>]}
[0m05:00:34.324248 [info ] [Thread-2  ]: 10 of 13 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 4.25s]
[0m05:00:34.337110 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m05:00:34.339122 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m05:00:34.339122 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m05:00:34.339122 [info ] [Thread-1  ]: 11 of 13 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m05:00:34.343217 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m05:00:34.343217 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m05:00:34.339122 [info ] [Thread-2  ]: 12 of 13 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m05:00:34.343217 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m05:00:34.343217 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m05:00:34.355068 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m05:00:34.355068 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m05:00:34.368808 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 05:00:34.343217 => 05:00:34.368808
[0m05:00:34.368808 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m05:00:34.368808 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:34.420380 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 05:00:34.352046 => 05:00:34.420380
[0m05:00:34.420380 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m05:00:34.420380 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:36.602238 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m05:00:36.604254 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m05:00:36.871871 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m05:00:36.871871 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m05:00:37.100039 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:291a9905-5de3-4652-8f45-b6b9456bf0dd&page=queryresults
[0m05:00:37.530702 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4bf02b64-85b9-4045-af2a-df493f115ee9&page=queryresults
[0m05:00:41.403944 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 05:00:34.420380 => 05:00:41.403944
[0m05:00:41.405457 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F34A3A60>]}
[0m05:00:41.405457 [info ] [Thread-2  ]: 12 of 13 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 77.2 KiB processed)[0m in 7.06s]
[0m05:00:41.405457 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m05:00:41.409347 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m05:00:41.409347 [info ] [Thread-2  ]: 13 of 13 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m05:00:41.411361 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_preco_produto)
[0m05:00:41.411361 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m05:00:41.417400 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m05:00:41.419409 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 05:00:41.411361 => 05:00:41.417400
[0m05:00:41.419409 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m05:00:41.421257 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:42.756146 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m05:00:42.758162 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m05:00:43.344248 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 05:00:34.368808 => 05:00:43.344248
[0m05:00:43.344248 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F34F2F70>]}
[0m05:00:43.346261 [info ] [Thread-1  ]: 11 of 13 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 9.00s]
[0m05:00:43.348275 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m05:00:43.470767 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:52d6d948-2c44-4b13-b684-ad110da7eddf&page=queryresults
[0m05:00:46.180410 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 05:00:41.419409 => 05:00:46.180410
[0m05:00:46.193020 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea59508a-1c1f-4410-89b8-f5def0e6457b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F344B490>]}
[0m05:00:46.193020 [info ] [Thread-2  ]: 13 of 13 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 73.7 KiB processed)[0m in 4.78s]
[0m05:00:46.193020 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m05:00:46.197344 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:00:46.197344 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:00:46.197344 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:00:46.197344 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m05:00:46.197344 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m05:00:46.197344 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m05:00:46.197344 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m05:00:46.197344 [info ] [MainThread]: 
[0m05:00:46.197344 [info ] [MainThread]: Finished running 8 view models, 5 table models in 0 hours 0 minutes and 28.16 seconds (28.16s).
[0m05:00:46.208505 [debug] [MainThread]: Command end result
[0m05:00:46.233319 [info ] [MainThread]: 
[0m05:00:46.233319 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:00:46.233319 [info ] [MainThread]: 
[0m05:00:46.233319 [info ] [MainThread]: Done. PASS=13 WARN=0 ERROR=0 SKIP=0 TOTAL=13
[0m05:00:46.233319 [debug] [MainThread]: Command `dbt run` succeeded at 05:00:46.233319 after 32.95 seconds
[0m05:00:46.233319 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9EE983430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F1EE4790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A9F22D8C40>]}
[0m05:00:46.240559 [debug] [MainThread]: Flushing usage events
[0m05:00:49.821155 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C83A76B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C8396F96D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C8396F9AF0>]}


============================== 05:00:49.821155 | 58171820-571d-4143-a23e-4b74adb91b6f ==============================
[0m05:00:49.821155 [info ] [MainThread]: Running with dbt=1.7.4
[0m05:00:49.837296 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m05:00:50.584381 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '58171820-571d-4143-a23e-4b74adb91b6f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C8396D9910>]}
[0m05:00:50.648394 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '58171820-571d-4143-a23e-4b74adb91b6f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C83DDCC100>]}
[0m05:00:50.648394 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m05:00:50.664404 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m05:00:50.712598 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:00:50.712598 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:00:50.712598 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '58171820-571d-4143-a23e-4b74adb91b6f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C83E09D910>]}
[0m05:00:50.733297 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '58171820-571d-4143-a23e-4b74adb91b6f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C83DF32490>]}
[0m05:00:50.733297 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m05:00:50.733297 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '58171820-571d-4143-a23e-4b74adb91b6f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C83DF32670>]}
[0m05:00:50.733297 [info ] [MainThread]: 
[0m05:00:50.733297 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m05:00:50.733297 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:50.733297 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:51.396978 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m05:00:51.396978 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m05:00:51.396978 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:51.396978 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:51.988570 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m05:00:51.988570 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:52.020361 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m05:00:52.020361 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:52.619136 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '58171820-571d-4143-a23e-4b74adb91b6f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C83DE555E0>]}
[0m05:00:52.619136 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m05:00:52.619136 [info ] [MainThread]: 
[0m05:00:52.634925 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m05:00:52.634925 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m05:00:52.634925 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m05:00:52.634925 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m05:00:52.634925 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 05:00:52.634925 => 05:00:52.634925
[0m05:00:52.634925 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m05:00:52.698974 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m05:00:52.698974 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m05:00:53.555054 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3ee7d7cb-d070-450f-8d32-7f6809b1f5fc&page=queryresults
[0m05:00:54.684253 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m05:00:55.070813 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:11d4d7f7-d2fd-481f-a6f5-0576cdc2dc73&page=queryresults
[0m05:00:57.703024 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m05:00:58.413784 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m05:00:58.413784 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m05:00:58.834487 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3148c2a7-5d1c-4301-8325-f22749733185&page=queryresults
[0m05:01:00.763382 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 05:00:52.634925 => 05:01:00.763382
[0m05:01:00.763382 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '58171820-571d-4143-a23e-4b74adb91b6f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C83E11E670>]}
[0m05:01:00.763382 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 65.3 KiB processed)[0m in 8.13s]
[0m05:01:00.763382 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m05:01:00.763382 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:01:00.763382 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:01:00.776326 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m05:01:00.776326 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m05:01:00.776326 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m05:01:00.776326 [info ] [MainThread]: 
[0m05:01:00.776326 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.04 seconds (10.04s).
[0m05:01:00.776326 [debug] [MainThread]: Command end result
[0m05:01:00.793774 [info ] [MainThread]: 
[0m05:01:00.793774 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:01:00.793774 [info ] [MainThread]: 
[0m05:01:00.793774 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m05:01:00.793774 [debug] [MainThread]: Command `dbt snapshot` succeeded at 05:01:00.793774 after 11.03 seconds
[0m05:01:00.793774 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C83A76B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C83DEA8820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C83D7AD130>]}
[0m05:01:00.793774 [debug] [MainThread]: Flushing usage events
[0m05:01:05.018409 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CE06E3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CDF6579A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CDF657D30>]}


============================== 05:01:05.018409 | 4e7138ae-c59f-4456-8286-e405a718dc24 ==============================
[0m05:01:05.018409 [info ] [MainThread]: Running with dbt=1.7.4
[0m05:01:05.018409 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m05:01:05.829874 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4e7138ae-c59f-4456-8286-e405a718dc24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CE3CCA8B0>]}
[0m05:01:05.894267 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4e7138ae-c59f-4456-8286-e405a718dc24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CE3D4E850>]}
[0m05:01:05.894267 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m05:01:05.894267 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m05:01:05.942083 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:01:05.942083 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:01:05.958193 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4e7138ae-c59f-4456-8286-e405a718dc24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CE400EF10>]}
[0m05:01:05.958193 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4e7138ae-c59f-4456-8286-e405a718dc24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CE3E84190>]}
[0m05:01:05.958193 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m05:01:05.958193 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4e7138ae-c59f-4456-8286-e405a718dc24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CE3E84F70>]}
[0m05:01:05.958193 [info ] [MainThread]: 
[0m05:01:05.958193 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m05:01:05.973985 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:01:05.973985 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:01:06.632290 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m05:01:06.648187 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:01:06.648187 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m05:01:06.648187 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:01:07.258775 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m05:01:07.265396 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:01:07.290562 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m05:01:07.290562 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:01:07.887169 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4e7138ae-c59f-4456-8286-e405a718dc24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CE401DFD0>]}
[0m05:01:07.887169 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m05:01:07.902710 [info ] [MainThread]: 
[0m05:01:07.908446 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m05:01:07.908446 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m05:01:07.918233 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m05:01:07.918233 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m05:01:07.918233 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m05:01:07.918233 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 05:01:07.918233 => 05:01:07.918233
[0m05:01:07.918233 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m05:01:07.950373 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m05:01:08.740770 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m05:01:08.740770 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m05:01:09.105699 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c6d491be-1f10-4ae6-a4d6-db8a4a390de8&page=queryresults
[0m05:01:10.794883 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 05:01:07.934215 => 05:01:10.794883
[0m05:01:10.794883 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e7138ae-c59f-4456-8286-e405a718dc24', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CE3FF4AF0>]}
[0m05:01:10.794883 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (363.0 rows, 53.3 KiB processed)[0m in 2.89s]
[0m05:01:10.794883 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m05:01:10.794883 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:01:10.794883 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:01:10.794883 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m05:01:10.794883 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m05:01:10.794883 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m05:01:10.794883 [info ] [MainThread]: 
[0m05:01:10.810658 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.84 seconds (4.84s).
[0m05:01:10.810658 [debug] [MainThread]: Command end result
[0m05:01:10.826639 [info ] [MainThread]: 
[0m05:01:10.826639 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:01:10.826639 [info ] [MainThread]: 
[0m05:01:10.826639 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m05:01:10.826639 [debug] [MainThread]: Command `dbt run` succeeded at 05:01:10.826639 after 5.87 seconds
[0m05:01:10.826639 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CE06E3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CE3DA8EE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019CE3CCD5B0>]}
[0m05:01:10.826639 [debug] [MainThread]: Flushing usage events
[0m06:00:04.177255 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF42D34C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF3240310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF3240790>]}


============================== 06:00:04.177255 | 29bce41c-2ed6-4540-8845-c16e114f67ec ==============================
[0m06:00:04.177255 [info ] [MainThread]: Running with dbt=1.7.4
[0m06:00:04.193396 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m06:00:05.069244 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF3239940>]}
[0m06:00:05.165487 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF7814B80>]}
[0m06:00:05.165487 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m06:00:05.181469 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m06:00:05.245469 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m06:00:05.245469 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m06:00:05.245469 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF7BFEDC0>]}
[0m06:00:05.261344 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF7B3FAC0>]}
[0m06:00:05.261344 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m06:00:05.261344 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF7B3FB20>]}
[0m06:00:05.261344 [info ] [MainThread]: 
[0m06:00:05.261344 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m06:00:05.261344 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:05.261344 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:05.261344 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:05.261344 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:06.285774 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:06.961943 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m06:00:06.961943 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:06.961943 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m06:00:06.961943 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:07.624484 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m06:00:07.636184 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:07.636184 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m06:00:07.636184 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:08.297495 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF7995FA0>]}
[0m06:00:08.297495 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m06:00:08.297495 [info ] [MainThread]: 
[0m06:00:08.297495 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:08.297495 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m06:00:08.297495 [info ] [Thread-1  ]: 1 of 13 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m06:00:08.311420 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m06:00:08.311420 [info ] [Thread-2  ]: 2 of 13 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m06:00:08.311420 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:08.311420 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m06:00:08.327354 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m06:00:08.327354 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m06:00:08.327354 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m06:00:08.327354 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 06:00:08.311420 => 06:00:08.327354
[0m06:00:08.327354 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:08.327354 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 06:00:08.327354 => 06:00:08.327354
[0m06:00:08.343320 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m06:00:08.375011 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m06:00:08.375011 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m06:00:08.390953 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m06:00:08.390953 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m06:00:08.390953 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m06:00:08.423353 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m06:00:09.285572 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1fb2007a-2808-4813-aaad-3b5c21578c12&page=queryresults
[0m06:00:09.285572 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:63e1e605-6458-46fe-b91e-710fa927988f&page=queryresults
[0m06:00:09.716028 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 06:00:08.343320 => 06:00:09.699930
[0m06:00:09.716028 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 06:00:08.327354 => 06:00:09.716028
[0m06:00:09.716028 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF7C7E2B0>]}
[0m06:00:09.716028 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF8CF5CD0>]}
[0m06:00:09.716028 [info ] [Thread-2  ]: 2 of 13 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m06:00:09.716028 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m06:00:09.716028 [info ] [Thread-1  ]: 1 of 13 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m06:00:09.716028 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m06:00:09.716028 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:09.716028 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m06:00:09.716028 [info ] [Thread-2  ]: 3 of 13 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m06:00:09.716028 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m06:00:09.716028 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m06:00:09.716028 [info ] [Thread-1  ]: 4 of 13 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m06:00:09.716028 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m06:00:09.716028 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m06:00:09.716028 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m06:00:09.716028 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m06:00:09.731902 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 06:00:09.716028 => 06:00:09.731902
[0m06:00:09.731902 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m06:00:09.731902 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m06:00:09.731902 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 06:00:09.716028 => 06:00:09.731902
[0m06:00:09.731902 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m06:00:09.731902 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:09.731902 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m06:00:09.731902 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m06:00:09.764009 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:09.764009 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m06:00:10.477021 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4cc76619-2d47-40f9-9ff2-c052a0ca9488&page=queryresults
[0m06:00:10.477021 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9e799952-02b7-481e-8ecd-1e7007f6ca9d&page=queryresults
[0m06:00:10.882409 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 06:00:09.731902 => 06:00:10.882409
[0m06:00:10.882409 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF8D83430>]}
[0m06:00:10.898370 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 06:00:09.731902 => 06:00:10.898370
[0m06:00:10.898370 [info ] [Thread-2  ]: 3 of 13 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m06:00:10.898370 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF8C7ED90>]}
[0m06:00:10.898370 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m06:00:10.898370 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m06:00:10.898370 [info ] [Thread-1  ]: 4 of 13 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m06:00:10.898370 [info ] [Thread-2  ]: 5 of 13 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m06:00:10.898370 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m06:00:10.898370 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m06:00:10.898370 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:10.898370 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m06:00:10.898370 [info ] [Thread-1  ]: 6 of 13 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m06:00:10.914276 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m06:00:10.914276 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m06:00:10.914276 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:10.914276 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 06:00:10.898370 => 06:00:10.914276
[0m06:00:10.930173 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m06:00:10.930173 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m06:00:10.945996 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m06:00:10.945996 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:10.945996 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m06:00:10.945996 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 06:00:10.914276 => 06:00:10.945996
[0m06:00:10.993916 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:10.993916 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m06:00:10.993916 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:10.993916 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m06:00:11.848686 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6139c301-774e-4fdb-92b4-88d4f43ef982&page=queryresults
[0m06:00:11.864827 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9126bf87-d248-4f22-b166-96fb7bdd6afc&page=queryresults
[0m06:00:12.284239 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 06:00:10.993916 => 06:00:12.284239
[0m06:00:12.284239 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF8C7ED30>]}
[0m06:00:12.297602 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 06:00:10.930173 => 06:00:12.297602
[0m06:00:12.299611 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF8D2CA30>]}
[0m06:00:12.284239 [info ] [Thread-1  ]: 6 of 13 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m06:00:12.299611 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:12.299611 [info ] [Thread-2  ]: 5 of 13 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m06:00:12.299611 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m06:00:12.299611 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m06:00:12.299611 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m06:00:12.299611 [info ] [Thread-1  ]: 7 of 13 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m06:00:12.299611 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_pedido)
[0m06:00:12.299611 [info ] [Thread-2  ]: 8 of 13 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m06:00:12.299611 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m06:00:12.299611 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m06:00:12.299611 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m06:00:12.299611 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m06:00:12.309684 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m06:00:12.309684 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 06:00:12.299611 => 06:00:12.309684
[0m06:00:12.309684 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m06:00:12.309684 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m06:00:12.315415 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 06:00:12.299611 => 06:00:12.315415
[0m06:00:12.315415 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m06:00:12.315415 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m06:00:12.315415 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:12.315415 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_pedido
        ,nullif(trim(total), '')                     as vl_total_item
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m06:00:12.320090 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:12.338676 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m06:00:13.014858 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:40cb0b35-825f-4ef3-a0ed-e9bf873c34f8&page=queryresults
[0m06:00:13.024812 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:286c0cbe-5534-4132-8b84-44e1047c665e&page=queryresults
[0m06:00:13.412478 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 06:00:12.315415 => 06:00:13.412478
[0m06:00:13.412478 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF8D6DA90>]}
[0m06:00:13.412478 [info ] [Thread-2  ]: 8 of 13 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.11s]
[0m06:00:13.412478 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m06:00:13.412478 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m06:00:13.412478 [info ] [Thread-2  ]: 9 of 13 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m06:00:13.412478 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m06:00:13.412478 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m06:00:13.428316 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 06:00:12.309684 => 06:00:13.428316
[0m06:00:13.444395 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF8D6DF70>]}
[0m06:00:13.444395 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m06:00:13.444395 [info ] [Thread-1  ]: 7 of 13 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m06:00:13.444395 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m06:00:13.444395 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 06:00:13.428316 => 06:00:13.444395
[0m06:00:13.444395 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m06:00:13.460188 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:14.107887 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m06:00:14.107887 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m06:00:14.801764 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9aa1fc7b-228b-42e1-bd76-3994ee85ed21&page=queryresults
[0m06:00:18.267768 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 06:00:13.444395 => 06:00:18.267768
[0m06:00:18.269782 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF7C7E2B0>]}
[0m06:00:18.271796 [info ] [Thread-2  ]: 9 of 13 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 4.86s]
[0m06:00:18.271796 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m06:00:18.274755 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m06:00:18.275366 [info ] [Thread-1  ]: 10 of 13 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m06:00:18.277379 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.tb_produto)
[0m06:00:18.277379 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m06:00:18.285429 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m06:00:18.287446 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 06:00:18.279393 => 06:00:18.287446
[0m06:00:18.287446 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m06:00:18.291569 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:18.903281 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m06:00:18.903281 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m06:00:19.731930 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4d002ffa-e5fa-4cd3-8dd0-6ba17a617227&page=queryresults
[0m06:00:27.706738 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 06:00:18.287446 => 06:00:27.706738
[0m06:00:27.706738 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF8CE8FA0>]}
[0m06:00:27.706738 [info ] [Thread-1  ]: 10 of 13 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 9.43s]
[0m06:00:27.706738 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m06:00:27.706738 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m06:00:27.706738 [info ] [Thread-2  ]: 11 of 13 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m06:00:27.706738 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m06:00:27.706738 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m06:00:27.706738 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m06:00:27.706738 [info ] [Thread-1  ]: 12 of 13 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m06:00:27.722484 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m06:00:27.722484 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m06:00:27.728039 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m06:00:27.734008 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m06:00:27.739844 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 06:00:27.706738 => 06:00:27.737832
[0m06:00:27.739844 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m06:00:27.739844 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:27.739844 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 06:00:27.722484 => 06:00:27.739844
[0m06:00:27.739844 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m06:00:27.751377 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:28.442742 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m06:00:28.457527 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m06:00:28.468080 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m06:00:28.472110 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m06:00:28.842006 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1ce0c6bf-8e7a-41de-a0dd-03224fc7f3c0&page=queryresults
[0m06:00:29.463405 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:04a876b0-41ce-45d7-b21f-097a56c4adbe&page=queryresults
[0m06:00:31.725124 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 06:00:27.739844 => 06:00:31.725124
[0m06:00:31.727137 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF8DD2B80>]}
[0m06:00:31.727137 [info ] [Thread-2  ]: 11 of 13 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 4.02s]
[0m06:00:31.729151 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m06:00:31.729151 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m06:00:31.729151 [info ] [Thread-2  ]: 13 of 13 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m06:00:31.731164 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_preco_produto)
[0m06:00:31.731164 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m06:00:31.737200 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m06:00:31.739211 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 06:00:31.733176 => 06:00:31.739211
[0m06:00:31.739211 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m06:00:31.739211 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:32.559936 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m06:00:32.559936 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m06:00:32.859733 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 06:00:27.747348 => 06:00:32.859733
[0m06:00:32.861747 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF8D307C0>]}
[0m06:00:32.861747 [info ] [Thread-1  ]: 12 of 13 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 77.2 KiB processed)[0m in 5.14s]
[0m06:00:32.863757 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m06:00:33.189862 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:92c26363-9d36-4ab7-81e8-755238860ddc&page=queryresults
[0m06:00:37.985174 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 06:00:31.739211 => 06:00:37.985174
[0m06:00:37.987187 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '29bce41c-2ed6-4540-8845-c16e114f67ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF8DC0D30>]}
[0m06:00:37.987187 [info ] [Thread-2  ]: 13 of 13 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 73.7 KiB processed)[0m in 6.26s]
[0m06:00:37.989202 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m06:00:37.989202 [debug] [MainThread]: Connection 'master' was properly closed.
[0m06:00:37.989202 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:00:37.993492 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:00:37.993492 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m06:00:37.993492 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m06:00:37.993492 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_geral' was properly closed.
[0m06:00:37.993492 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m06:00:37.993492 [info ] [MainThread]: 
[0m06:00:37.993492 [info ] [MainThread]: Finished running 8 view models, 5 table models in 0 hours 0 minutes and 32.73 seconds (32.73s).
[0m06:00:38.000173 [debug] [MainThread]: Command end result
[0m06:00:38.027979 [info ] [MainThread]: 
[0m06:00:38.027979 [info ] [MainThread]: [32mCompleted successfully[0m
[0m06:00:38.027979 [info ] [MainThread]: 
[0m06:00:38.027979 [info ] [MainThread]: Done. PASS=13 WARN=0 ERROR=0 SKIP=0 TOTAL=13
[0m06:00:38.027979 [debug] [MainThread]: Command `dbt run` succeeded at 06:00:38.027979 after 33.93 seconds
[0m06:00:38.027979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF42D34C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF7C07400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ECF79CB3D0>]}
[0m06:00:38.027979 [debug] [MainThread]: Flushing usage events
[0m06:00:42.977426 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F737613430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73659F9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73659FD30>]}


============================== 06:00:42.977426 | ac42f592-49d1-4a4e-941f-4066e1f1aeec ==============================
[0m06:00:42.977426 [info ] [MainThread]: Running with dbt=1.7.4
[0m06:00:42.988548 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m06:00:43.767015 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ac42f592-49d1-4a4e-941f-4066e1f1aeec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73658FB20>]}
[0m06:00:43.876319 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ac42f592-49d1-4a4e-941f-4066e1f1aeec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73AC78940>]}
[0m06:00:43.879481 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m06:00:43.887536 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m06:00:43.988513 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m06:00:43.988513 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m06:00:43.988513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ac42f592-49d1-4a4e-941f-4066e1f1aeec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73AF3D640>]}
[0m06:00:44.004448 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ac42f592-49d1-4a4e-941f-4066e1f1aeec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73AE72340>]}
[0m06:00:44.018540 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m06:00:44.018540 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ac42f592-49d1-4a4e-941f-4066e1f1aeec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73AE723A0>]}
[0m06:00:44.020404 [info ] [MainThread]: 
[0m06:00:44.020404 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m06:00:44.020404 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:44.020404 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:44.716414 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m06:00:44.716414 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m06:00:44.716414 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:44.716414 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:45.320669 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m06:00:45.325544 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m06:00:45.325544 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:45.325544 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:45.936602 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ac42f592-49d1-4a4e-941f-4066e1f1aeec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73AF72FD0>]}
[0m06:00:45.936602 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m06:00:45.936602 [info ] [MainThread]: 
[0m06:00:45.952599 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m06:00:45.952599 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m06:00:45.952599 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m06:00:45.952599 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m06:00:45.968756 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 06:00:45.952599 => 06:00:45.968756
[0m06:00:45.968756 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m06:00:46.016518 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m06:00:46.032243 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m06:00:46.874361 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:223a45a6-f04d-4bcb-b4a0-114de29ca082&page=queryresults
[0m06:00:48.054403 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m06:00:48.441446 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9c3e4fb8-1ff2-4fff-b187-303e62350792&page=queryresults
[0m06:00:50.564511 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m06:00:51.350557 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m06:00:51.350557 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m06:00:51.767577 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:25b1c69e-c080-4686-bd5e-87fbca60d8c2&page=queryresults
[0m06:00:53.487733 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 06:00:45.968756 => 06:00:53.487733
[0m06:00:53.487733 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ac42f592-49d1-4a4e-941f-4066e1f1aeec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73C01B550>]}
[0m06:00:53.487733 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 65.3 KiB processed)[0m in 7.54s]
[0m06:00:53.487733 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m06:00:53.494859 [debug] [MainThread]: Connection 'master' was properly closed.
[0m06:00:53.494859 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:00:53.496756 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m06:00:53.496756 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m06:00:53.496756 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m06:00:53.496756 [info ] [MainThread]: 
[0m06:00:53.498767 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 9.48 seconds (9.48s).
[0m06:00:53.498767 [debug] [MainThread]: Command end result
[0m06:00:53.513330 [info ] [MainThread]: 
[0m06:00:53.515344 [info ] [MainThread]: [32mCompleted successfully[0m
[0m06:00:53.515344 [info ] [MainThread]: 
[0m06:00:53.515344 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m06:00:53.515344 [debug] [MainThread]: Command `dbt snapshot` succeeded at 06:00:53.515344 after 10.63 seconds
[0m06:00:53.515344 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F737613430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73ACD8580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73AFC6C40>]}
[0m06:00:53.519992 [debug] [MainThread]: Flushing usage events
[0m06:00:57.053678 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2D3FE63D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2D2F7F2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2D2F7F760>]}


============================== 06:00:57.069602 | 6fc81f62-0dad-4e0f-af3a-edc96ab3071d ==============================
[0m06:00:57.069602 [info ] [MainThread]: Running with dbt=1.7.4
[0m06:00:57.069602 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m06:00:57.864554 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6fc81f62-0dad-4e0f-af3a-edc96ab3071d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2D613ABE0>]}
[0m06:00:57.912044 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6fc81f62-0dad-4e0f-af3a-edc96ab3071d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2D76607C0>]}
[0m06:00:57.912044 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m06:00:57.927864 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m06:00:57.975255 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m06:00:57.975255 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m06:00:57.975255 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6fc81f62-0dad-4e0f-af3a-edc96ab3071d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2D791EC70>]}
[0m06:00:57.975255 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6fc81f62-0dad-4e0f-af3a-edc96ab3071d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2D785F970>]}
[0m06:00:57.975255 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m06:00:57.975255 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6fc81f62-0dad-4e0f-af3a-edc96ab3071d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2D785F9D0>]}
[0m06:00:57.991083 [info ] [MainThread]: 
[0m06:00:57.991083 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m06:00:57.991083 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:57.991083 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:58.842957 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m06:00:58.842957 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m06:00:58.842957 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:58.842957 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:59.474424 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m06:00:59.474424 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:59.500893 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m06:00:59.500893 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:01:00.080359 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6fc81f62-0dad-4e0f-af3a-edc96ab3071d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2D785FB50>]}
[0m06:01:00.080359 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m06:01:00.080359 [info ] [MainThread]: 
[0m06:01:00.080359 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m06:01:00.080359 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m06:01:00.080359 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m06:01:00.080359 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m06:01:00.096178 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m06:01:00.096178 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 06:01:00.080359 => 06:01:00.096178
[0m06:01:00.096178 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m06:01:00.120243 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m06:01:00.776700 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m06:01:00.776700 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m06:01:01.149133 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:82853510-9b34-42b8-9cf5-c23e37eefa04&page=queryresults
[0m06:01:03.088250 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 06:01:00.096178 => 06:01:03.088250
[0m06:01:03.088250 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6fc81f62-0dad-4e0f-af3a-edc96ab3071d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2D785FBE0>]}
[0m06:01:03.088250 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (363.0 rows, 53.3 KiB processed)[0m in 3.01s]
[0m06:01:03.088250 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m06:01:03.088250 [debug] [MainThread]: Connection 'master' was properly closed.
[0m06:01:03.088250 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:01:03.088250 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m06:01:03.088250 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m06:01:03.088250 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m06:01:03.088250 [info ] [MainThread]: 
[0m06:01:03.104117 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.10 seconds (5.10s).
[0m06:01:03.105492 [debug] [MainThread]: Command end result
[0m06:01:03.111551 [info ] [MainThread]: 
[0m06:01:03.111551 [info ] [MainThread]: [32mCompleted successfully[0m
[0m06:01:03.111551 [info ] [MainThread]: 
[0m06:01:03.111551 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m06:01:03.111551 [debug] [MainThread]: Command `dbt run` succeeded at 06:01:03.111551 after 6.11 seconds
[0m06:01:03.111551 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2D3FE63D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2D75713D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2D75857F0>]}
[0m06:01:03.111551 [debug] [MainThread]: Flushing usage events
[0m07:00:05.012959 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000166495B93D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000166485372E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016648537760>]}


============================== 07:00:05.012959 | 805003e1-ec8d-4d16-8aec-156733a54246 ==============================
[0m07:00:05.012959 [info ] [MainThread]: Running with dbt=1.7.4
[0m07:00:05.012959 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m07:00:05.911682 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664852A100>]}
[0m07:00:05.970401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664B70AAF0>]}
[0m07:00:05.970401 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m07:00:05.974173 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m07:00:06.074960 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m07:00:06.074960 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m07:00:06.078996 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664CEEE7F0>]}
[0m07:00:06.090810 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664CE2E4C0>]}
[0m07:00:06.092818 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m07:00:06.092818 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664CE2E490>]}
[0m07:00:06.094823 [info ] [MainThread]: 
[0m07:00:06.096835 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m07:00:06.098843 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:06.098843 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:06.100598 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:06.100598 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:06.943659 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:07.614201 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m07:00:07.614201 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:07.614201 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m07:00:07.614201 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:08.282276 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m07:00:08.282276 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:08.298144 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m07:00:08.314172 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:08.982898 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664CF402B0>]}
[0m07:00:08.998742 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m07:00:08.998742 [info ] [MainThread]: 
[0m07:00:08.998742 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:08.998742 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m07:00:08.998742 [info ] [Thread-1  ]: 1 of 13 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m07:00:08.998742 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m07:00:08.998742 [info ] [Thread-2  ]: 2 of 13 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m07:00:09.014616 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:09.014616 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m07:00:09.014616 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m07:00:09.014616 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m07:00:09.014616 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m07:00:09.014616 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 07:00:09.014616 => 07:00:09.014616
[0m07:00:09.014616 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:09.030481 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 07:00:09.014616 => 07:00:09.030481
[0m07:00:09.030481 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m07:00:09.061940 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m07:00:09.079264 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m07:00:09.079264 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m07:00:09.079264 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m07:00:09.079264 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m07:00:09.108863 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m07:00:09.952164 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6400db4b-f664-4468-b0fc-436731cfe0e8&page=queryresults
[0m07:00:09.952164 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6b24a3dc-3108-4baa-b34f-35fa585f6458&page=queryresults
[0m07:00:10.457049 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 07:00:09.014616 => 07:00:10.448657
[0m07:00:10.459068 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 07:00:09.030481 => 07:00:10.457049
[0m07:00:10.459068 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664DF71D30>]}
[0m07:00:10.462844 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664CF638B0>]}
[0m07:00:10.462844 [info ] [Thread-1  ]: 1 of 13 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m07:00:10.464863 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:10.464863 [info ] [Thread-2  ]: 2 of 13 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m07:00:10.464863 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m07:00:10.471161 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m07:00:10.473179 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m07:00:10.471161 [info ] [Thread-1  ]: 3 of 13 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m07:00:10.477209 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m07:00:10.475194 [info ] [Thread-2  ]: 4 of 13 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m07:00:10.477209 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m07:00:10.478971 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m07:00:10.486104 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m07:00:10.486104 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m07:00:10.496547 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m07:00:10.498555 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 07:00:10.478971 => 07:00:10.498555
[0m07:00:10.498555 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m07:00:10.502576 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m07:00:10.504593 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 07:00:10.490506 => 07:00:10.504593
[0m07:00:10.504593 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m07:00:10.510383 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m07:00:10.512392 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:10.514400 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m07:00:10.514400 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:10.542534 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m07:00:11.444933 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d646e4c4-76a7-419b-b8e7-6c17f5a71a2f&page=queryresults
[0m07:00:11.484798 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b96617b6-4aa3-4687-b7ad-4aab86be5699&page=queryresults
[0m07:00:11.891710 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 07:00:10.504593 => 07:00:11.891710
[0m07:00:11.895188 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664E0584F0>]}
[0m07:00:11.895188 [info ] [Thread-2  ]: 4 of 13 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.41s]
[0m07:00:11.895188 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 07:00:10.498555 => 07:00:11.895188
[0m07:00:11.895188 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m07:00:11.895188 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664DFBA400>]}
[0m07:00:11.895188 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m07:00:11.895188 [info ] [Thread-1  ]: 3 of 13 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m07:00:11.895188 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m07:00:11.895188 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:11.895188 [info ] [Thread-2  ]: 5 of 13 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m07:00:11.895188 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m07:00:11.895188 [info ] [Thread-1  ]: 6 of 13 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m07:00:11.895188 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m07:00:11.895188 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m07:00:11.895188 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m07:00:11.895188 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:11.926956 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m07:00:11.926956 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 07:00:11.895188 => 07:00:11.926956
[0m07:00:11.926956 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m07:00:11.926956 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m07:00:11.926956 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 07:00:11.895188 => 07:00:11.926956
[0m07:00:11.926956 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:11.926956 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m07:00:11.926956 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:11.943103 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m07:00:11.959172 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:11.959172 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m07:00:12.653982 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:37ed1f1b-8870-4e6f-8d83-b3a744d422d0&page=queryresults
[0m07:00:12.691976 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fed2b4d4-7d86-44fa-9998-4ab9a2003dc0&page=queryresults
[0m07:00:13.110440 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 07:00:11.926956 => 07:00:13.110440
[0m07:00:13.110440 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664DF716D0>]}
[0m07:00:13.110440 [info ] [Thread-1  ]: 6 of 13 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m07:00:13.110440 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:13.110440 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m07:00:13.110440 [info ] [Thread-1  ]: 7 of 13 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m07:00:13.110440 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_pedido)
[0m07:00:13.110440 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m07:00:13.122293 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m07:00:13.122293 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 07:00:13.110440 => 07:00:13.122293
[0m07:00:13.122293 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m07:00:13.122293 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m07:00:13.138086 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:13.138086 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 07:00:11.926956 => 07:00:13.136331
[0m07:00:13.138086 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664E065700>]}
[0m07:00:13.138086 [info ] [Thread-2  ]: 5 of 13 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m07:00:13.138086 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_pedido
        ,nullif(trim(total), '')                     as vl_total_item
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m07:00:13.138086 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m07:00:13.154011 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m07:00:13.170272 [info ] [Thread-2  ]: 8 of 13 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m07:00:13.170272 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m07:00:13.170272 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m07:00:13.170272 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m07:00:13.170272 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 07:00:13.170272 => 07:00:13.170272
[0m07:00:13.170272 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m07:00:13.181426 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m07:00:13.181426 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:13.183444 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m07:00:13.856343 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9a2e7286-74b9-4c14-b68c-0265e6e6e71f&page=queryresults
[0m07:00:14.128203 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b120e808-f8f2-4804-92be-2f21afa9a4b4&page=queryresults
[0m07:00:14.255889 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 07:00:13.122293 => 07:00:14.240015
[0m07:00:14.255889 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664E03F430>]}
[0m07:00:14.255889 [info ] [Thread-1  ]: 7 of 13 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m07:00:14.255889 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m07:00:14.578637 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 07:00:13.170272 => 07:00:14.576622
[0m07:00:14.580654 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664CF771C0>]}
[0m07:00:14.580654 [info ] [Thread-2  ]: 8 of 13 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.41s]
[0m07:00:14.582675 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m07:00:14.584695 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m07:00:14.586713 [info ] [Thread-1  ]: 9 of 13 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m07:00:14.586713 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.dm_produto)
[0m07:00:14.586713 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m07:00:14.588594 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m07:00:14.588594 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 07:00:14.586713 => 07:00:14.588594
[0m07:00:14.588594 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m07:00:14.604556 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:15.255766 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m07:00:15.255766 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m07:00:15.909271 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:45776029-8ebf-45b2-8365-738667816159&page=queryresults
[0m07:00:18.762241 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 07:00:14.588594 => 07:00:18.762241
[0m07:00:18.764261 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664DFC5880>]}
[0m07:00:18.764261 [info ] [Thread-1  ]: 9 of 13 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 4.18s]
[0m07:00:18.766273 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m07:00:18.768289 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m07:00:18.768289 [info ] [Thread-2  ]: 10 of 13 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m07:00:18.770301 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m07:00:18.772319 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m07:00:18.782154 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m07:00:18.784169 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 07:00:18.772319 => 07:00:18.784169
[0m07:00:18.786181 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m07:00:18.789950 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:19.417075 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m07:00:19.428867 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m07:00:23.186944 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f18e750a-d75a-48c8-8ca0-7b67992c3085&page=queryresults
[0m07:00:26.000718 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 07:00:18.786181 => 07:00:26.000718
[0m07:00:26.000718 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664DF713D0>]}
[0m07:00:26.000718 [info ] [Thread-2  ]: 10 of 13 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 7.23s]
[0m07:00:26.000718 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m07:00:26.000718 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m07:00:26.000718 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m07:00:26.000718 [info ] [Thread-1  ]: 11 of 13 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m07:00:26.016579 [info ] [Thread-2  ]: 12 of 13 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m07:00:26.016579 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m07:00:26.016579 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m07:00:26.016579 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m07:00:26.016579 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m07:00:26.016579 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m07:00:26.016579 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 07:00:26.016579 => 07:00:26.016579
[0m07:00:26.029703 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m07:00:26.029703 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m07:00:26.034506 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:26.069394 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 07:00:26.016579 => 07:00:26.069394
[0m07:00:26.069394 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m07:00:26.074140 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:26.670282 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m07:00:26.670282 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m07:00:26.701944 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m07:00:26.701944 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m07:00:27.164433 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0da246ae-9011-420f-96c2-44d7ca708969&page=queryresults
[0m07:00:27.291564 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:35efa0b5-5d72-48d6-8f02-00e2a3f2ba2f&page=queryresults
[0m07:00:29.281575 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 07:00:26.069394 => 07:00:29.281575
[0m07:00:29.281575 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664DF61490>]}
[0m07:00:29.281575 [info ] [Thread-1  ]: 11 of 13 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 3.26s]
[0m07:00:29.281575 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m07:00:29.281575 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m07:00:29.281575 [info ] [Thread-1  ]: 13 of 13 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m07:00:29.281575 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_preco_produto)
[0m07:00:29.297377 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m07:00:29.297377 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m07:00:29.297377 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 07:00:29.297377 => 07:00:29.297377
[0m07:00:29.297377 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m07:00:29.313598 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:29.441434 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 07:00:26.029703 => 07:00:29.441434
[0m07:00:29.441434 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664E0B2FA0>]}
[0m07:00:29.441434 [info ] [Thread-2  ]: 12 of 13 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 77.2 KiB processed)[0m in 3.42s]
[0m07:00:29.457520 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m07:00:29.933968 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m07:00:29.933968 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m07:00:30.617846 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:25154f27-cabf-48be-8ea4-ec837a5659f9&page=queryresults
[0m07:00:37.602950 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 07:00:29.297377 => 07:00:37.602950
[0m07:00:37.602950 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '805003e1-ec8d-4d16-8aec-156733a54246', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664DF61490>]}
[0m07:00:37.602950 [info ] [Thread-1  ]: 13 of 13 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 73.7 KiB processed)[0m in 8.32s]
[0m07:00:37.602950 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m07:00:37.602950 [debug] [MainThread]: Connection 'master' was properly closed.
[0m07:00:37.602950 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:00:37.602950 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:00:37.602950 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m07:00:37.602950 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m07:00:37.602950 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m07:00:37.602950 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_geral' was properly closed.
[0m07:00:37.602950 [info ] [MainThread]: 
[0m07:00:37.602950 [info ] [MainThread]: Finished running 8 view models, 5 table models in 0 hours 0 minutes and 31.51 seconds (31.51s).
[0m07:00:37.618758 [debug] [MainThread]: Command end result
[0m07:00:37.634612 [info ] [MainThread]: 
[0m07:00:37.634612 [info ] [MainThread]: [32mCompleted successfully[0m
[0m07:00:37.634612 [info ] [MainThread]: 
[0m07:00:37.634612 [info ] [MainThread]: Done. PASS=13 WARN=0 ERROR=0 SKIP=0 TOTAL=13
[0m07:00:37.634612 [debug] [MainThread]: Command `dbt run` succeeded at 07:00:37.634612 after 32.69 seconds
[0m07:00:37.634612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000166495B93D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664CF77880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001664CBAF130>]}
[0m07:00:37.634612 [debug] [MainThread]: Flushing usage events
[0m07:00:41.970660 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002452A452460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245293DB670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245293DBD90>]}


============================== 07:00:41.977559 | 96dfa558-6425-4cfa-8a08-8cd2ee159c53 ==============================
[0m07:00:41.977559 [info ] [MainThread]: Running with dbt=1.7.4
[0m07:00:41.977559 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt snapshot', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m07:00:42.879352 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '96dfa558-6425-4cfa-8a08-8cd2ee159c53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245293CD1C0>]}
[0m07:00:42.973859 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '96dfa558-6425-4cfa-8a08-8cd2ee159c53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002452DAABB20>]}
[0m07:00:42.975867 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m07:00:42.981890 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m07:00:43.013493 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m07:00:43.013493 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m07:00:43.029520 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '96dfa558-6425-4cfa-8a08-8cd2ee159c53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002452DD7DD90>]}
[0m07:00:43.045405 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '96dfa558-6425-4cfa-8a08-8cd2ee159c53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002452DBD0A90>]}
[0m07:00:43.045405 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m07:00:43.045405 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '96dfa558-6425-4cfa-8a08-8cd2ee159c53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002452DBD0AF0>]}
[0m07:00:43.045405 [info ] [MainThread]: 
[0m07:00:43.045405 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m07:00:43.045405 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:43.045405 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:43.715543 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m07:00:43.715543 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:43.715543 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m07:00:43.731189 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:44.385212 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m07:00:44.385212 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:44.432637 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m07:00:44.432637 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:45.040450 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '96dfa558-6425-4cfa-8a08-8cd2ee159c53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002452DB19BE0>]}
[0m07:00:45.040450 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m07:00:45.054742 [info ] [MainThread]: 
[0m07:00:45.056478 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m07:00:45.056478 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m07:00:45.056478 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m07:00:45.056478 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m07:00:45.072179 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 07:00:45.056478 => 07:00:45.072179
[0m07:00:45.072179 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m07:00:45.119964 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m07:00:45.135821 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m07:00:45.871836 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:158562fb-f876-4c19-8711-34a4b445038c&page=queryresults
[0m07:00:47.036902 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m07:00:47.516834 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7dd01df4-1bf1-4798-9ff3-d511781bab74&page=queryresults
[0m07:00:50.150806 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m07:00:50.757313 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m07:00:50.757313 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m07:00:51.221624 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ea2973a2-6a8c-4a67-b389-e4906a3371eb&page=queryresults
[0m07:00:53.539167 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 07:00:45.072179 => 07:00:53.537163
[0m07:00:53.539167 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '96dfa558-6425-4cfa-8a08-8cd2ee159c53', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002452DA22160>]}
[0m07:00:53.541171 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 65.3 KiB processed)[0m in 8.48s]
[0m07:00:53.543178 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m07:00:53.545184 [debug] [MainThread]: Connection 'master' was properly closed.
[0m07:00:53.546931 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:00:53.546931 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m07:00:53.546931 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m07:00:53.548937 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m07:00:53.548937 [info ] [MainThread]: 
[0m07:00:53.550942 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.50 seconds (10.50s).
[0m07:00:53.550942 [debug] [MainThread]: Command end result
[0m07:00:53.566726 [info ] [MainThread]: 
[0m07:00:53.566726 [info ] [MainThread]: [32mCompleted successfully[0m
[0m07:00:53.568730 [info ] [MainThread]: 
[0m07:00:53.568730 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m07:00:53.570733 [debug] [MainThread]: Command `dbt snapshot` succeeded at 07:00:53.570733 after 11.67 seconds
[0m07:00:53.570733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002452A452460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002452DD7DE20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002452D9B9310>]}
[0m07:00:53.570733 [debug] [MainThread]: Flushing usage events
[0m07:00:58.394980 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018422F9B430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018421F166D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018421F16E20>]}


============================== 07:00:58.406084 | f62bf55a-8a03-4ac5-bb3c-fc2c11737ed7 ==============================
[0m07:00:58.406084 [info ] [MainThread]: Running with dbt=1.7.4
[0m07:00:58.406084 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m07:00:59.269626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f62bf55a-8a03-4ac5-bb3c-fc2c11737ed7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018421F15940>]}
[0m07:00:59.377000 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f62bf55a-8a03-4ac5-bb3c-fc2c11737ed7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184266112B0>]}
[0m07:00:59.377000 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m07:00:59.381018 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m07:00:59.491956 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m07:00:59.491956 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m07:00:59.507930 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f62bf55a-8a03-4ac5-bb3c-fc2c11737ed7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184268CE850>]}
[0m07:00:59.526954 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f62bf55a-8a03-4ac5-bb3c-fc2c11737ed7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001842680E520>]}
[0m07:00:59.526954 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m07:00:59.526954 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f62bf55a-8a03-4ac5-bb3c-fc2c11737ed7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001842680E4F0>]}
[0m07:00:59.526954 [info ] [MainThread]: 
[0m07:00:59.526954 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m07:00:59.539983 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:59.539983 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:01:00.248796 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m07:01:00.250803 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:01:00.252810 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m07:01:00.254566 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:01:00.894306 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m07:01:00.894306 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:01:00.922670 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m07:01:00.922670 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:01:01.527689 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f62bf55a-8a03-4ac5-bb3c-fc2c11737ed7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184268FD8B0>]}
[0m07:01:01.527689 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m07:01:01.527689 [info ] [MainThread]: 
[0m07:01:01.527689 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m07:01:01.527689 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m07:01:01.527689 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m07:01:01.527689 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m07:01:01.527689 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m07:01:01.543439 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 07:01:01.527689 => 07:01:01.543439
[0m07:01:01.543439 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m07:01:01.559434 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m07:01:02.211665 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m07:01:02.211665 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m07:01:02.577247 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:abbba2f1-f411-4ea0-a76c-4a554f7c9b34&page=queryresults
[0m07:01:04.505329 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 07:01:01.543439 => 07:01:04.505329
[0m07:01:04.507332 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f62bf55a-8a03-4ac5-bb3c-fc2c11737ed7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001842694D490>]}
[0m07:01:04.507332 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (363.0 rows, 53.3 KiB processed)[0m in 2.98s]
[0m07:01:04.509335 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m07:01:04.511079 [debug] [MainThread]: Connection 'master' was properly closed.
[0m07:01:04.511079 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:01:04.511079 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m07:01:04.511079 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m07:01:04.511079 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m07:01:04.513081 [info ] [MainThread]: 
[0m07:01:04.513081 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.99 seconds (4.99s).
[0m07:01:04.513081 [debug] [MainThread]: Command end result
[0m07:01:04.525108 [info ] [MainThread]: 
[0m07:01:04.527111 [info ] [MainThread]: [32mCompleted successfully[0m
[0m07:01:04.527111 [info ] [MainThread]: 
[0m07:01:04.527111 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m07:01:04.529114 [debug] [MainThread]: Command `dbt run` succeeded at 07:01:04.529114 after 6.21 seconds
[0m07:01:04.529114 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018422F9B430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184266112B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184268FD8B0>]}
[0m07:01:04.529114 [debug] [MainThread]: Flushing usage events
[0m08:00:04.844969 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB8F17B400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB8E101910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB8E101B80>]}


============================== 08:00:04.844969 | 221d87ad-dc1b-47b3-962a-2faf47ce5c8e ==============================
[0m08:00:04.844969 [info ] [MainThread]: Running with dbt=1.7.4
[0m08:00:04.844969 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --exclude tag:snaps', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m08:00:05.675748 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB8E0FB940>]}
[0m08:00:05.732850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB926E9AC0>]}
[0m08:00:05.732850 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m08:00:05.732850 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m08:00:05.790288 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m08:00:05.792293 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m08:00:05.796044 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB92AAE760>]}
[0m08:00:05.804779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB928419A0>]}
[0m08:00:05.804779 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m08:00:05.804779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB927442E0>]}
[0m08:00:05.804779 [info ] [MainThread]: 
[0m08:00:05.804779 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m08:00:05.811964 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:05.811964 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:05.811964 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:05.811964 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:06.611011 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:07.296613 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m08:00:07.296613 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:07.296613 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m08:00:07.296613 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:07.932303 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m08:00:07.932303 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:07.932303 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m08:00:07.932303 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:08.559168 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB928416A0>]}
[0m08:00:08.559168 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m08:00:08.559168 [info ] [MainThread]: 
[0m08:00:08.585742 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:08.585742 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m08:00:08.585742 [info ] [Thread-1  ]: 1 of 13 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m08:00:08.585742 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m08:00:08.585742 [info ] [Thread-2  ]: 2 of 13 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m08:00:08.585742 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:08.585742 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m08:00:08.601455 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m08:00:08.601455 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m08:00:08.601455 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m08:00:08.601455 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 08:00:08.585742 => 08:00:08.601455
[0m08:00:08.601455 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:08.601455 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 08:00:08.601455 => 08:00:08.601455
[0m08:00:08.601455 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m08:00:08.648719 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m08:00:08.648719 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m08:00:08.648719 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m08:00:08.664447 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m08:00:08.664447 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m08:00:08.680311 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m08:00:09.566745 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:419ad031-d932-4940-ba14-69925ad7f317&page=queryresults
[0m08:00:09.566745 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:52fea86a-749b-4374-91f0-fb86c2b9b6b5&page=queryresults
[0m08:00:10.034310 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 08:00:08.615245 => 08:00:10.034310
[0m08:00:10.034310 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB92AD8370>]}
[0m08:00:10.034310 [info ] [Thread-2  ]: 2 of 13 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m08:00:10.034310 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m08:00:10.034310 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m08:00:10.034310 [info ] [Thread-2  ]: 3 of 13 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m08:00:10.034310 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m08:00:10.034310 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m08:00:10.034310 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m08:00:10.034310 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 08:00:10.034310 => 08:00:10.034310
[0m08:00:10.034310 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m08:00:10.034310 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m08:00:10.034310 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:10.034310 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m08:00:10.076419 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 08:00:08.601455 => 08:00:10.076419
[0m08:00:10.076419 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB93B2FAC0>]}
[0m08:00:10.076419 [info ] [Thread-1  ]: 1 of 13 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.49s]
[0m08:00:10.076419 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:10.076419 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m08:00:10.076419 [info ] [Thread-1  ]: 4 of 13 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m08:00:10.076419 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m08:00:10.081637 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m08:00:10.081637 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m08:00:10.081637 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 08:00:10.081637 => 08:00:10.081637
[0m08:00:10.081637 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m08:00:10.081637 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m08:00:10.081637 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:10.081637 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m08:00:10.960128 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:10499fc2-e6b0-46de-9e6b-270a91491833&page=queryresults
[0m08:00:10.960128 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3fa45190-1919-4363-a48c-e24c241390fc&page=queryresults
[0m08:00:11.358650 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 08:00:10.081637 => 08:00:11.358650
[0m08:00:11.358650 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB93B5E130>]}
[0m08:00:11.358650 [info ] [Thread-1  ]: 4 of 13 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m08:00:11.358650 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m08:00:11.358650 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m08:00:11.358650 [info ] [Thread-1  ]: 5 of 13 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m08:00:11.358650 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m08:00:11.358650 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m08:00:11.374475 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m08:00:11.374475 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 08:00:11.358650 => 08:00:11.374475
[0m08:00:11.374475 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m08:00:11.374475 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m08:00:11.374475 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:11.374475 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m08:00:11.406004 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 08:00:10.034310 => 08:00:11.406004
[0m08:00:11.406004 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB93BE9160>]}
[0m08:00:11.406004 [info ] [Thread-2  ]: 3 of 13 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m08:00:11.406004 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m08:00:11.406004 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:11.406004 [info ] [Thread-2  ]: 6 of 13 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m08:00:11.406004 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m08:00:11.406004 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:11.406004 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m08:00:11.406004 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 08:00:11.406004 => 08:00:11.406004
[0m08:00:11.406004 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:11.422116 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m08:00:11.422116 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:11.422116 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m08:00:12.122911 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:de9094a7-17d8-4a82-82a2-fcad8ee6f378&page=queryresults
[0m08:00:12.170629 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:880c1248-4a7b-4584-8ea2-d3258b4fa8d6&page=queryresults
[0m08:00:12.522916 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 08:00:11.374475 => 08:00:12.522916
[0m08:00:12.538732 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB93B5E1F0>]}
[0m08:00:12.538732 [info ] [Thread-1  ]: 5 of 13 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m08:00:12.538732 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m08:00:12.538732 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m08:00:12.538732 [info ] [Thread-1  ]: 7 of 13 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m08:00:12.538732 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_pedido)
[0m08:00:12.538732 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m08:00:12.538732 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m08:00:12.538732 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 08:00:12.538732 => 08:00:12.538732
[0m08:00:12.538732 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m08:00:12.538732 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m08:00:12.538732 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:12.554657 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_pedido
        ,nullif(trim(total), '')                     as vl_total_item
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m08:00:12.585900 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 08:00:11.406004 => 08:00:12.585900
[0m08:00:12.587905 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB93B2F5E0>]}
[0m08:00:12.587905 [info ] [Thread-2  ]: 6 of 13 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m08:00:12.589910 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:12.589910 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m08:00:12.589910 [info ] [Thread-2  ]: 8 of 13 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m08:00:12.591914 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m08:00:12.591914 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m08:00:12.593918 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m08:00:12.593918 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 08:00:12.591914 => 08:00:12.593918
[0m08:00:12.593918 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m08:00:12.599937 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m08:00:12.601806 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:12.601806 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m08:00:13.279055 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a3e12b47-0a89-4ee5-88e4-efbb20c7ef98&page=queryresults
[0m08:00:13.334565 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d5138468-f6c4-4bda-adad-d4d2d63e8f76&page=queryresults
[0m08:00:13.696430 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 08:00:12.538732 => 08:00:13.696430
[0m08:00:13.696430 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB93BF61F0>]}
[0m08:00:13.696430 [info ] [Thread-1  ]: 7 of 13 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m08:00:13.696430 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m08:00:13.781734 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 08:00:12.595922 => 08:00:13.781734
[0m08:00:13.781734 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB93BDF7C0>]}
[0m08:00:13.783741 [info ] [Thread-2  ]: 8 of 13 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m08:00:13.783741 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m08:00:13.783741 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m08:00:13.783741 [info ] [Thread-1  ]: 9 of 13 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m08:00:13.783741 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.dm_produto)
[0m08:00:13.783741 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m08:00:13.793274 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m08:00:13.793274 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 08:00:13.783741 => 08:00:13.793274
[0m08:00:13.793274 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m08:00:13.809305 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:14.454905 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m08:00:14.454905 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m08:00:15.166096 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e36ce05c-11e5-4e4d-9a59-4ec609d86c03&page=queryresults
[0m08:00:17.481199 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 08:00:13.793274 => 08:00:17.481199
[0m08:00:17.481199 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB93BF66D0>]}
[0m08:00:17.481199 [info ] [Thread-1  ]: 9 of 13 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 3.70s]
[0m08:00:17.481199 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m08:00:17.481199 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m08:00:17.481199 [info ] [Thread-2  ]: 10 of 13 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m08:00:17.481199 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m08:00:17.481199 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m08:00:17.497150 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m08:00:17.497150 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 08:00:17.481199 => 08:00:17.497150
[0m08:00:17.497150 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m08:00:17.497150 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:18.191022 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m08:00:18.191022 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m08:00:18.983842 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:63448600-753e-4a10-9463-305251b3fd14&page=queryresults
[0m08:00:21.358466 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 08:00:17.497150 => 08:00:21.358466
[0m08:00:21.360480 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB93C0D9D0>]}
[0m08:00:21.362495 [info ] [Thread-2  ]: 10 of 13 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 3.88s]
[0m08:00:21.362495 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m08:00:21.364510 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m08:00:21.364510 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m08:00:21.366524 [info ] [Thread-1  ]: 11 of 13 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m08:00:21.366524 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m08:00:21.366524 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m08:00:21.378264 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m08:00:21.366524 [info ] [Thread-2  ]: 12 of 13 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m08:00:21.383347 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m08:00:21.383347 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m08:00:21.383347 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m08:00:21.383347 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 08:00:21.366524 => 08:00:21.383347
[0m08:00:21.383347 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m08:00:21.394289 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:21.441870 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 08:00:21.383347 => 08:00:21.441870
[0m08:00:21.441870 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m08:00:21.441870 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:22.088693 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m08:00:22.093522 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m08:00:22.102537 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m08:00:22.102537 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m08:00:22.475366 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:119ebf79-724a-4e6c-8da8-50fb6be5ac16&page=queryresults
[0m08:00:22.789995 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e6e1ec8d-a5ba-4d23-a890-ac0941a52d03&page=queryresults
[0m08:00:26.152533 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 08:00:21.441870 => 08:00:26.152533
[0m08:00:26.152533 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB93C9EF10>]}
[0m08:00:26.152533 [info ] [Thread-2  ]: 12 of 13 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 77.2 KiB processed)[0m in 4.77s]
[0m08:00:26.152533 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m08:00:26.152533 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m08:00:26.152533 [info ] [Thread-2  ]: 13 of 13 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m08:00:26.152533 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_preco_produto)
[0m08:00:26.152533 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m08:00:26.168974 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m08:00:26.170923 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 08:00:26.152533 => 08:00:26.170923
[0m08:00:26.170923 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m08:00:26.175416 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:26.488306 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 08:00:21.383347 => 08:00:26.488306
[0m08:00:26.488306 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB93CF5E80>]}
[0m08:00:26.488306 [info ] [Thread-1  ]: 11 of 13 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 5.12s]
[0m08:00:26.488306 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m08:00:26.825369 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m08:00:26.825369 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m08:00:27.465048 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f341d7b5-b496-405b-908d-ac3811fdc1b1&page=queryresults
[0m08:00:29.982157 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 08:00:26.170923 => 08:00:29.982157
[0m08:00:29.983669 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '221d87ad-dc1b-47b3-962a-2faf47ce5c8e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB93CF58B0>]}
[0m08:00:29.983669 [info ] [Thread-2  ]: 13 of 13 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 73.7 KiB processed)[0m in 3.83s]
[0m08:00:29.983669 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m08:00:29.987619 [debug] [MainThread]: Connection 'master' was properly closed.
[0m08:00:29.987619 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:00:29.990210 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:00:29.990210 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m08:00:29.990210 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m08:00:29.990210 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m08:00:29.990210 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m08:00:29.992220 [info ] [MainThread]: 
[0m08:00:29.992220 [info ] [MainThread]: Finished running 8 view models, 5 table models in 0 hours 0 minutes and 24.19 seconds (24.19s).
[0m08:00:29.996240 [debug] [MainThread]: Command end result
[0m08:00:30.019456 [info ] [MainThread]: 
[0m08:00:30.019456 [info ] [MainThread]: [32mCompleted successfully[0m
[0m08:00:30.019456 [info ] [MainThread]: 
[0m08:00:30.019456 [info ] [MainThread]: Done. PASS=13 WARN=0 ERROR=0 SKIP=0 TOTAL=13
[0m08:00:30.019456 [debug] [MainThread]: Command `dbt run` succeeded at 08:00:30.019456 after 25.24 seconds
[0m08:00:30.028332 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB8F17B400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB93BDF7C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB928BC280>]}
[0m08:00:30.028332 [debug] [MainThread]: Flushing usage events
[0m08:00:34.411738 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137C30C3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137C204F670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137C204FD90>]}


============================== 08:00:34.433699 | 48318e7d-d37c-4b71-8b30-a3066e7a7abc ==============================
[0m08:00:34.433699 [info ] [MainThread]: Running with dbt=1.7.4
[0m08:00:34.433699 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt snapshot', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m08:00:35.252340 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '48318e7d-d37c-4b71-8b30-a3066e7a7abc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137C2039070>]}
[0m08:00:35.299671 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '48318e7d-d37c-4b71-8b30-a3066e7a7abc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137C6724BE0>]}
[0m08:00:35.299671 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m08:00:35.315614 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m08:00:35.363766 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m08:00:35.363766 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m08:00:35.363766 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '48318e7d-d37c-4b71-8b30-a3066e7a7abc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137C69EDF10>]}
[0m08:00:35.379663 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '48318e7d-d37c-4b71-8b30-a3066e7a7abc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137C685ECD0>]}
[0m08:00:35.379663 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m08:00:35.379663 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '48318e7d-d37c-4b71-8b30-a3066e7a7abc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137C685EEE0>]}
[0m08:00:35.379663 [info ] [MainThread]: 
[0m08:00:35.379663 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m08:00:35.379663 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:35.379663 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:36.057048 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m08:00:36.057048 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:36.057048 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m08:00:36.057048 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:38.614959 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m08:00:38.614959 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:38.655730 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m08:00:38.655730 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:41.419496 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '48318e7d-d37c-4b71-8b30-a3066e7a7abc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137C685EC70>]}
[0m08:00:41.421250 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m08:00:41.421250 [info ] [MainThread]: 
[0m08:00:41.424745 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m08:00:41.424745 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m08:00:41.428755 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m08:00:41.428755 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m08:00:41.438799 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 08:00:41.430768 => 08:00:41.438799
[0m08:00:41.438799 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m08:00:41.533863 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m08:00:41.537888 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m08:00:42.438010 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ff677655-79a4-4e58-95cc-356de2d64b6f&page=queryresults
[0m08:00:43.592872 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m08:00:44.043041 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:58ceed5d-3b53-489f-ae5e-af85e490bde1&page=queryresults
[0m08:00:46.938066 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m08:00:47.603637 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m08:00:47.607660 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m08:00:48.031822 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:534b3c71-62b3-4f1b-8d0a-2bda3776cb00&page=queryresults
[0m08:00:50.593508 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 08:00:41.438799 => 08:00:50.593508
[0m08:00:50.593508 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '48318e7d-d37c-4b71-8b30-a3066e7a7abc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137C6A6E340>]}
[0m08:00:50.593508 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 65.3 KiB processed)[0m in 9.16s]
[0m08:00:50.593508 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m08:00:50.601233 [debug] [MainThread]: Connection 'master' was properly closed.
[0m08:00:50.601233 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:00:50.601233 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m08:00:50.601233 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m08:00:50.601233 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m08:00:50.601233 [info ] [MainThread]: 
[0m08:00:50.601233 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 15.22 seconds (15.22s).
[0m08:00:50.601233 [debug] [MainThread]: Command end result
[0m08:00:50.622261 [info ] [MainThread]: 
[0m08:00:50.625106 [info ] [MainThread]: [32mCompleted successfully[0m
[0m08:00:50.625106 [info ] [MainThread]: 
[0m08:00:50.625106 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m08:00:50.625106 [debug] [MainThread]: Command `dbt snapshot` succeeded at 08:00:50.625106 after 16.27 seconds
[0m08:00:50.625106 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137C30C3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137C66861F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000137C66E4C70>]}
[0m08:00:50.625106 [debug] [MainThread]: Flushing usage events
[0m08:00:54.128620 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C5F6C83430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C5F5BF19D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C5F5BF1B80>]}


============================== 08:00:54.129873 | ad6becc5-b4fe-4196-bf80-5472e6ffbc65 ==============================
[0m08:00:54.129873 [info ] [MainThread]: Running with dbt=1.7.4
[0m08:00:54.129873 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select tag:snaps', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m08:00:54.905636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ad6becc5-b4fe-4196-bf80-5472e6ffbc65', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C5F5BEA130>]}
[0m08:00:54.969204 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ad6becc5-b4fe-4196-bf80-5472e6ffbc65', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C5FA1D4A30>]}
[0m08:00:54.969204 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m08:00:54.985070 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m08:00:55.017048 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m08:00:55.017048 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m08:00:55.033076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ad6becc5-b4fe-4196-bf80-5472e6ffbc65', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C5FA5AEC40>]}
[0m08:00:55.033076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ad6becc5-b4fe-4196-bf80-5472e6ffbc65', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C5FA401940>]}
[0m08:00:55.033076 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m08:00:55.033076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ad6becc5-b4fe-4196-bf80-5472e6ffbc65', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C5FA4019A0>]}
[0m08:00:55.033076 [info ] [MainThread]: 
[0m08:00:55.033076 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m08:00:55.048740 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:55.048740 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:55.709929 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m08:00:55.709929 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:55.709929 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m08:00:55.709929 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:56.368278 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m08:00:56.368278 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:56.397840 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m08:00:56.397840 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:56.975814 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ad6becc5-b4fe-4196-bf80-5472e6ffbc65', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C5FA34D760>]}
[0m08:00:56.975814 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m08:00:56.975814 [info ] [MainThread]: 
[0m08:00:56.991561 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m08:00:56.991561 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m08:00:56.991561 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m08:00:56.991561 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m08:00:57.007683 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m08:00:57.007683 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 08:00:56.991561 => 08:00:57.007683
[0m08:00:57.007683 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m08:00:57.023431 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m08:00:57.731680 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m08:00:57.731680 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m08:00:58.203993 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fcc2e86f-3501-401c-a7dd-fa0031af1282&page=queryresults
[0m08:01:00.119686 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 08:00:57.007683 => 08:01:00.119686
[0m08:01:00.119686 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ad6becc5-b4fe-4196-bf80-5472e6ffbc65', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C5FA34D8E0>]}
[0m08:01:00.119686 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (363.0 rows, 53.3 KiB processed)[0m in 3.13s]
[0m08:01:00.119686 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m08:01:00.119686 [debug] [MainThread]: Connection 'master' was properly closed.
[0m08:01:00.119686 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:01:00.119686 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m08:01:00.119686 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m08:01:00.119686 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m08:01:00.119686 [info ] [MainThread]: 
[0m08:01:00.119686 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.09 seconds (5.09s).
[0m08:01:00.119686 [debug] [MainThread]: Command end result
[0m08:01:00.135726 [info ] [MainThread]: 
[0m08:01:00.135726 [info ] [MainThread]: [32mCompleted successfully[0m
[0m08:01:00.135726 [info ] [MainThread]: 
[0m08:01:00.135726 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m08:01:00.135726 [debug] [MainThread]: Command `dbt run` succeeded at 08:01:00.135726 after 6.08 seconds
[0m08:01:00.147294 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C5F6C83430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C5FA25B730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C5FA63BF70>]}
[0m08:01:00.147294 [debug] [MainThread]: Flushing usage events
[0m09:00:04.271514 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EDEE73460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EDDDF39A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EDDDF3D30>]}


============================== 09:00:04.271514 | 8c03fd22-f797-4a53-9a6c-4e4ae4921747 ==============================
[0m09:00:04.271514 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:00:04.271514 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --exclude tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m09:00:05.115499 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE0FBDB80>]}
[0m09:00:05.179527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE24E1A30>]}
[0m09:00:05.179527 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:00:05.195428 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:00:05.259039 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:00:05.259039 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:00:05.259039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE279EE50>]}
[0m09:00:05.276780 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE26DFA30>]}
[0m09:00:05.276780 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:00:05.276780 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE26DFAF0>]}
[0m09:00:05.276780 [info ] [MainThread]: 
[0m09:00:05.276780 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:00:05.276780 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:05.276780 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:05.276780 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:05.276780 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:06.077934 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:06.761076 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m09:00:06.762831 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:06.762831 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m09:00:06.762831 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:07.444029 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m09:00:07.444029 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:07.476011 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m09:00:07.476011 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:08.131123 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE2502040>]}
[0m09:00:08.133137 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:00:08.133137 [info ] [MainThread]: 
[0m09:00:08.141198 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:08.143210 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m09:00:08.144972 [info ] [Thread-1  ]: 1 of 13 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m09:00:08.149000 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m09:00:08.146987 [info ] [Thread-2  ]: 2 of 13 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m09:00:08.151015 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:08.153030 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m09:00:08.170902 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:00:08.170902 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m09:00:08.176679 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m09:00:08.176679 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 09:00:08.153030 => 09:00:08.176679
[0m09:00:08.178700 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:08.188765 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 09:00:08.172911 => 09:00:08.188765
[0m09:00:08.190774 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m09:00:08.226281 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m09:00:08.232317 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:00:08.234324 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:00:08.234324 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m09:00:08.236333 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m09:00:08.238355 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m09:00:09.132794 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3909598e-f367-42a3-88c9-e97d399ee6ca&page=queryresults
[0m09:00:09.132794 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3a7b622f-20f5-46e5-bc68-8edda8178983&page=queryresults
[0m09:00:09.610742 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 09:00:08.190774 => 09:00:09.610742
[0m09:00:09.610742 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 09:00:08.178700 => 09:00:09.610742
[0m09:00:09.610742 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE3880B50>]}
[0m09:00:09.610742 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE388A100>]}
[0m09:00:09.610742 [info ] [Thread-2  ]: 2 of 13 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m09:00:09.626533 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m09:00:09.610742 [info ] [Thread-1  ]: 1 of 13 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m09:00:09.626533 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m09:00:09.626533 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:09.626533 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m09:00:09.626533 [info ] [Thread-2  ]: 3 of 13 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m09:00:09.626533 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m09:00:09.626533 [info ] [Thread-1  ]: 4 of 13 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m09:00:09.626533 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m09:00:09.626533 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m09:00:09.626533 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m09:00:09.626533 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m09:00:09.626533 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m09:00:09.626533 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 09:00:09.626533 => 09:00:09.626533
[0m09:00:09.626533 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m09:00:09.626533 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m09:00:09.626533 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 09:00:09.626533 => 09:00:09.626533
[0m09:00:09.626533 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m09:00:09.626533 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m09:00:09.626533 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:09.642560 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m09:00:09.642560 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:09.658678 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m09:00:10.498432 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bc10fb6f-f778-4afd-bb17-bfdb4d3dadca&page=queryresults
[0m09:00:10.514450 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b4ce251b-2674-47ff-b350-b029256ec44f&page=queryresults
[0m09:00:10.915893 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 09:00:09.626533 => 09:00:10.915893
[0m09:00:10.915893 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE3921EB0>]}
[0m09:00:10.915893 [info ] [Thread-2  ]: 3 of 13 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m09:00:10.915893 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m09:00:10.915893 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m09:00:10.915893 [info ] [Thread-2  ]: 5 of 13 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m09:00:10.915893 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m09:00:10.932130 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m09:00:10.932130 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m09:00:10.932130 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 09:00:10.932130 => 09:00:10.932130
[0m09:00:10.932130 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m09:00:10.948316 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 09:00:09.626533 => 09:00:10.948316
[0m09:00:10.948316 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE3814FD0>]}
[0m09:00:10.948316 [info ] [Thread-1  ]: 4 of 13 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m09:00:10.964154 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m09:00:10.967951 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m09:00:10.967951 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:10.967951 [info ] [Thread-1  ]: 6 of 13 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m09:00:10.967951 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m09:00:10.967951 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:10.980282 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:10.980282 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m09:00:10.980282 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m09:00:11.028245 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 09:00:10.967951 => 09:00:11.028245
[0m09:00:11.028245 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:11.028245 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m09:00:11.028245 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:11.028245 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m09:00:11.768117 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:741bde78-287e-47cf-baa6-ac75668075fa&page=queryresults
[0m09:00:11.852732 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1c2c1f97-a3ba-49f8-b7e6-26990121f79c&page=queryresults
[0m09:00:12.154567 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 09:00:10.932130 => 09:00:12.154567
[0m09:00:12.154567 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE38232B0>]}
[0m09:00:12.154567 [info ] [Thread-2  ]: 5 of 13 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m09:00:12.154567 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m09:00:12.154567 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m09:00:12.154567 [info ] [Thread-2  ]: 7 of 13 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m09:00:12.154567 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_pedido)
[0m09:00:12.154567 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m09:00:12.170584 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m09:00:12.170584 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 09:00:12.154567 => 09:00:12.170584
[0m09:00:12.170584 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m09:00:12.170584 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m09:00:12.170584 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:12.170584 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_pedido
        ,nullif(trim(total), '')                     as vl_total_item
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m09:00:12.250358 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 09:00:11.028245 => 09:00:12.250358
[0m09:00:12.250358 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE27AB730>]}
[0m09:00:12.250358 [info ] [Thread-1  ]: 6 of 13 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m09:00:12.250358 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:12.250358 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m09:00:12.250358 [info ] [Thread-1  ]: 8 of 13 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m09:00:12.250358 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m09:00:12.250358 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m09:00:12.266367 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m09:00:12.266367 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 09:00:12.250358 => 09:00:12.266367
[0m09:00:12.266367 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m09:00:12.266367 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m09:00:12.266367 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:12.266367 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m09:00:12.943249 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:736bcbbf-1e89-40fd-b8dd-c1d8438daf52&page=queryresults
[0m09:00:13.023321 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:00e79f82-2bc3-4886-a953-6d8006471a22&page=queryresults
[0m09:00:13.365130 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 09:00:12.170584 => 09:00:13.365130
[0m09:00:13.380738 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE38E5340>]}
[0m09:00:13.380738 [info ] [Thread-2  ]: 7 of 13 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m09:00:13.380738 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m09:00:13.448543 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 09:00:12.266367 => 09:00:13.448543
[0m09:00:13.448543 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE27AB730>]}
[0m09:00:13.448543 [info ] [Thread-1  ]: 8 of 13 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m09:00:13.448543 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m09:00:13.448543 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m09:00:13.461239 [info ] [Thread-2  ]: 9 of 13 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m09:00:13.461239 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.dm_produto)
[0m09:00:13.461239 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m09:00:13.461239 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m09:00:13.461239 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 09:00:13.461239 => 09:00:13.461239
[0m09:00:13.461239 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m09:00:13.477306 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:14.118112 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m09:00:14.118112 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m09:00:14.747272 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:11e4f253-ddc0-4502-9ebc-ffa71ef293d1&page=queryresults
[0m09:00:17.292616 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 09:00:13.461239 => 09:00:17.292616
[0m09:00:17.292616 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE393AD60>]}
[0m09:00:17.292616 [info ] [Thread-2  ]: 9 of 13 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 3.83s]
[0m09:00:17.292616 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m09:00:17.292616 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m09:00:17.292616 [info ] [Thread-1  ]: 10 of 13 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m09:00:17.292616 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m09:00:17.292616 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m09:00:17.306613 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m09:00:17.308366 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 09:00:17.292616 => 09:00:17.308366
[0m09:00:17.308366 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m09:00:17.313422 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:17.949890 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m09:00:17.949890 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m09:00:18.700016 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:eef191aa-0730-494e-933c-fda7ec74955a&page=queryresults
[0m09:00:21.198666 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 09:00:17.311417 => 09:00:21.198666
[0m09:00:21.198666 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE3840CA0>]}
[0m09:00:21.198666 [info ] [Thread-1  ]: 10 of 13 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 3.91s]
[0m09:00:21.198666 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m09:00:21.198666 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m09:00:21.198666 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m09:00:21.198666 [info ] [Thread-2  ]: 11 of 13 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m09:00:21.214776 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m09:00:21.214776 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m09:00:21.214776 [info ] [Thread-1  ]: 12 of 13 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m09:00:21.214776 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m09:00:21.214776 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m09:00:21.230999 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m09:00:21.230999 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m09:00:21.230999 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 09:00:21.214776 => 09:00:21.230999
[0m09:00:21.246744 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 09:00:21.214776 => 09:00:21.246744
[0m09:00:21.248533 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m09:00:21.248533 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m09:00:21.248533 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:21.248533 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:21.920729 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m09:00:21.920729 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m09:00:21.920729 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m09:00:21.920729 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m09:00:22.292308 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1b7bac57-7182-4615-bb5b-9fb1c4aec0f5&page=queryresults
[0m09:00:22.524104 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f0c1f7c6-f641-4e38-b4ef-db8ebe64ff0c&page=queryresults
[0m09:00:24.504999 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 09:00:21.248533 => 09:00:24.504999
[0m09:00:24.504999 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE39D0A30>]}
[0m09:00:24.504999 [info ] [Thread-1  ]: 12 of 13 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 77.2 KiB processed)[0m in 3.29s]
[0m09:00:24.504999 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m09:00:24.504999 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m09:00:24.504999 [info ] [Thread-1  ]: 13 of 13 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m09:00:24.504999 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_preco_produto)
[0m09:00:24.504999 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m09:00:24.520863 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m09:00:24.520863 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 09:00:24.515826 => 09:00:24.520863
[0m09:00:24.520863 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m09:00:24.520863 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:24.802880 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 09:00:21.248533 => 09:00:24.802880
[0m09:00:24.802880 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE39E5220>]}
[0m09:00:24.804893 [info ] [Thread-2  ]: 11 of 13 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 3.59s]
[0m09:00:24.804893 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m09:00:26.099043 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m09:00:26.103070 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m09:00:26.721063 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:769eadb0-095b-41a2-9de2-5cde345480d0&page=queryresults
[0m09:00:31.071447 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 09:00:24.520863 => 09:00:31.071447
[0m09:00:31.071447 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8c03fd22-f797-4a53-9a6c-4e4ae4921747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE3993A30>]}
[0m09:00:31.073460 [info ] [Thread-1  ]: 13 of 13 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 73.7 KiB processed)[0m in 6.57s]
[0m09:00:31.073460 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m09:00:31.078993 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:00:31.078993 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:00:31.078993 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:00:31.081005 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m09:00:31.081005 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m09:00:31.081005 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m09:00:31.081005 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m09:00:31.081005 [info ] [MainThread]: 
[0m09:00:31.083017 [info ] [MainThread]: Finished running 8 view models, 5 table models in 0 hours 0 minutes and 25.80 seconds (25.80s).
[0m09:00:31.087039 [debug] [MainThread]: Command end result
[0m09:00:31.113712 [info ] [MainThread]: 
[0m09:00:31.113712 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:00:31.113712 [info ] [MainThread]: 
[0m09:00:31.113712 [info ] [MainThread]: Done. PASS=13 WARN=0 ERROR=0 SKIP=0 TOTAL=13
[0m09:00:31.113712 [debug] [MainThread]: Command `dbt run` succeeded at 09:00:31.113712 after 26.91 seconds
[0m09:00:31.120071 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EDEE73460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE24E1A30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011EE26DFCD0>]}
[0m09:00:31.120071 [debug] [MainThread]: Flushing usage events
[0m09:00:34.975606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B16D453430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B16C3DC9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B16C3DCD30>]}


============================== 09:00:34.975606 | 90577586-7091-4773-88da-b2827afb7a4d ==============================
[0m09:00:34.975606 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:00:34.975606 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt snapshot', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m09:00:35.767647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '90577586-7091-4773-88da-b2827afb7a4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B16F59ABB0>]}
[0m09:00:35.815288 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '90577586-7091-4773-88da-b2827afb7a4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B170AAE640>]}
[0m09:00:35.815288 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:00:35.831112 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:00:35.879057 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:00:35.879057 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:00:35.879057 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '90577586-7091-4773-88da-b2827afb7a4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B170D7DCA0>]}
[0m09:00:35.894858 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '90577586-7091-4773-88da-b2827afb7a4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B170BD09A0>]}
[0m09:00:35.894858 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:00:35.894858 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '90577586-7091-4773-88da-b2827afb7a4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B170BD0A00>]}
[0m09:00:35.897605 [info ] [MainThread]: 
[0m09:00:35.897605 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:00:35.897605 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:35.897605 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:36.553697 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m09:00:36.553697 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:36.553697 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m09:00:36.553697 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:38.797670 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m09:00:38.797670 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:38.993722 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m09:00:38.993722 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:43.458464 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '90577586-7091-4773-88da-b2827afb7a4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B170A29670>]}
[0m09:00:43.460985 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:00:43.460985 [info ] [MainThread]: 
[0m09:00:43.464414 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:00:43.468214 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m09:00:43.468214 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m09:00:43.468214 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:00:43.484388 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 09:00:43.468214 => 09:00:43.482375
[0m09:00:43.484388 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:00:43.536523 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:00:43.552363 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m09:00:44.322343 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:040d2c17-5186-4d20-b798-90696dc97da7&page=queryresults
[0m09:00:45.663156 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m09:00:46.157075 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:520b7c27-2854-44ce-a55c-4705e8e4f4dd&page=queryresults
[0m09:00:49.101404 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m09:00:49.855263 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m09:00:49.855263 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m09:00:50.284560 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:aa447a98-ee9c-4b02-8428-d92ed70c84a2&page=queryresults
[0m09:00:52.649695 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 09:00:43.484388 => 09:00:52.649695
[0m09:00:52.651710 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '90577586-7091-4773-88da-b2827afb7a4d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B171E26580>]}
[0m09:00:52.651710 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 65.3 KiB processed)[0m in 9.18s]
[0m09:00:52.653723 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:00:52.655733 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:00:52.655733 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:00:52.657708 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m09:00:52.657708 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m09:00:52.657708 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m09:00:52.657708 [info ] [MainThread]: 
[0m09:00:52.657708 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 16.76 seconds (16.76s).
[0m09:00:52.662217 [debug] [MainThread]: Command end result
[0m09:00:52.673726 [info ] [MainThread]: 
[0m09:00:52.673726 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:00:52.673726 [info ] [MainThread]: 
[0m09:00:52.673726 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m09:00:52.673726 [debug] [MainThread]: Command `dbt snapshot` succeeded at 09:00:52.673726 after 17.76 seconds
[0m09:00:52.681311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B16D453430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B170B18D30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B170B85790>]}
[0m09:00:52.681311 [debug] [MainThread]: Flushing usage events
[0m09:00:56.709865 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFC9CC93D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFC8C482E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFC8C48760>]}


============================== 09:00:56.726063 | 61dd1099-664f-4db2-95d0-c83d8e84b51d ==============================
[0m09:00:56.726063 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:00:56.726063 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select tag:snaps', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m09:00:57.520057 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '61dd1099-664f-4db2-95d0-c83d8e84b51d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFC8C2AAF0>]}
[0m09:00:57.584101 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '61dd1099-664f-4db2-95d0-c83d8e84b51d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFCD340580>]}
[0m09:00:57.587224 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:00:57.587224 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:00:57.631631 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:00:57.631631 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:00:57.631631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '61dd1099-664f-4db2-95d0-c83d8e84b51d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFCD5FEBE0>]}
[0m09:00:57.647703 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '61dd1099-664f-4db2-95d0-c83d8e84b51d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFCD53E8E0>]}
[0m09:00:57.647703 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:00:57.647703 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '61dd1099-664f-4db2-95d0-c83d8e84b51d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFCD53E940>]}
[0m09:00:57.647703 [info ] [MainThread]: 
[0m09:00:57.647703 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:00:57.647703 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:57.647703 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:58.387236 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m09:00:58.387236 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m09:00:58.387236 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:58.387236 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:58.982073 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m09:00:58.982073 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:59.014274 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m09:00:59.030135 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:59.624234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '61dd1099-664f-4db2-95d0-c83d8e84b51d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFCD608220>]}
[0m09:00:59.624234 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:00:59.624234 [info ] [MainThread]: 
[0m09:00:59.640061 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:00:59.640061 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m09:00:59.640061 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m09:00:59.640061 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:00:59.655880 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m09:00:59.655880 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 09:00:59.640061 => 09:00:59.655880
[0m09:00:59.655880 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:00:59.655880 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:01:00.631992 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m09:01:00.631992 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m09:01:01.027294 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:27a684e6-7ebe-4907-8406-e80b80decf8e&page=queryresults
[0m09:01:02.756973 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 09:00:59.655880 => 09:01:02.756973
[0m09:01:02.756973 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '61dd1099-664f-4db2-95d0-c83d8e84b51d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFCD2D4A00>]}
[0m09:01:02.758985 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (363.0 rows, 53.3 KiB processed)[0m in 3.12s]
[0m09:01:02.758985 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:01:02.758985 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:01:02.758985 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:01:02.758985 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m09:01:02.758985 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m09:01:02.758985 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m09:01:02.767026 [info ] [MainThread]: 
[0m09:01:02.767026 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.11 seconds (5.11s).
[0m09:01:02.767026 [debug] [MainThread]: Command end result
[0m09:01:02.782793 [info ] [MainThread]: 
[0m09:01:02.782793 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:01:02.782793 [info ] [MainThread]: 
[0m09:01:02.782793 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m09:01:02.782793 [debug] [MainThread]: Command `dbt run` succeeded at 09:01:02.782793 after 6.15 seconds
[0m09:01:02.782793 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFC9CC93D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFCD340580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AFCD3BEBB0>]}
[0m09:01:02.782793 [debug] [MainThread]: Flushing usage events
[0m10:00:04.777354 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DDECD3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DDDC509A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DDDC50D30>]}


============================== 10:00:04.777354 | fb045768-2896-41d7-8ed0-3bcd95b0f751 ==============================
[0m10:00:04.777354 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:00:04.777354 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --exclude tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m10:00:05.631886 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DDDC4D8B0>]}
[0m10:00:05.686980 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE2341970>]}
[0m10:00:05.688985 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:00:05.698768 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:00:05.748447 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:00:05.748447 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:00:05.752457 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE25FEDC0>]}
[0m10:00:05.762225 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE253F940>]}
[0m10:00:05.762225 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:00:05.762225 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE253FB20>]}
[0m10:00:05.762225 [info ] [MainThread]: 
[0m10:00:05.762225 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:00:05.762225 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:05.762225 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:05.762225 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:05.762225 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:06.600869 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:07.297774 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:00:07.297774 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m10:00:07.297774 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:07.297774 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:08.041154 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m10:00:08.041154 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:08.041154 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m10:00:08.065169 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:08.675530 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE23D7910>]}
[0m10:00:08.675530 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:00:08.691318 [info ] [MainThread]: 
[0m10:00:08.691318 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:08.691318 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m10:00:08.691318 [info ] [Thread-1  ]: 1 of 13 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m10:00:08.691318 [info ] [Thread-2  ]: 2 of 13 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m10:00:08.691318 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m10:00:08.707366 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m10:00:08.707366 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:08.707366 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m10:00:08.707366 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:00:08.723189 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m10:00:08.723189 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 10:00:08.707366 => 10:00:08.723189
[0m10:00:08.723189 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:08.723189 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 10:00:08.707366 => 10:00:08.723189
[0m10:00:08.723189 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m10:00:08.771464 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m10:00:08.787614 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:00:08.787614 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:00:08.787614 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m10:00:08.821233 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:00:08.821233 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m10:00:09.697671 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1daff403-969c-408d-94f8-387fa1af259a&page=queryresults
[0m10:00:09.729504 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8d4b2d67-a7c2-4369-b6ca-0695890daeaf&page=queryresults
[0m10:00:10.159599 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 10:00:08.739215 => 10:00:10.159599
[0m10:00:10.159599 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE3681FA0>]}
[0m10:00:10.175535 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 10:00:08.723189 => 10:00:10.175535
[0m10:00:10.175535 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE36EDB50>]}
[0m10:00:10.175535 [info ] [Thread-2  ]: 2 of 13 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m10:00:10.175535 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m10:00:10.175535 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m10:00:10.175535 [info ] [Thread-1  ]: 1 of 13 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.48s]
[0m10:00:10.175535 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:10.175535 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m10:00:10.175535 [info ] [Thread-2  ]: 3 of 13 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m10:00:10.175535 [info ] [Thread-1  ]: 4 of 13 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m10:00:10.175535 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m10:00:10.175535 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m10:00:10.175535 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m10:00:10.175535 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m10:00:10.191481 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m10:00:10.191481 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m10:00:10.191481 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 10:00:10.175535 => 10:00:10.191481
[0m10:00:10.191481 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m10:00:10.191481 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m10:00:10.191481 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 10:00:10.191481 => 10:00:10.191481
[0m10:00:10.191481 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:10.191481 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m10:00:10.207741 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m10:00:10.207741 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m10:00:10.239556 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:10.239556 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m10:00:10.956898 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:57a68fe5-a918-482c-b7f1-f3f8f97f2b01&page=queryresults
[0m10:00:10.988537 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c3b9b8e4-37bc-483b-856f-77a9af791211&page=queryresults
[0m10:00:11.379055 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 10:00:10.191481 => 10:00:11.379055
[0m10:00:11.379055 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE36CA220>]}
[0m10:00:11.379055 [info ] [Thread-2  ]: 3 of 13 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m10:00:11.379055 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m10:00:11.379055 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m10:00:11.379055 [info ] [Thread-2  ]: 5 of 13 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m10:00:11.388485 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 10:00:10.207741 => 10:00:11.388485
[0m10:00:11.388485 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m10:00:11.388485 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE3681D30>]}
[0m10:00:11.388485 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m10:00:11.388485 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m10:00:11.388485 [info ] [Thread-1  ]: 4 of 13 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m10:00:11.388485 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m10:00:11.404625 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:11.404625 [info ] [Thread-1  ]: 6 of 13 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m10:00:11.404625 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_meta_margem_preco)
[0m10:00:11.404625 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:11.404625 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 10:00:11.388485 => 10:00:11.404625
[0m10:00:11.404625 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m10:00:11.404625 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m10:00:11.420722 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:11.420722 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m10:00:11.452327 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m10:00:11.452327 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 10:00:11.404625 => 10:00:11.452327
[0m10:00:11.452327 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:11.468087 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m10:00:11.468087 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:11.468087 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m10:00:12.159634 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:01a33ae4-397b-4f94-98e7-bd3aec6375ee&page=queryresults
[0m10:00:12.159634 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:db6aa0e4-9877-4bca-a26a-c604427d1217&page=queryresults
[0m10:00:12.563097 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 10:00:11.452327 => 10:00:12.563097
[0m10:00:12.563097 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE36CA130>]}
[0m10:00:12.563097 [info ] [Thread-1  ]: 6 of 13 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m10:00:12.563097 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:12.563097 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m10:00:12.563097 [info ] [Thread-1  ]: 7 of 13 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m10:00:12.563097 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_pedido)
[0m10:00:12.579129 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m10:00:12.579129 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m10:00:12.579129 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 10:00:12.579129 => 10:00:12.579129
[0m10:00:12.579129 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m10:00:12.579129 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m10:00:12.579129 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:12.595305 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_pedido
        ,nullif(trim(total), '')                     as vl_total_item
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m10:00:12.627003 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 10:00:11.404625 => 10:00:12.627003
[0m10:00:12.627003 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE36E0190>]}
[0m10:00:12.627003 [info ] [Thread-2  ]: 5 of 13 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m10:00:12.627003 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m10:00:12.627003 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m10:00:12.627003 [info ] [Thread-2  ]: 8 of 13 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m10:00:12.627003 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_produto)
[0m10:00:12.627003 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m10:00:12.627003 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m10:00:12.627003 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 10:00:12.627003 => 10:00:12.627003
[0m10:00:12.627003 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m10:00:12.643085 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m10:00:12.643085 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:12.643085 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m10:00:13.482702 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dfc4badf-df53-49c6-bfb8-8943151bc31f&page=queryresults
[0m10:00:13.482702 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e6d0447d-63ec-4cd9-ab79-798bdca74e1c&page=queryresults
[0m10:00:13.890660 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 10:00:12.579129 => 10:00:13.890660
[0m10:00:13.890660 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE3768970>]}
[0m10:00:13.890660 [info ] [Thread-1  ]: 7 of 13 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m10:00:13.902384 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 10:00:12.627003 => 10:00:13.902384
[0m10:00:13.902384 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m10:00:13.902384 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE37D6A00>]}
[0m10:00:13.902384 [info ] [Thread-2  ]: 8 of 13 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m10:00:13.902384 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m10:00:13.902384 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m10:00:13.902384 [info ] [Thread-1  ]: 9 of 13 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m10:00:13.902384 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.dm_produto)
[0m10:00:13.902384 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m10:00:13.924371 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m10:00:13.924371 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 10:00:13.915667 => 10:00:13.924371
[0m10:00:13.924371 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m10:00:13.933816 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:14.560229 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m10:00:14.575978 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m10:00:15.276795 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:02058619-5e45-4836-a95c-5180b497c3b3&page=queryresults
[0m10:00:19.383551 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 10:00:13.924371 => 10:00:19.383551
[0m10:00:19.383551 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE36D38E0>]}
[0m10:00:19.383551 [info ] [Thread-1  ]: 9 of 13 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 5.48s]
[0m10:00:19.383551 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m10:00:19.383551 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m10:00:19.383551 [info ] [Thread-2  ]: 10 of 13 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m10:00:19.395797 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m10:00:19.397812 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m10:00:19.401833 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m10:00:19.421367 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 10:00:19.397812 => 10:00:19.421367
[0m10:00:19.421367 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m10:00:19.425389 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:20.065037 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m10:00:20.069064 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m10:00:20.894378 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:eb33f90f-c804-4ea4-9555-698e9d635bc1&page=queryresults
[0m10:00:23.667726 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 10:00:19.423378 => 10:00:23.667726
[0m10:00:23.669826 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE37A5BB0>]}
[0m10:00:23.669826 [info ] [Thread-2  ]: 10 of 13 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 4.27s]
[0m10:00:23.671838 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m10:00:23.671838 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m10:00:23.671838 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m10:00:23.674489 [info ] [Thread-1  ]: 11 of 13 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m10:00:23.674489 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m10:00:23.676498 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m10:00:23.680510 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m10:00:23.674489 [info ] [Thread-2  ]: 12 of 13 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m10:00:23.680510 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m10:00:23.680510 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m10:00:23.683823 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 10:00:23.676498 => 10:00:23.683823
[0m10:00:23.689061 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m10:00:23.689061 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m10:00:23.689061 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:23.689061 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 10:00:23.680510 => 10:00:23.689061
[0m10:00:23.689061 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m10:00:23.697519 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:24.223470 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m10:00:24.223470 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m10:00:24.303431 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m10:00:24.319226 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m10:00:24.702189 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:88356722-d000-4f01-b1e0-d081d99cd101&page=queryresults
[0m10:00:24.884033 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4fe26f36-88e7-4d9c-bed2-6e117fef3ff7&page=queryresults
[0m10:00:27.360750 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 10:00:23.689061 => 10:00:27.360750
[0m10:00:27.360750 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE3796EE0>]}
[0m10:00:27.360750 [info ] [Thread-1  ]: 11 of 13 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 3.69s]
[0m10:00:27.360750 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m10:00:27.360750 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m10:00:27.376774 [info ] [Thread-1  ]: 13 of 13 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m10:00:27.376774 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_preco_produto)
[0m10:00:27.376774 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m10:00:27.376774 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m10:00:27.376774 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 10:00:27.376774 => 10:00:27.376774
[0m10:00:27.376774 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m10:00:27.392591 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:27.489289 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 10:00:23.689061 => 10:00:27.489289
[0m10:00:27.489289 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE37CE160>]}
[0m10:00:27.489289 [info ] [Thread-2  ]: 12 of 13 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 77.2 KiB processed)[0m in 3.81s]
[0m10:00:27.489289 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m10:00:27.939896 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m10:00:27.939896 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m10:00:28.600556 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bd99ce01-a063-46fd-bd57-79fa9dae5f5e&page=queryresults
[0m10:00:33.036209 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 10:00:27.376774 => 10:00:33.036209
[0m10:00:33.038861 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb045768-2896-41d7-8ed0-3bcd95b0f751', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE36EDB50>]}
[0m10:00:33.038861 [info ] [Thread-1  ]: 13 of 13 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 73.7 KiB processed)[0m in 5.66s]
[0m10:00:33.038861 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m10:00:33.038861 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:00:33.038861 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:33.038861 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:33.038861 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m10:00:33.038861 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m10:00:33.038861 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m10:00:33.038861 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_geral' was properly closed.
[0m10:00:33.038861 [info ] [MainThread]: 
[0m10:00:33.038861 [info ] [MainThread]: Finished running 8 view models, 5 table models in 0 hours 0 minutes and 27.28 seconds (27.28s).
[0m10:00:33.038861 [debug] [MainThread]: Command end result
[0m10:00:33.075019 [info ] [MainThread]: 
[0m10:00:33.075019 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:00:33.075019 [info ] [MainThread]: 
[0m10:00:33.075019 [info ] [MainThread]: Done. PASS=13 WARN=0 ERROR=0 SKIP=0 TOTAL=13
[0m10:00:33.075019 [debug] [MainThread]: Command `dbt run` succeeded at 10:00:33.075019 after 28.35 seconds
[0m10:00:33.083948 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DDECD3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE2408F10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027DE22DA850>]}
[0m10:00:33.083948 [debug] [MainThread]: Flushing usage events
[0m10:00:36.573067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F25D09460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F24C94670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F24C94D90>]}


============================== 10:00:36.585753 | a036208d-0cd4-49f8-bb3f-b26393a5d9f7 ==============================
[0m10:00:36.585753 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:00:36.585753 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt snapshot', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:00:37.395872 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a036208d-0cd4-49f8-bb3f-b26393a5d9f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F24C8FBB0>]}
[0m10:00:37.443224 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a036208d-0cd4-49f8-bb3f-b26393a5d9f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F24C4EFD0>]}
[0m10:00:37.443224 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:00:37.458929 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:00:37.506758 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:00:37.506758 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:00:37.506758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a036208d-0cd4-49f8-bb3f-b26393a5d9f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F2963D730>]}
[0m10:00:37.506758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a036208d-0cd4-49f8-bb3f-b26393a5d9f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F29573430>]}
[0m10:00:37.506758 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:00:37.522706 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a036208d-0cd4-49f8-bb3f-b26393a5d9f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F29573490>]}
[0m10:00:37.522706 [info ] [MainThread]: 
[0m10:00:37.522706 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:00:37.522706 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:37.522706 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:38.183568 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m10:00:38.183568 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m10:00:38.183568 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:38.183568 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:40.685447 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m10:00:40.685447 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:40.733275 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m10:00:40.733275 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:41.442544 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a036208d-0cd4-49f8-bb3f-b26393a5d9f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F293D9970>]}
[0m10:00:41.442544 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:00:41.458764 [info ] [MainThread]: 
[0m10:00:41.458764 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:00:41.458764 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m10:00:41.458764 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m10:00:41.458764 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:00:41.474669 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 10:00:41.458764 => 10:00:41.474669
[0m10:00:41.474669 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:00:41.506767 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:00:41.522908 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m10:00:42.331123 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0038f9c7-dcb6-4039-a0ac-1047b920323b&page=queryresults
[0m10:00:43.423913 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m10:00:43.880271 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2275abec-64aa-4b89-a2ad-fec4ac5d57eb&page=queryresults
[0m10:00:46.525816 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m10:00:47.203707 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m10:00:47.203707 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m10:00:47.723545 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a1a9ab34-f25a-4603-9e25-e1e3d59c306f&page=queryresults
[0m10:00:50.602359 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 10:00:41.474669 => 10:00:50.602359
[0m10:00:50.604373 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a036208d-0cd4-49f8-bb3f-b26393a5d9f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F292DB040>]}
[0m10:00:50.604373 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 65.3 KiB processed)[0m in 9.14s]
[0m10:00:50.606385 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:00:50.609250 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:00:50.609250 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:50.609250 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m10:00:50.609250 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m10:00:50.609250 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m10:00:50.611260 [info ] [MainThread]: 
[0m10:00:50.611260 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 13.09 seconds (13.09s).
[0m10:00:50.613271 [debug] [MainThread]: Command end result
[0m10:00:50.625227 [info ] [MainThread]: 
[0m10:00:50.625227 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:00:50.625227 [info ] [MainThread]: 
[0m10:00:50.625227 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m10:00:50.625227 [debug] [MainThread]: Command `dbt snapshot` succeeded at 10:00:50.625227 after 14.10 seconds
[0m10:00:50.625227 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F25D09460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F293088B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F2A6E4430>]}
[0m10:00:50.625227 [debug] [MainThread]: Flushing usage events
[0m10:00:54.303864 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002445293B400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244518C6640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244518C6AC0>]}


============================== 10:00:54.303864 | 1e4ac218-ac16-49f8-a5f8-72e4f5bf9ab3 ==============================
[0m10:00:54.303864 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:00:54.319635 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m10:00:55.104297 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1e4ac218-ac16-49f8-a5f8-72e4f5bf9ab3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244518AF040>]}
[0m10:00:55.159389 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1e4ac218-ac16-49f8-a5f8-72e4f5bf9ab3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024455FA2BE0>]}
[0m10:00:55.161395 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:00:55.167075 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:00:55.210332 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:00:55.210332 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:00:55.222486 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1e4ac218-ac16-49f8-a5f8-72e4f5bf9ab3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002445626EF10>]}
[0m10:00:55.222486 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1e4ac218-ac16-49f8-a5f8-72e4f5bf9ab3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244560DFCD0>]}
[0m10:00:55.222486 [info ] [MainThread]: Found 14 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:00:55.222486 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1e4ac218-ac16-49f8-a5f8-72e4f5bf9ab3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000244560DFEE0>]}
[0m10:00:55.222486 [info ] [MainThread]: 
[0m10:00:55.222486 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:00:55.222486 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:55.222486 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:55.923614 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:00:55.923614 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:55.925634 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m10:00:55.925634 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:56.539864 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m10:00:56.539864 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:56.588089 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m10:00:56.588089 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:57.117634 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1e4ac218-ac16-49f8-a5f8-72e4f5bf9ab3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024455FFE4C0>]}
[0m10:00:57.117634 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:00:57.117634 [info ] [MainThread]: 
[0m10:00:57.117634 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:00:57.117634 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m10:00:57.117634 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m10:00:57.117634 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:00:57.133349 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m10:00:57.133349 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 10:00:57.117634 => 10:00:57.133349
[0m10:00:57.133349 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:00:57.149221 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:00:57.729006 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m10:00:57.729006 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m10:00:58.104470 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4777b23c-6396-4e3d-8745-e707d2d4609a&page=queryresults
[0m10:01:00.261945 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 10:00:57.133349 => 10:01:00.261945
[0m10:01:00.261945 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1e4ac218-ac16-49f8-a5f8-72e4f5bf9ab3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024457315940>]}
[0m10:01:00.261945 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (363.0 rows, 53.3 KiB processed)[0m in 3.14s]
[0m10:01:00.261945 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:01:00.278031 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:01:00.278031 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:01:00.278031 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m10:01:00.278031 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m10:01:00.278031 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m10:01:00.278031 [info ] [MainThread]: 
[0m10:01:00.278031 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.06 seconds (5.06s).
[0m10:01:00.278031 [debug] [MainThread]: Command end result
[0m10:01:00.278031 [info ] [MainThread]: 
[0m10:01:00.294079 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:01:00.294079 [info ] [MainThread]: 
[0m10:01:00.294079 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m10:01:00.294079 [debug] [MainThread]: Command `dbt run` succeeded at 10:01:00.294079 after 6.04 seconds
[0m10:01:00.294079 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002445293B400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002445600A370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024455F6FC70>]}
[0m10:01:00.294079 [debug] [MainThread]: Flushing usage events
[0m10:55:50.704407 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B9A2486400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B9A1405640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B9A1405AC0>]}


============================== 10:55:50.714732 | fec40616-90be-4046-abae-ae9d356ac4b8 ==============================
[0m10:55:50.714732 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:55:50.718384 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --models stg_item_pedido', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m10:55:53.053067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fec40616-90be-4046-abae-ae9d356ac4b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B9A13FB040>]}
[0m10:55:53.183741 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fec40616-90be-4046-abae-ae9d356ac4b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B9A5A8A100>]}
[0m10:55:53.185752 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:55:53.228276 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:55:53.335265 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m10:55:53.335265 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\1.stg\stg_item_pedido.sql
[0m10:55:53.735128 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fec40616-90be-4046-abae-ae9d356ac4b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B9A5EF7940>]}
[0m10:55:53.748271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fec40616-90be-4046-abae-ae9d356ac4b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B9A5D9A640>]}
[0m10:55:53.749269 [info ] [MainThread]: Found 15 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:55:53.749269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fec40616-90be-4046-abae-ae9d356ac4b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B9A5DDA6D0>]}
[0m10:55:53.751273 [info ] [MainThread]: 
[0m10:55:53.752268 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:55:53.753269 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:55:53.754491 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:55:54.643226 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:55:54.644493 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:55:54.647423 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m10:55:54.649482 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:55:55.320387 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m10:55:55.325017 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:55:55.378145 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m10:55:55.378145 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:55:56.294324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fec40616-90be-4046-abae-ae9d356ac4b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B9A5EF7820>]}
[0m10:55:56.299528 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:55:56.301587 [info ] [MainThread]: 
[0m10:55:56.311240 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m10:55:56.313232 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_item_pedido ......................... [RUN]
[0m10:55:56.315859 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_item_pedido'
[0m10:55:56.317672 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m10:55:56.347429 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m10:55:56.356356 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 10:55:56.317672 => 10:55:56.354289
[0m10:55:56.357298 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m10:55:56.384108 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m10:55:56.386159 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:55:56.388201 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m10:55:57.297300 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9bee567c-ebab-4636-8cb5-ee8b9ec2c0d2&page=queryresults
[0m10:55:57.773765 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 10:55:56.358324 => 10:55:57.773765
[0m10:55:57.774780 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fec40616-90be-4046-abae-ae9d356ac4b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B9A6FBF130>]}
[0m10:55:57.775904 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_item_pedido .................... [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m10:55:57.777468 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m10:55:57.783025 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:55:57.784109 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:55:57.785679 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m10:55:57.785679 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m10:55:57.785679 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_item_pedido' was properly closed.
[0m10:55:57.787235 [info ] [MainThread]: 
[0m10:55:57.789269 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.03 seconds (4.03s).
[0m10:55:57.793293 [debug] [MainThread]: Command end result
[0m10:55:57.820049 [info ] [MainThread]: 
[0m10:55:57.821010 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:55:57.822006 [info ] [MainThread]: 
[0m10:55:57.823520 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m10:55:57.825536 [debug] [MainThread]: Command `dbt run` succeeded at 10:55:57.825536 after 7.25 seconds
[0m10:55:57.826533 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B9A2486400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B9A5B55160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B9A5DAE400>]}
[0m10:55:57.827545 [debug] [MainThread]: Flushing usage events
[0m11:00:03.890087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE10D2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE00699A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE0069D30>]}


============================== 11:00:03.893608 | 74fcbe50-6537-4ca3-989f-0566f3af4591 ==============================
[0m11:00:03.893608 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:00:03.895117 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:00:04.438239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE0065970>]}
[0m11:00:04.518647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE4817130>]}
[0m11:00:04.520639 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:00:04.544224 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:00:04.946063 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:00:04.946063 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:00:04.955626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE4A24AF0>]}
[0m11:00:04.969751 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE49627F0>]}
[0m11:00:04.970779 [info ] [MainThread]: Found 15 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:00:04.971781 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE4962850>]}
[0m11:00:04.975867 [info ] [MainThread]: 
[0m11:00:04.975867 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:00:04.978414 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:04.979409 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:04.979409 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:04.980436 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:05.954520 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:06.773370 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m11:00:06.776449 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:06.780464 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m11:00:06.785091 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:07.617155 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m11:00:07.626226 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m11:00:07.629252 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:07.638382 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:08.397241 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE4A70D30>]}
[0m11:00:08.401275 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:00:08.404866 [info ] [MainThread]: 
[0m11:00:08.413964 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:08.414964 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m11:00:08.415960 [info ] [Thread-1  ]: 1 of 14 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m11:00:08.419516 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m11:00:08.419516 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:08.417472 [info ] [Thread-2  ]: 2 of 14 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m11:00:08.435823 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m11:00:08.436740 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m11:00:08.437774 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m11:00:08.441325 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m11:00:08.443868 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 11:00:08.420488 => 11:00:08.442853
[0m11:00:08.444882 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:08.445890 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 11:00:08.439306 => 11:00:08.445890
[0m11:00:08.449427 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m11:00:08.481256 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m11:00:08.488287 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m11:00:08.490287 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:00:08.491294 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m11:00:08.493812 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m11:00:08.495874 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m11:00:09.333968 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e242f2ec-e531-4b0f-a43a-b686f15c44b7&page=queryresults
[0m11:00:09.349028 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:39a91f90-2c3e-4687-81cd-424d74e662b2&page=queryresults
[0m11:00:09.761236 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 11:00:08.445890 => 11:00:09.761236
[0m11:00:09.762755 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE5B1FF70>]}
[0m11:00:09.765763 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 11:00:08.449913 => 11:00:09.765763
[0m11:00:09.767270 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE5ABF880>]}
[0m11:00:09.765763 [info ] [Thread-1  ]: 1 of 14 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m11:00:09.768277 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:09.768277 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m11:00:09.767270 [info ] [Thread-2  ]: 2 of 14 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m11:00:09.769275 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m11:00:09.770276 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m11:00:09.769275 [info ] [Thread-1  ]: 3 of 14 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m11:00:09.771276 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m11:00:09.771276 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m11:00:09.770276 [info ] [Thread-2  ]: 4 of 14 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m11:00:09.773796 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m11:00:09.774791 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m11:00:09.775800 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m11:00:09.778329 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m11:00:09.779311 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 11:00:09.775800 => 11:00:09.779311
[0m11:00:09.779311 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 11:00:09.771276 => 11:00:09.779311
[0m11:00:09.780313 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m11:00:09.780313 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m11:00:09.782819 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m11:00:09.785846 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m11:00:09.787356 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:09.787356 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:09.788362 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m11:00:09.790362 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m11:00:10.673092 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:23f31aae-6491-42e5-9b86-bd0884c890f1&page=queryresults
[0m11:00:10.762846 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2f53252d-1960-4744-bb5a-f0dbf4a70820&page=queryresults
[0m11:00:11.112240 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 11:00:09.783841 => 11:00:11.111235
[0m11:00:11.112240 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE5B0B8E0>]}
[0m11:00:11.113804 [info ] [Thread-1  ]: 3 of 14 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m11:00:11.113804 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m11:00:11.114817 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m11:00:11.115950 [info ] [Thread-1  ]: 5 of 14 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m11:00:11.117464 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m11:00:11.117464 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m11:00:11.121475 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m11:00:11.122983 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 11:00:11.117464 => 11:00:11.121475
[0m11:00:11.122983 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m11:00:11.131002 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m11:00:11.131996 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:11.133514 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m11:00:11.162929 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 11:00:09.781313 => 11:00:11.162929
[0m11:00:11.164120 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE5B0B7C0>]}
[0m11:00:11.164120 [info ] [Thread-2  ]: 4 of 14 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.39s]
[0m11:00:11.165239 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m11:00:11.165239 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m11:00:11.166250 [info ] [Thread-2  ]: 6 of 14 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m11:00:11.166250 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m11:00:11.167250 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m11:00:11.169247 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m11:00:11.170249 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 11:00:11.167250 => 11:00:11.170249
[0m11:00:11.171253 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m11:00:11.172764 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m11:00:11.173775 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:11.175776 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m11:00:11.901506 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:edc48fb0-0ab8-4b19-906a-3fc1edd83fed&page=queryresults
[0m11:00:11.983470 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:60012071-9b16-43d0-9e18-245054cb70b6&page=queryresults
[0m11:00:12.337533 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 11:00:11.171253 => 11:00:12.335915
[0m11:00:12.340636 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE5B037C0>]}
[0m11:00:12.341676 [info ] [Thread-2  ]: 6 of 14 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m11:00:12.344421 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m11:00:12.346424 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:12.347468 [info ] [Thread-2  ]: 7 of 14 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m11:00:12.349508 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_meta_margem_preco)
[0m11:00:12.350502 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:12.363921 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m11:00:12.368470 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 11:00:12.350502 => 11:00:12.367446
[0m11:00:12.369530 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:12.375248 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m11:00:12.376267 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:12.378207 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m11:00:12.407160 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 11:00:11.122983 => 11:00:12.407160
[0m11:00:12.408645 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE5B0B8E0>]}
[0m11:00:12.409644 [info ] [Thread-1  ]: 5 of 14 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m11:00:12.411590 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m11:00:12.413106 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m11:00:12.414128 [info ] [Thread-1  ]: 8 of 14 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m11:00:12.417134 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_pedido)
[0m11:00:12.419132 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m11:00:12.423202 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m11:00:12.423801 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 11:00:12.420204 => 11:00:12.423801
[0m11:00:12.424812 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m11:00:12.434625 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m11:00:12.437520 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:12.443383 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_pedido
        ,nullif(trim(total), '')                     as vl_total_item
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m11:00:13.168279 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4b3d50a1-8d3e-4d49-b82d-1906eef5880d&page=queryresults
[0m11:00:13.230674 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d28ee36e-d834-4502-b1dd-04e103b33af8&page=queryresults
[0m11:00:13.617285 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 11:00:12.424812 => 11:00:13.616349
[0m11:00:13.620288 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE5ACE610>]}
[0m11:00:13.630690 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 11:00:12.369530 => 11:00:13.630690
[0m11:00:13.624049 [info ] [Thread-1  ]: 8 of 14 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m11:00:13.633318 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE5AF4F10>]}
[0m11:00:13.634480 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m11:00:13.638622 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m11:00:13.636423 [info ] [Thread-2  ]: 7 of 14 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m11:00:13.644310 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:13.639659 [info ] [Thread-1  ]: 9 of 14 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m11:00:13.649360 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto)
[0m11:00:13.650303 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m11:00:13.664066 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m11:00:13.667132 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 11:00:13.651305 => 11:00:13.666061
[0m11:00:13.668110 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m11:00:13.674941 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m11:00:13.675945 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:13.679495 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m11:00:14.483074 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7c92d89d-e4db-4ddb-b4bf-ad11e279bd4f&page=queryresults
[0m11:00:14.886156 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 11:00:13.669156 => 11:00:14.886156
[0m11:00:14.887160 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE5AF4F10>]}
[0m11:00:14.888169 [info ] [Thread-1  ]: 9 of 14 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m11:00:14.888169 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m11:00:14.889168 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m11:00:14.890166 [info ] [Thread-2  ]: 10 of 14 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m11:00:14.891167 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.dm_produto)
[0m11:00:14.891167 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m11:00:14.894679 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m11:00:14.895679 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 11:00:14.891167 => 11:00:14.894679
[0m11:00:14.895679 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m11:00:14.904243 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:15.508183 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m11:00:15.508729 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m11:00:16.194001 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e7b8261b-1a68-4266-86c9-edfb343e4c40&page=queryresults
[0m11:00:18.768640 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 11:00:14.895679 => 11:00:18.767585
[0m11:00:18.769541 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE473B5B0>]}
[0m11:00:18.769541 [info ] [Thread-2  ]: 10 of 14 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 3.88s]
[0m11:00:18.771542 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m11:00:18.771542 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m11:00:18.773052 [info ] [Thread-1  ]: 11 of 14 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m11:00:18.774062 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m11:00:18.775064 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m11:00:18.778060 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m11:00:18.779064 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 11:00:18.775064 => 11:00:18.779064
[0m11:00:18.780065 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m11:00:18.785571 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:19.344897 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m11:00:19.345897 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m11:00:19.984154 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:addb61bc-5d25-4dae-8781-2c0dec0a7300&page=queryresults
[0m11:00:22.225253 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 11:00:18.780065 => 11:00:22.224208
[0m11:00:22.226181 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE5BB7C70>]}
[0m11:00:22.226181 [info ] [Thread-1  ]: 11 of 14 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 3.45s]
[0m11:00:22.227222 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m11:00:22.229184 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m11:00:22.231219 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m11:00:22.230154 [info ] [Thread-2  ]: 12 of 14 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m11:00:22.233147 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m11:00:22.233147 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m11:00:22.236339 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m11:00:22.232213 [info ] [Thread-1  ]: 13 of 14 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m11:00:22.237330 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m11:00:22.238391 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m11:00:22.240398 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m11:00:22.241334 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 11:00:22.233147 => 11:00:22.241334
[0m11:00:22.241334 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m11:00:22.244047 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:22.265816 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 11:00:22.238391 => 11:00:22.265816
[0m11:00:22.265816 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m11:00:22.268400 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:22.869183 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m11:00:22.873309 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m11:00:22.883977 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m11:00:22.884883 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m11:00:23.327332 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fe255f29-4089-4bb9-acca-2882d844ecd6&page=queryresults
[0m11:00:23.460241 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2a84f435-a277-4a63-bc1d-a8793e65ab90&page=queryresults
[0m11:00:25.275950 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 11:00:22.267361 => 11:00:25.275950
[0m11:00:25.277460 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE5AF43D0>]}
[0m11:00:25.277460 [info ] [Thread-1  ]: 13 of 14 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 77.2 KiB processed)[0m in 3.04s]
[0m11:00:25.279472 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m11:00:25.279472 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m11:00:25.280470 [info ] [Thread-1  ]: 14 of 14 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m11:00:25.281470 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_preco_produto)
[0m11:00:25.281470 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m11:00:25.284986 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m11:00:25.287991 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 11:00:25.281470 => 11:00:25.286990
[0m11:00:25.287991 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m11:00:25.296135 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:25.683837 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 11:00:22.241334 => 11:00:25.683837
[0m11:00:25.684841 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE5AC6040>]}
[0m11:00:25.684841 [info ] [Thread-2  ]: 12 of 14 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 3.45s]
[0m11:00:25.685839 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m11:00:25.852053 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m11:00:25.853541 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m11:00:26.536047 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e557d7a0-d888-4ccb-a75e-cc732797cbde&page=queryresults
[0m11:00:29.605878 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 11:00:25.287991 => 11:00:29.605878
[0m11:00:29.605878 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74fcbe50-6537-4ca3-989f-0566f3af4591', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE5BF0220>]}
[0m11:00:29.607493 [info ] [Thread-1  ]: 14 of 14 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 73.7 KiB processed)[0m in 4.33s]
[0m11:00:29.608546 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m11:00:29.610511 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:00:29.610511 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:00:29.611544 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:00:29.611544 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m11:00:29.611544 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m11:00:29.611544 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m11:00:29.611544 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m11:00:29.611544 [info ] [MainThread]: 
[0m11:00:29.613050 [info ] [MainThread]: Finished running 9 view models, 5 table models in 0 hours 0 minutes and 24.64 seconds (24.64s).
[0m11:00:29.615095 [debug] [MainThread]: Command end result
[0m11:00:29.623120 [info ] [MainThread]: 
[0m11:00:29.624401 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:00:29.624401 [info ] [MainThread]: 
[0m11:00:29.625428 [info ] [MainThread]: Done. PASS=14 WARN=0 ERROR=0 SKIP=0 TOTAL=14
[0m11:00:29.626441 [debug] [MainThread]: Command `dbt run` succeeded at 11:00:29.626441 after 25.80 seconds
[0m11:00:29.626441 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE10D2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE4A70D30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026FE4829280>]}
[0m11:00:29.626441 [debug] [MainThread]: Flushing usage events
[0m11:00:33.669891 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2BF733D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2AF009D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2AF00B80>]}


============================== 11:00:33.675078 | d5736722-2687-4800-a603-2653d33aeb64 ==============================
[0m11:00:33.675078 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:00:33.676073 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m11:00:34.599406 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd5736722-2687-4800-a603-2653d33aeb64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2AF149A0>]}
[0m11:00:34.683076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd5736722-2687-4800-a603-2653d33aeb64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2F599370>]}
[0m11:00:34.684145 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:00:34.693060 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:00:34.760126 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:00:34.760126 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:00:34.765501 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd5736722-2687-4800-a603-2653d33aeb64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2F8C3400>]}
[0m11:00:34.777105 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd5736722-2687-4800-a603-2653d33aeb64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2F7EA100>]}
[0m11:00:34.778122 [info ] [MainThread]: Found 15 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:00:34.778122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd5736722-2687-4800-a603-2653d33aeb64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2F7EA160>]}
[0m11:00:34.779102 [info ] [MainThread]: 
[0m11:00:34.780156 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:00:34.782144 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:34.782144 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:35.491500 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m11:00:35.494962 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:35.498496 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m11:00:35.500502 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:36.987467 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m11:00:36.992989 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:37.931113 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m11:00:37.932111 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:39.979387 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd5736722-2687-4800-a603-2653d33aeb64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2F553310>]}
[0m11:00:39.982919 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:00:39.985952 [info ] [MainThread]: 
[0m11:00:40.009064 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:00:40.015144 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m11:00:40.023161 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m11:00:40.024693 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:00:40.042827 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 11:00:40.025691 => 11:00:40.042827
[0m11:00:40.043841 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:00:40.119172 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:00:40.121171 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m11:00:41.014698 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:51c40bce-18d7-475f-a315-e7e0a0499ef2&page=queryresults
[0m11:00:43.151567 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m11:00:43.967055 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:16c8d60d-e00f-4648-8813-002bb9000215&page=queryresults
[0m11:00:46.931743 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m11:00:47.604313 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m11:00:47.606313 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m11:00:48.213461 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:11f1b08f-5955-4d31-93af-a7e65af27c9b&page=queryresults
[0m11:00:50.764156 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 11:00:40.043841 => 11:00:50.763107
[0m11:00:50.765160 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd5736722-2687-4800-a603-2653d33aeb64', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F30968040>]}
[0m11:00:50.766156 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 65.3 KiB processed)[0m in 10.74s]
[0m11:00:50.768161 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:00:50.771164 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:00:50.772157 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:00:50.773129 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m11:00:50.774237 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m11:00:50.775235 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m11:00:50.775235 [info ] [MainThread]: 
[0m11:00:50.777587 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 16.00 seconds (16.00s).
[0m11:00:50.779620 [debug] [MainThread]: Command end result
[0m11:00:50.795834 [info ] [MainThread]: 
[0m11:00:50.797342 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:00:50.797342 [info ] [MainThread]: 
[0m11:00:50.798469 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m11:00:50.799512 [debug] [MainThread]: Command `dbt snapshot` succeeded at 11:00:50.799512 after 17.21 seconds
[0m11:00:50.800510 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2BF733D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2F5538E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024F2F656B80>]}
[0m11:00:50.801478 [debug] [MainThread]: Flushing usage events
[0m11:00:54.617456 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A62E09460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A61D909A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A61D90D30>]}


============================== 11:00:54.621523 | 2dfba158-5d7d-44ac-8745-0e9faed6acba ==============================
[0m11:00:54.621523 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:00:54.621523 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m11:00:55.678472 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2dfba158-5d7d-44ac-8745-0e9faed6acba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A61D85970>]}
[0m11:00:55.777289 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2dfba158-5d7d-44ac-8745-0e9faed6acba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A64F5AB80>]}
[0m11:00:55.779354 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:00:55.788174 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:00:55.889064 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:00:55.891066 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:00:55.904251 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2dfba158-5d7d-44ac-8745-0e9faed6acba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A66754C40>]}
[0m11:00:55.929669 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2dfba158-5d7d-44ac-8745-0e9faed6acba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A6668B940>]}
[0m11:00:55.930668 [info ] [MainThread]: Found 15 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:00:55.930668 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2dfba158-5d7d-44ac-8745-0e9faed6acba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A6668B9A0>]}
[0m11:00:55.933901 [info ] [MainThread]: 
[0m11:00:55.935546 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:00:55.937588 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:55.938590 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:56.705958 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m11:00:56.711508 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m11:00:56.714040 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:56.716044 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:57.654296 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m11:00:57.659394 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m11:00:57.659394 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:57.662932 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:58.403675 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2dfba158-5d7d-44ac-8745-0e9faed6acba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A6675E8B0>]}
[0m11:00:58.407235 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:00:58.408266 [info ] [MainThread]: 
[0m11:00:58.418427 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:00:58.418427 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m11:00:58.420437 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m11:00:58.421435 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:00:58.430556 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m11:00:58.431581 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 11:00:58.421435 => 11:00:58.431581
[0m11:00:58.431581 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:00:58.450563 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:00:59.130625 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m11:00:59.131625 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m11:00:59.503282 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4df12e4f-d9c1-40c4-a1cb-56ea357bf923&page=queryresults
[0m11:01:02.085076 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 11:00:58.433104 => 11:01:02.084062
[0m11:01:02.088655 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2dfba158-5d7d-44ac-8745-0e9faed6acba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A667DE340>]}
[0m11:01:02.091656 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (363.0 rows, 53.3 KiB processed)[0m in 3.67s]
[0m11:01:02.095206 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:01:02.104563 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:01:02.108155 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:01:02.111155 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m11:01:02.113155 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m11:01:02.114726 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m11:01:02.117243 [info ] [MainThread]: 
[0m11:01:02.121294 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.18 seconds (6.18s).
[0m11:01:02.129290 [debug] [MainThread]: Command end result
[0m11:01:02.174217 [info ] [MainThread]: 
[0m11:01:02.177215 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:01:02.179277 [info ] [MainThread]: 
[0m11:01:02.182218 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m11:01:02.185785 [debug] [MainThread]: Command `dbt run` succeeded at 11:01:02.185785 after 7.65 seconds
[0m11:01:02.187383 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A62E09460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A6655C670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015A665378B0>]}
[0m11:01:02.188449 [debug] [MainThread]: Flushing usage events
[0m12:00:14.810171 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346A8F3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346987E9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346987ED30>]}


============================== 12:00:14.819733 | 43df7b8a-6eb7-497b-a08c-ce38e0b13f95 ==============================
[0m12:00:14.819733 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:00:14.821734 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --exclude tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m12:00:16.102041 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023469865040>]}
[0m12:00:16.164640 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346DEF5100>]}
[0m12:00:16.165879 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:00:16.203216 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:00:19.770182 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:00:19.771186 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:00:19.777852 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346E2261C0>]}
[0m12:00:19.825693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346E091F70>]}
[0m12:00:19.826744 [info ] [MainThread]: Found 15 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:00:19.827751 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346DE8E340>]}
[0m12:00:19.831826 [info ] [MainThread]: 
[0m12:00:19.833813 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:00:19.836595 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:19.838636 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:19.838636 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:19.839634 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:20.724712 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:21.527617 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m12:00:21.529570 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:21.530626 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m12:00:21.531626 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:22.308576 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m12:00:22.311696 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:22.314675 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m12:00:22.318112 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:22.984360 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346E284AC0>]}
[0m12:00:22.986029 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:00:22.986952 [info ] [MainThread]: 
[0m12:00:22.993113 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:22.993113 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m12:00:22.994119 [info ] [Thread-1  ]: 1 of 14 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m12:00:22.996669 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m12:00:22.995595 [info ] [Thread-2  ]: 2 of 14 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m12:00:22.997723 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:22.998720 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m12:00:23.009406 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m12:00:23.009406 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m12:00:23.012401 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m12:00:23.013401 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 12:00:22.998720 => 12:00:23.013401
[0m12:00:23.014284 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:23.014284 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 12:00:23.010403 => 12:00:23.014284
[0m12:00:23.015825 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m12:00:23.043246 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m12:00:23.047807 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m12:00:23.048859 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m12:00:23.049819 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:00:23.050852 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m12:00:23.071517 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m12:00:23.999612 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0ed564f9-3c93-4f2c-ab46-9872ef50fbb9&page=queryresults
[0m12:00:24.016909 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0ac66613-017d-4c93-9acd-087430d4e070&page=queryresults
[0m12:00:24.472732 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 12:00:23.014284 => 12:00:24.472732
[0m12:00:24.474626 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346E2847F0>]}
[0m12:00:24.477480 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 12:00:23.016945 => 12:00:24.477480
[0m12:00:24.475356 [info ] [Thread-1  ]: 1 of 14 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.48s]
[0m12:00:24.478463 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346F31EB20>]}
[0m12:00:24.478463 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:24.479463 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m12:00:24.479463 [info ] [Thread-2  ]: 2 of 14 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.48s]
[0m12:00:24.480373 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m12:00:24.480373 [info ] [Thread-1  ]: 3 of 14 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m12:00:24.480373 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m12:00:24.481481 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m12:00:24.481481 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m12:00:24.481481 [info ] [Thread-2  ]: 4 of 14 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m12:00:24.484475 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m12:00:24.484475 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m12:00:24.484475 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m12:00:24.487333 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m12:00:24.488223 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 12:00:24.482475 => 12:00:24.487333
[0m12:00:24.488223 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m12:00:24.492336 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m12:00:24.493348 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 12:00:24.485477 => 12:00:24.492336
[0m12:00:24.493348 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m12:00:24.496992 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m12:00:24.499048 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:24.499048 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:24.502061 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m12:00:24.549831 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m12:00:25.331658 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6be788f4-60d6-4bbb-81bd-da449f9efd4c&page=queryresults
[0m12:00:25.354265 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:debeab5b-1ed9-487a-bc69-8ae88b215b9d&page=queryresults
[0m12:00:25.778420 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 12:00:24.494320 => 12:00:25.778420
[0m12:00:25.779424 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346E29EA30>]}
[0m12:00:25.780423 [info ] [Thread-2  ]: 4 of 14 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m12:00:25.781319 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m12:00:25.781319 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m12:00:25.782325 [info ] [Thread-2  ]: 5 of 14 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m12:00:25.784428 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m12:00:25.786326 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m12:00:25.795425 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m12:00:25.803424 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 12:00:24.489329 => 12:00:25.803424
[0m12:00:25.805422 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346DFB0E50>]}
[0m12:00:25.807421 [info ] [Thread-1  ]: 3 of 14 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m12:00:25.809336 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m12:00:25.810325 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 12:00:25.787426 => 12:00:25.809336
[0m12:00:25.811330 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m12:00:25.812324 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m12:00:25.813329 [info ] [Thread-1  ]: 6 of 14 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m12:00:25.818889 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_item_pedido)
[0m12:00:25.820889 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m12:00:25.827854 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m12:00:25.836527 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m12:00:25.837524 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 12:00:25.822895 => 12:00:25.836527
[0m12:00:25.837524 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m12:00:25.845933 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:25.844637 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m12:00:25.850199 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m12:00:25.878559 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:25.882596 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m12:00:26.622896 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7c6fd500-5b3b-4f81-94f0-9ab46bbb8f52&page=queryresults
[0m12:00:26.665443 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c64dc524-7d19-4f09-8779-d6aa93b651e8&page=queryresults
[0m12:00:27.073975 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 12:00:25.813329 => 12:00:27.072971
[0m12:00:27.076911 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346F2CF340>]}
[0m12:00:27.082904 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 12:00:25.837524 => 12:00:27.081912
[0m12:00:27.085621 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346DFB0E50>]}
[0m12:00:27.083907 [info ] [Thread-2  ]: 5 of 14 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m12:00:27.088739 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m12:00:27.087731 [info ] [Thread-1  ]: 6 of 14 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m12:00:27.090732 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:27.092731 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m12:00:27.094638 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m12:00:27.093747 [info ] [Thread-2  ]: 7 of 14 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m12:00:27.097112 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m12:00:27.096107 [info ] [Thread-1  ]: 8 of 14 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m12:00:27.098111 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:27.099106 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m12:00:27.105113 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m12:00:27.105568 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m12:00:27.111644 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m12:00:27.115077 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 12:00:27.106569 => 12:00:27.113688
[0m12:00:27.116184 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m12:00:27.117188 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 12:00:27.099106 => 12:00:27.116184
[0m12:00:27.124180 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m12:00:27.125835 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:27.132995 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m12:00:27.135834 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:27.136958 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:27.141853 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_pedido
        ,nullif(trim(total), '')                     as vl_total_item
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m12:00:27.143849 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m12:00:28.050881 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c873b9ea-7a4b-419e-ab72-0013c620e30e&page=queryresults
[0m12:00:28.118181 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3f408ad6-d407-42d4-8210-f59b8e02b8a3&page=queryresults
[0m12:00:28.443890 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 12:00:27.125835 => 12:00:28.442896
[0m12:00:28.445901 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346F302FA0>]}
[0m12:00:28.446901 [info ] [Thread-2  ]: 7 of 14 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.35s]
[0m12:00:28.448896 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:28.449892 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m12:00:28.451898 [info ] [Thread-2  ]: 9 of 14 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m12:00:28.453893 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m12:00:28.454811 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m12:00:28.479186 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m12:00:28.482143 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 12:00:28.455895 => 12:00:28.481199
[0m12:00:28.482143 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m12:00:28.487720 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m12:00:28.489697 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:28.492722 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m12:00:28.541788 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 12:00:27.118169 => 12:00:28.541788
[0m12:00:28.542789 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346F355C70>]}
[0m12:00:28.542789 [info ] [Thread-1  ]: 8 of 14 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m12:00:28.543785 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m12:00:29.337388 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:39ea2edb-51bb-4b0f-9014-a18a6daaa8e7&page=queryresults
[0m12:00:29.732076 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 12:00:28.483191 => 12:00:29.730980
[0m12:00:29.733074 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346F33E910>]}
[0m12:00:29.735076 [info ] [Thread-2  ]: 9 of 14 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m12:00:29.735606 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m12:00:29.737619 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m12:00:29.738719 [info ] [Thread-1  ]: 10 of 14 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m12:00:29.740736 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.dm_produto)
[0m12:00:29.741721 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m12:00:29.750355 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m12:00:29.753260 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 12:00:29.742723 => 12:00:29.752355
[0m12:00:29.754360 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m12:00:29.778113 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:30.470904 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m12:00:30.473917 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m12:00:31.141699 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0d6a3fa0-d950-4daf-95cd-f0e5283224a7&page=queryresults
[0m12:00:33.570812 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 12:00:29.754360 => 12:00:33.570812
[0m12:00:33.572919 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346F301250>]}
[0m12:00:33.573915 [info ] [Thread-1  ]: 10 of 14 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 3.83s]
[0m12:00:33.575510 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m12:00:33.576620 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m12:00:33.577626 [info ] [Thread-2  ]: 11 of 14 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m12:00:33.579624 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m12:00:33.580530 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m12:00:33.587316 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m12:00:33.588222 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 12:00:33.580530 => 12:00:33.588222
[0m12:00:33.589346 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m12:00:33.597826 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:34.744721 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m12:00:34.745954 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m12:00:35.445693 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:22ac52d7-3120-49a0-b6e1-28e04021b37f&page=queryresults
[0m12:00:39.987173 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 12:00:33.590225 => 12:00:39.986059
[0m12:00:39.989171 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346F296D60>]}
[0m12:00:39.991174 [info ] [Thread-2  ]: 11 of 14 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 6.41s]
[0m12:00:39.993173 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m12:00:39.996030 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m12:00:39.999174 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m12:00:39.998153 [info ] [Thread-1  ]: 12 of 14 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m12:00:40.003180 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m12:00:40.001148 [info ] [Thread-2  ]: 13 of 14 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m12:00:40.005818 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m12:00:40.007936 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m12:00:40.018806 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m12:00:40.020797 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m12:00:40.029684 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m12:00:40.033588 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 12:00:40.008935 => 12:00:40.032684
[0m12:00:40.034682 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 12:00:40.021799 => 12:00:40.033588
[0m12:00:40.036418 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m12:00:40.037528 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m12:00:40.043532 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:40.049407 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:40.794500 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m12:00:40.797799 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m12:00:40.808266 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m12:00:40.811217 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m12:00:41.215366 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b6aef038-4f96-49fa-884f-0fd29707d28a&page=queryresults
[0m12:00:41.418982 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:66fa68e1-ca69-4717-9aaa-1d6b528cbd71&page=queryresults
[0m12:00:43.216298 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 12:00:40.044533 => 12:00:43.215276
[0m12:00:43.218292 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346F369E80>]}
[0m12:00:43.220296 [info ] [Thread-2  ]: 13 of 14 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 77.2 KiB processed)[0m in 3.21s]
[0m12:00:43.222296 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m12:00:43.223288 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m12:00:43.225291 [info ] [Thread-2  ]: 14 of 14 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m12:00:43.226560 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_preco_produto)
[0m12:00:43.228553 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m12:00:43.238001 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m12:00:43.242002 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 12:00:43.229556 => 12:00:43.242002
[0m12:00:43.244004 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m12:00:43.259079 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:43.637396 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 12:00:40.038439 => 12:00:43.636311
[0m12:00:43.638392 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346F469F10>]}
[0m12:00:43.638392 [info ] [Thread-1  ]: 12 of 14 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 3.64s]
[0m12:00:43.640417 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m12:00:43.897575 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m12:00:43.900577 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m12:00:44.520971 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d6fba080-3887-4ae2-81b6-68d3d426b61e&page=queryresults
[0m12:00:47.624950 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 12:00:43.245003 => 12:00:47.623946
[0m12:00:47.626626 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43df7b8a-6eb7-497b-a08c-ce38e0b13f95', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346F3F9E50>]}
[0m12:00:47.628612 [info ] [Thread-2  ]: 14 of 14 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 73.7 KiB processed)[0m in 4.40s]
[0m12:00:47.630699 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m12:00:47.634693 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:00:47.635429 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:00:47.636585 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:00:47.637536 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m12:00:47.637536 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m12:00:47.638585 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m12:00:47.639586 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m12:00:47.640579 [info ] [MainThread]: 
[0m12:00:47.641581 [info ] [MainThread]: Finished running 9 view models, 5 table models in 0 hours 0 minutes and 27.81 seconds (27.81s).
[0m12:00:47.650376 [debug] [MainThread]: Command end result
[0m12:00:47.672670 [info ] [MainThread]: 
[0m12:00:47.674616 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:00:47.675031 [info ] [MainThread]: 
[0m12:00:47.676024 [info ] [MainThread]: Done. PASS=14 WARN=0 ERROR=0 SKIP=0 TOTAL=14
[0m12:00:47.678249 [debug] [MainThread]: Command `dbt run` succeeded at 12:00:47.678249 after 33.03 seconds
[0m12:00:47.679245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346A8F3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346E13A130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002346987E130>]}
[0m12:00:47.680243 [debug] [MainThread]: Flushing usage events
[0m12:00:52.637350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028160A933D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002815F9FE9D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002815F9FEB80>]}


============================== 12:00:52.641375 | 3a74579a-fe00-4921-84f0-9211db625cc8 ==============================
[0m12:00:52.641375 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:00:52.642348 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt snapshot', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:00:53.276310 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3a74579a-fe00-4921-84f0-9211db625cc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002815FA01A30>]}
[0m12:00:53.358927 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3a74579a-fe00-4921-84f0-9211db625cc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028163FEC430>]}
[0m12:00:53.360918 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:00:53.368931 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:00:53.440192 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:00:53.441193 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:00:53.446756 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3a74579a-fe00-4921-84f0-9211db625cc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000281643C1E20>]}
[0m12:00:53.460240 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3a74579a-fe00-4921-84f0-9211db625cc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028164301B50>]}
[0m12:00:53.460240 [info ] [MainThread]: Found 15 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:00:53.461350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3a74579a-fe00-4921-84f0-9211db625cc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028164301AC0>]}
[0m12:00:53.463325 [info ] [MainThread]: 
[0m12:00:53.464327 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:00:53.465328 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:53.465969 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:54.164561 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m12:00:54.166232 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m12:00:54.167251 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:54.167251 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:54.813451 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m12:00:54.820043 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:54.823044 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m12:00:54.825480 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:55.486895 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3a74579a-fe00-4921-84f0-9211db625cc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000281640BDAC0>]}
[0m12:00:55.488897 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:00:55.489911 [info ] [MainThread]: 
[0m12:00:55.498590 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m12:00:55.500590 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m12:00:55.502591 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m12:00:55.502591 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m12:00:55.512133 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 12:00:55.503592 => 12:00:55.512133
[0m12:00:55.513139 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m12:00:55.580862 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:00:55.582853 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m12:00:56.511863 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f48aa317-92ce-4f45-b1eb-d9e6895209a4&page=queryresults
[0m12:00:57.694350 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m12:00:58.210486 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1252155e-7c30-44b1-b605-a175b3a38957&page=queryresults
[0m12:01:00.615502 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m12:01:01.392013 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m12:01:01.394966 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m12:01:01.844930 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a6f3c05b-1e86-49fa-9845-7640afb74f77&page=queryresults
[0m12:01:04.078534 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 12:00:55.513139 => 12:01:04.078534
[0m12:01:04.079533 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a74579a-fe00-4921-84f0-9211db625cc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028165479940>]}
[0m12:01:04.081535 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 65.3 KiB processed)[0m in 8.58s]
[0m12:01:04.082491 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m12:01:04.084541 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:01:04.085850 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:01:04.086849 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m12:01:04.086849 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m12:01:04.087847 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m12:01:04.088852 [info ] [MainThread]: 
[0m12:01:04.088852 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.62 seconds (10.62s).
[0m12:01:04.089838 [debug] [MainThread]: Command end result
[0m12:01:04.109655 [info ] [MainThread]: 
[0m12:01:04.111618 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:01:04.111618 [info ] [MainThread]: 
[0m12:01:04.112662 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m12:01:04.114661 [debug] [MainThread]: Command `dbt snapshot` succeeded at 12:01:04.114661 after 11.55 seconds
[0m12:01:04.115936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028160A933D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002816416FD30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002815F9E99D0>]}
[0m12:01:04.115936 [debug] [MainThread]: Flushing usage events
[0m12:01:09.005095 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000205723B3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000205713319D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020571331B80>]}


============================== 12:01:09.010111 | e52ae364-4674-49c6-9329-504a270c5408 ==============================
[0m12:01:09.010111 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:01:09.011091 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:01:09.732927 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e52ae364-4674-49c6-9329-504a270c5408', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002057131A130>]}
[0m12:01:09.820066 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e52ae364-4674-49c6-9329-504a270c5408', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000205712EFF40>]}
[0m12:01:09.821065 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:01:09.828724 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:01:09.887348 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:01:09.888349 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:01:09.897709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e52ae364-4674-49c6-9329-504a270c5408', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020575CE3F10>]}
[0m12:01:09.922468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e52ae364-4674-49c6-9329-504a270c5408', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020575A88B80>]}
[0m12:01:09.922468 [info ] [MainThread]: Found 15 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:01:09.923467 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e52ae364-4674-49c6-9329-504a270c5408', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020575A88EE0>]}
[0m12:01:09.924857 [info ] [MainThread]: 
[0m12:01:09.925851 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:01:09.927851 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:01:09.927851 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:01:10.635151 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m12:01:10.637305 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:01:10.640302 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m12:01:10.642315 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:01:11.272767 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m12:01:11.273769 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:01:11.330265 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m12:01:11.335833 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:01:11.996810 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e52ae364-4674-49c6-9329-504a270c5408', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000205759AF220>]}
[0m12:01:11.999800 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:01:12.000806 [info ] [MainThread]: 
[0m12:01:12.010479 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m12:01:12.012479 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m12:01:12.014478 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m12:01:12.016097 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m12:01:12.030673 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m12:01:12.032746 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 12:01:12.016097 => 12:01:12.031673
[0m12:01:12.032746 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m12:01:12.057731 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:01:12.695905 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m12:01:12.696911 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m12:01:13.070810 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:72064510-cb56-4c93-9a1a-a27cf61352c1&page=queryresults
[0m12:01:15.305554 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 12:01:12.032746 => 12:01:15.304913
[0m12:01:15.306573 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e52ae364-4674-49c6-9329-504a270c5408', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020575CF2FA0>]}
[0m12:01:15.307573 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (363.0 rows, 53.3 KiB processed)[0m in 3.29s]
[0m12:01:15.308671 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m12:01:15.311565 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:01:15.313573 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:01:15.313573 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m12:01:15.315089 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m12:01:15.316097 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m12:01:15.316097 [info ] [MainThread]: 
[0m12:01:15.317097 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.39 seconds (5.39s).
[0m12:01:15.319093 [debug] [MainThread]: Command end result
[0m12:01:15.331634 [info ] [MainThread]: 
[0m12:01:15.332626 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:01:15.333072 [info ] [MainThread]: 
[0m12:01:15.334119 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m12:01:15.335496 [debug] [MainThread]: Command `dbt run` succeeded at 12:01:15.335496 after 6.41 seconds
[0m12:01:15.336542 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000205723B3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020575AE94F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020576D8FD00>]}
[0m12:01:15.337550 [debug] [MainThread]: Flushing usage events
[0m13:00:04.054395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E22E1F3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E22D1699A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E22D169D30>]}


============================== 13:00:04.054395 | 7348f6eb-2d39-4a78-8284-dedee6a13d13 ==============================
[0m13:00:04.054395 [info ] [MainThread]: Running with dbt=1.7.4
[0m13:00:04.054395 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --exclude tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m13:00:04.603595 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E22D162970>]}
[0m13:00:04.651330 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E23033AB80>]}
[0m13:00:04.651330 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m13:00:04.667533 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m13:00:04.743867 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m13:00:04.743867 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\3.az\tb_pedido.sql
[0m13:00:04.823480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E231C6B8E0>]}
[0m13:00:04.839582 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E231B0C670>]}
[0m13:00:04.839582 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m13:00:04.839582 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E231B0CFA0>]}
[0m13:00:04.839582 [info ] [MainThread]: 
[0m13:00:04.839582 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:00:04.839582 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:00:04.839582 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:04.855597 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:00:04.855597 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:05.722569 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:06.401067 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m13:00:06.403083 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:06.405772 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m13:00:06.405772 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:07.091792 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m13:00:07.091792 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:07.170455 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m13:00:07.170455 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:08.145073 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E231880070>]}
[0m13:00:08.147168 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:00:08.148034 [info ] [MainThread]: 
[0m13:00:08.156970 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:08.158969 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m13:00:08.157969 [info ] [Thread-1  ]: 1 of 15 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m13:00:08.161503 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m13:00:08.161503 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:08.161503 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m13:00:08.159968 [info ] [Thread-2  ]: 2 of 15 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m13:00:08.176741 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m13:00:08.176741 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m13:00:08.176741 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m13:00:08.176741 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 13:00:08.161503 => 13:00:08.176741
[0m13:00:08.176741 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:08.203555 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m13:00:08.204550 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 13:00:08.176741 => 13:00:08.204550
[0m13:00:08.205524 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m13:00:08.207557 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m13:00:08.207557 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m13:00:08.208535 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m13:00:08.209524 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m13:00:08.222080 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m13:00:09.090995 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:722a0d0d-8bd8-4ecc-922e-55696fc92741&page=queryresults
[0m13:00:09.090995 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:15aa6c56-7443-455e-a0c5-33e4a3beb265&page=queryresults
[0m13:00:09.559541 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 13:00:08.205524 => 13:00:09.559541
[0m13:00:09.559541 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E231CF9370>]}
[0m13:00:09.559541 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 13:00:08.176741 => 13:00:09.559541
[0m13:00:09.559541 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E231CAB070>]}
[0m13:00:09.559541 [info ] [Thread-2  ]: 2 of 15 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m13:00:09.559541 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m13:00:09.559541 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m13:00:09.559541 [info ] [Thread-1  ]: 1 of 15 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m13:00:09.559541 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:09.559541 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m13:00:09.559541 [info ] [Thread-2  ]: 3 of 15 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m13:00:09.559541 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m13:00:09.575384 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m13:00:09.575384 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m13:00:09.559541 [info ] [Thread-1  ]: 4 of 15 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m13:00:09.575384 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m13:00:09.575384 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m13:00:09.575384 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m13:00:09.591274 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 13:00:09.575384 => 13:00:09.575384
[0m13:00:09.591274 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 13:00:09.575384 => 13:00:09.591274
[0m13:00:09.591274 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m13:00:09.591274 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m13:00:09.591274 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m13:00:09.591274 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m13:00:09.607440 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:09.591274 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:09.607440 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m13:00:09.623492 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m13:00:10.423272 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e607689e-a019-44c4-88ad-fcee1c71eca1&page=queryresults
[0m13:00:10.431144 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1f6b17cb-69ff-4cc7-bb58-0babc73bc23d&page=queryresults
[0m13:00:10.816535 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 13:00:09.591274 => 13:00:10.816535
[0m13:00:10.816535 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E232D03EB0>]}
[0m13:00:10.816535 [info ] [Thread-1  ]: 4 of 15 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m13:00:10.816535 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m13:00:10.816535 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m13:00:10.816535 [info ] [Thread-1  ]: 5 of 15 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m13:00:10.816535 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m13:00:10.816535 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m13:00:10.816535 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m13:00:10.832639 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 13:00:10.816535 => 13:00:10.832639
[0m13:00:10.832639 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m13:00:10.832639 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 13:00:09.591274 => 13:00:10.832639
[0m13:00:10.832639 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E232E13610>]}
[0m13:00:10.848743 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m13:00:10.848743 [info ] [Thread-2  ]: 3 of 15 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m13:00:10.848743 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m13:00:10.848743 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m13:00:10.848743 [info ] [Thread-2  ]: 6 of 15 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m13:00:10.848743 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_item_pedido)
[0m13:00:10.848743 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m13:00:10.864698 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m13:00:10.864698 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:10.864698 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m13:00:10.880623 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 13:00:10.848743 => 13:00:10.880623
[0m13:00:10.880623 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m13:00:10.880623 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m13:00:10.896288 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:10.896288 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m13:00:11.624791 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8c6c8a67-55ae-4303-8780-efa4573e06a6&page=queryresults
[0m13:00:11.640825 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:98606bde-1fcc-47c7-b7ca-7c360c5c346d&page=queryresults
[0m13:00:12.046804 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 13:00:10.832639 => 13:00:12.046804
[0m13:00:12.046804 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E232D03CD0>]}
[0m13:00:12.046804 [info ] [Thread-1  ]: 5 of 15 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m13:00:12.046804 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m13:00:12.046804 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:12.046804 [info ] [Thread-1  ]: 7 of 15 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m13:00:12.046804 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m13:00:12.062544 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:12.062544 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m13:00:12.062544 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 13:00:12.062544 => 13:00:12.062544
[0m13:00:12.062544 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:12.062544 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m13:00:12.078746 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 13:00:10.880623 => 13:00:12.078746
[0m13:00:12.078746 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E232E1EBB0>]}
[0m13:00:12.078746 [info ] [Thread-2  ]: 6 of 15 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m13:00:12.078746 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m13:00:12.078746 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m13:00:12.078746 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:12.078746 [info ] [Thread-2  ]: 8 of 15 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m13:00:12.078746 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m13:00:12.078746 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m13:00:12.094915 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m13:00:12.094915 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m13:00:12.126561 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 13:00:12.078746 => 13:00:12.126561
[0m13:00:12.126561 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m13:00:12.126561 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m13:00:12.126561 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:12.126561 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_pedido
        ,nullif(trim(total), '')                     as vl_total_item
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m13:00:12.783086 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3317fbac-58b7-4ffa-98f0-92e5a5b1a85a&page=queryresults
[0m13:00:12.921520 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:40f2bd6e-ddb1-44dd-aaf6-4663855069af&page=queryresults
[0m13:00:13.198698 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 13:00:12.062544 => 13:00:13.198698
[0m13:00:13.200699 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E232E57FD0>]}
[0m13:00:13.201699 [info ] [Thread-1  ]: 7 of 15 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m13:00:13.201699 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:13.201699 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m13:00:13.201699 [info ] [Thread-1  ]: 9 of 15 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m13:00:13.201699 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m13:00:13.201699 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m13:00:13.214730 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m13:00:13.216717 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 13:00:13.201699 => 13:00:13.216717
[0m13:00:13.217622 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m13:00:13.221627 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m13:00:13.222245 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:13.224426 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m13:00:13.359117 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 13:00:12.126561 => 13:00:13.359117
[0m13:00:13.359117 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E232E5AE80>]}
[0m13:00:13.359117 [info ] [Thread-2  ]: 8 of 15 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m13:00:13.359117 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m13:00:13.359117 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m13:00:13.359117 [info ] [Thread-2  ]: 10 of 15 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m13:00:13.359117 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.tb_pedido)
[0m13:00:13.359117 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m13:00:13.359117 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m13:00:13.359117 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 13:00:13.359117 => 13:00:13.359117
[0m13:00:13.374917 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m13:00:13.391037 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m13:00:13.391037 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:13.391037 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)
    );
  
[0m13:00:14.095039 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:03831671-5002-4e8d-be27-d7ec49b2c4a8&page=queryresults
[0m13:00:14.104810 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dc876cf0-a2f1-40f2-912e-56a0ecf67ea0&page=queryresults
[0m13:00:14.104810 [debug] [Thread-2  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Syntax error: Unexpected ")" at [46:5]')
[0m13:00:14.544760 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 13:00:13.217622 => 13:00:14.544760
[0m13:00:14.544760 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E233E6B190>]}
[0m13:00:14.544760 [info ] [Thread-1  ]: 9 of 15 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m13:00:14.544760 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m13:00:14.544760 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m13:00:14.544760 [info ] [Thread-1  ]: 11 of 15 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m13:00:14.544760 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m13:00:14.544760 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m13:00:14.560457 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m13:00:14.560457 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 13:00:14.544760 => 13:00:14.560457
[0m13:00:14.560457 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m13:00:14.560457 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:15.039920 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9967d8e5-4bed-43f3-adf2-c70010247743&page=queryresults
[0m13:00:15.041682 [error] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9967d8e5-4bed-43f3-adf2-c70010247743&page=queryresults
[0m13:00:15.041682 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 13:00:13.374917 => 13:00:15.041682
[0m13:00:15.168981 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m13:00:15.168981 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m13:00:15.493223 [debug] [Thread-2  ]: Database Error in model tb_pedido (models\3.az\tb_pedido.sql)
  Syntax error: Unexpected ")" at [46:5]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_pedido.sql
[0m13:00:15.493223 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E232DE26D0>]}
[0m13:00:15.493223 [error] [Thread-2  ]: 10 of 15 ERROR creating sql table model dbt_dw_az.tb_pedido .................... [[31mERROR[0m in 2.13s]
[0m13:00:15.509398 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m13:00:15.913065 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a7339dfa-23c8-47ce-bdd7-a4546d0eea78&page=queryresults
[0m13:00:19.023348 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 13:00:14.560457 => 13:00:19.023348
[0m13:00:19.023348 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E232E644F0>]}
[0m13:00:19.023348 [info ] [Thread-1  ]: 11 of 15 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 4.48s]
[0m13:00:19.023348 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m13:00:19.023348 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m13:00:19.039404 [info ] [Thread-2  ]: 12 of 15 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m13:00:19.039404 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_produto)
[0m13:00:19.039404 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m13:00:19.039404 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m13:00:19.039404 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 13:00:19.039404 => 13:00:19.039404
[0m13:00:19.039404 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m13:00:19.039404 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:19.833671 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m13:00:19.833671 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m13:00:20.492124 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3d7ea764-3ab9-4cae-b8cd-f1e871584f96&page=queryresults
[0m13:00:23.319490 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 13:00:19.039404 => 13:00:23.319490
[0m13:00:23.321500 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E233E6B190>]}
[0m13:00:23.321500 [info ] [Thread-2  ]: 12 of 15 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 4.28s]
[0m13:00:23.323513 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m13:00:23.323513 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m13:00:23.323513 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m13:00:23.326210 [info ] [Thread-1  ]: 13 of 15 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m13:00:23.326210 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m13:00:23.326210 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m13:00:23.326210 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m13:00:23.326210 [info ] [Thread-2  ]: 14 of 15 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m13:00:23.326210 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m13:00:23.326210 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m13:00:23.339438 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m13:00:23.339438 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 13:00:23.326210 => 13:00:23.339438
[0m13:00:23.339438 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 13:00:23.326210 => 13:00:23.339438
[0m13:00:23.339438 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m13:00:23.345126 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m13:00:23.345126 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:23.350998 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:24.055341 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m13:00:24.058237 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m13:00:24.079769 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m13:00:24.079769 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m13:00:24.488641 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d36b6f70-8e91-463a-a5ab-4208c1ae49eb&page=queryresults
[0m13:00:24.721734 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a1a95e9a-9975-4708-8cc6-5d0da943f6d3&page=queryresults
[0m13:00:26.199772 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 13:00:23.345126 => 13:00:26.197597
[0m13:00:26.199772 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E233E64610>]}
[0m13:00:26.204542 [info ] [Thread-2  ]: 14 of 15 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 77.2 KiB processed)[0m in 2.87s]
[0m13:00:26.205442 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m13:00:26.207506 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m13:00:26.207506 [info ] [Thread-2  ]: 15 of 15 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m13:00:26.209443 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_preco_produto)
[0m13:00:26.210442 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m13:00:26.218227 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m13:00:26.221225 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 13:00:26.211812 => 13:00:26.220228
[0m13:00:26.221225 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m13:00:26.222227 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:26.848953 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m13:00:26.848953 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m13:00:27.610650 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:37d6be7a-6c9c-4a05-8627-fcbc567d8b50&page=queryresults
[0m13:00:27.819558 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 13:00:23.345126 => 13:00:27.819558
[0m13:00:27.819558 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E233FA3610>]}
[0m13:00:27.819558 [info ] [Thread-1  ]: 13 of 15 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 4.49s]
[0m13:00:27.835346 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m13:00:30.704750 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 13:00:26.222227 => 13:00:30.704750
[0m13:00:30.706749 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7348f6eb-2d39-4a78-8284-dedee6a13d13', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E233E79430>]}
[0m13:00:30.707748 [info ] [Thread-2  ]: 15 of 15 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 73.7 KiB processed)[0m in 4.50s]
[0m13:00:30.708816 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m13:00:30.712855 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:00:30.714058 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:00:30.715057 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:00:30.715057 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m13:00:30.716056 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m13:00:30.716056 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m13:00:30.717054 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m13:00:30.717054 [info ] [MainThread]: 
[0m13:00:30.718056 [info ] [MainThread]: Finished running 9 view models, 6 table models in 0 hours 0 minutes and 25.88 seconds (25.88s).
[0m13:00:30.721268 [debug] [MainThread]: Command end result
[0m13:00:30.738344 [info ] [MainThread]: 
[0m13:00:30.738344 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:00:30.738344 [info ] [MainThread]: 
[0m13:00:30.738344 [error] [MainThread]:   Database Error in model tb_pedido (models\3.az\tb_pedido.sql)
  Syntax error: Unexpected ")" at [46:5]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_pedido.sql
[0m13:00:30.738344 [info ] [MainThread]: 
[0m13:00:30.738344 [info ] [MainThread]: Done. PASS=14 WARN=0 ERROR=1 SKIP=0 TOTAL=15
[0m13:00:30.738344 [debug] [MainThread]: Command `dbt run` failed at 13:00:30.738344 after 26.76 seconds
[0m13:00:30.738344 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E22E1F3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E23033AB80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E2318B87F0>]}
[0m13:00:30.738344 [debug] [MainThread]: Flushing usage events
[0m13:14:38.729588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002055471E400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000205536A5910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000205536A5B80>]}


============================== 13:14:38.733596 | ea9be952-3941-4de3-9c2d-5ff124f5a9be ==============================
[0m13:14:38.733596 [info ] [MainThread]: Running with dbt=1.7.4
[0m13:14:38.734042 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_pedido', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m13:14:39.193364 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ea9be952-3941-4de3-9c2d-5ff124f5a9be', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002055368C040>]}
[0m13:14:39.269679 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ea9be952-3941-4de3-9c2d-5ff124f5a9be', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020557E64D00>]}
[0m13:14:39.271917 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m13:14:39.277946 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m13:14:39.371437 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:14:39.371799 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_pedido.sql
[0m13:14:39.474311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ea9be952-3941-4de3-9c2d-5ff124f5a9be', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002055819CFA0>]}
[0m13:14:39.482932 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ea9be952-3941-4de3-9c2d-5ff124f5a9be', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020557EA53D0>]}
[0m13:14:39.482932 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m13:14:39.482932 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ea9be952-3941-4de3-9c2d-5ff124f5a9be', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020557EA5610>]}
[0m13:14:39.489350 [info ] [MainThread]: 
[0m13:14:39.489350 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:14:39.489350 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:14:39.489350 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:14:40.329574 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m13:14:40.329574 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:14:40.345816 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m13:14:40.345816 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:14:40.994371 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m13:14:40.995370 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:14:41.016762 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m13:14:41.021203 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:14:41.627207 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ea9be952-3941-4de3-9c2d-5ff124f5a9be', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020557DB4160>]}
[0m13:14:41.628553 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:14:41.629459 [info ] [MainThread]: 
[0m13:14:41.631858 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m13:14:41.633150 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_pedido ............................... [RUN]
[0m13:14:41.634148 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_pedido'
[0m13:14:41.634148 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m13:14:41.640164 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m13:14:41.642150 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 13:14:41.634148 => 13:14:41.641147
[0m13:14:41.642857 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m13:14:41.669598 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m13:14:41.670581 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m13:14:41.672613 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_tratamentos_pedido as a
left join cte_item               as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

select *
    from cte_pedido_base
    );
  
[0m13:14:42.391582 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1b1700c4-effd-4a26-ac83-85f1756d66f0&page=queryresults
[0m13:14:42.391582 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Table "cte_item" must be qualified with a dataset (e.g. dataset.table).')
[0m13:14:42.948289 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:37843fd1-6fe7-446b-aaf2-d0045c2f7190&page=queryresults
[0m13:14:42.950292 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:37843fd1-6fe7-446b-aaf2-d0045c2f7190&page=queryresults
[0m13:14:42.952689 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 13:14:41.642857 => 13:14:42.951595
[0m13:14:42.959693 [debug] [Thread-1  ]: Database Error in model tb_pedido (models\3.az\tb_pedido.sql)
  Table "cte_item" must be qualified with a dataset (e.g. dataset.table).
  compiled Code at target\run\shibaribrasil\models\3.az\tb_pedido.sql
[0m13:14:42.960733 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea9be952-3941-4de3-9c2d-5ff124f5a9be', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000205592A7FD0>]}
[0m13:14:42.961540 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_pedido ...................... [[31mERROR[0m in 1.33s]
[0m13:14:42.961540 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m13:14:42.965850 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:14:42.966522 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:14:42.966522 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m13:14:42.966522 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m13:14:42.967570 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_pedido' was properly closed.
[0m13:14:42.967570 [info ] [MainThread]: 
[0m13:14:42.968570 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.48 seconds (3.48s).
[0m13:14:42.968570 [debug] [MainThread]: Command end result
[0m13:14:42.989225 [info ] [MainThread]: 
[0m13:14:42.990222 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:14:42.991224 [info ] [MainThread]: 
[0m13:14:42.991224 [error] [MainThread]:   Database Error in model tb_pedido (models\3.az\tb_pedido.sql)
  Table "cte_item" must be qualified with a dataset (e.g. dataset.table).
  compiled Code at target\run\shibaribrasil\models\3.az\tb_pedido.sql
[0m13:14:42.992224 [info ] [MainThread]: 
[0m13:14:42.993222 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:14:42.994223 [debug] [MainThread]: Command `dbt run` failed at 13:14:42.994223 after 4.34 seconds
[0m13:14:42.994223 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002055471E400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020557E64D00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020557D13E50>]}
[0m13:14:42.995225 [debug] [MainThread]: Flushing usage events
[0m13:19:25.859487 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A1E016460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A1CF929A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A1CF92D30>]}


============================== 13:19:25.863486 | e0bed562-97d5-4698-9b21-91fd34df7b2e ==============================
[0m13:19:25.863486 [info ] [MainThread]: Running with dbt=1.7.4
[0m13:19:25.863486 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_pedido', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:19:26.383458 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e0bed562-97d5-4698-9b21-91fd34df7b2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A2015CA90>]}
[0m13:19:26.478564 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e0bed562-97d5-4698-9b21-91fd34df7b2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A2167A520>]}
[0m13:19:26.480459 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m13:19:26.490563 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m13:19:26.595456 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:19:26.596459 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_pedido.sql
[0m13:19:26.705457 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e0bed562-97d5-4698-9b21-91fd34df7b2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A21A8CBB0>]}
[0m13:19:26.715503 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e0bed562-97d5-4698-9b21-91fd34df7b2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A2187D1F0>]}
[0m13:19:26.716498 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m13:19:26.717099 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e0bed562-97d5-4698-9b21-91fd34df7b2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A2160D070>]}
[0m13:19:26.718240 [info ] [MainThread]: 
[0m13:19:26.719178 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:19:26.720216 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:19:26.720216 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:19:27.490660 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m13:19:27.491603 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:19:27.492593 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m13:19:27.493588 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:19:28.106590 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m13:19:28.107592 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:19:28.137590 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m13:19:28.138629 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:19:28.748287 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e0bed562-97d5-4698-9b21-91fd34df7b2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A21A8CAF0>]}
[0m13:19:28.749313 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:19:28.750311 [info ] [MainThread]: 
[0m13:19:28.755166 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m13:19:28.756165 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_pedido ............................... [RUN]
[0m13:19:28.757124 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_pedido'
[0m13:19:28.757124 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m13:19:28.765074 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m13:19:28.766071 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 13:19:28.757124 => 13:19:28.766071
[0m13:19:28.766071 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m13:19:28.795090 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m13:19:28.796091 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m13:19:28.797088 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_tratamentos_pedido        as a
left join cte_item_pedido               as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

select *
    from cte_pedido_base
    );
  
[0m13:19:29.475146 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:52399b03-8679-41d9-b738-6cae2359c1f2&page=queryresults
[0m13:19:29.476068 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Table "cte_tratamentos_pedido" must be qualified with a dataset (e.g. dataset.table).')
[0m13:19:30.680429 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3b12d30c-0102-476b-a211-df0539699ff3&page=queryresults
[0m13:19:30.680429 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3b12d30c-0102-476b-a211-df0539699ff3&page=queryresults
[0m13:19:30.682561 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 13:19:28.767082 => 13:19:30.681540
[0m13:19:30.686547 [debug] [Thread-1  ]: Database Error in model tb_pedido (models\3.az\tb_pedido.sql)
  Table "cte_tratamentos_pedido" must be qualified with a dataset (e.g. dataset.table).
  compiled Code at target\run\shibaribrasil\models\3.az\tb_pedido.sql
[0m13:19:30.687586 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e0bed562-97d5-4698-9b21-91fd34df7b2e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A22B2B580>]}
[0m13:19:30.688564 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_pedido ...................... [[31mERROR[0m in 1.93s]
[0m13:19:30.688822 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m13:19:30.690346 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:19:30.691356 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:19:30.692357 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m13:19:30.692357 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m13:19:30.692357 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_pedido' was properly closed.
[0m13:19:30.693355 [info ] [MainThread]: 
[0m13:19:30.694367 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.97 seconds (3.97s).
[0m13:19:30.695357 [debug] [MainThread]: Command end result
[0m13:19:30.716524 [info ] [MainThread]: 
[0m13:19:30.717518 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:19:30.718519 [info ] [MainThread]: 
[0m13:19:30.718519 [error] [MainThread]:   Database Error in model tb_pedido (models\3.az\tb_pedido.sql)
  Table "cte_tratamentos_pedido" must be qualified with a dataset (e.g. dataset.table).
  compiled Code at target\run\shibaribrasil\models\3.az\tb_pedido.sql
[0m13:19:30.719510 [info ] [MainThread]: 
[0m13:19:30.719510 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m13:19:30.720517 [debug] [MainThread]: Command `dbt run` failed at 13:19:30.720517 after 4.92 seconds
[0m13:19:30.722005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A1E016460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A2167A520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023A216EFDC0>]}
[0m13:19:30.722005 [debug] [MainThread]: Flushing usage events
[0m13:23:39.461072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9D14823D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9D041D2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9D041D760>]}


============================== 13:23:39.467121 | ce64431a-c7ac-4db8-9310-d33aed12f9d9 ==============================
[0m13:23:39.467121 [info ] [MainThread]: Running with dbt=1.7.4
[0m13:23:39.468109 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models tb_pedido', 'send_anonymous_usage_stats': 'True'}
[0m13:23:39.902559 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ce64431a-c7ac-4db8-9310-d33aed12f9d9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9D040C0D0>]}
[0m13:23:39.975549 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ce64431a-c7ac-4db8-9310-d33aed12f9d9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9D4A25C40>]}
[0m13:23:39.976798 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m13:23:39.983390 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m13:23:40.083405 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:23:40.083405 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_pedido.sql
[0m13:23:40.183970 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ce64431a-c7ac-4db8-9310-d33aed12f9d9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9D4F1CDF0>]}
[0m13:23:40.197171 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ce64431a-c7ac-4db8-9310-d33aed12f9d9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9D4D0E190>]}
[0m13:23:40.197171 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m13:23:40.198172 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ce64431a-c7ac-4db8-9310-d33aed12f9d9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9D4D0E3D0>]}
[0m13:23:40.199228 [info ] [MainThread]: 
[0m13:23:40.199925 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:23:40.201475 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:23:40.201475 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:23:40.881230 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m13:23:40.882241 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:23:40.887267 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m13:23:40.888255 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:23:41.510536 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m13:23:41.510536 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m13:23:41.510536 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:23:41.510536 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:23:42.157405 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ce64431a-c7ac-4db8-9310-d33aed12f9d9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9D4B6D2B0>]}
[0m13:23:42.157405 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:23:42.158454 [info ] [MainThread]: 
[0m13:23:42.163413 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m13:23:42.163413 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_pedido ............................... [RUN]
[0m13:23:42.164460 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_pedido'
[0m13:23:42.165374 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m13:23:42.175247 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m13:23:42.177614 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 13:23:42.165374 => 13:23:42.176604
[0m13:23:42.177614 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m13:23:42.201794 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m13:23:42.211279 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m13:23:42.213413 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

select *
    from cte_pedido_base
    );
  
[0m13:23:43.443227 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5c8e9087-5b84-46e6-ac90-a98d54a77494&page=queryresults
[0m13:23:45.806999 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 13:23:42.178619 => 13:23:45.805877
[0m13:23:45.807996 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ce64431a-c7ac-4db8-9310-d33aed12f9d9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9D5FD2E50>]}
[0m13:23:45.807996 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_pedido .......................... [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 3.64s]
[0m13:23:45.810000 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m13:23:45.813956 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:23:45.814965 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:23:45.815547 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m13:23:45.816650 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m13:23:45.816650 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_pedido' was properly closed.
[0m13:23:45.817655 [info ] [MainThread]: 
[0m13:23:45.819651 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.62 seconds (5.62s).
[0m13:23:45.821612 [debug] [MainThread]: Command end result
[0m13:23:45.897992 [info ] [MainThread]: 
[0m13:23:45.901000 [info ] [MainThread]: [32mCompleted successfully[0m
[0m13:23:45.903004 [info ] [MainThread]: 
[0m13:23:45.904957 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m13:23:45.909434 [debug] [MainThread]: Command `dbt run` succeeded at 13:23:45.908458 after 6.52 seconds
[0m13:23:45.910491 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9D14823D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9D4A9CA30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9D4DE1CD0>]}
[0m13:23:45.912436 [debug] [MainThread]: Flushing usage events
[0m13:28:13.777855 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023826196430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000238251126A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023825112DC0>]}


============================== 13:28:13.781632 | 26d64ac8-7a52-4cb3-80c9-3920b212dfa2 ==============================
[0m13:28:13.781632 [info ] [MainThread]: Running with dbt=1.7.4
[0m13:28:13.781632 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_pedido', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m13:28:14.250462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '26d64ac8-7a52-4cb3-80c9-3920b212dfa2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023825117880>]}
[0m13:28:14.312197 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '26d64ac8-7a52-4cb3-80c9-3920b212dfa2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000238297FA970>]}
[0m13:28:14.313244 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m13:28:14.320347 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m13:28:14.431746 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m13:28:14.432290 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_pedido.sql
[0m13:28:14.571509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '26d64ac8-7a52-4cb3-80c9-3920b212dfa2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023829C0AEE0>]}
[0m13:28:14.580895 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '26d64ac8-7a52-4cb3-80c9-3920b212dfa2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000238299FE4C0>]}
[0m13:28:14.580895 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m13:28:14.581920 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '26d64ac8-7a52-4cb3-80c9-3920b212dfa2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000238299FE520>]}
[0m13:28:14.582895 [info ] [MainThread]: 
[0m13:28:14.583894 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:28:14.584894 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:28:14.585895 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:28:15.399235 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m13:28:15.400289 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:28:15.402292 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m13:28:15.425168 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:28:16.139709 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m13:28:16.141696 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:28:16.170971 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m13:28:16.172972 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:28:16.905815 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '26d64ac8-7a52-4cb3-80c9-3920b212dfa2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002382970EFD0>]}
[0m13:28:16.906830 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:28:16.909354 [info ] [MainThread]: 
[0m13:28:16.918929 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m13:28:16.921051 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_pedido ............................... [RUN]
[0m13:28:16.922972 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_pedido'
[0m13:28:16.924001 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m13:28:16.939165 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m13:28:16.940162 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 13:28:16.924998 => 13:28:16.940162
[0m13:28:16.941152 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m13:28:16.953707 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m13:28:17.617700 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m13:28:17.619773 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,round((a.qt_item * vl_item), 2)                                                        as vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                         as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

select *
    from cte_pedido_total
    );
  
[0m13:28:18.491639 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a830464c-02d9-4726-8227-2c9b0a803679&page=queryresults
[0m13:28:20.784557 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 13:28:16.941152 => 13:28:20.784557
[0m13:28:20.785555 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '26d64ac8-7a52-4cb3-80c9-3920b212dfa2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023829CC0C10>]}
[0m13:28:20.786556 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_pedido .......................... [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 3.86s]
[0m13:28:20.787554 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m13:28:20.789826 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:28:20.789826 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:28:20.790828 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m13:28:20.790828 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m13:28:20.791848 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_pedido' was properly closed.
[0m13:28:20.791848 [info ] [MainThread]: 
[0m13:28:20.792798 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.21 seconds (6.21s).
[0m13:28:20.794822 [debug] [MainThread]: Command end result
[0m13:28:20.854005 [info ] [MainThread]: 
[0m13:28:20.857537 [info ] [MainThread]: [32mCompleted successfully[0m
[0m13:28:20.860568 [info ] [MainThread]: 
[0m13:28:20.862575 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m13:28:20.867782 [debug] [MainThread]: Command `dbt run` succeeded at 13:28:20.867782 after 7.15 seconds
[0m13:28:20.869840 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023826196430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000238298C6F10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023829AD0DC0>]}
[0m13:28:20.873455 [debug] [MainThread]: Flushing usage events
[0m14:00:05.956669 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001118E04B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001118CFDF9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001118CFDFD30>]}


============================== 14:00:05.972485 | 7404c7cc-c568-4a63-b430-a106e1f3dec1 ==============================
[0m14:00:05.972485 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:00:05.972485 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:00:07.193431 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001118CFCD1F0>]}
[0m14:00:07.257354 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000111915AB7F0>]}
[0m14:00:07.257354 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m14:00:07.257354 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m14:00:07.368935 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:00:07.368935 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:00:07.368935 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000111919848E0>]}
[0m14:00:07.385074 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000111918BA3D0>]}
[0m14:00:07.385074 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m14:00:07.385074 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011191729070>]}
[0m14:00:07.401019 [info ] [MainThread]: 
[0m14:00:07.401019 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:00:07.401019 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:07.401019 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:07.401019 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:07.401019 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:08.293920 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:09.043132 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m14:00:09.043132 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:09.043132 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m14:00:09.043132 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:09.828665 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m14:00:09.844641 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:09.924346 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m14:00:09.924346 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:10.703729 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000111918BA7F0>]}
[0m14:00:10.703729 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:00:10.719430 [info ] [MainThread]: 
[0m14:00:10.719430 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:10.719430 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m14:00:10.719430 [info ] [Thread-1  ]: 1 of 15 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m14:00:10.737142 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m14:00:10.719430 [info ] [Thread-2  ]: 2 of 15 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m14:00:10.737142 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:10.737142 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m14:00:10.750791 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m14:00:10.759390 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m14:00:10.768474 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m14:00:10.774538 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 14:00:10.737142 => 14:00:10.772516
[0m14:00:10.776561 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 14:00:10.759390 => 14:00:10.774538
[0m14:00:10.776561 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:10.778587 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m14:00:10.845862 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m14:00:10.861728 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m14:00:10.877662 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m14:00:10.879218 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m14:00:10.887031 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m14:00:10.887031 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m14:00:12.166874 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:eac4e535-8c30-4955-abac-52c182df68cf&page=queryresults
[0m14:00:12.166874 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e87683ac-54ae-41d9-b42a-a6b6779eca14&page=queryresults
[0m14:00:12.645011 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 14:00:10.782375 => 14:00:12.645011
[0m14:00:12.645011 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 14:00:10.780613 => 14:00:12.645011
[0m14:00:12.645011 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000111919FF370>]}
[0m14:00:12.645011 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011192A9D670>]}
[0m14:00:12.645011 [info ] [Thread-2  ]: 2 of 15 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.91s]
[0m14:00:12.645011 [info ] [Thread-1  ]: 1 of 15 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.91s]
[0m14:00:12.660795 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m14:00:12.660795 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:12.660795 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m14:00:12.660795 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m14:00:12.660795 [info ] [Thread-2  ]: 3 of 15 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m14:00:12.660795 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m14:00:12.660795 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m14:00:12.660795 [info ] [Thread-1  ]: 4 of 15 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m14:00:12.660795 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m14:00:12.660795 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m14:00:12.660795 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m14:00:12.676603 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m14:00:12.676603 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 14:00:12.660795 => 14:00:12.676603
[0m14:00:12.676603 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m14:00:12.676603 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m14:00:12.692524 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 14:00:12.660795 => 14:00:12.676603
[0m14:00:12.692524 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m14:00:12.697726 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m14:00:12.697726 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:12.708256 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m14:00:12.747776 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:12.747776 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m14:00:13.488346 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d3bf1007-065e-4b66-ab95-c3222c5b8fe9&page=queryresults
[0m14:00:13.504457 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d950f00b-8025-4f6e-aaeb-5751454985bb&page=queryresults
[0m14:00:13.902283 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 14:00:12.676603 => 14:00:13.902283
[0m14:00:13.902283 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000111929FCDF0>]}
[0m14:00:13.902283 [info ] [Thread-2  ]: 3 of 15 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m14:00:13.902283 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m14:00:13.902283 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m14:00:13.902283 [info ] [Thread-2  ]: 5 of 15 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m14:00:13.918352 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m14:00:13.918352 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m14:00:13.934398 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m14:00:13.948892 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 14:00:12.695705 => 14:00:13.946866
[0m14:00:13.951412 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011192A08FD0>]}
[0m14:00:13.951412 [info ] [Thread-1  ]: 4 of 15 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m14:00:13.951412 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m14:00:13.951412 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 14:00:13.918352 => 14:00:13.951412
[0m14:00:13.951412 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m14:00:13.951412 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m14:00:13.951412 [info ] [Thread-1  ]: 6 of 15 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m14:00:13.968184 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m14:00:13.970206 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m14:00:13.972227 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m14:00:13.976261 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m14:00:13.978275 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:13.978275 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m14:00:13.998167 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 14:00:13.972227 => 14:00:13.998167
[0m14:00:13.998167 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m14:00:14.003736 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m14:00:14.003736 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:14.005755 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m14:00:14.719207 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:72ba90ca-7792-4fac-905b-f645108b5a5a&page=queryresults
[0m14:00:14.855024 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:521c2569-3ea9-4b87-af7c-8e3e5119a652&page=queryresults
[0m14:00:15.151327 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 14:00:14.001715 => 14:00:15.151327
[0m14:00:15.151327 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011192AF2250>]}
[0m14:00:15.151327 [info ] [Thread-1  ]: 6 of 15 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m14:00:15.151327 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m14:00:15.151327 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:15.151327 [info ] [Thread-1  ]: 7 of 15 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m14:00:15.151327 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_meta_margem_preco)
[0m14:00:15.151327 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:15.174896 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m14:00:15.178927 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 14:00:15.151327 => 14:00:15.178927
[0m14:00:15.183315 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:15.183315 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m14:00:15.199267 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:15.199267 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m14:00:15.392999 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 14:00:13.951412 => 14:00:15.392999
[0m14:00:15.395026 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011192A553D0>]}
[0m14:00:15.397044 [info ] [Thread-2  ]: 5 of 15 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.48s]
[0m14:00:15.399063 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m14:00:15.401078 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m14:00:15.403098 [info ] [Thread-2  ]: 8 of 15 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m14:00:15.405118 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_pedido)
[0m14:00:15.405118 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m14:00:15.422733 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m14:00:15.422733 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 14:00:15.406879 => 14:00:15.422733
[0m14:00:15.428268 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m14:00:15.436494 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m14:00:15.438503 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:15.440514 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_pedido
        ,nullif(trim(total), '')                     as vl_total_item
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m14:00:15.964766 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e0d4d544-46b1-42cf-b747-c9ad22a954aa&page=queryresults
[0m14:00:16.190402 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f6d3ef9a-6bfd-4d6c-b491-4a23aee6415f&page=queryresults
[0m14:00:16.380734 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 14:00:15.183315 => 14:00:16.380734
[0m14:00:16.380734 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011192B30220>]}
[0m14:00:16.380734 [info ] [Thread-1  ]: 7 of 15 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m14:00:16.380734 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:16.380734 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m14:00:16.395444 [info ] [Thread-1  ]: 9 of 15 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m14:00:16.395444 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m14:00:16.395444 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m14:00:16.395444 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m14:00:16.395444 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 14:00:16.395444 => 14:00:16.395444
[0m14:00:16.395444 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m14:00:16.411333 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m14:00:16.411333 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:16.411333 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m14:00:16.635234 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 14:00:15.428268 => 14:00:16.635234
[0m14:00:16.635234 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000111919FF370>]}
[0m14:00:16.635234 [info ] [Thread-2  ]: 8 of 15 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m14:00:16.635234 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m14:00:16.635234 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m14:00:16.651196 [info ] [Thread-2  ]: 10 of 15 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m14:00:16.651196 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.tb_pedido)
[0m14:00:16.651196 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m14:00:16.651196 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m14:00:16.667023 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 14:00:16.651196 => 14:00:16.667023
[0m14:00:16.667023 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m14:00:16.686931 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:17.350673 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:577ac86b-9a0a-49fa-938a-d8053c8dc0fc&page=queryresults
[0m14:00:17.621569 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m14:00:17.623347 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,round((a.qt_item * vl_item), 2)                                                        as vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                         as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

select *
    from cte_pedido_total
    );
  
[0m14:00:17.811512 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 14:00:16.395444 => 14:00:17.811512
[0m14:00:17.813525 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011192AA91C0>]}
[0m14:00:17.813525 [info ] [Thread-1  ]: 9 of 15 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m14:00:17.815278 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m14:00:17.815278 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m14:00:17.815278 [info ] [Thread-1  ]: 11 of 15 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m14:00:17.818470 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m14:00:17.820506 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m14:00:17.832668 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m14:00:17.832668 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 14:00:17.820506 => 14:00:17.832668
[0m14:00:17.832668 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m14:00:17.846102 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:18.260415 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6994be87-5fed-47be-ad53-58f6198bf06f&page=queryresults
[0m14:00:18.530326 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m14:00:18.530326 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m14:00:19.132728 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c0fc4170-d4e4-4938-acc0-c2561869d41a&page=queryresults
[0m14:00:21.073865 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 14:00:16.667023 => 14:00:21.073865
[0m14:00:21.073865 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011192A31A60>]}
[0m14:00:21.073865 [info ] [Thread-2  ]: 10 of 15 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 4.42s]
[0m14:00:21.073865 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m14:00:22.397240 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 14:00:17.844093 => 14:00:22.395220
[0m14:00:22.397240 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011192AA60D0>]}
[0m14:00:22.399258 [info ] [Thread-1  ]: 11 of 15 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 4.58s]
[0m14:00:22.402791 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m14:00:22.404807 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m14:00:22.404807 [info ] [Thread-2  ]: 12 of 15 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m14:00:22.404807 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_produto)
[0m14:00:22.409202 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m14:00:22.416742 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m14:00:22.416742 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 14:00:22.409202 => 14:00:22.416742
[0m14:00:22.416742 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m14:00:22.416742 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:23.403900 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m14:00:23.419671 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m14:00:24.072665 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1c9503c2-a337-4278-91cc-8d84ea8edb22&page=queryresults
[0m14:00:26.922421 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 14:00:22.416742 => 14:00:26.922421
[0m14:00:26.924426 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011192A43880>]}
[0m14:00:26.926432 [info ] [Thread-2  ]: 12 of 15 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 4.52s]
[0m14:00:26.926432 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m14:00:26.928440 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m14:00:26.928440 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m14:00:26.928440 [info ] [Thread-1  ]: 13 of 15 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m14:00:26.932197 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m14:00:26.930190 [info ] [Thread-2  ]: 14 of 15 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m14:00:26.932197 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m14:00:26.934203 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m14:00:26.942223 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m14:00:26.944229 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m14:00:26.949988 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m14:00:26.954001 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 14:00:26.936208 => 14:00:26.951993
[0m14:00:26.954001 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 14:00:26.944229 => 14:00:26.954001
[0m14:00:26.956009 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m14:00:26.958018 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m14:00:26.965802 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:27.025151 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:27.698194 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m14:00:27.700204 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m14:00:27.759522 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m14:00:27.761530 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m14:00:28.098025 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7f7891d0-78b3-4815-9b8e-63df66343248&page=queryresults
[0m14:00:28.321316 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:acbae3c6-93ca-43e7-8716-9c20ff9f4cbd&page=queryresults
[0m14:00:30.098004 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 14:00:26.961777 => 14:00:30.098004
[0m14:00:30.098004 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011192C0F2B0>]}
[0m14:00:30.098004 [info ] [Thread-2  ]: 14 of 15 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 77.2 KiB processed)[0m in 3.16s]
[0m14:00:30.098004 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m14:00:30.110829 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m14:00:30.110829 [info ] [Thread-2  ]: 15 of 15 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m14:00:30.113949 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_preco_produto)
[0m14:00:30.113949 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m14:00:30.113949 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m14:00:30.130021 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 14:00:30.113949 => 14:00:30.130021
[0m14:00:30.130021 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m14:00:30.130021 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:30.560091 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 14:00:26.958018 => 14:00:30.560091
[0m14:00:30.560091 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011192A43AC0>]}
[0m14:00:30.560091 [info ] [Thread-1  ]: 13 of 15 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 3.63s]
[0m14:00:30.575902 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m14:00:30.785440 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m14:00:30.785440 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m14:00:31.469872 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5d2c2bce-15f1-4bd1-ab95-41a0a473a982&page=queryresults
[0m14:00:34.877095 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 14:00:30.130021 => 14:00:34.877095
[0m14:00:34.877095 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7404c7cc-c568-4a63-b430-a106e1f3dec1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011192A96580>]}
[0m14:00:34.877095 [info ] [Thread-2  ]: 15 of 15 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 73.7 KiB processed)[0m in 4.76s]
[0m14:00:34.877095 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m14:00:34.891788 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:00:34.891788 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:00:34.891788 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:00:34.891788 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m14:00:34.891788 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m14:00:34.891788 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m14:00:34.891788 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m14:00:34.891788 [info ] [MainThread]: 
[0m14:00:34.891788 [info ] [MainThread]: Finished running 9 view models, 6 table models in 0 hours 0 minutes and 27.49 seconds (27.49s).
[0m14:00:34.910079 [debug] [MainThread]: Command end result
[0m14:00:34.939208 [info ] [MainThread]: 
[0m14:00:34.939208 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:00:34.939208 [info ] [MainThread]: 
[0m14:00:34.939208 [info ] [MainThread]: Done. PASS=15 WARN=0 ERROR=0 SKIP=0 TOTAL=15
[0m14:00:34.939208 [debug] [MainThread]: Command `dbt run` succeeded at 14:00:34.939208 after 29.12 seconds
[0m14:00:34.939208 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001118E04B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000111915AB7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000111919D3130>]}
[0m14:00:34.939208 [debug] [MainThread]: Flushing usage events
[0m14:00:40.005582 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001729F6B24C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001729E6372E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001729E637760>]}


============================== 14:00:40.005582 | d01bdb69-611a-4191-8cb4-b90174f7fa10 ==============================
[0m14:00:40.005582 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:00:40.005582 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt snapshot', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:00:41.124298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd01bdb69-611a-4191-8cb4-b90174f7fa10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000172A17FAC10>]}
[0m14:00:41.187539 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd01bdb69-611a-4191-8cb4-b90174f7fa10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000172A2D10A30>]}
[0m14:00:41.187539 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m14:00:41.204910 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m14:00:41.254267 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:00:41.254267 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:00:41.258278 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd01bdb69-611a-4191-8cb4-b90174f7fa10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000172A2FE3880>]}
[0m14:00:41.266145 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd01bdb69-611a-4191-8cb4-b90174f7fa10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000172A2F1D580>]}
[0m14:00:41.266145 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m14:00:41.266145 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd01bdb69-611a-4191-8cb4-b90174f7fa10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000172A2D79430>]}
[0m14:00:41.266145 [info ] [MainThread]: 
[0m14:00:41.266145 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:00:41.266145 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:41.266145 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:42.077184 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m14:00:42.077184 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:42.077184 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m14:00:42.092959 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:42.746204 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m14:00:42.746204 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:43.191713 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m14:00:43.191713 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:43.906385 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd01bdb69-611a-4191-8cb4-b90174f7fa10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000172A2F1D520>]}
[0m14:00:43.922323 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:00:43.922323 [info ] [MainThread]: 
[0m14:00:43.922323 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m14:00:43.922323 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m14:00:43.938414 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m14:00:43.938414 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m14:00:43.970257 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 14:00:43.938414 => 14:00:43.970257
[0m14:00:43.970257 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m14:00:44.065920 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m14:00:44.065920 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m14:00:44.941503 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6f239af5-5e3f-419d-a1aa-100dc01b0ced&page=queryresults
[0m14:00:46.111006 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m14:00:46.564280 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:28aea76e-140b-4f13-84c5-303ef51d7f91&page=queryresults
[0m14:00:48.962525 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m14:00:49.726384 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m14:00:49.742140 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m14:00:50.293541 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:aa2ba039-066a-4fb0-8bd7-93c1e1966d81&page=queryresults
[0m14:00:52.284284 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 14:00:43.975312 => 14:00:52.284284
[0m14:00:52.284284 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd01bdb69-611a-4191-8cb4-b90174f7fa10', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000172A409DF40>]}
[0m14:00:52.284284 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 65.3 KiB processed)[0m in 8.35s]
[0m14:00:52.284284 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m14:00:52.284284 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:00:52.284284 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:00:52.284284 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m14:00:52.284284 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m14:00:52.284284 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m14:00:52.284284 [info ] [MainThread]: 
[0m14:00:52.284284 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 11.02 seconds (11.02s).
[0m14:00:52.284284 [debug] [MainThread]: Command end result
[0m14:00:52.315748 [info ] [MainThread]: 
[0m14:00:52.315748 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:00:52.315748 [info ] [MainThread]: 
[0m14:00:52.315748 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m14:00:52.315748 [debug] [MainThread]: Command `dbt snapshot` succeeded at 14:00:52.315748 after 12.38 seconds
[0m14:00:52.315748 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001729F6B24C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000172A2D40310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000172A2DE6CA0>]}
[0m14:00:52.315748 [debug] [MainThread]: Flushing usage events
[0m14:00:58.214773 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292F8E43400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292F7DB9640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292F7DB9AC0>]}


============================== 14:00:58.214773 | bb8851ee-6cb9-49de-9c29-d4d586d643ed ==============================
[0m14:00:58.214773 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:00:58.214773 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m14:00:59.256721 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bb8851ee-6cb9-49de-9c29-d4d586d643ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292F7DAFFD0>]}
[0m14:00:59.321000 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bb8851ee-6cb9-49de-9c29-d4d586d643ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC3E15B0>]}
[0m14:00:59.336993 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m14:00:59.336993 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m14:00:59.400803 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:00:59.400803 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:00:59.400803 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bb8851ee-6cb9-49de-9c29-d4d586d643ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC774AC0>]}
[0m14:00:59.416962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bb8851ee-6cb9-49de-9c29-d4d586d643ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC6A78B0>]}
[0m14:00:59.416962 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m14:00:59.416962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bb8851ee-6cb9-49de-9c29-d4d586d643ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC4E54F0>]}
[0m14:00:59.416962 [info ] [MainThread]: 
[0m14:00:59.416962 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:00:59.432878 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:59.432878 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:01:00.133734 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m14:01:00.133734 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:01:00.133734 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m14:01:00.133734 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:01:00.853262 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m14:01:00.867409 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:01:00.869436 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m14:01:00.871447 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:01:01.489892 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bb8851ee-6cb9-49de-9c29-d4d586d643ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC6A77F0>]}
[0m14:01:01.489892 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:01:01.489892 [info ] [MainThread]: 
[0m14:01:01.505816 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m14:01:01.505816 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m14:01:01.505816 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m14:01:01.505816 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m14:01:01.537760 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m14:01:01.537760 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 14:01:01.505816 => 14:01:01.537760
[0m14:01:01.537760 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m14:01:01.553601 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m14:01:02.240155 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m14:01:02.240155 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m14:01:02.640860 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:969e05c3-779c-49f0-a020-ac7c6d8a9e20&page=queryresults
[0m14:01:04.346111 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 14:01:01.537760 => 14:01:04.346111
[0m14:01:04.346111 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bb8851ee-6cb9-49de-9c29-d4d586d643ed', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC7FFB80>]}
[0m14:01:04.346111 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (363.0 rows, 53.3 KiB processed)[0m in 2.84s]
[0m14:01:04.346111 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m14:01:04.346111 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:01:04.346111 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:01:04.346111 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m14:01:04.346111 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m14:01:04.346111 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m14:01:04.362218 [info ] [MainThread]: 
[0m14:01:04.362218 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.95 seconds (4.95s).
[0m14:01:04.362218 [debug] [MainThread]: Command end result
[0m14:01:04.378225 [info ] [MainThread]: 
[0m14:01:04.378225 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:01:04.378225 [info ] [MainThread]: 
[0m14:01:04.378225 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m14:01:04.394353 [debug] [MainThread]: Command `dbt run` succeeded at 14:01:04.394353 after 6.24 seconds
[0m14:01:04.394353 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292F8E43400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC4C9F10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC564310>]}
[0m14:01:04.394353 [debug] [MainThread]: Flushing usage events
[0m15:00:05.021408 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BD7F734C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BD6EF5310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BD6EF5790>]}


============================== 15:00:05.031537 | 43d25243-e23a-48ee-b2c3-af9f6c9f613d ==============================
[0m15:00:05.031537 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:00:05.033552 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --exclude tag:snaps', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:00:05.865761 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BD6EDA190>]}
[0m15:00:05.929076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDB5110D0>]}
[0m15:00:05.929076 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:00:05.945123 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:00:05.992987 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:00:05.992987 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:00:05.992987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDB8A4AC0>]}
[0m15:00:05.992987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDB7D75B0>]}
[0m15:00:05.992987 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:00:06.009101 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDB51D6D0>]}
[0m15:00:06.009101 [info ] [MainThread]: 
[0m15:00:06.009101 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:00:06.009101 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:06.009101 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:06.009101 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:06.024792 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:06.876240 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:07.532521 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:00:07.532521 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m15:00:07.532521 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:07.532521 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:08.223499 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:00:08.239358 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:08.399472 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m15:00:08.399472 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:09.066244 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDB548AC0>]}
[0m15:00:09.066244 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:00:09.067312 [info ] [MainThread]: 
[0m15:00:09.072215 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:09.073295 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m15:00:09.073295 [info ] [Thread-1  ]: 1 of 15 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m15:00:09.074594 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m15:00:09.074209 [info ] [Thread-2  ]: 2 of 15 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m15:00:09.074594 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:09.074594 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m15:00:09.074594 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m15:00:09.074594 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m15:00:09.074594 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m15:00:09.074594 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 15:00:09.074594 => 15:00:09.074594
[0m15:00:09.074594 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m15:00:09.074594 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 15:00:09.074594 => 15:00:09.074594
[0m15:00:09.074594 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:09.110986 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m15:00:09.115984 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m15:00:09.115984 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:00:09.118023 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m15:00:09.118023 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m15:00:09.133742 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m15:00:10.001535 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9eccaf82-63ae-4a56-ab4a-cc97a234ff65&page=queryresults
[0m15:00:10.001535 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:560f7ff7-bffd-4bc2-8e62-66121d31a868&page=queryresults
[0m15:00:10.420748 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 15:00:09.074594 => 15:00:10.420748
[0m15:00:10.420748 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDB51DB20>]}
[0m15:00:10.420748 [info ] [Thread-2  ]: 2 of 15 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.35s]
[0m15:00:10.420748 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m15:00:10.420748 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m15:00:10.420748 [info ] [Thread-2  ]: 3 of 15 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m15:00:10.420748 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m15:00:10.420748 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m15:00:10.436648 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m15:00:10.436648 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 15:00:10.420748 => 15:00:10.436648
[0m15:00:10.436648 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m15:00:10.436648 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m15:00:10.436648 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:10.452839 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m15:00:10.469029 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 15:00:09.074594 => 15:00:10.469029
[0m15:00:10.484873 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDC929E50>]}
[0m15:00:10.484873 [info ] [Thread-1  ]: 1 of 15 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.41s]
[0m15:00:10.484873 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:10.484873 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m15:00:10.484873 [info ] [Thread-1  ]: 4 of 15 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m15:00:10.484873 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m15:00:10.484873 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m15:00:10.484873 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m15:00:10.484873 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 15:00:10.484873 => 15:00:10.484873
[0m15:00:10.484873 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m15:00:10.484873 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m15:00:10.501063 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:10.501063 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m15:00:11.199550 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bc54625c-1034-435f-9f7d-09b0596a3d76&page=queryresults
[0m15:00:11.279234 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ca11177b-b7b7-4fb2-8993-bfe1ec27c121&page=queryresults
[0m15:00:11.617117 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 15:00:10.436648 => 15:00:11.617117
[0m15:00:11.617117 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDB8F3C70>]}
[0m15:00:11.617117 [info ] [Thread-2  ]: 3 of 15 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m15:00:11.632827 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m15:00:11.632827 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m15:00:11.632827 [info ] [Thread-2  ]: 5 of 15 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m15:00:11.632827 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m15:00:11.632827 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m15:00:11.648611 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m15:00:11.648611 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 15:00:11.632827 => 15:00:11.648611
[0m15:00:11.648611 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m15:00:11.648611 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m15:00:11.648611 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:11.648611 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m15:00:11.696195 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 15:00:10.484873 => 15:00:11.696195
[0m15:00:11.696195 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDB8D9610>]}
[0m15:00:11.696195 [info ] [Thread-1  ]: 4 of 15 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m15:00:11.712339 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m15:00:11.712339 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m15:00:11.712339 [info ] [Thread-1  ]: 6 of 15 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m15:00:11.712339 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m15:00:11.712339 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m15:00:11.712339 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m15:00:11.712339 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 15:00:11.712339 => 15:00:11.712339
[0m15:00:11.728177 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m15:00:11.728177 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m15:00:11.728177 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:11.728177 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m15:00:12.447235 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:00633843-8491-4e27-b903-1daec361873e&page=queryresults
[0m15:00:12.511108 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:edfea231-9692-451d-a3c8-85bb09a04ba6&page=queryresults
[0m15:00:12.815420 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 15:00:11.648611 => 15:00:12.815420
[0m15:00:12.815420 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDB8F3C70>]}
[0m15:00:12.815420 [info ] [Thread-2  ]: 5 of 15 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m15:00:12.815420 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m15:00:12.815420 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:12.830619 [info ] [Thread-2  ]: 7 of 15 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m15:00:12.830619 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m15:00:12.830619 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:12.830619 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m15:00:12.830619 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 15:00:12.830619 => 15:00:12.830619
[0m15:00:12.830619 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:12.846745 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m15:00:12.846745 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:12.850211 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m15:00:13.012488 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 15:00:11.728177 => 15:00:13.012488
[0m15:00:13.014504 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDB8D9FA0>]}
[0m15:00:13.016519 [info ] [Thread-1  ]: 6 of 15 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m15:00:13.016519 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m15:00:13.016519 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m15:00:13.016519 [info ] [Thread-1  ]: 8 of 15 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m15:00:13.016519 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m15:00:13.022329 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m15:00:13.035598 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m15:00:13.039627 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 15:00:13.022329 => 15:00:13.037616
[0m15:00:13.039627 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m15:00:13.046101 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m15:00:13.048118 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:13.048118 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_pedido
        ,nullif(trim(total), '')                     as vl_total_item
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m15:00:13.691793 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1bb9be1c-991c-4a54-9c54-93661aeb963d&page=queryresults
[0m15:00:13.787572 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:50f747dd-85d0-4e2d-8aec-7fb600a73cc4&page=queryresults
[0m15:00:14.130041 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 15:00:12.830619 => 15:00:14.129046
[0m15:00:14.131037 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDC953F10>]}
[0m15:00:14.132036 [info ] [Thread-2  ]: 7 of 15 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m15:00:14.133943 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:14.134940 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m15:00:14.135937 [info ] [Thread-2  ]: 9 of 15 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m15:00:14.137001 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m15:00:14.137001 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m15:00:14.137001 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m15:00:14.137001 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 15:00:14.137001 => 15:00:14.137001
[0m15:00:14.137001 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m15:00:14.153008 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m15:00:14.153008 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:14.160029 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m15:00:14.224328 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 15:00:13.039627 => 15:00:14.222312
[0m15:00:14.224328 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDC99AA00>]}
[0m15:00:14.226341 [info ] [Thread-1  ]: 8 of 15 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m15:00:14.226341 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m15:00:14.226341 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m15:00:14.226341 [info ] [Thread-1  ]: 10 of 15 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m15:00:14.232994 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.tb_pedido)
[0m15:00:14.232994 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m15:00:14.232994 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m15:00:14.232994 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 15:00:14.232994 => 15:00:14.232994
[0m15:00:14.232994 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m15:00:14.253145 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:14.939587 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m15:00:14.939587 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:19100236-9b72-4314-997f-9d4e7a9f732c&page=queryresults
[0m15:00:14.939587 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,round((a.qt_item * vl_item), 2)                                                        as vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                         as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

select *
    from cte_pedido_total
    );
  
[0m15:00:15.326402 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 15:00:14.137001 => 15:00:15.326402
[0m15:00:15.328417 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDCA59CD0>]}
[0m15:00:15.330429 [info ] [Thread-2  ]: 9 of 15 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m15:00:15.332440 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m15:00:15.334448 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m15:00:15.336455 [info ] [Thread-2  ]: 11 of 15 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m15:00:15.338210 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m15:00:15.338210 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m15:00:15.354209 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m15:00:15.354209 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 15:00:15.338210 => 15:00:15.354209
[0m15:00:15.354209 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m15:00:15.360075 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:15.627019 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a36e69b9-fa60-4960-8c02-d5caf8551005&page=queryresults
[0m15:00:16.203259 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m15:00:16.203259 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m15:00:16.816700 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1e0bdcc7-7fc5-4705-91ff-91ce821a6f98&page=queryresults
[0m15:00:19.308245 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 15:00:14.232994 => 15:00:19.308245
[0m15:00:19.308245 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDC968A30>]}
[0m15:00:19.310256 [info ] [Thread-1  ]: 10 of 15 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 5.08s]
[0m15:00:19.310256 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m15:00:20.150514 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 15:00:15.358058 => 15:00:20.150514
[0m15:00:20.150514 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDC98D160>]}
[0m15:00:20.160232 [info ] [Thread-2  ]: 11 of 15 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 4.81s]
[0m15:00:20.160232 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m15:00:20.160232 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m15:00:20.162598 [info ] [Thread-1  ]: 12 of 15 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m15:00:20.162598 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_produto)
[0m15:00:20.164612 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m15:00:20.170648 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m15:00:20.170648 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 15:00:20.164612 => 15:00:20.170648
[0m15:00:20.170648 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m15:00:20.176407 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:20.812739 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m15:00:20.814751 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m15:00:21.465600 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:773c49b4-9a52-4804-951c-4b06d60ca1e7&page=queryresults
[0m15:00:23.810679 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 15:00:20.170648 => 15:00:23.810679
[0m15:00:23.810679 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDCA59CA0>]}
[0m15:00:23.810679 [info ] [Thread-1  ]: 12 of 15 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 3.65s]
[0m15:00:23.810679 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m15:00:23.810679 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m15:00:23.810679 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m15:00:23.810679 [info ] [Thread-2  ]: 13 of 15 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m15:00:23.810679 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m15:00:23.810679 [info ] [Thread-1  ]: 14 of 15 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m15:00:23.826785 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m15:00:23.826785 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m15:00:23.826785 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m15:00:23.826785 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m15:00:23.842667 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m15:00:23.842667 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 15:00:23.826785 => 15:00:23.842667
[0m15:00:23.842667 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m15:00:23.842667 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 15:00:23.826785 => 15:00:23.842667
[0m15:00:23.842667 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m15:00:23.858643 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:23.858643 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:24.536611 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m15:00:24.550691 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m15:00:24.550691 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m15:00:24.566459 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m15:00:24.921606 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7436cbfd-5e28-4a26-b840-57525da6acea&page=queryresults
[0m15:00:25.213202 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:af6c92ae-adda-4dc6-a0cf-c0126392b569&page=queryresults
[0m15:00:26.887028 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 15:00:23.858643 => 15:00:26.887028
[0m15:00:26.887028 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDCB31790>]}
[0m15:00:26.887028 [info ] [Thread-1  ]: 14 of 15 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 77.2 KiB processed)[0m in 3.06s]
[0m15:00:26.887028 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m15:00:26.887028 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m15:00:26.887028 [info ] [Thread-1  ]: 15 of 15 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m15:00:26.887028 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_preco_produto)
[0m15:00:26.887028 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m15:00:26.903047 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m15:00:26.903047 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 15:00:26.887028 => 15:00:26.903047
[0m15:00:26.903047 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m15:00:26.903047 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:27.434540 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 15:00:23.842667 => 15:00:27.434540
[0m15:00:27.434540 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDCAC53A0>]}
[0m15:00:27.434540 [info ] [Thread-2  ]: 13 of 15 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 3.62s]
[0m15:00:27.434540 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m15:00:27.725419 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m15:00:27.725419 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m15:00:28.399895 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:354b0f8b-a733-4cb4-bd8c-5634e6ae852e&page=queryresults
[0m15:00:31.534291 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 15:00:26.903047 => 15:00:31.534291
[0m15:00:31.534291 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43d25243-e23a-48ee-b2c3-af9f6c9f613d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDC975B80>]}
[0m15:00:31.534291 [info ] [Thread-1  ]: 15 of 15 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 73.7 KiB processed)[0m in 4.65s]
[0m15:00:31.534291 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m15:00:31.534291 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:00:31.534291 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:00:31.534291 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:00:31.534291 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:00:31.534291 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m15:00:31.534291 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m15:00:31.534291 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m15:00:31.534291 [info ] [MainThread]: 
[0m15:00:31.534291 [info ] [MainThread]: Finished running 9 view models, 6 table models in 0 hours 0 minutes and 25.53 seconds (25.53s).
[0m15:00:31.552175 [debug] [MainThread]: Command end result
[0m15:00:31.576824 [info ] [MainThread]: 
[0m15:00:31.576824 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:00:31.576824 [info ] [MainThread]: 
[0m15:00:31.576824 [info ] [MainThread]: Done. PASS=15 WARN=0 ERROR=0 SKIP=0 TOTAL=15
[0m15:00:31.582153 [debug] [MainThread]: Command `dbt run` succeeded at 15:00:31.582153 after 26.62 seconds
[0m15:00:31.582153 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BD7F734C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDB5110D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018BDB504040>]}
[0m15:00:31.582153 [debug] [MainThread]: Flushing usage events
[0m15:00:35.256850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021ADE743430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021ADD6A39A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021ADD6A3D30>]}


============================== 15:00:35.258011 | 0e193651-6108-48ff-88f9-6328f3b048cf ==============================
[0m15:00:35.258011 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:00:35.258011 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:00:35.750143 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0e193651-6108-48ff-88f9-6328f3b048cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021ADD6AFB20>]}
[0m15:00:35.807242 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0e193651-6108-48ff-88f9-6328f3b048cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021AE1CE1130>]}
[0m15:00:35.809447 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:00:35.809447 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:00:35.870115 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:00:35.870115 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:00:35.879491 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0e193651-6108-48ff-88f9-6328f3b048cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021AE2073520>]}
[0m15:00:35.886352 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0e193651-6108-48ff-88f9-6328f3b048cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021AE1E333D0>]}
[0m15:00:35.886352 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:00:35.886352 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0e193651-6108-48ff-88f9-6328f3b048cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021AE1CD59A0>]}
[0m15:00:35.886352 [info ] [MainThread]: 
[0m15:00:35.902103 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:00:35.902103 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:35.902103 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:36.562031 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:00:36.562031 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m15:00:36.562031 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:36.562031 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:38.393420 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m15:00:38.393420 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:38.926486 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m15:00:38.926486 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:40.028636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0e193651-6108-48ff-88f9-6328f3b048cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021AE1E358B0>]}
[0m15:00:40.028636 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:00:40.028636 [info ] [MainThread]: 
[0m15:00:40.049276 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m15:00:40.049704 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m15:00:40.052697 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m15:00:40.053703 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m15:00:40.067961 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 15:00:40.053703 => 15:00:40.067961
[0m15:00:40.068962 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m15:00:40.131279 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:00:40.131279 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m15:00:40.918239 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8047d798-c07a-4a8a-92a2-4b06816d02a9&page=queryresults
[0m15:00:42.526911 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m15:00:42.913443 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:df53b2f5-cc42-4317-a973-df79ae3d3178&page=queryresults
[0m15:00:45.569179 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m15:00:46.241289 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m15:00:46.241289 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m15:00:46.697313 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:89bc4aad-7d57-44d7-a71d-7a2db380833f&page=queryresults
[0m15:00:49.257516 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 15:00:40.068962 => 15:00:49.257516
[0m15:00:49.257516 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0e193651-6108-48ff-88f9-6328f3b048cf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021AE311A040>]}
[0m15:00:49.257516 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 65.3 KiB processed)[0m in 9.21s]
[0m15:00:49.257516 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m15:00:49.273488 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:00:49.273488 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:00:49.273488 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:00:49.277130 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m15:00:49.277130 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m15:00:49.277130 [info ] [MainThread]: 
[0m15:00:49.277130 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 13.39 seconds (13.39s).
[0m15:00:49.279148 [debug] [MainThread]: Command end result
[0m15:00:49.289305 [info ] [MainThread]: 
[0m15:00:49.289305 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:00:49.289305 [info ] [MainThread]: 
[0m15:00:49.289305 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:00:49.305298 [debug] [MainThread]: Command `dbt snapshot` succeeded at 15:00:49.305298 after 14.15 seconds
[0m15:00:49.305298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021ADE743430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021AE1CD59A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021AE1761520>]}
[0m15:00:49.305298 [debug] [MainThread]: Flushing usage events
[0m15:00:53.732699 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB4C2D34C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB4B250310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB4B250790>]}


============================== 15:00:53.732699 | 97b74be7-9e7b-4e03-9893-3fbc2df018ae ==============================
[0m15:00:53.732699 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:00:53.732699 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select tag:snaps', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:00:54.562326 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '97b74be7-9e7b-4e03-9893-3fbc2df018ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB4B23A130>]}
[0m15:00:54.626325 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '97b74be7-9e7b-4e03-9893-3fbc2df018ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB4F856C40>]}
[0m15:00:54.626325 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:00:54.641355 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:00:54.674375 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:00:54.674375 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:00:54.690577 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '97b74be7-9e7b-4e03-9893-3fbc2df018ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB4FC04700>]}
[0m15:00:54.690577 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '97b74be7-9e7b-4e03-9893-3fbc2df018ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB4FB38400>]}
[0m15:00:54.690577 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:00:54.690577 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '97b74be7-9e7b-4e03-9893-3fbc2df018ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB4F8A4280>]}
[0m15:00:54.690577 [info ] [MainThread]: 
[0m15:00:54.690577 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:00:54.706537 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:54.706537 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:55.364390 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m15:00:55.364390 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:55.364390 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:00:55.364390 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:55.968523 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m15:00:55.968523 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:00:55.968523 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:55.984453 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:56.853606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '97b74be7-9e7b-4e03-9893-3fbc2df018ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB4F995AC0>]}
[0m15:00:56.869738 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:00:56.869738 [info ] [MainThread]: 
[0m15:00:56.869738 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m15:00:56.869738 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m15:00:56.869738 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m15:00:56.869738 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m15:00:56.885704 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m15:00:56.885704 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 15:00:56.869738 => 15:00:56.885704
[0m15:00:56.885704 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m15:00:56.901585 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:00:57.532566 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m15:00:57.532566 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m15:00:57.934162 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:41affe48-5db7-4bae-9e69-8152b735ce4a&page=queryresults
[0m15:00:59.888350 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 15:00:56.885704 => 15:00:59.888350
[0m15:00:59.888350 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '97b74be7-9e7b-4e03-9893-3fbc2df018ae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB50CADA00>]}
[0m15:00:59.888350 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (363.0 rows, 53.3 KiB processed)[0m in 3.02s]
[0m15:00:59.888350 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m15:00:59.888350 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:00:59.888350 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:00:59.888350 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:00:59.888350 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:00:59.888350 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m15:00:59.888350 [info ] [MainThread]: 
[0m15:00:59.888350 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.20 seconds (5.20s).
[0m15:00:59.888350 [debug] [MainThread]: Command end result
[0m15:00:59.904216 [info ] [MainThread]: 
[0m15:00:59.904216 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:00:59.904216 [info ] [MainThread]: 
[0m15:00:59.904216 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:00:59.920416 [debug] [MainThread]: Command `dbt run` succeeded at 15:00:59.904216 after 6.24 seconds
[0m15:00:59.920416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB4C2D34C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB4F968460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FB4FA07D90>]}
[0m15:00:59.920416 [debug] [MainThread]: Flushing usage events
[0m16:00:05.084562 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002100F633460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002100E5BF9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002100E5BFD30>]}


============================== 16:00:05.093199 | cd980393-329c-44d2-b52c-1efefa9dcc62 ==============================
[0m16:00:05.093199 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:00:05.093199 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --exclude tag:snaps', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:00:06.049041 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002100E5A3040>]}
[0m16:00:06.117969 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021012C35100>]}
[0m16:00:06.119868 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:00:06.119868 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:00:06.167184 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:00:06.167184 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:00:06.167184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021012F64730>]}
[0m16:00:06.183249 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021012E98220>]}
[0m16:00:06.183249 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:00:06.183249 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021012E98460>]}
[0m16:00:06.183249 [info ] [MainThread]: 
[0m16:00:06.183249 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:00:06.183249 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:00:06.183249 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:00:06.183249 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:06.183249 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:06.999952 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:07.693992 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m16:00:07.693992 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:00:07.693992 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:07.693992 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:08.384196 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m16:00:08.384196 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:08.384196 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m16:00:08.384196 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:09.151282 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021012E982B0>]}
[0m16:00:09.151282 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:00:09.151282 [info ] [MainThread]: 
[0m16:00:09.167208 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:09.167208 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m16:00:09.167208 [info ] [Thread-1  ]: 1 of 15 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m16:00:09.167208 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m16:00:09.167208 [info ] [Thread-2  ]: 2 of 15 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m16:00:09.167208 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:09.167208 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m16:00:09.183048 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m16:00:09.183048 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m16:00:09.197238 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m16:00:09.198991 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 16:00:09.167208 => 16:00:09.198991
[0m16:00:09.198991 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:09.198991 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 16:00:09.183048 => 16:00:09.198991
[0m16:00:09.203508 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m16:00:09.230750 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m16:00:09.248835 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m16:00:09.248835 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:00:09.248835 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m16:00:09.254114 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m16:00:09.278853 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m16:00:10.323763 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c7a06a6a-54b1-4880-aaa3-c48581989d70&page=queryresults
[0m16:00:10.340834 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6c558923-e7f1-4d47-92c1-90e5f681e45d&page=queryresults
[0m16:00:10.776618 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 16:00:09.198991 => 16:00:10.776618
[0m16:00:10.776618 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021014075DF0>]}
[0m16:00:10.776618 [info ] [Thread-1  ]: 1 of 15 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.61s]
[0m16:00:10.776618 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:10.776618 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m16:00:10.776618 [info ] [Thread-1  ]: 3 of 15 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m16:00:10.776618 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m16:00:10.776618 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m16:00:10.792843 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 16:00:09.203508 => 16:00:10.792843
[0m16:00:10.792843 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m16:00:10.792843 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002101406E2B0>]}
[0m16:00:10.792843 [info ] [Thread-2  ]: 2 of 15 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.63s]
[0m16:00:10.792843 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m16:00:10.792843 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m16:00:10.792843 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 16:00:10.776618 => 16:00:10.792843
[0m16:00:10.792843 [info ] [Thread-2  ]: 4 of 15 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m16:00:10.792843 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m16:00:10.792843 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m16:00:10.792843 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m16:00:10.808647 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m16:00:10.808647 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m16:00:10.808647 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:10.808647 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m16:00:10.808647 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 16:00:10.808647 => 16:00:10.808647
[0m16:00:10.872595 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m16:00:10.872595 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m16:00:10.872595 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:10.872595 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m16:00:11.583338 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c731b10f-61ca-4244-ad21-679ae38001e7&page=queryresults
[0m16:00:11.594773 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:72c8d815-6c88-4c79-8e6a-3033fbae03b1&page=queryresults
[0m16:00:11.998094 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 16:00:10.872595 => 16:00:11.998094
[0m16:00:11.998094 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021013FD7E20>]}
[0m16:00:12.013942 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 16:00:10.792843 => 16:00:12.013942
[0m16:00:11.998094 [info ] [Thread-2  ]: 4 of 15 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m16:00:12.013942 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210140E5670>]}
[0m16:00:12.013942 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m16:00:12.013942 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m16:00:12.013942 [info ] [Thread-1  ]: 3 of 15 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m16:00:12.013942 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m16:00:12.013942 [info ] [Thread-2  ]: 5 of 15 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m16:00:12.013942 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m16:00:12.013942 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m16:00:12.013942 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m16:00:12.013942 [info ] [Thread-1  ]: 6 of 15 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m16:00:12.013942 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_item_pedido)
[0m16:00:12.029902 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m16:00:12.029902 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m16:00:12.029902 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m16:00:12.029902 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 16:00:12.029902 => 16:00:12.029902
[0m16:00:12.029902 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m16:00:12.045663 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m16:00:12.045663 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 16:00:12.013942 => 16:00:12.045663
[0m16:00:12.045663 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m16:00:12.045663 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m16:00:12.045663 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:12.061637 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m16:00:12.101365 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:12.101365 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m16:00:12.833740 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ad16fae1-c440-4bba-ad9d-9868fa8a10b2&page=queryresults
[0m16:00:12.960423 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bd5ce6ed-8013-472a-aa4f-032932d75a6d&page=queryresults
[0m16:00:13.215662 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 16:00:12.045663 => 16:00:13.215662
[0m16:00:13.215662 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021014013C70>]}
[0m16:00:13.215662 [info ] [Thread-2  ]: 5 of 15 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m16:00:13.215662 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m16:00:13.215662 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m16:00:13.215662 [info ] [Thread-2  ]: 7 of 15 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m16:00:13.215662 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m16:00:13.215662 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m16:00:13.215662 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m16:00:13.215662 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 16:00:13.215662 => 16:00:13.215662
[0m16:00:13.215662 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m16:00:13.215662 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m16:00:13.231435 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:13.231435 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m16:00:13.342988 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 16:00:12.029902 => 16:00:13.328995
[0m16:00:13.342988 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021013FE8A30>]}
[0m16:00:13.342988 [info ] [Thread-1  ]: 6 of 15 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m16:00:13.342988 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m16:00:13.342988 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m16:00:13.342988 [info ] [Thread-1  ]: 8 of 15 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m16:00:13.342988 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m16:00:13.342988 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m16:00:13.361119 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m16:00:13.363133 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 16:00:13.342988 => 16:00:13.363133
[0m16:00:13.365146 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m16:00:13.374970 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m16:00:13.374970 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:13.390671 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_pedido
        ,nullif(trim(total), '')                     as vl_total_item
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m16:00:13.949210 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1522e1da-b2f6-4d70-b406-26a54fc49831&page=queryresults
[0m16:00:14.162774 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e5b02d90-9ca0-496e-9141-f16c633e0abe&page=queryresults
[0m16:00:14.345215 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 16:00:13.215662 => 16:00:14.345215
[0m16:00:14.347230 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002101409D280>]}
[0m16:00:14.347230 [info ] [Thread-2  ]: 7 of 15 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m16:00:14.349246 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m16:00:14.351047 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m16:00:14.351047 [info ] [Thread-2  ]: 9 of 15 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m16:00:14.351047 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m16:00:14.351047 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m16:00:14.351047 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m16:00:14.351047 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 16:00:14.351047 => 16:00:14.351047
[0m16:00:14.351047 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m16:00:14.369040 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m16:00:14.369040 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:14.369040 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m16:00:14.637708 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 16:00:13.365146 => 16:00:14.637708
[0m16:00:14.637708 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210140DF040>]}
[0m16:00:14.637708 [info ] [Thread-1  ]: 8 of 15 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m16:00:14.653798 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m16:00:14.653798 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m16:00:14.653798 [info ] [Thread-1  ]: 10 of 15 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m16:00:14.653798 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.tb_pedido)
[0m16:00:14.653798 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m16:00:14.653798 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m16:00:14.653798 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 16:00:14.653798 => 16:00:14.653798
[0m16:00:14.653798 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m16:00:14.669921 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:15.103905 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d898a331-e08a-4fa8-b48d-75302ed6f21f&page=queryresults
[0m16:00:15.348983 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m16:00:15.348983 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,round((a.qt_item * vl_item), 2)                                                        as vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                         as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

select *
    from cte_pedido_total
    );
  
[0m16:00:15.494216 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 16:00:14.367021 => 16:00:15.494216
[0m16:00:15.505773 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021012F90880>]}
[0m16:00:15.505773 [info ] [Thread-2  ]: 9 of 15 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m16:00:15.505773 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m16:00:15.505773 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m16:00:15.505773 [info ] [Thread-2  ]: 11 of 15 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m16:00:15.505773 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m16:00:15.505773 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m16:00:15.505773 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m16:00:15.505773 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 16:00:15.505773 => 16:00:15.505773
[0m16:00:15.505773 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m16:00:15.521588 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:16.005581 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:daba7c77-542e-47e7-b76d-98ffb5aff5b7&page=queryresults
[0m16:00:16.234372 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m16:00:16.234372 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m16:00:16.843818 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3ff6afa0-a134-4f45-8f53-a62b4250d499&page=queryresults
[0m16:00:18.531788 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 16:00:14.653798 => 16:00:18.531788
[0m16:00:18.531788 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210141108B0>]}
[0m16:00:18.531788 [info ] [Thread-1  ]: 10 of 15 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 3.88s]
[0m16:00:18.531788 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m16:00:19.721670 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 16:00:15.505773 => 16:00:19.721670
[0m16:00:19.721670 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210140C94C0>]}
[0m16:00:19.721670 [info ] [Thread-2  ]: 11 of 15 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 4.22s]
[0m16:00:19.730782 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m16:00:19.730782 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m16:00:19.730782 [info ] [Thread-1  ]: 12 of 15 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m16:00:19.730782 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_produto)
[0m16:00:19.730782 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m16:00:19.746618 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m16:00:19.746618 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 16:00:19.730782 => 16:00:19.746618
[0m16:00:19.746618 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m16:00:19.746618 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:20.377195 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m16:00:20.379208 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m16:00:20.962678 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5f113521-2f07-4793-934c-cfc4ec2495dc&page=queryresults
[0m16:00:23.754191 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 16:00:19.746618 => 16:00:23.754191
[0m16:00:23.756207 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210141194C0>]}
[0m16:00:23.757720 [info ] [Thread-1  ]: 12 of 15 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 4.03s]
[0m16:00:23.759734 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m16:00:23.759734 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m16:00:23.761747 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m16:00:23.761747 [info ] [Thread-2  ]: 13 of 15 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m16:00:23.763760 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m16:00:23.763760 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m16:00:23.769796 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m16:00:23.771808 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 16:00:23.763760 => 16:00:23.771808
[0m16:00:23.771808 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m16:00:23.776499 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:23.761747 [info ] [Thread-1  ]: 14 of 15 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m16:00:23.776499 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m16:00:23.776499 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m16:00:23.776499 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m16:00:23.820684 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 16:00:23.776499 => 16:00:23.820684
[0m16:00:23.820684 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m16:00:23.827467 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:24.470912 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m16:00:24.472922 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m16:00:24.500419 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m16:00:24.500419 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m16:00:24.879421 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:44ede130-5fae-423f-a790-61d1d63a7435&page=queryresults
[0m16:00:25.057648 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b1504279-c2c1-44d9-afb9-38bb4229b885&page=queryresults
[0m16:00:26.838697 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 16:00:23.820684 => 16:00:26.838697
[0m16:00:26.840711 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002101413A520>]}
[0m16:00:26.840711 [info ] [Thread-1  ]: 14 of 15 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 77.2 KiB processed)[0m in 3.06s]
[0m16:00:26.842725 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m16:00:26.842725 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m16:00:26.844738 [info ] [Thread-1  ]: 15 of 15 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m16:00:26.844738 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_preco_produto)
[0m16:00:26.846752 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m16:00:26.852287 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m16:00:26.852287 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 16:00:26.846752 => 16:00:26.852287
[0m16:00:26.852287 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m16:00:26.859492 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:27.357806 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 16:00:23.773558 => 16:00:27.357806
[0m16:00:27.369261 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021014032BE0>]}
[0m16:00:27.369261 [info ] [Thread-2  ]: 13 of 15 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 3.61s]
[0m16:00:27.371281 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m16:00:27.792870 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m16:00:27.795753 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m16:00:28.458664 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2dced094-ecd1-4899-97d6-939420f09ace&page=queryresults
[0m16:00:31.224458 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 16:00:26.852287 => 16:00:31.224458
[0m16:00:31.224458 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd980393-329c-44d2-b52c-1efefa9dcc62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021014034FD0>]}
[0m16:00:31.224458 [info ] [Thread-1  ]: 15 of 15 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (306.0 rows, 73.7 KiB processed)[0m in 4.38s]
[0m16:00:31.224458 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m16:00:31.224458 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:00:31.224458 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:00:31.224458 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:00:31.224458 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m16:00:31.224458 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:00:31.224458 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m16:00:31.224458 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m16:00:31.224458 [info ] [MainThread]: 
[0m16:00:31.224458 [info ] [MainThread]: Finished running 9 view models, 6 table models in 0 hours 0 minutes and 25.04 seconds (25.04s).
[0m16:00:31.240349 [debug] [MainThread]: Command end result
[0m16:00:31.256378 [info ] [MainThread]: 
[0m16:00:31.256378 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:00:31.256378 [info ] [MainThread]: 
[0m16:00:31.256378 [info ] [MainThread]: Done. PASS=15 WARN=0 ERROR=0 SKIP=0 TOTAL=15
[0m16:00:31.256378 [debug] [MainThread]: Command `dbt run` succeeded at 16:00:31.256378 after 26.23 seconds
[0m16:00:31.256378 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002100F633460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021014031220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021012BF3EB0>]}
[0m16:00:31.256378 [debug] [MainThread]: Flushing usage events
[0m16:00:36.411242 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BCCA603400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BCC9588910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BCC9588B80>]}


============================== 16:00:36.411242 | 92994db3-cdf1-4bda-94a4-f31c7708f759 ==============================
[0m16:00:36.411242 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:00:36.411242 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt snapshot', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:00:37.427675 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '92994db3-cdf1-4bda-94a4-f31c7708f759', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BCC9588820>]}
[0m16:00:37.539806 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '92994db3-cdf1-4bda-94a4-f31c7708f759', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BCCDC5E0D0>]}
[0m16:00:37.539806 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:00:37.555861 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:00:37.667516 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:00:37.667516 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:00:37.683465 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '92994db3-cdf1-4bda-94a4-f31c7708f759', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BCCDF36310>]}
[0m16:00:37.702172 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '92994db3-cdf1-4bda-94a4-f31c7708f759', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BCCDCD5910>]}
[0m16:00:37.702172 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:00:37.702172 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '92994db3-cdf1-4bda-94a4-f31c7708f759', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BCCDE62310>]}
[0m16:00:37.702172 [info ] [MainThread]: 
[0m16:00:37.702172 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:00:37.702172 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:00:37.702172 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:38.455062 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m16:00:38.455062 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:00:38.455062 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:38.455062 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:40.804361 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m16:00:40.804361 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:41.318913 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m16:00:41.318913 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:42.218615 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '92994db3-cdf1-4bda-94a4-f31c7708f759', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BCCDCD5550>]}
[0m16:00:42.218615 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:00:42.218615 [info ] [MainThread]: 
[0m16:00:42.218615 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m16:00:42.218615 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m16:00:42.234578 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m16:00:42.234578 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m16:00:42.252731 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 16:00:42.234578 => 16:00:42.252731
[0m16:00:42.252731 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m16:00:42.298575 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:00:42.298575 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m16:00:43.633198 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4774d3b4-b54a-4309-9d1d-59729caf3078&page=queryresults
[0m16:00:44.840679 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m16:00:45.238982 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cb315f50-1492-43d2-8213-3d4a386304f9&page=queryresults
[0m16:00:47.916080 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m16:00:48.638687 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m16:00:48.638687 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m16:00:49.107015 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b1e99983-fc3a-42b2-984a-203ec0838989&page=queryresults
[0m16:00:51.665229 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 16:00:42.252731 => 16:00:51.665229
[0m16:00:51.667244 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '92994db3-cdf1-4bda-94a4-f31c7708f759', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BCCDFB2790>]}
[0m16:00:51.667244 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 65.3 KiB processed)[0m in 9.43s]
[0m16:00:51.669257 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m16:00:51.671271 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:00:51.673284 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:00:51.673284 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m16:00:51.675297 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:00:51.675297 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m16:00:51.675297 [info ] [MainThread]: 
[0m16:00:51.675297 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 13.97 seconds (13.97s).
[0m16:00:51.677309 [debug] [MainThread]: Command end result
[0m16:00:51.689112 [info ] [MainThread]: 
[0m16:00:51.692589 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:00:51.692589 [info ] [MainThread]: 
[0m16:00:51.692589 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:00:51.692589 [debug] [MainThread]: Command `dbt snapshot` succeeded at 16:00:51.692589 after 15.36 seconds
[0m16:00:51.692589 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BCCA603400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BCCDD26760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002BCCDB75C40>]}
[0m16:00:51.692589 [debug] [MainThread]: Flushing usage events
[0m16:00:56.000271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F775F23D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F7657F2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F7657F760>]}


============================== 16:00:56.000271 | ffcbfef4-8259-4931-b4d9-2f19b7ff08f1 ==============================
[0m16:00:56.000271 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:00:56.000271 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select tag:snaps', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:00:56.773606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ffcbfef4-8259-4931-b4d9-2f19b7ff08f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F7973EBE0>]}
[0m16:00:56.854032 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ffcbfef4-8259-4931-b4d9-2f19b7ff08f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F7AB8D160>]}
[0m16:00:56.870230 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:00:56.870230 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:00:56.950022 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:00:56.950022 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:00:56.950022 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ffcbfef4-8259-4931-b4d9-2f19b7ff08f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F7AF24760>]}
[0m16:00:56.966225 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ffcbfef4-8259-4931-b4d9-2f19b7ff08f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F7AE5B490>]}
[0m16:00:56.966225 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:00:56.966225 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ffcbfef4-8259-4931-b4d9-2f19b7ff08f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F7ABB2280>]}
[0m16:00:56.976858 [info ] [MainThread]: 
[0m16:00:56.976858 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:00:56.976858 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:00:56.976858 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:57.641316 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:00:57.641316 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m16:00:57.641316 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:57.641316 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:58.237600 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m16:00:58.237600 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:58.283454 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m16:00:58.283454 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:58.862690 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ffcbfef4-8259-4931-b4d9-2f19b7ff08f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F7AF53FD0>]}
[0m16:00:58.862690 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:00:58.862690 [info ] [MainThread]: 
[0m16:00:58.878633 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m16:00:58.878633 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m16:00:58.878633 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m16:00:58.878633 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m16:00:58.894619 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m16:00:58.894619 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 16:00:58.878633 => 16:00:58.894619
[0m16:00:58.894619 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m16:00:58.910594 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:00:59.565637 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m16:00:59.565637 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m16:00:59.935272 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:260a6138-8de4-4fe4-a936-744f7a88976e&page=queryresults
[0m16:01:01.848024 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 16:00:58.894619 => 16:01:01.848024
[0m16:01:01.848024 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffcbfef4-8259-4931-b4d9-2f19b7ff08f1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F7AF952B0>]}
[0m16:01:01.848024 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (363.0 rows, 53.3 KiB processed)[0m in 2.97s]
[0m16:01:01.848024 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m16:01:01.848024 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:01:01.848024 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:01:01.848024 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m16:01:01.848024 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:01:01.848024 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m16:01:01.848024 [info ] [MainThread]: 
[0m16:01:01.848024 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.87 seconds (4.87s).
[0m16:01:01.864233 [debug] [MainThread]: Command end result
[0m16:01:01.864233 [info ] [MainThread]: 
[0m16:01:01.864233 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:01:01.880161 [info ] [MainThread]: 
[0m16:01:01.880161 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:01:01.880161 [debug] [MainThread]: Command `dbt run` succeeded at 16:01:01.880161 after 5.99 seconds
[0m16:01:01.880161 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F775F23D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F7AB8D160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F7AFAFAC0>]}
[0m16:01:01.880161 [debug] [MainThread]: Flushing usage events
[0m17:16:08.754267 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA6CA503D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA6B9F22E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA6B9F2760>]}


============================== 17:16:08.761958 | 601bbf68-fcb1-4118-9ef8-77c0670f21ee ==============================
[0m17:16:08.761958 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:16:08.761958 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_pedido', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m17:16:09.914726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '601bbf68-fcb1-4118-9ef8-77c0670f21ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA6EBC0BE0>]}
[0m17:16:10.014691 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '601bbf68-fcb1-4118-9ef8-77c0670f21ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA700D67C0>]}
[0m17:16:10.022136 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:16:10.024341 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:16:10.204410 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:16:10.204410 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_pedido.sql
[0m17:16:10.354365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '601bbf68-fcb1-4118-9ef8-77c0670f21ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA704EAD90>]}
[0m17:16:10.369613 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '601bbf68-fcb1-4118-9ef8-77c0670f21ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA702DE280>]}
[0m17:16:10.369613 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:16:10.370768 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '601bbf68-fcb1-4118-9ef8-77c0670f21ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA702DE370>]}
[0m17:16:10.370768 [info ] [MainThread]: 
[0m17:16:10.370768 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:16:10.374295 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:16:10.374295 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:16:11.284335 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m17:16:11.286801 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:16:11.286801 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:16:11.286801 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:16:11.954443 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m17:16:11.954443 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:16:12.001329 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m17:16:12.001329 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:16:12.643943 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '601bbf68-fcb1-4118-9ef8-77c0670f21ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA7013AC40>]}
[0m17:16:12.643943 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:16:12.643943 [info ] [MainThread]: 
[0m17:16:12.667287 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m17:16:12.667287 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_pedido ............................... [RUN]
[0m17:16:12.676477 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_pedido'
[0m17:16:12.676477 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m17:16:12.716490 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m17:16:12.724664 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 17:16:12.676477 => 17:16:12.724664
[0m17:16:12.726785 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m17:16:12.775856 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:16:13.631112 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m17:16:13.639015 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((a.qt_item * a.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                         as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

select *
    from cte_pedido_total
    );
  
[0m17:16:14.559814 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:43b5e231-f83d-4cd0-96af-67ff32015b06&page=queryresults
[0m17:16:15.076095 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Name qt_item not found inside a at [59:20]')
[0m17:16:15.800568 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:aaf4d5b1-400d-4095-bae8-5417997d5080&page=queryresults
[0m17:16:16.182665 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:aaf4d5b1-400d-4095-bae8-5417997d5080&page=queryresults
[0m17:16:16.188897 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 17:16:12.726785 => 17:16:16.188897
[0m17:16:16.230837 [debug] [Thread-1  ]: Database Error in model tb_pedido (models\3.az\tb_pedido.sql)
  Name qt_item not found inside a at [59:20]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_pedido.sql
[0m17:16:16.230837 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '601bbf68-fcb1-4118-9ef8-77c0670f21ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA715AC8E0>]}
[0m17:16:16.238333 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_pedido ...................... [[31mERROR[0m in 3.55s]
[0m17:16:16.238333 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m17:16:16.263554 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:16:16.271484 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:16:16.271484 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m17:16:16.271484 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m17:16:16.271484 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_pedido' was properly closed.
[0m17:16:16.271484 [info ] [MainThread]: 
[0m17:16:16.280012 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.90 seconds (5.90s).
[0m17:16:16.280012 [debug] [MainThread]: Command end result
[0m17:16:16.373796 [info ] [MainThread]: 
[0m17:16:16.373796 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m17:16:16.373796 [info ] [MainThread]: 
[0m17:16:16.380564 [error] [MainThread]:   Database Error in model tb_pedido (models\3.az\tb_pedido.sql)
  Name qt_item not found inside a at [59:20]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_pedido.sql
[0m17:16:16.380564 [info ] [MainThread]: 
[0m17:16:16.380564 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m17:16:16.389278 [debug] [MainThread]: Command `dbt run` failed at 17:16:16.389278 after 7.72 seconds
[0m17:16:16.389278 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA6CA503D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA700D67C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA704EAF40>]}
[0m17:16:16.396574 [debug] [MainThread]: Flushing usage events
[0m17:17:27.800447 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026896AFE400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026895A8A640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026895A8AAC0>]}


============================== 17:17:27.804797 | 3b6dfbdd-ea59-4398-96d0-fb6ce85c2fbe ==============================
[0m17:17:27.804797 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:17:27.804797 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_pedido', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:17:28.463608 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3b6dfbdd-ea59-4398-96d0-fb6ce85c2fbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026895A8A850>]}
[0m17:17:28.565494 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3b6dfbdd-ea59-4398-96d0-fb6ce85c2fbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002689A09CD30>]}
[0m17:17:28.567505 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:17:28.578532 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:17:28.681230 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:17:28.681230 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_pedido.sql
[0m17:17:28.827007 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3b6dfbdd-ea59-4398-96d0-fb6ce85c2fbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002689A57CD30>]}
[0m17:17:28.841189 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3b6dfbdd-ea59-4398-96d0-fb6ce85c2fbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002689A36E2E0>]}
[0m17:17:28.841189 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:17:28.841189 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3b6dfbdd-ea59-4398-96d0-fb6ce85c2fbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002689A36E2B0>]}
[0m17:17:28.841189 [info ] [MainThread]: 
[0m17:17:28.844900 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:17:28.844900 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:17:28.844900 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:17:29.544617 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m17:17:29.544617 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:17:29.591392 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:17:29.591392 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:17:30.236795 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m17:17:30.239424 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:17:30.275739 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m17:17:30.278339 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:17:30.915937 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3b6dfbdd-ea59-4398-96d0-fb6ce85c2fbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002689A5B4DC0>]}
[0m17:17:30.918794 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:17:30.918794 [info ] [MainThread]: 
[0m17:17:30.926574 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m17:17:30.926574 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_pedido ............................... [RUN]
[0m17:17:30.928586 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_pedido'
[0m17:17:30.928586 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m17:17:30.942639 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m17:17:30.944853 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 17:17:30.930637 => 17:17:30.944853
[0m17:17:30.944853 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m17:17:30.960404 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:17:31.631578 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m17:17:31.631578 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                         as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

select *
    from cte_pedido_total
    );
  
[0m17:17:32.501715 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9ef89b59-c901-4258-a81b-c60409b0c7b8&page=queryresults
[0m17:17:32.936772 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Name vl_total_item is ambiguous inside a at [87:13]')
[0m17:17:34.507735 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1abccff1-b0de-48a6-a408-88339444e900&page=queryresults
[0m17:17:34.865382 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1abccff1-b0de-48a6-a408-88339444e900&page=queryresults
[0m17:17:34.867586 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 17:17:30.944853 => 17:17:34.867586
[0m17:17:34.876086 [debug] [Thread-1  ]: Database Error in model tb_pedido (models\3.az\tb_pedido.sql)
  Name vl_total_item is ambiguous inside a at [87:13]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_pedido.sql
[0m17:17:34.876086 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b6dfbdd-ea59-4398-96d0-fb6ce85c2fbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002689B6437F0>]}
[0m17:17:34.876086 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_pedido ...................... [[31mERROR[0m in 3.95s]
[0m17:17:34.881595 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m17:17:34.885750 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:17:34.885750 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:17:34.887767 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m17:17:34.889784 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:17:34.891471 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_pedido' was properly closed.
[0m17:17:34.893515 [info ] [MainThread]: 
[0m17:17:34.895524 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.05 seconds (6.05s).
[0m17:17:34.895524 [debug] [MainThread]: Command end result
[0m17:17:34.928240 [info ] [MainThread]: 
[0m17:17:34.930254 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m17:17:34.930254 [info ] [MainThread]: 
[0m17:17:34.931764 [error] [MainThread]:   Database Error in model tb_pedido (models\3.az\tb_pedido.sql)
  Name vl_total_item is ambiguous inside a at [87:13]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_pedido.sql
[0m17:17:34.931764 [info ] [MainThread]: 
[0m17:17:34.933518 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m17:17:34.933518 [debug] [MainThread]: Command `dbt run` failed at 17:17:34.933518 after 7.21 seconds
[0m17:17:34.933518 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026896AFE400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002689A09CD30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002689A57CF10>]}
[0m17:17:34.933518 [debug] [MainThread]: Flushing usage events
[0m17:22:22.801826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5C7B423D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5C6ADC2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5C6ADC760>]}


============================== 17:22:22.807785 | 1bd82981-4406-498b-93ba-662a25db9218 ==============================
[0m17:22:22.807785 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:22:22.808851 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --models tb_pedido', 'send_anonymous_usage_stats': 'True'}
[0m17:22:23.467738 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1bd82981-4406-498b-93ba-662a25db9218', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5CB09DBE0>]}
[0m17:22:23.578874 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1bd82981-4406-498b-93ba-662a25db9218', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5CB293160>]}
[0m17:22:23.578874 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:22:23.601573 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:22:23.717715 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:22:23.717715 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_pedido.sql
[0m17:22:23.882226 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1bd82981-4406-498b-93ba-662a25db9218', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5CB5E97C0>]}
[0m17:22:23.900934 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1bd82981-4406-498b-93ba-662a25db9218', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5CB4013A0>]}
[0m17:22:23.900934 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:22:23.902131 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1bd82981-4406-498b-93ba-662a25db9218', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5C6AA0400>]}
[0m17:22:23.903144 [info ] [MainThread]: 
[0m17:22:23.904356 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:22:23.905882 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:22:23.905882 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:22:24.867978 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:22:24.870487 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:22:24.873274 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m17:22:24.873274 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:22:25.590203 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m17:22:25.590203 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:22:25.629958 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m17:22:25.632451 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:22:26.285792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1bd82981-4406-498b-93ba-662a25db9218', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5CB340FD0>]}
[0m17:22:26.285792 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:22:26.287942 [info ] [MainThread]: 
[0m17:22:26.289694 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m17:22:26.289694 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_pedido ............................... [RUN]
[0m17:22:26.297356 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_pedido'
[0m17:22:26.297868 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m17:22:26.308488 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m17:22:26.308488 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 17:22:26.297868 => 17:22:26.308488
[0m17:22:26.308488 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m17:22:26.329868 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:22:27.049138 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m17:22:27.049138 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
        --  ,a.vl_total_item                                                            as vl_total_item
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                         as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

select *
    from cte_pedido_total
    );
  
[0m17:22:27.933681 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4e53d60d-613e-491d-9d04-50dfb61ad5d3&page=queryresults
[0m17:22:30.748406 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 17:22:26.313118 => 17:22:30.748406
[0m17:22:30.756627 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1bd82981-4406-498b-93ba-662a25db9218', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5CB6A3490>]}
[0m17:22:30.758501 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_pedido .......................... [[32mCREATE TABLE (2.6k rows, 1.0 MiB processed)[0m in 4.45s]
[0m17:22:30.758501 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m17:22:30.764925 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:22:30.764925 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:22:30.773116 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:22:30.773116 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m17:22:30.773116 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_pedido' was properly closed.
[0m17:22:30.773116 [info ] [MainThread]: 
[0m17:22:30.781275 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.87 seconds (6.87s).
[0m17:22:30.789811 [debug] [MainThread]: Command end result
[0m17:22:30.875910 [info ] [MainThread]: 
[0m17:22:30.875910 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:22:30.881884 [info ] [MainThread]: 
[0m17:22:30.881884 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:22:30.889728 [debug] [MainThread]: Command `dbt run` succeeded at 17:22:30.881884 after 8.16 seconds
[0m17:22:30.891458 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5C7B423D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5CB4013A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E5CB4B16A0>]}
[0m17:22:30.891458 [debug] [MainThread]: Flushing usage events
[0m17:36:04.305665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C551856430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5507D8640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5507D8AC0>]}


============================== 17:36:04.305665 | 5f69052a-c9a4-42c6-b225-b69628bbc82d ==============================
[0m17:36:04.305665 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:36:04.315785 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_pedido', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:36:04.926150 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5f69052a-c9a4-42c6-b225-b69628bbc82d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5507BC910>]}
[0m17:36:05.006377 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5f69052a-c9a4-42c6-b225-b69628bbc82d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C554E5A670>]}
[0m17:36:05.022483 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:36:05.022483 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:36:05.122777 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:36:05.122777 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_pedido.sql
[0m17:36:05.273942 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5f69052a-c9a4-42c6-b225-b69628bbc82d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5552CAAC0>]}
[0m17:36:05.286658 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5f69052a-c9a4-42c6-b225-b69628bbc82d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5550BD0A0>]}
[0m17:36:05.286658 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:36:05.288752 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5f69052a-c9a4-42c6-b225-b69628bbc82d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C55519DCD0>]}
[0m17:36:05.289864 [info ] [MainThread]: 
[0m17:36:05.289864 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:36:05.289864 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:36:05.293373 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:36:06.126925 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m17:36:06.126925 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:36:06.126925 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:36:06.126925 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:36:06.816853 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m17:36:06.818871 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:36:06.857799 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m17:36:06.857799 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:36:07.570393 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5f69052a-c9a4-42c6-b225-b69628bbc82d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5552CACD0>]}
[0m17:36:07.572406 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:36:07.572406 [info ] [MainThread]: 
[0m17:36:07.574978 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m17:36:07.574978 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_pedido ............................... [RUN]
[0m17:36:07.584800 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_pedido'
[0m17:36:07.584800 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m17:36:07.597419 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m17:36:07.600372 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 17:36:07.586494 => 17:36:07.600372
[0m17:36:07.600372 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m17:36:07.615270 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:36:08.305871 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m17:36:08.307879 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                         as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

select *
    from cte_pedido_total
    );
  
[0m17:36:09.092907 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d0f97d6c-1ef4-4faa-a500-11a7ec8f5236&page=queryresults
[0m17:36:11.677829 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 17:36:07.602609 => 17:36:11.677829
[0m17:36:11.679838 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5f69052a-c9a4-42c6-b225-b69628bbc82d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C555380850>]}
[0m17:36:11.679838 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_pedido .......................... [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 4.10s]
[0m17:36:11.681846 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m17:36:11.684770 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:36:11.684770 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:36:11.684770 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m17:36:11.684770 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m17:36:11.684770 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_pedido' was properly closed.
[0m17:36:11.684770 [info ] [MainThread]: 
[0m17:36:11.684770 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.39 seconds (6.39s).
[0m17:36:11.684770 [debug] [MainThread]: Command end result
[0m17:36:11.719147 [info ] [MainThread]: 
[0m17:36:11.719147 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:36:11.722027 [info ] [MainThread]: 
[0m17:36:11.722027 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:36:11.722027 [debug] [MainThread]: Command `dbt run` succeeded at 17:36:11.722027 after 7.48 seconds
[0m17:36:11.722027 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C551856430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C554F3F910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5551909A0>]}
[0m17:36:11.722027 [debug] [MainThread]: Flushing usage events
[0m17:37:43.779439 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002127F296460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021201D159A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021201D15D30>]}


============================== 17:37:43.779439 | 224adfdb-ba62-438f-a534-c04c0c4cc4d6 ==============================
[0m17:37:43.779439 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:37:43.779439 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_pedido', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:37:44.422785 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '224adfdb-ba62-438f-a534-c04c0c4cc4d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021201D0E250>]}
[0m17:37:44.517263 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '224adfdb-ba62-438f-a534-c04c0c4cc4d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021202936D00>]}
[0m17:37:44.517263 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:37:44.537393 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:37:44.629303 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:37:44.645099 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_pedido.sql
[0m17:37:44.789777 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '224adfdb-ba62-438f-a534-c04c0c4cc4d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021202E6AF10>]}
[0m17:37:44.802537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '224adfdb-ba62-438f-a534-c04c0c4cc4d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021202B707C0>]}
[0m17:37:44.802537 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:37:44.802537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '224adfdb-ba62-438f-a534-c04c0c4cc4d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021202D3E1F0>]}
[0m17:37:44.802537 [info ] [MainThread]: 
[0m17:37:44.802537 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:37:44.802537 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:37:44.802537 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:37:45.505224 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:37:45.508456 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:37:45.510474 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:37:45.510474 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:37:46.176153 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m17:37:46.176153 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:37:46.224429 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m17:37:46.224429 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:37:46.869312 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '224adfdb-ba62-438f-a534-c04c0c4cc4d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021202E95F40>]}
[0m17:37:46.869312 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:37:46.869312 [info ] [MainThread]: 
[0m17:37:46.879320 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m17:37:46.879320 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_pedido ............................... [RUN]
[0m17:37:46.886680 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_pedido'
[0m17:37:46.888295 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m17:37:46.900065 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m17:37:46.900065 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 17:37:46.888295 => 17:37:46.900065
[0m17:37:46.900065 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m17:37:46.918359 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:37:47.575212 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m17:37:47.575212 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,vl_total_item_pedido
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                         as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,vl_total_item_pedido
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

select *
    from cte_pedido_total
    );
  
[0m17:37:48.261966 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4510e64c-43ae-49c9-ae6c-69ab76167f0c&page=queryresults
[0m17:37:50.758546 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 17:37:46.900065 => 17:37:50.758546
[0m17:37:50.758546 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '224adfdb-ba62-438f-a534-c04c0c4cc4d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021202F1EEE0>]}
[0m17:37:50.758546 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_pedido .......................... [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 3.88s]
[0m17:37:50.762515 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m17:37:50.762515 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:37:50.762515 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:37:50.762515 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m17:37:50.762515 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:37:50.762515 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_pedido' was properly closed.
[0m17:37:50.762515 [info ] [MainThread]: 
[0m17:37:50.762515 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.96 seconds (5.96s).
[0m17:37:50.771142 [debug] [MainThread]: Command end result
[0m17:37:50.797682 [info ] [MainThread]: 
[0m17:37:50.800384 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:37:50.800384 [info ] [MainThread]: 
[0m17:37:50.800384 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:37:50.800384 [debug] [MainThread]: Command `dbt run` succeeded at 17:37:50.800384 after 7.09 seconds
[0m17:37:50.800384 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002127F296460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021202D3E1F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021202D31E80>]}
[0m17:37:50.800384 [debug] [MainThread]: Flushing usage events
[0m17:41:33.121161 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138D9EF2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138D8E8C2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138D8E8C760>]}


============================== 17:41:33.121161 | 70c798c2-5582-44dd-a7c4-6d6ae7fb56ab ==============================
[0m17:41:33.121161 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:41:33.121161 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models stg_item_pedido+', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:41:33.753321 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '70c798c2-5582-44dd-a7c4-6d6ae7fb56ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138D8E7C130>]}
[0m17:41:33.848657 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '70c798c2-5582-44dd-a7c4-6d6ae7fb56ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138DD580910>]}
[0m17:41:33.848657 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:41:33.864386 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:41:33.970613 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:41:33.970613 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_pedido.sql
[0m17:41:34.113063 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '70c798c2-5582-44dd-a7c4-6d6ae7fb56ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138DD98ADF0>]}
[0m17:41:34.129633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '70c798c2-5582-44dd-a7c4-6d6ae7fb56ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138DD77B1F0>]}
[0m17:41:34.129633 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:41:34.129633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '70c798c2-5582-44dd-a7c4-6d6ae7fb56ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138DD4D20A0>]}
[0m17:41:34.129633 [info ] [MainThread]: 
[0m17:41:34.129633 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:41:34.145630 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:41:34.145630 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:41:34.171540 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:41:34.171540 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:41:35.357853 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:41:35.367358 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:41:35.368170 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m17:41:35.372037 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:41:36.022599 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m17:41:36.022599 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:41:36.065192 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m17:41:36.065192 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:41:36.713994 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '70c798c2-5582-44dd-a7c4-6d6ae7fb56ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138DD9DC040>]}
[0m17:41:36.716309 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:41:36.716309 [info ] [MainThread]: 
[0m17:41:36.720332 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m17:41:36.723374 [info ] [Thread-1  ]: 1 of 2 START sql view model dbt_dw_stg.stg_item_pedido ......................... [RUN]
[0m17:41:36.728443 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_item_pedido'
[0m17:41:36.728443 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m17:41:36.741378 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m17:41:36.743387 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 17:41:36.728443 => 17:41:36.743387
[0m17:41:36.743387 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m17:41:36.774241 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m17:41:36.774241 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:41:36.774241 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m17:41:37.587821 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9e8bddb3-dcdc-4c7d-b14b-c4a2be3cc7b8&page=queryresults
[0m17:41:38.108308 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 17:41:36.743387 => 17:41:38.108308
[0m17:41:38.108308 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '70c798c2-5582-44dd-a7c4-6d6ae7fb56ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138DD77B3A0>]}
[0m17:41:38.110314 [info ] [Thread-1  ]: 1 of 2 OK created sql view model dbt_dw_stg.stg_item_pedido .................... [[32mCREATE VIEW (0 processed)[0m in 1.38s]
[0m17:41:38.110314 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m17:41:38.110314 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m17:41:38.113098 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_pedido ............................... [RUN]
[0m17:41:38.114209 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_pedido'
[0m17:41:38.114209 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m17:41:38.121652 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m17:41:38.123685 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 17:41:38.114209 => 17:41:38.121652
[0m17:41:38.123685 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m17:41:38.144130 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:41:38.826554 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m17:41:38.826554 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,vl_total_item_pedido
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                         as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,vl_total_item_pedido
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

select *
    from cte_pedido_total
    );
  
[0m17:41:39.551397 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4f948e9f-d889-4b51-9dcd-9ac12942b785&page=queryresults
[0m17:41:42.137841 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 17:41:38.125275 => 17:41:42.137841
[0m17:41:42.137841 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '70c798c2-5582-44dd-a7c4-6d6ae7fb56ab', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138DD9C99D0>]}
[0m17:41:42.143014 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_pedido .......................... [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 4.02s]
[0m17:41:42.143014 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m17:41:42.143014 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:41:42.150937 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:41:42.150937 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:41:42.150937 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:41:42.150937 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m17:41:42.150937 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_item_pedido' was properly closed.
[0m17:41:42.150937 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_pedido' was properly closed.
[0m17:41:42.150937 [info ] [MainThread]: 
[0m17:41:42.150937 [info ] [MainThread]: Finished running 1 view model, 1 table model in 0 hours 0 minutes and 8.02 seconds (8.02s).
[0m17:41:42.159456 [debug] [MainThread]: Command end result
[0m17:41:42.177371 [info ] [MainThread]: 
[0m17:41:42.185100 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:41:42.186362 [info ] [MainThread]: 
[0m17:41:42.186362 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m17:41:42.191747 [debug] [MainThread]: Command `dbt run` succeeded at 17:41:42.191747 after 9.14 seconds
[0m17:41:42.191747 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138D9EF2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138DDA32100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138DD85F070>]}
[0m17:41:42.194512 [debug] [MainThread]: Flushing usage events
[0m17:47:41.883966 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C69FF56460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C69EECC9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C69EECCD30>]}


============================== 17:47:41.888211 | a5b8c644-8443-4d3d-843e-f2dcb08bd71e ==============================
[0m17:47:41.888211 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:47:41.890093 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models stg_pedido+', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:47:42.509984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a5b8c644-8443-4d3d-843e-f2dcb08bd71e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C69EECCD90>]}
[0m17:47:42.591807 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a5b8c644-8443-4d3d-843e-f2dcb08bd71e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6A34F3130>]}
[0m17:47:42.605858 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:47:42.615063 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:47:42.719103 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:47:42.719103 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_pedido.sql
[0m17:47:42.861755 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a5b8c644-8443-4d3d-843e-f2dcb08bd71e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6A3A0EB80>]}
[0m17:47:42.879501 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a5b8c644-8443-4d3d-843e-f2dcb08bd71e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6A37BD0D0>]}
[0m17:47:42.879501 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:47:42.879501 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a5b8c644-8443-4d3d-843e-f2dcb08bd71e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6A37BD130>]}
[0m17:47:42.879501 [info ] [MainThread]: 
[0m17:47:42.879501 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:47:42.879501 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:47:42.879501 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:47:42.879501 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:47:42.879501 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:47:44.107218 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m17:47:44.109226 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:47:44.109226 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:47:44.111235 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:47:44.764033 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m17:47:44.764033 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:47:44.815607 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m17:47:44.815607 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:47:45.463200 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a5b8c644-8443-4d3d-843e-f2dcb08bd71e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6A361C9A0>]}
[0m17:47:45.463200 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:47:45.463200 [info ] [MainThread]: 
[0m17:47:45.474969 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m17:47:45.476365 [info ] [Thread-1  ]: 1 of 2 START sql view model dbt_dw_stg.stg_pedido .............................. [RUN]
[0m17:47:45.482046 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_pedido'
[0m17:47:45.482046 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m17:47:45.492520 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m17:47:45.497312 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 17:47:45.482046 => 17:47:45.496711
[0m17:47:45.497312 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m17:47:45.530445 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m17:47:45.530445 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:47:45.530445 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m17:47:46.346119 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:22b3a53a-651e-4f80-965e-57522429efc0&page=queryresults
[0m17:47:46.896121 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 17:47:45.497312 => 17:47:46.894108
[0m17:47:46.896121 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a5b8c644-8443-4d3d-843e-f2dcb08bd71e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6A4ACF400>]}
[0m17:47:46.898133 [info ] [Thread-1  ]: 1 of 2 OK created sql view model dbt_dw_stg.stg_pedido ......................... [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m17:47:46.898133 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m17:47:46.898133 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m17:47:46.898133 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_pedido ............................... [RUN]
[0m17:47:46.898133 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_pedido'
[0m17:47:46.904356 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m17:47:46.908372 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m17:47:46.912128 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 17:47:46.904356 => 17:47:46.912128
[0m17:47:46.913605 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m17:47:46.929324 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:47:47.716167 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m17:47:47.720234 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,vl_total_item_pedido
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                         as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,vl_total_item_pedido
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

select *
    from cte_pedido_total
    );
  
[0m17:47:48.469365 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:29fe8b2f-4025-4e5d-ab3f-e0c8be1fbf06&page=queryresults
[0m17:47:50.724507 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 17:47:46.913605 => 17:47:50.711183
[0m17:47:50.724507 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a5b8c644-8443-4d3d-843e-f2dcb08bd71e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6A3A689D0>]}
[0m17:47:50.724507 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_pedido .......................... [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 3.83s]
[0m17:47:50.724507 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m17:47:50.730508 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:47:50.733654 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:47:50.733654 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:47:50.733654 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m17:47:50.733654 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:47:50.735666 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_pedido' was properly closed.
[0m17:47:50.735666 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_pedido' was properly closed.
[0m17:47:50.735666 [info ] [MainThread]: 
[0m17:47:50.735666 [info ] [MainThread]: Finished running 1 view model, 1 table model in 0 hours 0 minutes and 7.86 seconds (7.86s).
[0m17:47:50.740188 [debug] [MainThread]: Command end result
[0m17:47:50.766092 [info ] [MainThread]: 
[0m17:47:50.768110 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:47:50.768110 [info ] [MainThread]: 
[0m17:47:50.772671 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m17:47:50.777421 [debug] [MainThread]: Command `dbt run` succeeded at 17:47:50.776705 after 8.96 seconds
[0m17:47:50.777421 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C69FF56460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6A3649FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C6A389DDC0>]}
[0m17:47:50.780467 [debug] [MainThread]: Flushing usage events
[0m17:58:11.674358 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228B6C22400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228B5BB8640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228B5BB8AC0>]}


============================== 17:58:11.674358 | 6d87d86e-e5eb-44e5-9cdf-2ccf90e9f0cb ==============================
[0m17:58:11.674358 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:58:11.674358 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --models tb_pedido', 'send_anonymous_usage_stats': 'True'}
[0m17:58:12.274928 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6d87d86e-e5eb-44e5-9cdf-2ccf90e9f0cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228B8D80B20>]}
[0m17:58:12.354003 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6d87d86e-e5eb-44e5-9cdf-2ccf90e9f0cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228BA2A39D0>]}
[0m17:58:12.369796 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:58:12.376640 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:58:12.473682 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:58:12.473682 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_pedido.sql
[0m17:58:12.630433 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6d87d86e-e5eb-44e5-9cdf-2ccf90e9f0cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228BA6A9EE0>]}
[0m17:58:12.646857 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6d87d86e-e5eb-44e5-9cdf-2ccf90e9f0cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228BA4A74C0>]}
[0m17:58:12.646857 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:58:12.646857 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6d87d86e-e5eb-44e5-9cdf-2ccf90e9f0cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228BA4A7550>]}
[0m17:58:12.646857 [info ] [MainThread]: 
[0m17:58:12.650001 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:58:12.650001 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:58:12.650001 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:58:13.572799 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m17:58:13.574810 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:58:13.574810 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:58:13.574810 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:58:14.282050 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m17:58:14.289597 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m17:58:14.289597 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:58:14.294447 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:58:15.015154 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6d87d86e-e5eb-44e5-9cdf-2ccf90e9f0cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228B5BB8100>]}
[0m17:58:15.015154 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:58:15.015154 [info ] [MainThread]: 
[0m17:58:15.015154 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m17:58:15.015154 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_pedido ............................... [RUN]
[0m17:58:15.030872 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_pedido'
[0m17:58:15.033769 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m17:58:15.050810 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m17:58:15.050810 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 17:58:15.033769 => 17:58:15.050810
[0m17:58:15.050810 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m17:58:15.067404 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:58:15.845321 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m17:58:15.845321 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,vl_total_item_pedido
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,vl_total_item_pedido
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_total_item_pedido
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m17:58:16.746519 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:834c8de9-db66-4f82-84c6-06790d852a2d&page=queryresults
[0m17:58:19.117101 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 17:58:15.050810 => 17:58:19.117101
[0m17:58:19.117101 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6d87d86e-e5eb-44e5-9cdf-2ccf90e9f0cb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228BA75FC10>]}
[0m17:58:19.117101 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_pedido .......................... [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 4.09s]
[0m17:58:19.117101 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m17:58:19.133058 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:58:19.133058 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:58:19.133058 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:58:19.133058 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m17:58:19.133058 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_pedido' was properly closed.
[0m17:58:19.133058 [info ] [MainThread]: 
[0m17:58:19.133058 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.48 seconds (6.48s).
[0m17:58:19.133058 [debug] [MainThread]: Command end result
[0m17:58:19.166945 [info ] [MainThread]: 
[0m17:58:19.166945 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:58:19.180817 [info ] [MainThread]: 
[0m17:58:19.180817 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:58:19.180817 [debug] [MainThread]: Command `dbt run` succeeded at 17:58:19.180817 after 7.58 seconds
[0m17:58:19.180817 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228B6C22400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228BA2F7400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228BA571DF0>]}
[0m17:58:19.180817 [debug] [MainThread]: Flushing usage events
[0m18:00:24.262235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CDD6F6430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CDC6709D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CDC670B80>]}


============================== 18:00:24.262235 | 493fad7d-51dc-42f5-9ecf-4586c69031fd ==============================
[0m18:00:24.262235 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:00:24.269855 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --models tb_pedido', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m18:00:24.887034 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '493fad7d-51dc-42f5-9ecf-4586c69031fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CDC65C130>]}
[0m18:00:24.983651 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '493fad7d-51dc-42f5-9ecf-4586c69031fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CE0D57070>]}
[0m18:00:24.983651 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:00:25.001679 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:00:25.112213 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:00:25.112213 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_pedido.sql
[0m18:00:25.260540 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '493fad7d-51dc-42f5-9ecf-4586c69031fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CE116AB80>]}
[0m18:00:25.266341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '493fad7d-51dc-42f5-9ecf-4586c69031fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CE0F593A0>]}
[0m18:00:25.266341 [info ] [MainThread]: Found 16 models, 1 snapshot, 10 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:00:25.266341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '493fad7d-51dc-42f5-9ecf-4586c69031fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CE0CC4130>]}
[0m18:00:25.266341 [info ] [MainThread]: 
[0m18:00:25.266341 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:00:25.266341 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:00:25.282516 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:26.082284 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m18:00:26.082284 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:26.082284 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m18:00:26.082284 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:27.822067 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m18:00:27.825353 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:00:27.970657 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m18:00:27.972262 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:00:30.177342 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '493fad7d-51dc-42f5-9ecf-4586c69031fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CE0F59160>]}
[0m18:00:30.177342 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:00:30.177342 [info ] [MainThread]: 
[0m18:00:30.186869 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m18:00:30.191944 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_pedido ............................... [RUN]
[0m18:00:30.196381 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_pedido'
[0m18:00:30.196381 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m18:00:30.218026 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m18:00:30.224008 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 18:00:30.196381 => 18:00:30.221034
[0m18:00:30.226021 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m18:00:30.248177 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:00:30.951674 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m18:00:30.951674 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m18:00:31.710393 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8ea77af6-064d-40a5-abfc-1bbef312908a&page=queryresults
[0m18:00:34.294976 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 18:00:30.226021 => 18:00:34.294976
[0m18:00:34.294976 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '493fad7d-51dc-42f5-9ecf-4586c69031fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CE12209A0>]}
[0m18:00:34.294976 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_pedido .......................... [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 4.10s]
[0m18:00:34.294976 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m18:00:34.302019 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:00:34.302019 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:00:34.302019 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m18:00:34.302019 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m18:00:34.302019 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_pedido' was properly closed.
[0m18:00:34.302019 [info ] [MainThread]: 
[0m18:00:34.302019 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 9.04 seconds (9.04s).
[0m18:00:34.310136 [debug] [MainThread]: Command end result
[0m18:00:34.355378 [info ] [MainThread]: 
[0m18:00:34.355378 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:00:34.355378 [info ] [MainThread]: 
[0m18:00:34.355378 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:00:34.370416 [debug] [MainThread]: Command `dbt run` succeeded at 18:00:34.368401 after 10.18 seconds
[0m18:00:34.370416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CDD6F6430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CE0CC4130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000011CE1031A00>]}
[0m18:00:34.372431 [debug] [MainThread]: Flushing usage events
[0m18:29:15.520723 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002471B116430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002471A0956A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002471A095DC0>]}


============================== 18:29:15.520723 | 09f92082-1abf-46e7-a423-452998364eb6 ==============================
[0m18:29:15.520723 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:29:15.520723 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models stg_tempo', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m18:29:16.069925 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '09f92082-1abf-46e7-a423-452998364eb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002471A087BB0>]}
[0m18:29:16.159766 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '09f92082-1abf-46e7-a423-452998364eb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002471A097F40>]}
[0m18:29:16.159766 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:29:16.164373 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:29:16.270455 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 2 files added, 0 files changed.
[0m18:29:16.270455 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\1.stg\stg_tempo.sql
[0m18:29:16.270455 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\3.az\tb_venda_produto_final.sql
[0m18:29:16.389284 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.shibaribrasil.stg_tempo' (models\1.stg\stg_tempo.sql) depends on a source named 'drive.tempo' which was not found
[0m18:29:16.389284 [debug] [MainThread]: Command `dbt run` failed at 18:29:16.389284 after 0.93 seconds
[0m18:29:16.389284 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002471B116430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002471EAEB6A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002471E976BB0>]}
[0m18:29:16.389284 [debug] [MainThread]: Flushing usage events
[0m18:29:44.491918 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B3E5D16460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B3E4C929A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B3E4C92D30>]}


============================== 18:29:44.491918 | 1ef70c03-936b-4483-9ecb-3731958623cc ==============================
[0m18:29:44.491918 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:29:44.491918 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models stg_tempo', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:29:45.143739 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1ef70c03-936b-4483-9ecb-3731958623cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B3E7E5DB80>]}
[0m18:29:45.240636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1ef70c03-936b-4483-9ecb-3731958623cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B3E9252A00>]}
[0m18:29:45.240636 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:29:45.244464 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:29:45.343116 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 2 files added, 0 files changed.
[0m18:29:45.344710 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\1.stg\stg_tempo.sql
[0m18:29:45.344710 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\3.az\tb_venda_produto_final.sql
[0m18:29:45.476944 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.shibaribrasil.stg_tempo' (models\1.stg\stg_tempo.sql) depends on a source named 'drive.drive_tempo' which was not found
[0m18:29:45.476944 [debug] [MainThread]: Command `dbt run` failed at 18:29:45.476944 after 1.07 seconds
[0m18:29:45.476944 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B3E5D16460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B3E9778E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B3E9587F70>]}
[0m18:29:45.476944 [debug] [MainThread]: Flushing usage events
[0m18:30:10.777131 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E6C6E6460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E6B6659A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E6B665D30>]}


============================== 18:30:10.777131 | 4defdfe9-aa6d-41a1-a1d6-b1546343b813 ==============================
[0m18:30:10.777131 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:30:10.786920 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_tempo', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:30:11.382715 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4defdfe9-aa6d-41a1-a1d6-b1546343b813', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E6B657B20>]}
[0m18:30:11.462855 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4defdfe9-aa6d-41a1-a1d6-b1546343b813', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E6FC3E7F0>]}
[0m18:30:11.462855 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:30:11.478506 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:30:11.575357 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 2 files added, 1 files changed.
[0m18:30:11.577507 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\1.stg\stg_tempo.sql
[0m18:30:11.577507 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\3.az\tb_venda_produto_final.sql
[0m18:30:11.577507 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\source.yml
[0m18:30:11.818179 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4defdfe9-aa6d-41a1-a1d6-b1546343b813', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E702FE8B0>]}
[0m18:30:11.828063 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4defdfe9-aa6d-41a1-a1d6-b1546343b813', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E6FF43250>]}
[0m18:30:11.828063 [info ] [MainThread]: Found 18 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:30:11.828063 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4defdfe9-aa6d-41a1-a1d6-b1546343b813', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E6FFFBB50>]}
[0m18:30:11.828063 [info ] [MainThread]: 
[0m18:30:11.828063 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:30:11.843986 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:30:11.843986 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:30:12.680290 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m18:30:12.680290 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:30:12.680290 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m18:30:12.680290 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:30:13.389164 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m18:30:13.389164 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:30:13.422297 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m18:30:13.434206 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:30:14.103642 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4defdfe9-aa6d-41a1-a1d6-b1546343b813', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E6FCA8070>]}
[0m18:30:14.103642 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:30:14.116292 [info ] [MainThread]: 
[0m18:30:14.120399 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m18:30:14.120399 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_tempo ............................... [RUN]
[0m18:30:14.120399 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_tempo'
[0m18:30:14.120399 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m18:30:14.134762 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m18:30:14.134762 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 18:30:14.120399 => 18:30:14.134762
[0m18:30:14.134762 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m18:30:14.167909 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m18:30:14.167909 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:30:14.167909 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abreviado       as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abreviado              as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fl_dia_util as int64)    as fl_dia_util	
         ,cast(fl_feriado as int64)     as fl_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo`
)

select *
  from cte_drive;


[0m18:30:15.139737 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:893d55b0-c7d4-439c-9635-55ebd82ec7f0&page=queryresults
[0m18:30:15.656566 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: ds_dia_semana_abreviado; Did you mean ds_dia_semana_abrev? at [19:11]')
[0m18:30:16.938534 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:425c1789-9e06-45c3-bee4-f8dec9962943&page=queryresults
[0m18:30:17.370645 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:425c1789-9e06-45c3-bee4-f8dec9962943&page=queryresults
[0m18:30:17.370645 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 18:30:14.134762 => 18:30:17.370645
[0m18:30:17.393507 [debug] [Thread-1  ]: Database Error in model stg_tempo (models\1.stg\stg_tempo.sql)
  Unrecognized name: ds_dia_semana_abreviado; Did you mean ds_dia_semana_abrev? at [19:11]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_tempo.sql
[0m18:30:17.395314 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4defdfe9-aa6d-41a1-a1d6-b1546343b813', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E70350FD0>]}
[0m18:30:17.395314 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_tempo ...................... [[31mERROR[0m in 3.27s]
[0m18:30:17.399210 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m18:30:17.404453 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:30:17.404453 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:30:17.404453 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m18:30:17.404453 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m18:30:17.404453 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_tempo' was properly closed.
[0m18:30:17.404453 [info ] [MainThread]: 
[0m18:30:17.404453 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 5.58 seconds (5.58s).
[0m18:30:17.410316 [debug] [MainThread]: Command end result
[0m18:30:17.425970 [info ] [MainThread]: 
[0m18:30:17.427130 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:30:17.427882 [info ] [MainThread]: 
[0m18:30:17.428535 [error] [MainThread]:   Database Error in model stg_tempo (models\1.stg\stg_tempo.sql)
  Unrecognized name: ds_dia_semana_abreviado; Did you mean ds_dia_semana_abrev? at [19:11]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_tempo.sql
[0m18:30:17.429297 [info ] [MainThread]: 
[0m18:30:17.430089 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:30:17.432277 [debug] [MainThread]: Command `dbt run` failed at 18:30:17.431310 after 6.72 seconds
[0m18:30:17.432926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E6C6E6460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E6FC3E7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E702F9040>]}
[0m18:30:17.435751 [debug] [MainThread]: Flushing usage events
[0m18:30:58.243131 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A9EB66430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A9DAE56A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A9DAE5DC0>]}


============================== 18:30:58.243131 | 98b30a21-6951-4075-8da3-c970d858a45a ==============================
[0m18:30:58.243131 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:30:58.243131 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --models stg_tempo', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:30:58.865236 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '98b30a21-6951-4075-8da3-c970d858a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A9DAD7940>]}
[0m18:30:58.972183 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '98b30a21-6951-4075-8da3-c970d858a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021AA21D1BB0>]}
[0m18:30:58.972183 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:30:58.975999 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:30:59.074580 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:30:59.074580 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_tempo.sql
[0m18:30:59.231212 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '98b30a21-6951-4075-8da3-c970d858a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021AA2641F10>]}
[0m18:30:59.244922 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '98b30a21-6951-4075-8da3-c970d858a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021AA23BB520>]}
[0m18:30:59.246928 [info ] [MainThread]: Found 18 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:30:59.246928 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '98b30a21-6951-4075-8da3-c970d858a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021AA23BB430>]}
[0m18:30:59.246928 [info ] [MainThread]: 
[0m18:30:59.246928 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:30:59.246928 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:30:59.246928 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:30:59.967840 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m18:30:59.967840 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:30:59.967840 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m18:30:59.967840 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:31:00.645579 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m18:31:00.645579 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:31:00.653631 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m18:31:00.653631 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:31:01.358041 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '98b30a21-6951-4075-8da3-c970d858a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021AA2229340>]}
[0m18:31:01.358041 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:31:01.361869 [info ] [MainThread]: 
[0m18:31:01.364349 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m18:31:01.364349 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_tempo ............................... [RUN]
[0m18:31:01.372228 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_tempo'
[0m18:31:01.373714 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m18:31:01.387186 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m18:31:01.387186 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 18:31:01.373714 => 18:31:01.387186
[0m18:31:01.387186 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m18:31:01.419869 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m18:31:01.419869 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:31:01.419869 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fl_dia_util as int64)    as fl_dia_util	
         ,cast(fl_feriado as int64)     as fl_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo`
)

select *
  from cte_drive;


[0m18:31:02.265421 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:00406b3f-4f07-4276-8440-ea6d4c9c7936&page=queryresults
[0m18:31:02.651085 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: fl_dia_util; Did you mean fg_dia_util? at [25:16]')
[0m18:31:03.241458 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:661b646f-68ad-4364-bffb-956449f0ee57&page=queryresults
[0m18:31:03.609364 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:661b646f-68ad-4364-bffb-956449f0ee57&page=queryresults
[0m18:31:03.609364 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 18:31:01.387186 => 18:31:03.609364
[0m18:31:03.609364 [debug] [Thread-1  ]: Database Error in model stg_tempo (models\1.stg\stg_tempo.sql)
  Unrecognized name: fl_dia_util; Did you mean fg_dia_util? at [25:16]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_tempo.sql
[0m18:31:03.609364 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '98b30a21-6951-4075-8da3-c970d858a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021AA36B5190>]}
[0m18:31:03.609364 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_tempo ...................... [[31mERROR[0m in 2.25s]
[0m18:31:03.625195 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m18:31:03.631121 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:31:03.632055 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:31:03.633146 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m18:31:03.634963 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:31:03.634963 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_tempo' was properly closed.
[0m18:31:03.637760 [info ] [MainThread]: 
[0m18:31:03.638489 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.39 seconds (4.39s).
[0m18:31:03.639521 [debug] [MainThread]: Command end result
[0m18:31:03.666615 [info ] [MainThread]: 
[0m18:31:03.666615 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:31:03.668919 [info ] [MainThread]: 
[0m18:31:03.668919 [error] [MainThread]:   Database Error in model stg_tempo (models\1.stg\stg_tempo.sql)
  Unrecognized name: fl_dia_util; Did you mean fg_dia_util? at [25:16]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_tempo.sql
[0m18:31:03.668919 [info ] [MainThread]: 
[0m18:31:03.668919 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:31:03.668919 [debug] [MainThread]: Command `dbt run` failed at 18:31:03.668919 after 5.50 seconds
[0m18:31:03.675147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021A9EB66430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021AA21D1BB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021AA23BB5B0>]}
[0m18:31:03.675147 [debug] [MainThread]: Flushing usage events
[0m18:31:24.551870 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E153913430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E1528B59D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E1528B5B80>]}


============================== 18:31:24.567980 | be75b365-4b16-4a94-a89e-02b1cc20cf73 ==============================
[0m18:31:24.567980 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:31:24.567980 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_tempo', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:31:25.174372 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'be75b365-4b16-4a94-a89e-02b1cc20cf73', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E15289C130>]}
[0m18:31:25.269854 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'be75b365-4b16-4a94-a89e-02b1cc20cf73', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E156FA57C0>]}
[0m18:31:25.269854 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:31:25.285071 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:31:25.392513 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:31:25.392513 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_tempo.sql
[0m18:31:25.536349 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'be75b365-4b16-4a94-a89e-02b1cc20cf73', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E15740FA90>]}
[0m18:31:25.550133 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'be75b365-4b16-4a94-a89e-02b1cc20cf73', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E1572548B0>]}
[0m18:31:25.550133 [info ] [MainThread]: Found 18 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:31:25.550133 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'be75b365-4b16-4a94-a89e-02b1cc20cf73', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E157254880>]}
[0m18:31:25.550133 [info ] [MainThread]: 
[0m18:31:25.550133 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:31:25.550133 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:31:25.550133 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:31:26.302196 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m18:31:26.304205 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m18:31:26.304205 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:31:26.304205 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:31:27.030253 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m18:31:27.030253 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:31:27.030253 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m18:31:27.030253 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:31:27.756121 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'be75b365-4b16-4a94-a89e-02b1cc20cf73', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E15701E370>]}
[0m18:31:27.759004 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:31:27.759004 [info ] [MainThread]: 
[0m18:31:27.759004 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m18:31:27.759004 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_tempo ............................... [RUN]
[0m18:31:27.765855 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_tempo'
[0m18:31:27.765855 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m18:31:27.776296 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m18:31:27.776296 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 18:31:27.767521 => 18:31:27.776296
[0m18:31:27.779399 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m18:31:27.810176 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m18:31:27.810176 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:31:27.810176 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fl_dia_util	
         ,cast(fg_feriado as int64)     as fl_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo`
)

select *
  from cte_drive;


[0m18:31:28.675157 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:340ea437-337c-4622-9046-1e3c39da4d80&page=queryresults
[0m18:31:29.163332 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 18:31:27.779399 => 18:31:29.163332
[0m18:31:29.163332 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'be75b365-4b16-4a94-a89e-02b1cc20cf73', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E157466FA0>]}
[0m18:31:29.165339 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_tempo .......................... [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m18:31:29.165339 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m18:31:29.165339 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:31:29.165339 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:31:29.165339 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:31:29.165339 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m18:31:29.165339 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_tempo' was properly closed.
[0m18:31:29.165339 [info ] [MainThread]: 
[0m18:31:29.171263 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.62 seconds (3.62s).
[0m18:31:29.171263 [debug] [MainThread]: Command end result
[0m18:31:29.196863 [info ] [MainThread]: 
[0m18:31:29.198112 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:31:29.198112 [info ] [MainThread]: 
[0m18:31:29.198112 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:31:29.202038 [debug] [MainThread]: Command `dbt run` succeeded at 18:31:29.198112 after 4.71 seconds
[0m18:31:29.202038 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E153913430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E1571C7EE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E15727D9A0>]}
[0m18:31:29.202038 [debug] [MainThread]: Flushing usage events
[0m18:43:13.351422 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232128134C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232117B83A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232117B8820>]}


============================== 18:43:13.360177 | d48fe51b-3737-4777-8935-fc05f13f7aae ==============================
[0m18:43:13.360177 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:43:13.360177 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_venda_produto_final', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:43:14.013638 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd48fe51b-3737-4777-8935-fc05f13f7aae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002321179AB80>]}
[0m18:43:14.112612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd48fe51b-3737-4777-8935-fc05f13f7aae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023215EA37C0>]}
[0m18:43:14.112612 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:43:14.125115 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:43:14.253644 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m18:43:14.253644 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_tempo.sql
[0m18:43:14.253644 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_venda_produto_final.sql
[0m18:43:14.403767 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd48fe51b-3737-4777-8935-fc05f13f7aae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002321630E250>]}
[0m18:43:14.419147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd48fe51b-3737-4777-8935-fc05f13f7aae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002321608F130>]}
[0m18:43:14.419981 [info ] [MainThread]: Found 18 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:43:14.419981 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd48fe51b-3737-4777-8935-fc05f13f7aae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232160C6700>]}
[0m18:43:14.419981 [info ] [MainThread]: 
[0m18:43:14.419981 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:43:14.419981 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:43:14.419981 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:43:15.819807 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m18:43:15.819807 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:43:15.819807 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m18:43:15.819807 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:43:16.691258 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m18:43:16.691258 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:43:16.731298 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m18:43:16.736847 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:43:17.400986 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd48fe51b-3737-4777-8935-fc05f13f7aae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023215ED54C0>]}
[0m18:43:17.400986 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:43:17.409825 [info ] [MainThread]: 
[0m18:43:17.410334 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m18:43:17.410334 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_venda_produto_final .................. [RUN]
[0m18:43:17.417214 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_venda_produto_final'
[0m18:43:17.417214 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m18:43:17.430304 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m18:43:17.432311 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 18:43:17.417214 => 18:43:17.432311
[0m18:43:17.432311 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m18:43:17.475485 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m18:43:17.475485 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:43:17.475485 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(dt_pedido, month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

select *
    from cte_pedido
    );
  
[0m18:43:18.444920 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:276724b7-447b-4cc5-b6da-06acb095662f&page=queryresults
[0m18:43:19.034626 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('No matching signature for function DATE_TRUNC\n  Argument types: STRING, DATE_TIME_PART\n  Signature: DATE_TRUNC(DATE, DATE_TIME_PART)\n    Argument 1: Unable to coerce type STRING to expected type DATE\n  Signature: DATE_TRUNC(DATETIME, DATE_TIME_PART)\n    Argument 1: Unable to coerce type STRING to expected type DATETIME\n  Signature: DATE_TRUNC(TIMESTAMP, DATE_TIME_PART, [STRING])\n    Argument 1: Unable to coerce type STRING to expected type TIMESTAMP at [43:11]')
[0m18:43:19.519005 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c3b5bb57-3905-4b79-adf3-25d17664fbc8&page=queryresults
[0m18:43:19.903711 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c3b5bb57-3905-4b79-adf3-25d17664fbc8&page=queryresults
[0m18:43:19.903711 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 18:43:17.432311 => 18:43:19.903711
[0m18:43:19.909402 [debug] [Thread-1  ]: Database Error in model tb_venda_produto_final (models\3.az\tb_venda_produto_final.sql)
  No matching signature for function DATE_TRUNC
    Argument types: STRING, DATE_TIME_PART
    Signature: DATE_TRUNC(DATE, DATE_TIME_PART)
      Argument 1: Unable to coerce type STRING to expected type DATE
    Signature: DATE_TRUNC(DATETIME, DATE_TIME_PART)
      Argument 1: Unable to coerce type STRING to expected type DATETIME
    Signature: DATE_TRUNC(TIMESTAMP, DATE_TIME_PART, [STRING])
      Argument 1: Unable to coerce type STRING to expected type TIMESTAMP at [43:11]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_venda_produto_final.sql
[0m18:43:19.909402 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd48fe51b-3737-4777-8935-fc05f13f7aae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002321736BD00>]}
[0m18:43:19.909402 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_venda_produto_final ......... [[31mERROR[0m in 2.50s]
[0m18:43:19.917603 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m18:43:19.919617 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:43:19.921630 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:43:19.921630 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m18:43:19.923642 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:43:19.923642 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_final' was properly closed.
[0m18:43:19.926291 [info ] [MainThread]: 
[0m18:43:19.927901 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.51 seconds (5.51s).
[0m18:43:19.927901 [debug] [MainThread]: Command end result
[0m18:43:19.958985 [info ] [MainThread]: 
[0m18:43:19.958985 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:43:19.958985 [info ] [MainThread]: 
[0m18:43:19.958985 [error] [MainThread]:   Database Error in model tb_venda_produto_final (models\3.az\tb_venda_produto_final.sql)
  No matching signature for function DATE_TRUNC
    Argument types: STRING, DATE_TIME_PART
    Signature: DATE_TRUNC(DATE, DATE_TIME_PART)
      Argument 1: Unable to coerce type STRING to expected type DATE
    Signature: DATE_TRUNC(DATETIME, DATE_TIME_PART)
      Argument 1: Unable to coerce type STRING to expected type DATETIME
    Signature: DATE_TRUNC(TIMESTAMP, DATE_TIME_PART, [STRING])
      Argument 1: Unable to coerce type STRING to expected type TIMESTAMP at [43:11]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_venda_produto_final.sql
[0m18:43:19.966435 [info ] [MainThread]: 
[0m18:43:19.966435 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m18:43:19.969335 [debug] [MainThread]: Command `dbt run` failed at 18:43:19.969335 after 6.68 seconds
[0m18:43:19.969335 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000232128134C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023215EA37C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023215F46AC0>]}
[0m18:43:19.971346 [debug] [MainThread]: Flushing usage events
[0m18:43:40.635519 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023049BD0430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023048B792E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023048B79760>]}


============================== 18:43:40.640889 | 79724e84-9aac-4adb-ac71-5ffdfd5680b8 ==============================
[0m18:43:40.640889 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:43:40.644726 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_venda_produto_final', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m18:43:41.262942 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '79724e84-9aac-4adb-ac71-5ffdfd5680b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023048B5CA60>]}
[0m18:43:41.362249 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '79724e84-9aac-4adb-ac71-5ffdfd5680b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002304D1472B0>]}
[0m18:43:41.363873 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:43:41.370470 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:43:41.477255 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m18:43:41.477255 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_venda_produto_final.sql
[0m18:43:41.618080 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '79724e84-9aac-4adb-ac71-5ffdfd5680b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002304D6D1F10>]}
[0m18:43:41.634326 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '79724e84-9aac-4adb-ac71-5ffdfd5680b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002304D461640>]}
[0m18:43:41.634326 [info ] [MainThread]: Found 18 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:43:41.634326 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '79724e84-9aac-4adb-ac71-5ffdfd5680b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002304D288AC0>]}
[0m18:43:41.634326 [info ] [MainThread]: 
[0m18:43:41.639417 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:43:41.639417 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:43:41.639417 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:43:42.389430 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m18:43:42.393631 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:43:42.393631 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m18:43:42.393631 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:43:43.079159 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m18:43:43.079159 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:43:43.122756 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m18:43:43.122756 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:43:43.811334 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '79724e84-9aac-4adb-ac71-5ffdfd5680b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002304D2A9400>]}
[0m18:43:43.811334 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:43:43.811334 [info ] [MainThread]: 
[0m18:43:43.825029 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m18:43:43.827044 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_venda_produto_final .................. [RUN]
[0m18:43:43.829589 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_venda_produto_final'
[0m18:43:43.829589 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m18:43:43.843367 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m18:43:43.843367 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 18:43:43.829589 => 18:43:43.843367
[0m18:43:43.843367 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m18:43:43.884188 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m18:43:43.884188 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:43:43.884188 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

select *
    from cte_pedido
    );
  
[0m18:43:44.738087 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cb483643-d85e-41fe-aa51-88fca358118c&page=queryresults
[0m18:43:46.804991 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 18:43:43.843367 => 18:43:46.804991
[0m18:43:46.804991 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '79724e84-9aac-4adb-ac71-5ffdfd5680b8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002304E734190>]}
[0m18:43:46.804991 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_venda_produto_final ............. [[32mCREATE TABLE (2.6k rows, 339.0 KiB processed)[0m in 2.98s]
[0m18:43:46.804991 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m18:43:46.809792 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:43:46.809792 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:43:46.809792 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m18:43:46.811799 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m18:43:46.811799 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_final' was properly closed.
[0m18:43:46.811799 [info ] [MainThread]: 
[0m18:43:46.813307 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.17 seconds (5.17s).
[0m18:43:46.813307 [debug] [MainThread]: Command end result
[0m18:43:46.846505 [info ] [MainThread]: 
[0m18:43:46.846505 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:43:46.846505 [info ] [MainThread]: 
[0m18:43:46.846505 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:43:46.846505 [debug] [MainThread]: Command `dbt run` succeeded at 18:43:46.846505 after 6.29 seconds
[0m18:43:46.846505 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023049BD0430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000230478786D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002304D549280>]}
[0m18:43:46.846505 [debug] [MainThread]: Flushing usage events
[0m19:03:47.934315 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEDCB623D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEDBB08310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEDBB08790>]}


============================== 19:03:47.934315 | 68f53865-158c-4b77-ba71-2e5b74966616 ==============================
[0m19:03:47.934315 [info ] [MainThread]: Running with dbt=1.7.4
[0m19:03:47.934315 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models tb_venda_produto_final', 'send_anonymous_usage_stats': 'True'}
[0m19:03:48.605271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '68f53865-158c-4b77-ba71-2e5b74966616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEDBAECA90>]}
[0m19:03:48.713560 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '68f53865-158c-4b77-ba71-2e5b74966616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEE0122250>]}
[0m19:03:48.722019 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m19:03:48.730332 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m19:03:48.840114 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:03:48.842120 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_venda_produto_final.sql
[0m19:03:48.999534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '68f53865-158c-4b77-ba71-2e5b74966616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEE065F790>]}
[0m19:03:49.016064 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '68f53865-158c-4b77-ba71-2e5b74966616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEE03F0040>]}
[0m19:03:49.019053 [info ] [MainThread]: Found 18 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m19:03:49.019053 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '68f53865-158c-4b77-ba71-2e5b74966616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEE03F0100>]}
[0m19:03:49.021064 [info ] [MainThread]: 
[0m19:03:49.021064 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m19:03:49.024128 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:03:49.024128 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:03:49.788322 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m19:03:49.788322 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:03:49.788322 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m19:03:49.788322 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:03:50.466976 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m19:03:50.466976 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:03:50.498185 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m19:03:50.498185 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:03:51.137984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '68f53865-158c-4b77-ba71-2e5b74966616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEE0189E80>]}
[0m19:03:51.141504 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:03:51.143532 [info ] [MainThread]: 
[0m19:03:51.149829 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m19:03:51.149829 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_venda_produto_final .................. [RUN]
[0m19:03:51.151839 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_venda_produto_final'
[0m19:03:51.153848 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m19:03:51.163953 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m19:03:51.163953 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 19:03:51.155858 => 19:03:51.163953
[0m19:03:51.163953 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m19:03:51.180311 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m19:03:51.874100 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m19:03:51.878247 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

select *
  from cte_produto_pedido_base
    );
  
[0m19:03:52.346752 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:39aeb7cf-efc6-42c6-9341-2d1644734285&page=queryresults
[0m19:03:52.748686 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('SELECT list expression references a.cd_produto_bling which is neither grouped nor aggregated at [57:11]')
[0m19:03:53.698750 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:38793127-e7fd-4219-b637-08a8a3525d89&page=queryresults
[0m19:03:54.105225 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:38793127-e7fd-4219-b637-08a8a3525d89&page=queryresults
[0m19:03:54.114311 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 19:03:51.163953 => 19:03:54.114311
[0m19:03:54.135301 [debug] [Thread-1  ]: Database Error in model tb_venda_produto_final (models\3.az\tb_venda_produto_final.sql)
  SELECT list expression references a.cd_produto_bling which is neither grouped nor aggregated at [57:11]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_venda_produto_final.sql
[0m19:03:54.138069 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68f53865-158c-4b77-ba71-2e5b74966616', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEE16C1E80>]}
[0m19:03:54.138069 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_venda_produto_final ......... [[31mERROR[0m in 2.98s]
[0m19:03:54.155534 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m19:03:54.162329 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:03:54.171143 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:03:54.171143 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m19:03:54.179467 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m19:03:54.179467 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_final' was properly closed.
[0m19:03:54.179467 [info ] [MainThread]: 
[0m19:03:54.187369 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.16 seconds (5.16s).
[0m19:03:54.195949 [debug] [MainThread]: Command end result
[0m19:03:54.311039 [info ] [MainThread]: 
[0m19:03:54.311039 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m19:03:54.311039 [info ] [MainThread]: 
[0m19:03:54.319448 [error] [MainThread]:   Database Error in model tb_venda_produto_final (models\3.az\tb_venda_produto_final.sql)
  SELECT list expression references a.cd_produto_bling which is neither grouped nor aggregated at [57:11]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_venda_produto_final.sql
[0m19:03:54.319448 [info ] [MainThread]: 
[0m19:03:54.319448 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m19:03:54.327326 [debug] [MainThread]: Command `dbt run` failed at 19:03:54.327326 after 6.46 seconds
[0m19:03:54.327326 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEDCB623D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEE0122250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEE01AF310>]}
[0m19:03:54.327326 [debug] [MainThread]: Flushing usage events
[0m19:04:33.030247 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABC3081430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABC200C2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABC200C760>]}


============================== 19:04:33.038503 | 1f80e771-51f0-49f3-996d-36c5f354eb46 ==============================
[0m19:04:33.038503 [info ] [MainThread]: Running with dbt=1.7.4
[0m19:04:33.039575 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_venda_produto_final', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:04:33.648719 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1f80e771-51f0-49f3-996d-36c5f354eb46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABC1FFC130>]}
[0m19:04:33.744641 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1f80e771-51f0-49f3-996d-36c5f354eb46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABC6602700>]}
[0m19:04:33.744641 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m19:04:33.760893 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m19:04:33.871804 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:04:33.880338 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_venda_produto_final.sql
[0m19:04:34.020557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1f80e771-51f0-49f3-996d-36c5f354eb46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABC6B83E20>]}
[0m19:04:34.030642 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1f80e771-51f0-49f3-996d-36c5f354eb46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABC68FF2E0>]}
[0m19:04:34.030642 [info ] [MainThread]: Found 18 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m19:04:34.030642 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1f80e771-51f0-49f3-996d-36c5f354eb46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABC68FF280>]}
[0m19:04:34.038825 [info ] [MainThread]: 
[0m19:04:34.038825 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m19:04:34.038825 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:04:34.038825 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:04:34.821164 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m19:04:34.821164 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:04:34.828765 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m19:04:34.830772 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:04:35.582693 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m19:04:35.582693 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:04:35.582693 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m19:04:35.590415 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:04:36.317909 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1f80e771-51f0-49f3-996d-36c5f354eb46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABC6764F10>]}
[0m19:04:36.317909 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:04:36.317909 [info ] [MainThread]: 
[0m19:04:36.326613 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m19:04:36.326613 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_venda_produto_final .................. [RUN]
[0m19:04:36.326613 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_venda_produto_final'
[0m19:04:36.326613 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m19:04:36.343236 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m19:04:36.343236 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 19:04:36.326613 => 19:04:36.343236
[0m19:04:36.349797 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m19:04:36.368243 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m19:04:37.153366 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m19:04:37.161843 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m19:04:37.628478 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0469e92f-f403-429e-8820-e643a38a1e9d&page=queryresults
[0m19:04:40.108771 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 19:04:36.349797 => 19:04:40.108771
[0m19:04:40.108771 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1f80e771-51f0-49f3-996d-36c5f354eb46', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABC6BD6DC0>]}
[0m19:04:40.108771 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_venda_produto_final ............. [[32mCREATE TABLE (1.2k rows, 407.8 KiB processed)[0m in 3.78s]
[0m19:04:40.108771 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m19:04:40.108771 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:04:40.108771 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:04:40.108771 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m19:04:40.117052 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m19:04:40.117052 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_final' was properly closed.
[0m19:04:40.117052 [info ] [MainThread]: 
[0m19:04:40.117052 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.08 seconds (6.08s).
[0m19:04:40.117052 [debug] [MainThread]: Command end result
[0m19:04:40.147756 [info ] [MainThread]: 
[0m19:04:40.147756 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:04:40.147756 [info ] [MainThread]: 
[0m19:04:40.149774 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:04:40.149774 [debug] [MainThread]: Command `dbt run` succeeded at 19:04:40.149774 after 7.19 seconds
[0m19:04:40.149774 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABC3081430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABC6660160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABC69F9070>]}
[0m19:04:40.149774 [debug] [MainThread]: Flushing usage events
[0m19:07:01.949225 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E09C8233D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E09B7B8310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E09B7B8790>]}


============================== 19:07:01.955266 | 62dd3ded-cb7d-43df-8db6-09b9c395e797 ==============================
[0m19:07:01.955266 [info ] [MainThread]: Running with dbt=1.7.4
[0m19:07:01.955266 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_venda_produto_final', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:07:02.632098 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '62dd3ded-cb7d-43df-8db6-09b9c395e797', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E09FE158E0>]}
[0m19:07:02.746299 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '62dd3ded-cb7d-43df-8db6-09b9c395e797', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E09FDCF0D0>]}
[0m19:07:02.749054 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m19:07:02.753907 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m19:07:02.860398 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:07:02.860398 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_venda_produto_final.sql
[0m19:07:03.024959 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '62dd3ded-cb7d-43df-8db6-09b9c395e797', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0A0312EE0>]}
[0m19:07:03.039992 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '62dd3ded-cb7d-43df-8db6-09b9c395e797', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E09FEF3370>]}
[0m19:07:03.039992 [info ] [MainThread]: Found 18 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m19:07:03.039992 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '62dd3ded-cb7d-43df-8db6-09b9c395e797', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E09FEDFD60>]}
[0m19:07:03.039992 [info ] [MainThread]: 
[0m19:07:03.043194 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m19:07:03.043194 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:07:03.043194 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:07:03.820698 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m19:07:03.822737 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:07:03.822737 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m19:07:03.822737 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:07:04.530170 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m19:07:04.530170 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:07:04.538160 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m19:07:04.538160 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:07:05.239815 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '62dd3ded-cb7d-43df-8db6-09b9c395e797', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E09FEEF9A0>]}
[0m19:07:05.245033 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:07:05.245033 [info ] [MainThread]: 
[0m19:07:05.254846 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m19:07:05.254846 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_venda_produto_final .................. [RUN]
[0m19:07:05.254846 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_venda_produto_final'
[0m19:07:05.254846 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m19:07:05.272337 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m19:07:05.274345 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 19:07:05.261379 => 19:07:05.274345
[0m19:07:05.274345 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m19:07:05.291266 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m19:07:06.039655 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m19:07:06.048427 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m19:07:06.621325 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6f11678c-c0d2-43f1-baf7-f3677da89e96&page=queryresults
[0m19:07:08.735789 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 19:07:05.274345 => 19:07:08.733349
[0m19:07:08.735789 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '62dd3ded-cb7d-43df-8db6-09b9c395e797', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0A036ACA0>]}
[0m19:07:08.735789 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_venda_produto_final ............. [[32mCREATE TABLE (1.2k rows, 407.8 KiB processed)[0m in 3.48s]
[0m19:07:08.735789 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m19:07:08.735789 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:07:08.735789 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:07:08.735789 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m19:07:08.741632 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m19:07:08.741632 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_final' was properly closed.
[0m19:07:08.741632 [info ] [MainThread]: 
[0m19:07:08.741632 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.70 seconds (5.70s).
[0m19:07:08.743372 [debug] [MainThread]: Command end result
[0m19:07:08.777813 [info ] [MainThread]: 
[0m19:07:08.777813 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:07:08.777813 [info ] [MainThread]: 
[0m19:07:08.777813 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:07:08.777813 [debug] [MainThread]: Command `dbt run` succeeded at 19:07:08.777813 after 6.90 seconds
[0m19:07:08.777813 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E09C8233D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0A0153E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0A0189130>]}
[0m19:07:08.783121 [debug] [MainThread]: Flushing usage events
[0m19:29:59.789468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000179E1BB6430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000179E0B329A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000179E0B32D30>]}


============================== 19:29:59.789468 | 7a2caa67-5e5d-48c0-b411-75ca4a6b7d28 ==============================
[0m19:29:59.789468 [info ] [MainThread]: Running with dbt=1.7.4
[0m19:29:59.789468 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_venda_produto_final', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m19:30:00.423914 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7a2caa67-5e5d-48c0-b411-75ca4a6b7d28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000179E0B21B20>]}
[0m19:30:00.514484 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7a2caa67-5e5d-48c0-b411-75ca4a6b7d28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000179E0B2EF70>]}
[0m19:30:00.514484 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m19:30:00.526406 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m19:30:00.639668 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m19:30:00.639668 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\3.az\tb_agg_venda_produto_final.sql
[0m19:30:00.773295 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7a2caa67-5e5d-48c0-b411-75ca4a6b7d28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000179E5691D00>]}
[0m19:30:00.788760 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7a2caa67-5e5d-48c0-b411-75ca4a6b7d28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000179E5424B20>]}
[0m19:30:00.788760 [info ] [MainThread]: Found 19 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m19:30:00.788760 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7a2caa67-5e5d-48c0-b411-75ca4a6b7d28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000179E5424100>]}
[0m19:30:00.797498 [info ] [MainThread]: 
[0m19:30:00.798569 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m19:30:00.800243 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:30:00.800243 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:30:01.680219 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m19:30:01.680219 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:30:01.687302 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m19:30:01.687302 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:30:02.370741 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m19:30:02.378323 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:30:02.378323 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m19:30:02.378323 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:30:03.069939 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7a2caa67-5e5d-48c0-b411-75ca4a6b7d28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000179E5267B50>]}
[0m19:30:03.069939 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:30:03.069939 [info ] [MainThread]: 
[0m19:30:03.077985 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m19:30:03.077985 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_venda_produto_final .................. [RUN]
[0m19:30:03.084102 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_venda_produto_final'
[0m19:30:03.086118 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m19:30:03.095248 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m19:30:03.095248 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 19:30:03.086118 => 19:30:03.095248
[0m19:30:03.095248 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m19:30:03.111452 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m19:30:03.795396 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m19:30:03.795396 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m19:30:04.316631 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5ff51c80-e79b-49ca-ba9b-ec335ddeda8d&page=queryresults
[0m19:30:06.713091 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 19:30:03.095248 => 19:30:06.713091
[0m19:30:06.715099 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a2caa67-5e5d-48c0-b411-75ca4a6b7d28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000179E56ECA00>]}
[0m19:30:06.715099 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_venda_produto_final ............. [[32mCREATE TABLE (1.2k rows, 407.8 KiB processed)[0m in 3.64s]
[0m19:30:06.717110 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m19:30:06.723138 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:30:06.723138 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:30:06.723138 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m19:30:06.723138 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m19:30:06.723138 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_final' was properly closed.
[0m19:30:06.725150 [info ] [MainThread]: 
[0m19:30:06.725150 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.93 seconds (5.93s).
[0m19:30:06.727164 [debug] [MainThread]: Command end result
[0m19:30:06.751287 [info ] [MainThread]: 
[0m19:30:06.753297 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:30:06.753297 [info ] [MainThread]: 
[0m19:30:06.755673 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:30:06.755673 [debug] [MainThread]: Command `dbt run` succeeded at 19:30:06.755673 after 7.04 seconds
[0m19:30:06.758062 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000179E1BB6430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000179E52EF820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000179E54FDB50>]}
[0m19:30:06.759379 [debug] [MainThread]: Flushing usage events
[0m19:32:12.836925 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ADFE15C460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD80C059A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD80C05D30>]}


============================== 19:32:12.839850 | 4b86bb3d-53d5-409d-918f-5697f35db957 ==============================
[0m19:32:12.839850 [info ] [MainThread]: Running with dbt=1.7.4
[0m19:32:12.839850 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_agg_venda_produto_final', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:32:13.464628 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4b86bb3d-53d5-409d-918f-5697f35db957', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD818AFA00>]}
[0m19:32:13.555923 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4b86bb3d-53d5-409d-918f-5697f35db957', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD818331F0>]}
[0m19:32:13.555923 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m19:32:13.567321 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m19:32:13.661526 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m19:32:13.661526 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m19:32:13.669684 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4b86bb3d-53d5-409d-918f-5697f35db957', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD81C24C70>]}
[0m19:32:13.678005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4b86bb3d-53d5-409d-918f-5697f35db957', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD81C13670>]}
[0m19:32:13.678005 [info ] [MainThread]: Found 19 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m19:32:13.686108 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4b86bb3d-53d5-409d-918f-5697f35db957', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD818CA580>]}
[0m19:32:13.686414 [info ] [MainThread]: 
[0m19:32:13.687946 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m19:32:13.689743 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:32:13.689743 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:32:14.410715 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m19:32:14.410715 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:32:14.410715 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m19:32:14.459121 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:32:15.090537 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m19:32:15.095214 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:32:15.137446 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m19:32:15.137446 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:32:15.791537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4b86bb3d-53d5-409d-918f-5697f35db957', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD81C24BE0>]}
[0m19:32:15.791537 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:32:15.791537 [info ] [MainThread]: 
[0m19:32:15.799582 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m19:32:15.799582 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_agg_venda_produto_final .............. [RUN]
[0m19:32:15.799582 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_agg_venda_produto_final'
[0m19:32:15.799582 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m19:32:15.816986 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m19:32:15.816986 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 19:32:15.799582 => 19:32:15.816986
[0m19:32:15.816986 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m19:32:15.866102 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m19:32:15.866102 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m19:32:15.866102 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m19:32:16.749964 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:942e9700-ffe7-4cf5-899d-39dc495a851e&page=queryresults
[0m19:32:19.041619 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 19:32:15.824334 => 19:32:19.041619
[0m19:32:19.041619 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4b86bb3d-53d5-409d-918f-5697f35db957', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD82CBEC70>]}
[0m19:32:19.048640 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ......... [[32mCREATE TABLE (1.2k rows, 245.3 KiB processed)[0m in 3.24s]
[0m19:32:19.048640 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m19:32:19.048640 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:32:19.048640 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:32:19.048640 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m19:32:19.048640 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m19:32:19.048640 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_agg_venda_produto_final' was properly closed.
[0m19:32:19.048640 [info ] [MainThread]: 
[0m19:32:19.048640 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.36 seconds (5.36s).
[0m19:32:19.057522 [debug] [MainThread]: Command end result
[0m19:32:19.066051 [info ] [MainThread]: 
[0m19:32:19.073206 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:32:19.073206 [info ] [MainThread]: 
[0m19:32:19.075540 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:32:19.075540 [debug] [MainThread]: Command `dbt run` succeeded at 19:32:19.075540 after 6.31 seconds
[0m19:32:19.075540 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ADFE15C460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD819FC7F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AD81C05DF0>]}
[0m19:32:19.075540 [debug] [MainThread]: Flushing usage events
[0m19:36:12.804451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BC6445430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BC53C6670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BC53C6D90>]}


============================== 19:36:12.812969 | 74741f31-8ba5-415c-98be-9c27f8a295a5 ==============================
[0m19:36:12.812969 [info ] [MainThread]: Running with dbt=1.7.4
[0m19:36:12.812969 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --models tb_agg_venda_produto_final', 'send_anonymous_usage_stats': 'True'}
[0m19:36:13.447530 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '74741f31-8ba5-415c-98be-9c27f8a295a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BC858CB50>]}
[0m19:36:13.530630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '74741f31-8ba5-415c-98be-9c27f8a295a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BC9AA6670>]}
[0m19:36:13.538708 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m19:36:13.547145 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m19:36:13.638322 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m19:36:13.638322 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_agg_venda_produto_final.sql
[0m19:36:13.786642 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '74741f31-8ba5-415c-98be-9c27f8a295a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BC9F21F10>]}
[0m19:36:13.795139 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '74741f31-8ba5-415c-98be-9c27f8a295a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BC9D76430>]}
[0m19:36:13.795139 [info ] [MainThread]: Found 19 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m19:36:13.803119 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '74741f31-8ba5-415c-98be-9c27f8a295a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BC9A0C6A0>]}
[0m19:36:13.803119 [info ] [MainThread]: 
[0m19:36:13.803119 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m19:36:13.803119 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:36:13.803119 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:36:14.736318 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m19:36:14.738332 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m19:36:14.738332 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:36:14.740345 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:36:15.420104 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m19:36:15.420104 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:36:15.460719 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m19:36:15.469218 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:36:16.169341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '74741f31-8ba5-415c-98be-9c27f8a295a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BC9A23130>]}
[0m19:36:16.169341 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:36:16.177234 [info ] [MainThread]: 
[0m19:36:16.179759 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m19:36:16.185526 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_agg_venda_produto_final .............. [RUN]
[0m19:36:16.185526 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_agg_venda_produto_final'
[0m19:36:16.189715 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m19:36:16.202435 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m19:36:16.202435 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 19:36:16.189715 => 19:36:16.202435
[0m19:36:16.207830 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m19:36:16.218513 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m19:36:16.913862 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m19:36:16.913862 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m19:36:17.462392 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c12a103f-d25e-464a-92e2-dcf758eee6e2&page=queryresults
[0m19:36:20.380885 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 19:36:16.207830 => 19:36:20.380885
[0m19:36:20.382891 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74741f31-8ba5-415c-98be-9c27f8a295a5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BC9F7CE80>]}
[0m19:36:20.382891 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ......... [[32mCREATE TABLE (319.0 rows, 245.3 KiB processed)[0m in 4.20s]
[0m19:36:20.383896 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m19:36:20.384963 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:36:20.384963 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:36:20.384963 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m19:36:20.384963 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m19:36:20.384963 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_agg_venda_produto_final' was properly closed.
[0m19:36:20.384963 [info ] [MainThread]: 
[0m19:36:20.388424 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.58 seconds (6.58s).
[0m19:36:20.388424 [debug] [MainThread]: Command end result
[0m19:36:20.410226 [info ] [MainThread]: 
[0m19:36:20.410226 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:36:20.417069 [info ] [MainThread]: 
[0m19:36:20.417069 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:36:20.417069 [debug] [MainThread]: Command `dbt run` succeeded at 19:36:20.417069 after 7.69 seconds
[0m19:36:20.417069 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BC6445430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BC9A1FCA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022BC9D8FF40>]}
[0m19:36:20.417069 [debug] [MainThread]: Flushing usage events
[0m09:41:22.735855 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0E5A85400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0E4A198E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0E4A195E0>]}


============================== 09:41:22.741972 | 9d86557c-42a3-485f-84b2-67fe203d9b3a ==============================
[0m09:41:22.741972 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:41:22.743045 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m09:41:24.275390 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0E4A17100>]}
[0m09:41:24.395890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0E90A7100>]}
[0m09:41:24.397092 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:41:24.415623 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:41:26.223986 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 1 files changed.
[0m09:41:26.224986 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\3.az\tb_venda_produto_base.sql
[0m09:41:26.224986 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_composicao_produto.sql
[0m09:41:26.401727 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0E9545910>]}
[0m09:41:26.437553 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0E9304460>]}
[0m09:41:26.438633 [info ] [MainThread]: Found 20 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:41:26.438633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0E91FB250>]}
[0m09:41:26.442045 [info ] [MainThread]: 
[0m09:41:26.442045 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:41:26.445110 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:41:26.445110 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:41:26.445110 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:41:26.445110 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:41:27.603366 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:41:28.274527 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m09:41:28.274527 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:41:28.275544 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m09:41:28.276588 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:41:29.056513 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m09:41:29.057801 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:41:29.095665 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m09:41:29.096677 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:41:29.757148 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0E915C7C0>]}
[0m09:41:29.759149 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:41:29.761179 [info ] [MainThread]: 
[0m09:41:29.786621 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:41:29.793604 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m09:41:29.788415 [info ] [Thread-1  ]: 1 of 19 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m09:41:29.794602 [info ] [Thread-2  ]: 2 of 19 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m09:41:29.798769 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m09:41:29.800810 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m09:41:29.801466 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m09:41:29.802504 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m09:41:29.815018 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:41:29.822189 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m09:41:29.824459 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 09:41:29.803578 => 09:41:29.824459
[0m09:41:29.825469 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 09:41:29.816025 => 09:41:29.825469
[0m09:41:29.826861 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m09:41:29.826861 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m09:41:29.878098 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m09:41:29.892181 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:41:29.893588 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m09:41:29.895597 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m09:41:29.897380 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:41:29.934340 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m09:41:30.828998 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:13e0dc2b-1740-4aef-b673-a67fa62e0b96&page=queryresults
[0m09:41:30.875599 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9324ece6-c5fd-4f82-bee6-9c552a72e80c&page=queryresults
[0m09:41:31.312125 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 09:41:29.833655 => 09:41:31.312125
[0m09:41:31.313171 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0E9584E80>]}
[0m09:41:31.313171 [info ] [Thread-2  ]: 2 of 19 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.51s]
[0m09:41:31.314292 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m09:41:31.315358 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m09:41:31.315358 [info ] [Thread-2  ]: 3 of 19 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m09:41:31.316503 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m09:41:31.316503 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m09:41:31.322163 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m09:41:31.325289 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 09:41:29.827869 => 09:41:31.325289
[0m09:41:31.326508 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0EA638730>]}
[0m09:41:31.327517 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 09:41:31.317507 => 09:41:31.327517
[0m09:41:31.327517 [info ] [Thread-1  ]: 1 of 19 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.53s]
[0m09:41:31.327517 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m09:41:31.328884 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:41:31.332750 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m09:41:31.333751 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m09:41:31.334756 [info ] [Thread-1  ]: 4 of 19 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m09:41:31.335791 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m09:41:31.335791 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:41:31.335791 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m09:41:31.340785 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m09:41:31.342896 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m09:41:31.372282 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 09:41:31.336846 => 09:41:31.371148
[0m09:41:31.373030 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m09:41:31.376984 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m09:41:31.379107 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:41:31.382187 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m09:41:32.137667 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ea5344e1-14f7-44e8-bd28-177fdfddc03a&page=queryresults
[0m09:41:32.169332 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e5fcb894-c167-4173-908c-fb63bb318e9d&page=queryresults
[0m09:41:32.579068 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 09:41:31.373734 => 09:41:32.578065
[0m09:41:32.579947 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0EA5CEFA0>]}
[0m09:41:32.580715 [info ] [Thread-1  ]: 4 of 19 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m09:41:32.581724 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m09:41:32.581724 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m09:41:32.582724 [info ] [Thread-1  ]: 5 of 19 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m09:41:32.582724 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m09:41:32.583871 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m09:41:32.587508 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m09:41:32.588508 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 09:41:32.583871 => 09:41:32.588508
[0m09:41:32.588508 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m09:41:32.603442 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m09:41:32.603442 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:41:32.605993 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m09:41:32.642041 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 09:41:31.328884 => 09:41:32.642041
[0m09:41:32.643040 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0EA6B2A90>]}
[0m09:41:32.644041 [info ] [Thread-2  ]: 3 of 19 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m09:41:32.645548 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m09:41:32.646555 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m09:41:32.647061 [info ] [Thread-2  ]: 6 of 19 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m09:41:32.648070 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_item_pedido)
[0m09:41:32.648070 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m09:41:32.653059 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m09:41:32.654781 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 09:41:32.649068 => 09:41:32.654059
[0m09:41:32.654781 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m09:41:32.659426 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m09:41:32.661452 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:41:32.662494 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m09:41:33.376252 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e56a5db0-59db-41e3-918c-992a51a2d8e8&page=queryresults
[0m09:41:33.441156 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b3770e16-6a5f-49cf-8f7a-913af39abffd&page=queryresults
[0m09:41:33.773582 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 09:41:32.589673 => 09:41:33.773582
[0m09:41:33.775085 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0EA6B2880>]}
[0m09:41:33.775085 [info ] [Thread-1  ]: 5 of 19 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m09:41:33.776119 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m09:41:33.776119 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m09:41:33.777118 [info ] [Thread-1  ]: 7 of 19 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m09:41:33.777620 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m09:41:33.778627 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m09:41:33.783471 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m09:41:33.785061 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 09:41:33.778627 => 09:41:33.783471
[0m09:41:33.785061 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m09:41:33.789537 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m09:41:33.790498 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:41:33.792505 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m09:41:33.833595 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 09:41:32.655591 => 09:41:33.832594
[0m09:41:33.835108 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0E95BE220>]}
[0m09:41:33.837191 [info ] [Thread-2  ]: 6 of 19 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m09:41:33.839200 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m09:41:33.841727 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m09:41:33.842730 [info ] [Thread-2  ]: 8 of 19 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m09:41:33.842730 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m09:41:33.843728 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m09:41:33.848283 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m09:41:33.850284 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 09:41:33.843728 => 09:41:33.850284
[0m09:41:33.851284 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m09:41:33.867152 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m09:41:33.868153 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:41:33.871167 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m09:41:34.669976 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:28df0d33-7495-4d24-a689-51e2f13ad1ba&page=queryresults
[0m09:41:34.831780 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fabab805-49c3-4a1f-aa1e-b446676cdc60&page=queryresults
[0m09:41:35.107737 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 09:41:33.851284 => 09:41:35.106725
[0m09:41:35.109807 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0EA649130>]}
[0m09:41:35.110934 [info ] [Thread-2  ]: 8 of 19 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m09:41:35.112936 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m09:41:35.114824 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m09:41:35.118871 [info ] [Thread-2  ]: 9 of 19 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m09:41:35.124007 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto)
[0m09:41:35.126048 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m09:41:35.138461 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m09:41:35.144741 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 09:41:35.127916 => 09:41:35.143232
[0m09:41:35.147784 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m09:41:35.166173 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m09:41:35.168171 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:41:35.176829 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m09:41:35.232019 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 09:41:33.786102 => 09:41:35.232019
[0m09:41:35.234690 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0EA68EA30>]}
[0m09:41:35.235992 [info ] [Thread-1  ]: 7 of 19 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m09:41:35.237919 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m09:41:35.238649 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m09:41:35.240880 [info ] [Thread-1  ]: 10 of 19 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m09:41:35.242609 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_tempo)
[0m09:41:35.243285 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m09:41:35.250944 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m09:41:35.258100 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 09:41:35.244799 => 09:41:35.255508
[0m09:41:35.259979 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m09:41:35.266718 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m09:41:35.268731 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:41:35.272760 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m09:41:35.987352 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bcde05fb-fec4-4c12-9a0d-d647a22844b4&page=queryresults
[0m09:41:36.109168 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bd973583-98c5-4564-a8c9-62c185c2542f&page=queryresults
[0m09:41:36.396720 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 09:41:35.259979 => 09:41:36.395717
[0m09:41:36.397718 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0EA68EA30>]}
[0m09:41:36.398719 [info ] [Thread-1  ]: 10 of 19 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m09:41:36.401702 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m09:41:36.402712 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m09:41:36.402712 [info ] [Thread-1  ]: 11 of 19 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m09:41:36.404895 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_venda_produto_base)
[0m09:41:36.404895 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m09:41:36.411087 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m09:41:36.413089 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 09:41:36.405915 => 09:41:36.412088
[0m09:41:36.413089 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m09:41:36.469949 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m09:41:36.471952 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:41:36.475533 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `dbt_dw_az.tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `dbt_dw_az.tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_pedidos_mes_atual
          ,qt_pecas_mes_atual
          ,vl_total_mes_atual
          ,qt_pedidos_mes_anterior
          ,qt_pecas_mes_anterior
          ,vl_total_mes_anterior
          ,qt_pedidos_tres_meses
          ,qt_pecas_tres_meses
          ,vl_total_tres_meses
          ,qt_pedidos_seis_meses
          ,qt_pecas_seis_meses
          ,vl_total_seis_meses
      from `dbt_dw_az.tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)       as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                   as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)       as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                   as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo) as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                 as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                      as qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.qt_pedidos_mes_atual
         ,b.qt_pecas_mes_atual
         ,b.vl_total_mes_atual
         ,b.qt_pedidos_mes_anterior
         ,b.qt_pecas_mes_anterior
         ,b.vl_total_mes_anterior
         ,b.qt_pedidos_tres_meses
         ,b.qt_pecas_tres_meses
         ,b.vl_total_tres_meses
         ,b.qt_pedidos_seis_meses
         ,b.qt_pecas_seis_meses
         ,b.vl_total_seis_meses
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
    );
  
[0m09:41:36.521942 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 09:41:35.152442 => 09:41:36.520941
[0m09:41:36.524028 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0EA728D60>]}
[0m09:41:36.525133 [info ] [Thread-2  ]: 9 of 19 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m09:41:36.528048 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m09:41:36.529985 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m09:41:36.531998 [info ] [Thread-2  ]: 12 of 19 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m09:41:36.533898 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m09:41:36.534914 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m09:41:36.542834 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m09:41:36.545342 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 09:41:36.535970 => 09:41:36.544836
[0m09:41:36.546712 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m09:41:36.551974 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:41:37.218929 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m09:41:37.221022 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m09:41:37.524949 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dca2a756-84fe-4d97-92f5-9028ad6d1ea7&page=queryresults
[0m09:41:37.933181 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8636de14-5035-4380-9ed7-533ed8aaf2bb&page=queryresults
[0m09:41:40.060778 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 09:41:36.414085 => 09:41:40.060778
[0m09:41:40.062574 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0EA6DEBB0>]}
[0m09:41:40.063586 [info ] [Thread-1  ]: 11 of 19 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (479.0 rows, 135.7 KiB processed)[0m in 3.66s]
[0m09:41:40.065094 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m09:41:40.175754 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 09:41:36.547785 => 09:41:40.175754
[0m09:41:40.177218 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0EA768D60>]}
[0m09:41:40.179213 [info ] [Thread-2  ]: 12 of 19 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 3.64s]
[0m09:41:40.180224 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m09:41:40.181278 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m09:41:40.182381 [info ] [Thread-1  ]: 13 of 19 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m09:41:40.184432 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_base, now model.shibaribrasil.tb_produto)
[0m09:41:40.184939 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m09:41:40.191557 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m09:41:40.193863 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 09:41:40.184939 => 09:41:40.193221
[0m09:41:40.193863 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m09:41:40.198333 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:41:40.986827 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m09:41:40.988074 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m09:41:41.756977 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e14d6db8-3ee9-47fc-b56e-2216af24d7ec&page=queryresults
[0m09:41:43.966307 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 09:41:40.194872 => 09:41:43.966307
[0m09:41:43.967391 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0EA64A6D0>]}
[0m09:41:43.968402 [info ] [Thread-1  ]: 13 of 19 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 3.78s]
[0m09:41:43.969552 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m09:41:43.970561 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m09:41:43.971876 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m09:41:43.971876 [info ] [Thread-2  ]: 14 of 19 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m09:41:43.973002 [info ] [Thread-1  ]: 15 of 19 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m09:41:43.974158 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m09:41:43.975169 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m09:41:43.975947 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m09:41:43.975947 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m09:41:43.980753 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m09:41:43.986649 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 09:41:43.976985 => 09:41:43.986649
[0m09:41:43.995154 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m09:41:43.995154 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m09:41:43.998566 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:41:44.027760 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 09:41:43.980753 => 09:41:44.026559
[0m09:41:44.027760 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m09:41:44.033332 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:41:44.626867 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m09:41:44.629383 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m09:41:44.629879 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m09:41:44.629879 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m09:41:45.010179 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ab57f178-f6f6-4cf0-a582-35ed86fbcedd&page=queryresults
[0m09:41:45.257825 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:36b5fa1c-e3f7-4d3b-b433-b2da53753aff&page=queryresults
[0m09:41:46.958121 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 09:41:44.029009 => 09:41:46.958121
[0m09:41:46.960069 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0EA76F910>]}
[0m09:41:46.961179 [info ] [Thread-1  ]: 15 of 19 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 82.4 KiB processed)[0m in 2.98s]
[0m09:41:46.961179 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m09:41:46.962702 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m09:41:46.962702 [info ] [Thread-1  ]: 16 of 19 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m09:41:46.963908 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_pedido)
[0m09:41:46.965053 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m09:41:46.971097 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m09:41:46.971097 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 09:41:46.965053 => 09:41:46.971097
[0m09:41:46.971097 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m09:41:46.971097 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:41:47.479099 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 09:41:43.996238 => 09:41:47.479099
[0m09:41:47.479099 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0EA771C70>]}
[0m09:41:47.479099 [info ] [Thread-2  ]: 14 of 19 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 3.50s]
[0m09:41:47.479099 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m09:41:47.479099 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m09:41:47.479099 [info ] [Thread-2  ]: 17 of 19 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m09:41:47.479099 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_preco_produto)
[0m09:41:47.479099 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m09:41:47.494904 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m09:41:47.494904 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 09:41:47.479099 => 09:41:47.494904
[0m09:41:47.494904 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m09:41:47.494904 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:41:47.558015 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m09:41:47.558015 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m09:41:48.192462 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m09:41:48.202829 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m09:41:48.287796 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f8fe2ae6-5974-42f1-b262-a6bacb14d5a7&page=queryresults
[0m09:41:48.797059 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3ab13feb-442d-4a2f-a559-a219e4e1bd01&page=queryresults
[0m09:41:50.791059 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 09:41:46.971097 => 09:41:50.791059
[0m09:41:50.792487 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0EA70CBB0>]}
[0m09:41:50.794536 [info ] [Thread-1  ]: 16 of 19 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 3.83s]
[0m09:41:50.795672 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m09:41:50.797157 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m09:41:50.798168 [info ] [Thread-1  ]: 18 of 19 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m09:41:50.799176 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m09:41:50.799176 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m09:41:50.804673 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m09:41:50.806720 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 09:41:50.799176 => 09:41:50.805709
[0m09:41:50.806720 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m09:41:50.810194 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:41:51.467612 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m09:41:51.468920 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m09:41:51.600565 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 09:41:47.494904 => 09:41:51.600565
[0m09:41:51.601565 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0EA5CEF70>]}
[0m09:41:51.602565 [info ] [Thread-2  ]: 17 of 19 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (309.0 rows, 81.0 KiB processed)[0m in 4.12s]
[0m09:41:51.603564 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m09:41:51.870526 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a416b452-587c-4d8a-afa1-1bb5b13619c6&page=queryresults
[0m09:41:54.127961 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 09:41:50.807752 => 09:41:54.127456
[0m09:41:54.128971 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0E93D93A0>]}
[0m09:41:54.129476 [info ] [Thread-1  ]: 18 of 19 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 413.1 KiB processed)[0m in 3.33s]
[0m09:41:54.131023 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m09:41:54.131897 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m09:41:54.132907 [info ] [Thread-2  ]: 19 of 19 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m09:41:54.133917 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m09:41:54.134927 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m09:41:54.139287 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m09:41:54.141474 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 09:41:54.134927 => 09:41:54.140482
[0m09:41:54.141983 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m09:41:54.145014 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:41:54.800422 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m09:41:54.802308 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m09:41:55.188569 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d618f09c-18a4-466e-a7b0-5919fe4dd555&page=queryresults
[0m09:41:57.399831 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 09:41:54.142490 => 09:41:57.399831
[0m09:41:57.399831 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d86557c-42a3-485f-84b2-67fe203d9b3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0E93EE0A0>]}
[0m09:41:57.399831 [info ] [Thread-2  ]: 19 of 19 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (320.0 rows, 266.9 KiB processed)[0m in 3.27s]
[0m09:41:57.399831 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m09:41:57.415476 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:41:57.415476 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:41:57.415476 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:41:57.415476 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m09:41:57.415476 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m09:41:57.415476 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_final' was properly closed.
[0m09:41:57.415476 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_agg_venda_produto_final' was properly closed.
[0m09:41:57.419276 [info ] [MainThread]: 
[0m09:41:57.420327 [info ] [MainThread]: Finished running 10 view models, 9 table models in 0 hours 0 minutes and 30.98 seconds (30.98s).
[0m09:41:57.425092 [debug] [MainThread]: Command end result
[0m09:41:57.443273 [info ] [MainThread]: 
[0m09:41:57.444273 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:41:57.444777 [info ] [MainThread]: 
[0m09:41:57.444777 [info ] [MainThread]: Done. PASS=19 WARN=0 ERROR=0 SKIP=0 TOTAL=19
[0m09:41:57.445782 [debug] [MainThread]: Command `dbt run` succeeded at 09:41:57.444777 after 34.83 seconds
[0m09:41:57.445782 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0E5A85400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0E9068520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E0EA6A7A30>]}
[0m09:41:57.445782 [debug] [MainThread]: Flushing usage events
[0m09:42:01.065658 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E6B103430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E6A08F9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E6A08FD30>]}


============================== 09:42:01.069905 | a8d7d928-f2ba-454c-8f9a-47d546bdf05c ==============================
[0m09:42:01.069905 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:42:01.071186 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt snapshot', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m09:42:01.627403 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a8d7d928-f2ba-454c-8f9a-47d546bdf05c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E6D24AAC0>]}
[0m09:42:01.710704 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a8d7d928-f2ba-454c-8f9a-47d546bdf05c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E6E76A520>]}
[0m09:42:01.712049 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:42:01.720154 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:42:01.789916 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:42:01.790263 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:42:01.795029 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a8d7d928-f2ba-454c-8f9a-47d546bdf05c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E6EA44B80>]}
[0m09:42:01.807517 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a8d7d928-f2ba-454c-8f9a-47d546bdf05c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E6E9697C0>]}
[0m09:42:01.807517 [info ] [MainThread]: Found 20 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:42:01.808828 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a8d7d928-f2ba-454c-8f9a-47d546bdf05c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E6E969850>]}
[0m09:42:01.810869 [info ] [MainThread]: 
[0m09:42:01.811864 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:42:01.813909 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:42:01.813909 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:42:02.560153 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m09:42:02.560153 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:42:02.583500 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m09:42:02.584732 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:42:03.122261 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m09:42:03.123343 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:42:03.189962 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m09:42:03.189962 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:42:03.817083 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a8d7d928-f2ba-454c-8f9a-47d546bdf05c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E6EA23B80>]}
[0m09:42:03.818093 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:42:03.819095 [info ] [MainThread]: 
[0m09:42:03.819903 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:42:03.819903 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m09:42:03.819903 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m09:42:03.819903 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:42:03.819903 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 09:42:03.819903 => 09:42:03.819903
[0m09:42:03.835029 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:42:03.905823 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:42:03.906918 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m09:42:04.946396 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f88a62a4-3e6d-4435-a700-2d16986481d6&page=queryresults
[0m09:42:06.051222 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m09:42:06.463980 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a8428e97-eb74-424a-b252-32126119d3e6&page=queryresults
[0m09:42:09.061084 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m09:42:09.915151 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m09:42:09.915151 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m09:42:10.294072 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5ac2fbf4-d8de-40d1-aeb2-e84d671a7e8b&page=queryresults
[0m09:42:12.641183 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 09:42:03.835591 => 09:42:12.641183
[0m09:42:12.644295 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8d7d928-f2ba-454c-8f9a-47d546bdf05c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E6EAD19A0>]}
[0m09:42:12.646296 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (6.0 rows, 66.6 KiB processed)[0m in 8.82s]
[0m09:42:12.648292 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:42:12.652183 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:42:12.653210 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:42:12.654291 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m09:42:12.655292 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m09:42:12.656287 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m09:42:12.657298 [info ] [MainThread]: 
[0m09:42:12.658236 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.84 seconds (10.84s).
[0m09:42:12.660185 [debug] [MainThread]: Command end result
[0m09:42:12.682478 [info ] [MainThread]: 
[0m09:42:12.684478 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:42:12.686135 [info ] [MainThread]: 
[0m09:42:12.687152 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m09:42:12.687152 [debug] [MainThread]: Command `dbt snapshot` succeeded at 09:42:12.687152 after 11.69 seconds
[0m09:42:12.687152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E6B103430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E6E7F9820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022E6E706430>]}
[0m09:42:12.696866 [debug] [MainThread]: Flushing usage events
[0m09:42:18.090913 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B151D23430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B150CA69D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B150CA6B80>]}


============================== 09:42:18.095569 | 569da887-e0b2-4547-8404-68a23292fe97 ==============================
[0m09:42:18.095569 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:42:18.098957 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m09:42:19.332899 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '569da887-e0b2-4547-8404-68a23292fe97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B14EDE1DC0>]}
[0m09:42:19.421368 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '569da887-e0b2-4547-8404-68a23292fe97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B155383C40>]}
[0m09:42:19.423404 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:42:19.429463 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:42:19.525691 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:42:19.526689 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:42:19.532391 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '569da887-e0b2-4547-8404-68a23292fe97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B155668250>]}
[0m09:42:19.543274 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '569da887-e0b2-4547-8404-68a23292fe97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B1556522B0>]}
[0m09:42:19.544284 [info ] [MainThread]: Found 20 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:42:19.544284 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '569da887-e0b2-4547-8404-68a23292fe97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B155365D30>]}
[0m09:42:19.545315 [info ] [MainThread]: 
[0m09:42:19.546307 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:42:19.548275 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:42:19.548275 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:42:20.262966 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m09:42:20.262966 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:42:20.278341 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m09:42:20.280837 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:42:21.225559 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m09:42:21.231781 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m09:42:21.232775 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:42:21.237781 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:42:22.158668 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '569da887-e0b2-4547-8404-68a23292fe97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B155451D60>]}
[0m09:42:22.158668 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:42:22.160684 [info ] [MainThread]: 
[0m09:42:22.168740 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:42:22.168740 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m09:42:22.170750 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m09:42:22.172505 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:42:22.182594 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m09:42:22.182594 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 09:42:22.172505 => 09:42:22.182594
[0m09:42:22.182594 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:42:22.233589 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:42:22.981929 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m09:42:22.981929 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m09:42:23.486548 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:181185b5-0a93-4663-bc97-898b75c202b7&page=queryresults
[0m09:42:25.500236 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 09:42:22.188452 => 09:42:25.500236
[0m09:42:25.515381 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '569da887-e0b2-4547-8404-68a23292fe97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B155668250>]}
[0m09:42:25.515381 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (366.0 rows, 53.8 KiB processed)[0m in 3.34s]
[0m09:42:25.515381 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:42:25.515381 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:42:25.515381 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:42:25.531383 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m09:42:25.531383 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m09:42:25.531383 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m09:42:25.531383 [info ] [MainThread]: 
[0m09:42:25.531383 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.99 seconds (5.99s).
[0m09:42:25.531383 [debug] [MainThread]: Command end result
[0m09:42:25.573460 [info ] [MainThread]: 
[0m09:42:25.575508 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:42:25.577874 [info ] [MainThread]: 
[0m09:42:25.579829 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m09:42:25.580145 [debug] [MainThread]: Command `dbt run` succeeded at 09:42:25.580145 after 7.61 seconds
[0m09:42:25.584667 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B151D23430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B155365F40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B1552A3AF0>]}
[0m09:42:25.584667 [debug] [MainThread]: Flushing usage events
[0m09:46:40.675544 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002665E713460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002665D6899A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002665D689D30>]}


============================== 09:46:40.710945 | f64486bb-a16e-4b32-bd66-48dc8c32946e ==============================
[0m09:46:40.710945 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:46:40.713889 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --exclude tag:snaps', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m09:46:41.429050 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002665D685970>]}
[0m09:46:41.503852 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026661D78100>]}
[0m09:46:41.504777 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:46:41.512892 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:46:41.570140 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:46:41.571401 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:46:41.586161 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026662055A00>]}
[0m09:46:41.600392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266620486A0>]}
[0m09:46:41.600392 [info ] [MainThread]: Found 20 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:46:41.601405 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026662048730>]}
[0m09:46:41.603415 [info ] [MainThread]: 
[0m09:46:41.604417 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:46:41.606930 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:46:41.606930 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:46:41.632471 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:46:41.633426 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:46:42.551995 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:46:43.287164 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m09:46:43.288224 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:46:43.290240 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m09:46:43.292183 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:46:43.934746 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m09:46:43.939443 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:46:43.970878 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m09:46:43.970878 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:46:44.637875 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026661DE41F0>]}
[0m09:46:44.639923 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:46:44.641883 [info ] [MainThread]: 
[0m09:46:44.651724 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:46:44.652676 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m09:46:44.653694 [info ] [Thread-1  ]: 1 of 19 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m09:46:44.656202 [info ] [Thread-2  ]: 2 of 19 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m09:46:44.658241 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m09:46:44.659259 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m09:46:44.660236 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m09:46:44.661236 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m09:46:44.669811 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:46:44.677852 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m09:46:44.678869 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 09:46:44.661236 => 09:46:44.678869
[0m09:46:44.678869 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m09:46:44.702605 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:46:44.704016 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 09:46:44.670811 => 09:46:44.702605
[0m09:46:44.704016 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m09:46:44.706083 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m09:46:44.707088 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:46:44.707088 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m09:46:44.709479 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m09:46:44.732896 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m09:46:45.484517 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:047e6f6a-0a61-484b-b4eb-d8d23a1704e4&page=queryresults
[0m09:46:45.533846 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ef0fe5c0-1f22-4e0e-944b-f77f1ecbaaf4&page=queryresults
[0m09:46:45.949872 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 09:46:44.704016 => 09:46:45.949872
[0m09:46:45.949872 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002666314E880>]}
[0m09:46:45.953873 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 09:46:44.679854 => 09:46:45.953873
[0m09:46:45.950873 [info ] [Thread-2  ]: 2 of 19 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m09:46:45.954874 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026663112310>]}
[0m09:46:45.955324 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m09:46:45.955853 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m09:46:45.955853 [info ] [Thread-1  ]: 1 of 19 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m09:46:45.957218 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:46:45.957218 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m09:46:45.956858 [info ] [Thread-2  ]: 3 of 19 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m09:46:45.958225 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m09:46:45.959224 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m09:46:45.958225 [info ] [Thread-1  ]: 4 of 19 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m09:46:45.962224 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m09:46:45.962224 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m09:46:45.963329 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m09:46:45.967240 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m09:46:45.967240 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 09:46:45.959224 => 09:46:45.967240
[0m09:46:45.968600 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m09:46:45.968600 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 09:46:45.964231 => 09:46:45.968600
[0m09:46:45.972599 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m09:46:45.974599 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m09:46:45.978144 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m09:46:45.979145 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:46:45.981146 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m09:46:45.982147 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:46:46.004226 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m09:46:46.728819 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:98b256db-1dec-425c-93b4-fa371566c028&page=queryresults
[0m09:46:46.874363 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2d29356a-8a93-489b-9a41-d72f84c52e53&page=queryresults
[0m09:46:47.168256 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 09:46:45.968600 => 09:46:47.167177
[0m09:46:47.169305 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026662104E50>]}
[0m09:46:47.170239 [info ] [Thread-2  ]: 3 of 19 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m09:46:47.171245 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m09:46:47.172282 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m09:46:47.173287 [info ] [Thread-2  ]: 5 of 19 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m09:46:47.174281 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m09:46:47.175256 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m09:46:47.178982 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m09:46:47.180953 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 09:46:47.175256 => 09:46:47.180953
[0m09:46:47.181924 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m09:46:47.186464 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m09:46:47.187066 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:46:47.189162 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m09:46:47.299240 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 09:46:45.972599 => 09:46:47.299240
[0m09:46:47.301231 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026662108DC0>]}
[0m09:46:47.302234 [info ] [Thread-1  ]: 4 of 19 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m09:46:47.304240 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m09:46:47.305229 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m09:46:47.306229 [info ] [Thread-1  ]: 6 of 19 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m09:46:47.308262 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m09:46:47.309261 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m09:46:47.314252 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m09:46:47.316257 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 09:46:47.309261 => 09:46:47.315252
[0m09:46:47.316257 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m09:46:47.318774 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m09:46:47.319771 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:46:47.320776 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m09:46:48.038019 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:70fa41b3-6c44-4c73-a28d-2d78e2694ea5&page=queryresults
[0m09:46:48.279266 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:91ced22f-1d68-47db-932b-dea3a90ab44e&page=queryresults
[0m09:46:48.444234 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 09:46:47.181924 => 09:46:48.444234
[0m09:46:48.446147 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266631F1FD0>]}
[0m09:46:48.447872 [info ] [Thread-2  ]: 5 of 19 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m09:46:48.449879 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m09:46:48.450881 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m09:46:48.451876 [info ] [Thread-2  ]: 7 of 19 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m09:46:48.452931 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m09:46:48.453871 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m09:46:48.458915 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m09:46:48.460921 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 09:46:48.453871 => 09:46:48.459911
[0m09:46:48.461916 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m09:46:48.473064 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m09:46:48.474049 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:46:48.477053 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m09:46:48.691246 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 09:46:47.316257 => 09:46:48.691246
[0m09:46:48.693249 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002666318D2B0>]}
[0m09:46:48.694249 [info ] [Thread-1  ]: 6 of 19 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.39s]
[0m09:46:48.696238 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m09:46:48.697238 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m09:46:48.698420 [info ] [Thread-1  ]: 8 of 19 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m09:46:48.700425 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m09:46:48.701417 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m09:46:48.704417 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m09:46:48.705418 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 09:46:48.701417 => 09:46:48.705418
[0m09:46:48.705418 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m09:46:48.708931 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m09:46:48.708931 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:46:48.711459 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m09:46:49.284915 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:29293b79-4149-4ab0-8b76-8cdcd96617e1&page=queryresults
[0m09:46:49.469153 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:63ab5163-00ab-4319-a0b4-02bd2c229442&page=queryresults
[0m09:46:49.684589 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 09:46:48.462919 => 09:46:49.683503
[0m09:46:49.686100 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002666312AF10>]}
[0m09:46:49.690144 [info ] [Thread-2  ]: 7 of 19 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m09:46:49.692153 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m09:46:49.693148 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m09:46:49.694146 [info ] [Thread-2  ]: 9 of 19 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m09:46:49.697146 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m09:46:49.697664 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m09:46:49.702668 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m09:46:49.704670 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 09:46:49.697664 => 09:46:49.704670
[0m09:46:49.704670 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m09:46:49.709008 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m09:46:49.709914 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:46:49.715478 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m09:46:49.883824 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 09:46:48.706923 => 09:46:49.883824
[0m09:46:49.884822 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026662108670>]}
[0m09:46:49.886340 [info ] [Thread-1  ]: 8 of 19 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m09:46:49.887871 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m09:46:49.888869 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m09:46:49.888869 [info ] [Thread-1  ]: 10 of 19 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m09:46:49.890869 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_tempo)
[0m09:46:49.890869 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m09:46:49.895869 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m09:46:49.896912 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 09:46:49.891909 => 09:46:49.896912
[0m09:46:49.898332 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m09:46:49.903315 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m09:46:49.904406 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:46:49.905315 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m09:46:50.488524 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e10e803f-0c1c-4968-9b7a-3445f7cade00&page=queryresults
[0m09:46:50.715280 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8a565e91-60c0-4405-b49b-120c1ea249fe&page=queryresults
[0m09:46:50.870091 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 09:46:49.704670 => 09:46:50.870091
[0m09:46:50.871090 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026663247310>]}
[0m09:46:50.872091 [info ] [Thread-2  ]: 9 of 19 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m09:46:50.873122 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m09:46:50.873122 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m09:46:50.873122 [info ] [Thread-2  ]: 11 of 19 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m09:46:50.874086 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_venda_produto_base)
[0m09:46:50.874086 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m09:46:50.878654 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m09:46:50.879653 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 09:46:50.874086 => 09:46:50.879653
[0m09:46:50.880649 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m09:46:50.893189 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:46:51.104856 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 09:46:49.898332 => 09:46:51.103851
[0m09:46:51.106378 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002666315A460>]}
[0m09:46:51.107898 [info ] [Thread-1  ]: 10 of 19 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m09:46:51.108911 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m09:46:51.109902 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m09:46:51.110909 [info ] [Thread-1  ]: 12 of 19 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m09:46:51.111902 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.dm_produto)
[0m09:46:51.112902 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m09:46:51.116937 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m09:46:51.118949 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 09:46:51.112902 => 09:46:51.117944
[0m09:46:51.118949 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m09:46:51.121975 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:46:51.570458 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m09:46:51.571452 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `dbt_dw_az.tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `dbt_dw_az.tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_pedidos_mes_atual
          ,qt_pecas_mes_atual
          ,vl_total_mes_atual
          ,qt_pedidos_mes_anterior
          ,qt_pecas_mes_anterior
          ,vl_total_mes_anterior
          ,qt_pedidos_tres_meses
          ,qt_pecas_tres_meses
          ,vl_total_tres_meses
          ,qt_pedidos_seis_meses
          ,qt_pecas_seis_meses
          ,vl_total_seis_meses
      from `dbt_dw_az.tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)       as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                   as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)       as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                   as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo) as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                 as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                      as qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.qt_pedidos_mes_atual
         ,b.qt_pecas_mes_atual
         ,b.vl_total_mes_atual
         ,b.qt_pedidos_mes_anterior
         ,b.qt_pecas_mes_anterior
         ,b.vl_total_mes_anterior
         ,b.qt_pedidos_tres_meses
         ,b.qt_pecas_tres_meses
         ,b.vl_total_tres_meses
         ,b.qt_pedidos_seis_meses
         ,b.qt_pecas_seis_meses
         ,b.vl_total_seis_meses
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
    );
  
[0m09:46:51.756826 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m09:46:51.758847 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m09:46:52.018176 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:98f6c175-b67e-47be-9fa7-2c9f5f9ef282&page=queryresults
[0m09:46:52.319062 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:286bea11-121c-4313-a144-35d3886b079c&page=queryresults
[0m09:46:53.951863 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 09:46:50.881643 => 09:46:53.951863
[0m09:46:53.953851 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266631D41F0>]}
[0m09:46:53.954850 [info ] [Thread-2  ]: 11 of 19 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (480.0 rows, 141.0 KiB processed)[0m in 3.08s]
[0m09:46:53.956865 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m09:46:54.841706 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 09:46:51.118949 => 09:46:54.841706
[0m09:46:54.842704 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266632443D0>]}
[0m09:46:54.843704 [info ] [Thread-1  ]: 12 of 19 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 3.73s]
[0m09:46:54.843704 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m09:46:54.844705 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m09:46:54.844705 [info ] [Thread-2  ]: 13 of 19 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m09:46:54.846210 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_base, now model.shibaribrasil.tb_produto)
[0m09:46:54.846715 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m09:46:54.849726 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m09:46:54.851734 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 09:46:54.846715 => 09:46:54.850735
[0m09:46:54.851734 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m09:46:54.856747 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:46:55.479265 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m09:46:55.480203 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m09:46:56.118104 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9d6c4499-a4d0-4a4d-82b0-6ffc88416a33&page=queryresults
[0m09:46:58.358030 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 09:46:54.851734 => 09:46:58.358030
[0m09:46:58.359987 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002666312A5B0>]}
[0m09:46:58.360992 [info ] [Thread-2  ]: 13 of 19 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 3.51s]
[0m09:46:58.363030 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m09:46:58.365037 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m09:46:58.365978 [info ] [Thread-1  ]: 14 of 19 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m09:46:58.367017 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m09:46:58.367596 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m09:46:58.371644 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m09:46:58.372619 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m09:46:58.372619 [info ] [Thread-2  ]: 15 of 19 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m09:46:58.373610 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m09:46:58.373610 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m09:46:58.377290 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m09:46:58.378299 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 09:46:58.367596 => 09:46:58.377290
[0m09:46:58.378299 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m09:46:58.380300 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:46:58.403321 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 09:46:58.374629 => 09:46:58.403321
[0m09:46:58.404220 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m09:46:58.406912 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:46:59.019213 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m09:46:59.022237 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m09:46:59.040955 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m09:46:59.042951 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m09:46:59.386927 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:611e761e-3d49-4d4c-bb04-d482e0f14ba2&page=queryresults
[0m09:46:59.631726 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:167083fa-adef-4b3c-a0d2-0db0a0d96432&page=queryresults
[0m09:47:01.619204 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 09:46:58.405253 => 09:47:01.618204
[0m09:47:01.621266 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266620DA910>]}
[0m09:47:01.623273 [info ] [Thread-2  ]: 15 of 19 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 82.4 KiB processed)[0m in 3.25s]
[0m09:47:01.624283 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m09:47:01.624283 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m09:47:01.624283 [info ] [Thread-2  ]: 16 of 19 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m09:47:01.625839 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_pedido)
[0m09:47:01.625839 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m09:47:01.632612 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m09:47:01.634602 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 09:47:01.625839 => 09:47:01.634602
[0m09:47:01.634602 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m09:47:01.654373 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:47:02.146286 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 09:46:58.378299 => 09:47:02.144727
[0m09:47:02.147351 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002666310DE20>]}
[0m09:47:02.149422 [info ] [Thread-1  ]: 14 of 19 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 3.78s]
[0m09:47:02.151371 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m09:47:02.153400 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m09:47:02.154426 [info ] [Thread-1  ]: 17 of 19 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m09:47:02.155426 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_preco_produto)
[0m09:47:02.156989 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m09:47:02.165047 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m09:47:02.167064 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 09:47:02.158068 => 09:47:02.167064
[0m09:47:02.168322 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m09:47:02.172383 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:47:02.329952 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m09:47:02.332906 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m09:47:02.793660 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m09:47:02.796173 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m09:47:02.911173 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7512b9b7-88a0-43a0-990f-45137e6294a7&page=queryresults
[0m09:47:03.387024 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2155fcdf-eef9-4e36-b33c-3ae53cf77371&page=queryresults
[0m09:47:05.162829 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 09:47:01.636165 => 09:47:05.162829
[0m09:47:05.163913 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266632722B0>]}
[0m09:47:05.164824 [info ] [Thread-2  ]: 16 of 19 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 3.54s]
[0m09:47:05.166400 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m09:47:05.167016 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m09:47:05.168031 [info ] [Thread-2  ]: 18 of 19 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m09:47:05.169100 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m09:47:05.170029 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m09:47:05.175046 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m09:47:05.177026 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 09:47:05.170029 => 09:47:05.177026
[0m09:47:05.178321 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m09:47:05.180321 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:47:05.977782 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m09:47:05.980794 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m09:47:06.388574 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c6ef1c42-f223-47af-aea8-caf712fe9c04&page=queryresults
[0m09:47:07.079974 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 09:47:02.169367 => 09:47:07.078989
[0m09:47:07.081992 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026663143880>]}
[0m09:47:07.082972 [info ] [Thread-1  ]: 17 of 19 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (309.0 rows, 81.0 KiB processed)[0m in 4.93s]
[0m09:47:07.085462 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m09:47:08.902051 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 09:47:05.178321 => 09:47:08.901047
[0m09:47:08.903050 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266631A2C70>]}
[0m09:47:08.905071 [info ] [Thread-2  ]: 18 of 19 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 413.1 KiB processed)[0m in 3.74s]
[0m09:47:08.906093 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m09:47:08.907041 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m09:47:08.908222 [info ] [Thread-1  ]: 19 of 19 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m09:47:08.909402 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m09:47:08.910418 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m09:47:08.914505 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m09:47:08.916048 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 09:47:08.910418 => 09:47:08.916048
[0m09:47:08.917061 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m09:47:08.923108 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:47:10.065280 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m09:47:10.067985 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m09:47:10.432336 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a27c086b-9124-4d5e-a114-97b8a59427a0&page=queryresults
[0m09:47:12.916929 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 09:47:08.917061 => 09:47:12.916929
[0m09:47:12.918941 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f64486bb-a16e-4b32-bd66-48dc8c32946e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026663275490>]}
[0m09:47:12.920950 [info ] [Thread-1  ]: 19 of 19 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (320.0 rows, 266.9 KiB processed)[0m in 4.01s]
[0m09:47:12.922951 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m09:47:12.927169 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:47:12.928187 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:47:12.928187 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:47:12.929182 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m09:47:12.929182 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m09:47:12.930184 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_agg_venda_produto_final' was properly closed.
[0m09:47:12.930184 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_final' was properly closed.
[0m09:47:12.931188 [info ] [MainThread]: 
[0m09:47:12.932180 [info ] [MainThread]: Finished running 10 view models, 9 table models in 0 hours 0 minutes and 31.33 seconds (31.33s).
[0m09:47:12.937178 [debug] [MainThread]: Command end result
[0m09:47:12.946398 [info ] [MainThread]: 
[0m09:47:12.946924 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:47:12.947938 [info ] [MainThread]: 
[0m09:47:12.947938 [info ] [MainThread]: Done. PASS=19 WARN=0 ERROR=0 SKIP=0 TOTAL=19
[0m09:47:12.948958 [debug] [MainThread]: Command `dbt run` succeeded at 09:47:12.948958 after 32.33 seconds
[0m09:47:12.948958 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002665E713460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026661E4B820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026661D02250>]}
[0m09:47:12.949938 [debug] [MainThread]: Flushing usage events
[0m09:47:16.388805 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF78369430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF772F7670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF772F7AC0>]}


============================== 09:47:16.392982 | 4356b9db-a504-4125-909e-12787924bf4c ==============================
[0m09:47:16.392982 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:47:16.393887 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt snapshot', 'send_anonymous_usage_stats': 'True'}
[0m09:47:16.957833 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4356b9db-a504-4125-909e-12787924bf4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF7A4BEB50>]}
[0m09:47:17.026862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4356b9db-a504-4125-909e-12787924bf4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF7B9CFA30>]}
[0m09:47:17.027965 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:47:17.035223 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:47:17.086898 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:47:17.086898 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:47:17.091940 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4356b9db-a504-4125-909e-12787924bf4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF7BCB4EB0>]}
[0m09:47:17.103476 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4356b9db-a504-4125-909e-12787924bf4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF7B9076A0>]}
[0m09:47:17.103476 [info ] [MainThread]: Found 20 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:47:17.104319 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4356b9db-a504-4125-909e-12787924bf4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF7B9B76D0>]}
[0m09:47:17.105910 [info ] [MainThread]: 
[0m09:47:17.105910 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:47:17.108033 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:47:17.108033 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:47:17.858230 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m09:47:17.859234 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:47:17.861182 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m09:47:17.863830 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:47:18.470208 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m09:47:18.473202 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:47:18.518068 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m09:47:18.519067 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:47:19.115336 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4356b9db-a504-4125-909e-12787924bf4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF7BA2AEB0>]}
[0m09:47:19.118767 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:47:19.119748 [info ] [MainThread]: 
[0m09:47:19.128636 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:47:19.129637 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m09:47:19.131636 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m09:47:19.131636 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:47:19.141173 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 09:47:19.132634 => 09:47:19.141173
[0m09:47:19.142174 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:47:19.185003 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:47:19.187003 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m09:47:19.934356 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:632eee65-6f44-41aa-b884-12042a541728&page=queryresults
[0m09:47:21.060056 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m09:47:21.491798 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e2476855-153e-4e5a-a42b-9acad70a6606&page=queryresults
[0m09:47:24.194795 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m09:47:24.924666 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m09:47:24.929436 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m09:47:25.470163 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:df3d305f-d212-499b-ad1c-462ce1ccb36c&page=queryresults
[0m09:47:39.664107 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 09:47:19.142174 => 09:47:39.663093
[0m09:47:39.666108 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4356b9db-a504-4125-909e-12787924bf4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF7CD5D700>]}
[0m09:47:39.668746 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 66.0 KiB processed)[0m in 20.54s]
[0m09:47:39.671659 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:47:39.676145 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:47:39.677156 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:47:39.678165 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m09:47:39.679188 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m09:47:39.680176 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m09:47:39.681177 [info ] [MainThread]: 
[0m09:47:39.683187 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 22.58 seconds (22.58s).
[0m09:47:39.687282 [debug] [MainThread]: Command end result
[0m09:47:39.719625 [info ] [MainThread]: 
[0m09:47:39.721572 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:47:39.724322 [info ] [MainThread]: 
[0m09:47:39.725366 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m09:47:39.730760 [debug] [MainThread]: Command `dbt snapshot` succeeded at 09:47:39.729721 after 23.40 seconds
[0m09:47:39.733722 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF78369430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF7B9647F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EF7BCC19D0>]}
[0m09:47:39.734785 [debug] [MainThread]: Flushing usage events
[0m09:47:43.323604 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242EDE693D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242ECDF42E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242ECDF4760>]}


============================== 09:47:43.326966 | 1ecd0c45-cc39-49b8-8e3c-dc044208db8d ==============================
[0m09:47:43.326966 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:47:43.328090 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m09:47:43.886927 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1ecd0c45-cc39-49b8-8e3c-dc044208db8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242EFFBABE0>]}
[0m09:47:43.953965 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1ecd0c45-cc39-49b8-8e3c-dc044208db8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242F0822B80>]}
[0m09:47:43.954971 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:47:43.962549 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:47:44.014132 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:47:44.014132 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:47:44.018842 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1ecd0c45-cc39-49b8-8e3c-dc044208db8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242F17B5EE0>]}
[0m09:47:44.030944 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1ecd0c45-cc39-49b8-8e3c-dc044208db8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242F14ADCD0>]}
[0m09:47:44.030944 [info ] [MainThread]: Found 20 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:47:44.031985 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1ecd0c45-cc39-49b8-8e3c-dc044208db8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242F14ADB50>]}
[0m09:47:44.033022 [info ] [MainThread]: 
[0m09:47:44.033965 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:47:44.034980 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:47:44.034980 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:47:44.752273 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m09:47:44.753271 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:47:44.755272 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m09:47:44.755272 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:47:45.372335 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m09:47:45.374435 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:47:45.416428 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m09:47:45.416934 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:47:46.074211 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1ecd0c45-cc39-49b8-8e3c-dc044208db8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242F146BFA0>]}
[0m09:47:46.075212 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:47:46.076212 [info ] [MainThread]: 
[0m09:47:46.084894 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:47:46.084894 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m09:47:46.086966 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m09:47:46.088073 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:47:46.096288 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m09:47:46.097391 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 09:47:46.088073 => 09:47:46.097391
[0m09:47:46.097391 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:47:46.112102 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:47:46.886210 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m09:47:46.887211 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m09:47:47.260190 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:270eda77-de08-4251-be76-3cfd860e4557&page=queryresults
[0m09:47:50.974782 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 09:47:46.098460 => 09:47:50.974782
[0m09:47:50.976319 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1ecd0c45-cc39-49b8-8e3c-dc044208db8d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242F1842EE0>]}
[0m09:47:50.977418 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (366.0 rows, 53.8 KiB processed)[0m in 4.89s]
[0m09:47:50.978535 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:47:50.981471 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:47:50.981471 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:47:50.981471 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m09:47:50.982557 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m09:47:50.982557 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m09:47:50.983545 [info ] [MainThread]: 
[0m09:47:50.984538 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.95 seconds (6.95s).
[0m09:47:50.984538 [debug] [MainThread]: Command end result
[0m09:47:50.999195 [info ] [MainThread]: 
[0m09:47:51.001167 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:47:51.002136 [info ] [MainThread]: 
[0m09:47:51.004185 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m09:47:51.006224 [debug] [MainThread]: Command `dbt run` succeeded at 09:47:51.005170 after 7.74 seconds
[0m09:47:51.007236 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242EDE693D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242F0822B80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000242F17B9280>]}
[0m09:47:51.007834 [debug] [MainThread]: Flushing usage events
[0m10:00:13.506808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BBC83430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BABF89D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BABF8B80>]}


============================== 10:00:13.511401 | 76e2bb92-d332-4eca-8dc3-5eee659c877d ==============================
[0m10:00:13.511401 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:00:13.512398 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --exclude tag:snaps', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:00:14.345674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BABEA100>]}
[0m10:00:14.404563 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF2F0850>]}
[0m10:00:14.406743 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:00:14.437512 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:00:17.942391 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:00:17.943393 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:00:17.950105 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF5C5DF0>]}
[0m10:00:17.996183 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF5B8A90>]}
[0m10:00:17.997162 [info ] [MainThread]: Found 20 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:00:17.998169 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF5B8B20>]}
[0m10:00:18.002801 [info ] [MainThread]: 
[0m10:00:18.004764 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:00:18.008784 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:18.010166 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:18.012292 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:18.014327 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:18.876165 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:19.563908 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m10:00:19.563908 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:19.565775 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m10:00:19.566896 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:20.246695 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m10:00:20.248796 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:20.284348 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m10:00:20.285348 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:20.922642 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF610220>]}
[0m10:00:20.923613 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:00:20.925243 [info ] [MainThread]: 
[0m10:00:20.933038 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:20.935085 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m10:00:20.934036 [info ] [Thread-1  ]: 1 of 19 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m10:00:20.937038 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m10:00:20.937038 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:20.949585 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:00:20.935085 [info ] [Thread-2  ]: 2 of 19 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m10:00:20.951741 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m10:00:20.952656 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m10:00:20.967139 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 10:00:20.938036 => 10:00:20.967139
[0m10:00:20.969184 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:20.966138 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m10:00:21.004582 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:00:21.005582 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 10:00:20.952656 => 10:00:21.005582
[0m10:00:21.005582 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m10:00:21.007690 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m10:00:21.008688 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:00:21.009586 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:00:21.011004 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m10:00:21.036147 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m10:00:21.872093 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d985c3f0-f3b9-4442-ac1d-9205e7261ad4&page=queryresults
[0m10:00:21.875080 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6904c291-a6ca-4b57-8d8b-d8357e594383&page=queryresults
[0m10:00:22.316463 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 10:00:21.005582 => 10:00:22.316463
[0m10:00:22.317465 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0C06CF310>]}
[0m10:00:22.317465 [info ] [Thread-2  ]: 2 of 19 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m10:00:22.318465 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m10:00:22.319467 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m10:00:22.319785 [info ] [Thread-2  ]: 3 of 19 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m10:00:22.320790 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m10:00:22.320790 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m10:00:22.323792 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m10:00:22.325792 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 10:00:22.320790 => 10:00:22.324795
[0m10:00:22.325792 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m10:00:22.327791 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m10:00:22.328789 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:22.330793 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m10:00:22.354805 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 10:00:20.969760 => 10:00:22.354805
[0m10:00:22.354805 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF65CDC0>]}
[0m10:00:22.356808 [info ] [Thread-1  ]: 1 of 19 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m10:00:22.357308 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:22.357308 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m10:00:22.358318 [info ] [Thread-1  ]: 4 of 19 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m10:00:22.359318 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m10:00:22.359641 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m10:00:22.366637 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m10:00:22.367638 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 10:00:22.359641 => 10:00:22.367638
[0m10:00:22.368640 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m10:00:22.370642 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m10:00:22.372910 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:22.373905 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m10:00:23.123547 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:16b459a3-57eb-43b8-a071-57c45edc828a&page=queryresults
[0m10:00:23.201544 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bb0d7dba-4e6c-4fd2-9d46-bc9139af1378&page=queryresults
[0m10:00:23.508195 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 10:00:22.325792 => 10:00:23.508195
[0m10:00:23.509105 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0C0666F70>]}
[0m10:00:23.509105 [info ] [Thread-2  ]: 3 of 19 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m10:00:23.511113 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m10:00:23.512153 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m10:00:23.512153 [info ] [Thread-2  ]: 5 of 19 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m10:00:23.513124 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m10:00:23.514198 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m10:00:23.516192 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m10:00:23.517192 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 10:00:23.514198 => 10:00:23.517192
[0m10:00:23.518147 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m10:00:23.520675 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m10:00:23.521676 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:23.523704 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m10:00:23.665944 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 10:00:22.368640 => 10:00:23.665944
[0m10:00:23.666935 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0C06AC280>]}
[0m10:00:23.667938 [info ] [Thread-1  ]: 4 of 19 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m10:00:23.669420 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m10:00:23.669420 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m10:00:23.670426 [info ] [Thread-1  ]: 6 of 19 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m10:00:23.671426 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m10:00:23.671426 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m10:00:23.675427 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m10:00:23.676425 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 10:00:23.672424 => 10:00:23.676425
[0m10:00:23.676425 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m10:00:23.680754 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m10:00:23.681750 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:23.683756 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m10:00:24.380091 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8509d78d-41cf-488e-958d-72f3ad693c0c&page=queryresults
[0m10:00:24.476219 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:50ec995a-b51e-42d9-9549-96a8b0b00ee1&page=queryresults
[0m10:00:24.815930 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 10:00:23.518147 => 10:00:24.815930
[0m10:00:24.817931 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF67D7F0>]}
[0m10:00:24.818932 [info ] [Thread-2  ]: 5 of 19 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m10:00:24.820929 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m10:00:24.821930 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:24.822962 [info ] [Thread-2  ]: 7 of 19 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m10:00:24.823933 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m10:00:24.825040 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:24.836854 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m10:00:24.837848 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 10:00:24.826042 => 10:00:24.837848
[0m10:00:24.838798 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:24.841255 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m10:00:24.842255 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:24.843299 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m10:00:24.880616 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 10:00:23.677436 => 10:00:24.880616
[0m10:00:24.881615 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF63B640>]}
[0m10:00:24.881615 [info ] [Thread-1  ]: 6 of 19 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m10:00:24.882615 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m10:00:24.882615 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m10:00:24.883616 [info ] [Thread-1  ]: 8 of 19 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m10:00:24.883616 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m10:00:24.884615 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m10:00:24.886615 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m10:00:24.887617 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 10:00:24.884615 => 10:00:24.887617
[0m10:00:24.887617 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m10:00:24.889935 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m10:00:24.889935 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:24.890941 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m10:00:25.558831 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e2a3d343-f383-4e55-ab61-b3088faab33f&page=queryresults
[0m10:00:25.592244 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:85fbae06-dbab-45c4-9704-a8137e1a9984&page=queryresults
[0m10:00:25.977363 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 10:00:24.838798 => 10:00:25.976361
[0m10:00:25.978361 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF67D700>]}
[0m10:00:25.979807 [info ] [Thread-2  ]: 7 of 19 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m10:00:25.980915 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:25.981930 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m10:00:25.982926 [info ] [Thread-2  ]: 9 of 19 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m10:00:25.983860 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m10:00:25.984876 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m10:00:25.990291 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m10:00:25.992302 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 10:00:25.984876 => 10:00:25.992302
[0m10:00:25.993301 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m10:00:25.998296 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m10:00:26.003293 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 10:00:24.887617 => 10:00:26.002294
[0m10:00:26.004292 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0C06AC2B0>]}
[0m10:00:26.004292 [info ] [Thread-1  ]: 8 of 19 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m10:00:26.006291 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m10:00:26.006291 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m10:00:26.007336 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:26.006291 [info ] [Thread-1  ]: 10 of 19 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m10:00:26.008328 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_tempo)
[0m10:00:26.008328 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m10:00:26.013386 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m10:00:26.015390 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m10:00:26.036961 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 10:00:26.009332 => 10:00:26.036961
[0m10:00:26.038000 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m10:00:26.043817 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m10:00:26.044805 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:26.045823 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m10:00:26.787324 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:494da378-dbef-4a26-a572-d2cd37b57a64&page=queryresults
[0m10:00:26.803626 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:326a2c63-bfdb-4ceb-b657-334002d574b8&page=queryresults
[0m10:00:27.203725 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 10:00:26.038000 => 10:00:27.203725
[0m10:00:27.204726 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF64C8E0>]}
[0m10:00:27.206728 [info ] [Thread-1  ]: 10 of 19 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m10:00:27.208738 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m10:00:27.209725 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m10:00:27.210240 [info ] [Thread-1  ]: 11 of 19 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m10:00:27.212258 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_venda_produto_base)
[0m10:00:27.213257 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m10:00:27.218356 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m10:00:27.223005 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 10:00:25.993301 => 10:00:27.222001
[0m10:00:27.224004 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF64C3D0>]}
[0m10:00:27.225007 [info ] [Thread-2  ]: 9 of 19 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m10:00:27.226931 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m10:00:27.227829 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 10:00:27.213257 => 10:00:27.227829
[0m10:00:27.228830 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m10:00:27.247218 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:27.248216 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m10:00:27.249131 [info ] [Thread-2  ]: 12 of 19 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m10:00:27.250815 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m10:00:27.251809 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m10:00:27.257805 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m10:00:27.288584 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 10:00:27.252921 => 10:00:27.287523
[0m10:00:27.288584 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m10:00:27.289630 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:27.975958 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m10:00:27.976977 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m10:00:27.978021 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m10:00:27.979516 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `dbt_dw_az.tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `dbt_dw_az.tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_pedidos_mes_atual
          ,qt_pecas_mes_atual
          ,vl_total_mes_atual
          ,qt_pedidos_mes_anterior
          ,qt_pecas_mes_anterior
          ,vl_total_mes_anterior
          ,qt_pedidos_tres_meses
          ,qt_pecas_tres_meses
          ,vl_total_tres_meses
          ,qt_pedidos_seis_meses
          ,qt_pecas_seis_meses
          ,vl_total_seis_meses
      from `dbt_dw_az.tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)       as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                   as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)       as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                   as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo) as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                 as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                      as qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.qt_pedidos_mes_atual
         ,b.qt_pecas_mes_atual
         ,b.vl_total_mes_atual
         ,b.qt_pedidos_mes_anterior
         ,b.qt_pecas_mes_anterior
         ,b.vl_total_mes_anterior
         ,b.qt_pedidos_tres_meses
         ,b.qt_pecas_tres_meses
         ,b.vl_total_tres_meses
         ,b.qt_pedidos_seis_meses
         ,b.qt_pecas_seis_meses
         ,b.vl_total_seis_meses
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
    );
  
[0m10:00:28.413580 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9c6ea8e7-53e1-442e-bd63-781d15856b0c&page=queryresults
[0m10:00:28.644655 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f1a5ad8c-3dff-440c-ab13-aa3746fab4a4&page=queryresults
[0m10:00:30.394933 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 10:00:27.228830 => 10:00:30.394933
[0m10:00:30.394933 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0C067FA00>]}
[0m10:00:30.395943 [info ] [Thread-1  ]: 11 of 19 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (480.0 rows, 141.0 KiB processed)[0m in 3.18s]
[0m10:00:30.396942 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m10:00:31.782743 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 10:00:27.288584 => 10:00:31.782743
[0m10:00:31.784756 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0C07BDD60>]}
[0m10:00:31.785746 [info ] [Thread-2  ]: 12 of 19 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 4.53s]
[0m10:00:31.786745 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m10:00:31.788747 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m10:00:31.788747 [info ] [Thread-1  ]: 13 of 19 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m10:00:31.791242 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_base, now model.shibaribrasil.tb_produto)
[0m10:00:31.791242 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m10:00:31.806754 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m10:00:31.808757 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 10:00:31.792249 => 10:00:31.807756
[0m10:00:31.808757 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m10:00:31.812291 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:32.457207 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m10:00:32.460114 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m10:00:33.165259 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:70b57e60-8a02-4f1f-b831-d91183c7e4aa&page=queryresults
[0m10:00:35.702769 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 10:00:31.810277 => 10:00:35.702769
[0m10:00:35.702769 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0C074ABB0>]}
[0m10:00:35.703772 [info ] [Thread-1  ]: 13 of 19 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 3.91s]
[0m10:00:35.704766 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m10:00:35.705688 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m10:00:35.706694 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m10:00:35.705688 [info ] [Thread-2  ]: 14 of 19 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m10:00:35.707488 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m10:00:35.706694 [info ] [Thread-1  ]: 15 of 19 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m10:00:35.708525 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m10:00:35.708525 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m10:00:35.712784 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m10:00:35.712784 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m10:00:35.715780 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m10:00:35.716779 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 10:00:35.708525 => 10:00:35.716779
[0m10:00:35.716779 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m10:00:35.717789 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 10:00:35.713801 => 10:00:35.716779
[0m10:00:35.718802 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:35.719789 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m10:00:35.721802 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:36.603299 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m10:00:36.608289 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m10:00:36.611130 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m10:00:36.617133 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m10:00:37.056654 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2e02538a-e8f5-4709-8723-86d8e8dfa44f&page=queryresults
[0m10:00:37.286457 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:52a8010f-62c4-42b9-8b3b-dffe20fb6916&page=queryresults
[0m10:00:40.146679 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 10:00:35.717789 => 10:00:40.145679
[0m10:00:40.147679 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF64EB50>]}
[0m10:00:40.147679 [info ] [Thread-2  ]: 14 of 19 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (233.0 rows, 108.6 KiB processed)[0m in 4.44s]
[0m10:00:40.148673 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m10:00:40.149674 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m10:00:40.150685 [info ] [Thread-2  ]: 16 of 19 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m10:00:40.151680 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_pedido)
[0m10:00:40.151680 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m10:00:40.159673 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m10:00:40.160674 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 10:00:40.151680 => 10:00:40.160674
[0m10:00:40.160674 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m10:00:40.162772 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:40.721475 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 10:00:35.720784 => 10:00:40.720360
[0m10:00:40.723514 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF64E070>]}
[0m10:00:40.724508 [info ] [Thread-1  ]: 15 of 19 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 82.4 KiB processed)[0m in 5.01s]
[0m10:00:40.726511 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m10:00:40.727511 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m10:00:40.728508 [info ] [Thread-1  ]: 17 of 19 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m10:00:40.731130 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_preco_produto)
[0m10:00:40.732158 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m10:00:40.739642 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m10:00:40.741662 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 10:00:40.732158 => 10:00:40.740728
[0m10:00:40.741662 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m10:00:40.744780 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:40.826537 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m10:00:40.828506 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m10:00:41.432948 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m10:00:41.434948 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m10:00:41.484856 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ed448acc-a652-4903-8249-0565cc45ba25&page=queryresults
[0m10:00:42.159489 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ba1a24de-73f3-41b9-8542-ff4b2629db7a&page=queryresults
[0m10:00:45.535328 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 10:00:40.741662 => 10:00:45.534395
[0m10:00:45.537357 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF64E070>]}
[0m10:00:45.538317 [info ] [Thread-1  ]: 17 of 19 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (309.0 rows, 81.0 KiB processed)[0m in 4.81s]
[0m10:00:45.540047 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m10:00:46.226796 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 10:00:40.161682 => 10:00:46.225787
[0m10:00:46.228788 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0C07B6370>]}
[0m10:00:46.229759 [info ] [Thread-2  ]: 16 of 19 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 6.08s]
[0m10:00:46.231459 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m10:00:46.233391 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m10:00:46.234479 [info ] [Thread-1  ]: 18 of 19 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m10:00:46.236477 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto, now model.shibaribrasil.tb_venda_produto_final)
[0m10:00:46.237471 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m10:00:46.244138 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m10:00:46.246077 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 10:00:46.237471 => 10:00:46.246077
[0m10:00:46.247053 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m10:00:46.249710 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:46.901963 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m10:00:46.902939 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m10:00:47.336588 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f1dea028-08fe-493f-bb8c-3dbe6cb9b623&page=queryresults
[0m10:00:50.136052 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 10:00:46.247053 => 10:00:50.136052
[0m10:00:50.137991 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF64C5B0>]}
[0m10:00:50.139031 [info ] [Thread-1  ]: 18 of 19 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 413.1 KiB processed)[0m in 3.90s]
[0m10:00:50.141531 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m10:00:50.142576 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:00:50.143545 [info ] [Thread-2  ]: 19 of 19 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m10:00:50.144540 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m10:00:50.144540 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:00:50.153069 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m10:00:50.154061 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 10:00:50.144540 => 10:00:50.154061
[0m10:00:50.155051 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:00:50.157063 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:50.867708 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m10:00:50.870246 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m10:00:51.257366 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:eaec0fbb-372e-41f5-8f10-d67451bac1b2&page=queryresults
[0m10:00:53.628881 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 10:00:50.155051 => 10:00:53.628881
[0m10:00:53.629880 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76e2bb92-d332-4eca-8dc3-5eee659c877d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0C1855220>]}
[0m10:00:53.629880 [info ] [Thread-2  ]: 19 of 19 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (320.0 rows, 266.9 KiB processed)[0m in 3.49s]
[0m10:00:53.630880 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:00:53.632915 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:00:53.633979 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:53.633979 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:53.634876 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m10:00:53.634876 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m10:00:53.634876 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_final' was properly closed.
[0m10:00:53.634876 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_agg_venda_produto_final' was properly closed.
[0m10:00:53.635876 [info ] [MainThread]: 
[0m10:00:53.635876 [info ] [MainThread]: Finished running 10 view models, 9 table models in 0 hours 0 minutes and 35.63 seconds (35.63s).
[0m10:00:53.638874 [debug] [MainThread]: Command end result
[0m10:00:53.648283 [info ] [MainThread]: 
[0m10:00:53.649342 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:00:53.649342 [info ] [MainThread]: 
[0m10:00:53.650348 [info ] [MainThread]: Done. PASS=19 WARN=0 ERROR=0 SKIP=0 TOTAL=19
[0m10:00:53.651317 [debug] [MainThread]: Command `dbt run` succeeded at 10:00:53.651317 after 40.28 seconds
[0m10:00:53.651317 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BBC83430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF3BCA90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F0BF34EE20>]}
[0m10:00:53.652286 [debug] [MainThread]: Flushing usage events
[0m10:00:57.011707 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000275FF9A3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002758241F670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002758241FD90>]}


============================== 10:00:57.015707 | 6abbe561-4272-4b35-89ee-7dc6ece4ad42 ==============================
[0m10:00:57.015707 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:00:57.015707 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m10:00:57.567991 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6abbe561-4272-4b35-89ee-7dc6ece4ad42', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027582408BB0>]}
[0m10:00:57.628846 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6abbe561-4272-4b35-89ee-7dc6ece4ad42', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027583148040>]}
[0m10:00:57.630855 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:00:57.637896 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:00:57.685237 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:00:57.685237 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:00:57.690050 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6abbe561-4272-4b35-89ee-7dc6ece4ad42', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027583434A30>]}
[0m10:00:57.700635 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6abbe561-4272-4b35-89ee-7dc6ece4ad42', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002758335D6D0>]}
[0m10:00:57.700635 [info ] [MainThread]: Found 20 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:00:57.701650 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6abbe561-4272-4b35-89ee-7dc6ece4ad42', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002758335D760>]}
[0m10:00:57.702695 [info ] [MainThread]: 
[0m10:00:57.703637 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:00:57.704705 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:57.704705 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:58.416043 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m10:00:58.416984 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:58.418943 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:00:58.420249 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:59.097314 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m10:00:59.098308 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:59.105293 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m10:00:59.106308 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:59.959148 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6abbe561-4272-4b35-89ee-7dc6ece4ad42', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000275830DD190>]}
[0m10:00:59.961134 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:00:59.962177 [info ] [MainThread]: 
[0m10:00:59.969112 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:00:59.970087 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m10:00:59.971086 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m10:00:59.971086 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:00:59.978099 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 10:00:59.972099 => 10:00:59.978099
[0m10:00:59.979081 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:01:00.028051 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:01:00.029421 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m10:01:00.951836 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:60c90e4f-11e1-47a0-84a6-d6076b0c1a8e&page=queryresults
[0m10:01:02.142135 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m10:01:02.585544 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e67ca582-8dd3-4347-8a1a-dbc67164597c&page=queryresults
[0m10:01:05.284350 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m10:01:06.152491 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m10:01:06.154497 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m10:01:06.576730 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c1b7ff11-e341-4b06-a725-5c00a48a2105&page=queryresults
[0m10:01:09.155672 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 10:00:59.979081 => 10:01:09.154676
[0m10:01:09.157674 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6abbe561-4272-4b35-89ee-7dc6ece4ad42', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000275834BDBE0>]}
[0m10:01:09.159679 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 66.0 KiB processed)[0m in 9.19s]
[0m10:01:09.161250 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:01:09.165295 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:01:09.165295 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:01:09.166297 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m10:01:09.167295 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m10:01:09.167295 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m10:01:09.168294 [info ] [MainThread]: 
[0m10:01:09.169652 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 11.47 seconds (11.47s).
[0m10:01:09.170697 [debug] [MainThread]: Command end result
[0m10:01:09.189844 [info ] [MainThread]: 
[0m10:01:09.190859 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:01:09.192861 [info ] [MainThread]: 
[0m10:01:09.194328 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m10:01:09.196062 [debug] [MainThread]: Command `dbt snapshot` succeeded at 10:01:09.196062 after 12.24 seconds
[0m10:01:09.197059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000275FF9A3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000275831CE610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000275831DCDF0>]}
[0m10:01:09.198062 [debug] [MainThread]: Flushing usage events
[0m10:01:12.222232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F5A713430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F596919D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F59691B80>]}


============================== 10:01:12.226193 | 7b5f5a51-9307-4e7e-8997-421ff2bd3761 ==============================
[0m10:01:12.226193 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:01:12.226193 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m10:01:12.739686 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7b5f5a51-9307-4e7e-8997-421ff2bd3761', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F577E1DC0>]}
[0m10:01:12.798395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7b5f5a51-9307-4e7e-8997-421ff2bd3761', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F5DD71C40>]}
[0m10:01:12.799933 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:01:12.806040 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:01:12.853053 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:01:12.854051 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:01:12.858128 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7b5f5a51-9307-4e7e-8997-421ff2bd3761', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F5E058250>]}
[0m10:01:12.868512 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7b5f5a51-9307-4e7e-8997-421ff2bd3761', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F5E0432B0>]}
[0m10:01:12.868512 [info ] [MainThread]: Found 20 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:01:12.869544 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7b5f5a51-9307-4e7e-8997-421ff2bd3761', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F5DD54D30>]}
[0m10:01:12.869928 [info ] [MainThread]: 
[0m10:01:12.871050 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:01:12.872071 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:01:12.873042 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:01:13.608293 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m10:01:13.609291 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:01:13.610935 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:01:13.612066 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:01:14.263749 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m10:01:14.268192 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:01:14.312975 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m10:01:14.312975 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:01:14.965677 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7b5f5a51-9307-4e7e-8997-421ff2bd3761', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F5DE41D60>]}
[0m10:01:14.967677 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:01:14.968665 [info ] [MainThread]: 
[0m10:01:14.976319 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:01:14.977323 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m10:01:14.979323 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m10:01:14.979954 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:01:14.994541 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m10:01:14.995529 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 10:01:14.979954 => 10:01:14.995529
[0m10:01:14.996441 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:01:15.011952 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:01:15.692911 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m10:01:15.693896 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m10:01:16.057632 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:25fe1199-d0c9-4f11-86ac-ec9f461f6054&page=queryresults
[0m10:01:18.057252 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 10:01:14.996441 => 10:01:18.057252
[0m10:01:18.058253 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7b5f5a51-9307-4e7e-8997-421ff2bd3761', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F5F0F69D0>]}
[0m10:01:18.059253 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (366.0 rows, 53.8 KiB processed)[0m in 3.08s]
[0m10:01:18.060252 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:01:18.062251 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:01:18.063251 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:01:18.063251 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m10:01:18.063251 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m10:01:18.063251 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m10:01:18.064349 [info ] [MainThread]: 
[0m10:01:18.065251 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.19 seconds (5.19s).
[0m10:01:18.065596 [debug] [MainThread]: Command end result
[0m10:01:18.074741 [info ] [MainThread]: 
[0m10:01:18.074741 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:01:18.075696 [info ] [MainThread]: 
[0m10:01:18.076753 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m10:01:18.077693 [debug] [MainThread]: Command `dbt run` succeeded at 10:01:18.077693 after 5.91 seconds
[0m10:01:18.077693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F5A713430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F5DD54F40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020F5DC93AF0>]}
[0m10:01:18.078729 [debug] [MainThread]: Flushing usage events
[0m10:39:53.916171 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84A5F6430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A8495756A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A849575DC0>]}


============================== 10:39:53.923693 | a0af14b0-4b87-42d4-a2f1-79b9c40eee1e ==============================
[0m10:39:53.923693 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:39:53.924014 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models dm_produto+', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:39:54.457538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a0af14b0-4b87-42d4-a2f1-79b9c40eee1e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A849566070>]}
[0m10:39:54.531413 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a0af14b0-4b87-42d4-a2f1-79b9c40eee1e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84DB4DA90>]}
[0m10:39:54.531413 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:39:54.531413 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:39:54.612948 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:39:54.620004 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\2.dw\dm_produto.sql
[0m10:39:54.732012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a0af14b0-4b87-42d4-a2f1-79b9c40eee1e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84E0D5F10>]}
[0m10:39:54.743708 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a0af14b0-4b87-42d4-a2f1-79b9c40eee1e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84DF293D0>]}
[0m10:39:54.744749 [info ] [MainThread]: Found 20 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:39:54.745726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a0af14b0-4b87-42d4-a2f1-79b9c40eee1e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84DBF8880>]}
[0m10:39:54.746722 [info ] [MainThread]: 
[0m10:39:54.747720 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:39:54.749548 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:39:54.750412 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:39:54.750791 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:39:54.751802 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:39:56.002835 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m10:39:56.002835 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:39:56.008874 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:39:56.010889 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:39:56.692147 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m10:39:56.692147 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:39:56.759605 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m10:39:56.759605 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:39:57.470912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a0af14b0-4b87-42d4-a2f1-79b9c40eee1e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84DF19EE0>]}
[0m10:39:57.486655 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:39:57.486655 [info ] [MainThread]: 
[0m10:39:57.486655 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m10:39:57.486655 [info ] [Thread-1  ]: 1 of 9 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m10:39:57.486655 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.dm_produto'
[0m10:39:57.486655 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m10:39:57.523503 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m10:39:57.527804 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 10:39:57.486655 => 10:39:57.525447
[0m10:39:57.529811 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m10:39:57.568812 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:39:58.240746 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m10:39:58.245579 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m10:39:58.914622 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:46074e1e-e0ed-4023-9dff-fbc49bfbf82b&page=queryresults
[0m10:40:01.825738 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 10:39:57.531358 => 10:40:01.825738
[0m10:40:01.826685 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a0af14b0-4b87-42d4-a2f1-79b9c40eee1e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84F10BEB0>]}
[0m10:40:01.826685 [info ] [Thread-1  ]: 1 of 9 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 4.34s]
[0m10:40:01.827901 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m10:40:01.827901 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m10:40:01.828895 [info ] [Thread-2  ]: 2 of 9 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m10:40:01.829769 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_produto'
[0m10:40:01.830349 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m10:40:01.839232 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m10:40:01.841623 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 10:40:01.830654 => 10:40:01.840231
[0m10:40:01.843222 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m10:40:01.848118 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:40:02.506858 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m10:40:02.506858 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m10:40:03.181611 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c2b6a82e-f51e-483d-b241-c279cf3d10f6&page=queryresults
[0m10:40:05.751736 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 10:40:01.843530 => 10:40:05.751736
[0m10:40:05.751736 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a0af14b0-4b87-42d4-a2f1-79b9c40eee1e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84F144CA0>]}
[0m10:40:05.751736 [info ] [Thread-2  ]: 2 of 9 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 3.92s]
[0m10:40:05.751736 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m10:40:05.767637 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m10:40:05.767637 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m10:40:05.767637 [info ] [Thread-1  ]: 3 of 9 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m10:40:05.767637 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m10:40:05.767637 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m10:40:05.767637 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m10:40:05.767637 [info ] [Thread-2  ]: 4 of 9 START sql table model dbt_dw_az.tb_estoque_geral ........................ [RUN]
[0m10:40:05.767637 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m10:40:05.767637 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m10:40:05.787706 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m10:40:05.789750 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 10:40:05.767637 => 10:40:05.789750
[0m10:40:05.789750 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m10:40:05.793609 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:40:05.820437 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 10:40:05.767637 => 10:40:05.820437
[0m10:40:05.820437 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m10:40:05.820437 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:40:06.712707 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m10:40:06.714717 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m10:40:06.751713 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m10:40:06.754137 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m10:40:07.121849 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:114a0cf7-5157-4bdd-a40b-66b0d6be3c5d&page=queryresults
[0m10:40:07.401477 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:622be180-1ca4-4dcf-897d-983e29896ca3&page=queryresults
[0m10:40:09.417931 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 10:40:05.820437 => 10:40:09.417931
[0m10:40:09.419956 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a0af14b0-4b87-42d4-a2f1-79b9c40eee1e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84F189FA0>]}
[0m10:40:09.419956 [info ] [Thread-2  ]: 4 of 9 OK created sql table model dbt_dw_az.tb_estoque_geral ................... [[32mCREATE TABLE (359.0 rows, 82.4 KiB processed)[0m in 3.65s]
[0m10:40:09.421976 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m10:40:09.423997 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:40:09.423997 [info ] [Thread-2  ]: 5 of 9 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m10:40:09.425764 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_hist_preco_custo_produto)
[0m10:40:09.427787 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:40:09.435864 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m10:40:09.437882 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 10:40:09.427787 => 10:40:09.435864
[0m10:40:09.437882 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:40:09.439901 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:40:09.629707 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 10:40:05.791013 => 10:40:09.629707
[0m10:40:09.630487 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a0af14b0-4b87-42d4-a2f1-79b9c40eee1e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84F13C940>]}
[0m10:40:09.631643 [info ] [Thread-1  ]: 3 of 9 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (244.0 rows, 108.6 KiB processed)[0m in 3.86s]
[0m10:40:09.632618 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m10:40:09.633082 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m10:40:09.633082 [info ] [Thread-1  ]: 6 of 9 START sql table model dbt_dw_az.tb_pedido ............................... [RUN]
[0m10:40:09.635135 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_pedido)
[0m10:40:09.635135 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m10:40:09.638251 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m10:40:09.639237 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 10:40:09.635135 => 10:40:09.638251
[0m10:40:09.639237 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m10:40:09.641343 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:40:10.072274 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m10:40:10.073284 [debug] [Thread-2  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m10:40:10.276768 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m10:40:10.277864 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m10:40:10.481810 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3ef35980-97cf-4c29-a71d-1f89e1b85e0d&page=queryresults
[0m10:40:10.871138 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6c9cf07d-495f-4f32-b1ce-6116ebefb681&page=queryresults
[0m10:40:12.430852 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 10:40:09.437882 => 10:40:12.430852
[0m10:40:12.430852 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a0af14b0-4b87-42d4-a2f1-79b9c40eee1e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84F218490>]}
[0m10:40:12.430852 [info ] [Thread-2  ]: 5 of 9 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (366.0 rows, 53.8 KiB processed)[0m in 3.01s]
[0m10:40:12.430852 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:40:12.430852 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m10:40:12.446196 [info ] [Thread-2  ]: 7 of 9 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m10:40:12.448715 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_hist_preco_custo_produto, now model.shibaribrasil.tb_preco_produto)
[0m10:40:12.449558 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m10:40:12.461258 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m10:40:12.465296 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 10:40:12.451753 => 10:40:12.463285
[0m10:40:12.466278 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m10:40:12.471230 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:40:13.204405 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m10:40:13.208505 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m10:40:13.889775 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:550bdb66-a7b0-412f-ade7-f3e44603f4c6&page=queryresults
[0m10:40:14.028206 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 10:40:09.639237 => 10:40:14.027206
[0m10:40:14.030196 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a0af14b0-4b87-42d4-a2f1-79b9c40eee1e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84F13C610>]}
[0m10:40:14.032192 [info ] [Thread-1  ]: 6 of 9 OK created sql table model dbt_dw_az.tb_pedido .......................... [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 4.40s]
[0m10:40:14.034206 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m10:40:14.036206 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m10:40:14.037206 [info ] [Thread-1  ]: 8 of 9 START sql table model dbt_dw_az.tb_venda_produto_final .................. [RUN]
[0m10:40:14.040210 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m10:40:14.041208 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m10:40:14.064312 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m10:40:14.073201 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 10:40:14.042206 => 10:40:14.071204
[0m10:40:14.076202 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m10:40:14.089199 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:40:14.785719 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m10:40:14.786824 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m10:40:15.161367 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f68690c4-e623-4d0b-beb9-fc8afeddf96e&page=queryresults
[0m10:40:17.069603 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 10:40:12.467300 => 10:40:17.068601
[0m10:40:17.070597 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a0af14b0-4b87-42d4-a2f1-79b9c40eee1e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84F13C7C0>]}
[0m10:40:17.072602 [info ] [Thread-2  ]: 7 of 9 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (309.0 rows, 81.0 KiB processed)[0m in 4.62s]
[0m10:40:17.073599 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m10:40:19.807251 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 10:40:14.078203 => 10:40:19.806280
[0m10:40:19.809265 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a0af14b0-4b87-42d4-a2f1-79b9c40eee1e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84F13C940>]}
[0m10:40:19.811261 [info ] [Thread-1  ]: 8 of 9 OK created sql table model dbt_dw_az.tb_venda_produto_final ............. [[32mCREATE TABLE (1.2k rows, 413.1 KiB processed)[0m in 5.77s]
[0m10:40:19.814312 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m10:40:19.816344 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:40:19.817264 [info ] [Thread-2  ]: 9 of 9 START sql table model dbt_dw_az.tb_agg_venda_produto_final .............. [RUN]
[0m10:40:19.819258 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m10:40:19.820253 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:40:19.827251 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m10:40:19.829248 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 10:40:19.820253 => 10:40:19.829248
[0m10:40:19.830255 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:40:19.837263 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:40:20.593052 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m10:40:20.598053 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m10:40:20.979414 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2fb69c70-a9a9-40b2-8f12-05111996f4ce&page=queryresults
[0m10:40:23.208719 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 10:40:19.831268 => 10:40:23.207723
[0m10:40:23.211727 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a0af14b0-4b87-42d4-a2f1-79b9c40eee1e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84F207790>]}
[0m10:40:23.213729 [info ] [Thread-2  ]: 9 of 9 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ......... [[32mCREATE TABLE (320.0 rows, 266.9 KiB processed)[0m in 3.39s]
[0m10:40:23.216724 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:40:23.221800 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:40:23.223800 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:40:23.224806 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:40:23.225809 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m10:40:23.227737 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m10:40:23.228718 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_final' was properly closed.
[0m10:40:23.230685 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_agg_venda_produto_final' was properly closed.
[0m10:40:23.232686 [info ] [MainThread]: 
[0m10:40:23.235694 [info ] [MainThread]: Finished running 9 table models in 0 hours 0 minutes and 28.48 seconds (28.48s).
[0m10:40:23.246722 [debug] [MainThread]: Command end result
[0m10:40:23.315591 [info ] [MainThread]: 
[0m10:40:23.317138 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:40:23.319145 [info ] [MainThread]: 
[0m10:40:23.321151 [info ] [MainThread]: Done. PASS=9 WARN=0 ERROR=0 SKIP=0 TOTAL=9
[0m10:40:23.326184 [debug] [MainThread]: Command `dbt run` succeeded at 10:40:23.326184 after 29.50 seconds
[0m10:40:23.327185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84A5F6430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84DCC4D30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002A84DE35BB0>]}
[0m10:40:23.328181 [debug] [MainThread]: Flushing usage events
[0m10:43:53.223168 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B146CC460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B136529D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B13652B80>]}


============================== 10:43:53.226170 | ce937eb9-3ea8-4b40-a1be-499f89d4e2af ==============================
[0m10:43:53.226170 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:43:53.227171 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models tb_venda_produto_base', 'send_anonymous_usage_stats': 'True'}
[0m10:43:53.641357 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ce937eb9-3ea8-4b40-a1be-499f89d4e2af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B1364E9A0>]}
[0m10:43:53.705360 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ce937eb9-3ea8-4b40-a1be-499f89d4e2af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B17CD7370>]}
[0m10:43:53.706373 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:43:53.713581 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:43:53.888196 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:43:53.889195 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_venda_produto_base.sql
[0m10:43:54.024872 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ce937eb9-3ea8-4b40-a1be-499f89d4e2af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B181B68B0>]}
[0m10:43:54.035868 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ce937eb9-3ea8-4b40-a1be-499f89d4e2af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B18003040>]}
[0m10:43:54.036929 [info ] [MainThread]: Found 20 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:43:54.036929 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ce937eb9-3ea8-4b40-a1be-499f89d4e2af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B18003070>]}
[0m10:43:54.037905 [info ] [MainThread]: 
[0m10:43:54.038971 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:43:54.040973 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:43:54.040973 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:43:54.787223 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m10:43:54.788221 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:43:54.791227 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m10:43:54.793234 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:43:55.534479 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m10:43:55.535484 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:43:55.581450 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m10:43:55.581450 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:43:56.260782 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ce937eb9-3ea8-4b40-a1be-499f89d4e2af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B17C958B0>]}
[0m10:43:56.261789 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:43:56.263794 [info ] [MainThread]: 
[0m10:43:56.271803 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m10:43:56.272797 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_venda_produto_base ................... [RUN]
[0m10:43:56.274796 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_venda_produto_base'
[0m10:43:56.275796 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m10:43:56.290749 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m10:43:56.291740 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 10:43:56.275796 => 10:43:56.290749
[0m10:43:56.292747 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m10:43:56.307149 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:43:57.107712 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m10:43:57.108707 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)    as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)      as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)      as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0) as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)   as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)   as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)   as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)     as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)     as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)   as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)     as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)     as vl_total_seis_meses
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
)

  select *
    from cte_base_final
order by nm_produto
    );
  
[0m10:43:57.512611 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9a93bb21-bada-4a3d-b4ea-ab8c4ff469b7&page=queryresults
[0m10:43:59.848790 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 10:43:56.292747 => 10:43:59.848790
[0m10:43:59.849791 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ce937eb9-3ea8-4b40-a1be-499f89d4e2af', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B191E28E0>]}
[0m10:43:59.850779 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_venda_produto_base .............. [[32mCREATE TABLE (236.0 rows, 121.1 KiB processed)[0m in 3.58s]
[0m10:43:59.851776 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m10:43:59.854691 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:43:59.854691 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:43:59.855692 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m10:43:59.856692 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m10:43:59.857693 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m10:43:59.857693 [info ] [MainThread]: 
[0m10:43:59.859740 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.82 seconds (5.82s).
[0m10:43:59.861816 [debug] [MainThread]: Command end result
[0m10:43:59.890697 [info ] [MainThread]: 
[0m10:43:59.892695 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:43:59.893690 [info ] [MainThread]: 
[0m10:43:59.893690 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m10:43:59.894704 [debug] [MainThread]: Command `dbt run` succeeded at 10:43:59.894704 after 6.74 seconds
[0m10:43:59.894704 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B146CC460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B180C7B80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021B17F69FD0>]}
[0m10:43:59.895704 [debug] [MainThread]: Flushing usage events
[0m11:00:06.048596 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A31C4B430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A30BC66D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A30BC6E20>]}


============================== 11:00:06.057594 | 4c226854-90cf-4117-8329-e1de6b04e8a1 ==============================
[0m11:00:06.057594 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:00:06.058590 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m11:00:07.003995 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A33D9AB50>]}
[0m11:00:07.072995 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A353ACE50>]}
[0m11:00:07.074997 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:00:07.085995 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:00:07.201066 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:00:07.202066 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:00:07.211246 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A355A5FA0>]}
[0m11:00:07.244242 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A352680A0>]}
[0m11:00:07.245258 [info ] [MainThread]: Found 20 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:00:07.246242 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A35268A90>]}
[0m11:00:07.249249 [info ] [MainThread]: 
[0m11:00:07.250199 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:00:07.253258 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:07.254239 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:07.256227 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:07.257234 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:08.272134 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:09.074994 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m11:00:09.075996 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:09.076997 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m11:00:09.077965 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:09.781522 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m11:00:09.783510 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:09.825463 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m11:00:09.826463 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:10.481553 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A35595B80>]}
[0m11:00:10.482557 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:00:10.483593 [info ] [MainThread]: 
[0m11:00:10.487583 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:10.487583 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m11:00:10.488552 [info ] [Thread-1  ]: 1 of 19 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m11:00:10.490555 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m11:00:10.488552 [info ] [Thread-2  ]: 2 of 19 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m11:00:10.491566 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:10.492563 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m11:00:10.509565 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m11:00:10.510464 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m11:00:10.514460 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 11:00:10.492563 => 11:00:10.514460
[0m11:00:10.516460 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:10.561460 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m11:00:10.579463 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m11:00:10.582466 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 11:00:10.511463 => 11:00:10.581465
[0m11:00:10.583463 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m11:00:10.591521 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m11:00:10.592511 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:00:10.593526 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m11:00:10.596521 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m11:00:10.619519 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m11:00:11.417654 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9c6bb6a9-efc7-407c-a4ad-0360cb3d3ef2&page=queryresults
[0m11:00:11.423700 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ea1e511c-a990-476a-8098-9cbe5189221e&page=queryresults
[0m11:00:11.906103 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 11:00:10.584463 => 11:00:11.906103
[0m11:00:11.907100 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A3565D7F0>]}
[0m11:00:11.909097 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 11:00:10.517460 => 11:00:11.909097
[0m11:00:11.910101 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A355A8A00>]}
[0m11:00:11.909097 [info ] [Thread-2  ]: 2 of 19 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m11:00:11.911097 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m11:00:11.910101 [info ] [Thread-1  ]: 1 of 19 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m11:00:11.911097 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m11:00:11.912099 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:11.912099 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m11:00:11.912099 [info ] [Thread-2  ]: 3 of 19 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m11:00:11.914044 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m11:00:11.914044 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m11:00:11.918043 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m11:00:11.913100 [info ] [Thread-1  ]: 4 of 19 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m11:00:11.919046 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m11:00:11.920087 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m11:00:11.926077 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m11:00:11.928055 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 11:00:11.915043 => 11:00:11.927045
[0m11:00:11.929046 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m11:00:11.934044 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m11:00:11.936052 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 11:00:11.921096 => 11:00:11.935047
[0m11:00:11.936052 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m11:00:11.943043 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:11.947078 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m11:00:11.948043 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m11:00:11.987100 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:11.990085 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m11:00:12.741857 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3dcaf193-0a25-4fef-bc30-4170174f4b38&page=queryresults
[0m11:00:12.778790 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0c82c08f-a69d-468c-bbdf-9659ca6298c8&page=queryresults
[0m11:00:13.162828 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 11:00:11.930048 => 11:00:13.161830
[0m11:00:13.163829 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A35657460>]}
[0m11:00:13.164826 [info ] [Thread-2  ]: 3 of 19 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m11:00:13.166743 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m11:00:13.167745 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m11:00:13.168834 [info ] [Thread-2  ]: 5 of 19 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m11:00:13.169827 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m11:00:13.170831 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m11:00:13.177835 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m11:00:13.179745 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 11:00:13.171827 => 11:00:13.178834
[0m11:00:13.181734 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m11:00:13.184740 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 11:00:11.937042 => 11:00:13.184740
[0m11:00:13.187833 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m11:00:13.189736 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A356574F0>]}
[0m11:00:13.189736 [info ] [Thread-1  ]: 4 of 19 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m11:00:13.190795 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m11:00:13.191768 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m11:00:13.191768 [info ] [Thread-1  ]: 6 of 19 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m11:00:13.192768 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m11:00:13.193736 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m11:00:13.196735 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m11:00:13.197795 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:13.200801 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m11:00:13.241740 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 11:00:13.193736 => 11:00:13.240780
[0m11:00:13.243788 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m11:00:13.249802 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m11:00:13.252778 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:13.254793 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m11:00:13.982618 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:66d68e82-b699-4110-b726-f84ae3ada040&page=queryresults
[0m11:00:14.008621 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6f376851-07f0-4a35-a77c-17b9fbab99d1&page=queryresults
[0m11:00:14.433629 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 11:00:13.184740 => 11:00:14.433629
[0m11:00:14.435627 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A3672CA60>]}
[0m11:00:14.437624 [info ] [Thread-2  ]: 5 of 19 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m11:00:14.439624 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m11:00:14.440577 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:14.441627 [info ] [Thread-2  ]: 7 of 19 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m11:00:14.444622 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m11:00:14.445625 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:14.455632 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m11:00:14.458584 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 11:00:14.446624 => 11:00:14.457628
[0m11:00:14.459645 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:14.473627 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m11:00:14.477633 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 11:00:13.243788 => 11:00:14.476625
[0m11:00:14.478634 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A36769E80>]}
[0m11:00:14.480642 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:14.479625 [info ] [Thread-1  ]: 6 of 19 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m11:00:14.482650 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m11:00:14.482650 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m11:00:14.485628 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m11:00:14.483643 [info ] [Thread-1  ]: 8 of 19 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m11:00:14.505630 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m11:00:14.506616 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m11:00:14.508629 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m11:00:14.510645 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 11:00:14.506616 => 11:00:14.509642
[0m11:00:14.510645 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m11:00:14.512626 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m11:00:14.513629 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:14.514541 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m11:00:15.386566 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1716407f-ee32-4b19-a423-f35ad2d9a11f&page=queryresults
[0m11:00:15.395566 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cfc16c10-c64b-4749-9797-4f48b57545d2&page=queryresults
[0m11:00:15.763842 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 11:00:14.459645 => 11:00:15.762842
[0m11:00:15.765804 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A366F50D0>]}
[0m11:00:15.766802 [info ] [Thread-2  ]: 7 of 19 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m11:00:15.768764 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:15.769759 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m11:00:15.771759 [info ] [Thread-2  ]: 9 of 19 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m11:00:15.773878 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m11:00:15.774880 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m11:00:15.783846 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m11:00:15.786751 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 11:00:15.775882 => 11:00:15.785843
[0m11:00:15.786751 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m11:00:15.794841 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m11:00:15.797809 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:15.803759 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m11:00:15.842812 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 11:00:14.510645 => 11:00:15.842812
[0m11:00:15.843813 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A366EC850>]}
[0m11:00:15.843813 [info ] [Thread-1  ]: 8 of 19 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m11:00:15.844818 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m11:00:15.845796 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m11:00:15.845796 [info ] [Thread-1  ]: 10 of 19 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m11:00:15.846809 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_tempo)
[0m11:00:15.846809 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m11:00:15.849800 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m11:00:15.851753 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 11:00:15.846809 => 11:00:15.851753
[0m11:00:15.852756 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m11:00:15.858755 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m11:00:15.860758 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:15.864754 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m11:00:16.600055 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:81c2aeed-5066-4d9b-ae3c-71fdbafc1c49&page=queryresults
[0m11:00:16.683093 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e0cbb798-7692-4e2d-8bb3-7fa06112bbe4&page=queryresults
[0m11:00:16.968641 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 11:00:15.787782 => 11:00:16.967644
[0m11:00:16.969644 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A367790A0>]}
[0m11:00:16.971683 [info ] [Thread-2  ]: 9 of 19 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m11:00:16.974686 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m11:00:16.976639 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m11:00:16.977686 [info ] [Thread-2  ]: 11 of 19 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m11:00:16.980685 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m11:00:16.981684 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m11:00:16.992691 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m11:00:16.995642 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 11:00:16.982685 => 11:00:16.995642
[0m11:00:16.996642 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m11:00:17.008689 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:17.082637 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 11:00:15.852756 => 11:00:17.081643
[0m11:00:17.083695 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A35657DF0>]}
[0m11:00:17.085687 [info ] [Thread-1  ]: 10 of 19 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m11:00:17.087687 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m11:00:17.720274 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m11:00:17.722272 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m11:00:18.373407 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:030a067d-acea-4b4c-b737-b2b10118e48c&page=queryresults
[0m11:00:21.221259 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 11:00:16.997691 => 11:00:21.221259
[0m11:00:21.223260 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A36774CA0>]}
[0m11:00:21.224259 [info ] [Thread-2  ]: 11 of 19 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 4.24s]
[0m11:00:21.226263 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m11:00:21.227266 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m11:00:21.228266 [info ] [Thread-1  ]: 12 of 19 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m11:00:21.230218 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m11:00:21.231264 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m11:00:21.243263 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m11:00:21.246268 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 11:00:21.232267 => 11:00:21.245276
[0m11:00:21.247265 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m11:00:21.253264 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:21.929264 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m11:00:21.932177 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m11:00:22.607256 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6ba5762f-5a65-4932-a2e0-7b6c7e1f5c2d&page=queryresults
[0m11:00:25.455942 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 11:00:21.248275 => 11:00:25.454947
[0m11:00:25.457951 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A366F8040>]}
[0m11:00:25.458941 [info ] [Thread-1  ]: 12 of 19 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 4.23s]
[0m11:00:25.460939 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m11:00:25.462940 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m11:00:25.462940 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m11:00:25.464940 [info ] [Thread-2  ]: 13 of 19 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m11:00:25.466944 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m11:00:25.465946 [info ] [Thread-1  ]: 14 of 19 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m11:00:25.467942 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m11:00:25.469949 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m11:00:25.479887 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m11:00:25.480953 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m11:00:25.489918 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 11:00:25.470898 => 11:00:25.488906
[0m11:00:25.496857 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m11:00:25.497853 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m11:00:25.501853 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:25.534936 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 11:00:25.481937 => 11:00:25.534936
[0m11:00:25.535909 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m11:00:25.539899 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:26.210383 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m11:00:26.212383 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m11:00:26.216382 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m11:00:26.217381 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m11:00:26.600874 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:48b0f66a-8cc0-44da-bafc-287ae4252967&page=queryresults
[0m11:00:26.756262 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:50ae138f-6290-433c-8c73-de85d833a48d&page=queryresults
[0m11:00:28.680289 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 11:00:25.497853 => 11:00:28.679313
[0m11:00:28.681399 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A3564BEE0>]}
[0m11:00:28.681399 [info ] [Thread-2  ]: 13 of 19 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 108.6 KiB processed)[0m in 3.21s]
[0m11:00:28.682414 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m11:00:28.683400 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m11:00:28.684413 [info ] [Thread-2  ]: 15 of 19 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m11:00:28.685412 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_pedido)
[0m11:00:28.686389 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m11:00:28.693409 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m11:00:28.694396 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 11:00:28.686389 => 11:00:28.694396
[0m11:00:28.694396 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m11:00:28.696396 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:29.416166 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m11:00:29.418136 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m11:00:30.237209 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:847c56d4-645f-4dfc-bb99-7f58f52bd413&page=queryresults
[0m11:00:32.015012 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 11:00:25.535909 => 11:00:32.015012
[0m11:00:32.017995 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A367EB190>]}
[0m11:00:32.019984 [info ] [Thread-1  ]: 14 of 19 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 82.4 KiB processed)[0m in 6.55s]
[0m11:00:32.023007 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m11:00:32.024010 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m11:00:32.026014 [info ] [Thread-1  ]: 16 of 19 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m11:00:32.029011 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_preco_produto)
[0m11:00:32.030973 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m11:00:32.042927 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m11:00:32.046930 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 11:00:32.032011 => 11:00:32.045928
[0m11:00:32.047972 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m11:00:32.056979 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:32.914361 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m11:00:32.918276 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m11:00:33.072308 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 11:00:28.695407 => 11:00:33.072308
[0m11:00:33.074316 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A3564BEE0>]}
[0m11:00:33.075295 [info ] [Thread-2  ]: 15 of 19 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 4.39s]
[0m11:00:33.077297 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m11:00:33.078267 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m11:00:33.079303 [info ] [Thread-2  ]: 17 of 19 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m11:00:33.080567 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m11:00:33.081580 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m11:00:33.085577 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m11:00:33.087575 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 11:00:33.081580 => 11:00:33.086579
[0m11:00:33.087575 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m11:00:33.090578 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:33.607606 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:95a988bf-334b-4213-b001-10537bdc3fe0&page=queryresults
[0m11:00:33.888554 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m11:00:33.890558 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m11:00:34.360966 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:26076d07-65a8-4a9b-bf05-50eb05c0ab31&page=queryresults
[0m11:00:36.638636 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 11:00:33.087575 => 11:00:36.635686
[0m11:00:36.641633 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A36843340>]}
[0m11:00:36.642635 [info ] [Thread-2  ]: 17 of 19 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 413.1 KiB processed)[0m in 3.56s]
[0m11:00:36.646640 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m11:00:36.648635 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m11:00:36.650637 [info ] [Thread-2  ]: 18 of 19 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m11:00:36.654637 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m11:00:36.656634 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m11:00:36.666634 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m11:00:36.669640 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 11:00:36.656634 => 11:00:36.668635
[0m11:00:36.670681 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m11:00:36.676694 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:37.076199 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 11:00:32.047972 => 11:00:37.076199
[0m11:00:37.077202 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A366F80A0>]}
[0m11:00:37.078198 [info ] [Thread-1  ]: 16 of 19 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (309.0 rows, 81.0 KiB processed)[0m in 5.05s]
[0m11:00:37.080211 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m11:00:37.396338 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m11:00:37.399331 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m11:00:37.762058 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d64cd6af-33ae-49c9-897e-2372f7f4b294&page=queryresults
[0m11:00:40.289497 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 11:00:36.671696 => 11:00:40.288475
[0m11:00:40.291502 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A367CA430>]}
[0m11:00:40.294506 [info ] [Thread-2  ]: 18 of 19 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (320.0 rows, 266.9 KiB processed)[0m in 3.64s]
[0m11:00:40.298573 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m11:00:40.302602 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m11:00:40.304611 [info ] [Thread-1  ]: 19 of 19 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m11:00:40.309718 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto, now model.shibaribrasil.tb_venda_produto_base)
[0m11:00:40.311719 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m11:00:40.323484 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m11:00:40.327024 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 11:00:40.312759 => 11:00:40.327024
[0m11:00:40.329591 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m11:00:40.346856 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:41.008090 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m11:00:41.011099 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)    as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)      as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)      as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0) as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)   as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)   as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)   as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)     as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)     as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)   as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)     as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)     as vl_total_seis_meses
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
)

  select *
    from cte_base_final
order by nm_produto
    );
  
[0m11:00:41.385277 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a7662fda-0d13-4dc2-b3eb-25c241850369&page=queryresults
[0m11:00:43.922082 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 11:00:40.330597 => 11:00:43.921085
[0m11:00:43.926770 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c226854-90cf-4117-8329-e1de6b04e8a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A3686BAF0>]}
[0m11:00:43.931140 [info ] [Thread-1  ]: 19 of 19 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (236.0 rows, 121.1 KiB processed)[0m in 3.62s]
[0m11:00:43.936832 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m11:00:43.944499 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:00:43.947181 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:00:43.949187 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:00:43.950099 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m11:00:43.952144 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m11:00:43.954143 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m11:00:43.956150 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_agg_venda_produto_final' was properly closed.
[0m11:00:43.956734 [info ] [MainThread]: 
[0m11:00:43.959364 [info ] [MainThread]: Finished running 10 view models, 9 table models in 0 hours 0 minutes and 36.71 seconds (36.71s).
[0m11:00:43.976572 [debug] [MainThread]: Command end result
[0m11:00:44.024205 [info ] [MainThread]: 
[0m11:00:44.026854 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:00:44.030926 [info ] [MainThread]: 
[0m11:00:44.033973 [info ] [MainThread]: Done. PASS=19 WARN=0 ERROR=0 SKIP=0 TOTAL=19
[0m11:00:44.038077 [debug] [MainThread]: Command `dbt run` succeeded at 11:00:44.038077 after 38.05 seconds
[0m11:00:44.040155 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A31C4B430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A35339F70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024A354D9040>]}
[0m11:00:44.042166 [debug] [MainThread]: Flushing usage events
[0m11:00:48.952492 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019636652460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000196355C7670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000196355C7D90>]}


============================== 11:00:48.956065 | cf1cadc9-2585-4992-9cc7-0fe432fe1ac0 ==============================
[0m11:00:48.956065 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:00:48.957083 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:00:49.603453 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cf1cadc9-2585-4992-9cc7-0fe432fe1ac0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001963879AB80>]}
[0m11:00:49.677209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cf1cadc9-2585-4992-9cc7-0fe432fe1ac0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019639D96E20>]}
[0m11:00:49.678224 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:00:49.686267 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:00:49.774211 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:00:49.774211 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:00:49.779259 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cf1cadc9-2585-4992-9cc7-0fe432fe1ac0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019639F94FA0>]}
[0m11:00:49.790512 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cf1cadc9-2585-4992-9cc7-0fe432fe1ac0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019639C5A0A0>]}
[0m11:00:49.791510 [info ] [MainThread]: Found 20 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:00:49.792570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cf1cadc9-2585-4992-9cc7-0fe432fe1ac0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019639C5AA60>]}
[0m11:00:49.794516 [info ] [MainThread]: 
[0m11:00:49.794516 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:00:49.797158 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:49.797158 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:50.564555 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m11:00:50.566062 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:50.567103 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m11:00:50.568134 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:51.505257 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m11:00:51.515333 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:51.520380 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m11:00:51.521387 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:52.293411 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cf1cadc9-2585-4992-9cc7-0fe432fe1ac0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019639D18490>]}
[0m11:00:52.295995 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:00:52.298030 [info ] [MainThread]: 
[0m11:00:52.306537 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:00:52.308064 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m11:00:52.311086 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m11:00:52.312081 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:00:52.330543 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 11:00:52.313084 => 11:00:52.329462
[0m11:00:52.333519 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:00:52.398210 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:00:52.400274 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m11:00:53.195960 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:552f835c-0765-4778-9893-41ab0a87d2cf&page=queryresults
[0m11:00:54.500158 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m11:00:55.003366 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:58cdd459-1cf9-4d61-98f3-8a898d0be831&page=queryresults
[0m11:00:58.357674 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m11:00:59.190492 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m11:00:59.194481 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m11:00:59.578332 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a9da15ad-75d0-4461-a326-2a17f85026fb&page=queryresults
[0m11:01:01.628377 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 11:00:52.334515 => 11:01:01.626820
[0m11:01:01.630473 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cf1cadc9-2585-4992-9cc7-0fe432fe1ac0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001963A01B4C0>]}
[0m11:01:01.631487 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 66.0 KiB processed)[0m in 9.32s]
[0m11:01:01.632503 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:01:01.634483 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:01:01.634483 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:01:01.634483 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m11:01:01.636087 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m11:01:01.636087 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m11:01:01.637181 [info ] [MainThread]: 
[0m11:01:01.637181 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 11.84 seconds (11.84s).
[0m11:01:01.638196 [debug] [MainThread]: Command end result
[0m11:01:01.652559 [info ] [MainThread]: 
[0m11:01:01.653508 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:01:01.654505 [info ] [MainThread]: 
[0m11:01:01.654505 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m11:01:01.656136 [debug] [MainThread]: Command `dbt snapshot` succeeded at 11:01:01.656136 after 12.79 seconds
[0m11:01:01.656136 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019636652460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019639D19F70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019639E900A0>]}
[0m11:01:01.657269 [debug] [MainThread]: Flushing usage events
[0m11:01:05.150568 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BE483400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BD40E640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BD40EAC0>]}


============================== 11:01:05.154705 | 822a5e60-9d20-40e1-abcd-eae66febec37 ==============================
[0m11:01:05.154705 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:01:05.154705 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m11:01:05.833282 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '822a5e60-9d20-40e1-abcd-eae66febec37', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BD3EEFD0>]}
[0m11:01:05.906093 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '822a5e60-9d20-40e1-abcd-eae66febec37', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2C19D77F0>]}
[0m11:01:05.908117 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:01:05.916995 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:01:05.972218 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:01:05.973215 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:01:05.978288 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '822a5e60-9d20-40e1-abcd-eae66febec37', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2C1DC5940>]}
[0m11:01:05.994441 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '822a5e60-9d20-40e1-abcd-eae66febec37', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2C1DB85B0>]}
[0m11:01:05.994441 [info ] [MainThread]: Found 20 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:01:05.996003 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '822a5e60-9d20-40e1-abcd-eae66febec37', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2C1DB8430>]}
[0m11:01:05.997077 [info ] [MainThread]: 
[0m11:01:05.997077 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:01:06.000620 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:01:06.000620 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:01:06.751720 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m11:01:06.753670 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:01:06.754669 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m11:01:06.758273 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:01:07.438214 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m11:01:07.451367 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m11:01:07.452361 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:01:07.456340 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:01:08.092281 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '822a5e60-9d20-40e1-abcd-eae66febec37', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2C1DF5C70>]}
[0m11:01:08.094932 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:01:08.095934 [info ] [MainThread]: 
[0m11:01:08.106172 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:01:08.107249 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m11:01:08.109195 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m11:01:08.110264 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:01:08.120896 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m11:01:08.121900 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 11:01:08.111245 => 11:01:08.121900
[0m11:01:08.122944 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:01:08.139432 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:01:08.870261 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m11:01:08.872223 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m11:01:09.226011 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2e23a1a6-19bc-4468-83af-ace4203951f0&page=queryresults
[0m11:01:11.157067 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 11:01:08.122944 => 11:01:11.157067
[0m11:01:11.158084 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '822a5e60-9d20-40e1-abcd-eae66febec37', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2C2E6CD30>]}
[0m11:01:11.159074 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (366.0 rows, 53.8 KiB processed)[0m in 3.05s]
[0m11:01:11.160052 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:01:11.162047 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:01:11.163048 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:01:11.163048 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m11:01:11.163048 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m11:01:11.164054 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m11:01:11.164054 [info ] [MainThread]: 
[0m11:01:11.165083 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.17 seconds (5.17s).
[0m11:01:11.166074 [debug] [MainThread]: Command end result
[0m11:01:11.179463 [info ] [MainThread]: 
[0m11:01:11.179463 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:01:11.180495 [info ] [MainThread]: 
[0m11:01:11.181481 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m11:01:11.182459 [debug] [MainThread]: Command `dbt run` succeeded at 11:01:11.182459 after 6.11 seconds
[0m11:01:11.183480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2BE483400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2C1DC5C40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2C1BA6730>]}
[0m11:01:11.183480 [debug] [MainThread]: Flushing usage events
[0m11:27:07.388851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAC5212430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAC41A2A30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAC41A2D60>]}


============================== 11:27:07.388851 | 45abd885-a990-4089-8d06-ebd05dc3549e ==============================
[0m11:27:07.388851 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:27:07.388851 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_estoque_produto_base', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:27:07.879961 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '45abd885-a990-4089-8d06-ebd05dc3549e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAC4195040>]}
[0m11:27:07.949782 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '45abd885-a990-4089-8d06-ebd05dc3549e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAC419E250>]}
[0m11:27:07.951948 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:27:07.951948 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:27:08.043149 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m11:27:08.043149 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\3.az\tb_estoque_produto_base.sql
[0m11:27:08.149962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '45abd885-a990-4089-8d06-ebd05dc3549e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAC8D07B20>]}
[0m11:27:08.160723 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '45abd885-a990-4089-8d06-ebd05dc3549e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAC8B48EE0>]}
[0m11:27:08.160723 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:27:08.160723 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '45abd885-a990-4089-8d06-ebd05dc3549e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAC87BCA90>]}
[0m11:27:08.160723 [info ] [MainThread]: 
[0m11:27:08.160723 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:27:08.160723 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:27:08.160723 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:27:08.907793 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m11:27:08.907793 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:27:08.907793 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m11:27:08.907793 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:27:09.650307 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m11:27:09.655910 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:27:09.681078 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m11:27:09.681078 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:27:10.329603 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '45abd885-a990-4089-8d06-ebd05dc3549e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAC88EFE80>]}
[0m11:27:10.329603 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:27:10.329603 [info ] [MainThread]: 
[0m11:27:10.329603 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m11:27:10.329603 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_estoque_produto_base ................. [RUN]
[0m11:27:10.329603 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_estoque_produto_base'
[0m11:27:10.339160 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m11:27:10.347261 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m11:27:10.347261 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 11:27:10.339640 => 11:27:10.347261
[0m11:27:10.347261 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m11:27:10.371137 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m11:27:10.371137 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:27:10.371137 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_produto       as a
left join cte_venda_produto as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m11:27:11.261336 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8e10d665-8108-41a8-86e8-9871ee70ea7e&page=queryresults
[0m11:27:11.694632 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Name qt_estoque_minimo not found inside b at [70:13]')
[0m11:27:12.430579 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9f44f685-3c28-4fcc-902b-c556a795b00c&page=queryresults
[0m11:27:12.828265 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9f44f685-3c28-4fcc-902b-c556a795b00c&page=queryresults
[0m11:27:12.829785 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 11:27:10.347261 => 11:27:12.829785
[0m11:27:13.224449 [debug] [Thread-1  ]: Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Name qt_estoque_minimo not found inside b at [70:13]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m11:27:13.224449 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '45abd885-a990-4089-8d06-ebd05dc3549e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAC9D7A6D0>]}
[0m11:27:13.224449 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_estoque_produto_base ........ [[31mERROR[0m in 2.89s]
[0m11:27:13.224449 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m11:27:13.240377 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:27:13.240377 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:27:13.240377 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m11:27:13.240377 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m11:27:13.243360 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m11:27:13.243360 [info ] [MainThread]: 
[0m11:27:13.243360 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.08 seconds (5.08s).
[0m11:27:13.243360 [debug] [MainThread]: Command end result
[0m11:27:13.280639 [info ] [MainThread]: 
[0m11:27:13.280639 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m11:27:13.280639 [info ] [MainThread]: 
[0m11:27:13.280639 [error] [MainThread]:   Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Name qt_estoque_minimo not found inside b at [70:13]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m11:27:13.280639 [info ] [MainThread]: 
[0m11:27:13.280639 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m11:27:13.280639 [debug] [MainThread]: Command `dbt run` failed at 11:27:13.280639 after 5.95 seconds
[0m11:27:13.280639 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAC5212430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAC419E250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EAC89586D0>]}
[0m11:27:13.280639 [debug] [MainThread]: Flushing usage events
[0m11:27:47.300838 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A662C46460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A661BC59D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A661BC5B80>]}


============================== 11:27:47.300838 | 063e1afe-2908-4460-a686-965aee1b92ca ==============================
[0m11:27:47.300838 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:27:47.300838 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --models tb_estoque_produto_base', 'send_anonymous_usage_stats': 'True'}
[0m11:27:47.750177 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '063e1afe-2908-4460-a686-965aee1b92ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A664D8DB80>]}
[0m11:27:47.810178 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '063e1afe-2908-4460-a686-965aee1b92ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A6662A8460>]}
[0m11:27:47.810178 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:27:47.820237 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:27:47.910844 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:27:47.910844 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_estoque_produto_base.sql
[0m11:27:48.010299 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '063e1afe-2908-4460-a686-965aee1b92ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A666727B80>]}
[0m11:27:48.024616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '063e1afe-2908-4460-a686-965aee1b92ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A66623ED90>]}
[0m11:27:48.024616 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:27:48.028178 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '063e1afe-2908-4460-a686-965aee1b92ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A66656ADF0>]}
[0m11:27:48.028178 [info ] [MainThread]: 
[0m11:27:48.030183 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:27:48.030183 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:27:48.030183 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:27:48.762481 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m11:27:48.769470 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:27:48.771536 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m11:27:48.772582 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:27:49.441451 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m11:27:49.441451 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:27:49.451054 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m11:27:49.453639 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:27:50.395498 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '063e1afe-2908-4460-a686-965aee1b92ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A666573910>]}
[0m11:27:50.397496 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:27:50.399216 [info ] [MainThread]: 
[0m11:27:50.408618 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m11:27:50.409569 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_estoque_produto_base ................. [RUN]
[0m11:27:50.412950 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_estoque_produto_base'
[0m11:27:50.413948 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m11:27:50.424434 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m11:27:50.426439 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 11:27:50.414858 => 11:27:50.425438
[0m11:27:50.426832 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m11:27:50.450197 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m11:27:50.450197 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:27:50.460659 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_venda_produto  as a
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m11:27:51.389742 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7ce97e5e-5553-4ab7-86ec-89478f5d05e4&page=queryresults
[0m11:27:53.403051 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 11:27:50.427304 => 11:27:53.403051
[0m11:27:53.403051 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '063e1afe-2908-4460-a686-965aee1b92ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A66778DC10>]}
[0m11:27:53.403051 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_estoque_produto_base ............ [[32mCREATE TABLE (236.0 rows, 128.9 KiB processed)[0m in 2.99s]
[0m11:27:53.403051 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m11:27:53.403051 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:27:53.403051 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:27:53.412886 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m11:27:53.412886 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m11:27:53.412886 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m11:27:53.412886 [info ] [MainThread]: 
[0m11:27:53.412886 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.38 seconds (5.38s).
[0m11:27:53.412886 [debug] [MainThread]: Command end result
[0m11:27:53.442837 [info ] [MainThread]: 
[0m11:27:53.443833 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:27:53.444833 [info ] [MainThread]: 
[0m11:27:53.445698 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m11:27:53.445698 [debug] [MainThread]: Command `dbt run` succeeded at 11:27:53.445698 after 6.21 seconds
[0m11:27:53.449008 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A662C46460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A666655B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A666596A60>]}
[0m11:27:53.450171 [debug] [MainThread]: Flushing usage events
[0m11:51:32.012169 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222416103D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222405B6310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222405B6790>]}


============================== 11:51:32.012169 | 76f52dab-e28b-4836-86ae-4402742051b0 ==============================
[0m11:51:32.012169 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:51:32.019099 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_venda_produto_base+', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m11:51:32.519876 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '76f52dab-e28b-4836-86ae-4402742051b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002224059C130>]}
[0m11:51:32.579809 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '76f52dab-e28b-4836-86ae-4402742051b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222405A6E50>]}
[0m11:51:32.579809 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:51:32.603024 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:51:35.715947 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:51:35.715947 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_venda_produto_base.sql
[0m11:51:35.795448 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '76f52dab-e28b-4836-86ae-4402742051b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022245118BE0>]}
[0m11:51:35.845365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '76f52dab-e28b-4836-86ae-4402742051b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022244F6D1C0>]}
[0m11:51:35.845365 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:51:35.845365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '76f52dab-e28b-4836-86ae-4402742051b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022244CE57C0>]}
[0m11:51:35.845365 [info ] [MainThread]: 
[0m11:51:35.845365 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:51:35.845365 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:51:35.845365 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:51:36.949395 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m11:51:36.949395 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:51:36.949395 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m11:51:36.949395 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:51:37.650572 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m11:51:37.660330 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:51:37.664609 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m11:51:37.664609 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:51:38.372989 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '76f52dab-e28b-4836-86ae-4402742051b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022244D07310>]}
[0m11:51:38.376561 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:51:38.376561 [info ] [MainThread]: 
[0m11:51:38.376561 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m11:51:38.376561 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_venda_produto_base ................... [RUN]
[0m11:51:38.376561 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_venda_produto_base'
[0m11:51:38.388993 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m11:51:38.406087 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m11:51:38.410043 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 11:51:38.388993 => 11:51:38.409022
[0m11:51:38.411573 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m11:51:38.423002 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:51:39.114733 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m11:51:39.114733 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)    as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)      as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)      as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0) as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)   as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)   as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)   as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)     as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)     as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)   as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)     as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)     as vl_total_seis_meses
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

  select *
    from cte_base_final
order by nm_produto
    );
  
[0m11:51:39.562586 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9b44cd1c-9844-41f1-9607-aa6d85d3ec4e&page=queryresults
[0m11:51:42.182338 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 11:51:38.411573 => 11:51:42.182338
[0m11:51:42.182338 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76f52dab-e28b-4836-86ae-4402742051b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022246148BB0>]}
[0m11:51:42.182338 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_venda_produto_base .............. [[32mCREATE TABLE (203.0 rows, 121.1 KiB processed)[0m in 3.81s]
[0m11:51:42.182338 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m11:51:42.193555 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m11:51:42.193555 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_estoque_produto_base ................. [RUN]
[0m11:51:42.195565 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_estoque_produto_base'
[0m11:51:42.195565 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m11:51:42.204832 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m11:51:42.204832 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 11:51:42.195565 => 11:51:42.204832
[0m11:51:42.204832 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m11:51:42.208972 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m11:51:43.121138 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m11:51:43.121138 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_venda_produto  as a
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m11:51:43.570237 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:567da6cf-d1db-426f-87a0-822fe955afab&page=queryresults
[0m11:51:45.840490 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 11:51:42.204832 => 11:51:45.839466
[0m11:51:45.843489 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '76f52dab-e28b-4836-86ae-4402742051b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022246148790>]}
[0m11:51:45.844486 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_estoque_produto_base ............ [[32mCREATE TABLE (203.0 rows, 122.7 KiB processed)[0m in 3.65s]
[0m11:51:45.847490 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m11:51:45.852671 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:51:45.854577 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:51:45.854577 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m11:51:45.855574 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m11:51:45.855574 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m11:51:45.855574 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m11:51:45.856573 [info ] [MainThread]: 
[0m11:51:45.857578 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 10.01 seconds (10.01s).
[0m11:51:45.861208 [debug] [MainThread]: Command end result
[0m11:51:45.883981 [info ] [MainThread]: 
[0m11:51:45.884988 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:51:45.885962 [info ] [MainThread]: 
[0m11:51:45.885962 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m11:51:45.888944 [debug] [MainThread]: Command `dbt run` succeeded at 11:51:45.885962 after 14.00 seconds
[0m11:51:45.888944 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000222416103D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022244C5E670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022244F86A60>]}
[0m11:51:45.888944 [debug] [MainThread]: Flushing usage events
[0m11:53:48.232614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228960AE400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022895032640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022895032AC0>]}


============================== 11:53:48.236631 | dc995c7a-6f03-49e3-86c8-9d071dd8fb5f ==============================
[0m11:53:48.236631 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:53:48.236631 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_venda_produto_base+', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m11:53:48.660247 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dc995c7a-6f03-49e3-86c8-9d071dd8fb5f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002289501C040>]}
[0m11:53:48.724691 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dc995c7a-6f03-49e3-86c8-9d071dd8fb5f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022899635C40>]}
[0m11:53:48.724691 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:53:48.724691 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:53:48.810748 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m11:53:48.810748 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_venda_produto_base.sql
[0m11:53:48.890448 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dc995c7a-6f03-49e3-86c8-9d071dd8fb5f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022899B96BB0>]}
[0m11:53:48.906248 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dc995c7a-6f03-49e3-86c8-9d071dd8fb5f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228999ED0D0>]}
[0m11:53:48.906248 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:53:48.906248 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dc995c7a-6f03-49e3-86c8-9d071dd8fb5f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022899691D30>]}
[0m11:53:48.906248 [info ] [MainThread]: 
[0m11:53:48.906248 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:53:48.906248 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:53:48.906248 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:53:49.724077 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m11:53:49.724077 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:53:49.724077 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m11:53:49.724077 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:53:50.523041 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m11:53:50.523041 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:53:50.523041 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m11:53:50.523041 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:53:51.663706 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dc995c7a-6f03-49e3-86c8-9d071dd8fb5f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228999ED130>]}
[0m11:53:51.664731 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:53:51.665705 [info ] [MainThread]: 
[0m11:53:51.671005 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m11:53:51.672056 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_venda_produto_base ................... [RUN]
[0m11:53:51.673056 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_venda_produto_base'
[0m11:53:51.674059 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m11:53:51.677205 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m11:53:51.677205 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 11:53:51.674059 => 11:53:51.677205
[0m11:53:51.677205 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m11:53:51.698968 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:53:52.410267 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m11:53:52.410267 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)    as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)      as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)      as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0) as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)   as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)   as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)   as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)     as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)     as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)   as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)     as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)     as vl_total_seis_meses
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

  select *
    from cte_base_final
order by nm_produto
    );
  
[0m11:53:52.908965 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b3841bf7-1912-4973-881f-c69ca597895a&page=queryresults
[0m11:53:56.247374 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 11:53:51.677205 => 11:53:56.247374
[0m11:53:56.247374 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dc995c7a-6f03-49e3-86c8-9d071dd8fb5f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002289ABC7B50>]}
[0m11:53:56.247374 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_venda_produto_base .............. [[32mCREATE TABLE (199.0 rows, 121.1 KiB processed)[0m in 4.58s]
[0m11:53:56.253432 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m11:53:56.253432 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m11:53:56.253432 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_estoque_produto_base ................. [RUN]
[0m11:53:56.253432 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_estoque_produto_base'
[0m11:53:56.253432 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m11:53:56.277474 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m11:53:56.280285 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 11:53:56.253432 => 11:53:56.278578
[0m11:53:56.280285 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m11:53:56.283700 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m11:53:57.276351 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m11:53:57.280732 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_venda_produto  as a
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m11:53:57.670654 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:453e12ac-de4f-4d92-a785-b452a06260f9&page=queryresults
[0m11:53:59.908113 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 11:53:56.280285 => 11:53:59.907109
[0m11:53:59.911121 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dc995c7a-6f03-49e3-86c8-9d071dd8fb5f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002289ABC7520>]}
[0m11:53:59.912116 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_estoque_produto_base ............ [[32mCREATE TABLE (199.0 rows, 122.1 KiB processed)[0m in 3.66s]
[0m11:53:59.915666 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m11:53:59.920517 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:53:59.921518 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:53:59.922562 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m11:53:59.923564 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m11:53:59.925192 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m11:53:59.926194 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m11:53:59.927199 [info ] [MainThread]: 
[0m11:53:59.929154 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 11.02 seconds (11.02s).
[0m11:53:59.932005 [debug] [MainThread]: Command end result
[0m11:53:59.968988 [info ] [MainThread]: 
[0m11:53:59.972000 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:53:59.975559 [info ] [MainThread]: 
[0m11:53:59.978582 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m11:53:59.983905 [debug] [MainThread]: Command `dbt run` succeeded at 11:53:59.982333 after 11.80 seconds
[0m11:53:59.985986 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228960AE400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000228997E8B20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022899A06A30>]}
[0m11:53:59.988000 [debug] [MainThread]: Flushing usage events
[0m12:00:04.318826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A17E92460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A16E079A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A16E07D30>]}


============================== 12:00:04.318826 | d30e186f-2190-4767-a5e7-8882a6d68fc2 ==============================
[0m12:00:04.318826 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:00:04.318826 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --exclude tag:snaps', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:00:04.872743 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A16E03040>]}
[0m12:00:04.937045 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1B5D3D00>]}
[0m12:00:04.937045 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:00:04.937045 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:00:05.033751 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:00:05.033751 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:00:05.033751 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1B7D7760>]}
[0m12:00:05.049850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1B7CC400>]}
[0m12:00:05.049850 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:00:05.049850 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1B45C040>]}
[0m12:00:05.049850 [info ] [MainThread]: 
[0m12:00:05.049850 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:00:05.049850 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:05.049850 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:05.049850 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:05.049850 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:05.931981 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:06.653995 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m12:00:06.653995 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:06.653995 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m12:00:06.653995 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:07.349799 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m12:00:07.349799 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:07.391128 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m12:00:07.392132 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:08.092220 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1B7CC220>]}
[0m12:00:08.095372 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:00:08.095372 [info ] [MainThread]: 
[0m12:00:08.095372 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:08.106953 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m12:00:08.095372 [info ] [Thread-1  ]: 1 of 20 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m12:00:08.108060 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m12:00:08.108060 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:08.108060 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m12:00:08.108060 [info ] [Thread-2  ]: 2 of 20 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m12:00:08.124221 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m12:00:08.124221 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m12:00:08.124221 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m12:00:08.124221 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 12:00:08.108060 => 12:00:08.124221
[0m12:00:08.124221 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:08.140121 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m12:00:08.140121 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 12:00:08.124221 => 12:00:08.140121
[0m12:00:08.155972 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m12:00:08.155972 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m12:00:08.155972 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:00:08.155972 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m12:00:08.171742 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m12:00:08.171742 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m12:00:09.160355 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:63b8d217-0ef2-43fd-a3a6-556a539cb640&page=queryresults
[0m12:00:09.173402 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:88727864-8931-44a1-9b11-843e3b69e66a&page=queryresults
[0m12:00:09.613110 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 12:00:08.124221 => 12:00:09.613110
[0m12:00:09.618196 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 12:00:08.155972 => 12:00:09.616928
[0m12:00:09.618971 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1C89D1F0>]}
[0m12:00:09.620751 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1C8DCDC0>]}
[0m12:00:09.622755 [info ] [Thread-1  ]: 1 of 20 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.51s]
[0m12:00:09.625749 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:09.623752 [info ] [Thread-2  ]: 2 of 20 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.50s]
[0m12:00:09.626752 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m12:00:09.627277 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m12:00:09.628983 [info ] [Thread-1  ]: 3 of 20 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m12:00:09.630063 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m12:00:09.631062 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m12:00:09.632060 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m12:00:09.637064 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m12:00:09.632060 [info ] [Thread-2  ]: 4 of 20 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m12:00:09.638062 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m12:00:09.638917 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m12:00:09.642933 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m12:00:09.642933 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 12:00:09.633058 => 12:00:09.642933
[0m12:00:09.642933 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m12:00:09.642933 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m12:00:09.642933 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 12:00:09.638917 => 12:00:09.642933
[0m12:00:09.653697 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m12:00:09.657729 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m12:00:09.659745 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:09.661762 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m12:00:09.663777 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:09.685432 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m12:00:10.422185 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c264fa82-6290-48b6-be44-b41f1fffe378&page=queryresults
[0m12:00:10.440457 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9b845634-113c-4bce-a157-25a224ed264c&page=queryresults
[0m12:00:10.830116 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 12:00:09.642933 => 12:00:10.830116
[0m12:00:10.832478 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1C8DCDC0>]}
[0m12:00:10.832904 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 12:00:09.653697 => 12:00:10.832904
[0m12:00:10.832904 [info ] [Thread-1  ]: 3 of 20 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m12:00:10.832904 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1B88EEE0>]}
[0m12:00:10.839273 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m12:00:10.841335 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m12:00:10.840329 [info ] [Thread-2  ]: 4 of 20 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m12:00:10.842322 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m12:00:10.842322 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m12:00:10.841335 [info ] [Thread-1  ]: 5 of 20 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m12:00:10.844289 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m12:00:10.844289 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m12:00:10.848380 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m12:00:10.843338 [info ] [Thread-2  ]: 6 of 20 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m12:00:10.850348 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m12:00:10.850348 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m12:00:10.852740 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m12:00:10.852740 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 12:00:10.844289 => 12:00:10.852740
[0m12:00:10.852740 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 12:00:10.851328 => 12:00:10.852740
[0m12:00:10.852740 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m12:00:10.852740 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m12:00:10.852740 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m12:00:10.861205 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m12:00:10.862170 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:10.862170 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m12:00:10.862170 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:10.888961 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m12:00:11.629900 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:36a0dd87-db06-4cc4-9011-b7aa6f0c1cf6&page=queryresults
[0m12:00:11.654742 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:983e335e-c788-4f4f-af1d-6b322406691d&page=queryresults
[0m12:00:12.018660 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 12:00:10.859160 => 12:00:12.018660
[0m12:00:12.018660 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1B860AF0>]}
[0m12:00:12.018660 [info ] [Thread-2  ]: 6 of 20 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m12:00:12.025449 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m12:00:12.026532 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:12.027524 [info ] [Thread-2  ]: 7 of 20 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m12:00:12.029432 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_meta_margem_preco)
[0m12:00:12.030691 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:12.052424 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m12:00:12.056424 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 12:00:10.852740 => 12:00:12.055417
[0m12:00:12.057420 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1C9297C0>]}
[0m12:00:12.058411 [info ] [Thread-1  ]: 5 of 20 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m12:00:12.059287 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m12:00:12.059287 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m12:00:12.059287 [info ] [Thread-1  ]: 8 of 20 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m12:00:12.059287 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_pedido)
[0m12:00:12.059287 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m12:00:12.059287 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m12:00:12.059287 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 12:00:12.030691 => 12:00:12.059287
[0m12:00:12.059287 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:12.059287 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m12:00:12.059287 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 12:00:12.059287 => 12:00:12.059287
[0m12:00:12.059287 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m12:00:12.074343 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m12:00:12.074343 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:12.074343 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m12:00:12.099958 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:12.101048 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m12:00:12.829688 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:33ba53bd-9af0-462a-9a04-5fb5f5d82678&page=queryresults
[0m12:00:12.850475 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bd5b9255-9368-4a41-9ae8-101e8f50bd49&page=queryresults
[0m12:00:13.237527 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 12:00:12.059287 => 12:00:13.237527
[0m12:00:13.238453 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1C929D00>]}
[0m12:00:13.239471 [info ] [Thread-1  ]: 8 of 20 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m12:00:13.241131 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m12:00:13.241131 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m12:00:13.242132 [info ] [Thread-1  ]: 9 of 20 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m12:00:13.243170 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto)
[0m12:00:13.243170 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m12:00:13.247512 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m12:00:13.249125 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 12:00:13.244226 => 12:00:13.248715
[0m12:00:13.249809 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m12:00:13.252955 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m12:00:13.253485 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:13.255533 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m12:00:13.296641 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 12:00:12.059287 => 12:00:13.296641
[0m12:00:13.296641 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1B860AF0>]}
[0m12:00:13.298649 [info ] [Thread-2  ]: 7 of 20 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m12:00:13.298649 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:13.298649 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m12:00:13.300655 [info ] [Thread-2  ]: 10 of 20 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m12:00:13.300655 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_tempo)
[0m12:00:13.300655 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m12:00:13.300655 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m12:00:13.300655 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 12:00:13.300655 => 12:00:13.300655
[0m12:00:13.300655 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m12:00:13.310596 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m12:00:13.310596 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:13.313432 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m12:00:13.973410 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6d2f7da5-0cd9-43b6-b507-b6999a4445f2&page=queryresults
[0m12:00:14.031131 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7a2da14d-6af4-49f0-902e-af8f35c338ca&page=queryresults
[0m12:00:14.399222 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 12:00:13.249809 => 12:00:14.399222
[0m12:00:14.399222 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1C9A0100>]}
[0m12:00:14.410240 [info ] [Thread-1  ]: 9 of 20 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m12:00:14.412502 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m12:00:14.414418 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m12:00:14.415468 [info ] [Thread-1  ]: 11 of 20 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m12:00:14.417482 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m12:00:14.418765 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m12:00:14.424356 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m12:00:14.426340 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 12:00:14.418765 => 12:00:14.425352
[0m12:00:14.426340 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m12:00:14.429264 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:14.429264 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 12:00:13.300655 => 12:00:14.429264
[0m12:00:14.439135 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1C90EF70>]}
[0m12:00:14.439692 [info ] [Thread-2  ]: 10 of 20 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m12:00:14.459185 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m12:00:15.139307 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m12:00:15.139307 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m12:00:15.846636 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e1a551c4-598c-4687-b764-f3b5d52b0199&page=queryresults
[0m12:00:18.370893 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 12:00:14.427349 => 12:00:18.370893
[0m12:00:18.370893 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1C9A8CD0>]}
[0m12:00:18.370893 [info ] [Thread-1  ]: 11 of 20 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 3.95s]
[0m12:00:18.375817 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m12:00:18.375817 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m12:00:18.375817 [info ] [Thread-2  ]: 12 of 20 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m12:00:18.375817 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m12:00:18.375817 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m12:00:18.386810 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m12:00:18.386810 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 12:00:18.375817 => 12:00:18.386810
[0m12:00:18.386810 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m12:00:18.386810 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:19.019028 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m12:00:19.019028 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m12:00:19.713873 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ac39c04c-4319-4995-bcf0-955374c46339&page=queryresults
[0m12:00:22.520535 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 12:00:18.386810 => 12:00:22.519619
[0m12:00:22.520535 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1C909F10>]}
[0m12:00:22.520535 [info ] [Thread-2  ]: 12 of 20 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 4.14s]
[0m12:00:22.521874 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m12:00:22.522844 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m12:00:22.523816 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m12:00:22.522844 [info ] [Thread-1  ]: 13 of 20 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m12:00:22.524814 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m12:00:22.524814 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m12:00:22.523816 [info ] [Thread-2  ]: 14 of 20 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m12:00:22.528434 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m12:00:22.529397 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m12:00:22.533682 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m12:00:22.546069 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m12:00:22.547109 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 12:00:22.529397 => 12:00:22.546069
[0m12:00:22.548115 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m12:00:22.552958 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:22.577927 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 12:00:22.524814 => 12:00:22.577927
[0m12:00:22.578925 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m12:00:22.581004 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:23.217958 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m12:00:23.218914 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m12:00:23.231926 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m12:00:23.233940 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m12:00:23.605498 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b5e565ee-2b8b-4375-92b5-4bf5c66af510&page=queryresults
[0m12:00:23.792835 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b5eb0a58-47a4-470a-91be-9044e2fea6db&page=queryresults
[0m12:00:25.530863 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 12:00:22.548115 => 12:00:25.530863
[0m12:00:25.530863 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1CA22670>]}
[0m12:00:25.530863 [info ] [Thread-2  ]: 14 of 20 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 82.4 KiB processed)[0m in 3.00s]
[0m12:00:25.530863 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m12:00:25.530863 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m12:00:25.530863 [info ] [Thread-2  ]: 15 of 20 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m12:00:25.530863 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_pedido)
[0m12:00:25.530863 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m12:00:25.530863 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m12:00:25.530863 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 12:00:25.530863 => 12:00:25.530863
[0m12:00:25.530863 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m12:00:25.530863 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:25.748955 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 12:00:22.578925 => 12:00:25.748039
[0m12:00:25.749573 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1C86B3D0>]}
[0m12:00:25.749573 [info ] [Thread-1  ]: 13 of 20 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 108.6 KiB processed)[0m in 3.22s]
[0m12:00:25.750656 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m12:00:25.750656 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m12:00:25.751663 [info ] [Thread-1  ]: 16 of 20 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m12:00:25.751663 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_preco_produto)
[0m12:00:25.752578 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m12:00:25.755292 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m12:00:25.756587 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 12:00:25.752891 => 12:00:25.756587
[0m12:00:25.756587 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m12:00:25.762494 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:26.165304 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m12:00:26.167242 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m12:00:26.369006 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m12:00:26.369006 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m12:00:26.814576 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:86abe9df-589a-4326-adc8-80412b86198d&page=queryresults
[0m12:00:27.084690 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:41118f93-66c2-4c32-aed7-e6b60d8754fa&page=queryresults
[0m12:00:29.330283 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 12:00:25.530863 => 12:00:29.329210
[0m12:00:29.330283 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1C8BF880>]}
[0m12:00:29.330283 [info ] [Thread-2  ]: 15 of 20 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 3.80s]
[0m12:00:29.330283 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m12:00:29.339146 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m12:00:29.341176 [info ] [Thread-2  ]: 17 of 20 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m12:00:29.343217 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m12:00:29.344220 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m12:00:29.354223 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m12:00:29.357179 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 12:00:29.345218 => 12:00:29.356215
[0m12:00:29.359171 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m12:00:29.365655 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:30.049429 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m12:00:30.051442 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m12:00:30.432639 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:badd0f44-ce20-40d0-bcc4-75759ccc8ad7&page=queryresults
[0m12:00:32.445276 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 12:00:25.756587 => 12:00:32.445276
[0m12:00:32.448275 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1C872580>]}
[0m12:00:32.450276 [info ] [Thread-1  ]: 16 of 20 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (309.0 rows, 81.0 KiB processed)[0m in 6.70s]
[0m12:00:32.453274 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m12:00:32.650232 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 12:00:29.360412 => 12:00:32.650232
[0m12:00:32.652245 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1CA4F1F0>]}
[0m12:00:32.652245 [info ] [Thread-2  ]: 17 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 413.1 KiB processed)[0m in 3.31s]
[0m12:00:32.654257 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m12:00:32.656013 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m12:00:32.656013 [info ] [Thread-1  ]: 18 of 20 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m12:00:32.658026 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m12:00:32.660279 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m12:00:32.666321 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m12:00:32.668333 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 12:00:32.660279 => 12:00:32.668333
[0m12:00:32.668333 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m12:00:32.672095 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:33.335136 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m12:00:33.338230 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m12:00:33.728272 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:537e513f-9f80-407c-96be-064b2a4f5017&page=queryresults
[0m12:00:35.950226 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 12:00:32.670345 => 12:00:35.950226
[0m12:00:35.950226 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1CA4F610>]}
[0m12:00:35.950226 [info ] [Thread-1  ]: 18 of 20 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (320.0 rows, 266.9 KiB processed)[0m in 3.29s]
[0m12:00:35.950226 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m12:00:35.950226 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m12:00:35.950226 [info ] [Thread-2  ]: 19 of 20 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m12:00:35.950226 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m12:00:35.950226 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m12:00:35.950226 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m12:00:35.950226 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 12:00:35.950226 => 12:00:35.950226
[0m12:00:35.950226 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m12:00:35.950226 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:36.573183 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m12:00:36.575071 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)    as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)      as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)      as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0) as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)   as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)   as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)   as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)     as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)     as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)   as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)     as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)     as vl_total_seis_meses
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

  select *
    from cte_base_final
order by nm_produto
    );
  
[0m12:00:36.955995 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9c9a885e-90f7-480d-95d6-3c238e867301&page=queryresults
[0m12:00:39.211331 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 12:00:35.950226 => 12:00:39.211331
[0m12:00:39.212329 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1DA33D90>]}
[0m12:00:39.212329 [info ] [Thread-2  ]: 19 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (199.0 rows, 121.1 KiB processed)[0m in 3.26s]
[0m12:00:39.213331 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m12:00:39.215253 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m12:00:39.215253 [info ] [Thread-1  ]: 20 of 20 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m12:00:39.216540 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_estoque_produto_base)
[0m12:00:39.217541 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m12:00:39.223402 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:00:39.226665 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 12:00:39.217541 => 12:00:39.225668
[0m12:00:39.226665 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m12:00:39.229322 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:39.981232 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:00:39.984138 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_venda_produto  as a
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m12:00:40.358168 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:200da088-abed-4bb6-8464-527675937c92&page=queryresults
[0m12:00:42.357216 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 12:00:39.226665 => 12:00:42.357216
[0m12:00:42.358225 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd30e186f-2190-4767-a5e7-8882a6d68fc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1C872460>]}
[0m12:00:42.358225 [info ] [Thread-1  ]: 20 of 20 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (199.0 rows, 122.1 KiB processed)[0m in 3.14s]
[0m12:00:42.359184 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m12:00:42.361306 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:00:42.361306 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:00:42.362345 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:00:42.362345 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m12:00:42.362345 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m12:00:42.362345 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m12:00:42.362345 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m12:00:42.362345 [info ] [MainThread]: 
[0m12:00:42.363547 [info ] [MainThread]: Finished running 10 view models, 10 table models in 0 hours 0 minutes and 37.31 seconds (37.31s).
[0m12:00:42.365551 [debug] [MainThread]: Command end result
[0m12:00:42.374402 [info ] [MainThread]: 
[0m12:00:42.375389 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:00:42.375389 [info ] [MainThread]: 
[0m12:00:42.376397 [info ] [MainThread]: Done. PASS=20 WARN=0 ERROR=0 SKIP=0 TOTAL=20
[0m12:00:42.376397 [debug] [MainThread]: Command `dbt run` succeeded at 12:00:42.376397 after 38.11 seconds
[0m12:00:42.377387 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A17E92460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1B55E0A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A1B524FD0>]}
[0m12:00:42.377387 [debug] [MainThread]: Flushing usage events
[0m12:00:45.884241 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B0EE13430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B0DD8C9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B0DD8CD30>]}


============================== 12:00:45.900070 | a81639e6-a2c4-4656-bf16-5959e878e2e9 ==============================
[0m12:00:45.900070 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:00:45.900070 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m12:00:46.587075 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a81639e6-a2c4-4656-bf16-5959e878e2e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B10F5AAC0>]}
[0m12:00:46.689424 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a81639e6-a2c4-4656-bf16-5959e878e2e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B1247C520>]}
[0m12:00:46.689424 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:00:46.689424 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:00:46.799104 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:00:46.800369 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:00:46.808318 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a81639e6-a2c4-4656-bf16-5959e878e2e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B12757280>]}
[0m12:00:46.822876 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a81639e6-a2c4-4656-bf16-5959e878e2e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B12590EB0>]}
[0m12:00:46.823860 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:00:46.823860 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a81639e6-a2c4-4656-bf16-5959e878e2e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B12590100>]}
[0m12:00:46.825979 [info ] [MainThread]: 
[0m12:00:46.826934 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:00:46.827910 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:46.828859 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:47.512259 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m12:00:47.512259 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:47.512259 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m12:00:47.512259 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:48.115482 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m12:00:48.131327 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:48.181678 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m12:00:48.181678 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:48.812023 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a81639e6-a2c4-4656-bf16-5959e878e2e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B124D9490>]}
[0m12:00:48.812023 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:00:48.819180 [info ] [MainThread]: 
[0m12:00:48.829263 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m12:00:48.829792 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m12:00:48.832029 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m12:00:48.833030 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m12:00:48.849817 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 12:00:48.833030 => 12:00:48.849817
[0m12:00:48.851922 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m12:00:48.954345 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:00:48.954345 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m12:00:49.781723 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1a65a551-b09a-41d0-9d78-966516ce5032&page=queryresults
[0m12:00:50.933297 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m12:00:51.339193 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1fba8829-8a68-49ae-8356-d7d168af3c85&page=queryresults
[0m12:00:54.530445 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m12:00:55.395547 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m12:00:55.399392 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m12:00:55.884119 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f68f0097-768a-49ae-ad4e-fa3a64c58b67&page=queryresults
[0m12:00:58.136862 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 12:00:48.851922 => 12:00:58.136862
[0m12:00:58.137864 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a81639e6-a2c4-4656-bf16-5959e878e2e9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B137FA0A0>]}
[0m12:00:58.138845 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 66.0 KiB processed)[0m in 9.31s]
[0m12:00:58.139818 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m12:00:58.141841 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:00:58.142858 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:00:58.143226 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m12:00:58.143226 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m12:00:58.143226 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m12:00:58.144303 [info ] [MainThread]: 
[0m12:00:58.144303 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 11.32 seconds (11.32s).
[0m12:00:58.145321 [debug] [MainThread]: Command end result
[0m12:00:58.148616 [info ] [MainThread]: 
[0m12:00:58.158955 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:00:58.158955 [info ] [MainThread]: 
[0m12:00:58.159963 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m12:00:58.160988 [debug] [MainThread]: Command `dbt snapshot` succeeded at 12:00:58.160988 after 12.32 seconds
[0m12:00:58.161978 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B0EE13430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B127FA040>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028B12509820>]}
[0m12:00:58.161978 [debug] [MainThread]: Flushing usage events
[0m12:01:01.415647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FCDF993430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FCDE91E6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FCDE91EE20>]}


============================== 12:01:01.430612 | 820aefa8-f84c-4873-b37c-21de9b0ea876 ==============================
[0m12:01:01.430612 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:01:01.430612 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select tag:snaps', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:01:01.986330 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '820aefa8-f84c-4873-b37c-21de9b0ea876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FCE1ADBA60>]}
[0m12:01:02.108259 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '820aefa8-f84c-4873-b37c-21de9b0ea876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FCE2FFB430>]}
[0m12:01:02.112035 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:01:02.118440 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:01:02.222126 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:01:02.222126 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:01:02.227044 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '820aefa8-f84c-4873-b37c-21de9b0ea876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FCE32D9310>]}
[0m12:01:02.238541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '820aefa8-f84c-4873-b37c-21de9b0ea876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FCE32C7370>]}
[0m12:01:02.239596 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:01:02.239596 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '820aefa8-f84c-4873-b37c-21de9b0ea876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FCE2F8EF70>]}
[0m12:01:02.239596 [info ] [MainThread]: 
[0m12:01:02.239596 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:01:02.239596 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:01:02.239596 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:01:02.992060 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m12:01:02.994078 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:01:02.994078 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m12:01:02.994078 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:01:03.613052 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m12:01:03.613052 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:01:03.652638 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m12:01:03.653629 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:01:04.320582 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '820aefa8-f84c-4873-b37c-21de9b0ea876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FCE30C3DF0>]}
[0m12:01:04.320582 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:01:04.320582 [info ] [MainThread]: 
[0m12:01:04.320582 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m12:01:04.320582 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m12:01:04.338191 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m12:01:04.340268 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m12:01:04.359138 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m12:01:04.363184 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 12:01:04.340268 => 12:01:04.362090
[0m12:01:04.364185 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m12:01:04.391937 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:01:05.141483 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m12:01:05.143488 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m12:01:05.513638 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fbd40153-5d6e-4971-a807-2238e91f6378&page=queryresults
[0m12:01:07.470658 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 12:01:04.364185 => 12:01:07.470658
[0m12:01:07.480560 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '820aefa8-f84c-4873-b37c-21de9b0ea876', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FCE304E160>]}
[0m12:01:07.480560 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (366.0 rows, 53.8 KiB processed)[0m in 3.16s]
[0m12:01:07.482575 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m12:01:07.486381 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:01:07.486381 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:01:07.488395 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m12:01:07.488395 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m12:01:07.488395 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m12:01:07.490408 [info ] [MainThread]: 
[0m12:01:07.490408 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.25 seconds (5.25s).
[0m12:01:07.490408 [debug] [MainThread]: Command end result
[0m12:01:07.514935 [info ] [MainThread]: 
[0m12:01:07.516937 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:01:07.517936 [info ] [MainThread]: 
[0m12:01:07.519249 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m12:01:07.522470 [debug] [MainThread]: Command `dbt run` succeeded at 12:01:07.521252 after 6.17 seconds
[0m12:01:07.524468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FCDF993430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FCE2F7D130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FCE33584F0>]}
[0m12:01:07.525568 [debug] [MainThread]: Flushing usage events
[0m12:17:48.022707 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229E73234C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229E62C83A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229E62C8820>]}


============================== 12:17:48.026249 | cce0250a-a26b-4a27-a8f2-3adb62da496b ==============================
[0m12:17:48.026249 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:17:48.027228 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_venda_produto_base+', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m12:17:48.521145 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cce0250a-a26b-4a27-a8f2-3adb62da496b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229EA92B580>]}
[0m12:17:48.605465 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cce0250a-a26b-4a27-a8f2-3adb62da496b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229EA8DF0A0>]}
[0m12:17:48.607469 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:17:48.615493 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:17:48.685347 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:17:48.686343 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_venda_produto_base.sql
[0m12:17:48.790128 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cce0250a-a26b-4a27-a8f2-3adb62da496b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229EAE26EB0>]}
[0m12:17:48.801219 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cce0250a-a26b-4a27-a8f2-3adb62da496b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229EAC7D400>]}
[0m12:17:48.801728 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:17:48.801728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cce0250a-a26b-4a27-a8f2-3adb62da496b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229EAC7D280>]}
[0m12:17:48.803731 [info ] [MainThread]: 
[0m12:17:48.804092 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:17:48.805390 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:17:48.805390 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:17:49.622996 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m12:17:49.622996 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:17:49.623996 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m12:17:49.623996 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:17:50.315310 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m12:17:50.321351 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:17:50.371136 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m12:17:50.372145 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:17:51.043782 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cce0250a-a26b-4a27-a8f2-3adb62da496b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229EAE53E50>]}
[0m12:17:51.045295 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:17:51.047313 [info ] [MainThread]: 
[0m12:17:51.055348 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m12:17:51.056372 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_venda_produto_base ................... [RUN]
[0m12:17:51.059367 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_venda_produto_base'
[0m12:17:51.060369 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m12:17:51.078545 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m12:17:51.084087 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 12:17:51.061372 => 12:17:51.082079
[0m12:17:51.085601 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m12:17:51.109735 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:17:52.027194 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m12:17:52.028179 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)    as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)      as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)      as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0) as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)   as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)   as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)   as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)     as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)     as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)   as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)     as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)     as vl_total_seis_meses
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_seis_meses) over () as qt_total_geral
         ,sum(qt_pecas_seis_meses) over (order by qt_pecas_seis_meses desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(acumulado / total_geral, 4) as vl_percentual_acumulado
         ,case
           when acumulado / total_geral <= 0.80 then 'A'
           when acumulado / total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m12:17:52.516703 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cc89dcfd-025d-43c9-83c2-615b35f6479d&page=queryresults
[0m12:17:52.954670 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: acumulado at [185:17]')
[0m12:17:54.004040 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cb80cb3d-0658-485b-a51a-a06191b91b4f&page=queryresults
[0m12:17:54.390128 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cb80cb3d-0658-485b-a51a-a06191b91b4f&page=queryresults
[0m12:17:54.393776 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 12:17:51.086626 => 12:17:54.392765
[0m12:17:54.798747 [debug] [Thread-1  ]: Database Error in model tb_venda_produto_base (models\3.az\tb_venda_produto_base.sql)
  Unrecognized name: acumulado at [185:17]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_venda_produto_base.sql
[0m12:17:54.799748 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cce0250a-a26b-4a27-a8f2-3adb62da496b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229EBE6ADC0>]}
[0m12:17:54.801259 [error] [Thread-1  ]: 1 of 2 ERROR creating sql table model dbt_dw_az.tb_venda_produto_base .......... [[31mERROR[0m in 3.74s]
[0m12:17:54.803268 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m12:17:54.805267 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m12:17:54.806275 [info ] [Thread-2  ]: 2 of 2 SKIP relation dbt_dw_az.tb_estoque_produto_base ......................... [[33mSKIP[0m]
[0m12:17:54.808274 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m12:17:54.811293 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:17:54.811293 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:17:54.812385 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m12:17:54.813402 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m12:17:54.814385 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m12:17:54.815384 [info ] [MainThread]: 
[0m12:17:54.817385 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 6.01 seconds (6.01s).
[0m12:17:54.820390 [debug] [MainThread]: Command end result
[0m12:17:54.867442 [info ] [MainThread]: 
[0m12:17:54.871442 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:17:54.872922 [info ] [MainThread]: 
[0m12:17:54.873953 [error] [MainThread]:   Database Error in model tb_venda_produto_base (models\3.az\tb_venda_produto_base.sql)
  Unrecognized name: acumulado at [185:17]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_venda_produto_base.sql
[0m12:17:54.875484 [info ] [MainThread]: 
[0m12:17:54.876517 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=1 TOTAL=2
[0m12:17:54.879500 [debug] [MainThread]: Command `dbt run` failed at 12:17:54.878500 after 6.91 seconds
[0m12:17:54.879500 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229E73234C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229EAC96DC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000229EA91F1F0>]}
[0m12:17:54.881016 [debug] [MainThread]: Flushing usage events
[0m12:18:55.597121 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F4550C2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F4540692E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F454069760>]}


============================== 12:18:55.601699 | 3cf32bf4-bbd1-45bd-b9aa-c7209350b0a8 ==============================
[0m12:18:55.601699 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:18:55.601699 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_venda_produto_base+', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:18:56.074026 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3cf32bf4-bbd1-45bd-b9aa-c7209350b0a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F4586417F0>]}
[0m12:18:56.141685 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3cf32bf4-bbd1-45bd-b9aa-c7209350b0a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F458653C70>]}
[0m12:18:56.142718 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:18:56.149385 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:18:56.248485 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:18:56.249469 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_venda_produto_base.sql
[0m12:18:56.375675 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3cf32bf4-bbd1-45bd-b9aa-c7209350b0a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F458BC6A30>]}
[0m12:18:56.386200 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3cf32bf4-bbd1-45bd-b9aa-c7209350b0a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F458AEBAF0>]}
[0m12:18:56.386200 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:18:56.387412 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3cf32bf4-bbd1-45bd-b9aa-c7209350b0a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F458982910>]}
[0m12:18:56.388420 [info ] [MainThread]: 
[0m12:18:56.389422 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:18:56.391086 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:18:56.391086 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:18:57.273189 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m12:18:57.274185 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:18:57.298179 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m12:18:57.299180 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:18:57.944274 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m12:18:57.945285 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:18:57.971885 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m12:18:57.971885 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:18:58.624125 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3cf32bf4-bbd1-45bd-b9aa-c7209350b0a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F45866D910>]}
[0m12:18:58.625173 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:18:58.626071 [info ] [MainThread]: 
[0m12:18:58.630942 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m12:18:58.631945 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_venda_produto_base ................... [RUN]
[0m12:18:58.632946 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_venda_produto_base'
[0m12:18:58.632946 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m12:18:58.640942 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m12:18:58.641946 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 12:18:58.632946 => 12:18:58.641946
[0m12:18:58.641946 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m12:18:58.652962 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:18:59.371056 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m12:18:59.373037 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)    as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)      as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)      as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0) as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)   as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)   as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)   as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)     as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)     as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)   as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)     as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)     as vl_total_seis_meses
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_seis_meses) over () as qt_total_geral
         ,sum(qt_pecas_seis_meses) over (order by qt_pecas_seis_meses desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m12:18:59.828555 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f669381b-e13a-49a3-a7b5-0b9789638a1a&page=queryresults
[0m12:19:02.752188 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 12:18:58.641946 => 12:19:02.751084
[0m12:19:02.753184 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3cf32bf4-bbd1-45bd-b9aa-c7209350b0a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F458C1BD00>]}
[0m12:19:02.755192 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_venda_produto_base .............. [[32mCREATE TABLE (199.0 rows, 121.1 KiB processed)[0m in 4.12s]
[0m12:19:02.757189 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m12:19:02.759090 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m12:19:02.760132 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_estoque_produto_base ................. [RUN]
[0m12:19:02.762179 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_estoque_produto_base'
[0m12:19:02.763187 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m12:19:02.779519 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:19:02.784582 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 12:19:02.764188 => 12:19:02.783623
[0m12:19:02.785626 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m12:19:02.794536 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m12:19:03.485467 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:19:03.490416 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_venda_produto  as a
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m12:19:03.963516 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a94c09d5-9808-4500-a597-51be3c1070ad&page=queryresults
[0m12:19:06.025312 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 12:19:02.786647 => 12:19:06.025312
[0m12:19:06.028345 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3cf32bf4-bbd1-45bd-b9aa-c7209350b0a8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F459C29CA0>]}
[0m12:19:06.029804 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_estoque_produto_base ............ [[32mCREATE TABLE (199.0 rows, 122.1 KiB processed)[0m in 3.27s]
[0m12:19:06.032798 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m12:19:06.036800 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:19:06.037802 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:19:06.038800 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m12:19:06.040234 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m12:19:06.041337 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m12:19:06.042344 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m12:19:06.043331 [info ] [MainThread]: 
[0m12:19:06.044287 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 9.65 seconds (9.65s).
[0m12:19:06.048413 [debug] [MainThread]: Command end result
[0m12:19:06.080006 [info ] [MainThread]: 
[0m12:19:06.082044 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:19:06.084106 [info ] [MainThread]: 
[0m12:19:06.086039 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m12:19:06.093071 [debug] [MainThread]: Command `dbt run` succeeded at 12:19:06.092083 after 10.56 seconds
[0m12:19:06.094165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F4550C2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F4586ED970>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F458A42BE0>]}
[0m12:19:06.096034 [debug] [MainThread]: Flushing usage events
[0m12:19:52.670342 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021860E21430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002185FDC92E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002185FDC9760>]}


============================== 12:19:52.670342 | 384508d0-df84-4b37-aad6-af356efe5395 ==============================
[0m12:19:52.670342 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:19:52.678779 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_venda_produto_base+', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:19:53.108883 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '384508d0-df84-4b37-aad6-af356efe5395', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021862F90AC0>]}
[0m12:19:53.169507 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '384508d0-df84-4b37-aad6-af356efe5395', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218644AA3A0>]}
[0m12:19:53.169507 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:19:53.179644 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:19:53.269407 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:19:53.269407 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_estoque_produto_base.sql
[0m12:19:53.368964 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '384508d0-df84-4b37-aad6-af356efe5395', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021864927970>]}
[0m12:19:53.376315 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '384508d0-df84-4b37-aad6-af356efe5395', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021864442B80>]}
[0m12:19:53.376315 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:19:53.376315 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '384508d0-df84-4b37-aad6-af356efe5395', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021864442B20>]}
[0m12:19:53.376315 [info ] [MainThread]: 
[0m12:19:53.376315 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:19:53.385037 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:19:53.385037 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:19:54.100771 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m12:19:54.100771 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:19:54.116587 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m12:19:54.116587 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:19:54.787317 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m12:19:54.787317 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:19:54.909767 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m12:19:54.909767 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:19:55.604292 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '384508d0-df84-4b37-aad6-af356efe5395', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002185FD80F40>]}
[0m12:19:55.606434 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:19:55.607425 [info ] [MainThread]: 
[0m12:19:55.627705 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m12:19:55.630097 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_venda_produto_base ................... [RUN]
[0m12:19:55.633873 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_venda_produto_base'
[0m12:19:55.634734 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m12:19:55.646800 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m12:19:55.646800 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 12:19:55.634734 => 12:19:55.646800
[0m12:19:55.649444 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m12:19:55.662075 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:19:56.579906 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m12:19:56.579906 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)    as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)      as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)      as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0) as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)   as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)   as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)   as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)     as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)     as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)   as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)     as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)     as vl_total_seis_meses
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_seis_meses) over () as qt_total_geral
         ,sum(qt_pecas_seis_meses) over (order by qt_pecas_seis_meses desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m12:19:57.043636 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7626560f-a8ed-471a-a7ea-ee2b00bfbccb&page=queryresults
[0m12:20:00.190760 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 12:19:55.649444 => 12:20:00.190760
[0m12:20:00.206636 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '384508d0-df84-4b37-aad6-af356efe5395', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002186497DBB0>]}
[0m12:20:00.206636 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_venda_produto_base .............. [[32mCREATE TABLE (199.0 rows, 121.1 KiB processed)[0m in 4.57s]
[0m12:20:00.206636 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m12:20:00.206636 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m12:20:00.206636 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_estoque_produto_base ................. [RUN]
[0m12:20:00.206636 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_estoque_produto_base'
[0m12:20:00.206636 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m12:20:00.206636 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:20:00.206636 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 12:20:00.206636 => 12:20:00.206636
[0m12:20:00.206636 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m12:20:00.206636 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m12:20:00.860270 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:20:00.876161 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.ds_classificacao_abc             as ds_classificacao_abc
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_venda_produto  as a
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m12:20:01.294814 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:584b4b1b-1d98-4105-9c39-637113c05635&page=queryresults
[0m12:20:03.277901 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 12:20:00.206636 => 12:20:03.275880
[0m12:20:03.277901 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '384508d0-df84-4b37-aad6-af356efe5395', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002186497D940>]}
[0m12:20:03.279925 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_estoque_produto_base ............ [[32mCREATE TABLE (199.0 rows, 122.7 KiB processed)[0m in 3.07s]
[0m12:20:03.282779 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m12:20:03.287384 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:20:03.289413 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:20:03.289413 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m12:20:03.291438 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m12:20:03.291438 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m12:20:03.291438 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m12:20:03.293467 [info ] [MainThread]: 
[0m12:20:03.295495 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 9.92 seconds (9.92s).
[0m12:20:03.297518 [debug] [MainThread]: Command end result
[0m12:20:03.333967 [info ] [MainThread]: 
[0m12:20:03.333967 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:20:03.338996 [info ] [MainThread]: 
[0m12:20:03.341658 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m12:20:03.346495 [debug] [MainThread]: Command `dbt run` succeeded at 12:20:03.346495 after 10.73 seconds
[0m12:20:03.347759 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021860E21430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000218659C0BE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021864796850>]}
[0m12:20:03.347759 [debug] [MainThread]: Flushing usage events
[0m12:22:50.501566 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D34E48C460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D34D4109D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D34D410B80>]}


============================== 12:22:50.501566 | aca65833-1bc7-460f-a211-402435779570 ==============================
[0m12:22:50.501566 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:22:50.501566 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_venda_produto_base+', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:22:50.910261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aca65833-1bc7-460f-a211-402435779570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D34D3FC3D0>]}
[0m12:22:50.982238 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aca65833-1bc7-460f-a211-402435779570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D351B01580>]}
[0m12:22:50.984231 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:22:50.988958 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:22:51.113534 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m12:22:51.129349 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_estoque_produto_base.sql
[0m12:22:51.129349 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_venda_produto_base.sql
[0m12:22:51.224629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aca65833-1bc7-460f-a211-402435779570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D351F36C10>]}
[0m12:22:51.224629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aca65833-1bc7-460f-a211-402435779570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D351DC5040>]}
[0m12:22:51.224629 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:22:51.224629 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aca65833-1bc7-460f-a211-402435779570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D351DBBFD0>]}
[0m12:22:51.224629 [info ] [MainThread]: 
[0m12:22:51.224629 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:22:51.240401 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:22:51.240401 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:22:52.069144 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m12:22:52.069144 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:22:52.069144 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m12:22:52.069144 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:22:52.761228 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m12:22:52.761228 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:22:52.796739 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m12:22:52.797070 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:22:53.450010 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aca65833-1bc7-460f-a211-402435779570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D351B5E910>]}
[0m12:22:53.450010 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:22:53.450010 [info ] [MainThread]: 
[0m12:22:53.460639 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m12:22:53.463443 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_venda_produto_base ................... [RUN]
[0m12:22:53.465500 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_venda_produto_base'
[0m12:22:53.465500 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m12:22:53.482829 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m12:22:53.484785 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 12:22:53.466553 => 12:22:53.483802
[0m12:22:53.486195 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m12:22:53.503884 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:22:54.179594 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m12:22:54.179594 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)    as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)      as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)      as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0) as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)   as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)   as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)   as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)     as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)     as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)   as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)     as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)     as vl_total_seis_meses
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_seis_meses) over () as qt_total_geral
         ,sum(qt_pecas_seis_meses) over (order by qt_pecas_seis_meses desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_seis_meses / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m12:22:54.619507 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3156e2b1-fa44-4778-bfc0-af5917e8ec85&page=queryresults
[0m12:22:57.835718 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 12:22:53.486195 => 12:22:57.835718
[0m12:22:57.835718 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aca65833-1bc7-460f-a211-402435779570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D352FB2D00>]}
[0m12:22:57.835718 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_venda_produto_base .............. [[32mCREATE TABLE (199.0 rows, 121.1 KiB processed)[0m in 4.37s]
[0m12:22:57.835718 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m12:22:57.835718 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m12:22:57.835718 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_estoque_produto_base ................. [RUN]
[0m12:22:57.835718 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_estoque_produto_base'
[0m12:22:57.835718 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m12:22:57.850261 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:22:57.850261 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 12:22:57.835718 => 12:22:57.850261
[0m12:22:57.851775 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m12:22:57.853800 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m12:22:58.487345 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:22:58.487345 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.ds_classificacao_abc             as ds_classificacao_abc
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_venda_produto  as a
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m12:22:58.888092 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6bb54299-0ea3-4376-9a48-16e0bc0c6e13&page=queryresults
[0m12:22:59.301236 [debug] [Thread-2  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Name vl_percentual_participacao not found inside a at [72:13]')
[0m12:22:59.733114 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:428e839a-b261-48bc-a2f2-0eafca59d69e&page=queryresults
[0m12:23:00.140719 [error] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:428e839a-b261-48bc-a2f2-0eafca59d69e&page=queryresults
[0m12:23:00.150146 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 12:22:57.852323 => 12:23:00.150146
[0m12:23:00.160055 [debug] [Thread-2  ]: Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Name vl_percentual_participacao not found inside a at [72:13]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m12:23:00.160055 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aca65833-1bc7-460f-a211-402435779570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D351FAE370>]}
[0m12:23:00.161803 [error] [Thread-2  ]: 2 of 2 ERROR creating sql table model dbt_dw_az.tb_estoque_produto_base ........ [[31mERROR[0m in 2.32s]
[0m12:23:00.164214 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m12:23:00.167404 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:23:00.167404 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:23:00.167404 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m12:23:00.167404 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m12:23:00.167404 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m12:23:00.167404 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m12:23:00.170223 [info ] [MainThread]: 
[0m12:23:00.171242 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 8.95 seconds (8.95s).
[0m12:23:00.172236 [debug] [MainThread]: Command end result
[0m12:23:00.185496 [info ] [MainThread]: 
[0m12:23:00.186498 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:23:00.186498 [info ] [MainThread]: 
[0m12:23:00.186498 [error] [MainThread]:   Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Name vl_percentual_participacao not found inside a at [72:13]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m12:23:00.187499 [info ] [MainThread]: 
[0m12:23:00.187499 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 TOTAL=2
[0m12:23:00.188498 [debug] [MainThread]: Command `dbt run` failed at 12:23:00.188498 after 9.75 seconds
[0m12:23:00.189727 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D34E48C460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D351B01580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D351E86160>]}
[0m12:23:00.189727 [debug] [MainThread]: Flushing usage events
[0m12:23:19.388116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F3A01430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F29A22E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F29A2760>]}


============================== 12:23:19.392131 | a93b3927-1588-4692-8cff-b147cbfd0735 ==============================
[0m12:23:19.392131 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:23:19.393579 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_venda_produto_base+', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m12:23:19.853249 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a93b3927-1588-4692-8cff-b147cbfd0735', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F298CA60>]}
[0m12:23:19.933522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a93b3927-1588-4692-8cff-b147cbfd0735', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F6A35F40>]}
[0m12:23:19.934723 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:23:19.941731 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:23:20.033145 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:23:20.034145 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_estoque_produto_base.sql
[0m12:23:20.145146 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a93b3927-1588-4692-8cff-b147cbfd0735', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F75076A0>]}
[0m12:23:20.157145 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a93b3927-1588-4692-8cff-b147cbfd0735', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F7357BB0>]}
[0m12:23:20.157145 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:23:20.158175 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a93b3927-1588-4692-8cff-b147cbfd0735', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F7433A30>]}
[0m12:23:20.159149 [info ] [MainThread]: 
[0m12:23:20.161148 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:23:20.162151 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:23:20.163152 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:23:20.975302 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m12:23:20.976303 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:23:20.977299 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m12:23:20.978295 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:23:21.612553 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m12:23:21.616559 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:23:21.650639 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m12:23:21.653634 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:23:22.329304 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a93b3927-1588-4692-8cff-b147cbfd0735', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F70E6EB0>]}
[0m12:23:22.331239 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:23:22.333868 [info ] [MainThread]: 
[0m12:23:22.345423 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m12:23:22.346424 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_venda_produto_base ................... [RUN]
[0m12:23:22.349425 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_venda_produto_base'
[0m12:23:22.350419 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m12:23:22.366108 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m12:23:22.367099 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 12:23:22.350419 => 12:23:22.367099
[0m12:23:22.368103 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m12:23:22.383162 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:23:23.070683 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m12:23:23.072192 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)    as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)      as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)      as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0) as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)   as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)   as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)   as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)     as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)     as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)   as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)     as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)     as vl_total_seis_meses
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_seis_meses) over () as qt_total_geral
         ,sum(qt_pecas_seis_meses) over (order by qt_pecas_seis_meses desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_seis_meses / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m12:23:23.444342 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bd852b08-0e58-4199-8fa2-9d9433a720fa&page=queryresults
[0m12:23:26.258980 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 12:23:22.368103 => 12:23:26.258980
[0m12:23:26.260080 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a93b3927-1588-4692-8cff-b147cbfd0735', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F856E9D0>]}
[0m12:23:26.261470 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_venda_produto_base .............. [[32mCREATE TABLE (199.0 rows, 121.1 KiB processed)[0m in 3.91s]
[0m12:23:26.263080 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m12:23:26.264093 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m12:23:26.266202 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_estoque_produto_base ................. [RUN]
[0m12:23:26.268194 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_estoque_produto_base'
[0m12:23:26.269119 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m12:23:26.291848 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:23:26.297411 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 12:23:26.269119 => 12:23:26.296414
[0m12:23:26.301414 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m12:23:26.313470 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m12:23:27.188515 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:23:27.191510 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_venda_produto  as a
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m12:23:27.563175 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bd98ec29-8061-4103-b496-36c767fbf805&page=queryresults
[0m12:23:29.777239 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 12:23:26.302935 => 12:23:29.776242
[0m12:23:29.780271 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a93b3927-1588-4692-8cff-b147cbfd0735', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F7559A90>]}
[0m12:23:29.782238 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_estoque_produto_base ............ [[32mCREATE TABLE (199.0 rows, 124.2 KiB processed)[0m in 3.51s]
[0m12:23:29.785503 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m12:23:29.790997 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:23:29.791996 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:23:29.794543 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m12:23:29.795528 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m12:23:29.796532 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m12:23:29.797542 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m12:23:29.798530 [info ] [MainThread]: 
[0m12:23:29.799534 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 9.64 seconds (9.64s).
[0m12:23:29.801532 [debug] [MainThread]: Command end result
[0m12:23:29.839685 [info ] [MainThread]: 
[0m12:23:29.841976 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:23:29.843514 [info ] [MainThread]: 
[0m12:23:29.845348 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m12:23:29.848380 [debug] [MainThread]: Command `dbt run` succeeded at 12:23:29.847351 after 10.54 seconds
[0m12:23:29.850366 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F3A01430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F734BE80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000233F7376580>]}
[0m12:23:29.852363 [debug] [MainThread]: Flushing usage events
[0m13:00:04.139445 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023017FF3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023016F7F9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023016F7FD30>]}


============================== 13:00:04.150518 | 667c6db9-a4c9-4e32-8945-12d7726890a3 ==============================
[0m13:00:04.150518 [info ] [MainThread]: Running with dbt=1.7.4
[0m13:00:04.150518 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --exclude tag:snaps', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:00:04.675035 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023016F7FD90>]}
[0m13:00:04.722713 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301B660700>]}
[0m13:00:04.722713 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m13:00:04.738571 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m13:00:04.834683 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:00:04.834683 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:00:04.834683 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301B938550>]}
[0m13:00:04.850473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301B92C160>]}
[0m13:00:04.850473 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m13:00:04.850473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301B92C1C0>]}
[0m13:00:04.850473 [info ] [MainThread]: 
[0m13:00:04.850473 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:00:04.850473 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:00:04.850473 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:04.850473 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:00:04.866522 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:05.751955 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:06.473852 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m13:00:06.473852 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:06.473852 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m13:00:06.473852 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:07.201463 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m13:00:07.201463 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:07.245638 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m13:00:07.245638 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:07.930710 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301B6E17F0>]}
[0m13:00:07.930710 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:00:07.930710 [info ] [MainThread]: 
[0m13:00:07.946385 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:07.946385 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m13:00:07.946385 [info ] [Thread-1  ]: 1 of 20 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m13:00:07.950246 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m13:00:07.950246 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:07.962216 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m13:00:07.950246 [info ] [Thread-2  ]: 2 of 20 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m13:00:07.962216 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m13:00:07.962216 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m13:00:07.982388 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m13:00:07.982388 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 13:00:07.950246 => 13:00:07.982388
[0m13:00:07.982388 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:08.010007 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m13:00:08.010007 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 13:00:07.962216 => 13:00:08.010007
[0m13:00:08.010007 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m13:00:08.026228 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m13:00:08.026228 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m13:00:08.026228 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m13:00:08.042338 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m13:00:08.042338 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m13:00:09.028643 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c1fd854d-2241-4073-85ad-ca652e20a7fc&page=queryresults
[0m13:00:09.056815 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e9ffd49b-2c68-4b82-97e9-829e50faa0a4&page=queryresults
[0m13:00:09.471368 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 13:00:08.010007 => 13:00:09.471368
[0m13:00:09.471368 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301CA29040>]}
[0m13:00:09.471368 [info ] [Thread-2  ]: 2 of 20 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.51s]
[0m13:00:09.471368 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m13:00:09.471368 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m13:00:09.471368 [info ] [Thread-2  ]: 3 of 20 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m13:00:09.471368 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m13:00:09.471368 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m13:00:09.471368 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m13:00:09.487282 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 13:00:09.471368 => 13:00:09.487282
[0m13:00:09.487282 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m13:00:09.487282 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m13:00:09.487282 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 13:00:07.982388 => 13:00:09.487282
[0m13:00:09.487282 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301C9FA9A0>]}
[0m13:00:09.487282 [info ] [Thread-1  ]: 1 of 20 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m13:00:09.487282 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:09.487282 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m13:00:09.487282 [info ] [Thread-1  ]: 4 of 20 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m13:00:09.487282 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m13:00:09.487282 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m13:00:09.503404 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:09.503404 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m13:00:09.503404 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m13:00:09.519624 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 13:00:09.487282 => 13:00:09.519624
[0m13:00:09.519624 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m13:00:09.519624 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m13:00:09.519624 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:09.519624 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m13:00:10.309197 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:94dfcf37-39b5-42d8-8ff2-1955e32d6a0e&page=queryresults
[0m13:00:10.328801 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:02ed1ace-cc79-4127-8203-e85cb1f952ce&page=queryresults
[0m13:00:10.715051 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 13:00:09.487282 => 13:00:10.715051
[0m13:00:10.715051 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301CA1E910>]}
[0m13:00:10.715051 [info ] [Thread-2  ]: 3 of 20 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m13:00:10.715051 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m13:00:10.715051 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m13:00:10.715051 [info ] [Thread-2  ]: 5 of 20 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m13:00:10.715051 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m13:00:10.715051 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m13:00:10.731229 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m13:00:10.731229 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 13:00:10.715051 => 13:00:10.731229
[0m13:00:10.731229 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m13:00:10.731229 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m13:00:10.731229 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:10.731229 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m13:00:10.763323 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 13:00:09.519624 => 13:00:10.763323
[0m13:00:10.763323 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301B96D7F0>]}
[0m13:00:10.763323 [info ] [Thread-1  ]: 4 of 20 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m13:00:10.763323 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m13:00:10.763323 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m13:00:10.763323 [info ] [Thread-1  ]: 6 of 20 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m13:00:10.763323 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m13:00:10.763323 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m13:00:10.763323 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m13:00:10.763323 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 13:00:10.763323 => 13:00:10.763323
[0m13:00:10.763323 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m13:00:10.763323 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m13:00:10.763323 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:10.763323 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m13:00:11.508218 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f901273a-c659-4ce5-bb2f-1e051b9a2dd6&page=queryresults
[0m13:00:11.540572 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:09252b98-d50b-46c7-9198-cd325d96cc7c&page=queryresults
[0m13:00:11.916287 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 13:00:10.731229 => 13:00:11.915289
[0m13:00:11.917293 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301C9C0E20>]}
[0m13:00:11.918290 [info ] [Thread-2  ]: 5 of 20 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m13:00:11.919288 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m13:00:11.919288 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:11.919288 [info ] [Thread-2  ]: 7 of 20 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m13:00:11.919288 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m13:00:11.919288 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:11.935133 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m13:00:11.935133 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 13:00:11.919288 => 13:00:11.935133
[0m13:00:11.935133 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:11.935133 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m13:00:11.935133 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:11.935133 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m13:00:11.967118 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 13:00:10.763323 => 13:00:11.967118
[0m13:00:11.967118 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301C9C0C40>]}
[0m13:00:11.967118 [info ] [Thread-1  ]: 6 of 20 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m13:00:11.967118 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m13:00:11.967118 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m13:00:11.967118 [info ] [Thread-1  ]: 8 of 20 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m13:00:11.967118 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m13:00:11.967118 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m13:00:11.967118 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m13:00:11.967118 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 13:00:11.967118 => 13:00:11.967118
[0m13:00:11.967118 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m13:00:11.967118 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m13:00:11.967118 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:11.983031 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m13:00:12.720538 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8f808167-4137-4b07-b380-c3da73584a5a&page=queryresults
[0m13:00:12.720538 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ddea7721-2af9-4a59-b30b-a987b4179c92&page=queryresults
[0m13:00:13.155611 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 13:00:11.967118 => 13:00:13.153596
[0m13:00:13.155611 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301CA11640>]}
[0m13:00:13.157628 [info ] [Thread-1  ]: 8 of 20 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m13:00:13.157628 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m13:00:13.157628 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m13:00:13.161101 [info ] [Thread-1  ]: 9 of 20 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m13:00:13.161101 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto)
[0m13:00:13.164490 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m13:00:13.171537 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m13:00:13.173549 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 13:00:13.164490 => 13:00:13.173549
[0m13:00:13.173549 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m13:00:13.177571 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m13:00:13.177571 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:13.179580 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m13:00:13.202914 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 13:00:11.935133 => 13:00:13.202914
[0m13:00:13.202914 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301B6B5FA0>]}
[0m13:00:13.202914 [info ] [Thread-2  ]: 7 of 20 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m13:00:13.202914 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:13.202914 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m13:00:13.202914 [info ] [Thread-2  ]: 10 of 20 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m13:00:13.202914 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_tempo)
[0m13:00:13.202914 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m13:00:13.202914 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m13:00:13.202914 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 13:00:13.202914 => 13:00:13.202914
[0m13:00:13.202914 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m13:00:13.202914 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m13:00:13.218734 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:13.218734 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m13:00:13.932414 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b894d0a1-0234-4bef-ba8a-02cb9a4c2789&page=queryresults
[0m13:00:13.962203 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:256acc44-7b4e-4305-bbc2-54a38e5bcfcc&page=queryresults
[0m13:00:14.347717 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 13:00:13.173549 => 13:00:14.347717
[0m13:00:14.349733 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301CB1D550>]}
[0m13:00:14.349733 [info ] [Thread-1  ]: 9 of 20 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m13:00:14.351749 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m13:00:14.351749 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m13:00:14.351749 [info ] [Thread-1  ]: 11 of 20 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m13:00:14.351749 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m13:00:14.358386 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m13:00:14.364155 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m13:00:14.366168 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 13:00:14.358386 => 13:00:14.364155
[0m13:00:14.366168 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m13:00:14.379978 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:14.379978 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 13:00:13.202914 => 13:00:14.379978
[0m13:00:14.379978 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301CA77100>]}
[0m13:00:14.379978 [info ] [Thread-2  ]: 10 of 20 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m13:00:14.434609 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m13:00:15.184418 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m13:00:15.190510 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m13:00:15.854027 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:21a59c5b-bdd3-4754-a03c-f80666454fc8&page=queryresults
[0m13:00:18.697336 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 13:00:14.366168 => 13:00:18.697336
[0m13:00:18.697336 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301CA112B0>]}
[0m13:00:18.697336 [info ] [Thread-1  ]: 11 of 20 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 4.35s]
[0m13:00:18.713320 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m13:00:18.713320 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m13:00:18.713320 [info ] [Thread-2  ]: 12 of 20 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m13:00:18.713320 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m13:00:18.713320 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m13:00:18.713320 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m13:00:18.729432 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 13:00:18.713320 => 13:00:18.729432
[0m13:00:18.729432 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m13:00:18.729432 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:19.422166 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m13:00:19.424181 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m13:00:20.092920 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a78dd0da-12e1-4a46-92d0-8e6a79ef595f&page=queryresults
[0m13:00:22.648317 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 13:00:18.729432 => 13:00:22.648317
[0m13:00:22.663225 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301CB1DAF0>]}
[0m13:00:22.663225 [info ] [Thread-2  ]: 12 of 20 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 3.93s]
[0m13:00:22.663225 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m13:00:22.663225 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m13:00:22.663225 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m13:00:22.663225 [info ] [Thread-1  ]: 13 of 20 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m13:00:22.663225 [info ] [Thread-2  ]: 14 of 20 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m13:00:22.663225 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m13:00:22.663225 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m13:00:22.663225 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m13:00:22.663225 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m13:00:22.678939 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m13:00:22.687148 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 13:00:22.663225 => 13:00:22.687148
[0m13:00:22.687148 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m13:00:22.692566 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:22.706642 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m13:00:22.757690 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 13:00:22.663225 => 13:00:22.757690
[0m13:00:22.757690 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m13:00:22.763876 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:23.437810 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m13:00:23.437810 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m13:00:23.458708 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m13:00:23.460723 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m13:00:23.840069 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6784f744-3028-4f3a-a40c-2eedaa5c0627&page=queryresults
[0m13:00:24.074509 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:989cc02e-f8ee-4775-867e-acc9d8a9ad15&page=queryresults
[0m13:00:25.767768 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 13:00:22.690555 => 13:00:25.767768
[0m13:00:25.767768 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301CB74220>]}
[0m13:00:25.779478 [info ] [Thread-2  ]: 14 of 20 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 82.4 KiB processed)[0m in 3.10s]
[0m13:00:25.779478 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m13:00:25.782499 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m13:00:25.782499 [info ] [Thread-2  ]: 15 of 20 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m13:00:25.782499 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_pedido)
[0m13:00:25.782499 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m13:00:25.782499 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m13:00:25.782499 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 13:00:25.782499 => 13:00:25.782499
[0m13:00:25.782499 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m13:00:25.795400 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:26.320082 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 13:00:22.757690 => 13:00:26.320082
[0m13:00:26.323205 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301CA11250>]}
[0m13:00:26.323205 [info ] [Thread-1  ]: 13 of 20 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 108.6 KiB processed)[0m in 3.66s]
[0m13:00:26.323205 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m13:00:26.323205 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m13:00:26.323205 [info ] [Thread-1  ]: 16 of 20 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m13:00:26.323205 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_preco_produto)
[0m13:00:26.323205 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m13:00:26.323205 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m13:00:26.323205 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 13:00:26.323205 => 13:00:26.323205
[0m13:00:26.323205 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m13:00:26.339159 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:26.460237 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m13:00:26.462254 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m13:00:27.107529 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e6d679b2-76d6-494a-a8ec-ae2c39c4a051&page=queryresults
[0m13:00:27.209848 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m13:00:27.211863 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m13:00:27.906180 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c727eb7d-8e28-45d8-887e-14fafe253bbe&page=queryresults
[0m13:00:30.529705 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 13:00:25.782499 => 13:00:30.514025
[0m13:00:30.529705 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301DB90310>]}
[0m13:00:30.529705 [info ] [Thread-2  ]: 15 of 20 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 4.75s]
[0m13:00:30.529705 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m13:00:30.529705 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m13:00:30.529705 [info ] [Thread-2  ]: 17 of 20 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m13:00:30.529705 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m13:00:30.529705 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m13:00:30.545527 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m13:00:30.545527 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 13:00:30.529705 => 13:00:30.545527
[0m13:00:30.545527 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m13:00:30.545527 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:31.214070 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m13:00:31.214070 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m13:00:31.279215 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 13:00:26.323205 => 13:00:31.279215
[0m13:00:31.294465 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301CB1DB80>]}
[0m13:00:31.294465 [info ] [Thread-1  ]: 16 of 20 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (309.0 rows, 81.0 KiB processed)[0m in 4.97s]
[0m13:00:31.296471 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m13:00:31.599897 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:28c5b7ac-9f72-4be1-8771-495de154583b&page=queryresults
[0m13:00:34.169124 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 13:00:30.545527 => 13:00:34.169124
[0m13:00:34.170536 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301CBACC40>]}
[0m13:00:34.172680 [info ] [Thread-2  ]: 17 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 413.1 KiB processed)[0m in 3.64s]
[0m13:00:34.174571 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m13:00:34.175573 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m13:00:34.176572 [info ] [Thread-1  ]: 18 of 20 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m13:00:34.178571 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m13:00:34.178571 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m13:00:34.178571 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m13:00:34.178571 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 13:00:34.178571 => 13:00:34.178571
[0m13:00:34.189507 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m13:00:34.193534 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:34.860270 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m13:00:34.876308 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m13:00:35.271798 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4bdf7032-deb5-4aa9-938a-f1ea2ecab1e4&page=queryresults
[0m13:00:37.516056 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 13:00:34.189507 => 13:00:37.516056
[0m13:00:37.518071 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301CA118B0>]}
[0m13:00:37.518071 [info ] [Thread-1  ]: 18 of 20 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (320.0 rows, 266.9 KiB processed)[0m in 3.34s]
[0m13:00:37.518071 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m13:00:37.518071 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m13:00:37.518071 [info ] [Thread-2  ]: 19 of 20 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m13:00:37.518071 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m13:00:37.518071 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m13:00:37.534149 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m13:00:37.534149 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 13:00:37.518071 => 13:00:37.534149
[0m13:00:37.538047 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m13:00:37.544094 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:38.234771 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m13:00:38.234771 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)    as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)      as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)      as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0) as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)   as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)   as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)   as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)     as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)     as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)   as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)     as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)     as vl_total_seis_meses
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_seis_meses) over () as qt_total_geral
         ,sum(qt_pecas_seis_meses) over (order by qt_pecas_seis_meses desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_seis_meses / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m13:00:38.682290 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:07c76b8b-f47f-41a8-9308-68b6f67a8f95&page=queryresults
[0m13:00:41.842267 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 13:00:37.540063 => 13:00:41.842267
[0m13:00:41.844022 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301DBEED30>]}
[0m13:00:41.844022 [info ] [Thread-2  ]: 19 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (199.0 rows, 121.1 KiB processed)[0m in 4.33s]
[0m13:00:41.846034 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m13:00:41.846034 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m13:00:41.848046 [info ] [Thread-1  ]: 20 of 20 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m13:00:41.848046 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_estoque_produto_base)
[0m13:00:41.848046 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m13:00:41.848046 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m13:00:41.848046 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 13:00:41.848046 => 13:00:41.848046
[0m13:00:41.848046 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m13:00:41.859927 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:42.560967 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m13:00:42.562985 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_venda_produto  as a
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m13:00:42.968196 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:245b4068-06af-44cf-bfd0-62ed8c6747ce&page=queryresults
[0m13:00:45.234843 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 13:00:41.848046 => 13:00:45.234843
[0m13:00:45.236857 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '667c6db9-a4c9-4e32-8945-12d7726890a3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301DBDFA00>]}
[0m13:00:45.236857 [info ] [Thread-1  ]: 20 of 20 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (199.0 rows, 124.2 KiB processed)[0m in 3.39s]
[0m13:00:45.236857 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m13:00:45.236857 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:00:45.243140 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:00:45.243140 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:00:45.243140 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m13:00:45.243140 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m13:00:45.245152 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m13:00:45.245152 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m13:00:45.245152 [info ] [MainThread]: 
[0m13:00:45.245152 [info ] [MainThread]: Finished running 10 view models, 10 table models in 0 hours 0 minutes and 40.39 seconds (40.39s).
[0m13:00:45.252567 [debug] [MainThread]: Command end result
[0m13:00:45.268694 [info ] [MainThread]: 
[0m13:00:45.268694 [info ] [MainThread]: [32mCompleted successfully[0m
[0m13:00:45.268694 [info ] [MainThread]: 
[0m13:00:45.268694 [info ] [MainThread]: Done. PASS=20 WARN=0 ERROR=0 SKIP=0 TOTAL=20
[0m13:00:45.268694 [debug] [MainThread]: Command `dbt run` succeeded at 13:00:45.268694 after 41.18 seconds
[0m13:00:45.275631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023017FF3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301CAFDD00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002301B5F7E50>]}
[0m13:00:45.275631 [debug] [MainThread]: Flushing usage events
[0m13:00:49.466054 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237CAB03430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237C9A87670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237C9A87AC0>]}


============================== 13:00:49.466054 | e46dae3e-5c73-4d73-9e91-60c82d4fa81e ==============================
[0m13:00:49.466054 [info ] [MainThread]: Running with dbt=1.7.4
[0m13:00:49.466054 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:00:49.986150 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e46dae3e-5c73-4d73-9e91-60c82d4fa81e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237C9A87850>]}
[0m13:00:50.034206 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e46dae3e-5c73-4d73-9e91-60c82d4fa81e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237CE103100>]}
[0m13:00:50.034206 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m13:00:50.050207 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m13:00:50.095488 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:00:50.095488 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:00:50.095488 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e46dae3e-5c73-4d73-9e91-60c82d4fa81e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237CE4464F0>]}
[0m13:00:50.111127 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e46dae3e-5c73-4d73-9e91-60c82d4fa81e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237CE43B130>]}
[0m13:00:50.111127 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m13:00:50.111127 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e46dae3e-5c73-4d73-9e91-60c82d4fa81e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237CE43B0A0>]}
[0m13:00:50.111127 [info ] [MainThread]: 
[0m13:00:50.111127 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:00:50.111127 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:00:50.111127 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:50.818424 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m13:00:50.818424 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:50.850695 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m13:00:50.850695 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:51.506485 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m13:00:51.522315 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:51.554165 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m13:00:51.554165 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:52.410937 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e46dae3e-5c73-4d73-9e91-60c82d4fa81e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237CE1C8C40>]}
[0m13:00:52.410937 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:00:52.410937 [info ] [MainThread]: 
[0m13:00:52.422615 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m13:00:52.424594 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m13:00:52.424594 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m13:00:52.424594 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m13:00:52.438427 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 13:00:52.424594 => 13:00:52.438427
[0m13:00:52.438427 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m13:00:52.470265 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m13:00:52.470265 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m13:00:53.418408 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:918e2f7a-d2cf-46fc-8040-9c064e472b36&page=queryresults
[0m13:00:54.640335 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m13:00:55.148733 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:661fc810-c0d7-4fc7-9501-634a5f0817cb&page=queryresults
[0m13:00:57.906354 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m13:00:58.766826 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m13:00:58.768838 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m13:00:59.178535 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c0ac1ddc-007b-470b-8575-beafa3347ebc&page=queryresults
[0m13:01:02.021267 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 13:00:52.438427 => 13:01:02.021267
[0m13:01:02.023283 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e46dae3e-5c73-4d73-9e91-60c82d4fa81e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237CE49CFD0>]}
[0m13:01:02.023283 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 66.0 KiB processed)[0m in 9.60s]
[0m13:01:02.025299 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m13:01:02.030517 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:01:02.030517 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:01:02.030517 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m13:01:02.032532 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m13:01:02.032532 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m13:01:02.032532 [info ] [MainThread]: 
[0m13:01:02.032532 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 11.92 seconds (11.92s).
[0m13:01:02.032532 [debug] [MainThread]: Command end result
[0m13:01:02.052878 [info ] [MainThread]: 
[0m13:01:02.052878 [info ] [MainThread]: [32mCompleted successfully[0m
[0m13:01:02.052878 [info ] [MainThread]: 
[0m13:01:02.052878 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m13:01:02.060059 [debug] [MainThread]: Command `dbt snapshot` succeeded at 13:01:02.060059 after 12.64 seconds
[0m13:01:02.060059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237CAB03430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237CF4E67F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237C9A870D0>]}
[0m13:01:02.060059 [debug] [MainThread]: Flushing usage events
[0m13:01:05.698854 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236465D3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002364555F910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002364555FB80>]}


============================== 13:01:05.710917 | 5579e49a-2600-40d9-9f05-3caefb6e1c89 ==============================
[0m13:01:05.710917 [info ] [MainThread]: Running with dbt=1.7.4
[0m13:01:05.710917 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select tag:snaps', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:01:06.218952 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5579e49a-2600-40d9-9f05-3caefb6e1c89', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002364554D190>]}
[0m13:01:06.267096 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5579e49a-2600-40d9-9f05-3caefb6e1c89', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023649B14D00>]}
[0m13:01:06.267096 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m13:01:06.283116 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m13:01:06.330974 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:01:06.330974 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:01:06.330974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5579e49a-2600-40d9-9f05-3caefb6e1c89', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023649F18670>]}
[0m13:01:06.346977 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5579e49a-2600-40d9-9f05-3caefb6e1c89', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023649F0C0D0>]}
[0m13:01:06.346977 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m13:01:06.346977 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5579e49a-2600-40d9-9f05-3caefb6e1c89', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023649CEF670>]}
[0m13:01:06.346977 [info ] [MainThread]: 
[0m13:01:06.346977 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:01:06.346977 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:01:06.346977 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:01:07.036249 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m13:01:07.037244 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:01:07.069708 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m13:01:07.069708 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:01:07.709062 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m13:01:07.711081 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:01:07.735836 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m13:01:07.751526 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:01:08.420289 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5579e49a-2600-40d9-9f05-3caefb6e1c89', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023649BD9100>]}
[0m13:01:08.425995 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:01:08.425995 [info ] [MainThread]: 
[0m13:01:08.436314 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m13:01:08.436314 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m13:01:08.436314 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m13:01:08.436314 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m13:01:08.436314 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m13:01:08.436314 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 13:01:08.436314 => 13:01:08.436314
[0m13:01:08.436314 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m13:01:08.452091 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m13:01:09.158525 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m13:01:09.158525 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m13:01:09.540227 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1ba767f8-2894-46bb-a11c-36538a7424ff&page=queryresults
[0m13:01:11.556444 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 13:01:08.436314 => 13:01:11.556444
[0m13:01:11.556444 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5579e49a-2600-40d9-9f05-3caefb6e1c89', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023649FB9FA0>]}
[0m13:01:11.556444 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (366.0 rows, 53.8 KiB processed)[0m in 3.12s]
[0m13:01:11.556444 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m13:01:11.556444 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:01:11.556444 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:01:11.556444 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m13:01:11.556444 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m13:01:11.556444 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m13:01:11.556444 [info ] [MainThread]: 
[0m13:01:11.556444 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.21 seconds (5.21s).
[0m13:01:11.556444 [debug] [MainThread]: Command end result
[0m13:01:11.588606 [info ] [MainThread]: 
[0m13:01:11.588606 [info ] [MainThread]: [32mCompleted successfully[0m
[0m13:01:11.588606 [info ] [MainThread]: 
[0m13:01:11.588606 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m13:01:11.588606 [debug] [MainThread]: Command `dbt run` succeeded at 13:01:11.588606 after 5.95 seconds
[0m13:01:11.588606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000236465D3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002364AFA6070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023649EFCBE0>]}
[0m13:01:11.588606 [debug] [MainThread]: Flushing usage events
[0m14:00:04.171270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018243BC3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018242B3D6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018242B3DE20>]}


============================== 14:00:04.175269 | 7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b ==============================
[0m14:00:04.175269 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:00:04.176264 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --exclude tag:snaps', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:00:04.731180 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018242B451C0>]}
[0m14:00:04.794475 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018247231B20>]}
[0m14:00:04.796450 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m14:00:04.802996 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m14:00:04.855840 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:00:04.855840 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:00:04.860810 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018247507580>]}
[0m14:00:04.870795 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182474FC2E0>]}
[0m14:00:04.870795 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m14:00:04.871808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182471CD250>]}
[0m14:00:04.873847 [info ] [MainThread]: 
[0m14:00:04.874787 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:00:04.876809 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:04.876809 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:04.877787 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:04.877787 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:05.716225 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:06.470105 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m14:00:06.471096 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:06.473045 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m14:00:06.474092 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:07.186105 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m14:00:07.187195 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:07.294455 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m14:00:07.295457 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:08.090508 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018247181BE0>]}
[0m14:00:08.092503 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:00:08.093560 [info ] [MainThread]: 
[0m14:00:08.103697 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:08.105696 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m14:00:08.104694 [info ] [Thread-1  ]: 1 of 20 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m14:00:08.108693 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m14:00:08.108693 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:08.120688 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m14:00:08.106739 [info ] [Thread-2  ]: 2 of 20 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m14:00:08.122794 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m14:00:08.122794 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m14:00:08.131688 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m14:00:08.131688 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 14:00:08.109692 => 14:00:08.131688
[0m14:00:08.132729 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:08.157687 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m14:00:08.158688 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 14:00:08.123801 => 14:00:08.158688
[0m14:00:08.158688 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m14:00:08.160689 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m14:00:08.161791 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m14:00:08.162689 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m14:00:08.183966 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m14:00:08.184966 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m14:00:09.004899 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:72876697-8018-4568-98ee-b72bddf36dda&page=queryresults
[0m14:00:09.112164 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dcbafcfa-9fea-46f8-8268-b18b47a97447&page=queryresults
[0m14:00:09.450631 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 14:00:08.158688 => 14:00:09.450631
[0m14:00:09.452685 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018248606A00>]}
[0m14:00:09.453591 [info ] [Thread-2  ]: 2 of 20 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m14:00:09.454592 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m14:00:09.455683 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m14:00:09.456687 [info ] [Thread-2  ]: 3 of 20 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m14:00:09.457593 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m14:00:09.458673 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m14:00:09.462679 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m14:00:09.463678 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 14:00:09.458673 => 14:00:09.463678
[0m14:00:09.464655 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m14:00:09.467679 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m14:00:09.468672 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:09.470594 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m14:00:09.558336 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 14:00:08.132729 => 14:00:09.558336
[0m14:00:09.560267 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182485CA9D0>]}
[0m14:00:09.561256 [info ] [Thread-1  ]: 1 of 20 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m14:00:09.563246 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:09.564337 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m14:00:09.565339 [info ] [Thread-1  ]: 4 of 20 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m14:00:09.567293 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m14:00:09.568214 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m14:00:09.585275 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m14:00:09.587253 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 14:00:09.569207 => 14:00:09.586327
[0m14:00:09.587253 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m14:00:09.591245 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m14:00:09.592297 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:09.593310 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m14:00:10.263684 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7323a668-0fc6-436b-b31c-a62524345fff&page=queryresults
[0m14:00:10.411873 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cd09c90c-cf70-4f37-9fab-92a80c3bc706&page=queryresults
[0m14:00:10.697159 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 14:00:09.464655 => 14:00:10.697159
[0m14:00:10.698157 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182486770D0>]}
[0m14:00:10.700154 [info ] [Thread-2  ]: 3 of 20 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m14:00:10.701552 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m14:00:10.702547 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m14:00:10.703541 [info ] [Thread-2  ]: 5 of 20 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m14:00:10.704542 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m14:00:10.705538 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m14:00:10.712542 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m14:00:10.713545 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 14:00:10.706547 => 14:00:10.713545
[0m14:00:10.714545 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m14:00:10.718537 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m14:00:10.719539 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:10.721536 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m14:00:10.821841 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 14:00:09.587253 => 14:00:10.821841
[0m14:00:10.823842 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182485B6310>]}
[0m14:00:10.824843 [info ] [Thread-1  ]: 4 of 20 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m14:00:10.826844 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m14:00:10.827840 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m14:00:10.827840 [info ] [Thread-1  ]: 6 of 20 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m14:00:10.829844 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m14:00:10.830844 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m14:00:10.836838 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m14:00:10.837839 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 14:00:10.831842 => 14:00:10.837839
[0m14:00:10.838834 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m14:00:10.841833 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m14:00:10.842833 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:10.844833 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m14:00:11.490764 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:673dfe3a-4986-40a7-a387-385a641d8c2d&page=queryresults
[0m14:00:11.644373 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1fb6729b-104b-4037-940e-bb22da1c3444&page=queryresults
[0m14:00:11.884628 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 14:00:10.714545 => 14:00:11.883625
[0m14:00:11.885626 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018248591DF0>]}
[0m14:00:11.886626 [info ] [Thread-2  ]: 5 of 20 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m14:00:11.888628 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m14:00:11.888628 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:11.889624 [info ] [Thread-2  ]: 7 of 20 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m14:00:11.891716 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m14:00:11.891716 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:11.905725 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m14:00:11.906727 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 14:00:11.892721 => 14:00:11.906727
[0m14:00:11.907725 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:11.910630 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m14:00:11.911915 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:11.912913 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m14:00:12.022453 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 14:00:10.838834 => 14:00:12.021373
[0m14:00:12.023455 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018248591AF0>]}
[0m14:00:12.024446 [info ] [Thread-1  ]: 6 of 20 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m14:00:12.026447 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m14:00:12.027451 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m14:00:12.028449 [info ] [Thread-1  ]: 8 of 20 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m14:00:12.030335 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m14:00:12.031700 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m14:00:12.038812 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m14:00:12.042742 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 14:00:12.031700 => 14:00:12.041678
[0m14:00:12.042742 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m14:00:12.048803 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m14:00:12.050734 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:12.053798 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m14:00:12.731168 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a312f35c-8030-42b1-9f5f-32ce89da2e5f&page=queryresults
[0m14:00:12.807622 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d63971a5-983a-49c4-bb4b-eb87187121cc&page=queryresults
[0m14:00:13.134738 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 14:00:11.907725 => 14:00:13.134738
[0m14:00:13.136739 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018248606A00>]}
[0m14:00:13.137740 [info ] [Thread-2  ]: 7 of 20 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m14:00:13.138798 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:13.139832 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m14:00:13.140735 [info ] [Thread-2  ]: 9 of 20 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m14:00:13.142817 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m14:00:13.142817 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m14:00:13.149814 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m14:00:13.151815 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 14:00:13.143815 => 14:00:13.150814
[0m14:00:13.151815 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m14:00:13.157814 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m14:00:13.158815 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:13.161812 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m14:00:13.206987 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 14:00:12.043804 => 14:00:13.206987
[0m14:00:13.207980 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001824866DD60>]}
[0m14:00:13.207980 [info ] [Thread-1  ]: 8 of 20 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m14:00:13.208978 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m14:00:13.209989 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m14:00:13.211284 [info ] [Thread-1  ]: 10 of 20 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m14:00:13.212395 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_tempo)
[0m14:00:13.212395 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m14:00:13.216384 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m14:00:13.218389 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 14:00:13.212395 => 14:00:13.217383
[0m14:00:13.218389 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m14:00:13.232765 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m14:00:13.234695 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:13.237767 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m14:00:14.093501 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2a7753c8-e399-4cc9-b5a7-b9f97615c659&page=queryresults
[0m14:00:14.110613 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bf44af35-c706-4151-b600-3469ccc58ac6&page=queryresults
[0m14:00:14.467575 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 14:00:13.152816 => 14:00:14.467575
[0m14:00:14.468574 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182475947C0>]}
[0m14:00:14.470496 [info ] [Thread-2  ]: 9 of 20 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m14:00:14.471509 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m14:00:14.473519 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m14:00:14.474571 [info ] [Thread-2  ]: 11 of 20 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m14:00:14.475526 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m14:00:14.476571 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m14:00:14.481500 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m14:00:14.483573 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 14:00:14.476571 => 14:00:14.482488
[0m14:00:14.483573 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m14:00:14.491479 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:14.493537 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 14:00:13.219395 => 14:00:14.493537
[0m14:00:14.494541 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182486064F0>]}
[0m14:00:14.494541 [info ] [Thread-1  ]: 10 of 20 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m14:00:14.514536 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m14:00:15.212826 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m14:00:15.213769 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m14:00:15.863114 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dd4d7022-43c4-467a-8dcd-9e18bc214347&page=queryresults
[0m14:00:18.729683 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 14:00:14.484511 => 14:00:18.729683
[0m14:00:18.731678 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018248606490>]}
[0m14:00:18.733660 [info ] [Thread-2  ]: 11 of 20 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 4.26s]
[0m14:00:18.735671 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m14:00:18.738386 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m14:00:18.739359 [info ] [Thread-1  ]: 12 of 20 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m14:00:18.742331 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m14:00:18.743315 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m14:00:18.750623 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m14:00:18.752749 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 14:00:18.744334 => 14:00:18.752749
[0m14:00:18.753747 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m14:00:18.755737 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:19.418289 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m14:00:19.421783 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m14:00:20.182026 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f3d0f4bd-134f-4701-831c-9869cbb46873&page=queryresults
[0m14:00:22.699631 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 14:00:18.753747 => 14:00:22.698630
[0m14:00:22.700632 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182485DE100>]}
[0m14:00:22.701628 [info ] [Thread-1  ]: 12 of 20 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 3.96s]
[0m14:00:22.703961 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m14:00:22.705183 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m14:00:22.707236 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m14:00:22.706329 [info ] [Thread-2  ]: 13 of 20 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m14:00:22.709332 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m14:00:22.710196 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m14:00:22.708239 [info ] [Thread-1  ]: 14 of 20 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m14:00:22.719241 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m14:00:22.720656 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m14:00:22.722774 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m14:00:22.728857 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m14:00:22.731763 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 14:00:22.712241 => 14:00:22.730787
[0m14:00:22.731763 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m14:00:22.735861 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:22.736865 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 14:00:22.723786 => 14:00:22.736865
[0m14:00:22.737856 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m14:00:22.740800 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:23.428544 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m14:00:23.431541 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m14:00:23.452750 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m14:00:23.454757 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m14:00:23.858993 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a9610e6b-d9c6-410e-9f45-7a0c30740a4a&page=queryresults
[0m14:00:24.102655 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6fc316d4-0dc3-45a6-924c-2a8e7ed21456&page=queryresults
[0m14:00:26.052501 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 14:00:22.737856 => 14:00:26.052501
[0m14:00:26.054500 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182486D21F0>]}
[0m14:00:26.055513 [info ] [Thread-1  ]: 14 of 20 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 82.5 KiB processed)[0m in 3.33s]
[0m14:00:26.057769 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m14:00:26.058767 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m14:00:26.058767 [info ] [Thread-1  ]: 15 of 20 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m14:00:26.060720 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_pedido)
[0m14:00:26.061693 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m14:00:26.068726 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m14:00:26.070682 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 14:00:26.061693 => 14:00:26.070682
[0m14:00:26.071647 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m14:00:26.075719 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:26.100634 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 14:00:22.732781 => 14:00:26.100634
[0m14:00:26.100634 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182486D2460>]}
[0m14:00:26.101737 [info ] [Thread-2  ]: 13 of 20 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 108.6 KiB processed)[0m in 3.39s]
[0m14:00:26.102707 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m14:00:26.102707 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m14:00:26.102707 [info ] [Thread-2  ]: 16 of 20 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m14:00:26.103676 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_preco_produto)
[0m14:00:26.103676 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m14:00:26.110692 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m14:00:26.111668 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 14:00:26.103676 => 14:00:26.110692
[0m14:00:26.111668 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m14:00:26.113719 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:26.929960 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m14:00:26.931962 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m14:00:26.967731 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m14:00:26.969643 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m14:00:27.586595 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c9430419-83fc-4c10-8c48-e2ddfd1ec982&page=queryresults
[0m14:00:27.607254 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cc828da1-3dda-4e56-99fb-0c5fd9377d99&page=queryresults
[0m14:00:30.102486 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 14:00:26.071647 => 14:00:30.101453
[0m14:00:30.103472 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001824871C820>]}
[0m14:00:30.104480 [info ] [Thread-1  ]: 15 of 20 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 4.04s]
[0m14:00:30.106468 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m14:00:30.108472 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m14:00:30.108472 [info ] [Thread-1  ]: 17 of 20 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m14:00:30.110443 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m14:00:30.111429 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m14:00:30.117486 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m14:00:30.119393 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 14:00:30.111429 => 14:00:30.118486
[0m14:00:30.119393 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m14:00:30.122472 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:30.703235 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 14:00:26.111668 => 14:00:30.702243
[0m14:00:30.704233 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001824871C5B0>]}
[0m14:00:30.706369 [info ] [Thread-2  ]: 16 of 20 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (309.0 rows, 81.0 KiB processed)[0m in 4.60s]
[0m14:00:30.708359 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m14:00:30.794109 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m14:00:30.796164 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m14:00:31.173331 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d86031c1-4bd9-4844-b6f0-8c869abf0869&page=queryresults
[0m14:00:33.396417 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 14:00:30.119393 => 14:00:33.395464
[0m14:00:33.397379 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001824871C820>]}
[0m14:00:33.399463 [info ] [Thread-1  ]: 17 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 413.1 KiB processed)[0m in 3.29s]
[0m14:00:33.402012 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m14:00:33.403961 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m14:00:33.404961 [info ] [Thread-2  ]: 18 of 20 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m14:00:33.405920 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m14:00:33.407004 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m14:00:33.412554 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m14:00:33.413549 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 14:00:33.407004 => 14:00:33.413549
[0m14:00:33.414466 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m14:00:33.416511 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:34.133509 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m14:00:34.135508 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m14:00:34.534494 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f8450ae5-b206-4e2f-a2ca-c8d9af264a30&page=queryresults
[0m14:00:36.735996 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 14:00:33.414466 => 14:00:36.734998
[0m14:00:36.736999 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182497AC460>]}
[0m14:00:36.737997 [info ] [Thread-2  ]: 18 of 20 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (319.0 rows, 266.7 KiB processed)[0m in 3.33s]
[0m14:00:36.739901 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m14:00:36.741953 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m14:00:36.742955 [info ] [Thread-1  ]: 19 of 20 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m14:00:36.743960 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m14:00:36.745900 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m14:00:36.753897 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m14:00:36.755899 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 14:00:36.745900 => 14:00:36.754898
[0m14:00:36.755899 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m14:00:36.760899 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:37.462495 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m14:00:37.465494 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)    as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)      as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)      as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0) as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)   as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)   as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)   as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)     as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)     as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)   as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)     as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)     as vl_total_seis_meses
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_seis_meses) over () as qt_total_geral
         ,sum(qt_pecas_seis_meses) over (order by qt_pecas_seis_meses desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_seis_meses / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m14:00:37.842348 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4e2d24a4-3377-4f2e-8b2f-a5a9de9b6f5b&page=queryresults
[0m14:00:40.673551 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 14:00:36.756898 => 14:00:40.672467
[0m14:00:40.674549 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018248797790>]}
[0m14:00:40.676544 [info ] [Thread-1  ]: 19 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (198.0 rows, 121.1 KiB processed)[0m in 3.93s]
[0m14:00:40.678550 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m14:00:40.680459 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m14:00:40.681427 [info ] [Thread-2  ]: 20 of 20 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m14:00:40.684563 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_estoque_produto_base)
[0m14:00:40.685555 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m14:00:40.692551 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m14:00:40.694563 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 14:00:40.685555 => 14:00:40.694563
[0m14:00:40.695466 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m14:00:40.699543 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:41.357647 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m14:00:41.359643 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_venda_produto  as a
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m14:00:41.771761 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:560aefd7-7c94-4d64-b1ea-fa1cc7f68b6e&page=queryresults
[0m14:00:44.245973 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 14:00:40.695466 => 14:00:44.244978
[0m14:00:44.246969 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7a4f4625-e549-4e0f-8c1a-4e5ab6b6006b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018248797850>]}
[0m14:00:44.247973 [info ] [Thread-2  ]: 20 of 20 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (198.0 rows, 124.0 KiB processed)[0m in 3.56s]
[0m14:00:44.250392 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m14:00:44.253617 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:00:44.254622 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:00:44.254622 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:00:44.255613 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m14:00:44.255613 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m14:00:44.256612 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m14:00:44.256612 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m14:00:44.257614 [info ] [MainThread]: 
[0m14:00:44.258564 [info ] [MainThread]: Finished running 10 view models, 10 table models in 0 hours 0 minutes and 39.38 seconds (39.38s).
[0m14:00:44.264624 [debug] [MainThread]: Command end result
[0m14:00:44.278584 [info ] [MainThread]: 
[0m14:00:44.279579 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:00:44.279579 [info ] [MainThread]: 
[0m14:00:44.280522 [info ] [MainThread]: Done. PASS=20 WARN=0 ERROR=0 SKIP=0 TOTAL=20
[0m14:00:44.281582 [debug] [MainThread]: Command `dbt run` succeeded at 14:00:44.281582 after 40.16 seconds
[0m14:00:44.281582 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018243BC3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182471815B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000182471ACC40>]}
[0m14:00:44.281582 [debug] [MainThread]: Flushing usage events
[0m14:00:47.716193 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D20F33D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D10639D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D1063B80>]}


============================== 14:00:47.720449 | eb10401f-e1e7-43b2-bc15-034b1709bd17 ==============================
[0m14:00:47.720449 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:00:47.721491 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:00:48.240703 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'eb10401f-e1e7-43b2-bc15-034b1709bd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D423AAF0>]}
[0m14:00:48.300486 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'eb10401f-e1e7-43b2-bc15-034b1709bd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D5760430>]}
[0m14:00:48.301516 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m14:00:48.307565 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m14:00:48.355534 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:00:48.355534 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:00:48.360476 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'eb10401f-e1e7-43b2-bc15-034b1709bd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D5A37310>]}
[0m14:00:48.370482 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'eb10401f-e1e7-43b2-bc15-034b1709bd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D5870370>]}
[0m14:00:48.370482 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m14:00:48.371521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'eb10401f-e1e7-43b2-bc15-034b1709bd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D106F9A0>]}
[0m14:00:48.372529 [info ] [MainThread]: 
[0m14:00:48.372529 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:00:48.374481 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:48.374481 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:49.085461 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m14:00:49.086458 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:49.087462 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m14:00:49.088569 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:49.771666 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m14:00:49.773664 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:49.817726 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m14:00:49.819721 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:50.506380 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'eb10401f-e1e7-43b2-bc15-034b1709bd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D57CB280>]}
[0m14:00:50.508399 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:00:50.510395 [info ] [MainThread]: 
[0m14:00:50.519393 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m14:00:50.520395 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m14:00:50.522395 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m14:00:50.523396 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m14:00:50.536390 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 14:00:50.524395 => 14:00:50.536390
[0m14:00:50.536390 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m14:00:50.576389 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m14:00:50.577390 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m14:00:51.570984 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:146157fb-1d91-4a59-b448-4117f6715ee7&page=queryresults
[0m14:00:52.719011 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m14:00:53.099360 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d7664977-cbf8-440c-b197-3f9a46d14deb&page=queryresults
[0m14:00:56.373516 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m14:00:57.151643 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m14:00:57.155643 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m14:00:57.603761 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dd56695c-d3fe-44e3-b254-a3da87bdd4a0&page=queryresults
[0m14:01:02.597857 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 14:00:50.537390 => 14:01:02.596841
[0m14:01:02.598858 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eb10401f-e1e7-43b2-bc15-034b1709bd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D5ADAEE0>]}
[0m14:01:02.601415 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 66.0 KiB processed)[0m in 12.08s]
[0m14:01:02.603424 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m14:01:02.608011 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:01:02.609008 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:01:02.610618 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m14:01:02.611687 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m14:01:02.612691 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m14:01:02.613691 [info ] [MainThread]: 
[0m14:01:02.614684 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 14.24 seconds (14.24s).
[0m14:01:02.616030 [debug] [MainThread]: Command end result
[0m14:01:02.628654 [info ] [MainThread]: 
[0m14:01:02.630655 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:01:02.631687 [info ] [MainThread]: 
[0m14:01:02.631687 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m14:01:02.633654 [debug] [MainThread]: Command `dbt snapshot` succeeded at 14:01:02.632658 after 14.98 seconds
[0m14:01:02.633654 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D20F33D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D5AC90A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3D56F3910>]}
[0m14:01:02.634654 [debug] [MainThread]: Flushing usage events
[0m14:01:06.177705 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E6DFAE34C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E6DEA5F310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E6DEA5F790>]}


============================== 14:01:06.181706 | 338d9d80-f2b0-4974-9572-7ef84d26a5f6 ==============================
[0m14:01:06.181706 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:01:06.182317 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:01:06.703667 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '338d9d80-f2b0-4974-9572-7ef84d26a5f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E6E1C2AB20>]}
[0m14:01:06.767112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '338d9d80-f2b0-4974-9572-7ef84d26a5f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E6E314C3A0>]}
[0m14:01:06.767901 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m14:01:06.774858 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m14:01:06.823358 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:01:06.823358 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:01:06.829105 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '338d9d80-f2b0-4974-9572-7ef84d26a5f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E6E342A280>]}
[0m14:01:06.838774 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '338d9d80-f2b0-4974-9572-7ef84d26a5f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E6E34173D0>]}
[0m14:01:06.838774 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m14:01:06.839767 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '338d9d80-f2b0-4974-9572-7ef84d26a5f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E6E30E7EE0>]}
[0m14:01:06.840718 [info ] [MainThread]: 
[0m14:01:06.841740 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:01:06.842728 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:01:06.842728 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:01:07.530255 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m14:01:07.531263 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:01:07.553282 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m14:01:07.553282 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:01:08.171846 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m14:01:08.178476 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:01:08.180478 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m14:01:08.181477 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:01:08.843675 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '338d9d80-f2b0-4974-9572-7ef84d26a5f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E6E31A8070>]}
[0m14:01:08.844670 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:01:08.845791 [info ] [MainThread]: 
[0m14:01:08.851490 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m14:01:08.852478 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m14:01:08.853476 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m14:01:08.854497 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m14:01:08.859579 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m14:01:08.860517 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 14:01:08.854497 => 14:01:08.860517
[0m14:01:08.860517 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m14:01:08.873584 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m14:01:09.721197 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m14:01:09.722194 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m14:01:10.196371 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c263278a-d68f-4ce3-8152-9a8b25f4f0ae&page=queryresults
[0m14:01:12.154469 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 14:01:08.860517 => 14:01:12.153464
[0m14:01:12.154469 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '338d9d80-f2b0-4974-9572-7ef84d26a5f6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E6E34CCFD0>]}
[0m14:01:12.155471 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (366.0 rows, 53.8 KiB processed)[0m in 3.30s]
[0m14:01:12.156980 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m14:01:12.158422 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:01:12.159477 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:01:12.159477 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m14:01:12.160424 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m14:01:12.161489 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m14:01:12.161489 [info ] [MainThread]: 
[0m14:01:12.162554 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.32 seconds (5.32s).
[0m14:01:12.163458 [debug] [MainThread]: Command end result
[0m14:01:12.177860 [info ] [MainThread]: 
[0m14:01:12.179862 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:01:12.180455 [info ] [MainThread]: 
[0m14:01:12.182470 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m14:01:12.184806 [debug] [MainThread]: Command `dbt run` succeeded at 14:01:12.184806 after 6.06 seconds
[0m14:01:12.185797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E6DFAE34C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E6E34347F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002E6DEA5F1F0>]}
[0m14:01:12.186810 [debug] [MainThread]: Flushing usage events
[0m15:00:04.353236 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354B313430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354A297640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354A297AC0>]}


============================== 15:00:04.353236 | 7bc8b543-fe4a-488d-8111-040af37ea452 ==============================
[0m15:00:04.353236 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:00:04.353236 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --exclude tag:snaps', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:00:04.922337 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354A2961C0>]}
[0m15:00:04.983999 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354E854D00>]}
[0m15:00:04.985931 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:00:04.991459 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:00:05.032143 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:00:05.032143 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:00:05.048270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354EC57670>]}
[0m15:00:05.048270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354EC4C0D0>]}
[0m15:00:05.048270 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:00:05.048270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354EA2F670>]}
[0m15:00:05.048270 [info ] [MainThread]: 
[0m15:00:05.048270 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:00:05.064165 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:05.064165 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:05.079872 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:05.079872 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:05.954756 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:06.692954 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m15:00:06.692954 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:06.696588 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m15:00:06.696588 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:07.396428 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m15:00:07.396428 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:07.428591 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m15:00:07.428591 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:08.126202 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354ECC5BE0>]}
[0m15:00:08.126202 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:00:08.126202 [info ] [MainThread]: 
[0m15:00:08.126202 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:08.126202 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m15:00:08.126202 [info ] [Thread-1  ]: 1 of 20 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m15:00:08.142334 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m15:00:08.142334 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:08.142334 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m15:00:08.126202 [info ] [Thread-2  ]: 2 of 20 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m15:00:08.142334 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m15:00:08.158375 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m15:00:08.160870 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m15:00:08.160870 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 15:00:08.142334 => 15:00:08.160870
[0m15:00:08.160870 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:08.190297 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m15:00:08.191422 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 15:00:08.158375 => 15:00:08.191422
[0m15:00:08.192309 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m15:00:08.194394 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m15:00:08.194394 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m15:00:08.195368 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:00:08.196358 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m15:00:08.216172 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m15:00:09.043094 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e50c76e5-211a-4a72-89ec-d3f672643318&page=queryresults
[0m15:00:09.132925 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:05ee36ad-1634-4f8e-a1b3-06270ecc3104&page=queryresults
[0m15:00:09.516781 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 15:00:08.192309 => 15:00:09.516781
[0m15:00:09.516781 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FCE2F40>]}
[0m15:00:09.516781 [info ] [Thread-2  ]: 2 of 20 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m15:00:09.516781 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m15:00:09.516781 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m15:00:09.516781 [info ] [Thread-2  ]: 3 of 20 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m15:00:09.516781 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m15:00:09.532697 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m15:00:09.532697 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m15:00:09.532697 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 15:00:09.532697 => 15:00:09.532697
[0m15:00:09.532697 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m15:00:09.532697 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m15:00:09.532697 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:09.532697 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m15:00:09.564328 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 15:00:08.160870 => 15:00:09.564328
[0m15:00:09.564328 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FCF0C70>]}
[0m15:00:09.564328 [info ] [Thread-1  ]: 1 of 20 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m15:00:09.580248 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:09.580248 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m15:00:09.580248 [info ] [Thread-1  ]: 4 of 20 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m15:00:09.580248 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m15:00:09.580248 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m15:00:09.580248 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m15:00:09.580248 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 15:00:09.580248 => 15:00:09.580248
[0m15:00:09.580248 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m15:00:09.580248 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m15:00:09.596240 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:09.596240 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m15:00:10.436868 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cf0ee080-f440-40d8-81d6-8adc0c001e56&page=queryresults
[0m15:00:10.576315 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4868105b-4d1e-4c13-bf33-03ed8a224367&page=queryresults
[0m15:00:10.860131 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 15:00:09.580248 => 15:00:10.860131
[0m15:00:10.860131 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FDD3880>]}
[0m15:00:10.860131 [info ] [Thread-1  ]: 4 of 20 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m15:00:10.875512 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m15:00:10.875512 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m15:00:10.877525 [info ] [Thread-1  ]: 5 of 20 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m15:00:10.877525 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m15:00:10.880041 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m15:00:10.890164 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m15:00:10.891178 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 15:00:10.880041 => 15:00:10.891178
[0m15:00:10.893193 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m15:00:10.897221 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m15:00:10.899230 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:10.901239 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m15:00:11.111033 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 15:00:09.532697 => 15:00:11.111033
[0m15:00:11.111033 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FD79FD0>]}
[0m15:00:11.111033 [info ] [Thread-2  ]: 3 of 20 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.59s]
[0m15:00:11.111033 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m15:00:11.111033 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m15:00:11.111033 [info ] [Thread-2  ]: 6 of 20 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m15:00:11.124832 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_item_pedido)
[0m15:00:11.124832 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m15:00:11.124832 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m15:00:11.124832 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 15:00:11.124832 => 15:00:11.124832
[0m15:00:11.124832 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m15:00:11.140771 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m15:00:11.141761 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:11.143898 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m15:00:11.763684 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:39bb9b64-fc6a-4edc-a99a-63c5c99e2546&page=queryresults
[0m15:00:11.907530 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:51406437-ee73-4649-ad01-f2080a8734b1&page=queryresults
[0m15:00:12.170206 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 15:00:10.893193 => 15:00:12.170206
[0m15:00:12.170206 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FCE2C40>]}
[0m15:00:12.170206 [info ] [Thread-1  ]: 5 of 20 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m15:00:12.185969 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m15:00:12.185969 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:12.185969 [info ] [Thread-1  ]: 7 of 20 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m15:00:12.185969 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m15:00:12.185969 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:12.185969 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m15:00:12.201883 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 15:00:12.185969 => 15:00:12.185969
[0m15:00:12.201883 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:12.201883 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m15:00:12.201883 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:12.201883 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m15:00:12.313633 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 15:00:11.124832 => 15:00:12.313633
[0m15:00:12.313633 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FD79F70>]}
[0m15:00:12.313633 [info ] [Thread-2  ]: 6 of 20 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m15:00:12.313633 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m15:00:12.313633 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m15:00:12.313633 [info ] [Thread-2  ]: 8 of 20 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m15:00:12.313633 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m15:00:12.329642 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m15:00:12.329642 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m15:00:12.329642 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 15:00:12.329642 => 15:00:12.329642
[0m15:00:12.329642 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m15:00:12.329642 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m15:00:12.329642 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:12.329642 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m15:00:12.905065 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:469582df-484f-4f58-940f-b0fb52e81f49&page=queryresults
[0m15:00:13.090740 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:aab72f7e-11ac-4022-a109-d08d98c66f11&page=queryresults
[0m15:00:13.308127 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 15:00:12.201883 => 15:00:13.308127
[0m15:00:13.310033 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FD35910>]}
[0m15:00:13.310983 [info ] [Thread-1  ]: 7 of 20 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m15:00:13.313254 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:13.313588 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m15:00:13.314658 [info ] [Thread-1  ]: 9 of 20 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m15:00:13.316707 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m15:00:13.317651 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m15:00:13.325166 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m15:00:13.327170 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 15:00:13.317651 => 15:00:13.326164
[0m15:00:13.328168 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m15:00:13.332988 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m15:00:13.336816 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:13.339069 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m15:00:13.514831 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 15:00:12.329642 => 15:00:13.514831
[0m15:00:13.514831 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FD2F130>]}
[0m15:00:13.514831 [info ] [Thread-2  ]: 8 of 20 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m15:00:13.519665 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m15:00:13.520806 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m15:00:13.521649 [info ] [Thread-2  ]: 10 of 20 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m15:00:13.521649 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_tempo)
[0m15:00:13.521649 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m15:00:13.521649 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m15:00:13.521649 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 15:00:13.521649 => 15:00:13.521649
[0m15:00:13.521649 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m15:00:13.531219 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m15:00:13.531219 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:13.531219 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m15:00:14.132004 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:911020c6-5413-4bd9-a532-911ed6c36ca1&page=queryresults
[0m15:00:14.232046 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9c55a8ac-d20f-4c6b-b5ee-18ac5778431a&page=queryresults
[0m15:00:14.522128 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 15:00:13.328168 => 15:00:14.521175
[0m15:00:14.523178 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FD3C340>]}
[0m15:00:14.525177 [info ] [Thread-1  ]: 9 of 20 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m15:00:14.526130 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m15:00:14.528134 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m15:00:14.529172 [info ] [Thread-1  ]: 11 of 20 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m15:00:14.531135 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m15:00:14.532182 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m15:00:14.537175 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m15:00:14.538177 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 15:00:14.532182 => 15:00:14.538177
[0m15:00:14.538177 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m15:00:14.545291 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:14.676576 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 15:00:13.521649 => 15:00:14.676576
[0m15:00:14.678586 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FD91790>]}
[0m15:00:14.679615 [info ] [Thread-2  ]: 10 of 20 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m15:00:14.681027 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m15:00:15.231822 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m15:00:15.231822 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m15:00:15.878096 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:69de1339-4723-4f8f-a94e-a5df1665eb65&page=queryresults
[0m15:00:19.350845 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 15:00:14.538177 => 15:00:19.350845
[0m15:00:19.350845 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FD0EEB0>]}
[0m15:00:19.356554 [info ] [Thread-1  ]: 11 of 20 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 4.82s]
[0m15:00:19.356554 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m15:00:19.356554 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m15:00:19.356554 [info ] [Thread-2  ]: 12 of 20 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m15:00:19.356554 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m15:00:19.356554 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m15:00:19.367060 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m15:00:19.367060 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 15:00:19.356554 => 15:00:19.367060
[0m15:00:19.367060 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m15:00:19.367060 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:20.026975 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m15:00:20.026975 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m15:00:20.821376 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d1a8c7d9-130e-4e3f-b220-6bf58e1796a4&page=queryresults
[0m15:00:23.063761 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 15:00:19.367060 => 15:00:23.062754
[0m15:00:23.064757 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FE43340>]}
[0m15:00:23.066753 [info ] [Thread-2  ]: 12 of 20 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 3.71s]
[0m15:00:23.067530 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m15:00:23.067530 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m15:00:23.067530 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m15:00:23.067530 [info ] [Thread-1  ]: 13 of 20 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m15:00:23.067530 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m15:00:23.067530 [info ] [Thread-2  ]: 14 of 20 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m15:00:23.067530 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m15:00:23.067530 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m15:00:23.082365 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m15:00:23.086732 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m15:00:23.095489 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 15:00:23.082365 => 15:00:23.094600
[0m15:00:23.102992 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m15:00:23.104998 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m15:00:23.107621 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:23.153953 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 15:00:23.067530 => 15:00:23.153953
[0m15:00:23.155155 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m15:00:23.157631 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:23.908279 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m15:00:23.923160 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m15:00:23.923160 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m15:00:23.933747 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m15:00:24.368218 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b3292d16-6155-4c82-b35a-f7ba2d40ce0d&page=queryresults
[0m15:00:24.607599 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e586c7ac-ea30-4768-b481-fd1f2386652e&page=queryresults
[0m15:00:26.559708 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 15:00:23.105424 => 15:00:26.559708
[0m15:00:26.559708 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FE8E2B0>]}
[0m15:00:26.559708 [info ] [Thread-2  ]: 14 of 20 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 82.5 KiB processed)[0m in 3.49s]
[0m15:00:26.575685 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m15:00:26.575685 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m15:00:26.575685 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 15:00:23.155155 => 15:00:26.575685
[0m15:00:26.575685 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FCF0640>]}
[0m15:00:26.575685 [info ] [Thread-2  ]: 15 of 20 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m15:00:26.575685 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_pedido)
[0m15:00:26.575685 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m15:00:26.575685 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m15:00:26.575685 [info ] [Thread-1  ]: 13 of 20 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 108.6 KiB processed)[0m in 3.51s]
[0m15:00:26.591633 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m15:00:26.591633 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m15:00:26.591633 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 15:00:26.575685 => 15:00:26.591633
[0m15:00:26.591633 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m15:00:26.591633 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:26.591633 [info ] [Thread-1  ]: 16 of 20 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m15:00:26.591633 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_preco_produto)
[0m15:00:26.591633 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m15:00:26.591633 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m15:00:26.637479 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 15:00:26.591633 => 15:00:26.637479
[0m15:00:26.637479 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m15:00:26.639949 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:27.271777 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m15:00:27.271777 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m15:00:27.281158 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m15:00:27.281158 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m15:00:27.889800 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bc85d3af-60f0-4e81-a1a1-efb371a475a4&page=queryresults
[0m15:00:27.901909 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b6f39c14-a85e-423b-9a52-e068c58fff79&page=queryresults
[0m15:00:30.409898 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 15:00:26.591633 => 15:00:30.408018
[0m15:00:30.409898 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354EA2F670>]}
[0m15:00:30.410911 [info ] [Thread-2  ]: 15 of 20 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 3.83s]
[0m15:00:30.411912 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m15:00:30.412911 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m15:00:30.412911 [info ] [Thread-2  ]: 17 of 20 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m15:00:30.413908 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m15:00:30.413908 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m15:00:30.416349 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m15:00:30.416349 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 15:00:30.413908 => 15:00:30.416349
[0m15:00:30.416349 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m15:00:30.420809 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:31.070028 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m15:00:31.070028 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m15:00:31.525383 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4eda4e08-2851-4cc7-b564-94c1b4541360&page=queryresults
[0m15:00:31.854420 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 15:00:26.637479 => 15:00:31.854420
[0m15:00:31.854420 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FE8A2B0>]}
[0m15:00:31.854420 [info ] [Thread-1  ]: 16 of 20 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (309.0 rows, 81.0 KiB processed)[0m in 5.26s]
[0m15:00:31.865110 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m15:00:33.832784 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 15:00:30.416349 => 15:00:33.832784
[0m15:00:33.832784 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FE49E80>]}
[0m15:00:33.839834 [info ] [Thread-2  ]: 17 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 413.1 KiB processed)[0m in 3.42s]
[0m15:00:33.841850 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m15:00:33.842723 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:00:33.842723 [info ] [Thread-1  ]: 18 of 20 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m15:00:33.842723 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m15:00:33.842723 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:00:33.849820 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m15:00:33.852733 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 15:00:33.842723 => 15:00:33.851873
[0m15:00:33.852733 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:00:33.852733 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:34.520771 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m15:00:34.522790 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m15:00:34.911708 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cfb459ef-dfcf-4616-8412-d8fafd06eead&page=queryresults
[0m15:00:37.407010 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 15:00:33.852733 => 15:00:37.407010
[0m15:00:37.408010 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FE70910>]}
[0m15:00:37.409008 [info ] [Thread-1  ]: 18 of 20 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (319.0 rows, 266.7 KiB processed)[0m in 3.57s]
[0m15:00:37.410009 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:00:37.410009 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m15:00:37.410009 [info ] [Thread-2  ]: 19 of 20 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m15:00:37.410009 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m15:00:37.410009 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m15:00:37.410009 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m15:00:37.410009 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 15:00:37.410009 => 15:00:37.410009
[0m15:00:37.410009 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m15:00:37.410009 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:38.098494 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m15:00:38.098494 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)    as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)      as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)      as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0) as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)   as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)   as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)   as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)     as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)     as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)   as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)     as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)     as vl_total_seis_meses
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_seis_meses) over () as qt_total_geral
         ,sum(qt_pecas_seis_meses) over (order by qt_pecas_seis_meses desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_seis_meses / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m15:00:38.489052 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bf73b582-ea3f-4d99-922c-7083545df2d3&page=queryresults
[0m15:00:41.590873 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 15:00:37.410009 => 15:00:41.589999
[0m15:00:41.592122 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FEB0160>]}
[0m15:00:41.593161 [info ] [Thread-2  ]: 19 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (198.0 rows, 121.1 KiB processed)[0m in 4.18s]
[0m15:00:41.595673 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m15:00:41.597696 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m15:00:41.598610 [info ] [Thread-1  ]: 20 of 20 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m15:00:41.600672 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_estoque_produto_base)
[0m15:00:41.601696 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m15:00:41.608031 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:00:41.609012 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 15:00:41.601696 => 15:00:41.609012
[0m15:00:41.609852 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m15:00:41.611329 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:42.446594 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:00:42.446594 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_venda_produto  as a
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m15:00:42.770553 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0f198316-1afe-4a85-9bff-82d8bcd71eb2&page=queryresults
[0m15:00:44.957837 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 15:00:41.609852 => 15:00:44.956945
[0m15:00:44.959837 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7bc8b543-fe4a-488d-8111-040af37ea452', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354FD332E0>]}
[0m15:00:44.960841 [info ] [Thread-1  ]: 20 of 20 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (198.0 rows, 124.0 KiB processed)[0m in 3.36s]
[0m15:00:44.960841 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m15:00:44.960841 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:00:44.960841 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:00:44.960841 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:00:44.960841 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m15:00:44.960841 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:00:44.960841 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m15:00:44.960841 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m15:00:44.960841 [info ] [MainThread]: 
[0m15:00:44.976701 [info ] [MainThread]: Finished running 10 view models, 10 table models in 0 hours 0 minutes and 39.91 seconds (39.91s).
[0m15:00:44.976701 [debug] [MainThread]: Command end result
[0m15:00:44.992445 [info ] [MainThread]: 
[0m15:00:44.992445 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:00:44.992445 [info ] [MainThread]: 
[0m15:00:44.999888 [info ] [MainThread]: Done. PASS=20 WARN=0 ERROR=0 SKIP=0 TOTAL=20
[0m15:00:45.000768 [debug] [MainThread]: Command `dbt run` succeeded at 15:00:45.000768 after 40.70 seconds
[0m15:00:45.000768 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354B313430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354E88F910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002354E91A100>]}
[0m15:00:45.000768 [debug] [MainThread]: Flushing usage events
[0m15:00:48.382164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000145018293D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000145007A39A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000145007A3D30>]}


============================== 15:00:48.382164 | 4825f39b-2b5b-4f96-89fe-99332b4aa4c7 ==============================
[0m15:00:48.382164 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:00:48.382164 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt snapshot', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:00:48.934036 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4825f39b-2b5b-4f96-89fe-99332b4aa4c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000145007A9970>]}
[0m15:00:49.000360 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4825f39b-2b5b-4f96-89fe-99332b4aa4c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014504E98490>]}
[0m15:00:49.001915 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:00:49.008357 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:00:49.061977 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:00:49.061977 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:00:49.066084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4825f39b-2b5b-4f96-89fe-99332b4aa4c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014505178370>]}
[0m15:00:49.069999 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4825f39b-2b5b-4f96-89fe-99332b4aa4c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014504E4D610>]}
[0m15:00:49.069999 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:00:49.069999 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4825f39b-2b5b-4f96-89fe-99332b4aa4c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001450516B0D0>]}
[0m15:00:49.069999 [info ] [MainThread]: 
[0m15:00:49.079281 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:00:49.080536 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:49.081560 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:49.771123 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:00:49.771123 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:49.808657 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m15:00:49.808657 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:50.430951 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:00:50.430951 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:50.430951 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m15:00:50.435107 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:51.131594 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4825f39b-2b5b-4f96-89fe-99332b4aa4c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014504F20F70>]}
[0m15:00:51.131594 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:00:51.131594 [info ] [MainThread]: 
[0m15:00:51.147074 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m15:00:51.147074 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m15:00:51.147074 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m15:00:51.147074 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m15:00:51.163220 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 15:00:51.147074 => 15:00:51.163220
[0m15:00:51.163220 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m15:00:51.194877 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:00:51.194877 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m15:00:52.055459 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:046cd0bf-13f1-492c-84d3-401431fdf4bc&page=queryresults
[0m15:00:53.382805 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m15:00:53.774239 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8fab7dc9-8649-4934-ae54-dcb6ae177716&page=queryresults
[0m15:00:56.158604 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m15:00:56.930057 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m15:00:56.934845 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m15:00:57.310909 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c7833e49-8b6a-4564-9b83-9f215e0d73af&page=queryresults
[0m15:00:59.610314 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 15:00:51.163220 => 15:00:59.610314
[0m15:00:59.610314 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4825f39b-2b5b-4f96-89fe-99332b4aa4c7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000145051F7520>]}
[0m15:00:59.610314 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 66.0 KiB processed)[0m in 8.46s]
[0m15:00:59.610314 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m15:00:59.624434 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:00:59.624434 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:00:59.624434 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:00:59.624434 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m15:00:59.624434 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m15:00:59.624434 [info ] [MainThread]: 
[0m15:00:59.624434 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.55 seconds (10.55s).
[0m15:00:59.624434 [debug] [MainThread]: Command end result
[0m15:00:59.656403 [info ] [MainThread]: 
[0m15:00:59.656403 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:00:59.656403 [info ] [MainThread]: 
[0m15:00:59.656403 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:00:59.656403 [debug] [MainThread]: Command `dbt snapshot` succeeded at 15:00:59.656403 after 11.34 seconds
[0m15:00:59.672582 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000145018293D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014505178B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014504F535B0>]}
[0m15:00:59.672582 [debug] [MainThread]: Flushing usage events
[0m15:01:03.044487 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A2C783460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A2B6FD6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A2B6FDE20>]}


============================== 15:01:03.047003 | def611a4-e8f4-46fc-b077-4a3c499fc545 ==============================
[0m15:01:03.047003 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:01:03.047003 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m15:01:03.556105 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'def611a4-e8f4-46fc-b077-4a3c499fc545', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A2B6F5940>]}
[0m15:01:03.628810 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'def611a4-e8f4-46fc-b077-4a3c499fc545', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A2FEB6130>]}
[0m15:01:03.630077 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:01:03.637253 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:01:03.701009 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:01:03.701009 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_estoque_produto_base.sql
[0m15:01:03.796325 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'def611a4-e8f4-46fc-b077-4a3c499fc545', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A302765B0>]}
[0m15:01:03.816408 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'def611a4-e8f4-46fc-b077-4a3c499fc545', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A300C7850>]}
[0m15:01:03.816408 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:01:03.816408 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'def611a4-e8f4-46fc-b077-4a3c499fc545', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A2FDABC70>]}
[0m15:01:03.820792 [info ] [MainThread]: 
[0m15:01:03.820792 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:01:03.822789 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:01:03.822789 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:01:04.509791 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:01:04.510919 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:01:04.510919 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:01:04.510919 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:01:05.152897 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m15:01:05.152897 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:01:05.199651 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:01:05.199651 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:01:05.836027 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'def611a4-e8f4-46fc-b077-4a3c499fc545', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A2FD254F0>]}
[0m15:01:05.836027 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:01:05.836027 [info ] [MainThread]: 
[0m15:01:05.851982 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m15:01:05.851982 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m15:01:05.851982 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m15:01:05.851982 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m15:01:05.867791 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m15:01:05.867791 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 15:01:05.851982 => 15:01:05.867791
[0m15:01:05.867791 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m15:01:05.887318 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:01:06.536769 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m15:01:06.537737 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m15:01:06.980350 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7e086a0b-94ae-45bc-be12-aeb88ddcf2bf&page=queryresults
[0m15:01:08.985856 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 15:01:05.867791 => 15:01:08.985856
[0m15:01:08.985856 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'def611a4-e8f4-46fc-b077-4a3c499fc545', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A312A9520>]}
[0m15:01:08.985856 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (366.0 rows, 53.8 KiB processed)[0m in 3.13s]
[0m15:01:08.985856 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m15:01:08.985856 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:01:08.985856 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:01:08.985856 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:01:08.985856 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m15:01:08.985856 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m15:01:09.001765 [info ] [MainThread]: 
[0m15:01:09.001765 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.18 seconds (5.18s).
[0m15:01:09.001765 [debug] [MainThread]: Command end result
[0m15:01:09.049929 [info ] [MainThread]: 
[0m15:01:09.049929 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:01:09.049929 [info ] [MainThread]: 
[0m15:01:09.049929 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:01:09.049929 [debug] [MainThread]: Command `dbt run` succeeded at 15:01:09.049929 after 6.07 seconds
[0m15:01:09.049929 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A2C783460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A2FE2D280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025A2FDABC70>]}
[0m15:01:09.049929 [debug] [MainThread]: Flushing usage events
[0m15:07:45.259610 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C71468E400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C7136126A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C713612DC0>]}


============================== 15:07:45.263127 | a18b65c1-6e2c-4a01-a9c2-343ec3b15249 ==============================
[0m15:07:45.263127 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:07:45.263127 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_estoque_produto_base', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:07:45.818520 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a18b65c1-6e2c-4a01-a9c2-343ec3b15249', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C713607940>]}
[0m15:07:45.911765 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a18b65c1-6e2c-4a01-a9c2-343ec3b15249', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C717D03AC0>]}
[0m15:07:45.913012 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:07:45.920020 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:07:46.008218 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:07:46.008218 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_estoque_produto_base.sql
[0m15:07:46.087226 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a18b65c1-6e2c-4a01-a9c2-343ec3b15249', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C718176E20>]}
[0m15:07:46.103012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a18b65c1-6e2c-4a01-a9c2-343ec3b15249', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C717FCC280>]}
[0m15:07:46.103012 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:07:46.103012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a18b65c1-6e2c-4a01-a9c2-343ec3b15249', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C717FCC220>]}
[0m15:07:46.103012 [info ] [MainThread]: 
[0m15:07:46.103012 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:07:46.103012 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:07:46.103012 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:07:46.950805 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m15:07:46.950805 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:07:46.961925 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:07:46.961925 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:07:47.640490 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:07:47.640490 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:07:47.640490 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m15:07:47.640490 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:07:48.383740 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a18b65c1-6e2c-4a01-a9c2-343ec3b15249', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C717D54640>]}
[0m15:07:48.383740 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:07:48.383740 [info ] [MainThread]: 
[0m15:07:48.383740 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m15:07:48.383740 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_estoque_produto_base ................. [RUN]
[0m15:07:48.399505 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_estoque_produto_base'
[0m15:07:48.399505 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m15:07:48.417822 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:07:48.421918 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 15:07:48.401129 => 15:07:48.419886
[0m15:07:48.423326 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m15:07:48.437698 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:07:49.154676 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:07:49.154676 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m15:07:50.030650 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:571c476c-866a-47b5-95d6-85997a97935d&page=queryresults
[0m15:07:54.850377 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 15:07:48.423326 => 15:07:54.850377
[0m15:07:54.852129 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a18b65c1-6e2c-4a01-a9c2-343ec3b15249', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C7191A5F10>]}
[0m15:07:54.852129 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_estoque_produto_base ............ [[32mCREATE TABLE (198.0 rows, 2.2 MiB processed)[0m in 6.47s]
[0m15:07:54.852129 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m15:07:54.852129 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:07:54.852129 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:07:54.852129 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:07:54.852129 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:07:54.852129 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m15:07:54.852129 [info ] [MainThread]: 
[0m15:07:54.852129 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 8.75 seconds (8.75s).
[0m15:07:54.852129 [debug] [MainThread]: Command end result
[0m15:07:54.880116 [info ] [MainThread]: 
[0m15:07:54.880116 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:07:54.880116 [info ] [MainThread]: 
[0m15:07:54.889708 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:07:54.891278 [debug] [MainThread]: Command `dbt run` succeeded at 15:07:54.891278 after 9.73 seconds
[0m15:07:54.891278 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C71468E400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C717DC4CD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C717FE5CA0>]}
[0m15:07:54.891278 [debug] [MainThread]: Flushing usage events
[0m15:12:20.340242 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213AF20A430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213AE1929A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213AE192D30>]}


============================== 15:12:20.340242 | cf0a7e39-f6ba-4563-b5ca-195403a765e0 ==============================
[0m15:12:20.340242 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:12:20.355632 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --models tb_estoque_produto_base', 'send_anonymous_usage_stats': 'True'}
[0m15:12:20.885326 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cf0a7e39-f6ba-4563-b5ca-195403a765e0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213B27DF8B0>]}
[0m15:12:20.945420 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cf0a7e39-f6ba-4563-b5ca-195403a765e0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213B2777A30>]}
[0m15:12:20.946606 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:12:20.952798 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:12:21.032579 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:12:21.032579 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_estoque_produto_base.sql
[0m15:12:21.130464 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cf0a7e39-f6ba-4563-b5ca-195403a765e0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213B2CF6EE0>]}
[0m15:12:21.140505 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cf0a7e39-f6ba-4563-b5ca-195403a765e0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213B2B4C490>]}
[0m15:12:21.140505 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:12:21.140505 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cf0a7e39-f6ba-4563-b5ca-195403a765e0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213B2B4C3A0>]}
[0m15:12:21.140505 [info ] [MainThread]: 
[0m15:12:21.150233 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:12:21.150233 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:12:21.150233 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:12:21.885114 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m15:12:21.886498 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:12:21.886498 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:12:21.890933 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:12:22.661307 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:12:22.661307 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:12:22.661307 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m15:12:22.677536 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:12:23.494776 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cf0a7e39-f6ba-4563-b5ca-195403a765e0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213B2B490D0>]}
[0m15:12:23.495794 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:12:23.497771 [info ] [MainThread]: 
[0m15:12:23.505656 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m15:12:23.506598 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_estoque_produto_base ................. [RUN]
[0m15:12:23.508595 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_estoque_produto_base'
[0m15:12:23.508595 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m15:12:23.522075 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:12:23.523075 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 15:12:23.509844 => 15:12:23.523075
[0m15:12:23.523075 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m15:12:23.531528 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:12:24.180849 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:12:24.180849 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m15:12:24.800875 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d3753067-677d-49e8-ab3d-d4e39708ec44&page=queryresults
[0m15:12:28.000413 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 15:12:23.524085 => 15:12:28.000413
[0m15:12:28.000413 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cf0a7e39-f6ba-4563-b5ca-195403a765e0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213B3D25EB0>]}
[0m15:12:28.000413 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_estoque_produto_base ............ [[32mCREATE TABLE (198.0 rows, 2.2 MiB processed)[0m in 4.49s]
[0m15:12:28.000413 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m15:12:28.000413 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:12:28.000413 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:12:28.000413 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m15:12:28.000413 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:12:28.000413 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m15:12:28.000413 [info ] [MainThread]: 
[0m15:12:28.000413 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.85 seconds (6.85s).
[0m15:12:28.000413 [debug] [MainThread]: Command end result
[0m15:12:28.027155 [info ] [MainThread]: 
[0m15:12:28.028169 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:12:28.028169 [info ] [MainThread]: 
[0m15:12:28.029170 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:12:28.030069 [debug] [MainThread]: Command `dbt run` succeeded at 15:12:28.030069 after 7.74 seconds
[0m15:12:28.030069 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213AF20A430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213ACE986D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213B2B65DF0>]}
[0m15:12:28.030069 [debug] [MainThread]: Flushing usage events
[0m15:19:28.311191 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F940214C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F92FCA3A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F92FCA820>]}


============================== 15:19:28.311191 | 30d4db3d-5c46-4b1d-9f29-d6134fd647fc ==============================
[0m15:19:28.311191 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:19:28.311191 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_venda_produto_base+', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:19:28.735356 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '30d4db3d-5c46-4b1d-9f29-d6134fd647fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F92FACAC0>]}
[0m15:19:28.792725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '30d4db3d-5c46-4b1d-9f29-d6134fd647fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F92FCA1C0>]}
[0m15:19:28.794731 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:19:28.796506 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:19:28.923580 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m15:19:28.923580 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_agg_venda_produto_final.sql
[0m15:19:28.925585 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_estoque_produto_base.sql
[0m15:19:29.026246 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '30d4db3d-5c46-4b1d-9f29-d6134fd647fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F97AE8DF0>]}
[0m15:19:29.042158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '30d4db3d-5c46-4b1d-9f29-d6134fd647fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F97644EE0>]}
[0m15:19:29.042158 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:19:29.057878 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '30d4db3d-5c46-4b1d-9f29-d6134fd647fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F97644E80>]}
[0m15:19:29.057878 [info ] [MainThread]: 
[0m15:19:29.057878 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:19:29.057878 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:19:29.057878 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:19:29.930796 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m15:19:29.931796 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:19:29.932793 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:19:29.932793 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:19:30.602298 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:19:30.602298 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:19:30.611623 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m15:19:30.611623 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:19:31.407335 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '30d4db3d-5c46-4b1d-9f29-d6134fd647fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F97726700>]}
[0m15:19:31.409761 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:19:31.410108 [info ] [MainThread]: 
[0m15:19:31.418344 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m15:19:31.418344 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_venda_produto_base ................... [RUN]
[0m15:19:31.419888 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_venda_produto_base'
[0m15:19:31.420917 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m15:19:31.436871 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m15:19:31.438121 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 15:19:31.420917 => 15:19:31.438121
[0m15:19:31.438121 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m15:19:31.450108 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:19:32.341194 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m15:19:32.350314 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)    as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)      as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)      as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0) as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)   as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)   as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)   as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)     as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)     as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)   as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)     as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)     as vl_total_seis_meses
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_seis_meses) over () as qt_total_geral
         ,sum(qt_pecas_seis_meses) over (order by qt_pecas_seis_meses desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_seis_meses / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m15:19:32.841948 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dc722e1f-292c-44e1-a8e2-6c34ab60075a&page=queryresults
[0m15:19:36.324645 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 15:19:31.439595 => 15:19:36.324645
[0m15:19:36.324645 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30d4db3d-5c46-4b1d-9f29-d6134fd647fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F98BAFFA0>]}
[0m15:19:36.324645 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_venda_produto_base .............. [[32mCREATE TABLE (198.0 rows, 121.1 KiB processed)[0m in 4.90s]
[0m15:19:36.324645 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m15:19:36.324645 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m15:19:36.324645 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_estoque_produto_base ................. [RUN]
[0m15:19:36.324645 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_estoque_produto_base'
[0m15:19:36.324645 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m15:19:36.341883 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:19:36.344051 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 15:19:36.324645 => 15:19:36.343624
[0m15:19:36.345165 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m15:19:36.351317 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m15:19:37.135732 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:19:37.135732 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m15:19:37.811025 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b290106d-22b5-4db4-aa26-3b3dd03265f0&page=queryresults
[0m15:19:38.199113 [debug] [Thread-2  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Name qt_pecas_sessenta_dias not found inside a at [56:13]')
[0m15:19:39.699389 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3faf425a-c7a5-4fe5-907a-91f8f38b0adf&page=queryresults
[0m15:19:40.073377 [error] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3faf425a-c7a5-4fe5-907a-91f8f38b0adf&page=queryresults
[0m15:19:40.073377 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 15:19:36.345165 => 15:19:40.073377
[0m15:19:40.086225 [debug] [Thread-2  ]: Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Name qt_pecas_sessenta_dias not found inside a at [56:13]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m15:19:40.088044 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '30d4db3d-5c46-4b1d-9f29-d6134fd647fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F97AE44F0>]}
[0m15:19:40.089777 [error] [Thread-2  ]: 2 of 2 ERROR creating sql table model dbt_dw_az.tb_estoque_produto_base ........ [[31mERROR[0m in 3.76s]
[0m15:19:40.092031 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m15:19:40.096612 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:19:40.096612 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:19:40.098807 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:19:40.098807 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:19:40.099826 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m15:19:40.100825 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m15:19:40.101834 [info ] [MainThread]: 
[0m15:19:40.102842 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 11.04 seconds (11.04s).
[0m15:19:40.104824 [debug] [MainThread]: Command end result
[0m15:19:40.122678 [info ] [MainThread]: 
[0m15:19:40.123677 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:19:40.123677 [info ] [MainThread]: 
[0m15:19:40.123677 [error] [MainThread]:   Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Name qt_pecas_sessenta_dias not found inside a at [56:13]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m15:19:40.124694 [info ] [MainThread]: 
[0m15:19:40.125680 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 TOTAL=2
[0m15:19:40.126680 [debug] [MainThread]: Command `dbt run` failed at 15:19:40.126680 after 11.86 seconds
[0m15:19:40.126680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F940214C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F92FCA1C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022F97644EE0>]}
[0m15:19:40.126680 [debug] [MainThread]: Flushing usage events
[0m15:23:28.923153 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F01E2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154EF1869D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154EF186B80>]}


============================== 15:23:28.929790 | d6f7deaa-8523-4762-8653-80a4138f16ee ==============================
[0m15:23:28.929790 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:23:28.930102 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models +tb_estoque_produto_base', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:23:29.317817 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F3220220>]}
[0m15:23:29.389614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F3870580>]}
[0m15:23:29.389614 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:23:29.389614 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:23:29.482093 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:23:29.482093 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_venda_produto_base.sql
[0m15:23:29.578607 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F3CE8B20>]}
[0m15:23:29.578607 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F380FE20>]}
[0m15:23:29.578607 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:23:29.578607 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F3C036A0>]}
[0m15:23:29.578607 [info ] [MainThread]: 
[0m15:23:29.594435 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:23:29.594435 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:23:29.594435 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:23:29.594435 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:23:29.594435 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:23:30.444452 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:23:31.229306 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m15:23:31.233808 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:23:31.233808 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:23:31.233808 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:23:31.984760 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m15:23:31.989792 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:23:31.993037 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m15:23:32.027452 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:23:32.929357 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F38EEA30>]}
[0m15:23:32.931274 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:23:32.932294 [info ] [MainThread]: 
[0m15:23:32.942220 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m15:23:32.945226 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m15:23:32.943231 [info ] [Thread-1  ]: 1 of 16 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m15:23:32.947221 [info ] [Thread-2  ]: 2 of 16 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m15:23:32.949221 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m15:23:32.951945 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m15:23:32.953018 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m15:23:32.954008 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m15:23:32.976215 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m15:23:32.981925 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m15:23:32.981925 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 15:23:32.967566 => 15:23:32.981925
[0m15:23:32.981925 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 15:23:32.955005 => 15:23:32.981925
[0m15:23:32.981925 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m15:23:32.981925 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m15:23:33.010204 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m15:23:33.016350 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m15:23:33.018859 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:23:33.019862 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m15:23:33.020860 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m15:23:33.040305 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m15:23:34.020174 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a0c1227e-6a3b-4f2c-97ae-eb7ca04f7e6a&page=queryresults
[0m15:23:34.030024 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fc88baa1-ba1c-44d4-bc34-de461cfce997&page=queryresults
[0m15:23:34.458236 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 15:23:33.005725 => 15:23:34.458236
[0m15:23:34.459296 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F4D8C9D0>]}
[0m15:23:34.459296 [info ] [Thread-1  ]: 1 of 16 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.51s]
[0m15:23:34.460206 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m15:23:34.461237 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m15:23:34.463293 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 15:23:32.981925 => 15:23:34.463293
[0m15:23:34.464232 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F4DCD040>]}
[0m15:23:34.461237 [info ] [Thread-1  ]: 3 of 16 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m15:23:34.465231 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m15:23:34.465231 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m15:23:34.468294 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m15:23:34.464232 [info ] [Thread-2  ]: 2 of 16 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.51s]
[0m15:23:34.468294 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m15:23:34.469258 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m15:23:34.469258 [info ] [Thread-2  ]: 4 of 16 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m15:23:34.470203 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_imagem_produto)
[0m15:23:34.471686 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 15:23:34.465231 => 15:23:34.471686
[0m15:23:34.471686 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m15:23:34.472693 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m15:23:34.475720 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m15:23:34.478710 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m15:23:34.479695 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:23:34.480695 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 15:23:34.472693 => 15:23:34.480695
[0m15:23:34.481696 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m15:23:34.483692 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m15:23:34.486582 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m15:23:34.507793 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:23:34.509801 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m15:23:35.187894 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f2a5d9b2-d19b-415a-81e3-6136b31eaf0c&page=queryresults
[0m15:23:35.253190 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dd3d3822-0e88-40dd-a5dc-8220726dd86d&page=queryresults
[0m15:23:35.577757 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 15:23:34.476710 => 15:23:35.577757
[0m15:23:35.578773 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F4D4BAF0>]}
[0m15:23:35.579757 [info ] [Thread-1  ]: 3 of 16 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.11s]
[0m15:23:35.580758 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m15:23:35.580758 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m15:23:35.580758 [info ] [Thread-1  ]: 5 of 16 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m15:23:35.581799 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_item_pedido)
[0m15:23:35.582862 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m15:23:35.591758 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m15:23:35.594043 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 15:23:35.582862 => 15:23:35.594043
[0m15:23:35.595068 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m15:23:35.597055 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m15:23:35.599051 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:23:35.601056 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m15:23:35.703123 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 15:23:34.484577 => 15:23:35.703123
[0m15:23:35.706119 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F4E14FA0>]}
[0m15:23:35.707118 [info ] [Thread-2  ]: 4 of 16 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m15:23:35.708110 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m15:23:35.708110 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m15:23:35.709111 [info ] [Thread-2  ]: 6 of 16 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m15:23:35.710116 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_pedido)
[0m15:23:35.710116 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m15:23:35.713113 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m15:23:35.715113 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 15:23:35.710116 => 15:23:35.714144
[0m15:23:35.715113 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m15:23:35.718112 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m15:23:35.720127 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:23:35.722121 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m15:23:36.282460 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:199069c1-fe45-47c4-b8ca-41371af5e012&page=queryresults
[0m15:23:36.665406 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 15:23:35.595068 => 15:23:36.664407
[0m15:23:36.666404 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F4E52C70>]}
[0m15:23:36.667402 [info ] [Thread-1  ]: 5 of 16 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.08s]
[0m15:23:36.669401 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m15:23:36.669401 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:57ce3c16-53e8-4402-a291-9e3d8a82ca83&page=queryresults
[0m15:23:36.670631 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m15:23:36.671625 [info ] [Thread-1  ]: 7 of 16 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m15:23:36.672622 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_produto)
[0m15:23:36.673626 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m15:23:36.675627 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m15:23:36.677623 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 15:23:36.673626 => 15:23:36.677623
[0m15:23:36.678628 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m15:23:36.680778 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m15:23:36.681777 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:23:36.683779 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m15:23:37.083586 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 15:23:35.716114 => 15:23:37.083586
[0m15:23:37.084585 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F4D8C0A0>]}
[0m15:23:37.085679 [info ] [Thread-2  ]: 6 of 16 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.38s]
[0m15:23:37.086583 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m15:23:37.087587 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m15:23:37.087587 [info ] [Thread-2  ]: 8 of 16 START sql view model dbt_dw_stg.stg_tempo .............................. [RUN]
[0m15:23:37.089586 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_tempo)
[0m15:23:37.089586 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m15:23:37.092709 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m15:23:37.093709 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 15:23:37.089586 => 15:23:37.093709
[0m15:23:37.094708 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m15:23:37.101079 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m15:23:37.102862 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:23:37.104985 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m15:23:37.383411 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e9622c5a-a145-431e-be64-9f89e6402bd2&page=queryresults
[0m15:23:37.782780 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 15:23:36.678628 => 15:23:37.782780
[0m15:23:37.783779 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F4E76250>]}
[0m15:23:37.783779 [info ] [Thread-1  ]: 7 of 16 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.11s]
[0m15:23:37.784779 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m15:23:37.785637 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m15:23:37.785637 [info ] [Thread-1  ]: 9 of 16 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m15:23:37.786705 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m15:23:37.786705 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m15:23:37.790056 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m15:23:37.792117 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 15:23:37.787644 => 15:23:37.791090
[0m15:23:37.792117 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m15:23:37.800600 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:23:37.801587 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3fc1dc5c-8c26-4441-bd17-c821b2787a26&page=queryresults
[0m15:23:38.204527 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 15:23:37.094708 => 15:23:38.204527
[0m15:23:38.206540 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F4D2E2E0>]}
[0m15:23:38.207538 [info ] [Thread-2  ]: 8 of 16 OK created sql view model dbt_dw_stg.stg_tempo ......................... [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m15:23:38.209429 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m15:23:38.496033 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m15:23:38.497972 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m15:23:39.095187 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d7781643-0bb3-4bb2-998a-4703d0432059&page=queryresults
[0m15:23:41.941420 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 15:23:37.792117 => 15:23:41.941420
[0m15:23:41.944538 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F4DF6B20>]}
[0m15:23:41.945542 [info ] [Thread-1  ]: 9 of 16 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 4.16s]
[0m15:23:41.948534 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m15:23:41.949425 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m15:23:41.952066 [info ] [Thread-2  ]: 10 of 16 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m15:23:41.956157 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m15:23:41.957060 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m15:23:41.972923 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m15:23:41.978026 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 15:23:41.958157 => 15:23:41.976965
[0m15:23:41.979915 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m15:23:41.988565 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:23:42.680440 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m15:23:42.682655 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m15:23:43.329490 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:823e81d5-2b61-4455-a556-bb77dfe82d1b&page=queryresults
[0m15:23:45.979781 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 15:23:41.980920 => 15:23:45.977461
[0m15:23:45.981877 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F4E14F10>]}
[0m15:23:45.983899 [info ] [Thread-2  ]: 10 of 16 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 4.03s]
[0m15:23:45.985920 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m15:23:45.989801 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m15:23:45.989801 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m15:23:45.993278 [info ] [Thread-1  ]: 11 of 16 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m15:23:45.993278 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m15:23:45.993278 [info ] [Thread-2  ]: 12 of 16 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m15:23:45.993278 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m15:23:45.999948 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_pedido)
[0m15:23:45.999948 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m15:23:46.011312 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m15:23:46.033015 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m15:23:46.033015 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 15:23:46.006444 => 15:23:46.033015
[0m15:23:46.036210 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m15:23:46.044112 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:23:46.046128 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 15:23:45.999948 => 15:23:46.046128
[0m15:23:46.089827 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m15:23:46.096042 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:23:46.779774 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m15:23:46.785547 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m15:23:46.809826 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m15:23:46.809826 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m15:23:47.409995 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:548b503c-e612-4b95-b604-499d7a993e43&page=queryresults
[0m15:23:47.431662 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dfc6716f-b862-49ef-902a-f7014b775f8f&page=queryresults
[0m15:23:50.019945 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 15:23:46.089827 => 15:23:50.016767
[0m15:23:50.022897 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F4E14910>]}
[0m15:23:50.024922 [info ] [Thread-1  ]: 11 of 16 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 108.6 KiB processed)[0m in 4.03s]
[0m15:23:50.028895 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m15:23:50.300482 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 15:23:46.036210 => 15:23:50.300482
[0m15:23:50.309750 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F4EB6220>]}
[0m15:23:50.309750 [info ] [Thread-2  ]: 12 of 16 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 4.32s]
[0m15:23:50.313703 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m15:23:50.313703 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m15:23:50.313703 [info ] [Thread-1  ]: 13 of 16 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m15:23:50.313703 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_venda_produto_final)
[0m15:23:50.319709 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m15:23:50.324944 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m15:23:50.329965 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 15:23:50.319709 => 15:23:50.324944
[0m15:23:50.329965 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m15:23:50.329965 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:23:51.009716 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m15:23:51.013827 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m15:23:51.424210 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:07425ba9-e0cc-43df-b59c-e412ddbdf801&page=queryresults
[0m15:23:53.658568 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 15:23:50.329965 => 15:23:53.657563
[0m15:23:53.661426 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F4D45190>]}
[0m15:23:53.662510 [info ] [Thread-1  ]: 13 of 16 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 413.1 KiB processed)[0m in 3.35s]
[0m15:23:53.665059 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m15:23:53.666417 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:23:53.668437 [info ] [Thread-2  ]: 14 of 16 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m15:23:53.669755 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m15:23:53.671838 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:23:53.678733 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m15:23:53.681722 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 15:23:53.671838 => 15:23:53.680575
[0m15:23:53.684022 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:23:53.727141 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:23:54.380644 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m15:23:54.380644 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_data >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and dt_data <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m15:23:54.753616 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:24567465-d571-4a15-bc69-b02e9170ee5f&page=queryresults
[0m15:23:55.100315 [debug] [Thread-2  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: dt_data at [106:10]')
[0m15:23:55.643980 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:de09faf7-939e-40ae-9497-9cf32c462f15&page=queryresults
[0m15:23:56.003430 [error] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:de09faf7-939e-40ae-9497-9cf32c462f15&page=queryresults
[0m15:23:56.003430 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 15:23:53.685527 => 15:23:56.003430
[0m15:23:56.003430 [debug] [Thread-2  ]: Database Error in model tb_agg_venda_produto_final (models\3.az\tb_agg_venda_produto_final.sql)
  Unrecognized name: dt_data at [106:10]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_agg_venda_produto_final.sql
[0m15:23:56.003430 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd6f7deaa-8523-4762-8653-80a4138f16ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F4E87580>]}
[0m15:23:56.003430 [error] [Thread-2  ]: 14 of 16 ERROR creating sql table model dbt_dw_az.tb_agg_venda_produto_final ... [[31mERROR[0m in 2.33s]
[0m15:23:56.003430 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:23:56.003430 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m15:23:56.019500 [info ] [Thread-1  ]: 15 of 16 SKIP relation dbt_dw_az.tb_venda_produto_base ......................... [[33mSKIP[0m]
[0m15:23:56.021186 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m15:23:56.023057 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m15:23:56.024883 [info ] [Thread-2  ]: 16 of 16 SKIP relation dbt_dw_az.tb_estoque_produto_base ....................... [[33mSKIP[0m]
[0m15:23:56.026069 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m15:23:56.031578 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:23:56.031578 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:23:56.032579 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:23:56.032579 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m15:23:56.033572 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m15:23:56.033572 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_final' was properly closed.
[0m15:23:56.033572 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_agg_venda_produto_final' was properly closed.
[0m15:23:56.035025 [info ] [MainThread]: 
[0m15:23:56.037079 [info ] [MainThread]: Finished running 8 view models, 8 table models in 0 hours 0 minutes and 26.46 seconds (26.46s).
[0m15:23:56.042116 [debug] [MainThread]: Command end result
[0m15:23:56.057887 [info ] [MainThread]: 
[0m15:23:56.058886 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:23:56.059502 [info ] [MainThread]: 
[0m15:23:56.060522 [error] [MainThread]:   Database Error in model tb_agg_venda_produto_final (models\3.az\tb_agg_venda_produto_final.sql)
  Unrecognized name: dt_data at [106:10]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_agg_venda_produto_final.sql
[0m15:23:56.061522 [info ] [MainThread]: 
[0m15:23:56.062510 [info ] [MainThread]: Done. PASS=13 WARN=0 ERROR=1 SKIP=2 TOTAL=16
[0m15:23:56.063124 [debug] [MainThread]: Command `dbt run` failed at 15:23:56.063124 after 27.19 seconds
[0m15:23:56.063124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F01E2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F3B559A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000154F3CE8A90>]}
[0m15:23:56.063124 [debug] [MainThread]: Flushing usage events
[0m15:24:48.777884 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C6E516460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C6D4929A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C6D492D30>]}


============================== 15:24:48.777884 | 1878f8ef-cbe0-4752-905a-350dce7a6879 ==============================
[0m15:24:48.777884 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:24:48.777884 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_agg_venda_produto_final+', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:24:49.183178 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1878f8ef-cbe0-4752-905a-350dce7a6879', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C6D492D90>]}
[0m15:24:49.246643 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1878f8ef-cbe0-4752-905a-350dce7a6879', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C71AACD30>]}
[0m15:24:49.246643 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:24:49.246643 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:24:49.344051 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:24:49.344051 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_agg_venda_produto_final.sql
[0m15:24:49.442982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1878f8ef-cbe0-4752-905a-350dce7a6879', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C71FF8B80>]}
[0m15:24:49.459149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1878f8ef-cbe0-4752-905a-350dce7a6879', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C71F15E20>]}
[0m15:24:49.459149 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:24:49.459149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1878f8ef-cbe0-4752-905a-350dce7a6879', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C71E3ABE0>]}
[0m15:24:49.459149 [info ] [MainThread]: 
[0m15:24:49.459149 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:24:49.459149 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:24:49.459149 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:24:50.269667 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m15:24:50.269667 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:24:50.269667 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:24:50.281017 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:24:50.951917 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m15:24:50.951917 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:24:50.973522 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:24:50.980702 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:24:51.619077 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1878f8ef-cbe0-4752-905a-350dce7a6879', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C71B09C10>]}
[0m15:24:51.619077 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:24:51.622137 [info ] [MainThread]: 
[0m15:24:51.627537 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:24:51.627537 [info ] [Thread-1  ]: 1 of 3 START sql table model dbt_dw_az.tb_agg_venda_produto_final .............. [RUN]
[0m15:24:51.627537 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_agg_venda_produto_final'
[0m15:24:51.627537 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:24:51.650586 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m15:24:51.653106 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 15:24:51.627537 => 15:24:51.653106
[0m15:24:51.654124 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:24:51.661692 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:24:52.324536 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m15:24:52.324536 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_pedido >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and dt_pedido <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m15:24:52.807312 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a2793f17-0488-453b-855d-d236fc6e7ec1&page=queryresults
[0m15:24:53.187446 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('No matching signature for operator >= for argument types: STRING, DATE\n  Signature: T1 >= T1\n    Unable to find common supertype for templated argument <T1>\n      Input types for <T1>: {STRING, DATE} at [106:10]')
[0m15:24:53.705475 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:08f8ff2d-ac87-4dfc-88a4-2f76356d59d4&page=queryresults
[0m15:24:54.058354 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:08f8ff2d-ac87-4dfc-88a4-2f76356d59d4&page=queryresults
[0m15:24:54.074382 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 15:24:51.654124 => 15:24:54.074382
[0m15:24:54.074382 [debug] [Thread-1  ]: Database Error in model tb_agg_venda_produto_final (models\3.az\tb_agg_venda_produto_final.sql)
  No matching signature for operator >= for argument types: STRING, DATE
    Signature: T1 >= T1
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {STRING, DATE} at [106:10]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_agg_venda_produto_final.sql
[0m15:24:54.074382 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1878f8ef-cbe0-4752-905a-350dce7a6879', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C7204D850>]}
[0m15:24:54.074382 [error] [Thread-1  ]: 1 of 3 ERROR creating sql table model dbt_dw_az.tb_agg_venda_produto_final ..... [[31mERROR[0m in 2.45s]
[0m15:24:54.074382 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:24:54.090099 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m15:24:54.092513 [info ] [Thread-2  ]: 2 of 3 SKIP relation dbt_dw_az.tb_venda_produto_base ........................... [[33mSKIP[0m]
[0m15:24:54.094255 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m15:24:54.095408 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m15:24:54.098158 [info ] [Thread-1  ]: 3 of 3 SKIP relation dbt_dw_az.tb_estoque_produto_base ......................... [[33mSKIP[0m]
[0m15:24:54.100227 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m15:24:54.103670 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:24:54.103670 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:24:54.103670 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:24:54.103670 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:24:54.103670 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_agg_venda_produto_final' was properly closed.
[0m15:24:54.103670 [info ] [MainThread]: 
[0m15:24:54.103670 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 4.64 seconds (4.64s).
[0m15:24:54.103670 [debug] [MainThread]: Command end result
[0m15:24:54.129898 [info ] [MainThread]: 
[0m15:24:54.131459 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:24:54.131459 [info ] [MainThread]: 
[0m15:24:54.131459 [error] [MainThread]:   Database Error in model tb_agg_venda_produto_final (models\3.az\tb_agg_venda_produto_final.sql)
  No matching signature for operator >= for argument types: STRING, DATE
    Signature: T1 >= T1
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {STRING, DATE} at [106:10]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_agg_venda_produto_final.sql
[0m15:24:54.131459 [info ] [MainThread]: 
[0m15:24:54.131459 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=2 TOTAL=3
[0m15:24:54.131459 [debug] [MainThread]: Command `dbt run` failed at 15:24:54.131459 after 5.41 seconds
[0m15:24:54.131459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C6E516460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C71AACD30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027C71BD4B80>]}
[0m15:24:54.131459 [debug] [MainThread]: Flushing usage events
[0m15:25:15.325121 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025358216460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025357189A30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025357189D60>]}


============================== 15:25:15.340888 | 9a482cba-6ca1-4226-b12c-7ce6785a36bb ==============================
[0m15:25:15.340888 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:25:15.340888 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_agg_venda_produto_final+', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:25:15.744892 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9a482cba-6ca1-4226-b12c-7ce6785a36bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002535717E1F0>]}
[0m15:25:15.792928 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9a482cba-6ca1-4226-b12c-7ce6785a36bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002535B883B20>]}
[0m15:25:15.792928 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:25:15.809011 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:25:15.898320 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:25:15.898320 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_agg_venda_produto_final.sql
[0m15:25:15.993787 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9a482cba-6ca1-4226-b12c-7ce6785a36bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002535BCF6D00>]}
[0m15:25:15.993787 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9a482cba-6ca1-4226-b12c-7ce6785a36bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002535BB4C340>]}
[0m15:25:16.009846 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:25:16.010958 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9a482cba-6ca1-4226-b12c-7ce6785a36bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002535BB3AD60>]}
[0m15:25:16.011329 [info ] [MainThread]: 
[0m15:25:16.011329 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:25:16.011329 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:25:16.011329 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:25:16.705615 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:25:16.712963 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:25:16.749706 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:25:16.749706 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:25:17.363127 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:25:17.363127 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:25:17.411276 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m15:25:17.411276 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:25:18.106481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9a482cba-6ca1-4226-b12c-7ce6785a36bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002535B8E1BE0>]}
[0m15:25:18.106481 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:25:18.106481 [info ] [MainThread]: 
[0m15:25:18.126449 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:25:18.127348 [info ] [Thread-1  ]: 1 of 3 START sql table model dbt_dw_az.tb_agg_venda_produto_final .............. [RUN]
[0m15:25:18.129348 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_agg_venda_produto_final'
[0m15:25:18.130348 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:25:18.145698 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m15:25:18.147081 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 15:25:18.130348 => 15:25:18.147081
[0m15:25:18.147081 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:25:18.159917 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:25:19.000228 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m15:25:19.000228 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m15:25:19.467514 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d10877c9-995f-4fae-b7a3-3953766883de&page=queryresults
[0m15:25:21.978934 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 15:25:18.147081 => 15:25:21.978934
[0m15:25:21.978934 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9a482cba-6ca1-4226-b12c-7ce6785a36bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002535BD4DEB0>]}
[0m15:25:21.978934 [info ] [Thread-1  ]: 1 of 3 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ......... [[32mCREATE TABLE (319.0 rows, 279.7 KiB processed)[0m in 3.85s]
[0m15:25:21.994731 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:25:21.994731 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m15:25:21.994731 [info ] [Thread-2  ]: 2 of 3 START sql table model dbt_dw_az.tb_venda_produto_base ................... [RUN]
[0m15:25:21.994731 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_venda_produto_base'
[0m15:25:21.994731 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m15:25:21.994731 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m15:25:22.010495 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 15:25:21.994731 => 15:25:22.010495
[0m15:25:22.010495 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m15:25:22.015111 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m15:25:22.635564 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m15:25:22.646506 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m15:25:23.037322 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c3899398-25cf-4477-8b5a-c2fb685e8778&page=queryresults
[0m15:25:25.554348 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 15:25:22.010495 => 15:25:25.554348
[0m15:25:25.556346 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9a482cba-6ca1-4226-b12c-7ce6785a36bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002535BD4DC40>]}
[0m15:25:25.557348 [info ] [Thread-2  ]: 2 of 3 OK created sql table model dbt_dw_az.tb_venda_produto_base .............. [[32mCREATE TABLE (198.0 rows, 123.6 KiB processed)[0m in 3.56s]
[0m15:25:25.559798 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m15:25:25.559798 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m15:25:25.564723 [info ] [Thread-1  ]: 3 of 3 START sql table model dbt_dw_az.tb_estoque_produto_base ................. [RUN]
[0m15:25:25.564723 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_estoque_produto_base)
[0m15:25:25.564723 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m15:25:25.576238 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:25:25.578755 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 15:25:25.564723 => 15:25:25.578098
[0m15:25:25.578755 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m15:25:25.584543 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:25:26.226950 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:25:26.226950 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m15:25:26.815295 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ff4066b1-b457-499c-9d1c-af0950a91f21&page=queryresults
[0m15:25:31.142198 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 15:25:25.580359 => 15:25:31.142198
[0m15:25:31.142198 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9a482cba-6ca1-4226-b12c-7ce6785a36bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002535CDAB820>]}
[0m15:25:31.142198 [info ] [Thread-1  ]: 3 of 3 OK created sql table model dbt_dw_az.tb_estoque_produto_base ............ [[32mCREATE TABLE (198.0 rows, 2.2 MiB processed)[0m in 5.58s]
[0m15:25:31.142198 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m15:25:31.142198 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:25:31.142198 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:25:31.142198 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:25:31.142198 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m15:25:31.142198 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m15:25:31.142198 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m15:25:31.142198 [info ] [MainThread]: 
[0m15:25:31.142198 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 15.13 seconds (15.13s).
[0m15:25:31.157274 [debug] [MainThread]: Command end result
[0m15:25:31.181324 [info ] [MainThread]: 
[0m15:25:31.181324 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:25:31.181324 [info ] [MainThread]: 
[0m15:25:31.181324 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m15:25:31.181324 [debug] [MainThread]: Command `dbt run` succeeded at 15:25:31.181324 after 15.90 seconds
[0m15:25:31.181324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025358216460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002535BCF31F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002535BB65C10>]}
[0m15:25:31.181324 [debug] [MainThread]: Flushing usage events
[0m16:00:04.174364 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DB4F3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DA47F9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DA47FD30>]}


============================== 16:00:04.185626 | d2975e2b-8100-45fa-a10b-a760918f44e3 ==============================
[0m16:00:04.185626 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:00:04.185626 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --exclude tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m16:00:04.703746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DD63AB80>]}
[0m16:00:04.767847 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DEC3CE20>]}
[0m16:00:04.767847 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:00:04.767847 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:00:04.863927 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:00:04.863927 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:00:04.863927 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DEE37670>]}
[0m16:00:04.880086 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DEE2C2B0>]}
[0m16:00:04.880086 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:00:04.880086 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DEE2C130>]}
[0m16:00:04.892102 [info ] [MainThread]: 
[0m16:00:04.892102 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:00:04.892102 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:00:04.895974 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:04.911845 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:00:04.911845 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:12.699333 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:13.409365 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:00:13.410913 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:13.412249 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:00:13.414205 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:14.226891 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m16:00:14.226891 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:14.226891 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m16:00:14.226891 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:15.009568 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DEBB5970>]}
[0m16:00:15.009568 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:00:15.009568 [info ] [MainThread]: 
[0m16:00:15.015461 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:15.015461 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m16:00:15.015461 [info ] [Thread-1  ]: 1 of 20 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m16:00:15.015461 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m16:00:15.015461 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:15.015461 [info ] [Thread-2  ]: 2 of 20 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m16:00:15.035192 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m16:00:15.035192 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m16:00:15.035192 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m16:00:15.046834 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m16:00:15.046834 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 16:00:15.015461 => 16:00:15.046834
[0m16:00:15.046834 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:15.062860 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 16:00:15.035192 => 16:00:15.062860
[0m16:00:15.062860 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m16:00:15.078581 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m16:00:15.094281 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m16:00:15.094281 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:00:15.094281 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m16:00:15.110480 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m16:00:15.110480 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m16:00:15.911820 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0234b2db-9357-4d5e-9ad0-67a807ebde1f&page=queryresults
[0m16:00:15.911820 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8307abe9-d733-4d2e-a6e3-c23ab08b268e&page=queryresults
[0m16:00:16.376902 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 16:00:15.062860 => 16:00:16.376902
[0m16:00:16.392984 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DFF0FFD0>]}
[0m16:00:16.392984 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 16:00:15.046834 => 16:00:16.392984
[0m16:00:16.392984 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DFF0FEB0>]}
[0m16:00:16.392984 [info ] [Thread-2  ]: 2 of 20 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m16:00:16.392984 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m16:00:16.392984 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m16:00:16.392984 [info ] [Thread-1  ]: 1 of 20 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.38s]
[0m16:00:16.392984 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:16.392984 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m16:00:16.392984 [info ] [Thread-2  ]: 3 of 20 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m16:00:16.392984 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m16:00:16.392984 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m16:00:16.392984 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m16:00:16.392984 [info ] [Thread-1  ]: 4 of 20 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m16:00:16.392984 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 16:00:16.392984 => 16:00:16.392984
[0m16:00:16.408993 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m16:00:16.408993 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m16:00:16.408993 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m16:00:16.408993 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m16:00:16.408993 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m16:00:16.408993 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:16.408993 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 16:00:16.408993 => 16:00:16.408993
[0m16:00:16.408993 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m16:00:16.425155 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m16:00:16.425155 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m16:00:16.441051 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:16.441051 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m16:00:17.199223 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:722c3178-640d-4181-9b6f-d6a8b8e642d1&page=queryresults
[0m16:00:17.258797 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:60d84ab9-32a5-4ad9-8d57-da6c7ce5206d&page=queryresults
[0m16:00:17.611583 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 16:00:16.408993 => 16:00:17.611583
[0m16:00:17.611583 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DFEC3040>]}
[0m16:00:17.611583 [info ] [Thread-2  ]: 3 of 20 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m16:00:17.611583 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m16:00:17.621227 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m16:00:17.621227 [info ] [Thread-2  ]: 5 of 20 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m16:00:17.621227 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m16:00:17.621227 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m16:00:17.629526 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m16:00:17.631541 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 16:00:17.624491 => 16:00:17.629526
[0m16:00:17.631541 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m16:00:17.635570 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m16:00:17.637582 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:17.639594 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m16:00:17.675180 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 16:00:16.408993 => 16:00:17.675180
[0m16:00:17.675180 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DEEEEE80>]}
[0m16:00:17.675180 [info ] [Thread-1  ]: 4 of 20 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m16:00:17.675180 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m16:00:17.675180 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m16:00:17.675180 [info ] [Thread-1  ]: 6 of 20 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m16:00:17.690978 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m16:00:17.690978 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m16:00:17.690978 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m16:00:17.690978 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 16:00:17.690978 => 16:00:17.690978
[0m16:00:17.690978 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m16:00:17.690978 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m16:00:17.690978 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:17.690978 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m16:00:18.398889 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:61be7714-2a1c-4baa-8776-c2fd96eb4ce5&page=queryresults
[0m16:00:18.466529 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5eb0e23a-f128-40dc-809f-f43ff05f7567&page=queryresults
[0m16:00:18.828013 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 16:00:17.631541 => 16:00:18.828013
[0m16:00:18.828013 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DFEC3130>]}
[0m16:00:18.843773 [info ] [Thread-2  ]: 5 of 20 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m16:00:18.843773 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m16:00:18.843773 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m16:00:18.843773 [info ] [Thread-2  ]: 7 of 20 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m16:00:18.843773 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m16:00:18.843773 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m16:00:18.859586 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m16:00:18.859586 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 16:00:18.843773 => 16:00:18.859586
[0m16:00:18.859586 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m16:00:18.859586 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m16:00:18.859586 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:18.859586 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m16:00:18.891550 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 16:00:17.690978 => 16:00:18.891550
[0m16:00:18.891550 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DFFD9D60>]}
[0m16:00:18.891550 [info ] [Thread-1  ]: 6 of 20 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m16:00:18.891550 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m16:00:18.891550 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m16:00:18.891550 [info ] [Thread-1  ]: 8 of 20 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m16:00:18.891550 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m16:00:18.891550 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m16:00:18.891550 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m16:00:18.891550 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 16:00:18.891550 => 16:00:18.891550
[0m16:00:18.891550 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m16:00:18.891550 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m16:00:18.891550 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:18.891550 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m16:00:19.566284 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a4832897-fc89-4f9a-94a2-06eb04272be2&page=queryresults
[0m16:00:19.694891 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5b711658-59a2-4a6a-a2ba-45560558fd40&page=queryresults
[0m16:00:19.993626 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 16:00:18.859586 => 16:00:19.993626
[0m16:00:19.993626 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DFEC3040>]}
[0m16:00:19.993626 [info ] [Thread-2  ]: 7 of 20 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m16:00:19.993626 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m16:00:19.993626 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m16:00:19.993626 [info ] [Thread-2  ]: 9 of 20 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m16:00:19.993626 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m16:00:19.993626 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m16:00:20.009681 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m16:00:20.009681 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 16:00:19.993626 => 16:00:20.009681
[0m16:00:20.009681 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m16:00:20.009681 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m16:00:20.009681 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:20.009681 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m16:00:20.105981 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 16:00:18.891550 => 16:00:20.105981
[0m16:00:20.105981 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DFFBE460>]}
[0m16:00:20.105981 [info ] [Thread-1  ]: 8 of 20 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m16:00:20.105981 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m16:00:20.105981 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m16:00:20.105981 [info ] [Thread-1  ]: 10 of 20 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m16:00:20.105981 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_tempo)
[0m16:00:20.105981 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m16:00:20.121757 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m16:00:20.121757 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 16:00:20.105981 => 16:00:20.121757
[0m16:00:20.121757 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m16:00:20.121757 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m16:00:20.121757 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:20.121757 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m16:00:20.976946 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3e8070b0-b171-45a2-99ee-fb9237172ea6&page=queryresults
[0m16:00:21.089593 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cbf5fe21-d134-4fad-b614-dfad1c3d7453&page=queryresults
[0m16:00:21.395081 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 16:00:20.009681 => 16:00:21.395081
[0m16:00:21.395081 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210E0011EE0>]}
[0m16:00:21.395081 [info ] [Thread-2  ]: 9 of 20 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m16:00:21.395081 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m16:00:21.395081 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m16:00:21.395081 [info ] [Thread-2  ]: 11 of 20 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m16:00:21.395081 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m16:00:21.395081 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m16:00:21.410989 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m16:00:21.410989 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 16:00:21.395081 => 16:00:21.410989
[0m16:00:21.410989 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m16:00:21.410989 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:21.507699 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 16:00:20.121757 => 16:00:21.507699
[0m16:00:21.523665 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DFEC3790>]}
[0m16:00:21.523665 [info ] [Thread-1  ]: 10 of 20 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m16:00:21.523665 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m16:00:22.128689 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m16:00:22.130696 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m16:00:22.768917 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3e4c1c0e-9bdb-40e0-a77d-901f49d85f93&page=queryresults
[0m16:00:25.932751 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 16:00:21.410989 => 16:00:25.931755
[0m16:00:25.933749 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DFF43190>]}
[0m16:00:25.933749 [info ] [Thread-2  ]: 11 of 20 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 4.54s]
[0m16:00:25.935747 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m16:00:25.936748 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m16:00:25.936748 [info ] [Thread-1  ]: 12 of 20 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m16:00:25.938750 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m16:00:25.939509 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m16:00:25.943180 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m16:00:25.944224 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 16:00:25.939509 => 16:00:25.943180
[0m16:00:25.944224 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m16:00:25.946223 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:26.785467 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m16:00:26.786463 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m16:00:27.486114 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a31e50e9-5728-4073-93b3-acdfe23c556f&page=queryresults
[0m16:00:29.792918 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 16:00:25.944224 => 16:00:29.792918
[0m16:00:29.792918 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210E00EB340>]}
[0m16:00:29.792918 [info ] [Thread-1  ]: 12 of 20 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 3.86s]
[0m16:00:29.792918 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m16:00:29.792918 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m16:00:29.792918 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m16:00:29.792918 [info ] [Thread-2  ]: 13 of 20 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m16:00:29.792918 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m16:00:29.792918 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m16:00:29.808976 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m16:00:29.792918 [info ] [Thread-1  ]: 14 of 20 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m16:00:29.808976 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m16:00:29.808976 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m16:00:29.808976 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m16:00:29.808976 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 16:00:29.792918 => 16:00:29.808976
[0m16:00:29.808976 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m16:00:29.825089 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:29.854137 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 16:00:29.808976 => 16:00:29.854137
[0m16:00:29.854137 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m16:00:29.856113 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:30.474018 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m16:00:30.474018 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m16:00:30.518648 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m16:00:30.521247 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m16:00:30.921772 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:07927e20-0449-469e-a16f-dd93457be967&page=queryresults
[0m16:00:31.129698 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8e37ef20-05e9-423f-aca0-25ccd6cb239f&page=queryresults
[0m16:00:33.430548 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 16:00:29.855113 => 16:00:33.430548
[0m16:00:33.446545 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210E003C3D0>]}
[0m16:00:33.446545 [info ] [Thread-1  ]: 14 of 20 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 82.5 KiB processed)[0m in 3.64s]
[0m16:00:33.446545 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m16:00:33.446545 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m16:00:33.446545 [info ] [Thread-1  ]: 15 of 20 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m16:00:33.446545 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_pedido)
[0m16:00:33.446545 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m16:00:33.446545 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m16:00:33.446545 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 16:00:33.446545 => 16:00:33.446545
[0m16:00:33.462520 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m16:00:33.462520 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:33.666013 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 16:00:29.808976 => 16:00:33.666013
[0m16:00:33.667813 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DFF43400>]}
[0m16:00:33.669352 [info ] [Thread-2  ]: 13 of 20 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 108.6 KiB processed)[0m in 3.87s]
[0m16:00:33.671484 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m16:00:33.672477 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m16:00:33.673479 [info ] [Thread-2  ]: 16 of 20 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m16:00:33.675479 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_preco_produto)
[0m16:00:33.676478 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m16:00:33.680519 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m16:00:33.689256 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 16:00:33.677479 => 16:00:33.680519
[0m16:00:33.690379 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m16:00:33.691377 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:34.103841 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m16:00:34.106846 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m16:00:34.321826 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m16:00:34.321826 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m16:00:34.731700 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3ca6a371-a4fe-48fb-a6c8-b82533ef26d8&page=queryresults
[0m16:00:34.960358 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a7f693d7-b0fc-4bc9-a033-763cfab9ce63&page=queryresults
[0m16:00:37.545694 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 16:00:33.462520 => 16:00:37.544689
[0m16:00:37.546698 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210E003CD00>]}
[0m16:00:37.547693 [info ] [Thread-1  ]: 15 of 20 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 4.10s]
[0m16:00:37.549639 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m16:00:37.550679 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m16:00:37.551697 [info ] [Thread-1  ]: 17 of 20 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m16:00:37.552689 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m16:00:37.553698 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m16:00:37.558697 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m16:00:37.559685 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 16:00:37.553698 => 16:00:37.559685
[0m16:00:37.561714 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m16:00:37.561714 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:38.075745 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 16:00:33.690379 => 16:00:38.075427
[0m16:00:38.076764 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DFFC4910>]}
[0m16:00:38.077195 [info ] [Thread-2  ]: 16 of 20 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (309.0 rows, 81.0 KiB processed)[0m in 4.40s]
[0m16:00:38.079345 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m16:00:38.250514 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m16:00:38.252638 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m16:00:38.627245 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a52ee377-7bf9-4d20-88d5-74463f190242&page=queryresults
[0m16:00:40.852969 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 16:00:37.561714 => 16:00:40.852969
[0m16:00:40.854969 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DFF43400>]}
[0m16:00:40.855973 [info ] [Thread-1  ]: 17 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 413.1 KiB processed)[0m in 3.30s]
[0m16:00:40.858373 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m16:00:40.859618 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m16:00:40.861771 [info ] [Thread-2  ]: 18 of 20 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m16:00:40.863772 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m16:00:40.864774 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m16:00:40.871385 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m16:00:40.873385 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 16:00:40.864774 => 16:00:40.872383
[0m16:00:40.873385 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m16:00:40.876379 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:41.506695 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m16:00:41.506695 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m16:00:41.920934 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:369060ef-a19f-47c1-a56c-d355edd58219&page=queryresults
[0m16:00:44.108792 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 16:00:40.873385 => 16:00:44.108792
[0m16:00:44.108792 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210E00BE070>]}
[0m16:00:44.108792 [info ] [Thread-2  ]: 18 of 20 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (319.0 rows, 279.7 KiB processed)[0m in 3.25s]
[0m16:00:44.108792 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m16:00:44.124723 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m16:00:44.124723 [info ] [Thread-1  ]: 19 of 20 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m16:00:44.124723 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m16:00:44.124723 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m16:00:44.124723 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m16:00:44.140405 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 16:00:44.124723 => 16:00:44.140405
[0m16:00:44.140405 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m16:00:44.147558 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:44.990873 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m16:00:44.991872 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m16:00:45.374782 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b1d11c62-9968-4a07-b1af-9b1ca4cf0128&page=queryresults
[0m16:00:49.074588 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 16:00:44.140405 => 16:00:49.073548
[0m16:00:49.075005 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DFFC17C0>]}
[0m16:00:49.075005 [info ] [Thread-1  ]: 19 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (198.0 rows, 123.6 KiB processed)[0m in 4.95s]
[0m16:00:49.079710 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m16:00:49.082764 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m16:00:49.083792 [info ] [Thread-2  ]: 20 of 20 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m16:00:49.086247 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_estoque_produto_base)
[0m16:00:49.086247 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m16:00:49.096704 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m16:00:49.098651 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 16:00:49.086247 => 16:00:49.097714
[0m16:00:49.098651 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m16:00:49.103150 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:49.750652 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m16:00:49.753796 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m16:00:50.316762 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:09a0f598-004f-4b06-8957-6cd63034798a&page=queryresults
[0m16:00:53.731622 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 16:00:49.099725 => 16:00:53.731622
[0m16:00:53.733807 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd2975e2b-8100-45fa-a10b-a760918f44e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DFEE8910>]}
[0m16:00:53.735141 [info ] [Thread-2  ]: 20 of 20 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (198.0 rows, 2.2 MiB processed)[0m in 4.65s]
[0m16:00:53.737403 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m16:00:53.742661 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:00:53.743660 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:00:53.744659 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:00:53.745355 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m16:00:53.745355 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m16:00:53.746646 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m16:00:53.746646 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m16:00:53.747656 [info ] [MainThread]: 
[0m16:00:53.748657 [info ] [MainThread]: Finished running 10 view models, 10 table models in 0 hours 0 minutes and 48.86 seconds (48.86s).
[0m16:00:53.755853 [debug] [MainThread]: Command end result
[0m16:00:53.775778 [info ] [MainThread]: 
[0m16:00:53.776786 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:00:53.777789 [info ] [MainThread]: 
[0m16:00:53.778777 [info ] [MainThread]: Done. PASS=20 WARN=0 ERROR=0 SKIP=0 TOTAL=20
[0m16:00:53.779657 [debug] [MainThread]: Command `dbt run` succeeded at 16:00:53.779657 after 49.65 seconds
[0m16:00:53.779657 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DB4F3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DEB7F2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000210DEEBA9D0>]}
[0m16:00:53.779657 [debug] [MainThread]: Flushing usage events
[0m16:00:57.323735 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2DB859460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2DA7E4670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2DA7E4D90>]}


============================== 16:00:57.330088 | b34baa62-d7fb-4b08-87a7-2accab32fc63 ==============================
[0m16:00:57.330088 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:00:57.330088 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:00:57.889408 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b34baa62-d7fb-4b08-87a7-2accab32fc63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2DA7DF070>]}
[0m16:00:57.953074 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b34baa62-d7fb-4b08-87a7-2accab32fc63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2DEEB9BE0>]}
[0m16:00:57.953074 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:00:57.953074 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:00:58.001042 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:00:58.001042 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:00:58.001042 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b34baa62-d7fb-4b08-87a7-2accab32fc63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2DF1A57F0>]}
[0m16:00:58.017197 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b34baa62-d7fb-4b08-87a7-2accab32fc63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2DF198400>]}
[0m16:00:58.017197 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:00:58.017197 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b34baa62-d7fb-4b08-87a7-2accab32fc63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2DF198310>]}
[0m16:00:58.017197 [info ] [MainThread]: 
[0m16:00:58.017197 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:00:58.017197 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:00:58.017197 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:58.739546 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m16:00:58.739546 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:58.739546 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:00:58.739546 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:59.394114 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m16:00:59.394114 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:59.439474 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m16:00:59.439474 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:01:00.067160 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b34baa62-d7fb-4b08-87a7-2accab32fc63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2DEE48F40>]}
[0m16:01:00.067160 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:01:00.073062 [info ] [MainThread]: 
[0m16:01:00.083082 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m16:01:00.083082 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m16:01:00.083082 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m16:01:00.083082 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m16:01:00.099188 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 16:01:00.083082 => 16:01:00.099188
[0m16:01:00.099188 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m16:01:00.131314 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:01:00.131314 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m16:01:00.934663 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e847a586-fe9f-48c4-86eb-b6c8232d58f6&page=queryresults
[0m16:01:02.068328 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m16:01:02.469475 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:56b4b894-57fe-4cdd-98c7-78f39b35b265&page=queryresults
[0m16:01:05.112603 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m16:01:06.106854 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m16:01:06.106854 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m16:01:06.581743 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:886767a2-daae-4435-9faf-3dacbd8535f3&page=queryresults
[0m16:01:08.611089 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 16:01:00.099188 => 16:01:08.611089
[0m16:01:08.613105 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b34baa62-d7fb-4b08-87a7-2accab32fc63', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2DF24F760>]}
[0m16:01:08.613105 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 66.0 KiB processed)[0m in 8.53s]
[0m16:01:08.615118 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m16:01:08.619568 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:01:08.619568 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:01:08.619568 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:01:08.619568 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m16:01:08.619568 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m16:01:08.619568 [info ] [MainThread]: 
[0m16:01:08.625070 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.60 seconds (10.60s).
[0m16:01:08.625070 [debug] [MainThread]: Command end result
[0m16:01:08.643000 [info ] [MainThread]: 
[0m16:01:08.643000 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:01:08.643000 [info ] [MainThread]: 
[0m16:01:08.643000 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:01:08.643000 [debug] [MainThread]: Command `dbt snapshot` succeeded at 16:01:08.643000 after 11.38 seconds
[0m16:01:08.643000 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2DB859460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2DEF2D4C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B2DEF8F2E0>]}
[0m16:01:08.643000 [debug] [MainThread]: Flushing usage events
[0m16:01:12.546561 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DE4A9400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DD430910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DD430B80>]}


============================== 16:01:12.550533 | f90096a4-a8f7-4453-8aa4-2f079ee5b2d6 ==============================
[0m16:01:12.550533 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:01:12.551529 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:01:13.052402 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f90096a4-a8f7-4453-8aa4-2f079ee5b2d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190E05F5A00>]}
[0m16:01:13.102166 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f90096a4-a8f7-4453-8aa4-2f079ee5b2d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190E1B23430>]}
[0m16:01:13.102166 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:01:13.118402 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:01:13.166279 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:01:13.166279 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:01:13.166279 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f90096a4-a8f7-4453-8aa4-2f079ee5b2d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190E1DF9370>]}
[0m16:01:13.182314 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f90096a4-a8f7-4453-8aa4-2f079ee5b2d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190E1AAF310>]}
[0m16:01:13.182314 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:01:13.182314 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f90096a4-a8f7-4453-8aa4-2f079ee5b2d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190E1AAF820>]}
[0m16:01:13.182314 [info ] [MainThread]: 
[0m16:01:13.182314 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:01:13.182314 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:01:13.182314 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:01:13.868818 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m16:01:13.876983 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:01:13.882012 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:01:13.882012 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:01:14.530503 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m16:01:14.530503 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:01:14.557424 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m16:01:14.557424 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:01:15.392382 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f90096a4-a8f7-4453-8aa4-2f079ee5b2d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190E1B76CA0>]}
[0m16:01:15.400390 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:01:15.401397 [info ] [MainThread]: 
[0m16:01:15.403577 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m16:01:15.403577 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m16:01:15.403577 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m16:01:15.403577 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m16:01:15.413485 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m16:01:15.413485 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 16:01:15.403577 => 16:01:15.413485
[0m16:01:15.414449 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m16:01:15.426058 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:01:16.089956 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m16:01:16.089956 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m16:01:16.430299 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fb48b8d3-0dec-4be7-a1b1-dda8fa21abc6&page=queryresults
[0m16:01:18.398219 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 16:01:15.414449 => 16:01:18.398219
[0m16:01:18.398219 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f90096a4-a8f7-4453-8aa4-2f079ee5b2d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190E2E80D60>]}
[0m16:01:18.398219 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (366.0 rows, 53.8 KiB processed)[0m in 2.99s]
[0m16:01:18.414187 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m16:01:18.414187 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:01:18.414187 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:01:18.414187 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:01:18.414187 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m16:01:18.414187 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m16:01:18.414187 [info ] [MainThread]: 
[0m16:01:18.414187 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.23 seconds (5.23s).
[0m16:01:18.414187 [debug] [MainThread]: Command end result
[0m16:01:18.430249 [info ] [MainThread]: 
[0m16:01:18.430249 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:01:18.430249 [info ] [MainThread]: 
[0m16:01:18.430249 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:01:18.430249 [debug] [MainThread]: Command `dbt run` succeeded at 16:01:18.430249 after 5.95 seconds
[0m16:01:18.446411 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190DE4A9400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190E1B23430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000190E1B76160>]}
[0m16:01:18.446411 [debug] [MainThread]: Flushing usage events
[0m17:00:04.345338 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984B019430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019849F969D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019849F96B80>]}


============================== 17:00:04.349101 | 33a0a000-228d-4b46-bf9b-ac9568d1af2d ==============================
[0m17:00:04.349101 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:00:04.349563 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m17:00:04.885782 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984D16CAC0>]}
[0m17:00:04.933597 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984E68C520>]}
[0m17:00:04.949824 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:00:04.949824 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:00:05.011147 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:00:05.012160 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:00:05.016141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984E9682E0>]}
[0m17:00:05.028944 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984E7A1FA0>]}
[0m17:00:05.028944 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:00:05.029946 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984E7A1070>]}
[0m17:00:05.031949 [info ] [MainThread]: 
[0m17:00:05.032945 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:00:05.034955 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:05.034955 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:05.035948 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:05.035948 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:06.070060 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:07.140792 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m17:00:07.148301 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:07.150278 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:00:07.151949 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:07.891720 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m17:00:07.899077 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:07.949913 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m17:00:07.949913 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:08.615886 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984E9B7130>]}
[0m17:00:08.617911 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:00:08.619923 [info ] [MainThread]: 
[0m17:00:08.625720 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:08.625720 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.625720 [info ] [Thread-1  ]: 1 of 20 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m17:00:08.625720 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m17:00:08.625720 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:08.639365 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m17:00:08.625720 [info ] [Thread-2  ]: 2 of 20 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m17:00:08.641199 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m17:00:08.641199 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.647533 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m17:00:08.647533 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 17:00:08.641199 => 17:00:08.647533
[0m17:00:08.647533 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 17:00:08.625720 => 17:00:08.647533
[0m17:00:08.647533 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.647533 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:08.671064 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m17:00:08.677933 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m17:00:08.679676 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:00:08.680850 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m17:00:08.701230 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:00:08.703229 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m17:00:09.573121 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b1263fee-b111-4355-8b99-a9e085eda28d&page=queryresults
[0m17:00:09.573121 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c7d0373d-fd57-42dd-b229-77bc237badeb&page=queryresults
[0m17:00:10.039014 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 17:00:08.647533 => 17:00:10.039014
[0m17:00:10.039509 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984FA555B0>]}
[0m17:00:10.040818 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 17:00:08.671064 => 17:00:10.037309
[0m17:00:10.040818 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984FA5B7C0>]}
[0m17:00:10.039509 [info ] [Thread-2  ]: 2 of 20 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m17:00:10.041988 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m17:00:10.041988 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m17:00:10.040818 [info ] [Thread-1  ]: 1 of 20 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m17:00:10.043002 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:10.044001 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m17:00:10.043002 [info ] [Thread-2  ]: 3 of 20 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m17:00:10.044332 [info ] [Thread-1  ]: 4 of 20 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m17:00:10.045345 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m17:00:10.045796 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m17:00:10.045796 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m17:00:10.046804 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m17:00:10.049505 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m17:00:10.052144 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m17:00:10.053130 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 17:00:10.046804 => 17:00:10.052144
[0m17:00:10.053130 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m17:00:10.057663 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 17:00:10.049505 => 17:00:10.057663
[0m17:00:10.060041 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m17:00:10.061062 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m17:00:10.062602 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m17:00:10.062602 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:10.062602 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m17:00:10.089904 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:10.091656 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m17:00:10.811520 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ced96b4b-f681-4f1d-a9ff-7ebd1b55c6c7&page=queryresults
[0m17:00:10.876188 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ec855370-552a-4fe0-bc83-557ad3067f6f&page=queryresults
[0m17:00:11.212231 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 17:00:10.053130 => 17:00:11.212231
[0m17:00:11.214246 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984F9FE730>]}
[0m17:00:11.214246 [info ] [Thread-2  ]: 3 of 20 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m17:00:11.214246 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m17:00:11.214246 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m17:00:11.214246 [info ] [Thread-2  ]: 5 of 20 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m17:00:11.214246 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m17:00:11.214246 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m17:00:11.228080 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m17:00:11.230092 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 17:00:11.221029 => 17:00:11.230092
[0m17:00:11.232103 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m17:00:11.234114 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m17:00:11.236121 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:11.236121 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m17:00:11.283637 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 17:00:10.061512 => 17:00:11.281626
[0m17:00:11.283637 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984E6DDBE0>]}
[0m17:00:11.283637 [info ] [Thread-1  ]: 4 of 20 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m17:00:11.285647 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m17:00:11.285647 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m17:00:11.285647 [info ] [Thread-1  ]: 6 of 20 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m17:00:11.287760 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m17:00:11.287760 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m17:00:11.291507 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m17:00:11.291507 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 17:00:11.287760 => 17:00:11.291507
[0m17:00:11.293514 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m17:00:11.295520 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m17:00:11.295520 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:11.295520 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m17:00:12.104963 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:318208ac-2e7c-4b36-a997-b5a805203bd3&page=queryresults
[0m17:00:12.147741 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:88a07b5c-ab35-4c54-929d-abde0fd33815&page=queryresults
[0m17:00:12.522603 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 17:00:11.293514 => 17:00:12.521603
[0m17:00:12.523603 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984E9EA910>]}
[0m17:00:12.524604 [info ] [Thread-1  ]: 6 of 20 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m17:00:12.526614 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m17:00:12.527605 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m17:00:12.528604 [info ] [Thread-1  ]: 7 of 20 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m17:00:12.529278 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_meta_margem_preco)
[0m17:00:12.530571 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m17:00:12.544328 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m17:00:12.546297 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 17:00:12.530571 => 17:00:12.545335
[0m17:00:12.546297 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m17:00:12.550582 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m17:00:12.551574 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:12.553578 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m17:00:12.576086 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 17:00:11.232103 => 17:00:12.575088
[0m17:00:12.576086 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984E7037F0>]}
[0m17:00:12.577087 [info ] [Thread-2  ]: 5 of 20 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m17:00:12.577445 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m17:00:12.577445 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m17:00:12.578504 [info ] [Thread-2  ]: 8 of 20 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m17:00:12.579455 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_pedido)
[0m17:00:12.579455 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m17:00:12.581561 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m17:00:12.582653 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 17:00:12.579455 => 17:00:12.582653
[0m17:00:12.582653 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m17:00:12.584656 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m17:00:12.585659 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:12.586685 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m17:00:13.271902 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1c2d2586-7780-44ff-8b55-1130470a7391&page=queryresults
[0m17:00:13.309784 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:04d44e1f-8d68-4b8f-8b4c-cdd71649767b&page=queryresults
[0m17:00:13.689522 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 17:00:12.583661 => 17:00:13.688635
[0m17:00:13.691536 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984FAA3700>]}
[0m17:00:13.692535 [info ] [Thread-2  ]: 8 of 20 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.11s]
[0m17:00:13.695188 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m17:00:13.696344 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m17:00:13.697343 [info ] [Thread-2  ]: 9 of 20 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m17:00:13.699179 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto)
[0m17:00:13.701582 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m17:00:13.702706 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m17:00:13.711789 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 17:00:13.702173 => 17:00:13.710335
[0m17:00:13.712921 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m17:00:13.715917 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m17:00:13.721083 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 17:00:12.547319 => 17:00:13.721083
[0m17:00:13.722115 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984FA55BE0>]}
[0m17:00:13.722115 [info ] [Thread-1  ]: 7 of 20 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m17:00:13.723077 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m17:00:13.723077 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m17:00:13.724123 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:13.723077 [info ] [Thread-1  ]: 10 of 20 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m17:00:13.725127 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_tempo)
[0m17:00:13.725127 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m17:00:13.727180 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m17:00:13.728893 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m17:00:13.744238 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 17:00:13.725127 => 17:00:13.744238
[0m17:00:13.744238 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m17:00:13.744238 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m17:00:13.744238 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:13.744238 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m17:00:14.448044 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:008aab15-732f-4ef9-998f-db8710d2919d&page=queryresults
[0m17:00:14.452622 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:46873ead-cded-4620-bedd-7dff49de0490&page=queryresults
[0m17:00:14.846547 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 17:00:13.712921 => 17:00:14.845542
[0m17:00:14.849067 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984FB2BE20>]}
[0m17:00:14.855521 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 17:00:13.744238 => 17:00:14.855521
[0m17:00:14.856860 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984FA5B7C0>]}
[0m17:00:14.851531 [info ] [Thread-2  ]: 9 of 20 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m17:00:14.860656 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m17:00:14.859089 [info ] [Thread-1  ]: 10 of 20 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m17:00:14.862287 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m17:00:14.863292 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m17:00:14.864896 [info ] [Thread-2  ]: 11 of 20 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m17:00:14.866091 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m17:00:14.867092 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m17:00:14.871684 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m17:00:14.872773 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 17:00:14.867092 => 17:00:14.872773
[0m17:00:14.872773 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m17:00:14.881171 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:15.549005 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m17:00:15.549005 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m17:00:16.251048 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d9d99a1d-8df3-427a-b18c-7aa17ed476b9&page=queryresults
[0m17:00:20.601849 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 17:00:14.873771 => 17:00:20.601849
[0m17:00:20.601849 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984FAA90A0>]}
[0m17:00:20.601849 [info ] [Thread-2  ]: 11 of 20 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.3 MiB processed)[0m in 5.74s]
[0m17:00:20.601849 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m17:00:20.601849 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m17:00:20.601849 [info ] [Thread-1  ]: 12 of 20 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m17:00:20.601849 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m17:00:20.601849 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m17:00:20.617715 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m17:00:20.617715 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 17:00:20.617715 => 17:00:20.617715
[0m17:00:20.617715 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m17:00:20.617715 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:21.230516 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m17:00:21.230516 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m17:00:21.914367 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c1abe7cf-4034-416f-a8c2-7cf4c5337c29&page=queryresults
[0m17:00:24.410586 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 17:00:20.617715 => 17:00:24.410586
[0m17:00:24.410586 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984EA13370>]}
[0m17:00:24.410586 [info ] [Thread-1  ]: 12 of 20 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (359.0 rows, 1.8 MiB processed)[0m in 3.81s]
[0m17:00:24.410586 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m17:00:24.419353 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m17:00:24.420373 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m17:00:24.420373 [info ] [Thread-2  ]: 13 of 20 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m17:00:24.421362 [info ] [Thread-1  ]: 14 of 20 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m17:00:24.422323 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m17:00:24.422323 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m17:00:24.422323 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m17:00:24.422323 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m17:00:24.429210 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m17:00:24.440913 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m17:00:24.441913 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 17:00:24.422323 => 17:00:24.441913
[0m17:00:24.442772 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m17:00:24.442772 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:24.469395 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 17:00:24.422323 => 17:00:24.468898
[0m17:00:24.469395 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m17:00:24.469395 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:25.089116 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m17:00:25.091131 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m17:00:25.119230 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m17:00:25.121255 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m17:00:25.413307 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4414592b-549c-4c0f-9a20-671169419ef6&page=queryresults
[0m17:00:25.698338 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a4f87196-f33c-4598-9c53-a2a417f9e87a&page=queryresults
[0m17:00:27.341324 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 17:00:24.442772 => 17:00:27.340291
[0m17:00:27.342309 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984FBBB100>]}
[0m17:00:27.344306 [info ] [Thread-1  ]: 14 of 20 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (359.0 rows, 82.5 KiB processed)[0m in 2.92s]
[0m17:00:27.345300 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m17:00:27.346314 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m17:00:27.347256 [info ] [Thread-1  ]: 15 of 20 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m17:00:27.349216 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_pedido)
[0m17:00:27.349854 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m17:00:27.354067 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m17:00:27.354067 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 17:00:27.349854 => 17:00:27.354067
[0m17:00:27.354067 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m17:00:27.358896 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:27.902701 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 17:00:24.469395 => 17:00:27.902701
[0m17:00:27.902701 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984FA03340>]}
[0m17:00:27.902701 [info ] [Thread-2  ]: 13 of 20 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 108.6 KiB processed)[0m in 3.48s]
[0m17:00:27.910794 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m17:00:27.911101 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m17:00:27.912127 [info ] [Thread-2  ]: 16 of 20 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m17:00:27.914124 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_preco_produto)
[0m17:00:27.914124 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m17:00:27.921205 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m17:00:27.923207 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 17:00:27.915123 => 17:00:27.922203
[0m17:00:27.923207 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m17:00:27.929426 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:27.986331 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m17:00:27.988327 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m17:00:28.543452 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m17:00:28.546454 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m17:00:28.596458 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2bf9c8d5-6c2f-490d-b509-89b91ca56fa2&page=queryresults
[0m17:00:29.177204 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c2adb806-6c64-4db7-867c-3a05f2a728eb&page=queryresults
[0m17:00:31.439991 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 17:00:27.354067 => 17:00:31.439685
[0m17:00:31.439991 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984FB19A00>]}
[0m17:00:31.439991 [info ] [Thread-1  ]: 15 of 20 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 4.09s]
[0m17:00:31.439991 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m17:00:31.439991 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m17:00:31.439991 [info ] [Thread-1  ]: 17 of 20 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m17:00:31.439991 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m17:00:31.439991 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m17:00:31.439991 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m17:00:31.455337 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 17:00:31.439991 => 17:00:31.439991
[0m17:00:31.455337 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m17:00:31.455337 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:32.089750 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m17:00:32.099017 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m17:00:32.250675 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 17:00:27.924204 => 17:00:32.250675
[0m17:00:32.250675 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984FB66910>]}
[0m17:00:32.250675 [info ] [Thread-2  ]: 16 of 20 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (309.0 rows, 81.0 KiB processed)[0m in 4.34s]
[0m17:00:32.261334 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m17:00:32.430917 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:da573d53-fdfa-4749-9019-b325896ca181&page=queryresults
[0m17:00:34.646537 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 17:00:31.455337 => 17:00:34.645550
[0m17:00:34.647535 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984FB73070>]}
[0m17:00:34.648545 [info ] [Thread-1  ]: 17 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 413.1 KiB processed)[0m in 3.21s]
[0m17:00:34.649147 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m17:00:34.651339 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m17:00:34.651339 [info ] [Thread-2  ]: 18 of 20 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m17:00:34.652313 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m17:00:34.653396 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m17:00:34.656361 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m17:00:34.657357 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 17:00:34.653396 => 17:00:34.657357
[0m17:00:34.657357 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m17:00:34.659113 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:35.283005 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m17:00:35.283005 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m17:00:35.689895 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d61a357b-c47f-4243-b7bc-374677e57a48&page=queryresults
[0m17:00:37.870278 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 17:00:34.657357 => 17:00:37.869237
[0m17:00:37.872310 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984FBBBBB0>]}
[0m17:00:37.873367 [info ] [Thread-2  ]: 18 of 20 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (319.0 rows, 279.7 KiB processed)[0m in 3.22s]
[0m17:00:37.876011 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m17:00:37.878066 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m17:00:37.879500 [info ] [Thread-1  ]: 19 of 20 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m17:00:37.881441 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m17:00:37.882882 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m17:00:37.891973 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m17:00:37.893023 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 17:00:37.883466 => 17:00:37.893023
[0m17:00:37.894028 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m17:00:37.899971 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:38.529053 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m17:00:38.529053 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m17:00:38.959654 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:df31c509-a4e6-4714-8318-885e044ba3a1&page=queryresults
[0m17:00:42.040097 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 17:00:37.894028 => 17:00:42.040097
[0m17:00:42.041087 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984FBA0910>]}
[0m17:00:42.043194 [info ] [Thread-1  ]: 19 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (198.0 rows, 123.6 KiB processed)[0m in 4.16s]
[0m17:00:42.044495 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m17:00:42.046464 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m17:00:42.047479 [info ] [Thread-2  ]: 20 of 20 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m17:00:42.049467 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_estoque_produto_base)
[0m17:00:42.050199 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m17:00:42.058397 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m17:00:42.060375 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 17:00:42.050612 => 17:00:42.059857
[0m17:00:42.061495 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m17:00:42.064495 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:42.770168 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m17:00:42.770168 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m17:00:43.362094 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fe9c0e2a-bb30-43c6-a3f6-f925f1fc31b6&page=queryresults
[0m17:00:46.433276 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 17:00:42.061495 => 17:00:46.433276
[0m17:00:46.433276 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33a0a000-228d-4b46-bf9b-ac9568d1af2d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984FABF820>]}
[0m17:00:46.433276 [info ] [Thread-2  ]: 20 of 20 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (198.0 rows, 2.2 MiB processed)[0m in 4.38s]
[0m17:00:46.433276 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m17:00:46.433276 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:00:46.433276 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:00:46.433276 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:00:46.433276 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:00:46.433276 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m17:00:46.433276 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m17:00:46.433276 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m17:00:46.433276 [info ] [MainThread]: 
[0m17:00:46.439049 [info ] [MainThread]: Finished running 10 view models, 10 table models in 0 hours 0 minutes and 41.40 seconds (41.40s).
[0m17:00:46.442063 [debug] [MainThread]: Command end result
[0m17:00:46.450873 [info ] [MainThread]: 
[0m17:00:46.451867 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:00:46.451867 [info ] [MainThread]: 
[0m17:00:46.452879 [info ] [MainThread]: Done. PASS=20 WARN=0 ERROR=0 SKIP=0 TOTAL=20
[0m17:00:46.453879 [debug] [MainThread]: Command `dbt run` succeeded at 17:00:46.453879 after 42.16 seconds
[0m17:00:46.453879 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984B019430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984E68C520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001984E9EAD00>]}
[0m17:00:46.453879 [debug] [MainThread]: Flushing usage events
[0m17:00:49.851730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138D79733D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138D68FF9D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138D68FFB80>]}


============================== 17:00:49.856226 | a9269d6e-0621-456e-9446-c05876bb0996 ==============================
[0m17:00:49.856226 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:00:49.856226 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt snapshot', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:00:50.381108 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a9269d6e-0621-456e-9446-c05876bb0996', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138D68E1130>]}
[0m17:00:50.443246 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a9269d6e-0621-456e-9446-c05876bb0996', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138DAECE4F0>]}
[0m17:00:50.445739 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:00:50.451265 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:00:50.499927 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:00:50.501674 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:00:50.505685 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a9269d6e-0621-456e-9446-c05876bb0996', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138DB2B57F0>]}
[0m17:00:50.513711 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a9269d6e-0621-456e-9446-c05876bb0996', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138DB2A9400>]}
[0m17:00:50.513711 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:00:50.513711 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a9269d6e-0621-456e-9446-c05876bb0996', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138DB2A9310>]}
[0m17:00:50.513711 [info ] [MainThread]: 
[0m17:00:50.513711 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:00:50.513711 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:50.513711 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:51.199869 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m17:00:51.199869 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:51.239860 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:00:51.239860 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:51.856399 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m17:00:51.856763 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:51.888881 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m17:00:51.888881 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:52.510581 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a9269d6e-0621-456e-9446-c05876bb0996', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138DAF4B1F0>]}
[0m17:00:52.512117 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:00:52.513219 [info ] [MainThread]: 
[0m17:00:52.521303 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m17:00:52.523399 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m17:00:52.525330 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m17:00:52.526327 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m17:00:52.536731 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 17:00:52.526327 => 17:00:52.536731
[0m17:00:52.536731 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m17:00:52.581898 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:00:52.583898 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m17:00:53.311585 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b4b4aba9-40af-4858-8681-a5d2d69512ee&page=queryresults
[0m17:00:54.489938 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m17:00:54.921072 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0b5678e3-2b46-4b4d-abea-afb356be6a2d&page=queryresults
[0m17:00:57.886216 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m17:00:58.708341 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m17:00:58.710358 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m17:00:59.144718 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b9c14805-f951-4304-b448-6fb15f517a67&page=queryresults
[0m17:01:01.419000 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 17:00:52.537732 => 17:01:01.419000
[0m17:01:01.419000 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a9269d6e-0621-456e-9446-c05876bb0996', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138D55F76D0>]}
[0m17:01:01.419000 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 66.0 KiB processed)[0m in 8.89s]
[0m17:01:01.419000 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m17:01:01.419000 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:01:01.419000 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:01:01.419000 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m17:01:01.419000 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:01:01.419000 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m17:01:01.434974 [info ] [MainThread]: 
[0m17:01:01.434974 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.92 seconds (10.92s).
[0m17:01:01.440554 [debug] [MainThread]: Command end result
[0m17:01:01.469097 [info ] [MainThread]: 
[0m17:01:01.469097 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:01:01.469097 [info ] [MainThread]: 
[0m17:01:01.469097 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:01:01.469097 [debug] [MainThread]: Command `dbt snapshot` succeeded at 17:01:01.469097 after 11.68 seconds
[0m17:01:01.469097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138D79733D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138DB2BF2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000138DB09F1C0>]}
[0m17:01:01.469097 [debug] [MainThread]: Flushing usage events
[0m17:01:04.907417 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB65933430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB648A79D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB648A7B80>]}


============================== 17:01:04.912434 | ed586806-9223-4d57-81e1-903a14a62d56 ==============================
[0m17:01:04.912434 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:01:04.912434 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:01:05.464720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ed586806-9223-4d57-81e1-903a14a62d56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB68F0EF40>]}
[0m17:01:05.531883 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ed586806-9223-4d57-81e1-903a14a62d56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB68EBF550>]}
[0m17:01:05.533839 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:01:05.540677 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:01:05.596498 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:01:05.597498 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:01:05.602484 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ed586806-9223-4d57-81e1-903a14a62d56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB69276E80>]}
[0m17:01:05.614106 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ed586806-9223-4d57-81e1-903a14a62d56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB69267940>]}
[0m17:01:05.614106 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:01:05.615017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ed586806-9223-4d57-81e1-903a14a62d56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB692678E0>]}
[0m17:01:05.616171 [info ] [MainThread]: 
[0m17:01:05.616171 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:01:05.618015 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:01:05.618015 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:06.287865 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:01:06.287865 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:06.289480 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m17:01:06.290522 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:07.079161 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m17:01:07.079161 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:01:07.149794 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m17:01:07.149794 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:01:07.838994 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ed586806-9223-4d57-81e1-903a14a62d56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB69276FD0>]}
[0m17:01:07.839867 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:01:07.839867 [info ] [MainThread]: 
[0m17:01:07.850964 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m17:01:07.850964 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m17:01:07.850964 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m17:01:07.850964 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m17:01:07.859713 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m17:01:07.859713 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 17:01:07.850964 => 17:01:07.859713
[0m17:01:07.859713 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m17:01:07.869344 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:01:08.522900 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m17:01:08.522900 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m17:01:08.993711 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:079fd6af-f724-4a9e-a6cd-2e855a5c5cce&page=queryresults
[0m17:01:11.825312 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 17:01:07.859713 => 17:01:11.825312
[0m17:01:11.825312 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ed586806-9223-4d57-81e1-903a14a62d56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB69300C70>]}
[0m17:01:11.825312 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (366.0 rows, 53.8 KiB processed)[0m in 3.97s]
[0m17:01:11.825312 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m17:01:11.825312 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:01:11.839706 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:01:11.840765 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m17:01:11.841865 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m17:01:11.841865 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m17:01:11.842866 [info ] [MainThread]: 
[0m17:01:11.843973 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.23 seconds (6.23s).
[0m17:01:11.845990 [debug] [MainThread]: Command end result
[0m17:01:11.865446 [info ] [MainThread]: 
[0m17:01:11.865446 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:01:11.865446 [info ] [MainThread]: 
[0m17:01:11.865446 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:01:11.865446 [debug] [MainThread]: Command `dbt run` succeeded at 17:01:11.865446 after 7.02 seconds
[0m17:01:11.874710 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB65933430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB69276FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB68F1FEB0>]}
[0m17:01:11.874710 [debug] [MainThread]: Flushing usage events
[0m17:34:42.026892 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED24A1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED14449A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED1444D30>]}


============================== 17:34:42.026892 | ff1517a5-f00a-4578-a80a-539f5cd071fe ==============================
[0m17:34:42.026892 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:34:42.026892 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:34:42.505165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED4610AC0>]}
[0m17:34:42.569230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED5B2B430>]}
[0m17:34:42.569230 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:34:42.569230 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:34:42.629095 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:34:42.629095 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:34:42.629095 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED5E07370>]}
[0m17:34:42.645065 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED5ABA310>]}
[0m17:34:42.645065 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:34:42.645065 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED5ABA820>]}
[0m17:34:42.648240 [info ] [MainThread]: 
[0m17:34:42.648240 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:34:42.648240 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:34:42.648240 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:34:42.648240 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:34:42.648240 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:34:43.458889 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:34:44.157393 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:34:44.157393 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:34:44.157393 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:34:44.157393 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:34:44.877196 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m17:34:44.879212 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:34:44.885251 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m17:34:44.885251 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:34:45.569070 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED5B7BA60>]}
[0m17:34:45.584814 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:34:45.584814 [info ] [MainThread]: 
[0m17:34:45.584814 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m17:34:45.584814 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m17:34:45.584814 [info ] [Thread-1  ]: 1 of 21 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m17:34:45.599467 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m17:34:45.584814 [info ] [Thread-2  ]: 2 of 21 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m17:34:45.601522 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m17:34:45.603094 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m17:34:45.613458 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m17:34:45.614561 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m17:34:45.625444 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m17:34:45.625444 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 17:34:45.605010 => 17:34:45.625444
[0m17:34:45.627459 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m17:34:45.649197 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m17:34:45.650316 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 17:34:45.614561 => 17:34:45.650316
[0m17:34:45.651312 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m17:34:45.653312 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m17:34:45.654307 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:34:45.655327 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m17:34:45.675301 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:34:45.675301 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m17:34:46.523909 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d0cf3895-06d2-47a0-8585-3cec9bc07f5e&page=queryresults
[0m17:34:46.523909 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:664ac859-559a-4155-827a-2f4533b9abfb&page=queryresults
[0m17:34:46.984289 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 17:34:45.651312 => 17:34:46.984289
[0m17:34:46.984289 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6F05BB0>]}
[0m17:34:46.984289 [info ] [Thread-2  ]: 2 of 21 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.38s]
[0m17:34:46.984289 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m17:34:46.984289 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m17:34:46.989105 [info ] [Thread-2  ]: 3 of 21 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m17:34:46.989105 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m17:34:46.989105 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m17:34:46.989105 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m17:34:46.989105 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 17:34:45.627459 => 17:34:46.989105
[0m17:34:46.989105 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6ECC3A0>]}
[0m17:34:46.989105 [info ] [Thread-1  ]: 1 of 21 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m17:34:46.989105 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m17:34:46.989105 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m17:34:46.989105 [info ] [Thread-1  ]: 4 of 21 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m17:34:47.003161 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m17:34:47.003958 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 17:34:46.989105 => 17:34:47.003958
[0m17:34:47.005065 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m17:34:47.006079 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m17:34:47.010750 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m17:34:47.017823 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m17:34:47.018590 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 17:34:47.006745 => 17:34:47.017823
[0m17:34:47.019602 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m17:34:47.021624 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m17:34:47.022989 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:34:47.022989 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:34:47.022989 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m17:34:47.050218 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m17:34:47.770975 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6140662c-e663-4035-9dbd-79862e2eabba&page=queryresults
[0m17:34:47.819028 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:35d7d6e1-6137-429b-943c-cdfb73df5f15&page=queryresults
[0m17:34:48.171434 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 17:34:47.019602 => 17:34:48.171434
[0m17:34:48.171434 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6F2F2E0>]}
[0m17:34:48.171434 [info ] [Thread-1  ]: 4 of 21 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m17:34:48.171434 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m17:34:48.171434 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m17:34:48.171434 [info ] [Thread-1  ]: 5 of 21 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m17:34:48.171434 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m17:34:48.171434 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m17:34:48.190479 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m17:34:48.193496 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 17:34:48.171434 => 17:34:48.192494
[0m17:34:48.193867 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m17:34:48.200074 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m17:34:48.203256 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:34:48.205618 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m17:34:48.233285 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 17:34:47.010750 => 17:34:48.233285
[0m17:34:48.233285 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6EC1940>]}
[0m17:34:48.234295 [info ] [Thread-2  ]: 3 of 21 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m17:34:48.235168 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m17:34:48.236306 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m17:34:48.236306 [info ] [Thread-2  ]: 6 of 21 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m17:34:48.237203 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_item_pedido)
[0m17:34:48.237203 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m17:34:48.239844 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m17:34:48.240981 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 17:34:48.237203 => 17:34:48.240981
[0m17:34:48.241928 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m17:34:48.243980 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m17:34:48.244944 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:34:48.246405 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m17:34:49.109655 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:37e556f3-c14c-4db2-a1d5-a88430a2b9df&page=queryresults
[0m17:34:49.173565 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2de80740-f821-4b74-8aeb-077e37941d48&page=queryresults
[0m17:34:49.464502 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 17:34:48.241928 => 17:34:49.464502
[0m17:34:49.464502 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6EC4C10>]}
[0m17:34:49.464502 [info ] [Thread-2  ]: 6 of 21 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m17:34:49.480578 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m17:34:49.480578 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m17:34:49.480578 [info ] [Thread-2  ]: 7 of 21 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m17:34:49.480578 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_meta_margem_preco)
[0m17:34:49.480578 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m17:34:49.498642 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m17:34:49.499705 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 17:34:49.480578 => 17:34:49.499705
[0m17:34:49.499705 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m17:34:49.505151 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m17:34:49.506214 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:34:49.507232 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m17:34:49.550270 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 17:34:48.194914 => 17:34:49.550270
[0m17:34:49.551273 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6EB9FD0>]}
[0m17:34:49.551273 [info ] [Thread-1  ]: 5 of 21 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.38s]
[0m17:34:49.552299 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m17:34:49.552299 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m17:34:49.553276 [info ] [Thread-1  ]: 8 of 21 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m17:34:49.553276 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_pedido)
[0m17:34:49.554262 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m17:34:49.556272 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m17:34:49.557274 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 17:34:49.554262 => 17:34:49.557274
[0m17:34:49.557274 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m17:34:49.559258 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m17:34:49.559258 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:34:49.559258 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m17:34:50.253759 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b4724a4e-27dc-48d1-8e31-ee8a25e57d2e&page=queryresults
[0m17:34:50.301623 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:72a3a3f4-b28b-44d7-83c3-c4cce7a2b7c7&page=queryresults
[0m17:34:50.628446 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 17:34:49.499705 => 17:34:50.628446
[0m17:34:50.630459 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6F77370>]}
[0m17:34:50.630459 [info ] [Thread-2  ]: 7 of 21 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m17:34:50.632469 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m17:34:50.634481 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m17:34:50.634481 [info ] [Thread-2  ]: 9 of 21 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m17:34:50.636492 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m17:34:50.636492 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m17:34:50.642274 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m17:34:50.645170 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 17:34:50.636492 => 17:34:50.644161
[0m17:34:50.645170 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m17:34:50.649649 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m17:34:50.650504 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:34:50.650504 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m17:34:50.699525 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 17:34:49.557274 => 17:34:50.699525
[0m17:34:50.699525 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6F83CD0>]}
[0m17:34:50.699525 [info ] [Thread-1  ]: 8 of 21 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m17:34:50.699525 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m17:34:50.699525 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m17:34:50.699525 [info ] [Thread-1  ]: 10 of 21 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m17:34:50.699525 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_tempo)
[0m17:34:50.699525 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m17:34:50.717813 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m17:34:50.719871 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 17:34:50.699525 => 17:34:50.718846
[0m17:34:50.720832 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m17:34:50.729334 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m17:34:50.729334 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:34:50.729334 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m17:34:51.363937 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3d3e9926-1334-47bd-8392-78e31b53cf7b&page=queryresults
[0m17:34:51.414439 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fdbc3e2a-b169-4bf9-abcc-a31cb1f178e0&page=queryresults
[0m17:34:51.764926 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 17:34:50.645669 => 17:34:51.764926
[0m17:34:51.780653 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6ECC220>]}
[0m17:34:51.780653 [info ] [Thread-2  ]: 9 of 21 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m17:34:51.780653 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m17:34:51.780653 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m17:34:51.780653 [info ] [Thread-2  ]: 11 of 21 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m17:34:51.780653 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m17:34:51.780653 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m17:34:51.801458 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m17:34:51.813887 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 17:34:50.721855 => 17:34:51.812947
[0m17:34:51.814569 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6ECC280>]}
[0m17:34:51.819982 [info ] [Thread-1  ]: 10 of 21 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m17:34:51.822364 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m17:34:51.822364 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 17:34:51.792187 => 17:34:51.822364
[0m17:34:51.827404 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m17:34:51.844574 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:34:52.519468 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m17:34:52.519468 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m17:34:53.231564 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d05c82ca-3714-4400-b8c5-2b3ab45c1c8d&page=queryresults
[0m17:34:56.059857 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 17:34:51.827404 => 17:34:56.059857
[0m17:34:56.059857 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6EC4910>]}
[0m17:34:56.059857 [info ] [Thread-2  ]: 11 of 21 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (352.0 rows, 1.4 MiB processed)[0m in 4.28s]
[0m17:34:56.059857 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m17:34:56.069801 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m17:34:56.069801 [info ] [Thread-1  ]: 12 of 21 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m17:34:56.069801 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m17:34:56.069801 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m17:34:56.084642 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m17:34:56.084642 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 17:34:56.069801 => 17:34:56.084642
[0m17:34:56.084642 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m17:34:56.089884 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:34:56.724655 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m17:34:56.734168 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m17:34:57.433872 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d584057e-2df4-4df7-9d8f-807b77a43a73&page=queryresults
[0m17:34:59.652015 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 17:34:56.084642 => 17:34:59.652015
[0m17:34:59.652015 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6FB6AF0>]}
[0m17:34:59.652015 [info ] [Thread-1  ]: 12 of 21 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (352.0 rows, 1.9 MiB processed)[0m in 3.58s]
[0m17:34:59.652015 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m17:34:59.652015 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m17:34:59.652015 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m17:34:59.652015 [info ] [Thread-2  ]: 13 of 21 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m17:34:59.652015 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m17:34:59.652015 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m17:34:59.652015 [info ] [Thread-1  ]: 14 of 21 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m17:34:59.671037 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m17:34:59.674454 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m17:34:59.692367 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m17:34:59.714058 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m17:34:59.717022 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 17:34:59.677285 => 17:34:59.716030
[0m17:34:59.719004 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m17:34:59.723773 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:34:59.746031 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 17:34:59.652015 => 17:34:59.746031
[0m17:34:59.746031 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m17:34:59.748224 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:35:00.393929 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m17:35:00.395951 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m17:35:00.419238 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m17:35:00.419238 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m17:35:00.770728 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:db5494e3-acb5-4aa0-93ad-cf94d793fb72&page=queryresults
[0m17:35:00.996256 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fa84392a-a9a1-4ae4-9d2f-f87844ac1b9f&page=queryresults
[0m17:35:02.689378 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 17:34:59.720000 => 17:35:02.689378
[0m17:35:02.689378 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED70801C0>]}
[0m17:35:02.689378 [info ] [Thread-1  ]: 14 of 21 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (352.0 rows, 83.7 KiB processed)[0m in 3.02s]
[0m17:35:02.705328 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m17:35:02.705328 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m17:35:02.705328 [info ] [Thread-1  ]: 15 of 21 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ........... [RUN]
[0m17:35:02.705328 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_hist_preco_custo_produto)
[0m17:35:02.705328 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m17:35:02.705328 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m17:35:02.721229 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 17:35:02.705328 => 17:35:02.721229
[0m17:35:02.722400 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m17:35:02.723791 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:35:02.929342 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 17:34:59.746031 => 17:35:02.929342
[0m17:35:02.929342 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6FA6DC0>]}
[0m17:35:02.929342 [info ] [Thread-2  ]: 13 of 21 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.5 KiB processed)[0m in 3.28s]
[0m17:35:02.929342 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m17:35:02.929342 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m17:35:02.929342 [info ] [Thread-2  ]: 16 of 21 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m17:35:02.945217 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_pedido)
[0m17:35:02.945217 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m17:35:02.945217 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m17:35:02.945217 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 17:35:02.945217 => 17:35:02.945217
[0m17:35:02.945217 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m17:35:02.971756 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:35:03.399037 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m17:35:03.399037 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m17:35:03.668464 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m17:35:03.668464 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m17:35:03.876801 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:50fd2d80-83d5-49c7-a225-027716dd8017&page=queryresults
[0m17:35:04.406374 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a0c8ed1e-28f3-45ca-b494-0f0908524e10&page=queryresults
[0m17:35:06.110363 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 17:35:02.722400 => 17:35:06.110363
[0m17:35:06.112374 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED5B7BBB0>]}
[0m17:35:06.114383 [info ] [Thread-1  ]: 15 of 21 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ...... [[32mCREATE TABLE (366.0 rows, 53.8 KiB processed)[0m in 3.41s]
[0m17:35:06.116394 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m17:35:06.116394 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m17:35:06.116394 [info ] [Thread-1  ]: 17 of 21 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m17:35:06.118404 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_hist_preco_custo_produto, now model.shibaribrasil.tb_preco_produto)
[0m17:35:06.118404 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m17:35:06.125677 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m17:35:06.127124 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 17:35:06.120416 => 17:35:06.127124
[0m17:35:06.127124 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m17:35:06.131744 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:35:06.832413 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m17:35:06.848204 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m17:35:07.200232 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 17:35:02.945217 => 17:35:07.200232
[0m17:35:07.202241 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6F08340>]}
[0m17:35:07.204260 [info ] [Thread-2  ]: 16 of 21 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 4.27s]
[0m17:35:07.206283 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m17:35:07.206283 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m17:35:07.208303 [info ] [Thread-2  ]: 18 of 21 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m17:35:07.210321 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m17:35:07.210321 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m17:35:07.221133 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m17:35:07.224089 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 17:35:07.212343 => 17:35:07.223129
[0m17:35:07.225098 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m17:35:07.229147 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:35:07.519542 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2134b79c-496f-470b-9695-a14d04979a72&page=queryresults
[0m17:35:07.988991 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m17:35:07.988991 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m17:35:08.325769 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:22f34dcd-86f5-4aa4-8cf1-293e9afb27d3&page=queryresults
[0m17:35:10.276920 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 17:35:06.128243 => 17:35:10.276920
[0m17:35:10.276920 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6F938E0>]}
[0m17:35:10.276920 [info ] [Thread-1  ]: 17 of 21 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (271.0 rows, 83.0 KiB processed)[0m in 4.16s]
[0m17:35:10.276920 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m17:35:10.546033 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 17:35:07.226138 => 17:35:10.546033
[0m17:35:10.546033 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED5EB4640>]}
[0m17:35:10.546033 [info ] [Thread-2  ]: 18 of 21 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 414.5 KiB processed)[0m in 3.34s]
[0m17:35:10.546033 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m17:35:10.546033 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m17:35:10.546033 [info ] [Thread-1  ]: 19 of 21 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m17:35:10.562097 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m17:35:10.563687 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m17:35:10.573527 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m17:35:10.575362 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 17:35:10.563687 => 17:35:10.575362
[0m17:35:10.576636 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m17:35:10.581385 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:35:11.246574 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m17:35:11.246574 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m17:35:11.681943 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:60b7566b-241d-4e1c-8c99-48ce199258cf&page=queryresults
[0m17:35:13.916810 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 17:35:10.576636 => 17:35:13.916810
[0m17:35:13.916810 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6F08340>]}
[0m17:35:13.916810 [info ] [Thread-1  ]: 19 of 21 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 287.3 KiB processed)[0m in 3.37s]
[0m17:35:13.916810 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m17:35:13.916810 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m17:35:13.916810 [info ] [Thread-2  ]: 20 of 21 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m17:35:13.916810 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m17:35:13.916810 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m17:35:13.938586 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m17:35:13.938586 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 17:35:13.916810 => 17:35:13.938586
[0m17:35:13.938586 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m17:35:13.952066 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:35:14.572436 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m17:35:14.572436 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m17:35:14.942373 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5238bf8d-73ef-4a79-9d15-335ae527b77b&page=queryresults
[0m17:35:18.062042 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 17:35:13.938586 => 17:35:18.062042
[0m17:35:18.062042 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6EBFDF0>]}
[0m17:35:18.062042 [info ] [Thread-2  ]: 20 of 21 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 123.2 KiB processed)[0m in 4.15s]
[0m17:35:18.062042 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m17:35:18.062042 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m17:35:18.077974 [info ] [Thread-1  ]: 21 of 21 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m17:35:18.077974 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_estoque_produto_base)
[0m17:35:18.077974 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m17:35:18.077974 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m17:35:18.077974 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 17:35:18.077974 => 17:35:18.077974
[0m17:35:18.077974 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m17:35:18.096408 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:35:18.755086 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m17:35:18.755086 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m17:35:19.446477 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5f0f6359-9020-4c64-8d23-ff08a6074af5&page=queryresults
[0m17:35:22.797794 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 17:35:18.077974 => 17:35:22.796784
[0m17:35:22.799287 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff1517a5-f00a-4578-a80a-539f5cd071fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED6F08340>]}
[0m17:35:22.801336 [info ] [Thread-1  ]: 21 of 21 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.2 MiB processed)[0m in 4.72s]
[0m17:35:22.803284 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m17:35:22.808931 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:35:22.810225 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:35:22.810846 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:35:22.812009 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m17:35:22.812009 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:35:22.812830 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m17:35:22.813383 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m17:35:22.814537 [info ] [MainThread]: 
[0m17:35:22.815477 [info ] [MainThread]: Finished running 10 view models, 11 table models in 0 hours 0 minutes and 40.17 seconds (40.17s).
[0m17:35:22.830580 [debug] [MainThread]: Command end result
[0m17:35:22.859459 [info ] [MainThread]: 
[0m17:35:22.859459 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:35:22.868678 [info ] [MainThread]: 
[0m17:35:22.869701 [info ] [MainThread]: Done. PASS=21 WARN=0 ERROR=0 SKIP=0 TOTAL=21
[0m17:35:22.871698 [debug] [MainThread]: Command `dbt run` succeeded at 17:35:22.870693 after 40.94 seconds
[0m17:35:22.871698 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED24A1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED5B2B430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AED5AC9550>]}
[0m17:35:22.871698 [debug] [MainThread]: Flushing usage events
[0m18:00:06.469921 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022757FD3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022756F58640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022756F58AC0>]}


============================== 18:00:06.469921 | 0b2d5d57-9527-4a29-a93c-d90bb62e0468 ==============================
[0m18:00:06.469921 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:00:06.469921 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:00:07.662474 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022756F47910>]}
[0m18:00:07.726450 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275B6412B0>]}
[0m18:00:07.726450 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:00:07.742134 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:00:07.837772 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:00:07.837772 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:00:07.837772 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275B915FA0>]}
[0m18:00:07.853904 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275B8FAAF0>]}
[0m18:00:07.853904 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:00:07.853904 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275B8FAF70>]}
[0m18:00:07.853904 [info ] [MainThread]: 
[0m18:00:07.853904 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:00:07.853904 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:00:07.853904 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:00:07.853904 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:07.853904 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:08.866723 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:00:09.722507 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m18:00:09.722507 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:09.722507 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m18:00:09.722507 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:10.948482 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m18:00:10.948482 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:00:10.948482 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m18:00:10.964583 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:00:11.652924 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275B68DE20>]}
[0m18:00:11.668965 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:00:11.668965 [info ] [MainThread]: 
[0m18:00:11.668965 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m18:00:11.684918 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m18:00:11.684918 [info ] [Thread-1  ]: 1 of 20 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m18:00:11.687054 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m18:00:11.687054 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m18:00:11.687054 [info ] [Thread-2  ]: 2 of 20 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m18:00:11.700712 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m18:00:11.700712 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m18:00:11.700712 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m18:00:11.700712 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 18:00:11.687054 => 18:00:11.700712
[0m18:00:11.700712 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m18:00:11.770429 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m18:00:11.794693 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m18:00:11.798234 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 18:00:11.700712 => 18:00:11.796217
[0m18:00:11.798234 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m18:00:11.798234 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m18:00:11.798234 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:00:11.804824 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m18:00:11.859826 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m18:00:11.859826 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m18:00:12.783108 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0cdff3b9-0cff-4cd9-b828-4fde12cd1c2f&page=queryresults
[0m18:00:12.894844 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8c213fdf-8a7d-43cd-a3ec-030968ee3e74&page=queryresults
[0m18:00:13.262761 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 18:00:11.798234 => 18:00:13.262761
[0m18:00:13.262761 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275C9F9100>]}
[0m18:00:13.262761 [info ] [Thread-2  ]: 2 of 20 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.56s]
[0m18:00:13.269812 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m18:00:13.269812 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m18:00:13.269812 [info ] [Thread-2  ]: 3 of 20 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m18:00:13.271823 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m18:00:13.271823 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m18:00:13.277863 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m18:00:13.278872 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 18:00:13.271823 => 18:00:13.278872
[0m18:00:13.280887 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m18:00:13.282897 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m18:00:13.284906 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:13.286917 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m18:00:13.342067 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 18:00:11.716656 => 18:00:13.342067
[0m18:00:13.342067 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275C9E6B20>]}
[0m18:00:13.342067 [info ] [Thread-1  ]: 1 of 20 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.66s]
[0m18:00:13.342067 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m18:00:13.342067 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m18:00:13.342067 [info ] [Thread-1  ]: 4 of 20 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m18:00:13.342067 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m18:00:13.342067 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m18:00:13.358033 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m18:00:13.358033 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 18:00:13.342067 => 18:00:13.358033
[0m18:00:13.358033 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m18:00:13.388726 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m18:00:13.392752 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:13.396782 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m18:00:14.092917 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:005b3362-4aea-499b-a223-b7eafcca2771&page=queryresults
[0m18:00:14.140583 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7fdebeb9-5361-4465-a63b-064ac0b598da&page=queryresults
[0m18:00:14.492462 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 18:00:13.280887 => 18:00:14.492462
[0m18:00:14.492462 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275CA44D90>]}
[0m18:00:14.492462 [info ] [Thread-2  ]: 3 of 20 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m18:00:14.492462 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m18:00:14.492462 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m18:00:14.492462 [info ] [Thread-2  ]: 5 of 20 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m18:00:14.492462 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m18:00:14.492462 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m18:00:14.508312 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m18:00:14.508312 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 18:00:14.492462 => 18:00:14.508312
[0m18:00:14.508312 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m18:00:14.508312 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m18:00:14.508312 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:14.524393 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m18:00:14.556324 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 18:00:13.358033 => 18:00:14.556324
[0m18:00:14.556324 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275CA440D0>]}
[0m18:00:14.556324 [info ] [Thread-1  ]: 4 of 20 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m18:00:14.572549 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m18:00:14.572549 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m18:00:14.572549 [info ] [Thread-1  ]: 6 of 20 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m18:00:14.572549 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m18:00:14.572549 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m18:00:14.572549 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m18:00:14.572549 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 18:00:14.572549 => 18:00:14.572549
[0m18:00:14.572549 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m18:00:14.572549 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m18:00:14.572549 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:14.588330 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m18:00:15.327398 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ce137be4-fdcf-4e14-a5c5-782fd4c16a54&page=queryresults
[0m18:00:15.721341 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 18:00:14.508312 => 18:00:15.721341
[0m18:00:15.721341 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275CA4FB20>]}
[0m18:00:15.721341 [info ] [Thread-2  ]: 5 of 20 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m18:00:15.721341 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m18:00:15.721341 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m18:00:15.721341 [info ] [Thread-2  ]: 7 of 20 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m18:00:15.721341 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m18:00:15.721341 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m18:00:15.737265 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m18:00:15.737265 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 18:00:15.721341 => 18:00:15.737265
[0m18:00:15.737265 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m18:00:15.753273 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bcf3bcf4-62d3-4a5c-8e5f-4e5d63fb0db4&page=queryresults
[0m18:00:15.765106 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m18:00:15.768655 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:15.774409 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m18:00:16.201488 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 18:00:14.572549 => 18:00:16.201488
[0m18:00:16.201488 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275C9D71C0>]}
[0m18:00:16.201488 [info ] [Thread-1  ]: 6 of 20 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.63s]
[0m18:00:16.201488 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m18:00:16.217450 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m18:00:16.217450 [info ] [Thread-1  ]: 8 of 20 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m18:00:16.217450 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m18:00:16.217450 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m18:00:16.217450 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m18:00:16.217450 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 18:00:16.217450 => 18:00:16.217450
[0m18:00:16.217450 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m18:00:16.233526 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m18:00:16.233526 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:16.233526 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m18:00:16.808418 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fe8fa6dd-2c54-48d3-b1e1-69ce0c846dad&page=queryresults
[0m18:00:17.145144 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b1052819-83fe-4e35-a077-e2f17c317bfc&page=queryresults
[0m18:00:17.209520 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 18:00:15.737265 => 18:00:17.209520
[0m18:00:17.209520 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275B9CF9A0>]}
[0m18:00:17.209520 [info ] [Thread-2  ]: 7 of 20 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.49s]
[0m18:00:17.209520 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m18:00:17.225600 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m18:00:17.225600 [info ] [Thread-2  ]: 9 of 20 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m18:00:17.225600 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m18:00:17.225600 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m18:00:17.225600 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m18:00:17.225600 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 18:00:17.225600 => 18:00:17.225600
[0m18:00:17.225600 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m18:00:17.241492 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m18:00:17.241492 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:17.241492 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m18:00:17.560488 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 18:00:16.233526 => 18:00:17.560488
[0m18:00:17.560488 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275C9B2460>]}
[0m18:00:17.560488 [info ] [Thread-1  ]: 8 of 20 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m18:00:17.576544 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m18:00:17.576544 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m18:00:17.576544 [info ] [Thread-1  ]: 10 of 20 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m18:00:17.576544 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_tempo)
[0m18:00:17.576544 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m18:00:17.576544 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m18:00:17.592303 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 18:00:17.576544 => 18:00:17.576544
[0m18:00:17.592303 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m18:00:17.592303 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m18:00:17.592303 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:17.592303 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m18:00:17.992728 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ef390798-b0bf-4d5e-ab7b-877351e57fb5&page=queryresults
[0m18:00:18.368732 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b492bf16-a65d-4825-a883-c117197f764a&page=queryresults
[0m18:00:18.424274 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 18:00:17.225600 => 18:00:18.424274
[0m18:00:18.426283 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275CA58040>]}
[0m18:00:18.428294 [info ] [Thread-2  ]: 9 of 20 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m18:00:18.430305 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m18:00:18.432316 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m18:00:18.432316 [info ] [Thread-2  ]: 11 of 20 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m18:00:18.434324 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m18:00:18.436333 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m18:00:18.442109 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m18:00:18.444118 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 18:00:18.436333 => 18:00:18.444118
[0m18:00:18.446129 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m18:00:18.461980 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:18.764098 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 18:00:17.592303 => 18:00:18.762078
[0m18:00:18.766116 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275CA8B6A0>]}
[0m18:00:18.766116 [info ] [Thread-1  ]: 10 of 20 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m18:00:18.770147 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m18:00:19.155646 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m18:00:19.155646 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m18:00:19.825358 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9baf6fc1-8fcd-4677-9b1b-61e118a8ab7a&page=queryresults
[0m18:00:25.165720 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 18:00:18.446129 => 18:00:25.165720
[0m18:00:25.165720 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275CAF71F0>]}
[0m18:00:25.165720 [info ] [Thread-2  ]: 11 of 20 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (352.0 rows, 1.4 MiB processed)[0m in 6.73s]
[0m18:00:25.165720 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m18:00:25.181513 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m18:00:25.181513 [info ] [Thread-1  ]: 12 of 20 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m18:00:25.181513 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m18:00:25.186551 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m18:00:25.192593 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m18:00:25.194608 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 18:00:25.186551 => 18:00:25.194608
[0m18:00:25.194608 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m18:00:25.199657 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:25.853985 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m18:00:25.853985 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m18:00:26.559016 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c3e0da1b-c843-410d-8f30-62c48974a719&page=queryresults
[0m18:00:28.784316 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 18:00:25.196624 => 18:00:28.782306
[0m18:00:28.784316 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275B9CF310>]}
[0m18:00:28.786326 [info ] [Thread-1  ]: 12 of 20 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (352.0 rows, 1.9 MiB processed)[0m in 3.60s]
[0m18:00:28.788341 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m18:00:28.790095 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m18:00:28.790095 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m18:00:28.790095 [info ] [Thread-2  ]: 13 of 20 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m18:00:28.790095 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m18:00:28.790095 [info ] [Thread-1  ]: 14 of 20 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m18:00:28.790095 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m18:00:28.790095 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m18:00:28.790095 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m18:00:28.790095 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m18:00:28.790095 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 18:00:28.790095 => 18:00:28.790095
[0m18:00:28.814474 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m18:00:28.816491 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m18:00:28.823556 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:28.837518 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 18:00:28.790095 => 18:00:28.837518
[0m18:00:28.837518 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m18:00:28.853667 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:29.523682 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m18:00:29.539385 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m18:00:29.577685 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m18:00:29.579703 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m18:00:29.954824 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:167efd98-4cd8-430f-9c6c-d09c2371df83&page=queryresults
[0m18:00:30.162522 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:04b3b558-dbb1-452d-8a4b-b4c8521c849b&page=queryresults
[0m18:00:31.915181 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 18:00:28.837518 => 18:00:31.913158
[0m18:00:31.917201 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275CB4F880>]}
[0m18:00:31.917201 [info ] [Thread-1  ]: 14 of 20 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (352.0 rows, 83.7 KiB processed)[0m in 3.13s]
[0m18:00:31.921476 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m18:00:31.921476 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m18:00:31.921476 [info ] [Thread-1  ]: 15 of 20 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m18:00:31.921476 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_pedido)
[0m18:00:31.921476 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m18:00:31.937222 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m18:00:31.937222 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 18:00:31.921476 => 18:00:31.937222
[0m18:00:31.937222 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m18:00:31.947459 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:32.442457 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 18:00:28.818508 => 18:00:32.440442
[0m18:00:32.444471 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275CB4FCA0>]}
[0m18:00:32.444471 [info ] [Thread-2  ]: 13 of 20 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.5 KiB processed)[0m in 3.65s]
[0m18:00:32.446229 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m18:00:32.448244 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m18:00:32.450258 [info ] [Thread-2  ]: 16 of 20 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m18:00:32.452272 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_preco_produto)
[0m18:00:32.454290 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m18:00:32.462121 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m18:00:32.465103 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 18:00:32.454290 => 18:00:32.465103
[0m18:00:32.465103 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m18:00:32.465103 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:32.589493 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m18:00:32.589493 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m18:00:33.131879 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m18:00:33.131879 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m18:00:33.212118 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d3cf7115-537c-4d36-a926-0ec42bb743de&page=queryresults
[0m18:00:33.753065 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3616f813-3390-48c9-bbe1-cd31511ca6f6&page=queryresults
[0m18:00:36.309773 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 18:00:31.937222 => 18:00:36.309773
[0m18:00:36.325585 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275CA4F460>]}
[0m18:00:36.325585 [info ] [Thread-1  ]: 15 of 20 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 4.39s]
[0m18:00:36.325585 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m18:00:36.325585 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m18:00:36.325585 [info ] [Thread-1  ]: 17 of 20 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m18:00:36.325585 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m18:00:36.325585 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m18:00:36.341529 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m18:00:36.341529 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 18:00:36.325585 => 18:00:36.341529
[0m18:00:36.352671 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m18:00:36.357736 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:36.902777 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 18:00:32.465103 => 18:00:36.902777
[0m18:00:36.918863 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275CAF2A30>]}
[0m18:00:36.921594 [info ] [Thread-2  ]: 16 of 20 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (271.0 rows, 83.0 KiB processed)[0m in 4.47s]
[0m18:00:36.923617 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m18:00:37.076954 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m18:00:37.076954 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m18:00:37.435769 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1ee0c026-d499-4798-a835-b2c94bfb8bce&page=queryresults
[0m18:00:40.013285 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 18:00:36.352671 => 18:00:40.013285
[0m18:00:40.015304 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275CA4CD00>]}
[0m18:00:40.017325 [info ] [Thread-1  ]: 17 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 414.5 KiB processed)[0m in 3.69s]
[0m18:00:40.019344 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m18:00:40.021363 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m18:00:40.023382 [info ] [Thread-2  ]: 18 of 20 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m18:00:40.025399 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m18:00:40.027413 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m18:00:40.032733 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m18:00:40.034744 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 18:00:40.027413 => 18:00:40.034744
[0m18:00:40.034744 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m18:00:40.038764 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:40.781262 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m18:00:40.797282 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m18:00:41.227240 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2f1dc9ab-3c14-4ee0-8c7c-8a549ca6402f&page=queryresults
[0m18:00:44.330511 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 18:00:40.036755 => 18:00:44.330511
[0m18:00:44.330511 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275CA92970>]}
[0m18:00:44.337660 [info ] [Thread-2  ]: 18 of 20 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 287.3 KiB processed)[0m in 4.31s]
[0m18:00:44.339669 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m18:00:44.341682 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m18:00:44.343697 [info ] [Thread-1  ]: 19 of 20 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m18:00:44.345715 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m18:00:44.345715 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m18:00:44.359924 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m18:00:44.361687 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 18:00:44.348491 => 18:00:44.361687
[0m18:00:44.361687 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m18:00:44.377284 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:45.027772 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m18:00:45.027772 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m18:00:45.409898 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:78535a65-70a8-4738-bca9-91b99e764ac4&page=queryresults
[0m18:00:48.487299 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 18:00:44.361687 => 18:00:48.487299
[0m18:00:48.489319 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275DB595E0>]}
[0m18:00:48.489319 [info ] [Thread-1  ]: 19 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 123.2 KiB processed)[0m in 4.15s]
[0m18:00:48.491328 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m18:00:48.491328 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m18:00:48.493342 [info ] [Thread-2  ]: 20 of 20 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m18:00:48.495360 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_estoque_produto_base)
[0m18:00:48.495360 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m18:00:48.506541 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m18:00:48.508566 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 18:00:48.497377 => 18:00:48.508566
[0m18:00:48.510582 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m18:00:48.514626 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:49.203714 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m18:00:49.219522 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m18:00:49.793770 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1b81bd5e-594b-4475-8796-06c8263908c4&page=queryresults
[0m18:00:53.172534 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 18:00:48.510582 => 18:00:53.172534
[0m18:00:53.172534 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b2d5d57-9527-4a29-a93c-d90bb62e0468', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275DB9C4C0>]}
[0m18:00:53.172534 [info ] [Thread-2  ]: 20 of 20 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.2 MiB processed)[0m in 4.68s]
[0m18:00:53.172534 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m18:00:53.172534 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:00:53.172534 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:00:53.188701 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:00:53.188701 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m18:00:53.188701 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:00:53.188701 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m18:00:53.188701 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m18:00:53.188701 [info ] [MainThread]: 
[0m18:00:53.188701 [info ] [MainThread]: Finished running 10 view models, 10 table models in 0 hours 0 minutes and 45.33 seconds (45.33s).
[0m18:00:53.204505 [debug] [MainThread]: Command end result
[0m18:00:53.220674 [info ] [MainThread]: 
[0m18:00:53.220674 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:00:53.220674 [info ] [MainThread]: 
[0m18:00:53.220674 [info ] [MainThread]: Done. PASS=20 WARN=0 ERROR=0 SKIP=0 TOTAL=20
[0m18:00:53.220674 [debug] [MainThread]: Command `dbt run` succeeded at 18:00:53.220674 after 46.89 seconds
[0m18:00:53.220674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022757FD3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275B69E730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002275B848040>]}
[0m18:00:53.220674 [debug] [MainThread]: Flushing usage events
[0m18:00:59.188152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFCD8434C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFCC7B02E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFCC7B0760>]}


============================== 18:00:59.203932 | dd3defba-98d3-405e-b6be-61721619a8e3 ==============================
[0m18:00:59.203932 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:00:59.203932 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m18:01:00.273674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dd3defba-98d3-405e-b6be-61721619a8e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFD0E9E520>]}
[0m18:01:00.321695 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dd3defba-98d3-405e-b6be-61721619a8e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFD0EA4C40>]}
[0m18:01:00.321695 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:01:00.337656 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:01:00.468265 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:01:00.470277 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:01:00.475817 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dd3defba-98d3-405e-b6be-61721619a8e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFD1186850>]}
[0m18:01:00.495718 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dd3defba-98d3-405e-b6be-61721619a8e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFD1178490>]}
[0m18:01:00.497728 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:01:00.497728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dd3defba-98d3-405e-b6be-61721619a8e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFD1178310>]}
[0m18:01:00.497728 [info ] [MainThread]: 
[0m18:01:00.497728 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:01:00.497728 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:01:00.497728 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:01.197308 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m18:01:01.197308 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:01.197308 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m18:01:01.197308 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:01.899958 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m18:01:01.908035 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:01:01.963364 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m18:01:01.963364 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:01:02.636555 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dd3defba-98d3-405e-b6be-61721619a8e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFD11BDA90>]}
[0m18:01:02.636555 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:01:02.636555 [info ] [MainThread]: 
[0m18:01:02.649568 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m18:01:02.653681 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m18:01:02.653681 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m18:01:02.653681 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m18:01:02.665686 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 18:01:02.653681 => 18:01:02.665686
[0m18:01:02.681220 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m18:01:02.790394 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:01:02.792145 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m18:01:03.701853 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:adf9fcf7-dd53-475f-8854-d4749396a818&page=queryresults
[0m18:01:04.848350 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m18:01:05.357539 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b60efc87-9f87-4cd9-94ce-1e0001e85a21&page=queryresults
[0m18:01:07.678835 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m18:01:08.475934 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m18:01:08.479968 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m18:01:08.845574 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7bd4791b-c7eb-4d88-84a4-16856c3b9596&page=queryresults
[0m18:01:11.114772 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 18:01:02.681220 => 18:01:11.114772
[0m18:01:11.116794 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd3defba-98d3-405e-b6be-61721619a8e3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFD0E05040>]}
[0m18:01:11.116794 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (51.0 rows, 76.6 KiB processed)[0m in 8.46s]
[0m18:01:11.118813 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m18:01:11.120829 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:01:11.120829 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:01:11.120829 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:01:11.120829 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m18:01:11.122589 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m18:01:11.122589 [info ] [MainThread]: 
[0m18:01:11.122589 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.62 seconds (10.62s).
[0m18:01:11.124601 [debug] [MainThread]: Command end result
[0m18:01:11.134672 [info ] [MainThread]: 
[0m18:01:11.136679 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:01:11.136679 [info ] [MainThread]: 
[0m18:01:11.136679 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:01:11.138428 [debug] [MainThread]: Command `dbt snapshot` succeeded at 18:01:11.138428 after 12.06 seconds
[0m18:01:11.138428 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFCD8434C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFD0EFC520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFD0F6FE80>]}
[0m18:01:11.138428 [debug] [MainThread]: Flushing usage events
[0m18:01:16.110158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFEF19B400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFEE12F910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFEE12FB80>]}


============================== 18:01:16.120239 | 278bb6ea-4f06-4493-87ae-d26048b1b8b3 ==============================
[0m18:01:16.120239 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:01:16.120239 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select tag:snaps', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:01:17.541784 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '278bb6ea-4f06-4493-87ae-d26048b1b8b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFEE10E8E0>]}
[0m18:01:17.637546 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '278bb6ea-4f06-4493-87ae-d26048b1b8b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF2726E20>]}
[0m18:01:17.637546 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:01:17.725039 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:01:21.746002 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:01:21.746002 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:01:21.746002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '278bb6ea-4f06-4493-87ae-d26048b1b8b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF2AE5E20>]}
[0m18:01:22.066211 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '278bb6ea-4f06-4493-87ae-d26048b1b8b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF2AD7A60>]}
[0m18:01:22.066211 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:01:22.082476 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '278bb6ea-4f06-4493-87ae-d26048b1b8b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF2AD78E0>]}
[0m18:01:22.082476 [info ] [MainThread]: 
[0m18:01:22.082476 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:01:22.082476 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:01:22.098572 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:22.845608 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m18:01:22.847621 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:22.847621 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m18:01:22.847621 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:23.672980 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m18:01:23.680802 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:01:23.724208 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m18:01:23.724208 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:01:24.512073 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '278bb6ea-4f06-4493-87ae-d26048b1b8b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF2AE5E80>]}
[0m18:01:24.514089 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:01:24.516110 [info ] [MainThread]: 
[0m18:01:24.526213 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m18:01:24.527986 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m18:01:24.530008 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m18:01:24.530008 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m18:01:24.549827 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m18:01:24.551837 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 18:01:24.530008 => 18:01:24.551837
[0m18:01:24.551837 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m18:01:24.574950 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:01:25.260673 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m18:01:25.260673 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m18:01:25.579392 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:eb750b91-034b-433f-af0f-4cdb6a13b630&page=queryresults
[0m18:01:27.533468 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 18:01:24.553846 => 18:01:27.533468
[0m18:01:27.533468 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '278bb6ea-4f06-4493-87ae-d26048b1b8b3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF3B900D0>]}
[0m18:01:27.533468 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (388.0 rows, 58.1 KiB processed)[0m in 3.00s]
[0m18:01:27.533468 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m18:01:27.533468 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:01:27.533468 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:01:27.533468 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m18:01:27.533468 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m18:01:27.533468 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m18:01:27.533468 [info ] [MainThread]: 
[0m18:01:27.533468 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.45 seconds (5.45s).
[0m18:01:27.533468 [debug] [MainThread]: Command end result
[0m18:01:27.549625 [info ] [MainThread]: 
[0m18:01:27.549625 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:01:27.549625 [info ] [MainThread]: 
[0m18:01:27.549625 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:01:27.549625 [debug] [MainThread]: Command `dbt run` succeeded at 18:01:27.549625 after 11.54 seconds
[0m18:01:27.549625 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFEF19B400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF28AC6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DFF27F3D90>]}
[0m18:01:27.549625 [debug] [MainThread]: Flushing usage events
[0m19:00:13.797650 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDBB32460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDAABF9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDAABFD30>]}


============================== 19:00:13.813497 | 6df3fc49-c636-4211-83b5-0e6a1381c1c8 ==============================
[0m19:00:13.813497 [info ] [MainThread]: Running with dbt=1.7.4
[0m19:00:13.813497 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --exclude tag:snaps', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:00:15.513895 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDAAA3B20>]}
[0m19:00:15.562262 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDF0867F0>]}
[0m19:00:15.562262 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m19:00:15.578222 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m19:00:15.642409 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m19:00:15.642409 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m19:00:15.642409 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDF476F10>]}
[0m19:00:15.658232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDF46A070>]}
[0m19:00:15.658232 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m19:00:15.658232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDF46A0A0>]}
[0m19:00:15.658232 [info ] [MainThread]: 
[0m19:00:15.658232 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m19:00:15.658232 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:00:15.658232 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:15.658232 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:00:15.674136 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:16.558038 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:00:17.281358 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m19:00:17.281358 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m19:00:17.281358 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:17.281358 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:17.943319 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m19:00:17.943319 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:00:17.987044 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m19:00:17.987044 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:00:18.791295 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDF4BDC70>]}
[0m19:00:18.791295 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:00:18.807058 [info ] [MainThread]: 
[0m19:00:18.807058 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m19:00:18.807058 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m19:00:18.807058 [info ] [Thread-1  ]: 1 of 20 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m19:00:18.807058 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m19:00:18.807058 [info ] [Thread-2  ]: 2 of 20 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m19:00:18.807058 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m19:00:18.807058 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m19:00:18.823011 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m19:00:18.823011 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m19:00:18.839109 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 19:00:18.807058 => 19:00:18.839109
[0m19:00:18.839109 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m19:00:18.839109 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m19:00:18.887046 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m19:00:18.887046 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 19:00:18.823011 => 19:00:18.887046
[0m19:00:18.887046 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m19:00:18.887046 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m19:00:18.887046 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m19:00:18.887046 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m19:00:18.887046 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m19:00:18.919316 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m19:00:19.705181 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:36577f01-649b-4f66-8e51-b6fc50e5ec73&page=queryresults
[0m19:00:19.769757 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4c9262c0-a6c5-4cc9-a97e-47c3ce7f3948&page=queryresults
[0m19:00:20.187844 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 19:00:18.839109 => 19:00:20.187844
[0m19:00:20.187844 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDF52FB20>]}
[0m19:00:20.187844 [info ] [Thread-1  ]: 1 of 20 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.38s]
[0m19:00:20.187844 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m19:00:20.187844 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m19:00:20.187844 [info ] [Thread-1  ]: 3 of 20 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m19:00:20.203967 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m19:00:20.203967 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m19:00:20.203967 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m19:00:20.203967 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 19:00:20.203967 => 19:00:20.203967
[0m19:00:20.203967 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m19:00:20.219763 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m19:00:20.219763 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:20.219763 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m19:00:20.251594 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 19:00:18.887046 => 19:00:20.251594
[0m19:00:20.251594 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE0581640>]}
[0m19:00:20.251594 [info ] [Thread-2  ]: 2 of 20 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m19:00:20.251594 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m19:00:20.251594 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m19:00:20.251594 [info ] [Thread-2  ]: 4 of 20 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m19:00:20.264371 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m19:00:20.264371 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m19:00:20.275326 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m19:00:20.277342 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 19:00:20.264371 => 19:00:20.277342
[0m19:00:20.279356 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m19:00:20.283133 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m19:00:20.283133 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:20.283133 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m19:00:20.994797 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b2a17de3-4d70-4b9b-8176-c2f4462f8f68&page=queryresults
[0m19:00:21.054302 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c0b9574f-e061-4c69-a16a-9d0b82dbf61c&page=queryresults
[0m19:00:21.400920 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 19:00:20.203967 => 19:00:21.398906
[0m19:00:21.400920 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE0581DC0>]}
[0m19:00:21.402933 [info ] [Thread-1  ]: 3 of 20 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m19:00:21.402933 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m19:00:21.404945 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m19:00:21.404945 [info ] [Thread-1  ]: 5 of 20 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m19:00:21.406457 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m19:00:21.406457 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m19:00:21.406457 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m19:00:21.406457 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 19:00:21.406457 => 19:00:21.406457
[0m19:00:21.406457 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m19:00:21.417280 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m19:00:21.417280 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:21.422358 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m19:00:21.464279 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 19:00:20.279356 => 19:00:21.464279
[0m19:00:21.464279 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE050D1F0>]}
[0m19:00:21.466288 [info ] [Thread-2  ]: 4 of 20 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m19:00:21.466288 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m19:00:21.466288 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m19:00:21.468298 [info ] [Thread-2  ]: 6 of 20 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m19:00:21.468298 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m19:00:21.470051 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m19:00:21.470051 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m19:00:21.470051 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 19:00:21.470051 => 19:00:21.470051
[0m19:00:21.470051 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m19:00:21.470051 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m19:00:21.470051 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:21.482658 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m19:00:22.161002 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9aec144c-9fc2-4cc6-9881-236de62b9b00&page=queryresults
[0m19:00:22.249296 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ad4b18e6-df49-411a-8da8-3f9213c5a551&page=queryresults
[0m19:00:22.548119 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 19:00:21.406457 => 19:00:22.548119
[0m19:00:22.550133 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDF52F490>]}
[0m19:00:22.552148 [info ] [Thread-1  ]: 5 of 20 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m19:00:22.552148 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m19:00:22.554161 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m19:00:22.554161 [info ] [Thread-1  ]: 7 of 20 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m19:00:22.556173 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m19:00:22.556173 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m19:00:22.563957 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m19:00:22.563957 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 19:00:22.556173 => 19:00:22.563957
[0m19:00:22.563957 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m19:00:22.575765 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m19:00:22.575765 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:22.575765 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m19:00:22.671866 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 19:00:21.470051 => 19:00:22.671866
[0m19:00:22.671866 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDF52F640>]}
[0m19:00:22.671866 [info ] [Thread-2  ]: 6 of 20 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m19:00:22.671866 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m19:00:22.671866 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m19:00:22.671866 [info ] [Thread-2  ]: 8 of 20 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m19:00:22.671866 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m19:00:22.671866 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m19:00:22.690051 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m19:00:22.692063 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 19:00:22.671866 => 19:00:22.690051
[0m19:00:22.692063 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m19:00:22.696090 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m19:00:22.698104 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:22.700308 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m19:00:23.374964 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5fd51c09-2f13-4504-87da-c94d814b0bbf&page=queryresults
[0m19:00:23.410976 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6c3a5127-e753-4ce7-9bba-60383f342f25&page=queryresults
[0m19:00:23.769625 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 19:00:22.563957 => 19:00:23.769625
[0m19:00:23.771637 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE050DF10>]}
[0m19:00:23.771637 [info ] [Thread-1  ]: 7 of 20 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m19:00:23.773649 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m19:00:23.773649 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m19:00:23.773649 [info ] [Thread-1  ]: 9 of 20 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m19:00:23.775659 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m19:00:23.775659 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m19:00:23.781691 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m19:00:23.783702 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 19:00:23.775659 => 19:00:23.783702
[0m19:00:23.783702 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m19:00:23.788852 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m19:00:23.789360 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:23.789360 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m19:00:23.797628 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 19:00:22.692063 => 19:00:23.797628
[0m19:00:23.836858 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDF52F640>]}
[0m19:00:23.836858 [info ] [Thread-2  ]: 8 of 20 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m19:00:23.840832 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m19:00:23.840832 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m19:00:23.840832 [info ] [Thread-2  ]: 10 of 20 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m19:00:23.840832 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_tempo)
[0m19:00:23.840832 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m19:00:23.840832 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m19:00:23.855361 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 19:00:23.840832 => 19:00:23.840832
[0m19:00:23.856339 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m19:00:23.858857 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m19:00:23.860869 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:23.862879 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m19:00:24.632904 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5fc83fab-38a8-4966-994c-6559593bbe70&page=queryresults
[0m19:00:24.775032 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ea551fef-2df2-4b64-b9f3-59452950a77b&page=queryresults
[0m19:00:24.998773 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 19:00:23.783702 => 19:00:24.998773
[0m19:00:25.000783 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE0663820>]}
[0m19:00:25.000783 [info ] [Thread-1  ]: 9 of 20 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m19:00:25.002795 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m19:00:25.002795 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m19:00:25.002795 [info ] [Thread-1  ]: 11 of 20 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m19:00:25.002795 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m19:00:25.002795 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m19:00:25.015524 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m19:00:25.021550 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 19:00:25.002795 => 19:00:25.021550
[0m19:00:25.023563 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m19:00:25.037302 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:25.203765 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 19:00:23.856847 => 19:00:25.203765
[0m19:00:25.203765 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDF52F610>]}
[0m19:00:25.203765 [info ] [Thread-2  ]: 10 of 20 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m19:00:25.203765 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m19:00:25.731474 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m19:00:25.731474 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m19:00:26.446147 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:41df8f50-42d5-4f0d-9310-d73e16893811&page=queryresults
[0m19:00:29.274675 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 19:00:25.023563 => 19:00:29.274675
[0m19:00:29.274675 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE05FA310>]}
[0m19:00:29.274675 [info ] [Thread-1  ]: 11 of 20 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (352.0 rows, 1.4 MiB processed)[0m in 4.27s]
[0m19:00:29.274675 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m19:00:29.274675 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m19:00:29.274675 [info ] [Thread-2  ]: 12 of 20 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m19:00:29.274675 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m19:00:29.274675 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m19:00:29.274675 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m19:00:29.274675 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 19:00:29.274675 => 19:00:29.274675
[0m19:00:29.274675 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m19:00:29.293038 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:29.947977 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m19:00:29.947977 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m19:00:30.637812 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8c4e5382-25ee-4a34-8546-593c2360ba76&page=queryresults
[0m19:00:32.872080 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 19:00:29.274675 => 19:00:32.872080
[0m19:00:32.872080 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE06BD580>]}
[0m19:00:32.872080 [info ] [Thread-2  ]: 12 of 20 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (352.0 rows, 1.9 MiB processed)[0m in 3.60s]
[0m19:00:32.872080 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m19:00:32.872080 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m19:00:32.872080 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m19:00:32.872080 [info ] [Thread-1  ]: 13 of 20 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m19:00:32.887366 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m19:00:32.887366 [info ] [Thread-2  ]: 14 of 20 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m19:00:32.887366 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m19:00:32.887366 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m19:00:32.887366 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m19:00:32.887366 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m19:00:32.903580 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m19:00:32.903580 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 19:00:32.887366 => 19:00:32.903580
[0m19:00:32.903580 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m19:00:32.903580 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:32.903580 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 19:00:32.887366 => 19:00:32.903580
[0m19:00:32.903580 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m19:00:32.951278 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:33.603286 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m19:00:33.610296 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m19:00:33.617438 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m19:00:33.624420 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m19:00:34.087188 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:012c51f0-ae0c-43d5-83c4-c645d929b542&page=queryresults
[0m19:00:34.185182 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4b47bba3-f2a7-41ce-81b0-e956c7c6bf81&page=queryresults
[0m19:00:36.068314 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 19:00:32.903580 => 19:00:36.067305
[0m19:00:36.069278 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE054AA60>]}
[0m19:00:36.071311 [info ] [Thread-2  ]: 14 of 20 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (352.0 rows, 83.7 KiB processed)[0m in 3.18s]
[0m19:00:36.073224 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m19:00:36.074221 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m19:00:36.075227 [info ] [Thread-2  ]: 15 of 20 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m19:00:36.076719 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_pedido)
[0m19:00:36.077726 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m19:00:36.084721 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m19:00:36.087258 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 19:00:36.077726 => 19:00:36.086131
[0m19:00:36.088254 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m19:00:36.091387 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:36.452159 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 19:00:32.903580 => 19:00:36.451164
[0m19:00:36.453155 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE068D6A0>]}
[0m19:00:36.453155 [info ] [Thread-1  ]: 13 of 20 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.5 KiB processed)[0m in 3.57s]
[0m19:00:36.455156 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m19:00:36.456150 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m19:00:36.457155 [info ] [Thread-1  ]: 16 of 20 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m19:00:36.459349 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_preco_produto)
[0m19:00:36.459349 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m19:00:36.471080 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m19:00:36.473530 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 19:00:36.460945 => 19:00:36.472506
[0m19:00:36.473530 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m19:00:36.475513 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:37.049945 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m19:00:37.052968 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m19:00:37.203901 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m19:00:37.205903 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m19:00:37.681967 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bfc70d11-d262-4615-8941-ee81663b22fa&page=queryresults
[0m19:00:37.911849 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7ee04d74-5937-4932-a045-cd4264352b94&page=queryresults
[0m19:00:40.194821 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 19:00:36.088254 => 19:00:40.193713
[0m19:00:40.195823 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE068DAC0>]}
[0m19:00:40.195823 [info ] [Thread-2  ]: 15 of 20 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.6k rows, 1.1 MiB processed)[0m in 4.12s]
[0m19:00:40.197827 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m19:00:40.198794 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m19:00:40.199823 [info ] [Thread-2  ]: 17 of 20 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m19:00:40.201716 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m19:00:40.201716 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m19:00:40.208073 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m19:00:40.210092 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 19:00:40.202715 => 19:00:40.209069
[0m19:00:40.211082 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m19:00:40.213070 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:40.711134 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 19:00:36.473530 => 19:00:40.710122
[0m19:00:40.712524 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE05CFD60>]}
[0m19:00:40.714658 [info ] [Thread-1  ]: 16 of 20 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (271.0 rows, 83.0 KiB processed)[0m in 4.25s]
[0m19:00:40.716663 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m19:00:40.840555 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m19:00:40.842569 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m19:00:41.265129 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:18c3f8f7-1090-4082-aa41-5f91c9c4e66b&page=queryresults
[0m19:00:43.531015 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 19:00:40.211082 => 19:00:43.531015
[0m19:00:43.533029 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE06D6340>]}
[0m19:00:43.533029 [info ] [Thread-2  ]: 17 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 414.5 KiB processed)[0m in 3.33s]
[0m19:00:43.537277 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m19:00:43.541317 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m19:00:43.543335 [info ] [Thread-1  ]: 18 of 20 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m19:00:43.545353 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m19:00:43.547372 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m19:00:43.555209 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m19:00:43.555209 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 19:00:43.549388 => 19:00:43.555209
[0m19:00:43.555209 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m19:00:43.568999 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:44.262789 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m19:00:44.262789 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m19:00:44.742151 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4df8dac9-ab1a-4f0e-82cb-57c02820fcd9&page=queryresults
[0m19:00:47.535153 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 19:00:43.568999 => 19:00:47.533138
[0m19:00:47.535153 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE1734250>]}
[0m19:00:47.537166 [info ] [Thread-1  ]: 18 of 20 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 287.3 KiB processed)[0m in 3.99s]
[0m19:00:47.537166 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m19:00:47.539182 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m19:00:47.540938 [info ] [Thread-2  ]: 19 of 20 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m19:00:47.540938 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m19:00:47.540938 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m19:00:47.551904 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m19:00:47.553918 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 19:00:47.543849 => 19:00:47.551904
[0m19:00:47.553918 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m19:00:47.556946 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:48.420949 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m19:00:48.422963 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m19:00:48.825681 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a6e4dad7-3f47-455d-a35d-f5db92c7cd01&page=queryresults
[0m19:00:51.317259 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 19:00:47.553918 => 19:00:51.317259
[0m19:00:51.317259 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE171B0D0>]}
[0m19:00:51.317259 [info ] [Thread-2  ]: 19 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 123.2 KiB processed)[0m in 3.78s]
[0m19:00:51.317259 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m19:00:51.317259 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m19:00:51.324226 [info ] [Thread-1  ]: 20 of 20 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m19:00:51.324226 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_estoque_produto_base)
[0m19:00:51.324226 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m19:00:51.331270 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m19:00:51.337304 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 19:00:51.326239 => 19:00:51.337304
[0m19:00:51.337304 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m19:00:51.341328 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:51.934734 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m19:00:51.936747 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m19:00:52.482839 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b14c6a07-9125-4f12-9395-59669d2650a6&page=queryresults
[0m19:00:55.882669 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 19:00:51.337304 => 19:00:55.882669
[0m19:00:55.882669 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6df3fc49-c636-4211-83b5-0e6a1381c1c8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BE171B0A0>]}
[0m19:00:55.882669 [info ] [Thread-1  ]: 20 of 20 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.2 MiB processed)[0m in 4.56s]
[0m19:00:55.882669 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m19:00:55.882669 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:00:55.882669 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:00:55.882669 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:00:55.882669 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m19:00:55.882669 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m19:00:55.882669 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m19:00:55.882669 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m19:00:55.882669 [info ] [MainThread]: 
[0m19:00:55.882669 [info ] [MainThread]: Finished running 10 view models, 10 table models in 0 hours 0 minutes and 40.22 seconds (40.22s).
[0m19:00:55.898532 [debug] [MainThread]: Command end result
[0m19:00:55.914186 [info ] [MainThread]: 
[0m19:00:55.914186 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:00:55.914186 [info ] [MainThread]: 
[0m19:00:55.914186 [info ] [MainThread]: Done. PASS=20 WARN=0 ERROR=0 SKIP=0 TOTAL=20
[0m19:00:55.914186 [debug] [MainThread]: Command `dbt run` succeeded at 19:00:55.914186 after 42.21 seconds
[0m19:00:55.929898 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDBB32460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDF1DA5E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000015BDF11FE50>]}
[0m19:00:55.929898 [debug] [MainThread]: Flushing usage events
[0m19:01:00.217861 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000230488F3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000230478739A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023047873D30>]}


============================== 19:01:00.217861 | 8e3e2467-18fe-415e-92db-6d6dd2a5970a ==============================
[0m19:01:00.217861 [info ] [MainThread]: Running with dbt=1.7.4
[0m19:01:00.217861 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt snapshot', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:01:01.044248 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8e3e2467-18fe-415e-92db-6d6dd2a5970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023047868040>]}
[0m19:01:01.108497 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8e3e2467-18fe-415e-92db-6d6dd2a5970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002304BF47BE0>]}
[0m19:01:01.108497 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m19:01:01.124440 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m19:01:01.172318 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m19:01:01.172318 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m19:01:01.172318 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8e3e2467-18fe-415e-92db-6d6dd2a5970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002304C2367F0>]}
[0m19:01:01.172318 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8e3e2467-18fe-415e-92db-6d6dd2a5970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002304C228400>]}
[0m19:01:01.172318 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m19:01:01.188079 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8e3e2467-18fe-415e-92db-6d6dd2a5970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002304C228310>]}
[0m19:01:01.188079 [info ] [MainThread]: 
[0m19:01:01.188079 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m19:01:01.188079 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:01:01.188079 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:01:01.934763 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m19:01:01.934763 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:01:01.934763 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m19:01:01.934763 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:01:02.572312 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m19:01:02.572312 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:01:02.604498 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m19:01:02.604498 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:01:03.214426 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8e3e2467-18fe-415e-92db-6d6dd2a5970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002304C26DBE0>]}
[0m19:01:03.214426 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:01:03.214426 [info ] [MainThread]: 
[0m19:01:03.230530 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m19:01:03.230530 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m19:01:03.230530 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m19:01:03.230530 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m19:01:03.246693 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 19:01:03.230530 => 19:01:03.246693
[0m19:01:03.246693 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m19:01:03.278720 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m19:01:03.278720 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m19:01:04.050334 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9bd7c4c8-ecf2-4bd0-a827-c54fe0b0af9c&page=queryresults
[0m19:01:05.191796 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m19:01:05.678233 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:091552bd-654c-4231-8e3c-d705e5551eee&page=queryresults
[0m19:01:08.581044 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m19:01:09.353045 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m19:01:09.353045 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m19:01:09.786269 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:60527207-123c-4a9c-a688-92292b0fd086&page=queryresults
[0m19:01:11.719234 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 19:01:03.246693 => 19:01:11.719234
[0m19:01:11.719234 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8e3e2467-18fe-415e-92db-6d6dd2a5970a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002304D2E24C0>]}
[0m19:01:11.719234 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 71.0 KiB processed)[0m in 8.49s]
[0m19:01:11.719234 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m19:01:11.719234 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:01:11.735435 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:01:11.735435 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m19:01:11.735435 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m19:01:11.735435 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m19:01:11.735435 [info ] [MainThread]: 
[0m19:01:11.735435 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.55 seconds (10.55s).
[0m19:01:11.735435 [debug] [MainThread]: Command end result
[0m19:01:11.751213 [info ] [MainThread]: 
[0m19:01:11.751213 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:01:11.754500 [info ] [MainThread]: 
[0m19:01:11.754500 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:01:11.754500 [debug] [MainThread]: Command `dbt snapshot` succeeded at 19:01:11.754500 after 11.60 seconds
[0m19:01:11.754500 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000230488F3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002304BF7B4F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002304C01F2E0>]}
[0m19:01:11.754500 [debug] [MainThread]: Flushing usage events
[0m19:01:16.148699 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B3197593D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B3186EF2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B3186EF760>]}


============================== 19:01:16.164773 | 07c142f5-ff0c-4699-ba6f-e9c0568f0bf3 ==============================
[0m19:01:16.164773 [info ] [MainThread]: Running with dbt=1.7.4
[0m19:01:16.164773 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m19:01:17.100807 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '07c142f5-ff0c-4699-ba6f-e9c0568f0bf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B3186EF940>]}
[0m19:01:17.195963 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '07c142f5-ff0c-4699-ba6f-e9c0568f0bf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B31CDCF2B0>]}
[0m19:01:17.212062 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m19:01:17.212062 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m19:01:17.323343 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m19:01:17.323343 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m19:01:17.323343 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '07c142f5-ff0c-4699-ba6f-e9c0568f0bf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B31D0A9220>]}
[0m19:01:17.339415 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '07c142f5-ff0c-4699-ba6f-e9c0568f0bf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B31CD67700>]}
[0m19:01:17.339415 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m19:01:17.339415 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '07c142f5-ff0c-4699-ba6f-e9c0568f0bf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B31CD678B0>]}
[0m19:01:17.339415 [info ] [MainThread]: 
[0m19:01:17.339415 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m19:01:17.355264 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:01:17.355264 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:01:18.046329 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m19:01:18.046329 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:01:18.046329 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m19:01:18.046329 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:01:18.848842 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m19:01:18.848842 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:01:18.881210 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m19:01:18.881210 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:01:19.522209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '07c142f5-ff0c-4699-ba6f-e9c0568f0bf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B31D0A9E80>]}
[0m19:01:19.522209 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:01:19.522209 [info ] [MainThread]: 
[0m19:01:19.522209 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m19:01:19.522209 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m19:01:19.537890 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m19:01:19.537890 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m19:01:19.553660 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m19:01:19.553660 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 19:01:19.537890 => 19:01:19.553660
[0m19:01:19.553660 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m19:01:19.553660 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m19:01:20.197820 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m19:01:20.197820 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m19:01:20.551901 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e3affdbc-3fd9-4630-9f86-23608766f902&page=queryresults
[0m19:01:22.464954 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 19:01:19.553660 => 19:01:22.464954
[0m19:01:22.464954 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07c142f5-ff0c-4699-ba6f-e9c0568f0bf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B31E14BB50>]}
[0m19:01:22.464954 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (388.0 rows, 58.1 KiB processed)[0m in 2.93s]
[0m19:01:22.464954 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m19:01:22.480865 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:01:22.480865 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:01:22.480865 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m19:01:22.480865 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m19:01:22.480865 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m19:01:22.480865 [info ] [MainThread]: 
[0m19:01:22.480865 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.14 seconds (5.14s).
[0m19:01:22.480865 [debug] [MainThread]: Command end result
[0m19:01:22.500787 [info ] [MainThread]: 
[0m19:01:22.500787 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:01:22.500787 [info ] [MainThread]: 
[0m19:01:22.500787 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m19:01:22.500787 [debug] [MainThread]: Command `dbt run` succeeded at 19:01:22.500787 after 6.43 seconds
[0m19:01:22.500787 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B3197593D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B31CE31280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B31CD8E5E0>]}
[0m19:01:22.500787 [debug] [MainThread]: Flushing usage events
[0m20:00:04.789265 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DC89FB400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DC7985640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DC7985AC0>]}


============================== 20:00:04.789265 | f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288 ==============================
[0m20:00:04.789265 [info ] [MainThread]: Running with dbt=1.7.4
[0m20:00:04.789265 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --exclude tag:snaps', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m20:00:05.617034 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DC796EFD0>]}
[0m20:00:05.664792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DC793FBE0>]}
[0m20:00:05.664792 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m20:00:05.680912 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m20:00:05.728375 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:00:05.728375 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:00:05.728375 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCC347820>]}
[0m20:00:05.744353 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCC33C1C0>]}
[0m20:00:05.744353 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m20:00:05.744353 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCC09BBE0>]}
[0m20:00:05.755548 [info ] [MainThread]: 
[0m20:00:05.755548 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:00:05.757568 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:00:05.760083 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:05.760083 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:00:05.760083 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:06.580509 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:00:07.333513 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m20:00:07.333513 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m20:00:07.333513 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:07.333513 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:08.109452 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m20:00:08.109452 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:00:08.153383 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m20:00:08.153383 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:00:08.792837 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCC347F70>]}
[0m20:00:08.792837 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:00:08.792837 [info ] [MainThread]: 
[0m20:00:08.792837 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m20:00:08.808567 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m20:00:08.808567 [info ] [Thread-1  ]: 1 of 20 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m20:00:08.808567 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m20:00:08.808567 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m20:00:08.808567 [info ] [Thread-2  ]: 2 of 20 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m20:00:08.824395 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m20:00:08.824395 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m20:00:08.824395 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m20:00:08.824395 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 20:00:08.808567 => 20:00:08.824395
[0m20:00:08.824395 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m20:00:08.856452 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m20:00:08.856452 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m20:00:08.856452 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m20:00:08.856452 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 20:00:08.824395 => 20:00:08.856452
[0m20:00:08.856452 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m20:00:08.856452 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m20:00:08.872644 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m20:00:08.888879 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m20:00:08.888879 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m20:00:09.691991 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f97bb725-ec78-4c08-a366-dc5e6a24c330&page=queryresults
[0m20:00:09.691991 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f6960193-463d-45f8-9a5d-dd114a6cee5b&page=queryresults
[0m20:00:10.142417 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 20:00:08.824395 => 20:00:10.142417
[0m20:00:10.142417 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCC3FEE50>]}
[0m20:00:10.142417 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 20:00:08.856452 => 20:00:10.142417
[0m20:00:10.142417 [info ] [Thread-1  ]: 1 of 20 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m20:00:10.142417 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCD445E50>]}
[0m20:00:10.142417 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m20:00:10.142417 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m20:00:10.142417 [info ] [Thread-2  ]: 2 of 20 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m20:00:10.142417 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m20:00:10.142417 [info ] [Thread-1  ]: 3 of 20 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m20:00:10.142417 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m20:00:10.142417 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m20:00:10.142417 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m20:00:10.142417 [info ] [Thread-2  ]: 4 of 20 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m20:00:10.142417 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m20:00:10.142417 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m20:00:10.142417 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m20:00:10.158569 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m20:00:10.158569 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 20:00:10.142417 => 20:00:10.158569
[0m20:00:10.158569 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 20:00:10.142417 => 20:00:10.158569
[0m20:00:10.158569 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m20:00:10.158569 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m20:00:10.158569 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m20:00:10.158569 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m20:00:10.158569 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:10.170147 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m20:00:10.190884 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:10.190884 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m20:00:10.932002 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8c86cb1f-0770-47de-8729-f05990feab4c&page=queryresults
[0m20:00:10.932002 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4012742c-cff4-425c-8932-0b8b7efa35af&page=queryresults
[0m20:00:11.360198 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 20:00:10.158569 => 20:00:11.358184
[0m20:00:11.360198 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCC3F9F10>]}
[0m20:00:11.365980 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 20:00:10.158569 => 20:00:11.365980
[0m20:00:11.367992 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DC66876D0>]}
[0m20:00:11.362210 [info ] [Thread-2  ]: 4 of 20 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m20:00:11.367992 [info ] [Thread-1  ]: 3 of 20 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m20:00:11.370202 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m20:00:11.370202 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m20:00:11.372211 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m20:00:11.370202 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m20:00:11.372211 [info ] [Thread-2  ]: 6 of 20 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m20:00:11.374222 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m20:00:11.374222 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m20:00:11.378243 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m20:00:11.372211 [info ] [Thread-1  ]: 5 of 20 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m20:00:11.382005 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m20:00:11.382005 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m20:00:11.382005 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m20:00:11.382005 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 20:00:11.382005 => 20:00:11.382005
[0m20:00:11.389820 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m20:00:11.389820 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m20:00:11.389820 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 20:00:11.374222 => 20:00:11.389820
[0m20:00:11.389820 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m20:00:11.397967 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m20:00:11.397967 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:11.397967 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m20:00:11.429827 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:11.429827 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m20:00:12.177243 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1823ce36-305e-4cce-b1d5-a1398b3e4d6f&page=queryresults
[0m20:00:12.177243 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5747a9a4-18a0-48bb-af97-cc06231d7a40&page=queryresults
[0m20:00:12.583774 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 20:00:11.389820 => 20:00:12.583774
[0m20:00:12.583774 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCC3FE2E0>]}
[0m20:00:12.594569 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 20:00:11.389820 => 20:00:12.592556
[0m20:00:12.594569 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DC66876D0>]}
[0m20:00:12.583774 [info ] [Thread-2  ]: 6 of 20 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m20:00:12.596581 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m20:00:12.596581 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m20:00:12.594569 [info ] [Thread-1  ]: 5 of 20 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m20:00:12.599600 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m20:00:12.599600 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m20:00:12.598591 [info ] [Thread-2  ]: 7 of 20 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m20:00:12.601610 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_meta_margem_preco)
[0m20:00:12.601610 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m20:00:12.605632 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m20:00:12.599600 [info ] [Thread-1  ]: 8 of 20 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m20:00:12.609652 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_pedido)
[0m20:00:12.609652 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m20:00:12.627593 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m20:00:12.609652 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 20:00:12.601610 => 20:00:12.609652
[0m20:00:12.629604 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m20:00:12.631459 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m20:00:12.631459 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 20:00:12.609652 => 20:00:12.631459
[0m20:00:12.631459 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m20:00:12.631459 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m20:00:12.631459 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:12.644851 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m20:00:12.680691 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:12.696729 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m20:00:13.512177 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:89e7e431-152e-474c-b169-6efa72d0a9cc&page=queryresults
[0m20:00:13.644849 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:76dab76d-3266-44ca-a8fe-02858c3f2e6a&page=queryresults
[0m20:00:13.925278 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 20:00:12.629604 => 20:00:13.925278
[0m20:00:13.927291 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCD41CF70>]}
[0m20:00:13.927291 [info ] [Thread-2  ]: 7 of 20 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m20:00:13.929304 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m20:00:13.929304 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m20:00:13.931157 [info ] [Thread-2  ]: 9 of 20 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m20:00:13.931157 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m20:00:13.931157 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m20:00:13.937996 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m20:00:13.937996 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 20:00:13.933974 => 20:00:13.937996
[0m20:00:13.937996 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m20:00:13.945107 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m20:00:13.945107 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:13.945107 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m20:00:14.026962 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 20:00:12.631459 => 20:00:14.026962
[0m20:00:14.026962 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCD480850>]}
[0m20:00:14.026962 [info ] [Thread-1  ]: 8 of 20 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m20:00:14.026962 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m20:00:14.026962 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m20:00:14.026962 [info ] [Thread-1  ]: 10 of 20 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m20:00:14.026962 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_tempo)
[0m20:00:14.026962 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m20:00:14.042900 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m20:00:14.042900 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 20:00:14.026962 => 20:00:14.042900
[0m20:00:14.044913 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m20:00:14.048936 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m20:00:14.048936 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:14.050949 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m20:00:14.733309 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:01a5292a-b5a8-4752-a7f6-acbceaa8b25c&page=queryresults
[0m20:00:14.743932 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8901f5f3-6924-4c27-ac62-e328821d043a&page=queryresults
[0m20:00:15.131641 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 20:00:13.937996 => 20:00:15.131641
[0m20:00:15.133654 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCD3FD460>]}
[0m20:00:15.133654 [info ] [Thread-2  ]: 9 of 20 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m20:00:15.135668 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m20:00:15.135668 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m20:00:15.135668 [info ] [Thread-2  ]: 11 of 20 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m20:00:15.135668 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m20:00:15.135668 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m20:00:15.143987 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m20:00:15.143987 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 20:00:15.139964 => 20:00:15.143987
[0m20:00:15.143987 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m20:00:15.160192 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:15.202330 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 20:00:14.044913 => 20:00:15.202330
[0m20:00:15.202330 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCC3F9F70>]}
[0m20:00:15.208174 [info ] [Thread-1  ]: 10 of 20 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m20:00:15.208174 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m20:00:15.945704 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m20:00:15.945704 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m20:00:16.672179 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b0c31ac5-ca9f-440d-8c7b-547e046d4088&page=queryresults
[0m20:00:19.824998 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 20:00:15.143987 => 20:00:19.809013
[0m20:00:19.825866 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCD4F0220>]}
[0m20:00:19.825866 [info ] [Thread-2  ]: 11 of 20 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (352.0 rows, 1.4 MiB processed)[0m in 4.69s]
[0m20:00:19.825866 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m20:00:19.825866 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m20:00:19.825866 [info ] [Thread-1  ]: 12 of 20 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m20:00:19.825866 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m20:00:19.825866 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m20:00:19.825866 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m20:00:19.841119 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 20:00:19.825866 => 20:00:19.841119
[0m20:00:19.841119 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m20:00:19.841119 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:20.540585 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m20:00:20.542603 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m20:00:21.285279 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:223ff341-7651-42c1-8b38-ded6236e4094&page=queryresults
[0m20:00:24.059220 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 20:00:19.841119 => 20:00:24.059220
[0m20:00:24.060976 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCC395580>]}
[0m20:00:24.060976 [info ] [Thread-1  ]: 12 of 20 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (352.0 rows, 1.9 MiB processed)[0m in 4.24s]
[0m20:00:24.060976 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m20:00:24.065110 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m20:00:24.065110 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m20:00:24.065110 [info ] [Thread-2  ]: 13 of 20 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m20:00:24.067122 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m20:00:24.067122 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m20:00:24.067122 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m20:00:24.067122 [info ] [Thread-1  ]: 14 of 20 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m20:00:24.067122 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m20:00:24.067122 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m20:00:24.088237 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m20:00:24.090884 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 20:00:24.067122 => 20:00:24.090243
[0m20:00:24.091390 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m20:00:24.093239 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:24.093239 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 20:00:24.067122 => 20:00:24.093239
[0m20:00:24.093239 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m20:00:24.093239 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:24.825310 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m20:00:24.827325 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m20:00:24.847509 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m20:00:24.847509 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m20:00:25.214924 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f8cbbfef-141e-4cd8-b5b6-10f3efea4004&page=queryresults
[0m20:00:25.505842 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fb5557a7-6351-4644-834b-7e3fd55aae94&page=queryresults
[0m20:00:26.870547 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 20:00:24.091390 => 20:00:26.870547
[0m20:00:26.870547 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCD3EAAF0>]}
[0m20:00:26.870547 [info ] [Thread-1  ]: 14 of 20 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (352.0 rows, 83.7 KiB processed)[0m in 2.80s]
[0m20:00:26.870547 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m20:00:26.870547 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m20:00:26.870547 [info ] [Thread-1  ]: 15 of 20 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m20:00:26.881369 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_pedido)
[0m20:00:26.881369 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m20:00:26.883383 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m20:00:26.883383 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 20:00:26.883383 => 20:00:26.883383
[0m20:00:26.883383 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m20:00:26.895213 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:27.522950 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m20:00:27.522950 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m20:00:28.048158 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 20:00:24.093239 => 20:00:28.048158
[0m20:00:28.050171 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCD54CE50>]}
[0m20:00:28.050171 [info ] [Thread-2  ]: 13 of 20 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.5 KiB processed)[0m in 3.98s]
[0m20:00:28.052184 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m20:00:28.052184 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m20:00:28.052184 [info ] [Thread-2  ]: 16 of 20 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m20:00:28.052184 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_preco_produto)
[0m20:00:28.052184 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m20:00:28.060809 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m20:00:28.060809 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 20:00:28.052184 => 20:00:28.060809
[0m20:00:28.060809 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m20:00:28.068123 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:28.163825 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b00b9216-d5c3-41ce-9855-f8a5fdf2bdda&page=queryresults
[0m20:00:28.712036 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m20:00:28.712036 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m20:00:29.365393 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c44115ad-c05a-4cc6-b3ba-c5c29d14779d&page=queryresults
[0m20:00:31.107195 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 20:00:26.883383 => 20:00:31.107195
[0m20:00:31.109210 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCD4A0160>]}
[0m20:00:31.110964 [info ] [Thread-1  ]: 15 of 20 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.23s]
[0m20:00:31.110964 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m20:00:31.112976 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m20:00:31.112976 [info ] [Thread-1  ]: 17 of 20 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m20:00:31.112976 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m20:00:31.112976 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m20:00:31.120827 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m20:00:31.122855 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 20:00:31.116803 => 20:00:31.122855
[0m20:00:31.122855 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m20:00:31.126716 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:31.884033 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m20:00:31.886047 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m20:00:32.286172 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:047f93a3-f823-42d6-9fa2-69ba5ac8ba67&page=queryresults
[0m20:00:32.488687 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 20:00:28.060809 => 20:00:32.488687
[0m20:00:32.488687 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCD47E430>]}
[0m20:00:32.488687 [info ] [Thread-2  ]: 16 of 20 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (271.0 rows, 83.0 KiB processed)[0m in 4.44s]
[0m20:00:32.488687 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m20:00:34.846686 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 20:00:31.122855 => 20:00:34.846686
[0m20:00:34.846686 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCD49BEB0>]}
[0m20:00:34.846686 [info ] [Thread-1  ]: 17 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 414.7 KiB processed)[0m in 3.73s]
[0m20:00:34.846686 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m20:00:34.846686 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m20:00:34.846686 [info ] [Thread-2  ]: 18 of 20 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m20:00:34.846686 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m20:00:34.846686 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m20:00:34.846686 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m20:00:34.846686 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 20:00:34.846686 => 20:00:34.846686
[0m20:00:34.846686 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m20:00:34.864793 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:35.474172 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m20:00:35.474172 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m20:00:36.000408 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ecb2a3b7-0989-405c-b981-d86eb5e315e5&page=queryresults
[0m20:00:38.524262 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 20:00:34.846686 => 20:00:38.524262
[0m20:00:38.524262 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCD537640>]}
[0m20:00:38.524262 [info ] [Thread-2  ]: 18 of 20 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 287.5 KiB processed)[0m in 3.68s]
[0m20:00:38.524262 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m20:00:38.535482 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m20:00:38.535482 [info ] [Thread-1  ]: 19 of 20 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m20:00:38.535482 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m20:00:38.535482 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m20:00:38.551246 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m20:00:38.553759 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 20:00:38.535482 => 20:00:38.553253
[0m20:00:38.554265 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m20:00:38.554265 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:39.161307 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m20:00:39.177394 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m20:00:39.614198 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:96118d0c-2bf0-4305-9552-f55324d7f7b7&page=queryresults
[0m20:00:42.711891 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 20:00:38.554265 => 20:00:42.711891
[0m20:00:42.713905 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCD4A05E0>]}
[0m20:00:42.715921 [info ] [Thread-1  ]: 19 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 123.2 KiB processed)[0m in 4.18s]
[0m20:00:42.715921 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m20:00:42.715921 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m20:00:42.715921 [info ] [Thread-2  ]: 20 of 20 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m20:00:42.715921 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_estoque_produto_base)
[0m20:00:42.715921 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m20:00:42.723307 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m20:00:42.723307 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 20:00:42.723307 => 20:00:42.723307
[0m20:00:42.723307 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m20:00:42.723307 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:43.638086 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m20:00:43.651541 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m20:00:44.240454 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9a89306d-436b-47a7-8f6e-e6b97e930afe&page=queryresults
[0m20:00:47.948883 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 20:00:42.723307 => 20:00:47.948883
[0m20:00:47.951107 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f0cc3d38-0c8c-47e5-a3e1-a5dc9473b288', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCD54C8B0>]}
[0m20:00:47.952112 [info ] [Thread-2  ]: 20 of 20 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.2 MiB processed)[0m in 5.23s]
[0m20:00:47.953120 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m20:00:47.956105 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:00:47.957119 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:00:47.957119 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:00:47.958116 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m20:00:47.958116 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m20:00:47.959106 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m20:00:47.959106 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m20:00:47.960321 [info ] [MainThread]: 
[0m20:00:47.961246 [info ] [MainThread]: Finished running 10 view models, 10 table models in 0 hours 0 minutes and 42.20 seconds (42.20s).
[0m20:00:47.968323 [debug] [MainThread]: Command end result
[0m20:00:47.991081 [info ] [MainThread]: 
[0m20:00:47.992083 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:00:47.993077 [info ] [MainThread]: 
[0m20:00:47.994610 [info ] [MainThread]: Done. PASS=20 WARN=0 ERROR=0 SKIP=0 TOTAL=20
[0m20:00:47.996896 [debug] [MainThread]: Command `dbt run` succeeded at 20:00:47.996896 after 43.27 seconds
[0m20:00:47.997883 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DC89FB400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCC0C96D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DCC09DBE0>]}
[0m20:00:47.998895 [debug] [MainThread]: Flushing usage events
[0m20:00:52.416702 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E12B83430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E11B0F9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E11B0FD30>]}


============================== 20:00:52.416702 | c61a3587-8890-434f-92d9-e1fe5925841a ==============================
[0m20:00:52.416702 [info ] [MainThread]: Running with dbt=1.7.4
[0m20:00:52.416702 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m20:00:53.241290 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c61a3587-8890-434f-92d9-e1fe5925841a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E14CCABB0>]}
[0m20:00:53.305571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c61a3587-8890-434f-92d9-e1fe5925841a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E161E1A30>]}
[0m20:00:53.305571 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m20:00:53.305571 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m20:00:53.352862 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:00:53.352862 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:00:53.352862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c61a3587-8890-434f-92d9-e1fe5925841a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E164C56A0>]}
[0m20:00:53.368774 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c61a3587-8890-434f-92d9-e1fe5925841a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E164B82B0>]}
[0m20:00:53.368774 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m20:00:53.368774 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c61a3587-8890-434f-92d9-e1fe5925841a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E164B81C0>]}
[0m20:00:53.381732 [info ] [MainThread]: 
[0m20:00:53.381732 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:00:53.384468 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:00:53.384468 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:54.026713 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m20:00:54.026713 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:54.026713 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m20:00:54.026713 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:54.669686 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m20:00:54.669686 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:00:54.701758 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m20:00:54.701758 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:00:55.509320 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c61a3587-8890-434f-92d9-e1fe5925841a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E164FFF10>]}
[0m20:00:55.509320 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:00:55.509320 [info ] [MainThread]: 
[0m20:00:55.525227 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m20:00:55.525227 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m20:00:55.525227 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m20:00:55.525227 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m20:00:55.541021 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 20:00:55.525227 => 20:00:55.541021
[0m20:00:55.541021 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m20:00:55.589455 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m20:00:55.589455 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m20:00:56.392981 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d4cd2939-8211-4682-ab9d-3464650ce78d&page=queryresults
[0m20:00:57.509509 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m20:00:57.886554 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8af7d616-8e8a-47e3-a380-312262eaff6c&page=queryresults
[0m20:01:00.269635 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m20:01:01.070722 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m20:01:01.070722 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m20:01:01.491717 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2704f5ff-113e-40d1-b0c4-1140f3cde4f5&page=queryresults
[0m20:01:03.724806 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 20:00:55.541021 => 20:01:03.724806
[0m20:01:03.724806 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c61a3587-8890-434f-92d9-e1fe5925841a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E1657E760>]}
[0m20:01:03.724806 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 71.0 KiB processed)[0m in 8.20s]
[0m20:01:03.724806 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m20:01:03.724806 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:01:03.724806 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:01:03.724806 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m20:01:03.724806 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m20:01:03.724806 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m20:01:03.724806 [info ] [MainThread]: 
[0m20:01:03.724806 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.34 seconds (10.34s).
[0m20:01:03.724806 [debug] [MainThread]: Command end result
[0m20:01:03.740565 [info ] [MainThread]: 
[0m20:01:03.740565 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:01:03.756435 [info ] [MainThread]: 
[0m20:01:03.756435 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:01:03.756435 [debug] [MainThread]: Command `dbt snapshot` succeeded at 20:01:03.756435 after 11.41 seconds
[0m20:01:03.756435 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E12B83430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E164A7D00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021E162B6F70>]}
[0m20:01:03.756435 [debug] [MainThread]: Flushing usage events
[0m20:01:08.548170 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AF4A3A3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AF4932C9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AF4932CD30>]}


============================== 20:01:08.548170 | 718ee3a0-5b2e-42e3-808e-8778503ad054 ==============================
[0m20:01:08.548170 [info ] [MainThread]: Running with dbt=1.7.4
[0m20:01:08.548170 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --select tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m20:01:09.394380 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '718ee3a0-5b2e-42e3-808e-8778503ad054', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AF49313B20>]}
[0m20:01:09.458623 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '718ee3a0-5b2e-42e3-808e-8778503ad054', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AF4D9415B0>]}
[0m20:01:09.458623 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m20:01:09.474454 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m20:01:09.522241 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:01:09.522241 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:01:09.522241 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '718ee3a0-5b2e-42e3-808e-8778503ad054', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AF4DCE78E0>]}
[0m20:01:09.538012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '718ee3a0-5b2e-42e3-808e-8778503ad054', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AF4DCDC4F0>]}
[0m20:01:09.538012 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m20:01:09.538012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '718ee3a0-5b2e-42e3-808e-8778503ad054', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AF4DCDC400>]}
[0m20:01:09.538012 [info ] [MainThread]: 
[0m20:01:09.538012 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:01:09.538012 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:01:09.538012 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:01:10.147661 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m20:01:10.147661 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:01:10.147661 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m20:01:10.147661 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:01:10.760606 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m20:01:10.760606 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:01:10.790124 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m20:01:10.790124 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:01:11.397116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '718ee3a0-5b2e-42e3-808e-8778503ad054', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AF4DAD2070>]}
[0m20:01:11.397116 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:01:11.397116 [info ] [MainThread]: 
[0m20:01:11.397116 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m20:01:11.397116 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m20:01:11.397116 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m20:01:11.397116 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m20:01:11.412878 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m20:01:11.412878 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 20:01:11.412878 => 20:01:11.412878
[0m20:01:11.412878 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m20:01:11.428820 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m20:01:12.070627 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m20:01:12.070627 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m20:01:12.426338 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0f3e81aa-a969-43ff-897d-0fc67b8b6532&page=queryresults
[0m20:01:14.388523 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 20:01:11.412878 => 20:01:14.388523
[0m20:01:14.388523 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '718ee3a0-5b2e-42e3-808e-8778503ad054', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AF4DCE7D00>]}
[0m20:01:14.388523 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (388.0 rows, 58.1 KiB processed)[0m in 2.99s]
[0m20:01:14.388523 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m20:01:14.388523 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:01:14.388523 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:01:14.388523 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m20:01:14.388523 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m20:01:14.388523 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m20:01:14.388523 [info ] [MainThread]: 
[0m20:01:14.388523 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.85 seconds (4.85s).
[0m20:01:14.388523 [debug] [MainThread]: Command end result
[0m20:01:14.404602 [info ] [MainThread]: 
[0m20:01:14.404602 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:01:14.404602 [info ] [MainThread]: 
[0m20:01:14.404602 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:01:14.404602 [debug] [MainThread]: Command `dbt run` succeeded at 20:01:14.404602 after 5.93 seconds
[0m20:01:14.404602 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AF4A3A3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AF4D9415B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AF4DCCBFD0>]}
[0m20:01:14.404602 [debug] [MainThread]: Flushing usage events
[0m21:00:05.732560 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C449923460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C4488AF9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C4488AFD30>]}


============================== 21:00:05.732560 | 6887d750-2b5b-4fe3-b84a-f2bb463e42bf ==============================
[0m21:00:05.732560 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:00:05.732560 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --exclude tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m21:00:06.528471 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44BA65A90>]}
[0m21:00:06.607949 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44CF91430>]}
[0m21:00:06.607949 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:00:06.620513 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:00:06.671988 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:00:06.671988 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:00:06.671988 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44D269370>]}
[0m21:00:06.688160 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44CF1F310>]}
[0m21:00:06.688160 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:00:06.688160 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44CF1F820>]}
[0m21:00:06.692099 [info ] [MainThread]: 
[0m21:00:06.692099 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:00:06.695427 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:00:06.695427 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:00:06.695427 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:06.695427 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:07.537500 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:00:08.532151 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m21:00:08.532151 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:08.532151 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m21:00:08.532151 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:09.256079 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m21:00:09.256079 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:00:09.288227 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m21:00:09.288227 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:00:09.915410 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44D006340>]}
[0m21:00:09.915410 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:00:09.931197 [info ] [MainThread]: 
[0m21:00:09.931197 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m21:00:09.931197 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m21:00:09.931197 [info ] [Thread-1  ]: 1 of 20 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m21:00:09.931197 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m21:00:09.931197 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m21:00:09.931197 [info ] [Thread-2  ]: 2 of 20 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m21:00:09.947062 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m21:00:09.947062 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m21:00:09.947062 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m21:00:09.947062 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 21:00:09.931197 => 21:00:09.947062
[0m21:00:09.962908 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m21:00:09.978927 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m21:00:09.978927 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m21:00:09.994868 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 21:00:09.947062 => 21:00:09.994868
[0m21:00:09.994868 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:00:09.994868 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m21:00:09.994868 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m21:00:10.006539 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m21:00:10.042682 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m21:00:10.042682 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m21:00:10.834763 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:eb070f14-6c66-4e72-9724-f008a45f8835&page=queryresults
[0m21:00:10.845526 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ee0f5294-ff1e-4d30-812d-d9553eb7d37e&page=queryresults
[0m21:00:11.280027 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 21:00:09.994868 => 21:00:11.280027
[0m21:00:11.280027 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44E302BB0>]}
[0m21:00:11.280027 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 21:00:09.962908 => 21:00:11.280027
[0m21:00:11.280027 [info ] [Thread-2  ]: 2 of 20 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m21:00:11.280027 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44E2FC370>]}
[0m21:00:11.280027 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m21:00:11.280027 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m21:00:11.280027 [info ] [Thread-1  ]: 1 of 20 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.35s]
[0m21:00:11.280027 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m21:00:11.280027 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m21:00:11.280027 [info ] [Thread-2  ]: 3 of 20 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m21:00:11.280027 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m21:00:11.280027 [info ] [Thread-1  ]: 4 of 20 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m21:00:11.296151 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m21:00:11.296151 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m21:00:11.296151 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m21:00:11.296151 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m21:00:11.296151 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m21:00:11.296151 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 21:00:11.296151 => 21:00:11.296151
[0m21:00:11.312102 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 21:00:11.296151 => 21:00:11.312102
[0m21:00:11.312102 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m21:00:11.312102 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m21:00:11.312102 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m21:00:11.328269 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:11.328269 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m21:00:11.328269 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m21:00:11.360557 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:11.360557 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m21:00:12.064710 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e9ae6142-a93b-412a-b01f-a56371d2760f&page=queryresults
[0m21:00:12.096541 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a145cdad-0134-4f3e-8f5f-4be5e2532c5d&page=queryresults
[0m21:00:12.462453 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 21:00:11.312102 => 21:00:12.462453
[0m21:00:12.464465 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44E3DB190>]}
[0m21:00:12.464465 [info ] [Thread-1  ]: 4 of 20 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m21:00:12.466478 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m21:00:12.466478 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m21:00:12.466478 [info ] [Thread-1  ]: 5 of 20 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m21:00:12.468490 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_imagem_produto)
[0m21:00:12.468490 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m21:00:12.476531 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m21:00:12.478543 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 21:00:12.472513 => 21:00:12.476531
[0m21:00:12.478543 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m21:00:12.484323 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m21:00:12.484323 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 21:00:11.312102 => 21:00:12.484323
[0m21:00:12.484323 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44D313BE0>]}
[0m21:00:12.484323 [info ] [Thread-2  ]: 3 of 20 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m21:00:12.484323 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m21:00:12.484323 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m21:00:12.484323 [info ] [Thread-2  ]: 6 of 20 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m21:00:12.484323 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_item_pedido)
[0m21:00:12.484323 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m21:00:12.499724 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m21:00:12.501734 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:12.501734 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m21:00:12.546530 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 21:00:12.484323 => 21:00:12.546530
[0m21:00:12.546530 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m21:00:12.546530 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m21:00:12.546530 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:12.559903 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m21:00:13.240557 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:54246e62-1c30-4e35-9535-a6f8bafca134&page=queryresults
[0m21:00:13.330181 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:53e383b1-40b8-4dcf-bef1-63712c7d22ff&page=queryresults
[0m21:00:13.626478 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 21:00:12.478543 => 21:00:13.626478
[0m21:00:13.628491 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44E2F2040>]}
[0m21:00:13.630505 [info ] [Thread-1  ]: 5 of 20 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m21:00:13.630505 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m21:00:13.630505 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m21:00:13.632518 [info ] [Thread-1  ]: 7 of 20 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m21:00:13.632518 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_meta_margem_preco)
[0m21:00:13.634531 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m21:00:13.638554 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m21:00:13.640565 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 21:00:13.634531 => 21:00:13.640565
[0m21:00:13.640565 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m21:00:13.652373 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m21:00:13.654384 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:13.654384 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m21:00:13.727766 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 21:00:12.546530 => 21:00:13.727766
[0m21:00:13.727766 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44D310310>]}
[0m21:00:13.727766 [info ] [Thread-2  ]: 6 of 20 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m21:00:13.727766 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m21:00:13.727766 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m21:00:13.727766 [info ] [Thread-2  ]: 8 of 20 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m21:00:13.727766 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m21:00:13.727766 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m21:00:13.727766 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m21:00:13.727766 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 21:00:13.727766 => 21:00:13.727766
[0m21:00:13.743739 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m21:00:13.743739 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m21:00:13.743739 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:13.743739 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m21:00:14.597486 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:41a7f211-3515-45a9-b392-05b4d6f1d098&page=queryresults
[0m21:00:14.628228 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:892cf06c-312f-4d3d-a9a4-7c1c607c8c63&page=queryresults
[0m21:00:14.995590 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 21:00:13.642578 => 21:00:14.995590
[0m21:00:14.995590 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44E39DD60>]}
[0m21:00:14.995590 [info ] [Thread-1  ]: 7 of 20 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m21:00:14.995590 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m21:00:14.995590 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m21:00:14.995590 [info ] [Thread-1  ]: 9 of 20 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m21:00:15.000773 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m21:00:15.000773 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m21:00:15.006811 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m21:00:15.006811 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 21:00:15.000773 => 21:00:15.006811
[0m21:00:15.006811 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m21:00:15.011598 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m21:00:15.011598 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:15.011598 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m21:00:15.059264 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 21:00:13.743739 => 21:00:15.059264
[0m21:00:15.059264 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44E3B3F40>]}
[0m21:00:15.059264 [info ] [Thread-2  ]: 8 of 20 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m21:00:15.059264 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m21:00:15.059264 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m21:00:15.070154 [info ] [Thread-2  ]: 10 of 20 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m21:00:15.070154 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_tempo)
[0m21:00:15.070154 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m21:00:15.075185 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m21:00:15.075185 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 21:00:15.072165 => 21:00:15.075185
[0m21:00:15.075185 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m21:00:15.083109 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m21:00:15.083109 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:15.085122 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m21:00:15.734627 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:260cf606-d43d-4613-a033-0e92917f3ef7&page=queryresults
[0m21:00:15.795453 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f5a70a46-ea1a-4bf6-949a-401624ada3c2&page=queryresults
[0m21:00:16.128478 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 21:00:15.009861 => 21:00:16.128478
[0m21:00:16.130492 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44E471940>]}
[0m21:00:16.130492 [info ] [Thread-1  ]: 9 of 20 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m21:00:16.132505 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m21:00:16.132505 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m21:00:16.132505 [info ] [Thread-1  ]: 11 of 20 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m21:00:16.132505 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m21:00:16.132505 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m21:00:16.141538 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m21:00:16.141538 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 21:00:16.137515 => 21:00:16.141538
[0m21:00:16.141538 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m21:00:16.148369 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:16.199676 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 21:00:15.079087 => 21:00:16.199676
[0m21:00:16.199676 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44E40A6A0>]}
[0m21:00:16.201684 [info ] [Thread-2  ]: 10 of 20 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m21:00:16.201684 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m21:00:16.787690 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m21:00:16.787690 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m21:00:17.659467 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:964733b1-fa7f-4ab3-b30c-226c9798c40f&page=queryresults
[0m21:00:20.202054 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 21:00:16.141538 => 21:00:20.202054
[0m21:00:20.218073 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44E415C10>]}
[0m21:00:20.218073 [info ] [Thread-1  ]: 11 of 20 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (352.0 rows, 1.4 MiB processed)[0m in 4.09s]
[0m21:00:20.218073 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m21:00:20.218073 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m21:00:20.218073 [info ] [Thread-2  ]: 12 of 20 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m21:00:20.218073 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m21:00:20.218073 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m21:00:20.234251 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m21:00:20.234251 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 21:00:20.218073 => 21:00:20.234251
[0m21:00:20.234251 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m21:00:20.240130 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:21.065358 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m21:00:21.065358 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m21:00:21.706836 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:358b9fd5-171b-454e-a350-ec8da119fa42&page=queryresults
[0m21:00:24.033549 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 21:00:20.234251 => 21:00:24.033549
[0m21:00:24.033549 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44E3315E0>]}
[0m21:00:24.033549 [info ] [Thread-2  ]: 12 of 20 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (352.0 rows, 1.9 MiB processed)[0m in 3.82s]
[0m21:00:24.033549 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m21:00:24.033549 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:00:24.033549 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m21:00:24.033549 [info ] [Thread-1  ]: 13 of 20 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m21:00:24.033549 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m21:00:24.033549 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m21:00:24.049437 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m21:00:24.033549 [info ] [Thread-2  ]: 14 of 20 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m21:00:24.049437 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_estoque_geral)
[0m21:00:24.049437 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m21:00:24.065297 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m21:00:24.065297 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 21:00:24.056745 => 21:00:24.065297
[0m21:00:24.065297 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m21:00:24.065297 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:24.065297 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 21:00:24.033549 => 21:00:24.065297
[0m21:00:24.065297 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m21:00:24.079050 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:24.752695 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m21:00:24.752695 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m21:00:24.764554 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m21:00:24.768710 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m21:00:25.137289 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9eaf56de-d1e3-4aec-9afa-3a9d76ed9cde&page=queryresults
[0m21:00:25.334132 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:214c72c1-28f4-451e-8f3f-b48b7b9b60a0&page=queryresults
[0m21:00:27.224568 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 21:00:24.065297 => 21:00:27.222437
[0m21:00:27.224568 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44E415880>]}
[0m21:00:27.226582 [info ] [Thread-2  ]: 14 of 20 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (352.0 rows, 83.7 KiB processed)[0m in 3.18s]
[0m21:00:27.226582 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m21:00:27.226582 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m21:00:27.226582 [info ] [Thread-2  ]: 15 of 20 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m21:00:27.226582 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_pedido)
[0m21:00:27.226582 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m21:00:27.226582 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m21:00:27.238258 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 21:00:27.226582 => 21:00:27.238258
[0m21:00:27.238258 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m21:00:27.238258 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:27.366733 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 21:00:24.065297 => 21:00:27.366733
[0m21:00:27.366733 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44E471940>]}
[0m21:00:27.366733 [info ] [Thread-1  ]: 13 of 20 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.5 KiB processed)[0m in 3.33s]
[0m21:00:27.366733 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:00:27.366733 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m21:00:27.377850 [info ] [Thread-1  ]: 16 of 20 START sql table model dbt_dw_az.tb_preco_produto ...................... [RUN]
[0m21:00:27.377850 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_preco_produto)
[0m21:00:27.377850 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m21:00:27.382392 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m21:00:27.382392 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 21:00:27.377850 => 21:00:27.382392
[0m21:00:27.382392 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m21:00:27.382392 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:27.977375 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m21:00:27.991199 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m21:00:28.023012 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m21:00:28.040271 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visão atual dos produtos, não trabalho aqui com histórico do preço
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,a.vl_alteracao_preco
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
     where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] Cartão de Crédito', '[Nuvem] PIX')
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,coalesce(a.vl_custo_compra, 0) as vl_custo_compra
          ,coalesce(a.vl_custo_total, 0)  as vl_custo_total
          ,coalesce(a.vl_preco_venda, 0)  as vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_alteracao_preco
          ,a.ds_tipo_alteracao_preco
          ,a.dt_alteracao_preco
          ,coalesce(a.vl_alteracao_preco, 0)                                                                                 as vl_alteracao_preco
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] Cartão de Crédito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto     as a
left join cte_meta_margem as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m21:00:28.633853 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:701493d3-f89a-4ead-b1bd-b6654bf5e850&page=queryresults
[0m21:00:28.735447 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7de78457-c22a-45f5-9dae-9171a82d2457&page=queryresults
[0m21:00:31.130541 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 21:00:27.238258 => 21:00:31.130541
[0m21:00:31.130541 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44E4B76A0>]}
[0m21:00:31.130541 [info ] [Thread-2  ]: 15 of 20 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.90s]
[0m21:00:31.130541 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m21:00:31.130541 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m21:00:31.130541 [info ] [Thread-2  ]: 17 of 20 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m21:00:31.130541 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m21:00:31.145645 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m21:00:31.149674 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m21:00:31.151686 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 21:00:31.145645 => 21:00:31.151686
[0m21:00:31.153699 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m21:00:31.155712 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:31.546117 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 21:00:27.382392 => 21:00:31.546117
[0m21:00:31.546117 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C4475A76D0>]}
[0m21:00:31.546117 [info ] [Thread-1  ]: 16 of 20 OK created sql table model dbt_dw_az.tb_preco_produto ................. [[32mCREATE TABLE (271.0 rows, 83.0 KiB processed)[0m in 4.17s]
[0m21:00:31.546117 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m21:00:31.809865 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m21:00:31.811876 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m21:00:32.186758 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:af3f2e53-49a1-4e17-851f-d03a19961571&page=queryresults
[0m21:00:34.398818 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 21:00:31.153699 => 21:00:34.398818
[0m21:00:34.400871 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C4475A76D0>]}
[0m21:00:34.400871 [info ] [Thread-2  ]: 17 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 414.7 KiB processed)[0m in 3.27s]
[0m21:00:34.402970 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m21:00:34.402970 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m21:00:34.405025 [info ] [Thread-1  ]: 18 of 20 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m21:00:34.405025 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m21:00:34.405025 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m21:00:34.405025 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m21:00:34.416998 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 21:00:34.405025 => 21:00:34.414984
[0m21:00:34.416998 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m21:00:34.421026 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:35.055802 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m21:00:35.055802 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m21:00:35.436438 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0a3bde4e-7089-47ba-915c-9138cc2f5e05&page=queryresults
[0m21:00:37.683397 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 21:00:34.416998 => 21:00:37.683397
[0m21:00:37.683397 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44E4B7700>]}
[0m21:00:37.683397 [info ] [Thread-1  ]: 18 of 20 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 287.5 KiB processed)[0m in 3.28s]
[0m21:00:37.683397 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m21:00:37.692082 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m21:00:37.692082 [info ] [Thread-2  ]: 19 of 20 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m21:00:37.694096 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m21:00:37.694096 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m21:00:37.700360 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m21:00:37.708400 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 21:00:37.694096 => 21:00:37.706388
[0m21:00:37.708400 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m21:00:37.712422 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:38.381385 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m21:00:38.385412 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m21:00:38.773719 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f33b3bd9-b540-4afd-b0ce-0765c42eb48c&page=queryresults
[0m21:00:41.865512 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 21:00:37.708400 => 21:00:41.865512
[0m21:00:41.865512 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44D0125B0>]}
[0m21:00:41.865512 [info ] [Thread-2  ]: 19 of 20 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (191.0 rows, 123.2 KiB processed)[0m in 4.17s]
[0m21:00:41.865512 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m21:00:41.872579 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m21:00:41.872579 [info ] [Thread-1  ]: 20 of 20 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m21:00:41.874593 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_estoque_produto_base)
[0m21:00:41.874593 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m21:00:41.881642 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m21:00:41.881642 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 21:00:41.874593 => 21:00:41.881642
[0m21:00:41.881642 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m21:00:41.881642 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:42.509718 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m21:00:42.511733 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m21:00:43.142469 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ee37a164-f265-47bb-b126-28a3b4193b9d&page=queryresults
[0m21:00:46.506498 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 21:00:41.881642 => 21:00:46.506498
[0m21:00:46.508511 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6887d750-2b5b-4fe3-b84a-f2bb463e42bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44E4D5490>]}
[0m21:00:46.508511 [info ] [Thread-1  ]: 20 of 20 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (191.0 rows, 2.2 MiB processed)[0m in 4.63s]
[0m21:00:46.510525 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m21:00:46.510525 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:00:46.514826 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:00:46.514826 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:00:46.514826 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m21:00:46.514826 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m21:00:46.514826 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m21:00:46.516838 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m21:00:46.516838 [info ] [MainThread]: 
[0m21:00:46.516838 [info ] [MainThread]: Finished running 10 view models, 10 table models in 0 hours 0 minutes and 39.82 seconds (39.82s).
[0m21:00:46.522869 [debug] [MainThread]: Command end result
[0m21:00:46.532660 [info ] [MainThread]: 
[0m21:00:46.532660 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:00:46.532660 [info ] [MainThread]: 
[0m21:00:46.532660 [info ] [MainThread]: Done. PASS=20 WARN=0 ERROR=0 SKIP=0 TOTAL=20
[0m21:00:46.542820 [debug] [MainThread]: Command `dbt run` succeeded at 21:00:46.542820 after 40.86 seconds
[0m21:00:46.542820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C449923460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44CF91430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C44D2ECEE0>]}
[0m21:00:46.542820 [debug] [MainThread]: Flushing usage events
[0m21:00:51.083328 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216DA9F3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216D9999940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216D9999B80>]}


============================== 21:00:51.083328 | 1893cdf6-a32f-4e00-a361-e338a183117d ==============================
[0m21:00:51.083328 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:00:51.083328 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt snapshot', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:00:51.941978 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1893cdf6-a32f-4e00-a361-e338a183117d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216D9999850>]}
[0m21:00:52.005978 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1893cdf6-a32f-4e00-a361-e338a183117d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216DDF9BD30>]}
[0m21:00:52.005978 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:00:52.021985 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:00:52.053772 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:00:52.053772 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:00:52.069819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1893cdf6-a32f-4e00-a361-e338a183117d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216DE356460>]}
[0m21:00:52.086052 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1893cdf6-a32f-4e00-a361-e338a183117d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216DE349040>]}
[0m21:00:52.086052 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:00:52.086052 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1893cdf6-a32f-4e00-a361-e338a183117d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216DE3490A0>]}
[0m21:00:52.086052 [info ] [MainThread]: 
[0m21:00:52.086052 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:00:52.086052 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:00:52.086052 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:52.793200 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:00:52.793200 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m21:00:52.793200 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:52.793200 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:53.408820 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m21:00:53.408820 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:00:53.442130 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m21:00:53.442130 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:00:54.063508 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1893cdf6-a32f-4e00-a361-e338a183117d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216DE0BD5B0>]}
[0m21:00:54.064462 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:00:54.065970 [info ] [MainThread]: 
[0m21:00:54.143964 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m21:00:54.143964 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m21:00:54.143964 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m21:00:54.143964 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m21:00:54.143964 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 21:00:54.143964 => 21:00:54.143964
[0m21:00:54.160031 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m21:00:54.255362 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:00:54.257362 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_total from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m21:00:55.214482 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f49154b8-ed05-45fa-bb3e-104ce4b97155&page=queryresults
[0m21:00:56.452314 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_total` != source_data.`vl_custo_total`
        or
        (
            ((snapshotted_data.`vl_custo_total` is null) and not (source_data.`vl_custo_total` is null))
            or
            ((not snapshotted_data.`vl_custo_total` is null) and (source_data.`vl_custo_total` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m21:00:56.888238 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:029856a4-a667-4ea9-8957-3580c8c69ba4&page=queryresults
[0m21:00:59.232513 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m21:01:00.015323 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m21:01:00.019373 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_compra`, `vl_custo_total`, `vl_preco_venda`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m21:01:00.427191 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bf59d816-53ea-4d9a-a10b-d8d77756507d&page=queryresults
[0m21:01:02.645170 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 21:00:54.160031 => 21:01:02.645170
[0m21:01:02.645170 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1893cdf6-a32f-4e00-a361-e338a183117d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216DE3E1AF0>]}
[0m21:01:02.645170 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 71.0 KiB processed)[0m in 8.50s]
[0m21:01:02.658455 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m21:01:02.658455 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:01:02.658455 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:01:02.658455 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:01:02.658455 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m21:01:02.658455 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m21:01:02.658455 [info ] [MainThread]: 
[0m21:01:02.658455 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.57 seconds (10.57s).
[0m21:01:02.658455 [debug] [MainThread]: Command end result
[0m21:01:02.674614 [info ] [MainThread]: 
[0m21:01:02.674614 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:01:02.674614 [info ] [MainThread]: 
[0m21:01:02.674614 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:01:02.674614 [debug] [MainThread]: Command `dbt snapshot` succeeded at 21:01:02.674614 after 11.65 seconds
[0m21:01:02.674614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216DA9F3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216DDF9BD30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216DE3E1AF0>]}
[0m21:01:02.674614 [debug] [MainThread]: Flushing usage events
[0m21:01:06.808407 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFFCB23430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFFBA979D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFFBA97B80>]}


============================== 21:01:06.824269 | 3cc5fc8a-41df-4f5c-9f90-af7b8fba2ae5 ==============================
[0m21:01:06.824269 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:01:06.824269 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m21:01:07.619169 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3cc5fc8a-41df-4f5c-9f90-af7b8fba2ae5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BF800ADDC0>]}
[0m21:01:07.683812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3cc5fc8a-41df-4f5c-9f90-af7b8fba2ae5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFFBA5FC70>]}
[0m21:01:07.683812 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:01:07.699659 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:01:07.747760 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:01:07.747760 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:01:07.747760 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3cc5fc8a-41df-4f5c-9f90-af7b8fba2ae5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BF80486B50>]}
[0m21:01:07.763562 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3cc5fc8a-41df-4f5c-9f90-af7b8fba2ae5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BF80308790>]}
[0m21:01:07.763562 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:01:07.763562 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3cc5fc8a-41df-4f5c-9f90-af7b8fba2ae5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BF80308610>]}
[0m21:01:07.763562 [info ] [MainThread]: 
[0m21:01:07.763562 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:01:07.763562 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:01:07.763562 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:01:08.421647 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m21:01:08.421647 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:01:08.421647 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m21:01:08.421647 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:01:09.064161 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m21:01:09.064161 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:01:09.096385 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m21:01:09.096385 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:01:09.722603 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3cc5fc8a-41df-4f5c-9f90-af7b8fba2ae5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BF80262580>]}
[0m21:01:09.722603 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:01:09.738784 [info ] [MainThread]: 
[0m21:01:09.738784 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m21:01:09.738784 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m21:01:09.738784 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m21:01:09.738784 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m21:01:09.754769 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m21:01:09.754769 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 21:01:09.738784 => 21:01:09.754769
[0m21:01:09.754769 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m21:01:09.770566 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:01:10.557027 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m21:01:10.557027 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m21:01:10.893727 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8d125b55-346c-48e9-bc82-9ced55d0e768&page=queryresults
[0m21:01:12.822137 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 21:01:09.754769 => 21:01:12.822137
[0m21:01:12.822137 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3cc5fc8a-41df-4f5c-9f90-af7b8fba2ae5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BF8046BCD0>]}
[0m21:01:12.822137 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (388.0 rows, 58.1 KiB processed)[0m in 3.08s]
[0m21:01:12.822137 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m21:01:12.822137 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:01:12.822137 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:01:12.822137 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:01:12.822137 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m21:01:12.822137 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m21:01:12.822137 [info ] [MainThread]: 
[0m21:01:12.822137 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.06 seconds (5.06s).
[0m21:01:12.822137 [debug] [MainThread]: Command end result
[0m21:01:12.837962 [info ] [MainThread]: 
[0m21:01:12.837962 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:01:12.837962 [info ] [MainThread]: 
[0m21:01:12.837962 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:01:12.853663 [debug] [MainThread]: Command `dbt run` succeeded at 21:01:12.853663 after 6.10 seconds
[0m21:01:12.853663 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BFFCB23430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BF80486E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BF80262820>]}
[0m21:01:12.853663 [debug] [MainThread]: Flushing usage events
[0m21:58:35.481761 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE1CF2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE0C80A30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE0C80D60>]}


============================== 21:58:35.486886 | f1224c16-66be-41a0-822b-fe04a73e3570 ==============================
[0m21:58:35.486886 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:58:35.486886 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models +tb_estoque_produto_base', 'send_anonymous_usage_stats': 'True'}
[0m21:58:36.080325 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE0C77040>]}
[0m21:58:36.174871 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE530A100>]}
[0m21:58:36.174871 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:58:36.190602 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:58:36.293939 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:58:36.293939 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_venda_produto_base.sql
[0m21:58:36.436943 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE57E8C40>]}
[0m21:58:36.436943 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE563C0A0>]}
[0m21:58:36.436943 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:58:36.436943 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE563C070>]}
[0m21:58:36.454524 [info ] [MainThread]: 
[0m21:58:36.454524 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:58:36.454524 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:58:36.454524 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:58:36.454524 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:58:36.454524 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:58:37.482076 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:58:38.364704 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m21:58:38.364704 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:58:38.364704 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:58:38.364704 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:58:39.023457 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m21:58:39.023457 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:58:39.143504 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m21:58:39.145516 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:58:39.800145 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE57E8B50>]}
[0m21:58:39.803462 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:58:39.803462 [info ] [MainThread]: 
[0m21:58:39.803462 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m21:58:39.803462 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m21:58:39.803462 [info ] [Thread-1  ]: 1 of 16 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m21:58:39.813789 [info ] [Thread-2  ]: 2 of 16 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m21:58:39.816491 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m21:58:39.818567 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m21:58:39.818567 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m21:58:39.821965 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m21:58:39.830759 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m21:58:39.833989 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m21:58:39.833989 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 21:58:39.830759 => 21:58:39.833989
[0m21:58:39.837695 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m21:58:39.854456 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 21:58:39.823047 => 21:58:39.854456
[0m21:58:39.855159 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m21:58:39.855159 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m21:58:39.871788 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m21:58:39.871788 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m21:58:39.882361 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m21:58:39.910625 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:58:39.910625 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437913', cd_valor, null))       as fg_alteracao_preco
        ,max(if(cd_campo_customizado = '3437914', ds_valor_campo, null)) as ds_tipo_alteracao_preco
        ,max(if(cd_campo_customizado = '3437915', cd_valor, null))       as dt_alteracao_preco
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,fg_alteracao_preco
        ,ds_tipo_alteracao_preco
        ,dt_alteracao_preco
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m21:58:40.653213 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6801a299-48bd-428b-ab28-38b3bb35361f&page=queryresults
[0m21:58:40.669377 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c2853314-e6cd-47eb-a630-de3ec2537776&page=queryresults
[0m21:58:41.087768 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 21:58:39.870194 => 21:58:41.087768
[0m21:58:41.087768 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE685E880>]}
[0m21:58:41.098430 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 21:58:39.838682 => 21:58:41.098430
[0m21:58:41.087768 [info ] [Thread-1  ]: 1 of 16 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m21:58:41.100442 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE685E640>]}
[0m21:58:41.100442 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m21:58:41.103529 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m21:58:41.103529 [info ] [Thread-2  ]: 2 of 16 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m21:58:41.107668 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m21:58:41.108161 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m21:58:41.105538 [info ] [Thread-1  ]: 3 of 16 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m21:58:41.111632 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m21:58:41.108161 [info ] [Thread-2  ]: 4 of 16 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m21:58:41.111632 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m21:58:41.111632 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_imagem_produto)
[0m21:58:41.111632 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m21:58:41.111632 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m21:58:41.123200 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m21:58:41.123200 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 21:58:41.111632 => 21:58:41.123200
[0m21:58:41.123200 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m21:58:41.127799 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m21:58:41.127799 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 21:58:41.111632 => 21:58:41.127799
[0m21:58:41.127799 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m21:58:41.127799 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m21:58:41.127799 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:58:41.127799 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m21:58:41.154547 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:58:41.154547 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m21:58:41.891056 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:05d1a42a-7ed2-430e-b804-b16c655a8751&page=queryresults
[0m21:58:41.929460 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b21b549c-809f-4841-a1cf-b20c4a64cc08&page=queryresults
[0m21:58:42.345380 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 21:58:41.127799 => 21:58:42.334714
[0m21:58:42.345380 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 21:58:41.123200 => 21:58:42.345380
[0m21:58:42.350481 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE68BCF70>]}
[0m21:58:42.350481 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE6931A60>]}
[0m21:58:42.350481 [info ] [Thread-2  ]: 4 of 16 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m21:58:42.350481 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m21:58:42.350481 [info ] [Thread-1  ]: 3 of 16 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m21:58:42.350481 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m21:58:42.350481 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m21:58:42.350481 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m21:58:42.350481 [info ] [Thread-2  ]: 5 of 16 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m21:58:42.366244 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m21:58:42.366244 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m21:58:42.350481 [info ] [Thread-1  ]: 6 of 16 START sql view model dbt_dw_stg.stg_pedido ............................. [RUN]
[0m21:58:42.373449 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_pedido)
[0m21:58:42.373449 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m21:58:42.387519 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m21:58:42.403068 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m21:58:42.406094 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 21:58:42.373449 => 21:58:42.405107
[0m21:58:42.406094 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m21:58:42.410694 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m21:58:42.410694 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 21:58:42.366244 => 21:58:42.410694
[0m21:58:42.410694 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m21:58:42.419285 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m21:58:42.421871 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:58:42.426435 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m21:58:42.474322 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:58:42.481019 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'Método de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m21:58:43.220815 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:79d0e1c2-fcfd-4886-bfe5-fa68342da44a&page=queryresults
[0m21:58:43.252438 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3b95a10d-8347-4b3d-8d2c-2247d00e268f&page=queryresults
[0m21:58:43.617511 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 21:58:42.410694 => 21:58:43.617511
[0m21:58:43.617511 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE6901190>]}
[0m21:58:43.633735 [info ] [Thread-2  ]: 5 of 16 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m21:58:43.633735 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m21:58:43.635990 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m21:58:43.635990 [info ] [Thread-2  ]: 7 of 16 START sql view model dbt_dw_stg.stg_produto ............................ [RUN]
[0m21:58:43.635990 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_produto)
[0m21:58:43.635990 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m21:58:43.635990 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m21:58:43.635990 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 21:58:43.635990 => 21:58:43.635990
[0m21:58:43.649526 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m21:58:43.655141 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m21:58:43.657433 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:58:43.657433 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m21:58:43.715963 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 21:58:42.406094 => 21:58:43.715963
[0m21:58:43.715963 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE6931F10>]}
[0m21:58:43.715963 [info ] [Thread-1  ]: 6 of 16 OK created sql view model dbt_dw_stg.stg_pedido ........................ [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m21:58:43.722212 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m21:58:43.724250 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m21:58:43.724250 [info ] [Thread-1  ]: 8 of 16 START sql view model dbt_dw_stg.stg_tempo .............................. [RUN]
[0m21:58:43.724250 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_tempo)
[0m21:58:43.724250 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m21:58:43.724250 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m21:58:43.724250 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 21:58:43.724250 => 21:58:43.724250
[0m21:58:43.724250 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m21:58:43.748612 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m21:58:43.752200 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:58:43.756073 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m21:58:44.705522 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:083c9cd7-a76e-40e5-8ff7-f026cbd9ddc2&page=queryresults
[0m21:58:44.752626 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4e16877a-d0d3-4012-adea-f954e646a1f8&page=queryresults
[0m21:58:45.064451 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 21:58:43.649526 => 21:58:45.064451
[0m21:58:45.064451 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE684DC10>]}
[0m21:58:45.080165 [info ] [Thread-2  ]: 7 of 16 OK created sql view model dbt_dw_stg.stg_produto ....................... [[32mCREATE VIEW (0 processed)[0m in 1.43s]
[0m21:58:45.080165 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m21:58:45.080165 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m21:58:45.080165 [info ] [Thread-2  ]: 9 of 16 START sql table model dbt_dw_dw.dm_produto ............................. [RUN]
[0m21:58:45.085241 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m21:58:45.085241 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m21:58:45.085241 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m21:58:45.085241 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 21:58:45.085241 => 21:58:45.085241
[0m21:58:45.085241 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m21:58:45.114220 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:58:45.224171 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 21:58:43.724250 => 21:58:45.224171
[0m21:58:45.224171 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE688A6A0>]}
[0m21:58:45.224171 [info ] [Thread-1  ]: 8 of 16 OK created sql view model dbt_dw_stg.stg_tempo ......................... [[32mCREATE VIEW (0 processed)[0m in 1.50s]
[0m21:58:45.224171 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m21:58:45.896179 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m21:58:45.902923 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m21:58:46.569462 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1d4f0ef2-208e-4dda-a7ef-69693589967b&page=queryresults
[0m21:58:49.154035 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 21:58:45.096299 => 21:58:49.154035
[0m21:58:49.154035 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE68DDC70>]}
[0m21:58:49.154035 [info ] [Thread-2  ]: 9 of 16 OK created sql table model dbt_dw_dw.dm_produto ........................ [[32mCREATE TABLE (352.0 rows, 1.4 MiB processed)[0m in 4.07s]
[0m21:58:49.168409 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m21:58:49.171338 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m21:58:49.171338 [info ] [Thread-1  ]: 10 of 16 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m21:58:49.171338 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m21:58:49.171338 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m21:58:49.171338 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m21:58:49.171338 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 21:58:49.171338 => 21:58:49.171338
[0m21:58:49.184772 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m21:58:49.190024 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:58:50.147564 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m21:58:50.147564 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_alteracao_preco
          ,ds_tipo_alteracao_preco
          ,dt_alteracao_preco
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_join_campos_imagens as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_alteracao_preco
          ,b.ds_tipo_alteracao_preco
          ,b.dt_alteracao_preco
          ,b.vl_alteracao_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling     
)

  select *
    from cte_join_campos_imagens
order by nm_produto_completo
    );
  
[0m21:58:50.840923 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:85704573-3083-4b39-b272-64a5300785f0&page=queryresults
[0m21:58:52.786012 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 21:58:49.184772 => 21:58:52.786012
[0m21:58:52.786012 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE693C850>]}
[0m21:58:52.786012 [info ] [Thread-1  ]: 10 of 16 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (352.0 rows, 1.9 MiB processed)[0m in 3.61s]
[0m21:58:52.786012 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m21:58:52.786012 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:58:52.786012 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m21:58:52.786012 [info ] [Thread-2  ]: 11 of 16 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m21:58:52.786012 [info ] [Thread-1  ]: 12 of 16 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m21:58:52.801976 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m21:58:52.802735 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_pedido)
[0m21:58:52.804781 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m21:58:52.805549 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m21:58:52.809036 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m21:58:52.825926 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 21:58:52.806678 => 21:58:52.825926
[0m21:58:52.832510 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m21:58:52.840632 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m21:58:52.851436 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:58:52.906004 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 21:58:52.815747 => 21:58:52.906004
[0m21:58:52.906004 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m21:58:52.906004 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:58:53.568348 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m21:58:53.572828 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m21:58:53.577511 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m21:58:53.577511 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m21:58:54.255198 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f243c431-b5b5-4560-9ca4-d88cd8365e3e&page=queryresults
[0m21:58:54.255198 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a21416f5-5831-46ee-98fa-d5482dbeb114&page=queryresults
[0m21:58:56.533637 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 21:58:52.840632 => 21:58:56.533637
[0m21:58:56.533637 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE688A790>]}
[0m21:58:56.533637 [info ] [Thread-2  ]: 11 of 16 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.5 KiB processed)[0m in 3.75s]
[0m21:58:56.533637 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:58:57.047417 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 21:58:52.906004 => 21:58:57.047417
[0m21:58:57.047417 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE69DB6A0>]}
[0m21:58:57.047417 [info ] [Thread-1  ]: 12 of 16 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.24s]
[0m21:58:57.056566 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m21:58:57.056566 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m21:58:57.056566 [info ] [Thread-2  ]: 13 of 16 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m21:58:57.063370 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_venda_produto_final)
[0m21:58:57.067031 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m21:58:57.075689 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m21:58:57.077203 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 21:58:57.067031 => 21:58:57.077203
[0m21:58:57.079216 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m21:58:57.084885 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:58:57.750523 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m21:58:57.752538 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m21:58:58.115663 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7ddac92e-07e8-4270-8a6b-8b3a168976be&page=queryresults
[0m21:59:00.148640 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 21:58:57.079216 => 21:59:00.148640
[0m21:59:00.148640 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE68D3130>]}
[0m21:59:00.148640 [info ] [Thread-2  ]: 13 of 16 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 414.7 KiB processed)[0m in 3.09s]
[0m21:59:00.148640 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m21:59:00.148640 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m21:59:00.148640 [info ] [Thread-1  ]: 14 of 16 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m21:59:00.148640 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m21:59:00.148640 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m21:59:00.166332 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m21:59:00.171077 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 21:59:00.148640 => 21:59:00.169604
[0m21:59:00.171077 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m21:59:00.181464 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:59:00.860921 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m21:59:00.864721 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m21:59:01.206978 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c906f3cc-a030-4e50-acd0-08297228b552&page=queryresults
[0m21:59:03.497500 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 21:59:00.172894 => 21:59:03.497500
[0m21:59:03.497500 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE69DB1C0>]}
[0m21:59:03.497500 [info ] [Thread-1  ]: 14 of 16 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 287.5 KiB processed)[0m in 3.35s]
[0m21:59:03.497500 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m21:59:03.504304 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m21:59:03.505816 [info ] [Thread-2  ]: 15 of 16 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m21:59:03.505816 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m21:59:03.508892 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m21:59:03.520770 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m21:59:03.520770 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 21:59:03.510847 => 21:59:03.520770
[0m21:59:03.526246 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m21:59:03.534560 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:59:04.196674 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m21:59:04.196674 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m21:59:04.587406 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d13ea7dc-892a-4b07-9da7-b2041a5c1647&page=queryresults
[0m21:59:07.277532 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 21:59:03.526246 => 21:59:07.277532
[0m21:59:07.291048 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE69DB6A0>]}
[0m21:59:07.291048 [info ] [Thread-2  ]: 15 of 16 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 123.2 KiB processed)[0m in 3.79s]
[0m21:59:07.291048 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m21:59:07.291048 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m21:59:07.291048 [info ] [Thread-1  ]: 16 of 16 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m21:59:07.291048 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_estoque_produto_base)
[0m21:59:07.301179 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m21:59:07.312339 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m21:59:07.316760 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 21:59:07.302241 => 21:59:07.314732
[0m21:59:07.316760 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m21:59:07.318776 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:59:08.005219 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m21:59:08.007234 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m21:59:08.684773 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c0e22faa-7cc5-450f-8343-20b9a87a69bb&page=queryresults
[0m21:59:12.677130 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 21:59:07.318776 => 21:59:12.677130
[0m21:59:12.677130 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f1224c16-66be-41a0-822b-fe04a73e3570', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE58192B0>]}
[0m21:59:12.677130 [info ] [Thread-1  ]: 16 of 16 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 5.39s]
[0m21:59:12.677130 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m21:59:12.686238 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:59:12.686238 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:59:12.686238 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:59:12.686238 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m21:59:12.686238 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:59:12.686238 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m21:59:12.686238 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m21:59:12.686238 [info ] [MainThread]: 
[0m21:59:12.696897 [info ] [MainThread]: Finished running 8 view models, 8 table models in 0 hours 0 minutes and 36.23 seconds (36.23s).
[0m21:59:12.696897 [debug] [MainThread]: Command end result
[0m21:59:12.846064 [info ] [MainThread]: 
[0m21:59:12.846064 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:59:12.846064 [info ] [MainThread]: 
[0m21:59:12.846064 [info ] [MainThread]: Done. PASS=16 WARN=0 ERROR=0 SKIP=0 TOTAL=16
[0m21:59:12.846064 [debug] [MainThread]: Command `dbt run` succeeded at 21:59:12.846064 after 37.48 seconds
[0m21:59:12.846064 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE1CF2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE576E220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017CE510A9D0>]}
[0m21:59:12.846064 [debug] [MainThread]: Flushing usage events
[0m22:24:55.038389 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001657E582430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001657D5209D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001657D520B80>]}


============================== 22:24:55.045103 | e242352f-a347-4ec1-b613-ec2d6e0a9b59 ==============================
[0m22:24:55.045103 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:24:55.047454 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_hist_preco_custo_produto', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:24:55.771262 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e242352f-a347-4ec1-b613-ec2d6e0a9b59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001657D50C130>]}
[0m22:24:55.869591 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e242352f-a347-4ec1-b613-ec2d6e0a9b59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001657D4E0F40>]}
[0m22:24:55.869591 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:24:55.877649 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:24:55.997924 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:24:55.999931 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\Históricas\tb_hist_preco_custo_produto.sql
[0m22:24:56.137810 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e242352f-a347-4ec1-b613-ec2d6e0a9b59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000165020C8B20>]}
[0m22:24:56.156553 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e242352f-a347-4ec1-b613-ec2d6e0a9b59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016501CCF490>]}
[0m22:24:56.156553 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:24:56.156553 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e242352f-a347-4ec1-b613-ec2d6e0a9b59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016501F1D0A0>]}
[0m22:24:56.156553 [info ] [MainThread]: 
[0m22:24:56.156553 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:24:56.164935 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:24:56.164935 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:24:57.021042 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m22:24:57.021042 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:24:57.021042 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:24:57.021042 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:24:57.714729 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m22:24:57.714729 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:24:57.720146 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m22:24:57.720146 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:24:58.400081 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e242352f-a347-4ec1-b613-ec2d6e0a9b59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016501BE0070>]}
[0m22:24:58.400081 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:24:58.405975 [info ] [MainThread]: 
[0m22:24:58.405975 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:24:58.405975 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m22:24:58.405975 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m22:24:58.405975 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:24:58.423655 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m22:24:58.423655 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 22:24:58.405975 => 22:24:58.423655
[0m22:24:58.423655 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:24:58.445543 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:24:59.116577 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m22:24:59.116577 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_fim_vigencia asc) as nr_linha
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m22:24:59.604478 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d760b4e9-7484-4eac-b21d-b4a3f8d728ba&page=queryresults
[0m22:25:00.105984 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: dt_fim_vigencia at [35:70]')
[0m22:25:01.323068 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9ddeee1a-2e15-4961-85c4-1de9a5727c89&page=queryresults
[0m22:25:01.743590 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9ddeee1a-2e15-4961-85c4-1de9a5727c89&page=queryresults
[0m22:25:01.743590 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 22:24:58.428341 => 22:25:01.743590
[0m22:25:02.072271 [debug] [Thread-1  ]: Database Error in model tb_hist_preco_custo_produto (models\3.az\Históricas\tb_hist_preco_custo_produto.sql)
  Unrecognized name: dt_fim_vigencia at [35:70]
  compiled Code at target\run\shibaribrasil\models\3.az\Históricas\tb_hist_preco_custo_produto.sql
[0m22:25:02.072271 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e242352f-a347-4ec1-b613-ec2d6e0a9b59', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016503139FA0>]}
[0m22:25:02.074285 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_hist_preco_custo_produto .... [[31mERROR[0m in 3.67s]
[0m22:25:02.074285 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:25:02.074285 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:25:02.074285 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:25:02.074285 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:25:02.079890 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:25:02.079890 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m22:25:02.079890 [info ] [MainThread]: 
[0m22:25:02.079890 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.92 seconds (5.92s).
[0m22:25:02.082253 [debug] [MainThread]: Command end result
[0m22:25:02.105715 [info ] [MainThread]: 
[0m22:25:02.105715 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:25:02.105715 [info ] [MainThread]: 
[0m22:25:02.105715 [error] [MainThread]:   Database Error in model tb_hist_preco_custo_produto (models\3.az\Históricas\tb_hist_preco_custo_produto.sql)
  Unrecognized name: dt_fim_vigencia at [35:70]
  compiled Code at target\run\shibaribrasil\models\3.az\Históricas\tb_hist_preco_custo_produto.sql
[0m22:25:02.105715 [info ] [MainThread]: 
[0m22:25:02.105715 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:25:02.105715 [debug] [MainThread]: Command `dbt run` failed at 22:25:02.105715 after 7.15 seconds
[0m22:25:02.105715 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001657E582430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016501F35A30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016501C029D0>]}
[0m22:25:02.114003 [debug] [MainThread]: Flushing usage events
[0m22:25:46.884707 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D824535400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D8234B2640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D8234B2AC0>]}


============================== 22:25:46.888436 | 41d699ab-3424-4d33-8296-fc80faf6deee ==============================
[0m22:25:46.888436 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:25:46.890695 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_hist_preco_custo_produto', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m22:25:47.482794 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '41d699ab-3424-4d33-8296-fc80faf6deee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D8234B7190>]}
[0m22:25:47.577312 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '41d699ab-3424-4d33-8296-fc80faf6deee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D827BA4AF0>]}
[0m22:25:47.577312 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:25:47.595890 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:25:47.692113 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:25:47.692113 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\Históricas\tb_hist_preco_custo_produto.sql
[0m22:25:47.835316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '41d699ab-3424-4d33-8296-fc80faf6deee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D828016E80>]}
[0m22:25:47.851087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '41d699ab-3424-4d33-8296-fc80faf6deee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D827E6C3A0>]}
[0m22:25:47.851087 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:25:47.851087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '41d699ab-3424-4d33-8296-fc80faf6deee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D827AF52E0>]}
[0m22:25:47.851087 [info ] [MainThread]: 
[0m22:25:47.851087 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:25:47.851087 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:25:47.851087 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:25:48.625727 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:25:48.627742 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:25:48.629509 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:25:48.629509 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:25:49.437071 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m22:25:49.437071 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m22:25:49.437071 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:25:49.437071 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:25:50.184800 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '41d699ab-3424-4d33-8296-fc80faf6deee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D827E5DBE0>]}
[0m22:25:50.187963 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:25:50.192113 [info ] [MainThread]: 
[0m22:25:50.192113 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:25:50.192113 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m22:25:50.208021 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m22:25:50.208021 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:25:50.208021 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m22:25:50.208021 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 22:25:50.208021 => 22:25:50.208021
[0m22:25:50.208021 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:25:50.240057 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:25:50.918565 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m22:25:50.920572 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dbt_valid_to asc) as nr_linha
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

  select *
    from cte_snapshot
order by nm_produto
        ,ds_variacao
    );
  
[0m22:25:51.698100 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0a0a53da-41b3-47f2-9166-8d1cbf13841a&page=queryresults
[0m22:25:54.761010 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 22:25:50.208021 => 22:25:54.761010
[0m22:25:54.763024 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41d699ab-3424-4d33-8296-fc80faf6deee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D829045EE0>]}
[0m22:25:54.765040 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (388.0 rows, 58.1 KiB processed)[0m in 4.56s]
[0m22:25:54.765040 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:25:54.765040 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:25:54.773335 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:25:54.773335 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:25:54.773335 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m22:25:54.773335 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m22:25:54.773335 [info ] [MainThread]: 
[0m22:25:54.791134 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.92 seconds (6.92s).
[0m22:25:54.799201 [debug] [MainThread]: Command end result
[0m22:25:54.884846 [info ] [MainThread]: 
[0m22:25:54.884846 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:25:54.884846 [info ] [MainThread]: 
[0m22:25:54.884846 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:25:54.900696 [debug] [MainThread]: Command `dbt run` succeeded at 22:25:54.900696 after 8.10 seconds
[0m22:25:54.900696 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D824535400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D8221B86D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002D827E85D90>]}
[0m22:25:54.900696 [debug] [MainThread]: Flushing usage events
[0m22:34:06.252920 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DBE9C6460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DBD949A30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DBD949D60>]}


============================== 22:34:06.252920 | 01783d91-ecdc-4751-9ecb-b7557e8c3ee5 ==============================
[0m22:34:06.252920 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:34:06.252920 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --models tb_hist_preco_custo_produto', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:34:06.934943 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '01783d91-ecdc-4751-9ecb-b7557e8c3ee5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DBD937040>]}
[0m22:34:07.054513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '01783d91-ecdc-4751-9ecb-b7557e8c3ee5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DC1F45C40>]}
[0m22:34:07.055714 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:34:07.058472 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:34:07.190677 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:34:07.190677 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\Históricas\tb_hist_preco_custo_produto.sql
[0m22:34:07.355957 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '01783d91-ecdc-4751-9ecb-b7557e8c3ee5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DC24A8C40>]}
[0m22:34:07.372409 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '01783d91-ecdc-4751-9ecb-b7557e8c3ee5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DC22FC1F0>]}
[0m22:34:07.372409 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:34:07.372409 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '01783d91-ecdc-4751-9ecb-b7557e8c3ee5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DC20FD910>]}
[0m22:34:07.375782 [info ] [MainThread]: 
[0m22:34:07.376996 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:34:07.378100 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:34:07.378100 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:34:08.271057 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:34:08.271057 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:34:08.271057 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:34:08.271057 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:34:08.986096 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m22:34:08.991554 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:34:08.991554 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m22:34:08.991554 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:34:10.123377 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '01783d91-ecdc-4751-9ecb-b7557e8c3ee5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DC1FBC130>]}
[0m22:34:10.123377 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:34:10.123377 [info ] [MainThread]: 
[0m22:34:10.133302 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:34:10.133302 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m22:34:10.141377 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m22:34:10.143390 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:34:10.151946 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m22:34:10.151946 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 22:34:10.143390 => 22:34:10.151946
[0m22:34:10.151946 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:34:10.172080 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:34:10.855688 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m22:34:10.855688 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dbt_valid_to asc) as nr_linha
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,if(b.cd_produto_bling is not null, true, false) fg_alteracao
     from cte_snapshot as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m22:34:11.446343 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6e3c2ab7-9931-4fe6-aa79-6843220c0255&page=queryresults
[0m22:34:11.960043 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Column name cd_produto_bling is ambiguous at [45:12]')
[0m22:34:12.773573 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ebc5a828-f44e-42b1-a97c-89640dc75926&page=queryresults
[0m22:34:13.190344 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ebc5a828-f44e-42b1-a97c-89640dc75926&page=queryresults
[0m22:34:13.192682 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 22:34:10.151946 => 22:34:13.190796
[0m22:34:13.202768 [debug] [Thread-1  ]: Database Error in model tb_hist_preco_custo_produto (models\3.az\Históricas\tb_hist_preco_custo_produto.sql)
  Column name cd_produto_bling is ambiguous at [45:12]
  compiled Code at target\run\shibaribrasil\models\3.az\Históricas\tb_hist_preco_custo_produto.sql
[0m22:34:13.204311 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '01783d91-ecdc-4751-9ecb-b7557e8c3ee5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DC35186D0>]}
[0m22:34:13.204311 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_hist_preco_custo_produto .... [[31mERROR[0m in 3.06s]
[0m22:34:13.204311 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:34:13.210188 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:34:13.210188 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:34:13.210188 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:34:13.210188 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m22:34:13.213703 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m22:34:13.213703 [info ] [MainThread]: 
[0m22:34:13.215432 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.84 seconds (5.84s).
[0m22:34:13.217764 [debug] [MainThread]: Command end result
[0m22:34:13.240530 [info ] [MainThread]: 
[0m22:34:13.240530 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:34:13.240530 [info ] [MainThread]: 
[0m22:34:13.240530 [error] [MainThread]:   Database Error in model tb_hist_preco_custo_produto (models\3.az\Históricas\tb_hist_preco_custo_produto.sql)
  Column name cd_produto_bling is ambiguous at [45:12]
  compiled Code at target\run\shibaribrasil\models\3.az\Históricas\tb_hist_preco_custo_produto.sql
[0m22:34:13.248585 [info ] [MainThread]: 
[0m22:34:13.248585 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:34:13.251375 [debug] [MainThread]: Command `dbt run` failed at 22:34:13.248585 after 7.08 seconds
[0m22:34:13.251375 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DBE9C6460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DC1F45C40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021DBC6486D0>]}
[0m22:34:13.251375 [debug] [MainThread]: Flushing usage events
[0m22:34:28.239663 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209569F6400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020955978640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020955978AC0>]}


============================== 22:34:28.239663 | d15cbde2-7ced-493d-98f9-7a696c4f5f7d ==============================
[0m22:34:28.239663 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:34:28.239663 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_hist_preco_custo_produto', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:34:28.965572 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd15cbde2-7ced-493d-98f9-7a696c4f5f7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020955978850>]}
[0m22:34:29.064345 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd15cbde2-7ced-493d-98f9-7a696c4f5f7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020959FA3130>]}
[0m22:34:29.064345 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:34:29.080234 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:34:29.198304 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:34:29.198304 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\Históricas\tb_hist_preco_custo_produto.sql
[0m22:34:29.355492 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd15cbde2-7ced-493d-98f9-7a696c4f5f7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002095A4E7940>]}
[0m22:34:29.371247 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd15cbde2-7ced-493d-98f9-7a696c4f5f7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002095A0D1850>]}
[0m22:34:29.371247 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:34:29.371247 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd15cbde2-7ced-493d-98f9-7a696c4f5f7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002095A0D1520>]}
[0m22:34:29.373784 [info ] [MainThread]: 
[0m22:34:29.375790 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:34:29.375790 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:34:29.375790 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:34:30.086141 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:34:30.086141 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:34:30.086141 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:34:30.126370 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:34:30.738744 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m22:34:30.746772 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:34:30.786675 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m22:34:30.786675 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:34:31.520587 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd15cbde2-7ced-493d-98f9-7a696c4f5f7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002095A0A4370>]}
[0m22:34:31.520587 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:34:31.520587 [info ] [MainThread]: 
[0m22:34:31.527477 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:34:31.527477 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m22:34:31.535357 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m22:34:31.535357 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:34:31.550023 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m22:34:31.550023 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 22:34:31.536925 => 22:34:31.550023
[0m22:34:31.551772 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:34:31.565888 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:34:32.252122 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m22:34:32.252122 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dbt_valid_to asc) as nr_linha
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,if(b.cd_produto_bling is not null, true, false) fg_alteracao
     from cte_snapshot as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m22:34:32.835121 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:05a52c77-30b8-440b-b7fe-d5254a09d20e&page=queryresults
[0m22:34:34.947136 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 22:34:31.551772 => 22:34:34.947136
[0m22:34:34.947136 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd15cbde2-7ced-493d-98f9-7a696c4f5f7d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002095A53B9A0>]}
[0m22:34:34.949143 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (388.0 rows, 58.1 KiB processed)[0m in 3.42s]
[0m22:34:34.949143 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:34:34.949143 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:34:34.949143 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:34:34.949143 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:34:34.949143 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m22:34:34.949143 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m22:34:34.949143 [info ] [MainThread]: 
[0m22:34:34.949143 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.58 seconds (5.58s).
[0m22:34:34.955684 [debug] [MainThread]: Command end result
[0m22:34:34.978681 [info ] [MainThread]: 
[0m22:34:34.978681 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:34:34.978681 [info ] [MainThread]: 
[0m22:34:34.978681 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:34:34.978681 [debug] [MainThread]: Command `dbt run` succeeded at 22:34:34.978681 after 6.82 seconds
[0m22:34:34.978681 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000209569F6400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020954A786D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002095A355850>]}
[0m22:34:34.992690 [debug] [MainThread]: Flushing usage events
[0m22:35:21.405236 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001842790C460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184268929A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018426892D30>]}


============================== 22:35:21.413599 | 9a2a73c5-8846-43c2-82f2-d5ac95b2e156 ==============================
[0m22:35:21.413599 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:35:21.413599 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_hist_preco_custo_produto', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:35:22.070737 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9a2a73c5-8846-43c2-82f2-d5ac95b2e156', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000184268859D0>]}
[0m22:35:22.174199 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9a2a73c5-8846-43c2-82f2-d5ac95b2e156', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001842AE83520>]}
[0m22:35:22.174199 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:35:22.181898 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:35:22.281701 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:35:22.281701 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\Históricas\tb_hist_preco_custo_produto.sql
[0m22:35:22.425270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9a2a73c5-8846-43c2-82f2-d5ac95b2e156', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001842B3F8B50>]}
[0m22:35:22.441087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9a2a73c5-8846-43c2-82f2-d5ac95b2e156', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001842AF0D9A0>]}
[0m22:35:22.441087 [info ] [MainThread]: Found 21 models, 1 snapshot, 11 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:35:22.441087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9a2a73c5-8846-43c2-82f2-d5ac95b2e156', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001842AFB2FA0>]}
[0m22:35:22.441087 [info ] [MainThread]: 
[0m22:35:22.452422 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:35:22.452422 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:35:22.452422 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:35:23.233727 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:35:23.233727 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:35:23.233727 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:35:23.233727 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:35:23.945706 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m22:35:23.945706 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:35:23.945706 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m22:35:23.945706 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:35:24.675623 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9a2a73c5-8846-43c2-82f2-d5ac95b2e156', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001842B048A30>]}
[0m22:35:24.675623 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:35:24.675623 [info ] [MainThread]: 
[0m22:35:24.675623 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:35:24.675623 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m22:35:24.686675 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m22:35:24.686675 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:35:24.693734 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m22:35:24.693734 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 22:35:24.689190 => 22:35:24.693734
[0m22:35:24.702516 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:35:24.718319 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:35:25.516230 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m22:35:25.518237 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,date(dbt_valid_from, "America/Sao_Paulo")     as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")     as hr_ini_vigencia
          ,date(dbt_valid_to, "America/Sao_Paulo")       as dt_fim_vigencia
          ,time(dbt_valid_to, "America/Sao_Paulo")       as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo") as dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dbt_valid_to asc) as nr_linha
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false) fg_alteracao
     from cte_snapshot as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m22:35:25.996901 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:90582d7f-4aa4-4261-ba22-87f577a02dde&page=queryresults
[0m22:35:28.723113 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 22:35:24.703243 => 22:35:28.723113
[0m22:35:28.723113 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9a2a73c5-8846-43c2-82f2-d5ac95b2e156', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001842C428C40>]}
[0m22:35:28.739217 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (388.0 rows, 58.1 KiB processed)[0m in 4.05s]
[0m22:35:28.739217 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m22:35:28.739217 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:35:28.739217 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:35:28.739217 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:35:28.739217 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m22:35:28.739217 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m22:35:28.739217 [info ] [MainThread]: 
[0m22:35:28.739217 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.29 seconds (6.29s).
[0m22:35:28.739217 [debug] [MainThread]: Command end result
[0m22:35:28.773662 [info ] [MainThread]: 
[0m22:35:28.773662 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:35:28.773662 [info ] [MainThread]: 
[0m22:35:28.773662 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:35:28.780140 [debug] [MainThread]: Command `dbt run` succeeded at 22:35:28.780140 after 7.45 seconds
[0m22:35:28.782147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001842790C460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001842AF0D9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001842B265A60>]}
[0m22:35:28.782147 [debug] [MainThread]: Flushing usage events
