[0m11:01:53.744747 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: select * from (
        

    with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

[0m11:01:54.304301 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fd588e3b-57b4-4d9e-a80d-4d4c93be7994&page=queryresults
[0m11:01:54.521101 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: select * from (
        select 
    current_timestamp()
 as dbt_snapshot_time
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

[0m11:01:54.850784 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:571c1011-38aa-4e52-b118-a9c6896d171f&page=queryresults
[0m11:01:55.045294 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m11:01:55.049709 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.8.7", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m11:01:55.439167 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:02ec7caf-45df-4827-976c-1720882cd4de&page=queryresults
[0m11:01:57.393973 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0fa19a5-8207-4e26-ad0f-2c8c51f99cf9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C9B6F4F10>]}
[0m11:01:57.396971 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 365.2 KiB processed)[0m in 9.11s]
[0m11:01:57.399313 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:01:57.402330 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:01:57.403421 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:01:57.404426 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m11:01:57.405417 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m11:01:57.406423 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m11:01:57.407318 [info ] [MainThread]: 
[0m11:01:57.408315 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 11.49 seconds (11.49s).
[0m11:01:57.411575 [debug] [MainThread]: Command end result
[0m11:01:57.456042 [info ] [MainThread]: 
[0m11:01:57.457035 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:01:57.458167 [info ] [MainThread]: 
[0m11:01:57.459033 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m11:01:57.461164 [debug] [MainThread]: Command `dbt snapshot` succeeded at 11:01:57.460142 after 14.95 seconds
[0m11:01:57.461164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023CFE6C5A60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C80013520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023C9B296D60>]}
[0m11:01:57.461164 [debug] [MainThread]: Flushing usage events
[0m11:02:02.834671 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CDB697CFA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CDB616A250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CDB9DC8F70>]}


============================== 11:02:02.841692 | 05572ea4-0586-4267-a5e0-a704af6a0a69 ==============================
[0m11:02:02.841692 [info ] [MainThread]: Running with dbt=1.8.7
[0m11:02:02.842661 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m11:02:05.463069 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '05572ea4-0586-4267-a5e0-a704af6a0a69', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CDD2DADBE0>]}
[0m11:02:05.499269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '05572ea4-0586-4267-a5e0-a704af6a0a69', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CDB9E01B80>]}
[0m11:02:05.500279 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m11:02:05.507279 [debug] [MainThread]: checksum: 4af21dafb485259c48497ac86b711ddb1982f3d0f1c0ca4e09356de488b753c0, vars: {}, profile: , target: , version: 1.8.7
[0m11:02:05.669505 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:02:05.669505 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:02:05.675514 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.shibaribrasil.2.dw
[0m11:02:05.760164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '05572ea4-0586-4267-a5e0-a704af6a0a69', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CDD2D59850>]}
[0m11:02:05.902324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '05572ea4-0586-4267-a5e0-a704af6a0a69', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CDB829EB20>]}
[0m11:02:05.903300 [info ] [MainThread]: Found 40 models, 1 snapshot, 15 sources, 479 macros
[0m11:02:05.904313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '05572ea4-0586-4267-a5e0-a704af6a0a69', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CDB7839460>]}
[0m11:02:05.905326 [info ] [MainThread]: 
[0m11:02:05.906317 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:02:05.916340 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:02:05.918100 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:02:06.713902 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m11:02:06.715914 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:02:06.718913 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m11:02:06.720908 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:02:07.406207 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m11:02:07.417914 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:02:08.078494 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '05572ea4-0586-4267-a5e0-a704af6a0a69', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CDD33BD7C0>]}
[0m11:02:08.080564 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:02:08.082596 [info ] [MainThread]: 
[0m11:02:08.094119 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:02:08.096141 [info ] [Thread-1  ]: 1 of 3 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m11:02:08.099168 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m11:02:08.101116 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:02:08.123548 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m11:02:08.125483 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:02:08.162565 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:02:08.854043 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m11:02:08.855047 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.8.7", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(nullif(vl_custo_ultima_compra,0), vl_custo_cadastro) vl_custo_final
          ,coalesce(nullif(vl_preco_venda_por,0), vl_preco_venda)        vl_preco_final
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select cd_produto_bling, count(distinct nr_linha) 
    from cte_snapshot
  group by cd_produto_bling
  having count(distinct nr_linha) > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_final, 0)         as vl_custo_final
          ,coalesce(a.vl_preco_final, 0)         as vl_preco_final
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_final)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_final_anterior
          ,lead(a.vl_preco_final)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_final_anterior
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m11:02:09.385521 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0f511b5c-bbb2-44a3-a77f-cfedc3af80b5&page=queryresults
[0m11:02:13.769288 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '05572ea4-0586-4267-a5e0-a704af6a0a69', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CDD384C700>]}
[0m11:02:13.770403 [info ] [Thread-1  ]: 1 of 3 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (1.6k rows, 313.1 KiB processed)[0m in 5.67s]
[0m11:02:13.771397 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:02:13.773403 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m11:02:13.775406 [info ] [Thread-2  ]: 2 of 3 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m11:02:13.777411 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m11:02:13.778406 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m11:02:13.783398 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m11:02:13.784400 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m11:02:13.787397 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m11:02:14.441933 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m11:02:14.443924 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.8.7", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_final
          ,vl_preco_final
          ,fg_alteracao
          ,vl_custo_final_anterior
          ,vl_preco_final_anterior
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_final_anterior
          ,b.vl_preco_final_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco                as a
 left join cte_hist                 as b 
        on a.cd_produto_bling = b.cd_produto_bling
     where a.ds_tipo_produto not in ('PAI')
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m11:02:14.793736 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3145f6ac-0b06-4ab8-980b-cb5fb85e01ef&page=queryresults
[0m11:02:16.706069 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '05572ea4-0586-4267-a5e0-a704af6a0a69', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CDB824DEE0>]}
[0m11:02:16.709070 [info ] [Thread-2  ]: 2 of 3 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (332.0 rows, 152.9 KiB processed)[0m in 2.93s]
[0m11:02:16.712068 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m11:02:16.715070 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_analitico
[0m11:02:16.717068 [info ] [Thread-1  ]: 3 of 3 START sql table model dbt_dw_az.tb_preco_analitico ...................... [RUN]
[0m11:02:16.719518 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_hist_preco_custo_produto, now model.shibaribrasil.tb_preco_analitico)
[0m11:02:16.721514 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_analitico
[0m11:02:16.736517 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_analitico"
[0m11:02:16.739040 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_analitico
[0m11:02:16.743999 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:02:17.429880 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_analitico"
[0m11:02:17.430919 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_analitico: /* {"app": "dbt", "dbt_version": "1.8.7", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_analitico"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_analitico`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.vl_custo_final_anterior
          ,a.vl_preco_final_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,a.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,a.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`    as a
)

, cte_estoque as (
    select a.cd_produto_bling
          ,a.qt_estoque_atual
          ,a.ds_classificacao_risco
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_analitico` as a  
)

   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.vl_custo_final_anterior
          ,a.vl_preco_final_anterior
          ,b.qt_estoque_atual
          ,b.ds_classificacao_risco
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,a.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,a.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco   as a
 left join cte_estoque as b
        on a.cd_produto_bling = b.cd_produto_bling
    );
  
[0m11:02:17.777670 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9d0c9dae-7ad7-4158-97cc-e72802f6bb7b&page=queryresults
[0m11:02:19.667627 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '05572ea4-0586-4267-a5e0-a704af6a0a69', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CDD384C0D0>]}
[0m11:02:19.669575 [info ] [Thread-1  ]: 3 of 3 OK created sql table model dbt_dw_az.tb_preco_analitico ................. [[32mCREATE TABLE (332.0 rows, 106.8 KiB processed)[0m in 2.95s]
[0m11:02:19.671653 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_analitico
[0m11:02:19.674581 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:02:19.675653 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:02:19.676657 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m11:02:19.677654 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m11:02:19.678651 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_analitico' was properly closed.
[0m11:02:19.679530 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m11:02:19.680603 [info ] [MainThread]: 
[0m11:02:19.682674 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 13.77 seconds (13.77s).
[0m11:02:19.686665 [debug] [MainThread]: Command end result
[0m11:02:19.785201 [info ] [MainThread]: 
[0m11:02:19.786137 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:02:19.786137 [info ] [MainThread]: 
[0m11:02:19.787141 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m11:02:19.788624 [debug] [MainThread]: Command `dbt run` succeeded at 11:02:19.788624 after 17.03 seconds
[0m11:02:19.788624 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CDB697CFA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CDB8270490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CDB9BFEC70>]}
[0m11:02:19.789671 [debug] [MainThread]: Flushing usage events
