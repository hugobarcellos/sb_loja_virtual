[0m14:03:41.195110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC4C7F13D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC4F1603D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC4B77BD30>]}


============================== 14:03:41.203622 | 2fd4bc1e-9a8e-4940-acf9-047ac4413aab ==============================
[0m14:03:41.203622 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:03:41.203622 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Users\\HTK1511\\.dbt', 'log_path': 'logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt init dbt_shibaribrasil', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:03:41.203622 [debug] [MainThread]: Starter project path: c:\users\htk1511\appdata\local\programs\python\python38\lib\site-packages\dbt\include\starter_project
[0m14:03:41.236090 [info ] [MainThread]: 
Your new dbt project "dbt_shibaribrasil" was created!

For more information on how to configure the profiles.yml file,
please consult the dbt documentation here:

  https://docs.getdbt.com/docs/configure-your-profile

One more thing:

Need help? Don't hesitate to reach out to us via GitHub issues or on Slack:

  https://community.getdbt.com/

Happy modeling!

[0m14:03:41.236090 [info ] [MainThread]: Setting up your profile.
[0m14:04:41.944399 [info ] [MainThread]: Profile dbt_shibaribrasil written to C:\Users\HTK1511\.dbt\profiles.yml using target's profile_template.yml and your supplied values. Run 'dbt debug' to validate the connection.
[0m14:04:41.944399 [debug] [MainThread]: Command `dbt init` succeeded at 14:04:41.944399 after 60.81 seconds
[0m14:04:41.944399 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC4C7F13D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC4B7508B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC4B750DF0>]}
[0m14:04:41.950169 [debug] [MainThread]: Flushing usage events
[0m14:11:10.949386 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E78A4A24C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E78CE0E3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E78944CD60>]}


============================== 14:11:10.952387 | 54353fcf-58fa-4091-9db5-d2dcf888f2ed ==============================
[0m14:11:10.952387 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:11:10.953736 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'logs', 'profiles_dir': 'C:\\Users\\HTK1511\\.dbt', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt debug', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m14:11:10.954248 [info ] [MainThread]: dbt version: 1.7.4
[0m14:11:10.954811 [info ] [MainThread]: python version: 3.8.10
[0m14:11:10.954811 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m14:11:10.954811 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m14:11:11.306482 [info ] [MainThread]: Using profiles dir at C:\Users\HTK1511\.dbt
[0m14:11:11.306482 [info ] [MainThread]: Using profiles.yml file at C:\Users\HTK1511\.dbt\profiles.yml
[0m14:11:11.307513 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_shibaribrasil\dbt_project.yml
[0m14:11:11.307513 [error] [MainThread]: Encountered an error:
Internal Error
  Profile should not be None if loading profile completed
[0m14:11:11.308487 [debug] [MainThread]: Command `dbt debug` failed at 14:11:11.308487 after 0.43 seconds
[0m14:11:11.308487 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E78A4A24C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E78DA578B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E78DA7FFA0>]}
[0m14:11:11.309503 [debug] [MainThread]: Flushing usage events
[0m15:43:11.741179 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B195AB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B185396A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B18539DC0>]}


============================== 15:43:11.745929 | 426c619a-f98c-4bdc-9e81-72d4d3dab704 ==============================
[0m15:43:11.745929 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:43:11.746924 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:43:12.466269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '426c619a-f98c-4bdc-9e81-72d4d3dab704', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B1851C070>]}
[0m15:43:12.558209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '426c619a-f98c-4bdc-9e81-72d4d3dab704', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B1CB04160>]}
[0m15:43:12.560203 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:43:12.567318 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:43:12.572828 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:43:12.574336 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m15:43:12.575343 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '426c619a-f98c-4bdc-9e81-72d4d3dab704', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B1CCADC10>]}
[0m15:43:13.396026 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '426c619a-f98c-4bdc-9e81-72d4d3dab704', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B1D127BE0>]}
[0m15:43:13.407152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '426c619a-f98c-4bdc-9e81-72d4d3dab704', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B1D127EB0>]}
[0m15:43:13.408152 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:43:13.408152 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '426c619a-f98c-4bdc-9e81-72d4d3dab704', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B1CD09CD0>]}
[0m15:43:13.410151 [info ] [MainThread]: 
[0m15:43:13.410151 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:43:13.411658 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:43:13.412661 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:43:14.160451 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622, now create_igneous-sandbox-381622_dbt-dw)
[0m15:43:14.162041 [debug] [ThreadPool]: Creating schema "database: "igneous-sandbox-381622"
schema: "dbt-dw"
"
[0m15:43:14.182015 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:43:14.186021 [debug] [ThreadPool]: On create_igneous-sandbox-381622_dbt-dw: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "connection_name": "create_igneous-sandbox-381622_dbt-dw"} */
create schema if not exists `igneous-sandbox-381622`.`dbt-dw`
  
[0m15:43:15.064474 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:bce3ed58-690b-4f0a-b0ba-bac3200d71e1&page=queryresults
[0m15:43:15.588452 [debug] [ThreadPool]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Invalid dataset ID "dbt-dw". Dataset IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long.')
[0m15:43:16.611281 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:34effebe-41b5-41f5-afec-9775f5f60d81&page=queryresults
[0m15:43:17.118211 [error] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:34effebe-41b5-41f5-afec-9775f5f60d81&page=queryresults
[0m15:43:17.120258 [debug] [ThreadPool]: BigQuery adapter: Unhandled error while running:
macro create_schema
[0m15:43:17.120258 [debug] [ThreadPool]: BigQuery adapter: Database Error
  Invalid dataset ID "dbt-dw". Dataset IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long.
[0m15:43:17.122915 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:43:17.124439 [debug] [MainThread]: Connection 'create_igneous-sandbox-381622_dbt-dw' was properly closed.
[0m15:43:17.125458 [info ] [MainThread]: 
[0m15:43:17.126461 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 3.72 seconds (3.72s).
[0m15:43:17.127458 [error] [MainThread]: Encountered an error:
Database Error
  Invalid dataset ID "dbt-dw". Dataset IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long.
[0m15:43:17.128459 [debug] [MainThread]: Command `dbt run` failed at 15:43:17.128459 after 5.45 seconds
[0m15:43:17.129460 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B195AB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B1D11EF10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025B1CFD0190>]}
[0m15:43:17.129460 [debug] [MainThread]: Flushing usage events
[0m15:43:51.803945 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A48965460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A478E66A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A478E6DC0>]}


============================== 15:43:51.807971 | cef8ae93-7bf4-45d2-83da-892deadac52d ==============================
[0m15:43:51.807971 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:43:51.808968 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:43:52.319182 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cef8ae93-7bf4-45d2-83da-892deadac52d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4AAACB80>]}
[0m15:43:52.389132 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cef8ae93-7bf4-45d2-83da-892deadac52d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4B2A1370>]}
[0m15:43:52.390948 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:43:52.398160 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:43:52.428429 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:43:52.429043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'cef8ae93-7bf4-45d2-83da-892deadac52d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4C074E80>]}
[0m15:43:53.157971 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cef8ae93-7bf4-45d2-83da-892deadac52d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4C4D9AC0>]}
[0m15:43:53.167263 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cef8ae93-7bf4-45d2-83da-892deadac52d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4C4D9F70>]}
[0m15:43:53.168195 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:43:53.168195 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cef8ae93-7bf4-45d2-83da-892deadac52d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4C0B9D30>]}
[0m15:43:53.169193 [info ] [MainThread]: 
[0m15:43:53.170248 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:43:53.171689 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:43:53.172696 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:43:53.879897 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m15:43:53.881424 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:43:54.627113 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cef8ae93-7bf4-45d2-83da-892deadac52d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4C3AB0D0>]}
[0m15:43:54.629128 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:43:54.630113 [info ] [MainThread]: 
[0m15:43:54.639137 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m15:43:54.640136 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m15:43:54.641135 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m15:43:54.641639 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m15:43:54.706319 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m15:43:54.707319 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 15:43:54.641639 => 15:43:54.707319
[0m15:43:54.708320 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m15:43:54.741926 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m15:43:54.749456 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:43:54.751459 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:43:55.691953 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:b2bb7859-f3d0-404c-9f65-53b9cf1b3acd&page=queryresults
[0m15:43:55.695530 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:43:55.697877 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US

Location: US
Job ID: b2bb7859-f3d0-404c-9f65-53b9cf1b3acd

[0m15:43:55.699872 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 15:43:54.708320 => 15:43:55.698864
[0m15:43:56.171335 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: b2bb7859-f3d0-404c-9f65-53b9cf1b3acd
  
[0m15:43:56.171901 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cef8ae93-7bf4-45d2-83da-892deadac52d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4C3D07F0>]}
[0m15:43:56.174577 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 1.53s]
[0m15:43:56.177194 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m15:43:56.182777 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:43:56.184299 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:43:56.185327 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m15:43:56.186376 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m15:43:56.187328 [info ] [MainThread]: 
[0m15:43:56.190323 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.02 seconds (3.02s).
[0m15:43:56.192770 [debug] [MainThread]: Command end result
[0m15:43:56.224287 [info ] [MainThread]: 
[0m15:43:56.227373 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:43:56.231378 [info ] [MainThread]: 
[0m15:43:56.234514 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: b2bb7859-f3d0-404c-9f65-53b9cf1b3acd
  
[0m15:43:56.238696 [info ] [MainThread]: 
[0m15:43:56.241356 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:43:56.247995 [debug] [MainThread]: Command `dbt run` failed at 15:43:56.247047 after 4.51 seconds
[0m15:43:56.249463 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A48965460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4B2A1370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000027A4C2D8F70>]}
[0m15:43:56.250639 [debug] [MainThread]: Flushing usage events
[0m15:46:17.770214 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207D832C430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207D72AF640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207D72AFAC0>]}


============================== 15:46:17.774004 | 520f7f22-471b-4b5f-82a0-8bb4839cc9bb ==============================
[0m15:46:17.774004 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:46:17.775050 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:46:18.434110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '520f7f22-471b-4b5f-82a0-8bb4839cc9bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207D729D100>]}
[0m15:46:18.519297 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '520f7f22-471b-4b5f-82a0-8bb4839cc9bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DB980100>]}
[0m15:46:18.520298 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:46:18.531859 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:46:18.638955 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:46:18.638955 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\source.yml
[0m15:46:18.656199 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '520f7f22-471b-4b5f-82a0-8bb4839cc9bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DBC8EE80>]}
[0m15:46:18.666295 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '520f7f22-471b-4b5f-82a0-8bb4839cc9bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DBB35790>]}
[0m15:46:18.667294 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:46:18.667294 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '520f7f22-471b-4b5f-82a0-8bb4839cc9bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DB9D5280>]}
[0m15:46:18.669310 [info ] [MainThread]: 
[0m15:46:18.669310 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:46:18.671299 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:46:18.671811 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:46:19.397102 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m15:46:19.398116 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:46:20.100201 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '520f7f22-471b-4b5f-82a0-8bb4839cc9bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DBA4B3A0>]}
[0m15:46:20.101198 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:46:20.101805 [info ] [MainThread]: 
[0m15:46:20.106406 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m15:46:20.107464 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m15:46:20.108413 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m15:46:20.108413 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m15:46:20.116023 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m15:46:20.118031 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 15:46:20.108413 => 15:46:20.118031
[0m15:46:20.119035 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m15:46:20.147592 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m15:46:20.149511 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:46:20.150533 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:46:21.038580 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:babd61c6-4db1-4280-b842-221033187c95&page=queryresults
[0m15:46:21.040573 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:46:21.043103 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US

Location: US
Job ID: babd61c6-4db1-4280-b842-221033187c95

[0m15:46:21.045653 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 15:46:20.119035 => 15:46:21.043103
[0m15:46:21.054348 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: babd61c6-4db1-4280-b842-221033187c95
  
[0m15:46:21.055860 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '520f7f22-471b-4b5f-82a0-8bb4839cc9bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DBD31760>]}
[0m15:46:21.057875 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 0.95s]
[0m15:46:21.059882 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m15:46:21.065985 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:46:21.067120 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:46:21.068054 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m15:46:21.068054 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m15:46:21.068054 [info ] [MainThread]: 
[0m15:46:21.069331 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.40 seconds (2.40s).
[0m15:46:21.070126 [debug] [MainThread]: Command end result
[0m15:46:21.089322 [info ] [MainThread]: 
[0m15:46:21.091305 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:46:21.091305 [info ] [MainThread]: 
[0m15:46:21.091305 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: babd61c6-4db1-4280-b842-221033187c95
  
[0m15:46:21.093103 [info ] [MainThread]: 
[0m15:46:21.094113 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:46:21.098121 [debug] [MainThread]: Command `dbt run` failed at 15:46:21.098121 after 3.39 seconds
[0m15:46:21.098121 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207D832C430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DBA50640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000207DBA4B3A0>]}
[0m15:46:21.099115 [debug] [MainThread]: Flushing usage events
[0m15:46:44.485425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A10D835460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A10C7B76A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A10C7B7DC0>]}


============================== 15:46:44.489984 | ec35f7f6-3453-45a1-93b1-69292bf85dff ==============================
[0m15:46:44.489984 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:46:44.489984 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run', 'send_anonymous_usage_stats': 'True'}
[0m15:46:45.006117 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ec35f7f6-3453-45a1-93b1-69292bf85dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A110E8E610>]}
[0m15:46:45.081533 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ec35f7f6-3453-45a1-93b1-69292bf85dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A10C770F10>]}
[0m15:46:45.082539 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:46:45.091567 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:46:45.120299 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:46:45.121221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'ec35f7f6-3453-45a1-93b1-69292bf85dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A110E6F2E0>]}
[0m15:46:45.895257 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ec35f7f6-3453-45a1-93b1-69292bf85dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A1113AAE50>]}
[0m15:46:45.905316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ec35f7f6-3453-45a1-93b1-69292bf85dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A1113AAF40>]}
[0m15:46:45.905316 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:46:45.906315 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ec35f7f6-3453-45a1-93b1-69292bf85dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A110E5BD60>]}
[0m15:46:45.907319 [info ] [MainThread]: 
[0m15:46:45.908152 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:46:45.909291 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:46:45.910302 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:46:46.675789 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m15:46:46.679814 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:46:47.398016 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ec35f7f6-3453-45a1-93b1-69292bf85dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A1113ABCA0>]}
[0m15:46:47.402566 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:46:47.405585 [info ] [MainThread]: 
[0m15:46:47.422019 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m15:46:47.424544 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m15:46:47.431645 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m15:46:47.437261 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m15:46:47.524322 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m15:46:47.525326 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 15:46:47.440275 => 15:46:47.525326
[0m15:46:47.526326 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m15:46:47.555414 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m15:46:47.556417 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:46:47.558424 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:46:48.412303 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:f5358fc2-9f34-4b11-b4f5-341201674673&page=queryresults
[0m15:46:48.414298 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:46:48.417341 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US

Location: US
Job ID: f5358fc2-9f34-4b11-b4f5-341201674673

[0m15:46:48.419342 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 15:46:47.526326 => 15:46:48.418338
[0m15:46:48.437351 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: f5358fc2-9f34-4b11-b4f5-341201674673
  
[0m15:46:48.439366 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ec35f7f6-3453-45a1-93b1-69292bf85dff', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A1112A13A0>]}
[0m15:46:48.444416 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 1.01s]
[0m15:46:48.449989 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m15:46:48.459545 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:46:48.461506 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:46:48.462019 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m15:46:48.463031 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m15:46:48.463031 [info ] [MainThread]: 
[0m15:46:48.467211 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.55 seconds (2.55s).
[0m15:46:48.472406 [debug] [MainThread]: Command end result
[0m15:46:48.511282 [info ] [MainThread]: 
[0m15:46:48.511822 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:46:48.512827 [info ] [MainThread]: 
[0m15:46:48.516381 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: f5358fc2-9f34-4b11-b4f5-341201674673
  
[0m15:46:48.519381 [info ] [MainThread]: 
[0m15:46:48.520364 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:46:48.522887 [debug] [MainThread]: Command `dbt run` failed at 15:46:48.521869 after 4.11 seconds
[0m15:46:48.524404 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A10D835460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A110E8E610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A1113B7AF0>]}
[0m15:46:48.526415 [debug] [MainThread]: Flushing usage events
[0m15:48:16.479044 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001559E024430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001559CFAF640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001559CFAFAC0>]}


============================== 15:48:16.482274 | 1a2b0f8f-20b5-4b45-b276-df5400af3316 ==============================
[0m15:48:16.482274 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:48:16.483260 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:48:16.978522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1a2b0f8f-20b5-4b45-b276-df5400af3316', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000155A1687730>]}
[0m15:48:17.051654 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1a2b0f8f-20b5-4b45-b276-df5400af3316', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000155A15EC460>]}
[0m15:48:17.053552 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:48:17.064436 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:48:17.092238 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:48:17.093252 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '1a2b0f8f-20b5-4b45-b276-df5400af3316', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000155A175EF40>]}
[0m15:48:17.824243 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1a2b0f8f-20b5-4b45-b276-df5400af3316', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000155A1BA7E80>]}
[0m15:48:17.832513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1a2b0f8f-20b5-4b45-b276-df5400af3316', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000155A1BA7EE0>]}
[0m15:48:17.834021 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:48:17.834021 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1a2b0f8f-20b5-4b45-b276-df5400af3316', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000155A163CD90>]}
[0m15:48:17.835029 [info ] [MainThread]: 
[0m15:48:17.837037 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:48:17.837975 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:48:17.838982 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:48:19.070391 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622, now create_igneous-sandbox-381622_igneous-sandbox-381622)
[0m15:48:19.071389 [debug] [ThreadPool]: Creating schema "database: "igneous-sandbox-381622"
schema: "igneous-sandbox-381622"
"
[0m15:48:19.080486 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:48:19.082014 [debug] [ThreadPool]: On create_igneous-sandbox-381622_igneous-sandbox-381622: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "connection_name": "create_igneous-sandbox-381622_igneous-sandbox-381622"} */
create schema if not exists `igneous-sandbox-381622`.`igneous-sandbox-381622`
  
[0m15:48:19.914342 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:32aa63d0-9aea-4c0c-8e25-22be0c9ef569&page=queryresults
[0m15:48:20.474611 [debug] [ThreadPool]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Invalid dataset ID "igneous-sandbox-381622". Dataset IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long.')
[0m15:48:21.460562 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:684c3c3e-25f2-44ca-90ea-b4f60ab09220&page=queryresults
[0m15:48:21.934409 [error] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:684c3c3e-25f2-44ca-90ea-b4f60ab09220&page=queryresults
[0m15:48:21.937130 [debug] [ThreadPool]: BigQuery adapter: Unhandled error while running:
macro create_schema
[0m15:48:21.939155 [debug] [ThreadPool]: BigQuery adapter: Database Error
  Invalid dataset ID "igneous-sandbox-381622". Dataset IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long.
[0m15:48:21.942844 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:48:21.944363 [debug] [MainThread]: Connection 'create_igneous-sandbox-381622_igneous-sandbox-381622' was properly closed.
[0m15:48:21.945885 [info ] [MainThread]: 
[0m15:48:21.948037 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 4.11 seconds (4.11s).
[0m15:48:21.950120 [error] [MainThread]: Encountered an error:
Database Error
  Invalid dataset ID "igneous-sandbox-381622". Dataset IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long.
[0m15:48:21.953711 [debug] [MainThread]: Command `dbt run` failed at 15:48:21.952757 after 5.55 seconds
[0m15:48:21.954768 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001559E024430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000155A1C18B80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000155A1B9FEE0>]}
[0m15:48:21.956338 [debug] [MainThread]: Flushing usage events
[0m15:51:43.102256 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D34853D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D24042E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D2404760>]}


============================== 15:51:43.107311 | 3039e6a9-68b0-4432-afae-a8962e4d7eef ==============================
[0m15:51:43.107311 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:51:43.107311 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models testetabela', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:51:43.599516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3039e6a9-68b0-4432-afae-a8962e4d7eef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D2404940>]}
[0m15:51:43.667305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3039e6a9-68b0-4432-afae-a8962e4d7eef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6AE4250>]}
[0m15:51:43.668626 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:51:43.676161 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:51:43.702979 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:51:43.702979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '3039e6a9-68b0-4432-afae-a8962e4d7eef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6B45B20>]}
[0m15:51:44.448499 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3039e6a9-68b0-4432-afae-a8962e4d7eef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6FF3850>]}
[0m15:51:44.457184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3039e6a9-68b0-4432-afae-a8962e4d7eef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6FF3D00>]}
[0m15:51:44.458185 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:51:44.459184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3039e6a9-68b0-4432-afae-a8962e4d7eef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6BB9550>]}
[0m15:51:44.459184 [info ] [MainThread]: 
[0m15:51:44.461184 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:51:44.462695 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:51:44.462695 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:51:45.200133 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m15:51:45.200133 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:51:45.969357 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3039e6a9-68b0-4432-afae-a8962e4d7eef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6BACE50>]}
[0m15:51:45.970363 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:51:45.971867 [info ] [MainThread]: 
[0m15:51:45.977403 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m15:51:45.978401 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m15:51:45.979397 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m15:51:45.980397 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m15:51:46.042810 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m15:51:46.044316 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 15:51:45.980397 => 15:51:46.044316
[0m15:51:46.045329 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m15:51:46.067366 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m15:51:46.068362 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:51:46.069275 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:51:47.003293 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:f3965339-5cdc-4ddb-b67d-39a8ca37cf80&page=queryresults
[0m15:51:47.005267 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:51:47.006823 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US

Location: US
Job ID: f3965339-5cdc-4ddb-b67d-39a8ca37cf80

[0m15:51:47.008913 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 15:51:46.045329 => 15:51:47.007871
[0m15:51:47.019636 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: f3965339-5cdc-4ddb-b67d-39a8ca37cf80
  
[0m15:51:47.020691 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3039e6a9-68b0-4432-afae-a8962e4d7eef', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6C2C8B0>]}
[0m15:51:47.022314 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 1.04s]
[0m15:51:47.025321 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m15:51:47.030403 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:51:47.031453 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:51:47.032485 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m15:51:47.033482 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m15:51:47.036507 [info ] [MainThread]: 
[0m15:51:47.040528 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.58 seconds (2.58s).
[0m15:51:47.045581 [debug] [MainThread]: Command end result
[0m15:51:47.072832 [info ] [MainThread]: 
[0m15:51:47.072832 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:51:47.074138 [info ] [MainThread]: 
[0m15:51:47.075160 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: f3965339-5cdc-4ddb-b67d-39a8ca37cf80
  
[0m15:51:47.076155 [info ] [MainThread]: 
[0m15:51:47.077155 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:51:47.079244 [debug] [MainThread]: Command `dbt run` failed at 15:51:47.078147 after 4.04 seconds
[0m15:51:47.079244 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D34853D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6AE4250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000175D6D6A730>]}
[0m15:51:47.080241 [debug] [MainThread]: Flushing usage events
[0m15:54:41.887402 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001976F4A5460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001976E4079A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001976E407D30>]}


============================== 15:54:41.891401 | c201d063-655e-4293-aa53-93aa4b193861 ==============================
[0m15:54:41.891401 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:54:41.891887 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models testetabela', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:54:42.380060 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c201d063-655e-4293-aa53-93aa4b193861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001976E407D90>]}
[0m15:54:42.449243 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c201d063-655e-4293-aa53-93aa4b193861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019772B10940>]}
[0m15:54:42.450241 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:54:42.458229 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:54:42.492886 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:54:42.492886 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'c201d063-655e-4293-aa53-93aa4b193861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019772B75A30>]}
[0m15:54:43.220450 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c201d063-655e-4293-aa53-93aa4b193861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019773013BB0>]}
[0m15:54:43.229075 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c201d063-655e-4293-aa53-93aa4b193861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019773013FA0>]}
[0m15:54:43.229075 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:54:43.230095 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c201d063-655e-4293-aa53-93aa4b193861', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019772BFBD90>]}
[0m15:54:43.231602 [info ] [MainThread]: 
[0m15:54:43.231602 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:54:43.234122 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dbt_dw'
[0m15:54:43.235139 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:43.962144 [debug] [ThreadPool]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest("GET https://bigquery.googleapis.com/bigquery/v2/projects/dbt_dw/datasets?maxResults=10000&prettyPrint=false: Invalid project ID 'dbt_dw'. Project IDs must contain 6-63 lowercase letters, digits, or dashes. Some project IDs also include domain name separated by a colon. IDs must start with a letter and may not end with a dash.")
[0m15:54:44.998250 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:54:44.999316 [debug] [MainThread]: Connection 'list_dbt_dw' was properly closed.
[0m15:54:45.001301 [info ] [MainThread]: 
[0m15:54:45.003028 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 1.77 seconds (1.77s).
[0m15:54:45.005577 [error] [MainThread]: Encountered an error:
Database Error
  Invalid project ID 'dbt_dw'. Project IDs must contain 6-63 lowercase letters, digits, or dashes. Some project IDs also include domain name separated by a colon. IDs must start with a letter and may not end with a dash.
[0m15:54:45.009625 [debug] [MainThread]: Command `dbt run` failed at 15:54:45.008618 after 3.22 seconds
[0m15:54:45.010659 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001976F4A5460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019773021100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019772A72DF0>]}
[0m15:54:45.011616 [debug] [MainThread]: Flushing usage events
[0m15:54:54.700609 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C49ED400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C397F640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C397FAC0>]}


============================== 15:54:54.705287 | e60cb4ac-f669-4665-8edb-cfbd707325a1 ==============================
[0m15:54:54.705287 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:54:54.706231 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --models testetabela', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:54:55.297224 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e60cb4ac-f669-4665-8edb-cfbd707325a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C395C910>]}
[0m15:54:55.370390 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e60cb4ac-f669-4665-8edb-cfbd707325a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C8124160>]}
[0m15:54:55.371390 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:54:55.380205 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:54:55.402385 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:54:55.403365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'e60cb4ac-f669-4665-8edb-cfbd707325a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C7FE1A60>]}
[0m15:54:56.151360 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e60cb4ac-f669-4665-8edb-cfbd707325a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C8561400>]}
[0m15:54:56.160486 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e60cb4ac-f669-4665-8edb-cfbd707325a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C8561B20>]}
[0m15:54:56.161483 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:54:56.162002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e60cb4ac-f669-4665-8edb-cfbd707325a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C80A3E20>]}
[0m15:54:56.163064 [info ] [MainThread]: 
[0m15:54:56.163064 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:54:56.166191 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:54:56.166191 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:56.907634 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m15:54:56.907634 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:54:57.589903 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e60cb4ac-f669-4665-8edb-cfbd707325a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C857A5B0>]}
[0m15:54:57.592472 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:54:57.593515 [info ] [MainThread]: 
[0m15:54:57.599985 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m15:54:57.599985 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m15:54:57.601605 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m15:54:57.603626 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m15:54:57.662890 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m15:54:57.665405 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 15:54:57.605612 => 15:54:57.664397
[0m15:54:57.665405 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m15:54:57.687469 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m15:54:57.688470 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:54:57.689469 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:54:58.708374 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:4acda73e-f5ce-4fa3-93b3-34cad23a7ba7&page=queryresults
[0m15:54:58.709330 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:54:58.710402 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US

Location: US
Job ID: 4acda73e-f5ce-4fa3-93b3-34cad23a7ba7

[0m15:54:58.712063 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 15:54:57.666408 => 15:54:58.711405
[0m15:54:58.722518 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: 4acda73e-f5ce-4fa3-93b3-34cad23a7ba7
  
[0m15:54:58.723513 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e60cb4ac-f669-4665-8edb-cfbd707325a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C83DD580>]}
[0m15:54:58.724540 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 1.12s]
[0m15:54:58.726734 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m15:54:58.730017 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:54:58.731628 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:54:58.732643 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m15:54:58.732643 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m15:54:58.733643 [info ] [MainThread]: 
[0m15:54:58.736218 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.57 seconds (2.57s).
[0m15:54:58.739238 [debug] [MainThread]: Command end result
[0m15:54:58.752003 [info ] [MainThread]: 
[0m15:54:58.753016 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:54:58.753016 [info ] [MainThread]: 
[0m15:54:58.753016 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: 4acda73e-f5ce-4fa3-93b3-34cad23a7ba7
  
[0m15:54:58.755548 [info ] [MainThread]: 
[0m15:54:58.757533 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:54:58.758532 [debug] [MainThread]: Command `dbt run` failed at 15:54:58.758532 after 4.12 seconds
[0m15:54:58.758532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C49ED400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C80A3E20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000199C85614F0>]}
[0m15:54:58.759534 [debug] [MainThread]: Flushing usage events
[0m15:58:25.102787 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023877624400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000238765A5640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000238765A5AC0>]}


============================== 15:58:25.109349 | 41ffa16b-6320-44df-b9f5-41c89e0ec7a2 ==============================
[0m15:58:25.109349 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:58:25.109349 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models testetabela', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m15:58:25.638261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '41ffa16b-6320-44df-b9f5-41c89e0ec7a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000238765A5DC0>]}
[0m15:58:25.711848 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '41ffa16b-6320-44df-b9f5-41c89e0ec7a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387AC8DE20>]}
[0m15:58:25.712851 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:58:25.720472 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:58:25.749544 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m15:58:25.750548 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '41ffa16b-6320-44df-b9f5-41c89e0ec7a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387AD4F970>]}
[0m15:58:26.505516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '41ffa16b-6320-44df-b9f5-41c89e0ec7a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387B194DF0>]}
[0m15:58:26.513035 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '41ffa16b-6320-44df-b9f5-41c89e0ec7a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387B194D00>]}
[0m15:58:26.514543 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:58:26.515553 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '41ffa16b-6320-44df-b9f5-41c89e0ec7a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387AD74910>]}
[0m15:58:26.516560 [info ] [MainThread]: 
[0m15:58:26.517558 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:58:26.519558 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:58:26.519558 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:58:27.299875 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m15:58:27.299875 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:58:28.190502 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '41ffa16b-6320-44df-b9f5-41c89e0ec7a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387AC1E070>]}
[0m15:58:28.192221 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:58:28.193255 [info ] [MainThread]: 
[0m15:58:28.203373 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m15:58:28.207404 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m15:58:28.209392 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m15:58:28.210390 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m15:58:28.286443 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m15:58:28.287444 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 15:58:28.210390 => 15:58:28.287444
[0m15:58:28.287444 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m15:58:28.309495 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m15:58:28.310496 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:58:28.311495 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:58:29.151378 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e974060f-dfbc-489c-8a85-4a308fdbc7ba&page=queryresults
[0m15:58:29.153011 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m15:58:29.154555 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location us-east4

Location: us-east4
Job ID: e974060f-dfbc-489c-8a85-4a308fdbc7ba

[0m15:58:29.157592 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 15:58:28.287444 => 15:58:29.156577
[0m15:58:29.172556 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location us-east4
  
  Location: us-east4
  Job ID: e974060f-dfbc-489c-8a85-4a308fdbc7ba
  
[0m15:58:29.174991 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '41ffa16b-6320-44df-b9f5-41c89e0ec7a2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387AEC2D60>]}
[0m15:58:29.177652 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 0.97s]
[0m15:58:29.180652 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m15:58:29.187500 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:58:29.189564 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:58:29.189564 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m15:58:29.190551 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m15:58:29.191550 [info ] [MainThread]: 
[0m15:58:29.193147 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.67 seconds (2.67s).
[0m15:58:29.198536 [debug] [MainThread]: Command end result
[0m15:58:29.236877 [info ] [MainThread]: 
[0m15:58:29.238814 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:58:29.239820 [info ] [MainThread]: 
[0m15:58:29.243641 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location us-east4
  
  Location: us-east4
  Job ID: e974060f-dfbc-489c-8a85-4a308fdbc7ba
  
[0m15:58:29.247669 [info ] [MainThread]: 
[0m15:58:29.249723 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:58:29.250714 [debug] [MainThread]: Command `dbt run` failed at 15:58:29.250714 after 4.26 seconds
[0m15:58:29.251728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023877624400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387AC8DE20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002387AD4F1C0>]}
[0m15:58:29.252323 [debug] [MainThread]: Flushing usage events
[0m16:01:17.323292 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FA74D1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FA64739D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FA6473B80>]}


============================== 16:01:17.327276 | 0458d4ff-f421-491b-a9e8-0215bd71bcfe ==============================
[0m16:01:17.327276 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:01:17.328273 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models testetabela', 'send_anonymous_usage_stats': 'True'}
[0m16:01:17.820257 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0458d4ff-f421-491b-a9e8-0215bd71bcfe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FA645B130>]}
[0m16:01:17.896199 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0458d4ff-f421-491b-a9e8-0215bd71bcfe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAAB5F8B0>]}
[0m16:01:17.898109 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:01:17.905821 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:01:17.934472 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m16:01:17.935461 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '0458d4ff-f421-491b-a9e8-0215bd71bcfe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAAAEAC40>]}
[0m16:01:18.713297 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0458d4ff-f421-491b-a9e8-0215bd71bcfe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAB061A00>]}
[0m16:01:18.721711 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0458d4ff-f421-491b-a9e8-0215bd71bcfe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAB061EB0>]}
[0m16:01:18.722723 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:01:18.722723 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0458d4ff-f421-491b-a9e8-0215bd71bcfe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAAAB30D0>]}
[0m16:01:18.725289 [info ] [MainThread]: 
[0m16:01:18.726244 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:01:18.727246 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:01:18.727246 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:01:19.612733 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m16:01:19.615315 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:01:20.320555 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0458d4ff-f421-491b-a9e8-0215bd71bcfe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAAF45DF0>]}
[0m16:01:20.322132 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:01:20.323138 [info ] [MainThread]: 
[0m16:01:20.329574 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m16:01:20.330585 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m16:01:20.332210 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m16:01:20.333215 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m16:01:20.395421 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m16:01:20.396422 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 16:01:20.333215 => 16:01:20.396422
[0m16:01:20.396422 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m16:01:20.419466 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m16:01:20.420467 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:01:20.421972 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:01:21.578505 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:5d2fc881-f7d6-4d6d-8879-5dfaa1400987&page=queryresults
[0m16:01:21.582027 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:01:21.583050 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US

Location: US
Job ID: 5d2fc881-f7d6-4d6d-8879-5dfaa1400987

[0m16:01:21.587633 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 16:01:20.396422 => 16:01:21.584572
[0m16:01:21.607833 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: 5d2fc881-f7d6-4d6d-8879-5dfaa1400987
  
[0m16:01:21.608833 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0458d4ff-f421-491b-a9e8-0215bd71bcfe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAAC9AE80>]}
[0m16:01:21.609838 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 1.28s]
[0m16:01:21.612368 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m16:01:21.617899 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:01:21.618898 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:01:21.619897 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m16:01:21.619897 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m16:01:21.619897 [info ] [MainThread]: 
[0m16:01:21.622422 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.89 seconds (2.89s).
[0m16:01:21.627422 [debug] [MainThread]: Command end result
[0m16:01:21.642536 [info ] [MainThread]: 
[0m16:01:21.643539 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:01:21.645537 [info ] [MainThread]: 
[0m16:01:21.647535 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:datalake_bling was not found in location US
  
  Location: US
  Job ID: 5d2fc881-f7d6-4d6d-8879-5dfaa1400987
  
[0m16:01:21.648540 [info ] [MainThread]: 
[0m16:01:21.648540 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:01:21.650538 [debug] [MainThread]: Command `dbt run` failed at 16:01:21.650538 after 4.39 seconds
[0m16:01:21.651535 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FA74D1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAAC27CA0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000013FAAE71C40>]}
[0m16:01:21.652043 [debug] [MainThread]: Flushing usage events
[0m16:03:23.120247 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DA72913D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DA62392E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DA6239760>]}


============================== 16:03:23.124215 | b0c668fa-7a21-44f4-a60f-0c75abc504f7 ==============================
[0m16:03:23.124215 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:03:23.125289 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models testetabela', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:03:23.625441 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b0c668fa-7a21-44f4-a60f-0c75abc504f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DA621CA60>]}
[0m16:03:23.689402 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b0c668fa-7a21-44f4-a60f-0c75abc504f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DAA9F7E50>]}
[0m16:03:23.691357 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:03:23.699381 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:03:23.778506 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:03:23.778506 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:03:23.783019 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b0c668fa-7a21-44f4-a60f-0c75abc504f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DAABA8310>]}
[0m16:03:23.792054 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b0c668fa-7a21-44f4-a60f-0c75abc504f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DAAAC8190>]}
[0m16:03:23.792054 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:03:23.792920 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b0c668fa-7a21-44f4-a60f-0c75abc504f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DAAAC80D0>]}
[0m16:03:23.792920 [info ] [MainThread]: 
[0m16:03:23.795485 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:03:23.797514 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:03:23.797514 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:03:24.500377 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m16:03:24.501416 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:03:25.127508 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b0c668fa-7a21-44f4-a60f-0c75abc504f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DAA979340>]}
[0m16:03:25.128514 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:03:25.129576 [info ] [MainThread]: 
[0m16:03:25.135313 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m16:03:25.136339 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m16:03:25.137346 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m16:03:25.137346 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m16:03:25.148544 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m16:03:25.149605 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 16:03:25.138335 => 16:03:25.149605
[0m16:03:25.149605 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m16:03:25.178648 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m16:03:25.179707 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:03:25.180654 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:03:25.918504 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:03bc919a-ebee-4b6a-a967-c597897b5e3a&page=queryresults
[0m16:03:25.919610 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:03:25.920596 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location US

Location: US
Job ID: 03bc919a-ebee-4b6a-a967-c597897b5e3a

[0m16:03:25.920596 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 16:03:25.150568 => 16:03:25.920596
[0m16:03:25.926374 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location US
  
  Location: US
  Job ID: 03bc919a-ebee-4b6a-a967-c597897b5e3a
  
[0m16:03:25.926374 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b0c668fa-7a21-44f4-a60f-0c75abc504f7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DAABB3FA0>]}
[0m16:03:25.926374 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 0.79s]
[0m16:03:25.928443 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m16:03:25.930659 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:03:25.930659 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:03:25.930659 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m16:03:25.931657 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m16:03:25.931657 [info ] [MainThread]: 
[0m16:03:25.932380 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.14 seconds (2.14s).
[0m16:03:25.935409 [debug] [MainThread]: Command end result
[0m16:03:25.942792 [info ] [MainThread]: 
[0m16:03:25.945309 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:03:25.946316 [info ] [MainThread]: 
[0m16:03:25.947313 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location US
  
  Location: US
  Job ID: 03bc919a-ebee-4b6a-a967-c597897b5e3a
  
[0m16:03:25.947313 [info ] [MainThread]: 
[0m16:03:25.948493 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:03:25.949498 [debug] [MainThread]: Command `dbt run` failed at 16:03:25.949498 after 2.89 seconds
[0m16:03:25.949498 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DA72913D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DAA9F7E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025DAAC23FD0>]}
[0m16:03:25.949498 [debug] [MainThread]: Flushing usage events
[0m16:03:54.888290 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F264C1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F254479D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F25447B80>]}


============================== 16:03:54.891322 | d854b771-54a2-412a-8e26-7bbe51dd03d5 ==============================
[0m16:03:54.891322 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:03:54.892620 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --models testetabela', 'send_anonymous_usage_stats': 'True'}
[0m16:03:55.408377 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd854b771-54a2-412a-8e26-7bbe51dd03d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F2543C130>]}
[0m16:03:55.475015 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd854b771-54a2-412a-8e26-7bbe51dd03d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F29B4F8B0>]}
[0m16:03:55.476568 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:03:55.482729 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:03:55.536478 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:03:55.536478 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:03:55.540472 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd854b771-54a2-412a-8e26-7bbe51dd03d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F29DD6DF0>]}
[0m16:03:55.549583 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd854b771-54a2-412a-8e26-7bbe51dd03d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F29C65A00>]}
[0m16:03:55.550604 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:03:55.550604 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd854b771-54a2-412a-8e26-7bbe51dd03d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F29C65100>]}
[0m16:03:55.552223 [info ] [MainThread]: 
[0m16:03:55.553228 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:03:55.554790 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:03:55.554790 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:03:56.211512 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m16:03:56.213727 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:03:56.966694 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd854b771-54a2-412a-8e26-7bbe51dd03d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F29DD6E80>]}
[0m16:03:56.967699 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:03:56.967699 [info ] [MainThread]: 
[0m16:03:56.979733 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m16:03:56.980732 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m16:03:56.981732 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m16:03:56.982236 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m16:03:56.989770 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m16:03:56.990769 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 16:03:56.982236 => 16:03:56.990769
[0m16:03:56.990769 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m16:03:57.044528 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m16:03:57.046540 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:03:57.049543 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:03:57.967591 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:US:589ea0a1-ca7f-4a0d-a5f6-4e8fa2bc8c6c&page=queryresults
[0m16:03:57.968586 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:03:57.969586 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location US

Location: US
Job ID: 589ea0a1-ca7f-4a0d-a5f6-4e8fa2bc8c6c

[0m16:03:57.970585 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 16:03:56.991778 => 16:03:57.969586
[0m16:03:57.974619 [debug] [Thread-1  ]: Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location US
  
  Location: US
  Job ID: 589ea0a1-ca7f-4a0d-a5f6-4e8fa2bc8c6c
  
[0m16:03:57.976627 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd854b771-54a2-412a-8e26-7bbe51dd03d5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F29DC1730>]}
[0m16:03:57.976627 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 0.99s]
[0m16:03:57.978136 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m16:03:57.980181 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:03:57.980181 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:03:57.980181 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m16:03:57.980181 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m16:03:57.980181 [info ] [MainThread]: 
[0m16:03:57.981689 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.43 seconds (2.43s).
[0m16:03:57.982702 [debug] [MainThread]: Command end result
[0m16:03:57.989805 [info ] [MainThread]: 
[0m16:03:57.990767 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:03:57.991770 [info ] [MainThread]: 
[0m16:03:57.991770 [error] [MainThread]:   Runtime Error in model testetabela (models\1.stg\testetabela.sql)
  404 Not found: Dataset igneous-sandbox-381622:dbt_dw was not found in location US
  
  Location: US
  Job ID: 589ea0a1-ca7f-4a0d-a5f6-4e8fa2bc8c6c
  
[0m16:03:57.991770 [info ] [MainThread]: 
[0m16:03:57.993018 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:03:57.994529 [debug] [MainThread]: Command `dbt run` failed at 16:03:57.994529 after 3.17 seconds
[0m16:03:57.995541 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F264C1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F29A5B250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023F29ADBCA0>]}
[0m16:03:57.996544 [debug] [MainThread]: Flushing usage events
[0m16:04:05.331279 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE790DB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE780539A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE78053D30>]}


============================== 16:04:05.335459 | 8f7a85b2-87be-4046-9a2b-a92b1542fa8f ==============================
[0m16:04:05.335459 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:04:05.336491 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models testetabela', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:04:05.815296 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8f7a85b2-87be-4046-9a2b-a92b1542fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7C6C9580>]}
[0m16:04:05.881721 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8f7a85b2-87be-4046-9a2b-a92b1542fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7C63EA60>]}
[0m16:04:05.883381 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:04:05.890444 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:04:05.897655 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m16:04:05.898639 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '8f7a85b2-87be-4046-9a2b-a92b1542fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7C6B76D0>]}
[0m16:04:06.789812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8f7a85b2-87be-4046-9a2b-a92b1542fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7CC52EB0>]}
[0m16:04:06.801438 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8f7a85b2-87be-4046-9a2b-a92b1542fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7CC52E20>]}
[0m16:04:06.801438 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:04:06.802989 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8f7a85b2-87be-4046-9a2b-a92b1542fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7C7CEFA0>]}
[0m16:04:06.804509 [info ] [MainThread]: 
[0m16:04:06.805698 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:04:06.808170 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:04:06.808170 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:04:07.474747 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m16:04:07.477403 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:04:08.285404 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8f7a85b2-87be-4046-9a2b-a92b1542fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7CC50790>]}
[0m16:04:08.288411 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:04:08.291430 [info ] [MainThread]: 
[0m16:04:08.305649 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m16:04:08.307652 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m16:04:08.310651 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m16:04:08.313198 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m16:04:08.400806 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m16:04:08.401805 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 16:04:08.319310 => 16:04:08.401805
[0m16:04:08.403118 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m16:04:08.427489 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m16:04:08.428489 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:04:08.429391 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id,
  cliente,
  data,
  total,
  status
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:04:09.419615 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:21808c7b-9da6-4242-bac5-7425f6079069&page=queryresults
[0m16:04:09.859428 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: cliente at [10:3]')
[0m16:04:10.462869 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3550af82-10c8-4988-bfc3-21bb4b022f5f&page=queryresults
[0m16:04:10.869149 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3550af82-10c8-4988-bfc3-21bb4b022f5f&page=queryresults
[0m16:04:10.872717 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 16:04:08.403118 => 16:04:10.871688
[0m16:04:10.882606 [debug] [Thread-1  ]: Database Error in model testetabela (models\1.stg\testetabela.sql)
  Unrecognized name: cliente at [10:3]
  compiled Code at target\run\shibaribrasil\models\1.stg\testetabela.sql
[0m16:04:10.884591 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8f7a85b2-87be-4046-9a2b-a92b1542fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7CB511C0>]}
[0m16:04:10.886653 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw.testetabela ........................ [[31mERROR[0m in 2.57s]
[0m16:04:10.888646 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m16:04:10.890648 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:04:10.890648 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:04:10.891644 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m16:04:10.891644 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m16:04:10.892156 [info ] [MainThread]: 
[0m16:04:10.892156 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.09 seconds (4.09s).
[0m16:04:10.895714 [debug] [MainThread]: Command end result
[0m16:04:10.909299 [info ] [MainThread]: 
[0m16:04:10.909299 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:04:10.910297 [info ] [MainThread]: 
[0m16:04:10.911818 [error] [MainThread]:   Database Error in model testetabela (models\1.stg\testetabela.sql)
  Unrecognized name: cliente at [10:3]
  compiled Code at target\run\shibaribrasil\models\1.stg\testetabela.sql
[0m16:04:10.911818 [info ] [MainThread]: 
[0m16:04:10.912829 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:04:10.915352 [debug] [MainThread]: Command `dbt run` failed at 16:04:10.914339 after 5.65 seconds
[0m16:04:10.915352 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE790DB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7CA5B820>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BE7C6CE0D0>]}
[0m16:04:10.916347 [debug] [MainThread]: Flushing usage events
[0m16:04:31.333318 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC23C1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC13639D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC1363B80>]}


============================== 16:04:31.337278 | 4c75a5ea-2694-4f7d-b0ba-c1cabb224c17 ==============================
[0m16:04:31.337278 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:04:31.338404 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models testetabela', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:04:31.863026 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4c75a5ea-2694-4f7d-b0ba-c1cabb224c17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC134C0A0>]}
[0m16:04:31.942839 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4c75a5ea-2694-4f7d-b0ba-c1cabb224c17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC5937DF0>]}
[0m16:04:31.942839 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:04:31.950610 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:04:32.046357 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:04:32.047414 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\testetabela.sql
[0m16:04:32.164439 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4c75a5ea-2694-4f7d-b0ba-c1cabb224c17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC5E78430>]}
[0m16:04:32.178532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4c75a5ea-2694-4f7d-b0ba-c1cabb224c17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC5B64850>]}
[0m16:04:32.179535 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:04:32.180537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4c75a5ea-2694-4f7d-b0ba-c1cabb224c17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC5B0CE80>]}
[0m16:04:32.181536 [info ] [MainThread]: 
[0m16:04:32.183077 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:04:32.184585 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:04:32.185593 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:04:32.799593 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw'
[0m16:04:32.800593 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:04:33.501717 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4c75a5ea-2694-4f7d-b0ba-c1cabb224c17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC5A8D1C0>]}
[0m16:04:33.501717 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:04:33.502882 [info ] [MainThread]: 
[0m16:04:33.509400 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m16:04:33.510400 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw.testetabela ................................. [RUN]
[0m16:04:33.511403 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m16:04:33.511913 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m16:04:33.519425 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m16:04:33.520425 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 16:04:33.511913 => 16:04:33.520425
[0m16:04:33.520425 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m16:04:33.550557 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m16:04:33.551559 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:04:33.553076 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw`.`testetabela`
  OPTIONS()
  as 

SELECT
  id
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:04:34.333065 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:81ad8f51-35c9-4a5a-8094-1f9c7ab6ef24&page=queryresults
[0m16:04:34.829599 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 16:04:33.520425 => 16:04:34.828560
[0m16:04:34.830603 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c75a5ea-2694-4f7d-b0ba-c1cabb224c17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC59A5A90>]}
[0m16:04:34.832174 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw.testetabela ............................ [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m16:04:34.838384 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m16:04:34.852799 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:04:34.852799 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:04:34.852799 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw' was properly closed.
[0m16:04:34.855855 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m16:04:34.859321 [info ] [MainThread]: 
[0m16:04:34.862865 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.68 seconds (2.68s).
[0m16:04:34.868752 [debug] [MainThread]: Command end result
[0m16:04:34.897546 [info ] [MainThread]: 
[0m16:04:34.898805 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:04:34.899906 [info ] [MainThread]: 
[0m16:04:34.901478 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:04:34.903506 [debug] [MainThread]: Command `dbt run` succeeded at 16:04:34.902510 after 3.64 seconds
[0m16:04:34.903506 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC23C1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC5A931C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDC5ACDAF0>]}
[0m16:04:34.903506 [debug] [MainThread]: Flushing usage events
[0m16:06:47.000245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC68C21430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC67BB09D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC67BB0B80>]}


============================== 16:06:47.005512 | d77a3bc3-47e3-4de0-810e-462ae5d7db7f ==============================
[0m16:06:47.005512 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:06:47.005512 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --models testetabela', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:06:47.506781 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd77a3bc3-47e3-4de0-810e-462ae5d7db7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC67BAC130>]}
[0m16:06:47.578621 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd77a3bc3-47e3-4de0-810e-462ae5d7db7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC67BB0190>]}
[0m16:06:47.579704 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:06:47.587598 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:06:47.613574 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m16:06:47.615686 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'd77a3bc3-47e3-4de0-810e-462ae5d7db7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC6C310B50>]}
[0m16:06:48.493051 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 2 unused configuration paths:
- models.shibaribrasil.2.dw
- models.shibaribrasil.3.az
[0m16:06:48.497626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd77a3bc3-47e3-4de0-810e-462ae5d7db7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC6C7B1730>]}
[0m16:06:48.506400 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd77a3bc3-47e3-4de0-810e-462ae5d7db7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC6C7B1BE0>]}
[0m16:06:48.507401 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:06:48.507401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd77a3bc3-47e3-4de0-810e-462ae5d7db7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC6C38DC10>]}
[0m16:06:48.508404 [info ] [MainThread]: 
[0m16:06:48.509410 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:06:48.510422 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:06:48.510422 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:06:49.288624 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622, now create_igneous-sandbox-381622_dbt_dw_stg)
[0m16:06:49.290618 [debug] [ThreadPool]: Creating schema "database: "igneous-sandbox-381622"
schema: "dbt_dw_stg"
"
[0m16:06:49.307730 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:06:49.309730 [debug] [ThreadPool]: On create_igneous-sandbox-381622_dbt_dw_stg: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "connection_name": "create_igneous-sandbox-381622_dbt_dw_stg"} */
create schema if not exists `igneous-sandbox-381622`.`dbt_dw_stg`
  
[0m16:06:50.098472 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:87b85be2-d90e-4f80-a4a4-9d4782ea3e82&page=queryresults
[0m16:06:51.018609 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:06:51.018609 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:06:51.652381 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd77a3bc3-47e3-4de0-810e-462ae5d7db7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC6C6AF940>]}
[0m16:06:51.653388 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:06:51.655390 [info ] [MainThread]: 
[0m16:06:51.666513 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m16:06:51.670540 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.testetabela ............................. [RUN]
[0m16:06:51.676620 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m16:06:51.679640 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m16:06:51.710614 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m16:06:51.711617 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 16:06:51.681641 => 16:06:51.710614
[0m16:06:51.712140 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m16:06:51.734720 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m16:06:51.736735 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:06:51.737736 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`testetabela`
  OPTIONS()
  as 

SELECT
  id
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:06:52.568811 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:667f0c32-8cf1-42ca-b6f8-7c3520176a89&page=queryresults
[0m16:06:53.005458 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 16:06:51.712140 => 16:06:53.004494
[0m16:06:53.005458 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd77a3bc3-47e3-4de0-810e-462ae5d7db7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC6C6E1E50>]}
[0m16:06:53.006541 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.testetabela ........................ [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m16:06:53.007443 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m16:06:53.009451 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:06:53.009451 [debug] [MainThread]: Connection 'create_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:06:53.009451 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:06:53.009451 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m16:06:53.010447 [info ] [MainThread]: 
[0m16:06:53.010447 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.50 seconds (4.50s).
[0m16:06:53.011466 [debug] [MainThread]: Command end result
[0m16:06:53.023056 [info ] [MainThread]: 
[0m16:06:53.024568 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:06:53.026579 [info ] [MainThread]: 
[0m16:06:53.027591 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:06:53.030588 [debug] [MainThread]: Command `dbt run` succeeded at 16:06:53.029591 after 6.15 seconds
[0m16:06:53.030588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC68C21430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC6C38DC10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC6C363670>]}
[0m16:06:53.030588 [debug] [MainThread]: Flushing usage events
[0m16:18:19.737689 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002378586C430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237847A07C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237847A04C0>]}


============================== 16:18:19.740751 | 2e97a673-c63f-45c6-a026-4e7f020cbfe8 ==============================
[0m16:18:19.740751 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:18:19.741619 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual\\dbt_shibaribrasil\\dbt_shibaribrasil', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt debug --profiles-dir C:\\Git\\sb_loja_virtual\\dbt_shibaribrasil\\dbt_shibaribrasil', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:18:19.741619 [info ] [MainThread]: dbt version: 1.7.4
[0m16:18:19.742890 [info ] [MainThread]: python version: 3.8.10
[0m16:18:19.743710 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m16:18:19.744728 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m16:18:19.745783 [info ] [MainThread]: Using profiles dir at C:\Git\sb_loja_virtual\dbt_shibaribrasil\dbt_shibaribrasil
[0m16:18:19.745783 [info ] [MainThread]: Using profiles.yml file at C:\Git\sb_loja_virtual\dbt_shibaribrasil\dbt_shibaribrasil\profiles.yml
[0m16:18:19.746794 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_project.yml
[0m16:18:19.828518 [info ] [MainThread]: Configuration:
[0m16:18:19.828518 [info ] [MainThread]:   profiles.yml file [[31mERROR not found[0m]
[0m16:18:19.829521 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m16:18:19.829521 [info ] [MainThread]: Required dependencies:
[0m16:18:19.830521 [debug] [MainThread]: Executing "git --help"
[0m16:18:19.870409 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m16:18:19.870409 [debug] [MainThread]: STDERR: "b''"
[0m16:18:19.870409 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m16:18:19.871955 [info ] [MainThread]: Connection test skipped since no profile was found
[0m16:18:19.871955 [info ] [MainThread]: [31m1 check failed:[0m
[0m16:18:19.873039 [info ] [MainThread]: dbt looked for a profiles.yml file in C:\Git\sb_loja_virtual\dbt_shibaribrasil\dbt_shibaribrasil\profiles.yml, but did
not find one. For more information on configuring your profile, consult the
documentation:

https://docs.getdbt.com/docs/configure-your-profile


[0m16:18:19.875673 [debug] [MainThread]: Command `dbt debug` failed at 16:18:19.874610 after 0.17 seconds
[0m16:18:19.875673 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002378586C430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237882047C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002378821CF40>]}
[0m16:18:19.876625 [debug] [MainThread]: Flushing usage events
[0m16:18:29.842009 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266B259D460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266B4EEEB80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266B151DFD0>]}


============================== 16:18:29.846532 | 8ddbe58a-7a8a-4d69-9b16-2be1f378525a ==============================
[0m16:18:29.846532 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:18:29.847540 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt debug', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:18:29.847540 [info ] [MainThread]: dbt version: 1.7.4
[0m16:18:29.848724 [info ] [MainThread]: python version: 3.8.10
[0m16:18:29.848724 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m16:18:29.849731 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m16:18:30.238866 [info ] [MainThread]: Using profiles dir at C:\Git\sb_loja_virtual
[0m16:18:30.239910 [info ] [MainThread]: Using profiles.yml file at C:\Git\sb_loja_virtual\profiles.yml
[0m16:18:30.239910 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_project.yml
[0m16:18:30.242455 [info ] [MainThread]: adapter type: bigquery
[0m16:18:30.242455 [info ] [MainThread]: adapter version: 1.7.2
[0m16:18:30.347885 [info ] [MainThread]: Configuration:
[0m16:18:30.348996 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m16:18:30.348996 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m16:18:30.350003 [info ] [MainThread]: Required dependencies:
[0m16:18:30.350003 [debug] [MainThread]: Executing "git --help"
[0m16:18:30.385558 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m16:18:30.386556 [debug] [MainThread]: STDERR: "b''"
[0m16:18:30.387558 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m16:18:30.388555 [info ] [MainThread]: Connection:
[0m16:18:30.388555 [info ] [MainThread]:   method: service-account
[0m16:18:30.389556 [info ] [MainThread]:   database: igneous-sandbox-381622
[0m16:18:30.389556 [info ] [MainThread]:   execution_project: igneous-sandbox-381622
[0m16:18:30.390555 [info ] [MainThread]:   schema: dbt_dw
[0m16:18:30.391554 [info ] [MainThread]:   location: us-east4
[0m16:18:30.391554 [info ] [MainThread]:   priority: None
[0m16:18:30.391554 [info ] [MainThread]:   maximum_bytes_billed: None
[0m16:18:30.392894 [info ] [MainThread]:   impersonate_service_account: None
[0m16:18:30.392894 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m16:18:30.394403 [info ] [MainThread]:   job_retries: 1
[0m16:18:30.395414 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m16:18:30.396422 [info ] [MainThread]:   job_execution_timeout_seconds: None
[0m16:18:30.397413 [info ] [MainThread]:   keyfile: C:\Git\sb_loja_virtual\key_project_sb.json
[0m16:18:30.398414 [info ] [MainThread]:   timeout_seconds: None
[0m16:18:30.398414 [info ] [MainThread]:   refresh_token: None
[0m16:18:30.399410 [info ] [MainThread]:   client_id: None
[0m16:18:30.399410 [info ] [MainThread]:   token_uri: None
[0m16:18:30.400412 [info ] [MainThread]:   dataproc_region: None
[0m16:18:30.400412 [info ] [MainThread]:   dataproc_cluster_name: None
[0m16:18:30.400412 [info ] [MainThread]:   gcs_bucket: None
[0m16:18:30.400412 [info ] [MainThread]:   dataproc_batch: None
[0m16:18:30.401917 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:18:30.401917 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m16:18:30.402924 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:18:30.404432 [debug] [MainThread]: On debug: select 1 as id
[0m16:18:30.681140 [info ] [MainThread]:   Connection test: [[31mERROR[0m]

[0m16:18:30.682756 [info ] [MainThread]: [31m1 check failed:[0m
[0m16:18:30.684767 [info ] [MainThread]: dbt was unable to connect to the specified database.
The database returned the following error:

  >Runtime Error
  Unable to generate access token, if you're using impersonate_service_account, make sure your initial account has the "roles/iam.serviceAccountTokenCreator" role on the account you are trying to impersonate.
  
  ('invalid_grant: Invalid JWT Signature.', {'error': 'invalid_grant', 'error_description': 'Invalid JWT Signature.'})

Check your database credentials and try again. For more information, visit:
https://docs.getdbt.com/docs/configure-your-profile


[0m16:18:30.689316 [debug] [MainThread]: Command `dbt debug` failed at 16:18:30.688322 after 0.91 seconds
[0m16:18:30.689316 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m16:18:30.690315 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266B259D460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266B5AFCD60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000266B5BCC460>]}
[0m16:18:30.690315 [debug] [MainThread]: Flushing usage events
[0m16:20:43.252890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E88E151460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E890ABCBB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E88D0FAFD0>]}


============================== 16:20:43.256433 | 18036055-fe7d-4974-9bb2-c48fed3333ea ==============================
[0m16:20:43.256433 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:20:43.257446 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt debug', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:20:43.257446 [info ] [MainThread]: dbt version: 1.7.4
[0m16:20:43.258426 [info ] [MainThread]: python version: 3.8.10
[0m16:20:43.258426 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m16:20:43.259419 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m16:20:43.652352 [info ] [MainThread]: Using profiles dir at C:\Git\sb_loja_virtual
[0m16:20:43.653347 [info ] [MainThread]: Using profiles.yml file at C:\Git\sb_loja_virtual\profiles.yml
[0m16:20:43.653347 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_project.yml
[0m16:20:43.654852 [info ] [MainThread]: adapter type: bigquery
[0m16:20:43.655860 [info ] [MainThread]: adapter version: 1.7.2
[0m16:20:43.764414 [info ] [MainThread]: Configuration:
[0m16:20:43.764414 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m16:20:43.765424 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m16:20:43.766422 [info ] [MainThread]: Required dependencies:
[0m16:20:43.766422 [debug] [MainThread]: Executing "git --help"
[0m16:20:43.798162 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m16:20:43.798162 [debug] [MainThread]: STDERR: "b''"
[0m16:20:43.799154 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m16:20:43.799154 [info ] [MainThread]: Connection:
[0m16:20:43.800157 [info ] [MainThread]:   method: service-account
[0m16:20:43.800157 [info ] [MainThread]:   database: igneous-sandbox-381622
[0m16:20:43.800157 [info ] [MainThread]:   execution_project: igneous-sandbox-381622
[0m16:20:43.801673 [info ] [MainThread]:   schema: dbt_dw
[0m16:20:43.801673 [info ] [MainThread]:   location: us-east4
[0m16:20:43.801673 [info ] [MainThread]:   priority: None
[0m16:20:43.802730 [info ] [MainThread]:   maximum_bytes_billed: None
[0m16:20:43.802730 [info ] [MainThread]:   impersonate_service_account: None
[0m16:20:43.803936 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m16:20:43.805015 [info ] [MainThread]:   job_retries: 1
[0m16:20:43.805015 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m16:20:43.805015 [info ] [MainThread]:   job_execution_timeout_seconds: None
[0m16:20:43.806527 [info ] [MainThread]:   keyfile: C:\Git\sb_loja_virtual\key_project_sb.json
[0m16:20:43.807590 [info ] [MainThread]:   timeout_seconds: None
[0m16:20:43.807590 [info ] [MainThread]:   refresh_token: None
[0m16:20:43.808604 [info ] [MainThread]:   client_id: None
[0m16:20:43.809551 [info ] [MainThread]:   token_uri: None
[0m16:20:43.809551 [info ] [MainThread]:   dataproc_region: None
[0m16:20:43.809551 [info ] [MainThread]:   dataproc_cluster_name: None
[0m16:20:43.810603 [info ] [MainThread]:   gcs_bucket: None
[0m16:20:43.810603 [info ] [MainThread]:   dataproc_batch: None
[0m16:20:43.811598 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:20:43.812750 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m16:20:43.812750 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:20:43.815715 [debug] [MainThread]: On debug: select 1 as id
[0m16:20:44.081612 [info ] [MainThread]:   Connection test: [[31mERROR[0m]

[0m16:20:44.083137 [info ] [MainThread]: [31m1 check failed:[0m
[0m16:20:44.085673 [info ] [MainThread]: dbt was unable to connect to the specified database.
The database returned the following error:

  >Runtime Error
  Unable to generate access token, if you're using impersonate_service_account, make sure your initial account has the "roles/iam.serviceAccountTokenCreator" role on the account you are trying to impersonate.
  
  ('invalid_grant: Invalid JWT Signature.', {'error': 'invalid_grant', 'error_description': 'Invalid JWT Signature.'})

Check your database credentials and try again. For more information, visit:
https://docs.getdbt.com/docs/configure-your-profile


[0m16:20:44.088670 [debug] [MainThread]: Command `dbt debug` failed at 16:20:44.088670 after 0.90 seconds
[0m16:20:44.089669 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m16:20:44.089669 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E88E151460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E88D0CA280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E8916F7CD0>]}
[0m16:20:44.090668 [debug] [MainThread]: Flushing usage events
[0m16:21:40.284504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021303AF13D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002130645CC10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021302A98D30>]}


============================== 16:21:40.288538 | abe9bf46-cedb-4761-833c-074349741041 ==============================
[0m16:21:40.288538 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:21:40.289279 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt debug', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:21:40.289279 [info ] [MainThread]: dbt version: 1.7.4
[0m16:21:40.290383 [info ] [MainThread]: python version: 3.8.10
[0m16:21:40.290383 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m16:21:40.290383 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m16:21:40.667762 [info ] [MainThread]: Using profiles dir at C:\Git\sb_loja_virtual
[0m16:21:40.667762 [info ] [MainThread]: Using profiles.yml file at C:\Git\sb_loja_virtual\profiles.yml
[0m16:21:40.668719 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_project.yml
[0m16:21:40.669721 [info ] [MainThread]: adapter type: bigquery
[0m16:21:40.669721 [info ] [MainThread]: adapter version: 1.7.2
[0m16:21:40.773530 [info ] [MainThread]: Configuration:
[0m16:21:40.774440 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m16:21:40.775482 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m16:21:40.775482 [info ] [MainThread]: Required dependencies:
[0m16:21:40.776444 [debug] [MainThread]: Executing "git --help"
[0m16:21:40.803286 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m16:21:40.803286 [debug] [MainThread]: STDERR: "b''"
[0m16:21:40.803286 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m16:21:40.804806 [info ] [MainThread]: Connection:
[0m16:21:40.805822 [info ] [MainThread]:   method: service-account
[0m16:21:40.806829 [info ] [MainThread]:   database: igneous-sandbox-381622
[0m16:21:40.807878 [info ] [MainThread]:   execution_project: igneous-sandbox-381622
[0m16:21:40.807878 [info ] [MainThread]:   schema: dbt_dw
[0m16:21:40.808846 [info ] [MainThread]:   location: us-east4
[0m16:21:40.808846 [info ] [MainThread]:   priority: None
[0m16:21:40.809844 [info ] [MainThread]:   maximum_bytes_billed: None
[0m16:21:40.810845 [info ] [MainThread]:   impersonate_service_account: None
[0m16:21:40.810845 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m16:21:40.811842 [info ] [MainThread]:   job_retries: 1
[0m16:21:40.811842 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m16:21:40.813293 [info ] [MainThread]:   job_execution_timeout_seconds: None
[0m16:21:40.813293 [info ] [MainThread]:   keyfile: C:\Git\sb_loja_virtual\key_project_sb.json
[0m16:21:40.813293 [info ] [MainThread]:   timeout_seconds: None
[0m16:21:40.814805 [info ] [MainThread]:   refresh_token: None
[0m16:21:40.815821 [info ] [MainThread]:   client_id: None
[0m16:21:40.816818 [info ] [MainThread]:   token_uri: None
[0m16:21:40.816818 [info ] [MainThread]:   dataproc_region: None
[0m16:21:40.817828 [info ] [MainThread]:   dataproc_cluster_name: None
[0m16:21:40.818840 [info ] [MainThread]:   gcs_bucket: None
[0m16:21:40.818840 [info ] [MainThread]:   dataproc_batch: None
[0m16:21:40.819837 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:21:40.820380 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m16:21:40.820380 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:21:40.821906 [debug] [MainThread]: On debug: select 1 as id
[0m16:21:42.716973 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4e8240f7-3a1e-4d92-b935-a5ebc138e3d3&page=queryresults
[0m16:21:43.226776 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m16:21:43.228755 [info ] [MainThread]: [32mAll checks passed![0m
[0m16:21:43.230350 [debug] [MainThread]: Command `dbt debug` succeeded at 16:21:43.229334 after 3.01 seconds
[0m16:21:43.230350 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m16:21:43.230350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021303AF13D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000213070C2490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021307136CA0>]}
[0m16:21:43.231862 [debug] [MainThread]: Flushing usage events
[0m16:21:55.037612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020990D6B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002098FCB07F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002098FCB04F0>]}


============================== 16:21:55.040661 | 1dd28214-a494-425e-ba6b-f02a3729d365 ==============================
[0m16:21:55.040661 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:21:55.041696 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual\\dbt_shibaribrasil\\dbt_shibaribrasil', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt debug --profiles-dir C:\\Git\\sb_loja_virtual\\dbt_shibaribrasil\\dbt_shibaribrasil', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:21:55.042941 [info ] [MainThread]: dbt version: 1.7.4
[0m16:21:55.042941 [info ] [MainThread]: python version: 3.8.10
[0m16:21:55.042941 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m16:21:55.044449 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m16:21:55.045466 [info ] [MainThread]: Using profiles dir at C:\Git\sb_loja_virtual\dbt_shibaribrasil\dbt_shibaribrasil
[0m16:21:55.045466 [info ] [MainThread]: Using profiles.yml file at C:\Git\sb_loja_virtual\dbt_shibaribrasil\dbt_shibaribrasil\profiles.yml
[0m16:21:55.046516 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_project.yml
[0m16:21:55.129641 [info ] [MainThread]: Configuration:
[0m16:21:55.129641 [info ] [MainThread]:   profiles.yml file [[31mERROR not found[0m]
[0m16:21:55.130578 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m16:21:55.130578 [info ] [MainThread]: Required dependencies:
[0m16:21:55.131577 [debug] [MainThread]: Executing "git --help"
[0m16:21:55.162008 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m16:21:55.163009 [debug] [MainThread]: STDERR: "b''"
[0m16:21:55.163009 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m16:21:55.163009 [info ] [MainThread]: Connection test skipped since no profile was found
[0m16:21:55.164523 [info ] [MainThread]: [31m1 check failed:[0m
[0m16:21:55.164523 [info ] [MainThread]: dbt looked for a profiles.yml file in C:\Git\sb_loja_virtual\dbt_shibaribrasil\dbt_shibaribrasil\profiles.yml, but did
not find one. For more information on configuring your profile, consult the
documentation:

https://docs.getdbt.com/docs/configure-your-profile


[0m16:21:55.166548 [debug] [MainThread]: Command `dbt debug` failed at 16:21:55.166548 after 0.16 seconds
[0m16:21:55.166548 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020990D6B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002098CAED7C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020992EBBA90>]}
[0m16:21:55.166548 [debug] [MainThread]: Flushing usage events
[0m16:22:13.109793 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002385B195430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002385BAE43A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002385A1195E0>]}


============================== 16:22:13.113456 | d3ff7e5b-dc0a-4bea-bc2c-5da4deec7180 ==============================
[0m16:22:13.113456 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:22:13.114402 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt debug --profiles-dir C:\\Git\\sb_loja_virtual', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:22:13.115401 [info ] [MainThread]: dbt version: 1.7.4
[0m16:22:13.116405 [info ] [MainThread]: python version: 3.8.10
[0m16:22:13.116405 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m16:22:13.117397 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m16:22:13.569708 [info ] [MainThread]: Using profiles dir at C:\Git\sb_loja_virtual
[0m16:22:13.570716 [info ] [MainThread]: Using profiles.yml file at C:\Git\sb_loja_virtual\profiles.yml
[0m16:22:13.571652 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_project.yml
[0m16:22:13.573090 [info ] [MainThread]: adapter type: bigquery
[0m16:22:13.573615 [info ] [MainThread]: adapter version: 1.7.2
[0m16:22:13.677865 [info ] [MainThread]: Configuration:
[0m16:22:13.678866 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m16:22:13.679789 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m16:22:13.679789 [info ] [MainThread]: Required dependencies:
[0m16:22:13.679789 [debug] [MainThread]: Executing "git --help"
[0m16:22:13.708503 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m16:22:13.708503 [debug] [MainThread]: STDERR: "b''"
[0m16:22:13.709525 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m16:22:13.709525 [info ] [MainThread]: Connection:
[0m16:22:13.710501 [info ] [MainThread]:   method: service-account
[0m16:22:13.710501 [info ] [MainThread]:   database: igneous-sandbox-381622
[0m16:22:13.711503 [info ] [MainThread]:   execution_project: igneous-sandbox-381622
[0m16:22:13.711503 [info ] [MainThread]:   schema: dbt_dw
[0m16:22:13.712698 [info ] [MainThread]:   location: us-east4
[0m16:22:13.712698 [info ] [MainThread]:   priority: None
[0m16:22:13.713666 [info ] [MainThread]:   maximum_bytes_billed: None
[0m16:22:13.713666 [info ] [MainThread]:   impersonate_service_account: None
[0m16:22:13.714679 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m16:22:13.715669 [info ] [MainThread]:   job_retries: 1
[0m16:22:13.716668 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m16:22:13.717669 [info ] [MainThread]:   job_execution_timeout_seconds: None
[0m16:22:13.717669 [info ] [MainThread]:   keyfile: C:\Git\sb_loja_virtual\key_project_sb.json
[0m16:22:13.717669 [info ] [MainThread]:   timeout_seconds: None
[0m16:22:13.718675 [info ] [MainThread]:   refresh_token: None
[0m16:22:13.718675 [info ] [MainThread]:   client_id: None
[0m16:22:13.719666 [info ] [MainThread]:   token_uri: None
[0m16:22:13.719666 [info ] [MainThread]:   dataproc_region: None
[0m16:22:13.719666 [info ] [MainThread]:   dataproc_cluster_name: None
[0m16:22:13.720666 [info ] [MainThread]:   gcs_bucket: None
[0m16:22:13.720666 [info ] [MainThread]:   dataproc_batch: None
[0m16:22:13.721668 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:22:13.722175 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m16:22:13.722175 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:22:13.724688 [debug] [MainThread]: On debug: select 1 as id
[0m16:22:14.518722 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a61797db-38a2-4693-b276-2c2a11b7a1db&page=queryresults
[0m16:22:15.028695 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m16:22:15.030688 [info ] [MainThread]: [32mAll checks passed![0m
[0m16:22:15.032807 [debug] [MainThread]: Command `dbt debug` succeeded at 16:22:15.032807 after 1.99 seconds
[0m16:22:15.033856 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m16:22:15.033856 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002385B195430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002385E7BCEE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002385E753400>]}
[0m16:22:15.034808 [debug] [MainThread]: Flushing usage events
[0m16:23:56.460792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D720B24430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D71FAC39A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D71FAC3D30>]}


============================== 16:23:56.464834 | 71024de1-cacb-41b8-8eb7-1f972d7bbdea ==============================
[0m16:23:56.464834 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:23:56.465842 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:23:56.944558 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '71024de1-cacb-41b8-8eb7-1f972d7bbdea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D71FAC4250>]}
[0m16:23:57.011611 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '71024de1-cacb-41b8-8eb7-1f972d7bbdea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7241B1A90>]}
[0m16:23:57.013253 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:23:57.020021 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:23:57.066411 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:23:57.067538 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:23:57.067538 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 2 unused configuration paths:
- models.shibaribrasil.2.dw
- models.shibaribrasil.3.az
[0m16:23:57.072067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '71024de1-cacb-41b8-8eb7-1f972d7bbdea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7244370D0>]}
[0m16:23:57.080631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '71024de1-cacb-41b8-8eb7-1f972d7bbdea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D7243726D0>]}
[0m16:23:57.081629 [info ] [MainThread]: Found 1 model, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:23:57.081881 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '71024de1-cacb-41b8-8eb7-1f972d7bbdea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D724372E20>]}
[0m16:23:57.082957 [info ] [MainThread]: 
[0m16:23:57.082957 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:23:57.085619 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:23:57.085619 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:23:57.993925 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:23:57.995932 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:23:58.712137 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '71024de1-cacb-41b8-8eb7-1f972d7bbdea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D724200B50>]}
[0m16:23:58.714660 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:23:58.717195 [info ] [MainThread]: 
[0m16:23:58.730852 [debug] [Thread-1  ]: Began running node model.shibaribrasil.testetabela
[0m16:23:58.733033 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.testetabela ............................. [RUN]
[0m16:23:58.736539 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.testetabela'
[0m16:23:58.739610 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.testetabela
[0m16:23:58.768736 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.testetabela"
[0m16:23:58.773556 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (compile): 16:23:58.740554 => 16:23:58.772461
[0m16:23:58.775079 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.testetabela
[0m16:23:58.888907 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.testetabela"
[0m16:23:58.891804 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:23:58.898947 [debug] [Thread-1  ]: On model.shibaribrasil.testetabela: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.testetabela"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`testetabela`
  OPTIONS()
  as 

SELECT
  id
FROM `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`;


[0m16:23:59.830574 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9f7eae62-22f6-4a7d-b254-00c9f9a95b20&page=queryresults
[0m16:24:00.303090 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.testetabela (execute): 16:23:58.776598 => 16:24:00.303090
[0m16:24:00.303090 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71024de1-cacb-41b8-8eb7-1f972d7bbdea', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D724524EB0>]}
[0m16:24:00.304595 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.testetabela ........................ [[32mCREATE VIEW (0 processed)[0m in 1.57s]
[0m16:24:00.305603 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.testetabela
[0m16:24:00.309602 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:24:00.310618 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:24:00.310618 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:24:00.312149 [debug] [MainThread]: Connection 'model.shibaribrasil.testetabela' was properly closed.
[0m16:24:00.313164 [info ] [MainThread]: 
[0m16:24:00.315696 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.23 seconds (3.23s).
[0m16:24:00.318688 [debug] [MainThread]: Command end result
[0m16:24:00.346974 [info ] [MainThread]: 
[0m16:24:00.348848 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:24:00.350982 [info ] [MainThread]: 
[0m16:24:00.351994 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:24:00.355942 [debug] [MainThread]: Command `dbt run` succeeded at 16:24:00.354842 after 3.96 seconds
[0m16:24:00.356862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D720B24430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D724134C40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D724434FD0>]}
[0m16:24:00.358022 [debug] [MainThread]: Flushing usage events
[0m16:28:51.603456 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5448CD400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5451DC760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C54385A7C0>]}


============================== 16:28:51.607031 | b676423c-5d95-4df0-b285-1d6522789aee ==============================
[0m16:28:51.607031 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:28:51.608101 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt debug --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m16:28:51.608101 [info ] [MainThread]: dbt version: 1.7.4
[0m16:28:51.609102 [info ] [MainThread]: python version: 3.8.10
[0m16:28:51.609102 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m16:28:51.610101 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m16:28:51.944191 [info ] [MainThread]: Using profiles dir at C:\Git\sb_loja_virtual
[0m16:28:51.944191 [info ] [MainThread]: Using profiles.yml file at C:\Git\sb_loja_virtual\profiles.yml
[0m16:28:51.945114 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_project.yml
[0m16:28:51.946140 [info ] [MainThread]: adapter type: bigquery
[0m16:28:51.947140 [info ] [MainThread]: adapter version: 1.7.2
[0m16:28:52.037916 [info ] [MainThread]: Configuration:
[0m16:28:52.038922 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m16:28:52.039867 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m16:28:52.039867 [info ] [MainThread]: Required dependencies:
[0m16:28:52.040863 [debug] [MainThread]: Executing "git --help"
[0m16:28:52.066900 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m16:28:52.066900 [debug] [MainThread]: STDERR: "b''"
[0m16:28:52.066900 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m16:28:52.068197 [info ] [MainThread]: Connection:
[0m16:28:52.069206 [info ] [MainThread]:   method: service-account
[0m16:28:52.069206 [info ] [MainThread]:   database: igneous-sandbox-381622
[0m16:28:52.070247 [info ] [MainThread]:   execution_project: igneous-sandbox-381622
[0m16:28:52.070247 [info ] [MainThread]:   schema: dbt_dw
[0m16:28:52.071203 [info ] [MainThread]:   location: us-east4
[0m16:28:52.071203 [info ] [MainThread]:   priority: None
[0m16:28:52.072201 [info ] [MainThread]:   maximum_bytes_billed: None
[0m16:28:52.072201 [info ] [MainThread]:   impersonate_service_account: None
[0m16:28:52.072201 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m16:28:52.073205 [info ] [MainThread]:   job_retries: 1
[0m16:28:52.073205 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m16:28:52.074124 [info ] [MainThread]:   job_execution_timeout_seconds: None
[0m16:28:52.074124 [info ] [MainThread]:   keyfile: C:\Git\key_project_sb.json
[0m16:28:52.075154 [info ] [MainThread]:   timeout_seconds: None
[0m16:28:52.075154 [info ] [MainThread]:   refresh_token: None
[0m16:28:52.076141 [info ] [MainThread]:   client_id: None
[0m16:28:52.077136 [info ] [MainThread]:   token_uri: None
[0m16:28:52.077136 [info ] [MainThread]:   dataproc_region: None
[0m16:28:52.077136 [info ] [MainThread]:   dataproc_cluster_name: None
[0m16:28:52.078137 [info ] [MainThread]:   gcs_bucket: None
[0m16:28:52.078137 [info ] [MainThread]:   dataproc_batch: None
[0m16:28:52.079160 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:28:52.079160 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m16:28:52.079160 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:28:52.081730 [debug] [MainThread]: On debug: select 1 as id
[0m16:28:53.107813 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:11fe03d6-d242-48d5-b0c1-64db0a62ac53&page=queryresults
[0m16:28:53.716071 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m16:28:53.717680 [info ] [MainThread]: [32mAll checks passed![0m
[0m16:28:53.719820 [debug] [MainThread]: Command `dbt debug` succeeded at 16:28:53.719820 after 2.19 seconds
[0m16:28:53.720741 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m16:28:53.721819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5448CD400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C547EF39A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C547F00340>]}
[0m16:28:53.722818 [debug] [MainThread]: Flushing usage events
[0m16:44:00.389459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA8DDC2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA8CD659D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA8CD65B80>]}


============================== 16:44:00.392525 | 180ed13b-0c19-4172-8167-c6b1150085fe ==============================
[0m16:44:00.392525 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:44:00.393547 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models stg_produto', 'send_anonymous_usage_stats': 'True'}
[0m16:44:00.867351 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '180ed13b-0c19-4172-8167-c6b1150085fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA8FF2CAC0>]}
[0m16:44:00.930799 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '180ed13b-0c19-4172-8167-c6b1150085fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA91457550>]}
[0m16:44:00.931806 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:44:00.938349 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:44:00.944337 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m16:44:00.945348 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '180ed13b-0c19-4172-8167-c6b1150085fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA91518580>]}
[0m16:44:01.773032 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 2 unused configuration paths:
- models.shibaribrasil.2.dw
- models.shibaribrasil.3.az
[0m16:44:01.777060 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '180ed13b-0c19-4172-8167-c6b1150085fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA918288B0>]}
[0m16:44:01.786030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '180ed13b-0c19-4172-8167-c6b1150085fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA91828610>]}
[0m16:44:01.787030 [info ] [MainThread]: Found 2 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:44:01.787030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '180ed13b-0c19-4172-8167-c6b1150085fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA91828670>]}
[0m16:44:01.788034 [info ] [MainThread]: 
[0m16:44:01.789038 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:44:01.790038 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:44:01.791030 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:44:02.739993 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:44:02.740984 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:44:03.373479 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '180ed13b-0c19-4172-8167-c6b1150085fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA91772D60>]}
[0m16:44:03.375762 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:44:03.378115 [info ] [MainThread]: 
[0m16:44:03.389853 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m16:44:03.391925 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m16:44:03.395006 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m16:44:03.396943 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m16:44:03.426055 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m16:44:03.431003 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 16:44:03.397941 => 16:44:03.429001
[0m16:44:03.432994 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m16:44:03.482911 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m16:44:03.483958 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:44:03.486969 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS()
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m16:44:04.486293 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:556ccd8f-2528-4b0b-ae94-a026e205c12e&page=queryresults
[0m16:44:05.109208 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 16:44:03.432994 => 16:44:05.109208
[0m16:44:05.110230 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '180ed13b-0c19-4172-8167-c6b1150085fe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA9184C040>]}
[0m16:44:05.110230 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.72s]
[0m16:44:05.111226 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m16:44:05.112740 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:44:05.113745 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:44:05.113745 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:44:05.113745 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_produto' was properly closed.
[0m16:44:05.113745 [info ] [MainThread]: 
[0m16:44:05.114750 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.33 seconds (3.33s).
[0m16:44:05.116761 [debug] [MainThread]: Command end result
[0m16:44:05.124746 [info ] [MainThread]: 
[0m16:44:05.125752 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:44:05.126752 [info ] [MainThread]: 
[0m16:44:05.127750 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:44:05.129022 [debug] [MainThread]: Command `dbt run` succeeded at 16:44:05.129022 after 4.79 seconds
[0m16:44:05.129022 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA8DDC2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA9160EFD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FA918C8E20>]}
[0m16:44:05.130017 [debug] [MainThread]: Flushing usage events
[0m16:51:03.577002 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F35B8D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F34B036A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F34B03DC0>]}


============================== 16:51:03.581008 | cea304b0-90ed-4590-964e-4ad4f28e0e91 ==============================
[0m16:51:03.581008 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:51:03.582007 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --models dm_produto', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:51:03.999544 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cea304b0-90ed-4590-964e-4ad4f28e0e91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F34B038E0>]}
[0m16:51:04.061302 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cea304b0-90ed-4590-964e-4ad4f28e0e91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F391FA6A0>]}
[0m16:51:04.062303 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:51:04.068787 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:51:04.162798 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 1 files added, 0 files changed.
[0m16:51:04.163798 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\2.dw\dm_produto.sql
[0m16:51:04.163798 [debug] [MainThread]: Partial parsing: deleted file: shibaribrasil://models\1.stg\testetabela.sql
[0m16:51:04.260284 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.shibaribrasil.3.az
[0m16:51:04.265185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cea304b0-90ed-4590-964e-4ad4f28e0e91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F395409A0>]}
[0m16:51:04.273652 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cea304b0-90ed-4590-964e-4ad4f28e0e91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F3933BD30>]}
[0m16:51:04.273652 [info ] [MainThread]: Found 2 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:51:04.274660 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cea304b0-90ed-4590-964e-4ad4f28e0e91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F3933B310>]}
[0m16:51:04.275656 [info ] [MainThread]: 
[0m16:51:04.277188 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:51:04.279201 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:51:04.279201 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:51:05.157536 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622, now create_igneous-sandbox-381622_dbt_dw_dw)
[0m16:51:05.159529 [debug] [ThreadPool]: Creating schema "database: "igneous-sandbox-381622"
schema: "dbt_dw_dw"
"
[0m16:51:05.172135 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:51:05.173146 [debug] [ThreadPool]: On create_igneous-sandbox-381622_dbt_dw_dw: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "connection_name": "create_igneous-sandbox-381622_dbt_dw_dw"} */
create schema if not exists `igneous-sandbox-381622`.`dbt_dw_dw`
  
[0m16:51:06.066362 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:339dc78f-3109-4fbd-8b22-98012b24b06a&page=queryresults
[0m16:51:07.010672 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:51:07.011799 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:51:07.013712 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:51:07.015731 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:51:07.718447 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cea304b0-90ed-4590-964e-4ad4f28e0e91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F3944F2E0>]}
[0m16:51:07.720428 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:51:07.721984 [info ] [MainThread]: 
[0m16:51:07.731862 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m16:51:07.732867 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m16:51:07.734864 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.dm_produto'
[0m16:51:07.735863 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m16:51:07.749534 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m16:51:07.753474 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 16:51:07.736870 => 16:51:07.752478
[0m16:51:07.754486 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m16:51:07.788244 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m16:51:07.789242 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:51:07.791244 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m16:51:08.888632 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8b1be5ae-82af-4fd0-8fb7-4b4dea5f0aac&page=queryresults
[0m16:51:09.351938 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Column name cd_categoria is ambiguous at [72:12]')
[0m16:51:10.681955 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6278724e-daf2-4495-a1cd-a59be3e14d09&page=queryresults
[0m16:51:11.195063 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6278724e-daf2-4495-a1cd-a59be3e14d09&page=queryresults
[0m16:51:11.197634 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 16:51:07.755514 => 16:51:11.196973
[0m16:51:11.207348 [debug] [Thread-1  ]: Database Error in model dm_produto (models\2.dw\dm_produto.sql)
  Column name cd_categoria is ambiguous at [72:12]
  compiled Code at target\run\shibaribrasil\models\2.dw\dm_produto.sql
[0m16:51:11.209431 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cea304b0-90ed-4590-964e-4ad4f28e0e91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F3964F610>]}
[0m16:51:11.211414 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_dw.dm_produto ..................... [[31mERROR[0m in 3.47s]
[0m16:51:11.213368 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m16:51:11.220032 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:51:11.220988 [debug] [MainThread]: Connection 'create_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:51:11.221987 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:51:11.223045 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:51:11.223997 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m16:51:11.224981 [info ] [MainThread]: 
[0m16:51:11.227828 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.95 seconds (6.95s).
[0m16:51:11.231509 [debug] [MainThread]: Command end result
[0m16:51:11.250191 [info ] [MainThread]: 
[0m16:51:11.251200 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:51:11.252191 [info ] [MainThread]: 
[0m16:51:11.253186 [error] [MainThread]:   Database Error in model dm_produto (models\2.dw\dm_produto.sql)
  Column name cd_categoria is ambiguous at [72:12]
  compiled Code at target\run\shibaribrasil\models\2.dw\dm_produto.sql
[0m16:51:11.255194 [info ] [MainThread]: 
[0m16:51:11.257193 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:51:11.260681 [debug] [MainThread]: Command `dbt run` failed at 16:51:11.260681 after 7.74 seconds
[0m16:51:11.260681 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F35B8D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F391FA6A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021F393AC0D0>]}
[0m16:51:11.261664 [debug] [MainThread]: Flushing usage events
[0m16:51:34.752024 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF63562430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF625059D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF62505B80>]}


============================== 16:51:34.755079 | bc8921d9-67dd-42f6-bed6-987d3a5b3748 ==============================
[0m16:51:34.755079 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:51:34.756068 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models dm_produto', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m16:51:35.184181 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bc8921d9-67dd-42f6-bed6-987d3a5b3748', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF624EC3D0>]}
[0m16:51:35.246833 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bc8921d9-67dd-42f6-bed6-987d3a5b3748', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF66AEB2B0>]}
[0m16:51:35.248432 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:51:35.255429 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:51:35.367041 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:51:35.367041 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\2.dw\dm_produto.sql
[0m16:51:35.469233 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.shibaribrasil.3.az
[0m16:51:35.473233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bc8921d9-67dd-42f6-bed6-987d3a5b3748', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF66CBB970>]}
[0m16:51:35.482181 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bc8921d9-67dd-42f6-bed6-987d3a5b3748', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF66DA91C0>]}
[0m16:51:35.482181 [info ] [MainThread]: Found 2 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:51:35.483183 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bc8921d9-67dd-42f6-bed6-987d3a5b3748', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF66C76400>]}
[0m16:51:35.485176 [info ] [MainThread]: 
[0m16:51:35.486179 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:51:35.488173 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:51:35.488173 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:51:36.192333 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:51:36.192333 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:51:36.195349 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:51:36.196945 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:51:36.884018 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bc8921d9-67dd-42f6-bed6-987d3a5b3748', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF66B83190>]}
[0m16:51:36.887019 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:51:36.888707 [info ] [MainThread]: 
[0m16:51:36.899440 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m16:51:36.901436 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m16:51:36.903359 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.dm_produto'
[0m16:51:36.905342 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m16:51:36.930140 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m16:51:36.933156 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 16:51:36.905342 => 16:51:36.932137
[0m16:51:36.936138 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m16:51:36.968754 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m16:51:36.969755 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:51:36.971756 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m16:51:38.127089 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fb709fad-d0ec-43af-8da7-5a9d0c4bbd9a&page=queryresults
[0m16:51:38.638873 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Name ds_subcategoria not found inside a at [106:14]')
[0m16:51:39.824117 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b06a80bd-4dbd-4d75-a7c8-8de3a9436ae3&page=queryresults
[0m16:51:40.277234 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b06a80bd-4dbd-4d75-a7c8-8de3a9436ae3&page=queryresults
[0m16:51:40.279962 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 16:51:36.937148 => 16:51:40.278971
[0m16:51:40.287700 [debug] [Thread-1  ]: Database Error in model dm_produto (models\2.dw\dm_produto.sql)
  Name ds_subcategoria not found inside a at [106:14]
  compiled Code at target\run\shibaribrasil\models\2.dw\dm_produto.sql
[0m16:51:40.289269 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bc8921d9-67dd-42f6-bed6-987d3a5b3748', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF66B83190>]}
[0m16:51:40.290323 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_dw.dm_produto ..................... [[31mERROR[0m in 3.39s]
[0m16:51:40.291319 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m16:51:40.295332 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:51:40.296355 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:51:40.297328 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:51:40.297328 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:51:40.298337 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m16:51:40.298337 [info ] [MainThread]: 
[0m16:51:40.299338 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.81 seconds (4.81s).
[0m16:51:40.300337 [debug] [MainThread]: Command end result
[0m16:51:40.309993 [info ] [MainThread]: 
[0m16:51:40.311069 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:51:40.311069 [info ] [MainThread]: 
[0m16:51:40.311963 [error] [MainThread]:   Database Error in model dm_produto (models\2.dw\dm_produto.sql)
  Name ds_subcategoria not found inside a at [106:14]
  compiled Code at target\run\shibaribrasil\models\2.dw\dm_produto.sql
[0m16:51:40.312964 [info ] [MainThread]: 
[0m16:51:40.312964 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:51:40.313964 [debug] [MainThread]: Command `dbt run` failed at 16:51:40.313964 after 5.62 seconds
[0m16:51:40.313964 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF63562430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF66AEB2B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CF612086D0>]}
[0m16:51:40.314996 [debug] [MainThread]: Flushing usage events
[0m16:52:14.458522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E267023D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E256A42E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E256A4760>]}


============================== 16:52:14.461522 | f95792b5-5f92-407c-acdf-4da83048d901 ==============================
[0m16:52:14.461522 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:52:14.462585 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models dm_produto', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:52:14.900987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f95792b5-5f92-407c-acdf-4da83048d901', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E2568BA60>]}
[0m16:52:14.966691 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f95792b5-5f92-407c-acdf-4da83048d901', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E29D8D7F0>]}
[0m16:52:14.968259 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:52:14.974334 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:52:15.052918 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m16:52:15.052918 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\2.dw\dm_produto.sql
[0m16:52:15.149990 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.shibaribrasil.3.az
[0m16:52:15.154620 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f95792b5-5f92-407c-acdf-4da83048d901', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E2A197EE0>]}
[0m16:52:15.162324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f95792b5-5f92-407c-acdf-4da83048d901', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E29EA96D0>]}
[0m16:52:15.163367 [info ] [MainThread]: Found 2 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:52:15.164349 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f95792b5-5f92-407c-acdf-4da83048d901', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E29CF1400>]}
[0m16:52:15.165356 [info ] [MainThread]: 
[0m16:52:15.166361 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:52:15.168329 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:52:15.168329 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:52:15.914642 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:52:15.914642 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:52:15.945966 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:52:15.947424 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:52:16.610625 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f95792b5-5f92-407c-acdf-4da83048d901', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E29CF1400>]}
[0m16:52:16.611620 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:52:16.613615 [info ] [MainThread]: 
[0m16:52:16.621234 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m16:52:16.622224 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m16:52:16.624230 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.dm_produto'
[0m16:52:16.625232 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m16:52:16.634165 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m16:52:16.636168 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 16:52:16.625232 => 16:52:16.635169
[0m16:52:16.637173 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m16:52:16.664367 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m16:52:16.665387 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:52:16.666328 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m16:52:17.997499 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:79ae4398-cc15-43d2-af54-368996377076&page=queryresults
[0m16:52:20.614508 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 16:52:16.637173 => 16:52:20.614508
[0m16:52:20.615510 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f95792b5-5f92-407c-acdf-4da83048d901', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E2A1EEDF0>]}
[0m16:52:20.616825 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 3.99s]
[0m16:52:20.617864 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m16:52:20.619825 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:52:20.619825 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:52:20.620826 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:52:20.620826 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:52:20.621825 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m16:52:20.621825 [info ] [MainThread]: 
[0m16:52:20.622823 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.46 seconds (5.46s).
[0m16:52:20.623855 [debug] [MainThread]: Command end result
[0m16:52:20.643838 [info ] [MainThread]: 
[0m16:52:20.644878 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:52:20.646872 [info ] [MainThread]: 
[0m16:52:20.647841 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:52:20.649857 [debug] [MainThread]: Command `dbt run` succeeded at 16:52:20.649857 after 6.24 seconds
[0m16:52:20.649857 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E267023D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E29DA9DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E29D568E0>]}
[0m16:52:20.650900 [debug] [MainThread]: Flushing usage events
[0m16:54:51.218571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5AA3E1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5A93842E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5A9384760>]}


============================== 16:54:51.221602 | 708dc89a-a244-45ff-9e12-3e1699ac8c51 ==============================
[0m16:54:51.221602 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:54:51.222606 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models stg_categoria_produtos', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:54:51.658566 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '708dc89a-a244-45ff-9e12-3e1699ac8c51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5A936CBE0>]}
[0m16:54:51.731614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '708dc89a-a244-45ff-9e12-3e1699ac8c51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5A9386250>]}
[0m16:54:51.732600 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:54:51.741605 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:54:51.853646 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m16:54:51.854647 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\2.dw\dm_produto.sql
[0m16:54:51.854647 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_produto.sql
[0m16:54:51.964800 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.shibaribrasil.3.az
[0m16:54:51.969324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '708dc89a-a244-45ff-9e12-3e1699ac8c51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5ADD5EE80>]}
[0m16:54:51.977733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '708dc89a-a244-45ff-9e12-3e1699ac8c51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5ADC14190>]}
[0m16:54:51.977733 [info ] [MainThread]: Found 2 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:54:51.978735 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '708dc89a-a244-45ff-9e12-3e1699ac8c51', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5AD9DE880>]}
[0m16:54:51.978735 [warn ] [MainThread]: The selection criterion 'stg_categoria_produtos' does not match any nodes
[0m16:54:51.979732 [info ] [MainThread]: 
[0m16:54:51.980734 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m16:54:51.981730 [debug] [MainThread]: Command end result
[0m16:54:51.989077 [debug] [MainThread]: Command `dbt run` succeeded at 16:54:51.989077 after 0.84 seconds
[0m16:54:51.989077 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5AA3E1430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5A9386250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5AD9C7460>]}
[0m16:54:51.990179 [debug] [MainThread]: Flushing usage events
[0m16:55:43.325346 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7A82ED430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7A72739A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7A7273D30>]}


============================== 16:55:43.329649 | eda5ad82-7e0e-44df-9b2a-c24abfaff01f ==============================
[0m16:55:43.329649 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:55:43.330649 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --models stg_categoria_produtos', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:55:43.797725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'eda5ad82-7e0e-44df-9b2a-c24abfaff01f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7A725C970>]}
[0m16:55:43.865833 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'eda5ad82-7e0e-44df-9b2a-c24abfaff01f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7AB835BB0>]}
[0m16:55:43.866828 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:55:43.873369 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:55:43.943232 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:55:43.943232 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:55:43.944234 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.shibaribrasil.3.az
[0m16:55:43.948979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'eda5ad82-7e0e-44df-9b2a-c24abfaff01f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7ABBF0340>]}
[0m16:55:43.957374 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'eda5ad82-7e0e-44df-9b2a-c24abfaff01f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7ABB22250>]}
[0m16:55:43.957374 [info ] [MainThread]: Found 2 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:55:43.958375 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'eda5ad82-7e0e-44df-9b2a-c24abfaff01f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7AB987820>]}
[0m16:55:43.958375 [warn ] [MainThread]: The selection criterion 'stg_categoria_produtos' does not match any nodes
[0m16:55:43.959373 [info ] [MainThread]: 
[0m16:55:43.960372 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m16:55:43.960372 [debug] [MainThread]: Command end result
[0m16:55:43.968396 [debug] [MainThread]: Command `dbt run` succeeded at 16:55:43.968396 after 0.70 seconds
[0m16:55:43.969473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7A82ED430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7AB9978B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B7ABBD1E20>]}
[0m16:55:43.969473 [debug] [MainThread]: Flushing usage events
[0m16:56:32.452507 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219BF10D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219BE0829A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219BE082D30>]}


============================== 16:56:32.455490 | ad6e4775-2c6b-4a88-9a72-f307cbeb1746 ==============================
[0m16:56:32.455490 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:56:32.456491 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models stg_categoria_produto', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:56:32.891415 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ad6e4775-2c6b-4a88-9a72-f307cbeb1746', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219BE085040>]}
[0m16:56:32.950948 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ad6e4775-2c6b-4a88-9a72-f307cbeb1746', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219C27826D0>]}
[0m16:56:32.952946 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:56:32.958554 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:56:33.008977 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m16:56:33.009974 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\1.stg\stg_categoria_produto.sql
[0m16:56:33.101102 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.shibaribrasil.3.az
[0m16:56:33.106059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ad6e4775-2c6b-4a88-9a72-f307cbeb1746', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219C2A316A0>]}
[0m16:56:33.115058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ad6e4775-2c6b-4a88-9a72-f307cbeb1746', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219C29F0E20>]}
[0m16:56:33.115058 [info ] [MainThread]: Found 3 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:56:33.116124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ad6e4775-2c6b-4a88-9a72-f307cbeb1746', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219C29F0DF0>]}
[0m16:56:33.117109 [info ] [MainThread]: 
[0m16:56:33.118476 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:56:33.120567 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:56:33.120567 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:56:33.906781 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:56:33.907390 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:56:33.948275 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:56:33.948275 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:56:34.791055 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ad6e4775-2c6b-4a88-9a72-f307cbeb1746', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219C2926070>]}
[0m16:56:34.792996 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:56:34.794034 [info ] [MainThread]: 
[0m16:56:34.803507 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m16:56:34.805510 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m16:56:34.808000 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m16:56:34.809025 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m16:56:34.823999 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m16:56:34.829584 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 16:56:34.809025 => 16:56:34.828585
[0m16:56:34.830693 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m16:56:34.854169 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m16:56:34.856267 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:56:34.857378 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS()
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categoria_produtos`
)

select *
  from cte_categoria;


[0m16:56:35.706440 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1d4dcd9c-4ea4-4930-b229-156cf5bab86b&page=queryresults
[0m16:56:35.707857 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
/* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS()
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categoria_produtos`
)

select *
  from cte_categoria;


[0m16:56:35.708912 [debug] [Thread-1  ]: BigQuery adapter: 404 Not found: Table igneous-sandbox-381622:datalake_bling.categoria_produtos was not found in location us-east4

Location: us-east4
Job ID: 1d4dcd9c-4ea4-4930-b229-156cf5bab86b

[0m16:56:35.709917 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 16:56:34.830693 => 16:56:35.709917
[0m16:56:35.718452 [debug] [Thread-1  ]: Runtime Error in model stg_categoria_produto (models\1.stg\stg_categoria_produto.sql)
  404 Not found: Table igneous-sandbox-381622:datalake_bling.categoria_produtos was not found in location us-east4
  
  Location: us-east4
  Job ID: 1d4dcd9c-4ea4-4930-b229-156cf5bab86b
  
[0m16:56:35.720520 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ad6e4775-2c6b-4a88-9a72-f307cbeb1746', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219C2BF5550>]}
[0m16:56:35.721526 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_categoria_produto .......... [[31mERROR[0m in 0.91s]
[0m16:56:35.724530 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m16:56:35.729181 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:56:35.730173 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:56:35.731180 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:56:35.732175 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:56:35.733186 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_categoria_produto' was properly closed.
[0m16:56:35.734180 [info ] [MainThread]: 
[0m16:56:35.736176 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 2.62 seconds (2.62s).
[0m16:56:35.738780 [debug] [MainThread]: Command end result
[0m16:56:35.762697 [info ] [MainThread]: 
[0m16:56:35.764662 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:56:35.767672 [info ] [MainThread]: 
[0m16:56:35.769667 [error] [MainThread]:   Runtime Error in model stg_categoria_produto (models\1.stg\stg_categoria_produto.sql)
  404 Not found: Table igneous-sandbox-381622:datalake_bling.categoria_produtos was not found in location us-east4
  
  Location: us-east4
  Job ID: 1d4dcd9c-4ea4-4930-b229-156cf5bab86b
  
[0m16:56:35.772672 [info ] [MainThread]: 
[0m16:56:35.773648 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m16:56:35.778636 [debug] [MainThread]: Command `dbt run` failed at 16:56:35.778636 after 3.39 seconds
[0m16:56:35.780720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219BF10D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219C27826D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000219C27D9640>]}
[0m16:56:35.780720 [debug] [MainThread]: Flushing usage events
[0m16:57:03.887269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212EE7A1460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212ED7499D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212ED749B80>]}


============================== 16:57:03.890740 | 93a53c2e-3215-43c2-bfa7-0b6f6b5235da ==============================
[0m16:57:03.890740 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:57:03.891728 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models stg_categoria_produto', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m16:57:04.370074 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '93a53c2e-3215-43c2-bfa7-0b6f6b5235da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212ED7468E0>]}
[0m16:57:04.434671 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '93a53c2e-3215-43c2-bfa7-0b6f6b5235da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212F1DD96D0>]}
[0m16:57:04.436675 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:57:04.443132 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:57:04.544231 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m16:57:04.544231 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\source.yml
[0m16:57:04.545234 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_categoria_produto.sql
[0m16:57:04.707086 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.shibaribrasil.3.az
[0m16:57:04.711085 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '93a53c2e-3215-43c2-bfa7-0b6f6b5235da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212F23A27C0>]}
[0m16:57:04.721087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '93a53c2e-3215-43c2-bfa7-0b6f6b5235da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212F2005670>]}
[0m16:57:04.721087 [info ] [MainThread]: Found 3 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:57:04.722083 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '93a53c2e-3215-43c2-bfa7-0b6f6b5235da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212F1ED75E0>]}
[0m16:57:04.724089 [info ] [MainThread]: 
[0m16:57:04.725083 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:57:04.727415 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:57:04.727415 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:57:05.406807 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:57:05.407805 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:57:05.439831 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:57:05.439831 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:57:06.097539 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '93a53c2e-3215-43c2-bfa7-0b6f6b5235da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212F1D944C0>]}
[0m16:57:06.101549 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:57:06.104294 [info ] [MainThread]: 
[0m16:57:06.126281 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m16:57:06.130103 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m16:57:06.135173 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m16:57:06.137154 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m16:57:06.167040 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m16:57:06.170873 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 16:57:06.139357 => 16:57:06.169714
[0m16:57:06.170873 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m16:57:06.212030 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m16:57:06.212030 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:57:06.214044 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS()
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m16:57:07.221276 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cad0762c-4969-4a29-bff5-b8bc9d3952af&page=queryresults
[0m16:57:07.751070 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 16:57:06.170873 => 16:57:07.750072
[0m16:57:07.753134 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '93a53c2e-3215-43c2-bfa7-0b6f6b5235da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212F33F9E20>]}
[0m16:57:07.755131 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.62s]
[0m16:57:07.758652 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m16:57:07.764779 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:57:07.765772 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:57:07.765772 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:57:07.766760 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:57:07.766760 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_categoria_produto' was properly closed.
[0m16:57:07.767772 [info ] [MainThread]: 
[0m16:57:07.769778 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.04 seconds (3.04s).
[0m16:57:07.774092 [debug] [MainThread]: Command end result
[0m16:57:07.803581 [info ] [MainThread]: 
[0m16:57:07.805578 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:57:07.806583 [info ] [MainThread]: 
[0m16:57:07.807589 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:57:07.808580 [debug] [MainThread]: Command `dbt run` succeeded at 16:57:07.808580 after 3.99 seconds
[0m16:57:07.809581 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212EE7A1460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212F1DD96D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212F20B39D0>]}
[0m16:57:07.810581 [debug] [MainThread]: Flushing usage events
[0m17:00:03.299660 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E75BA3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E74B186D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E74B18E20>]}


============================== 17:00:03.303311 | 188bcfd1-bfd3-44bf-b584-0360f891b922 ==============================
[0m17:00:03.303311 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:00:03.304312 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m17:00:03.835932 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E74B10070>]}
[0m17:00:03.895845 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E792077C0>]}
[0m17:00:03.897357 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:00:03.904078 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:00:03.978517 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m17:00:03.978517 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\3.az\tb_produto.sql
[0m17:00:04.077522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E7957B700>]}
[0m17:00:04.085228 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E79481E20>]}
[0m17:00:04.086298 [info ] [MainThread]: Found 4 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:00:04.086298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E79481BE0>]}
[0m17:00:04.088800 [info ] [MainThread]: 
[0m17:00:04.088800 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:00:04.090843 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:04.090843 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:04.091816 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:04.091816 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:04.813012 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:05.529143 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622, now create_igneous-sandbox-381622_dbt_dw_az)
[0m17:00:05.531134 [debug] [ThreadPool]: Creating schema "database: "igneous-sandbox-381622"
schema: "dbt_dw_az"
"
[0m17:00:05.549388 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:05.552396 [debug] [ThreadPool]: On create_igneous-sandbox-381622_dbt_dw_az: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "connection_name": "create_igneous-sandbox-381622_dbt_dw_az"} */
create schema if not exists `igneous-sandbox-381622`.`dbt_dw_az`
  
[0m17:00:06.372359 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f2082fd1-d115-45a6-8687-3bf806edbb4e&page=queryresults
[0m17:00:07.317017 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:00:07.318062 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:07.320064 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:00:07.321057 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:08.009383 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m17:00:08.010467 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:08.663594 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E792376D0>]}
[0m17:00:08.664621 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:00:08.666618 [info ] [MainThread]: 
[0m17:00:08.676227 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.680036 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m17:00:08.677926 [info ] [Thread-1  ]: 1 of 4 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m17:00:08.682948 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m17:00:08.683944 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.697713 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m17:00:08.681045 [info ] [Thread-2  ]: 2 of 4 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m17:00:08.698818 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m17:00:08.699825 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m17:00:08.704824 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m17:00:08.708291 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 17:00:08.683944 => 17:00:08.707289
[0m17:00:08.709806 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.727305 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 17:00:08.699825 => 17:00:08.727305
[0m17:00:08.728369 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m17:00:08.736308 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m17:00:08.737362 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m17:00:08.739369 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:00:08.739369 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:00:08.740315 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS()
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m17:00:08.760818 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS()
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m17:00:09.830881 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d9a8e403-637f-4203-a208-5affcbd0e21b&page=queryresults
[0m17:00:09.832880 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4eb6af14-90fb-4371-92e6-ddea00da0b12&page=queryresults
[0m17:00:10.362035 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 17:00:08.728369 => 17:00:10.362035
[0m17:00:10.368047 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 17:00:08.709806 => 17:00:10.367051
[0m17:00:10.371046 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E792376D0>]}
[0m17:00:10.372047 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E7A712E20>]}
[0m17:00:10.373076 [info ] [Thread-2  ]: 2 of 4 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.67s]
[0m17:00:10.377766 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m17:00:10.374111 [info ] [Thread-1  ]: 1 of 4 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.69s]
[0m17:00:10.381064 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m17:00:10.383038 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m17:00:10.384055 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m17:00:10.383038 [info ] [Thread-2  ]: 3 of 4 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m17:00:10.386324 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m17:00:10.387424 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m17:00:10.385031 [info ] [Thread-1  ]: 4 of 4 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m17:00:10.391831 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.tb_produto)
[0m17:00:10.398558 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m17:00:10.399556 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m17:00:10.403558 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m17:00:10.405557 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 17:00:10.387424 => 17:00:10.404558
[0m17:00:10.406561 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m17:00:10.417236 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:10.419416 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 17:00:10.399556 => 17:00:10.419416
[0m17:00:10.442433 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m17:00:10.464170 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m17:00:10.467172 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:10.469207 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m17:00:11.061528 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m17:00:11.064517 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m17:00:11.544593 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cd774763-e1a8-4ba6-ab8d-c9e49251f1d1&page=queryresults
[0m17:00:11.774619 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c9f187ce-b150-41f9-80c4-d30b966c5436&page=queryresults
[0m17:00:14.467327 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 17:00:10.443433 => 17:00:14.466599
[0m17:00:14.469447 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E7A6BA8E0>]}
[0m17:00:14.470436 [info ] [Thread-1  ]: 4 of 4 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.08s]
[0m17:00:14.472353 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m17:00:14.483358 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 17:00:10.406561 => 17:00:14.482399
[0m17:00:14.485419 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '188bcfd1-bfd3-44bf-b584-0360f891b922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E7A6F7400>]}
[0m17:00:14.487351 [info ] [Thread-2  ]: 3 of 4 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.10s]
[0m17:00:14.490390 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m17:00:14.493395 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:00:14.493395 [debug] [MainThread]: Connection 'create_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:00:14.494393 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:00:14.494393 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m17:00:14.495423 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:00:14.495423 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m17:00:14.495423 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m17:00:14.496387 [info ] [MainThread]: 
[0m17:00:14.497822 [info ] [MainThread]: Finished running 2 view models, 2 table models in 0 hours 0 minutes and 10.41 seconds (10.41s).
[0m17:00:14.499828 [debug] [MainThread]: Command end result
[0m17:00:14.517594 [info ] [MainThread]: 
[0m17:00:14.519596 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:00:14.520599 [info ] [MainThread]: 
[0m17:00:14.521717 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m17:00:14.522704 [debug] [MainThread]: Command `dbt run` succeeded at 17:00:14.521717 after 11.28 seconds
[0m17:00:14.522704 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E75BA3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E791A3B80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029E794B96D0>]}
[0m17:00:14.522704 [debug] [MainThread]: Flushing usage events
[0m17:00:21.769916 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000161552F4400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016154275640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016154275AC0>]}


============================== 17:00:21.773911 | 1f490cda-dc2d-489e-8ae2-86a1d2bcb8da ==============================
[0m17:00:21.773911 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:00:21.773911 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_produto', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:00:22.199463 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1f490cda-dc2d-489e-8ae2-86a1d2bcb8da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016154275850>]}
[0m17:00:22.260588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1f490cda-dc2d-489e-8ae2-86a1d2bcb8da', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000161589684C0>]}
[0m17:00:22.261577 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:00:22.268212 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:00:22.367129 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:00:22.367727 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_produto.sql
[0m17:00:22.453452 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.shibaribrasil.tb_produto' (models\3.az\tb_produto.sql) depends on a node named 'dw_produto' which was not found
[0m17:00:22.454398 [debug] [MainThread]: Command `dbt run` failed at 17:00:22.454398 after 0.74 seconds
[0m17:00:22.454398 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000161552F4400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016158919130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016158C02D90>]}
[0m17:00:22.455462 [debug] [MainThread]: Flushing usage events
[0m17:00:41.434741 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CAA6D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5C99F36A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5C99F3DC0>]}


============================== 17:00:41.439071 | 4036ce2e-e5df-440b-9b0e-7c6a8bc5542d ==============================
[0m17:00:41.439071 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:00:41.439071 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_produto', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:00:41.883912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4036ce2e-e5df-440b-9b0e-7c6a8bc5542d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CCBBBA60>]}
[0m17:00:41.946324 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4036ce2e-e5df-440b-9b0e-7c6a8bc5542d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CD3BF400>]}
[0m17:00:41.946799 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:00:41.952847 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:00:42.000826 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:00:42.001827 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_produto.sql
[0m17:00:42.096780 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4036ce2e-e5df-440b-9b0e-7c6a8bc5542d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CE4EE5B0>]}
[0m17:00:42.104318 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4036ce2e-e5df-440b-9b0e-7c6a8bc5542d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CE2AD970>]}
[0m17:00:42.105308 [info ] [MainThread]: Found 4 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:00:42.106284 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4036ce2e-e5df-440b-9b0e-7c6a8bc5542d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CE2AD880>]}
[0m17:00:42.106648 [info ] [MainThread]: 
[0m17:00:42.107703 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:00:42.108695 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:42.109706 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:42.805587 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m17:00:42.805587 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:42.827594 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:00:42.828589 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:43.623812 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m17:00:43.628128 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:44.240196 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4036ce2e-e5df-440b-9b0e-7c6a8bc5542d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5C99F3700>]}
[0m17:00:44.242192 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:00:44.243190 [info ] [MainThread]: 
[0m17:00:44.251192 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m17:00:44.252206 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m17:00:44.253191 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_produto'
[0m17:00:44.254191 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m17:00:44.266216 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m17:00:44.270214 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 17:00:44.255190 => 17:00:44.269214
[0m17:00:44.271221 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m17:00:44.290737 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:00:44.943166 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m17:00:44.944169 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m17:00:45.669183 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e013de55-8eb9-4826-abf2-942fc09b97c3&page=queryresults
[0m17:00:47.947790 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 17:00:44.272211 => 17:00:47.947790
[0m17:00:47.948875 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4036ce2e-e5df-440b-9b0e-7c6a8bc5542d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CE559E80>]}
[0m17:00:47.949868 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 82.6 KiB processed)[0m in 3.70s]
[0m17:00:47.951858 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m17:00:47.953868 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:00:47.953868 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:00:47.954860 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m17:00:47.954860 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m17:00:47.954860 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m17:00:47.954860 [info ] [MainThread]: 
[0m17:00:47.955859 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.85 seconds (5.85s).
[0m17:00:47.956864 [debug] [MainThread]: Command end result
[0m17:00:47.963418 [info ] [MainThread]: 
[0m17:00:47.964355 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:00:47.964355 [info ] [MainThread]: 
[0m17:00:47.966811 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:00:47.968903 [debug] [MainThread]: Command `dbt run` succeeded at 17:00:47.968903 after 6.59 seconds
[0m17:00:47.968903 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CAA6D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CE0B7E80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C5CE38E610>]}
[0m17:00:47.969912 [debug] [MainThread]: Flushing usage events
[0m17:01:28.273120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BB0833D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BA0079D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BA007B80>]}


============================== 17:01:28.277142 | 3698c33f-7d60-42cf-86e3-245f083ab78d ==============================
[0m17:01:28.277142 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:01:28.277838 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m17:01:29.311969 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BA004280>]}
[0m17:01:29.378746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BE701A90>]}
[0m17:01:29.380742 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:01:29.388168 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:01:29.546604 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:01:29.547885 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:01:29.557088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BE9940D0>]}
[0m17:01:29.570817 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BE97BC40>]}
[0m17:01:29.570817 [info ] [MainThread]: Found 4 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:01:29.573316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BE97B3A0>]}
[0m17:01:29.576360 [info ] [MainThread]: 
[0m17:01:29.577896 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:01:29.580969 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:01:29.581921 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:29.582913 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:01:29.583975 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:30.421090 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:01:31.141092 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:01:31.143090 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:31.144087 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:01:31.146088 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:31.853638 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m17:01:31.853638 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:01:32.569679 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BE764070>]}
[0m17:01:32.570679 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:01:32.570679 [info ] [MainThread]: 
[0m17:01:32.575627 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m17:01:32.576683 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m17:01:32.577159 [info ] [Thread-1  ]: 1 of 4 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m17:01:32.578219 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m17:01:32.579270 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m17:01:32.585246 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m17:01:32.577159 [info ] [Thread-2  ]: 2 of 4 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m17:01:32.586151 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m17:01:32.586151 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m17:01:32.589747 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m17:01:32.590709 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 17:01:32.587184 => 17:01:32.589747
[0m17:01:32.590709 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m17:01:32.607762 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 17:01:32.579270 => 17:01:32.607279
[0m17:01:32.612808 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m17:01:32.613816 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m17:01:32.618266 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m17:01:32.619316 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:01:32.620288 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:01:32.621321 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS()
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m17:01:32.644489 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS()
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m17:01:33.416647 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9f089a11-46e3-4490-8605-8d0ae2f05ddb&page=queryresults
[0m17:01:33.431330 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4f0c5612-6cd3-4e91-aef4-e359965a07ad&page=queryresults
[0m17:01:33.805254 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000125726C2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001257164F6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001257164FE20>]}


============================== 17:01:33.809828 | 9dda4c23-2282-4f53-bbc6-9dbb19c7f915 ==============================
[0m17:01:33.809828 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:01:33.810822 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:01:33.912985 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 17:01:32.590709 => 17:01:33.912985
[0m17:01:33.915987 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 17:01:32.613816 => 17:01:33.915987
[0m17:01:33.916935 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BFA26430>]}
[0m17:01:33.917440 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BEA483A0>]}
[0m17:01:33.918520 [info ] [Thread-2  ]: 2 of 4 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m17:01:33.919489 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m17:01:33.918520 [info ] [Thread-1  ]: 1 of 4 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m17:01:33.920489 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m17:01:33.920489 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m17:01:33.921487 [info ] [Thread-2  ]: 3 of 4 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m17:01:33.921487 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m17:01:33.922491 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m17:01:33.925491 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m17:01:33.926480 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 17:01:33.922491 => 17:01:33.925491
[0m17:01:33.926791 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m17:01:33.933848 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:01:34.380050 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001257480DA90>]}
[0m17:01:34.441709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012575D33550>]}
[0m17:01:34.442710 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:01:34.449345 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:01:34.492950 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:01:34.492950 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:01:34.497363 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012575FC2CD0>]}
[0m17:01:34.505380 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012575EF6A00>]}
[0m17:01:34.505380 [info ] [MainThread]: Found 4 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:01:34.506412 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012575EF6880>]}
[0m17:01:34.507655 [info ] [MainThread]: 
[0m17:01:34.508655 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:01:34.510628 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:01:34.510628 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:34.511687 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:01:34.511687 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:34.672912 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m17:01:34.675910 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m17:01:35.289631 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:34e733e9-0ec7-4f01-8d36-887cc1cd3de2&page=queryresults
[0m17:01:35.439189 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:01:36.128005 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m17:01:36.130021 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:36.131961 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:01:36.132957 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:36.773785 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m17:01:36.773785 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:01:37.486961 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012575FC2DF0>]}
[0m17:01:37.489044 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:01:37.489993 [info ] [MainThread]: 
[0m17:01:37.495997 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m17:01:37.497693 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m17:01:37.497049 [info ] [Thread-1  ]: 1 of 4 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m17:01:37.500759 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m17:01:37.501749 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m17:01:37.499764 [info ] [Thread-2  ]: 2 of 4 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m17:01:37.518778 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m17:01:37.519785 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m17:01:37.520786 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m17:01:37.526797 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m17:01:37.528132 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 17:01:37.502712 => 17:01:37.527135
[0m17:01:37.528132 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m17:01:37.551326 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m17:01:37.552303 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 17:01:37.521731 => 17:01:37.551326
[0m17:01:37.552303 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m17:01:37.556754 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m17:01:37.557794 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:01:37.557794 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:01:37.559787 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS()
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m17:01:37.580947 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS()
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m17:01:37.885769 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 17:01:33.926791 => 17:01:37.885769
[0m17:01:37.886811 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BEA35A30>]}
[0m17:01:37.888512 [info ] [Thread-2  ]: 3 of 4 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 3.97s]
[0m17:01:37.889624 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m17:01:37.890525 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m17:01:37.891531 [info ] [Thread-1  ]: 4 of 4 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m17:01:37.893534 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.tb_produto)
[0m17:01:37.893534 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m17:01:37.898013 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m17:01:37.899018 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 17:01:37.893534 => 17:01:37.898013
[0m17:01:37.899018 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m17:01:37.901011 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:01:38.296185 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e1d34587-d914-4a4d-8960-0138fe38b8b4&page=queryresults
[0m17:01:38.401011 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d092e40e-1b4b-4479-8578-1d900dc24535&page=queryresults
[0m17:01:38.501280 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m17:01:38.504275 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m17:01:38.726083 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 17:01:37.552303 => 17:01:38.726083
[0m17:01:38.727084 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012576068820>]}
[0m17:01:38.727521 [info ] [Thread-2  ]: 2 of 4 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m17:01:38.728514 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m17:01:38.728514 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m17:01:38.729519 [info ] [Thread-2  ]: 3 of 4 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m17:01:38.729519 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m17:01:38.729519 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m17:01:38.733638 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m17:01:38.734639 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 17:01:38.730528 => 17:01:38.733638
[0m17:01:38.734639 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m17:01:38.747708 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:01:38.772054 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 17:01:37.529189 => 17:01:38.772054
[0m17:01:38.773054 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000125760489A0>]}
[0m17:01:38.773054 [info ] [Thread-1  ]: 1 of 4 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m17:01:38.774060 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m17:01:39.192400 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:23acc0a2-3ad9-40f0-8545-28470c042f0b&page=queryresults
[0m17:01:39.562101 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m17:01:39.564052 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m17:01:40.179050 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3988d73b-d1c7-4763-bca7-f676746f885a&page=queryresults
[0m17:01:41.224421 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 17:01:37.899018 => 17:01:41.223418
[0m17:01:41.226372 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3698c33f-7d60-42cf-86e3-245f083ab78d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BFAC41C0>]}
[0m17:01:41.227753 [info ] [Thread-1  ]: 4 of 4 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 82.6 KiB processed)[0m in 3.33s]
[0m17:01:41.229752 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m17:01:41.233767 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:01:41.233767 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:01:41.234884 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:01:41.235882 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:01:41.235882 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m17:01:41.236882 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m17:01:41.237662 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m17:01:41.237662 [info ] [MainThread]: 
[0m17:01:41.238813 [info ] [MainThread]: Finished running 2 view models, 2 table models in 0 hours 0 minutes and 11.66 seconds (11.66s).
[0m17:01:41.241810 [debug] [MainThread]: Command end result
[0m17:01:41.267968 [info ] [MainThread]: 
[0m17:01:41.269056 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:01:41.270043 [info ] [MainThread]: 
[0m17:01:41.270043 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m17:01:41.271115 [debug] [MainThread]: Command `dbt run` succeeded at 17:01:41.271115 after 13.06 seconds
[0m17:01:41.271115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BB0833D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BE699A60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000147BE5DE760>]}
[0m17:01:41.271115 [debug] [MainThread]: Flushing usage events
[0m17:01:42.812521 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 17:01:38.735598 => 17:01:42.811564
[0m17:01:42.813579 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001257705F490>]}
[0m17:01:42.815465 [info ] [Thread-2  ]: 3 of 4 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.08s]
[0m17:01:42.817183 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m17:01:42.818540 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m17:01:42.820546 [info ] [Thread-1  ]: 4 of 4 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m17:01:42.822545 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.tb_produto)
[0m17:01:42.823545 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m17:01:42.831167 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m17:01:42.833170 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 17:01:42.824547 => 17:01:42.833170
[0m17:01:42.834178 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m17:01:42.837654 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:01:43.489653 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m17:01:43.492237 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS()
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m17:01:44.140803 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b0c7b3a4-158b-452c-94cf-7748d6971305&page=queryresults
[0m17:01:46.116961 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 17:01:42.834178 => 17:01:46.116961
[0m17:01:46.118407 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9dda4c23-2282-4f53-bbc6-9dbb19c7f915', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012577117C70>]}
[0m17:01:46.118407 [info ] [Thread-1  ]: 4 of 4 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 82.6 KiB processed)[0m in 3.30s]
[0m17:01:46.119442 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m17:01:46.121441 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:01:46.121441 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:01:46.121441 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:01:46.121441 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m17:01:46.121441 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m17:01:46.122634 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m17:01:46.122634 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m17:01:46.122634 [info ] [MainThread]: 
[0m17:01:46.123672 [info ] [MainThread]: Finished running 2 view models, 2 table models in 0 hours 0 minutes and 11.61 seconds (11.61s).
[0m17:01:46.123672 [debug] [MainThread]: Command end result
[0m17:01:46.131842 [info ] [MainThread]: 
[0m17:01:46.131842 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:01:46.132835 [info ] [MainThread]: 
[0m17:01:46.132835 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m17:01:46.133834 [debug] [MainThread]: Command `dbt run` succeeded at 17:01:46.133834 after 12.38 seconds
[0m17:01:46.133834 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000125726C2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012575DFBB20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000012575C84820>]}
[0m17:01:46.134833 [debug] [MainThread]: Flushing usage events
[0m17:12:35.095199 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296D59623D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296D82D1BE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296D48FBD30>]}


============================== 17:12:35.095199 | 524b1577-3b9d-40b1-8ded-6b1eea483a41 ==============================
[0m17:12:35.095199 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:12:35.095199 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt debug', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:12:35.095199 [info ] [MainThread]: dbt version: 1.7.4
[0m17:12:35.095199 [info ] [MainThread]: python version: 3.8.10
[0m17:12:35.095199 [info ] [MainThread]: python path: c:\users\htk1511\appdata\local\programs\python\python38\python.exe
[0m17:12:35.109405 [info ] [MainThread]: os info: Windows-10-10.0.26100-SP0
[0m17:12:35.479163 [info ] [MainThread]: Using profiles dir at C:\Git\sb_loja_virtual
[0m17:12:35.479163 [info ] [MainThread]: Using profiles.yml file at C:\Git\sb_loja_virtual\profiles.yml
[0m17:12:35.479163 [info ] [MainThread]: Using dbt_project.yml file at C:\Git\sb_loja_virtual\dbt_project.yml
[0m17:12:35.479163 [info ] [MainThread]: adapter type: bigquery
[0m17:12:35.479163 [info ] [MainThread]: adapter version: 1.7.2
[0m17:12:35.575963 [info ] [MainThread]: Configuration:
[0m17:12:35.575963 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m17:12:35.575963 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m17:12:35.575963 [info ] [MainThread]: Required dependencies:
[0m17:12:35.575963 [debug] [MainThread]: Executing "git --help"
[0m17:12:35.615736 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--config-env=<name>=<envvar>] <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m17:12:35.616747 [debug] [MainThread]: STDERR: "b''"
[0m17:12:35.616747 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m17:12:35.617749 [info ] [MainThread]: Connection:
[0m17:12:35.618753 [info ] [MainThread]:   method: service-account
[0m17:12:35.618753 [info ] [MainThread]:   database: igneous-sandbox-381622
[0m17:12:35.618753 [info ] [MainThread]:   execution_project: igneous-sandbox-381622
[0m17:12:35.619747 [info ] [MainThread]:   schema: dbt_dw
[0m17:12:35.619747 [info ] [MainThread]:   location: us-east4
[0m17:12:35.619747 [info ] [MainThread]:   priority: None
[0m17:12:35.619747 [info ] [MainThread]:   maximum_bytes_billed: None
[0m17:12:35.619747 [info ] [MainThread]:   impersonate_service_account: None
[0m17:12:35.619747 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m17:12:35.619747 [info ] [MainThread]:   job_retries: 1
[0m17:12:35.619747 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m17:12:35.619747 [info ] [MainThread]:   job_execution_timeout_seconds: None
[0m17:12:35.619747 [info ] [MainThread]:   keyfile: C:\Git\key_project_sb.json
[0m17:12:35.619747 [info ] [MainThread]:   timeout_seconds: None
[0m17:12:35.625785 [info ] [MainThread]:   refresh_token: None
[0m17:12:35.625785 [info ] [MainThread]:   client_id: None
[0m17:12:35.626799 [info ] [MainThread]:   token_uri: None
[0m17:12:35.627797 [info ] [MainThread]:   dataproc_region: None
[0m17:12:35.627797 [info ] [MainThread]:   dataproc_cluster_name: None
[0m17:12:35.628797 [info ] [MainThread]:   gcs_bucket: None
[0m17:12:35.628797 [info ] [MainThread]:   dataproc_batch: None
[0m17:12:35.629795 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:12:35.629795 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m17:12:35.629795 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:12:35.631816 [debug] [MainThread]: On debug: select 1 as id
[0m17:12:36.496491 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:13dd5e7a-722f-4ed2-8bae-a2e84d0d6789&page=queryresults
[0m17:12:36.998680 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m17:12:36.998680 [info ] [MainThread]: [32mAll checks passed![0m
[0m17:12:36.998680 [debug] [MainThread]: Command `dbt debug` succeeded at 17:12:36.998680 after 1.96 seconds
[0m17:12:36.998680 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m17:12:36.998680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296D59623D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296D8EF0A60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296D8F81F10>]}
[0m17:12:36.998680 [debug] [MainThread]: Flushing usage events
[0m18:00:05.007392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019108A49430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191079CC640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191079CCAC0>]}


============================== 18:00:05.018302 | ad301add-a93a-4793-8992-f3d1e39e677b ==============================
[0m18:00:05.018302 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:00:05.018302 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m18:00:05.401666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000191079CC850>]}
[0m18:00:05.460741 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C0C0B20>]}
[0m18:00:05.467926 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:00:05.467926 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:00:05.467926 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
[0m18:00:05.467926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C02F160>]}
[0m18:00:06.166971 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C4878B0>]}
[0m18:00:06.215473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C4F39D0>]}
[0m18:00:06.215473 [info ] [MainThread]: Found 4 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:00:06.215473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C4F3700>]}
[0m18:00:06.215473 [info ] [MainThread]: 
[0m18:00:06.215473 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:00:06.215473 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:00:06.215473 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:00:06.215473 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:06.215473 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:07.088093 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:00:07.823016 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m18:00:07.834854 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m18:00:07.834854 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:07.834854 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:08.521720 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m18:00:08.521720 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:00:09.211841 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C4DF580>]}
[0m18:00:09.211841 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:00:09.211841 [info ] [MainThread]: 
[0m18:00:09.211841 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m18:00:09.227585 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m18:00:09.227585 [info ] [Thread-1  ]: 1 of 4 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m18:00:09.227585 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m18:00:09.227585 [info ] [Thread-2  ]: 2 of 4 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m18:00:09.227585 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m18:00:09.227585 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m18:00:09.243417 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m18:00:09.243417 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m18:00:09.259508 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m18:00:09.259508 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 18:00:09.227585 => 18:00:09.259508
[0m18:00:09.259508 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m18:00:09.270113 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 18:00:09.243417 => 18:00:09.270113
[0m18:00:09.270113 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m18:00:09.355618 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m18:00:09.370086 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m18:00:09.371596 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m18:00:09.371596 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:00:09.371596 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m18:00:09.371596 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m18:00:10.286768 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e72ae9cc-3b7b-4a6a-a478-1aa20d9e36ef&page=queryresults
[0m18:00:10.286768 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6d8c3af9-06ee-4813-aaec-2619d001877c&page=queryresults
[0m18:00:10.818233 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 18:00:09.259508 => 18:00:10.818233
[0m18:00:10.818233 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C281940>]}
[0m18:00:10.818233 [info ] [Thread-1  ]: 1 of 4 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.59s]
[0m18:00:10.818233 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m18:00:10.850294 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 18:00:09.291599 => 18:00:10.850294
[0m18:00:10.850294 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C2E8280>]}
[0m18:00:10.850294 [info ] [Thread-2  ]: 2 of 4 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.62s]
[0m18:00:10.850294 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m18:00:10.850294 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m18:00:10.850294 [info ] [Thread-1  ]: 3 of 4 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m18:00:10.850294 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.dm_produto)
[0m18:00:10.850294 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m18:00:10.866189 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m18:00:10.866189 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 18:00:10.850294 => 18:00:10.866189
[0m18:00:10.866189 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m18:00:10.897941 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:11.618256 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m18:00:11.618256 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m18:00:12.422795 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cd44dca5-dd31-44cc-af16-ae5212577f46&page=queryresults
[0m18:00:16.733204 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 18:00:10.879808 => 18:00:16.733204
[0m18:00:16.733204 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C504250>]}
[0m18:00:16.733204 [info ] [Thread-1  ]: 3 of 4 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 5.88s]
[0m18:00:16.749406 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m18:00:16.749406 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m18:00:16.749406 [info ] [Thread-2  ]: 4 of 4 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m18:00:16.749406 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m18:00:16.749406 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m18:00:16.749406 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m18:00:16.749406 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 18:00:16.749406 => 18:00:16.749406
[0m18:00:16.749406 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m18:00:16.765587 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:17.455152 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m18:00:17.455152 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m18:00:18.172430 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9da07ae2-dc15-4119-bd4d-5ff7ec608cb8&page=queryresults
[0m18:00:20.273408 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 18:00:16.749406 => 18:00:20.273408
[0m18:00:20.275426 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ad301add-a93a-4793-8992-f3d1e39e677b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C5D1DF0>]}
[0m18:00:20.277442 [info ] [Thread-2  ]: 4 of 4 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 82.6 KiB processed)[0m in 3.53s]
[0m18:00:20.277442 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m18:00:20.283180 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:00:20.283180 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:00:20.283180 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:00:20.283180 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:00:20.283180 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m18:00:20.283180 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m18:00:20.283180 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m18:00:20.283180 [info ] [MainThread]: 
[0m18:00:20.283180 [info ] [MainThread]: Finished running 2 view models, 2 table models in 0 hours 0 minutes and 14.07 seconds (14.07s).
[0m18:00:20.283180 [debug] [MainThread]: Command end result
[0m18:00:20.315079 [info ] [MainThread]: 
[0m18:00:20.317102 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:00:20.319117 [info ] [MainThread]: 
[0m18:00:20.319117 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m18:00:20.319117 [debug] [MainThread]: Command `dbt run` succeeded at 18:00:20.319117 after 15.37 seconds
[0m18:00:20.319117 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019108A49430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C13A610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001910C555CA0>]}
[0m18:00:20.319117 [debug] [MainThread]: Flushing usage events
[0m19:00:03.720974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEC153430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEB0D3640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEB0D3AC0>]}


============================== 19:00:03.720974 | 772eca72-2777-4b49-8085-97dea2277281 ==============================
[0m19:00:03.720974 [info ] [MainThread]: Running with dbt=1.7.4
[0m19:00:03.720974 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m19:00:04.070018 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEB0BB910>]}
[0m19:00:04.137313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEF885C40>]}
[0m19:00:04.139319 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m19:00:04.143611 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m19:00:04.213974 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m19:00:04.213974 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m19:00:04.213974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEFA52340>]}
[0m19:00:04.229094 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEB0D36D0>]}
[0m19:00:04.229094 [info ] [MainThread]: Found 4 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m19:00:04.229094 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEF74C190>]}
[0m19:00:04.229094 [info ] [MainThread]: 
[0m19:00:04.229094 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m19:00:04.229094 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:00:04.229094 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m19:00:04.229094 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:04.229094 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:05.084288 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:00:05.769765 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m19:00:05.769765 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m19:00:05.769765 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:05.769765 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m19:00:06.442477 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m19:00:06.442477 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m19:00:07.116072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEFA848B0>]}
[0m19:00:07.116072 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m19:00:07.116072 [info ] [MainThread]: 
[0m19:00:07.131532 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m19:00:07.131532 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m19:00:07.131532 [info ] [Thread-1  ]: 1 of 4 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m19:00:07.131532 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m19:00:07.131532 [info ] [Thread-2  ]: 2 of 4 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m19:00:07.131532 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m19:00:07.131532 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m19:00:07.147382 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m19:00:07.147382 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m19:00:07.147382 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m19:00:07.147382 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 19:00:07.131532 => 19:00:07.147382
[0m19:00:07.147382 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 19:00:07.147382 => 19:00:07.147382
[0m19:00:07.147382 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m19:00:07.147382 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m19:00:07.194994 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m19:00:07.194994 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m19:00:07.194994 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m19:00:07.202623 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m19:00:07.202623 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m19:00:07.210680 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m19:00:08.594532 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8e4e82d2-66e6-4e55-a8b3-7c7e55192118&page=queryresults
[0m19:00:08.594532 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:71fe4268-1462-446d-8a52-a19ff3a6bbbe&page=queryresults
[0m19:00:09.124575 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 19:00:07.178819 => 19:00:09.124575
[0m19:00:09.139871 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 19:00:07.163102 => 19:00:09.139871
[0m19:00:09.139871 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEFAD4FD0>]}
[0m19:00:09.139871 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDF0B3AB80>]}
[0m19:00:09.139871 [info ] [Thread-2  ]: 2 of 4 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 2.01s]
[0m19:00:09.139871 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m19:00:09.139871 [info ] [Thread-1  ]: 1 of 4 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 2.01s]
[0m19:00:09.139871 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m19:00:09.139871 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m19:00:09.139871 [info ] [Thread-2  ]: 3 of 4 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m19:00:09.139871 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m19:00:09.139871 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m19:00:09.155868 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m19:00:09.155868 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 19:00:09.139871 => 19:00:09.155868
[0m19:00:09.155868 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m19:00:09.155868 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m19:00:09.957786 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m19:00:09.957786 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m19:00:10.648682 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2c0197bf-c6ba-4404-a3b5-52508f557c33&page=queryresults
[0m19:00:12.956435 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 19:00:09.155868 => 19:00:12.956435
[0m19:00:12.956435 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEFA5FCA0>]}
[0m19:00:12.956435 [info ] [Thread-2  ]: 3 of 4 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 3.82s]
[0m19:00:12.956435 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m19:00:12.956435 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m19:00:12.956435 [info ] [Thread-1  ]: 4 of 4 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m19:00:12.956435 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.tb_produto)
[0m19:00:12.956435 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m19:00:12.972609 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m19:00:12.972609 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 19:00:12.956435 => 19:00:12.972609
[0m19:00:12.972609 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m19:00:12.972609 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m19:00:13.598442 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m19:00:13.598442 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m19:00:14.226514 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:11117059-86d2-48cc-8005-8e8fa408f0f3&page=queryresults
[0m19:00:16.525816 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 19:00:12.972609 => 19:00:16.525816
[0m19:00:16.537354 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '772eca72-2777-4b49-8085-97dea2277281', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEFAE7CD0>]}
[0m19:00:16.537354 [info ] [Thread-1  ]: 4 of 4 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 82.6 KiB processed)[0m in 3.58s]
[0m19:00:16.537354 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m19:00:16.537354 [debug] [MainThread]: Connection 'master' was properly closed.
[0m19:00:16.537354 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:00:16.537354 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m19:00:16.537354 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m19:00:16.537354 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m19:00:16.537354 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m19:00:16.537354 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m19:00:16.537354 [info ] [MainThread]: 
[0m19:00:16.537354 [info ] [MainThread]: Finished running 2 view models, 2 table models in 0 hours 0 minutes and 12.31 seconds (12.31s).
[0m19:00:16.537354 [debug] [MainThread]: Command end result
[0m19:00:16.578953 [info ] [MainThread]: 
[0m19:00:16.578953 [info ] [MainThread]: [32mCompleted successfully[0m
[0m19:00:16.578953 [info ] [MainThread]: 
[0m19:00:16.578953 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m19:00:16.578953 [debug] [MainThread]: Command `dbt run` succeeded at 19:00:16.578953 after 12.92 seconds
[0m19:00:16.578953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEC153430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEF74C2B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FDEF78B550>]}
[0m19:00:16.585228 [debug] [MainThread]: Flushing usage events
[0m20:00:04.523314 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF02E9400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CEF26C8E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CEF26C5E0>]}


============================== 20:00:04.523314 | 168c0ccb-312f-48c2-9290-93f9e352014c ==============================
[0m20:00:04.523314 [info ] [MainThread]: Running with dbt=1.7.4
[0m20:00:04.523314 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m20:00:05.034027 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF2435AF0>]}
[0m20:00:05.097599 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CEF273EE0>]}
[0m20:00:05.097599 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m20:00:05.113327 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m20:00:05.145302 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:00:05.161245 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:00:05.161245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF3BF1EE0>]}
[0m20:00:05.161245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF3B2E160>]}
[0m20:00:05.161245 [info ] [MainThread]: Found 4 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m20:00:05.161245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF39B3880>]}
[0m20:00:05.175490 [info ] [MainThread]: 
[0m20:00:05.177242 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:00:05.177242 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:00:05.177242 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:05.177242 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m20:00:05.177242 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:06.061063 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:00:06.748736 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m20:00:06.748736 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m20:00:06.748736 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:06.748736 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:00:07.438076 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m20:00:07.438076 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:00:08.143410 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF38B2550>]}
[0m20:00:08.143410 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m20:00:08.143410 [info ] [MainThread]: 
[0m20:00:08.159427 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m20:00:08.159427 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m20:00:08.159427 [info ] [Thread-1  ]: 1 of 4 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m20:00:08.159427 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m20:00:08.166746 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m20:00:08.159427 [info ] [Thread-2  ]: 2 of 4 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m20:00:08.175133 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m20:00:08.175133 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m20:00:08.175133 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m20:00:08.188643 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m20:00:08.191051 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 20:00:08.166746 => 20:00:08.188643
[0m20:00:08.191051 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 20:00:08.175133 => 20:00:08.191051
[0m20:00:08.191051 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m20:00:08.191051 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m20:00:08.224997 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m20:00:08.224997 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m20:00:08.224997 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m20:00:08.239177 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m20:00:08.270954 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m20:00:08.270954 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m20:00:09.170336 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2c2d279c-6ff5-4b35-a464-bc89f4126b23&page=queryresults
[0m20:00:09.202339 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7e81f02c-6673-4b10-9da5-456116ec30aa&page=queryresults
[0m20:00:09.703946 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 20:00:08.222987 => 20:00:09.703946
[0m20:00:09.703946 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 20:00:08.191051 => 20:00:09.703946
[0m20:00:09.703946 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF3BFFB50>]}
[0m20:00:09.703946 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF3C979A0>]}
[0m20:00:09.703946 [info ] [Thread-2  ]: 2 of 4 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.53s]
[0m20:00:09.703946 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m20:00:09.703946 [info ] [Thread-1  ]: 1 of 4 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m20:00:09.703946 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m20:00:09.703946 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m20:00:09.703946 [info ] [Thread-2  ]: 3 of 4 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m20:00:09.703946 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m20:00:09.703946 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m20:00:09.703946 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m20:00:09.703946 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 20:00:09.703946 => 20:00:09.703946
[0m20:00:09.703946 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m20:00:09.719667 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m20:00:10.347597 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m20:00:10.347597 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m20:00:11.024570 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e287232c-d405-4cd0-97fb-1ec96c0a8cce&page=queryresults
[0m20:00:13.943898 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 20:00:09.703946 => 20:00:13.943898
[0m20:00:13.943898 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF3C8FE80>]}
[0m20:00:13.943898 [info ] [Thread-2  ]: 3 of 4 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.24s]
[0m20:00:13.943898 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m20:00:13.943898 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m20:00:13.943898 [info ] [Thread-1  ]: 4 of 4 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m20:00:13.943898 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.tb_produto)
[0m20:00:13.943898 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m20:00:13.943898 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m20:00:13.960027 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 20:00:13.943898 => 20:00:13.960027
[0m20:00:13.961291 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m20:00:13.963305 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:00:14.647460 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m20:00:14.649477 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m20:00:15.292656 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:90f1957a-392a-4e23-aee9-0f4fab45be70&page=queryresults
[0m20:00:17.611708 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 20:00:13.961291 => 20:00:17.609693
[0m20:00:17.611708 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '168c0ccb-312f-48c2-9290-93f9e352014c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF3C8FEE0>]}
[0m20:00:17.613467 [info ] [Thread-1  ]: 4 of 4 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 82.6 KiB processed)[0m in 3.67s]
[0m20:00:17.613467 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m20:00:17.616882 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:00:17.619346 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:00:17.619346 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m20:00:17.619346 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m20:00:17.619346 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m20:00:17.619346 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m20:00:17.621356 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m20:00:17.621356 [info ] [MainThread]: 
[0m20:00:17.621356 [info ] [MainThread]: Finished running 2 view models, 2 table models in 0 hours 0 minutes and 12.44 seconds (12.44s).
[0m20:00:17.623368 [debug] [MainThread]: Command end result
[0m20:00:17.645299 [info ] [MainThread]: 
[0m20:00:17.645299 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:00:17.645299 [info ] [MainThread]: 
[0m20:00:17.645299 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m20:00:17.645299 [debug] [MainThread]: Command `dbt run` succeeded at 20:00:17.645299 after 13.22 seconds
[0m20:00:17.645299 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF02E9400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CF38B8130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021CEF26C2E0>]}
[0m20:00:17.645299 [debug] [MainThread]: Flushing usage events
[0m21:00:04.379222 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A50F3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A406B6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A406BE20>]}


============================== 21:00:04.382985 | 74e96246-ea25-48fa-9287-20f9684f7233 ==============================
[0m21:00:04.382985 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:00:04.382985 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m21:00:04.717087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A4059340>]}
[0m21:00:04.777861 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A8770AC0>]}
[0m21:00:04.777861 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:00:04.787277 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:00:04.825723 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:00:04.825723 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:00:04.825723 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A8A01FA0>]}
[0m21:00:04.841809 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A89ECFD0>]}
[0m21:00:04.841809 [info ] [MainThread]: Found 4 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:00:04.841809 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A882FD00>]}
[0m21:00:04.841809 [info ] [MainThread]: 
[0m21:00:04.841809 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:00:04.841809 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:00:04.841809 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:04.858022 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:00:04.874227 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:05.898162 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:00:06.528758 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m21:00:06.528758 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:06.528758 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:00:06.528758 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:00:07.230830 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m21:00:07.232846 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:00:07.859829 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A86FA7F0>]}
[0m21:00:07.859829 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:00:07.859829 [info ] [MainThread]: 
[0m21:00:07.873635 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m21:00:07.873635 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m21:00:07.873635 [info ] [Thread-1  ]: 1 of 4 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m21:00:07.873635 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m21:00:07.873635 [info ] [Thread-2  ]: 2 of 4 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m21:00:07.873635 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m21:00:07.873635 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m21:00:07.889601 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m21:00:07.889601 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m21:00:07.905399 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m21:00:07.905399 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 21:00:07.873635 => 21:00:07.905399
[0m21:00:07.905399 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m21:00:07.905399 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 21:00:07.889601 => 21:00:07.905399
[0m21:00:07.937322 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m21:00:07.937322 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m21:00:07.953418 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m21:00:07.953418 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:00:07.953418 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m21:00:07.985535 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m21:00:07.985535 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m21:00:08.853866 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5536ea10-36e0-4604-b372-e413f0a3e629&page=queryresults
[0m21:00:08.853866 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9ba7dd82-cc6a-4258-991c-894ae2c9c3c3&page=queryresults
[0m21:00:09.341092 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 21:00:07.937322 => 21:00:09.340101
[0m21:00:09.341092 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A8A03040>]}
[0m21:00:09.344161 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 21:00:07.905399 => 21:00:09.343052
[0m21:00:09.345118 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A8AB7BB0>]}
[0m21:00:09.344161 [info ] [Thread-2  ]: 2 of 4 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m21:00:09.346158 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m21:00:09.345118 [info ] [Thread-1  ]: 1 of 4 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m21:00:09.347102 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m21:00:09.347102 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m21:00:09.348096 [info ] [Thread-2  ]: 3 of 4 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m21:00:09.348503 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m21:00:09.349513 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m21:00:09.353513 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m21:00:09.353513 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 21:00:09.349513 => 21:00:09.353513
[0m21:00:09.353513 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m21:00:09.369576 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m21:00:09.980183 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m21:00:09.996403 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), '') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m21:00:10.756685 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:121b4f37-e57f-4537-92bc-c9789b2a62f7&page=queryresults
[0m21:00:13.118487 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 21:00:09.353513 => 21:00:13.118487
[0m21:00:13.118487 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A8AB7BB0>]}
[0m21:00:13.118487 [info ] [Thread-2  ]: 3 of 4 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 3.77s]
[0m21:00:13.118487 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m21:00:13.134531 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m21:00:13.134531 [info ] [Thread-1  ]: 4 of 4 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m21:00:13.134531 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.tb_produto)
[0m21:00:13.138741 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m21:00:13.144783 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m21:00:13.146795 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 21:00:13.138741 => 21:00:13.146795
[0m21:00:13.146795 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m21:00:13.152417 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:00:13.839391 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m21:00:13.841149 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m21:00:14.551681 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:db0d4334-b525-448b-ad1a-9db871c284d1&page=queryresults
[0m21:00:16.601990 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 21:00:13.146795 => 21:00:16.601990
[0m21:00:16.601990 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '74e96246-ea25-48fa-9287-20f9684f7233', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A8A9FAF0>]}
[0m21:00:16.601990 [info ] [Thread-1  ]: 4 of 4 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 82.6 KiB processed)[0m in 3.47s]
[0m21:00:16.601990 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m21:00:16.610216 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:00:16.612263 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:00:16.612263 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:00:16.612263 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m21:00:16.612263 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m21:00:16.614275 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m21:00:16.614275 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m21:00:16.614275 [info ] [MainThread]: 
[0m21:00:16.614275 [info ] [MainThread]: Finished running 2 view models, 2 table models in 0 hours 0 minutes and 11.77 seconds (11.77s).
[0m21:00:16.617648 [debug] [MainThread]: Command end result
[0m21:00:16.639690 [info ] [MainThread]: 
[0m21:00:16.639690 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:00:16.639690 [info ] [MainThread]: 
[0m21:00:16.649265 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m21:00:16.649265 [debug] [MainThread]: Command `dbt run` succeeded at 21:00:16.649265 after 12.33 seconds
[0m21:00:16.649265 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A50F3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A8678D90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000183A864C040>]}
[0m21:00:16.649265 [debug] [MainThread]: Flushing usage events
[0m21:11:15.195158 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CBE425400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CBD3896A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CBD389DC0>]}


============================== 21:11:15.198628 | 7e3b7990-7cc0-4753-a5fe-10182248f808 ==============================
[0m21:11:15.198628 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:11:15.199627 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models stg_composicao_produto', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:11:15.561764 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7e3b7990-7cc0-4753-a5fe-10182248f808', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC0570B20>]}
[0m21:11:15.622048 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7e3b7990-7cc0-4753-a5fe-10182248f808', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC1A929D0>]}
[0m21:11:15.623040 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:11:15.629577 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:11:15.693439 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m21:11:15.693439 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\1.stg\stg_composicao_produto.sql
[0m21:11:15.789917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7e3b7990-7cc0-4753-a5fe-10182248f808', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC1E69D90>]}
[0m21:11:15.799057 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7e3b7990-7cc0-4753-a5fe-10182248f808', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC1BCFB50>]}
[0m21:11:15.799057 [info ] [MainThread]: Found 5 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:11:15.800165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7e3b7990-7cc0-4753-a5fe-10182248f808', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC1BCF130>]}
[0m21:11:15.801056 [info ] [MainThread]: 
[0m21:11:15.801925 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:11:15.803034 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:11:15.803932 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:11:16.585594 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:11:16.586596 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m21:11:16.587592 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:11:16.587592 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:11:17.220847 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m21:11:17.221843 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:11:17.849028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7e3b7990-7cc0-4753-a5fe-10182248f808', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC1AF1550>]}
[0m21:11:17.851047 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:11:17.853044 [info ] [MainThread]: 
[0m21:11:17.863881 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m21:11:17.864879 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m21:11:17.866735 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_composicao_produto'
[0m21:11:17.866735 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m21:11:17.875690 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m21:11:17.877222 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 21:11:17.867786 => 21:11:17.877222
[0m21:11:17.877222 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m21:11:17.902278 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m21:11:17.904285 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:11:17.905280 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m21:11:18.795880 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:50d92d06-725b-4951-aabb-4526b4c761e0&page=queryresults
[0m21:11:19.374828 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 21:11:17.878261 => 21:11:19.374828
[0m21:11:19.374828 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7e3b7990-7cc0-4753-a5fe-10182248f808', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC1E69F40>]}
[0m21:11:19.375825 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.51s]
[0m21:11:19.376772 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m21:11:19.378248 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:11:19.378248 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:11:19.378248 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m21:11:19.378248 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:11:19.379304 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_composicao_produto' was properly closed.
[0m21:11:19.379304 [info ] [MainThread]: 
[0m21:11:19.380250 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.58 seconds (3.58s).
[0m21:11:19.380250 [debug] [MainThread]: Command end result
[0m21:11:19.386974 [info ] [MainThread]: 
[0m21:11:19.388019 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:11:19.389016 [info ] [MainThread]: 
[0m21:11:19.389332 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:11:19.391341 [debug] [MainThread]: Command `dbt run` succeeded at 21:11:19.390386 after 4.27 seconds
[0m21:11:19.391341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CBE425400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC19B2640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014CC1D3ED60>]}
[0m21:11:19.391341 [debug] [MainThread]: Flushing usage events
[0m21:19:38.646003 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000250FE575370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000250FFEF4BE0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000250FD4E3D30>]}


============================== 21:19:38.646003 | bd5b2234-2e49-4b83-9856-5c96572dadb6 ==============================
[0m21:19:38.646003 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:19:38.646003 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_composicao_produto', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:19:39.030853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bd5b2234-2e49-4b83-9856-5c96572dadb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000250FD4CC880>]}
[0m21:19:39.090413 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bd5b2234-2e49-4b83-9856-5c96572dadb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025081CCAFD0>]}
[0m21:19:39.090413 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:19:39.100494 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:19:39.150331 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m21:19:39.150331 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\3.az\tb_composicao_produto.sql
[0m21:19:39.240508 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bd5b2234-2e49-4b83-9856-5c96572dadb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025081F11A60>]}
[0m21:19:39.250493 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bd5b2234-2e49-4b83-9856-5c96572dadb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025081E79D90>]}
[0m21:19:39.250493 [info ] [MainThread]: Found 6 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:19:39.250493 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bd5b2234-2e49-4b83-9856-5c96572dadb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025081E79C40>]}
[0m21:19:39.250493 [info ] [MainThread]: 
[0m21:19:39.259910 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:19:39.260547 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:19:39.260547 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:19:40.081469 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m21:19:40.081469 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:19:40.114981 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:19:40.114981 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:19:40.810414 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m21:19:40.810414 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:19:41.440973 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bd5b2234-2e49-4b83-9856-5c96572dadb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025081B20610>]}
[0m21:19:41.440973 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:19:41.440973 [info ] [MainThread]: 
[0m21:19:41.455660 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:19:41.455660 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m21:19:41.461114 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_composicao_produto'
[0m21:19:41.463208 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m21:19:41.475766 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m21:19:41.479313 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 21:19:41.463208 => 21:19:41.478072
[0m21:19:41.481574 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m21:19:41.521488 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m21:19:41.522495 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:19:41.524495 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m21:19:42.861910 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1923e776-fffe-4bf9-8bc6-c22edd5f1ef6&page=queryresults
[0m21:19:44.980867 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 21:19:41.482583 => 21:19:44.980867
[0m21:19:44.980867 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bd5b2234-2e49-4b83-9856-5c96572dadb6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002508200E6A0>]}
[0m21:19:44.980867 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (346.0 rows, 82.6 KiB processed)[0m in 3.52s]
[0m21:19:44.980867 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:19:44.980867 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:19:44.980867 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:19:44.980867 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:19:44.980867 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m21:19:44.980867 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m21:19:44.980867 [info ] [MainThread]: 
[0m21:19:44.980867 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.72 seconds (5.72s).
[0m21:19:44.980867 [debug] [MainThread]: Command end result
[0m21:19:45.002197 [info ] [MainThread]: 
[0m21:19:45.003560 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:19:45.005668 [info ] [MainThread]: 
[0m21:19:45.006769 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:19:45.007759 [debug] [MainThread]: Command `dbt run` succeeded at 21:19:45.007759 after 6.41 seconds
[0m21:19:45.008758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000250FE575370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025081CCAFD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025081B43370>]}
[0m21:19:45.008758 [debug] [MainThread]: Flushing usage events
[0m21:20:38.074048 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002155E8B23D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002155D858310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002155D858790>]}


============================== 21:20:38.076997 | 0aea6e40-3821-4fa3-acd3-546e2100cc0f ==============================
[0m21:20:38.076997 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:20:38.077506 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_composicao_produto', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m21:20:38.422306 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0aea6e40-3821-4fa3-acd3-546e2100cc0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002155D83CA90>]}
[0m21:20:38.481171 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0aea6e40-3821-4fa3-acd3-546e2100cc0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000215612BFA90>]}
[0m21:20:38.482166 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:20:38.487776 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:20:38.580185 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:20:38.581183 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_composicao_produto.sql
[0m21:20:38.677798 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0aea6e40-3821-4fa3-acd3-546e2100cc0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000215622C1F10>]}
[0m21:20:38.687800 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0aea6e40-3821-4fa3-acd3-546e2100cc0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000215621CB3D0>]}
[0m21:20:38.687800 [info ] [MainThread]: Found 6 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:20:38.688804 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0aea6e40-3821-4fa3-acd3-546e2100cc0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000215621CB250>]}
[0m21:20:38.689795 [info ] [MainThread]: 
[0m21:20:38.689795 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:20:38.691801 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:20:38.691801 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:20:39.409910 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:20:39.411906 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:20:39.413902 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m21:20:39.414907 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:20:40.092984 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m21:20:40.093983 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:20:40.824805 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0aea6e40-3821-4fa3-acd3-546e2100cc0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021561F9D2B0>]}
[0m21:20:40.827404 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:20:40.829457 [info ] [MainThread]: 
[0m21:20:40.843218 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:20:40.845221 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m21:20:40.848975 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_composicao_produto'
[0m21:20:40.851537 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m21:20:40.884853 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m21:20:40.885853 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 21:20:40.853510 => 21:20:40.885853
[0m21:20:40.888335 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m21:20:40.906770 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:20:41.667628 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m21:20:41.668688 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
    where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto              as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_base_produto               as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao_base
  order by nm_produto_completo
    );
  
[0m21:20:42.049544 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ad0db52a-df3e-4d72-953f-6a771f9549a3&page=queryresults
[0m21:20:42.051488 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Table "cte_base_produto" must be qualified with a dataset (e.g. dataset.table).')
[0m21:20:42.459508 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c9b1e583-b3e8-4732-9ae4-d6a7b45251ff&page=queryresults
[0m21:20:42.461469 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c9b1e583-b3e8-4732-9ae4-d6a7b45251ff&page=queryresults
[0m21:20:42.463462 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 21:20:40.889331 => 21:20:42.462461
[0m21:20:42.473340 [debug] [Thread-1  ]: Database Error in model tb_composicao_produto (models\3.az\tb_composicao_produto.sql)
  Table "cte_base_produto" must be qualified with a dataset (e.g. dataset.table).
  compiled Code at target\run\shibaribrasil\models\3.az\tb_composicao_produto.sql
[0m21:20:42.474349 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0aea6e40-3821-4fa3-acd3-546e2100cc0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021562383C10>]}
[0m21:20:42.475377 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_composicao_produto .......... [[31mERROR[0m in 1.63s]
[0m21:20:42.477336 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:20:42.480335 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:20:42.480335 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:20:42.480335 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m21:20:42.481326 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m21:20:42.481326 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m21:20:42.481326 [info ] [MainThread]: 
[0m21:20:42.482377 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 3.79 seconds (3.79s).
[0m21:20:42.483335 [debug] [MainThread]: Command end result
[0m21:20:42.492633 [info ] [MainThread]: 
[0m21:20:42.493646 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:20:42.493646 [info ] [MainThread]: 
[0m21:20:42.494624 [error] [MainThread]:   Database Error in model tb_composicao_produto (models\3.az\tb_composicao_produto.sql)
  Table "cte_base_produto" must be qualified with a dataset (e.g. dataset.table).
  compiled Code at target\run\shibaribrasil\models\3.az\tb_composicao_produto.sql
[0m21:20:42.495605 [info ] [MainThread]: 
[0m21:20:42.496645 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m21:20:42.497599 [debug] [MainThread]: Command `dbt run` failed at 21:20:42.497599 after 4.47 seconds
[0m21:20:42.498690 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002155E8B23D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000215612BFA90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002156229D5B0>]}
[0m21:20:42.498690 [debug] [MainThread]: Flushing usage events
[0m21:21:07.822364 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA3CD1460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA2C679D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA2C67B80>]}


============================== 21:21:07.825410 | e7f0668f-eea5-43b7-85f9-710b537b078d ==============================
[0m21:21:07.825410 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:21:07.826348 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --models tb_composicao_produto', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:21:08.228820 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e7f0668f-eea5-43b7-85f9-710b537b078d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA2C6F9A0>]}
[0m21:21:08.293475 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e7f0668f-eea5-43b7-85f9-710b537b078d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA73627C0>]}
[0m21:21:08.294483 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:21:08.300009 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:21:08.387771 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:21:08.388916 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_composicao_produto.sql
[0m21:21:08.495305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e7f0668f-eea5-43b7-85f9-710b537b078d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA76E9430>]}
[0m21:21:08.506084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e7f0668f-eea5-43b7-85f9-710b537b078d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA75E87F0>]}
[0m21:21:08.506084 [info ] [MainThread]: Found 6 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:21:08.507084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7f0668f-eea5-43b7-85f9-710b537b078d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA75E8700>]}
[0m21:21:08.507623 [info ] [MainThread]: 
[0m21:21:08.508783 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:21:08.510665 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:21:08.510665 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:21:09.190332 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:21:09.191329 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:21:09.193320 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m21:21:09.194327 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:21:09.907243 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m21:21:09.908342 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:21:10.621796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7f0668f-eea5-43b7-85f9-710b537b078d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA725B3D0>]}
[0m21:21:10.622771 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:21:10.622771 [info ] [MainThread]: 
[0m21:21:10.626772 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:21:10.627767 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m21:21:10.627767 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_composicao_produto'
[0m21:21:10.628750 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m21:21:10.634748 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m21:21:10.635748 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 21:21:10.628750 => 21:21:10.635748
[0m21:21:10.636761 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m21:21:10.649665 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:21:11.307595 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m21:21:11.308604 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
    where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto              as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto               as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao_base
  order by nm_produto_completo
    );
  
[0m21:21:12.054567 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7724dc48-a828-4179-b48b-f45b7ab937c8&page=queryresults
[0m21:21:12.457518 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Duplicate alias cte_item_composicao_base for WITH subquery at [54:3]')
[0m21:21:13.554935 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:485ce690-26e0-4115-b828-8a156f211fea&page=queryresults
[0m21:21:13.997110 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:485ce690-26e0-4115-b828-8a156f211fea&page=queryresults
[0m21:21:13.999161 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 21:21:10.636761 => 21:21:13.998157
[0m21:21:14.004110 [debug] [Thread-1  ]: Database Error in model tb_composicao_produto (models\3.az\tb_composicao_produto.sql)
  Duplicate alias cte_item_composicao_base for WITH subquery at [54:3]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_composicao_produto.sql
[0m21:21:14.005102 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e7f0668f-eea5-43b7-85f9-710b537b078d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA87DDA60>]}
[0m21:21:14.005102 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_composicao_produto .......... [[31mERROR[0m in 3.38s]
[0m21:21:14.006100 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:21:14.008573 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:21:14.008573 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:21:14.009623 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m21:21:14.009623 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:21:14.010618 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m21:21:14.010618 [info ] [MainThread]: 
[0m21:21:14.010618 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.50 seconds (5.50s).
[0m21:21:14.011618 [debug] [MainThread]: Command end result
[0m21:21:14.027883 [info ] [MainThread]: 
[0m21:21:14.028961 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:21:14.030912 [info ] [MainThread]: 
[0m21:21:14.032949 [error] [MainThread]:   Database Error in model tb_composicao_produto (models\3.az\tb_composicao_produto.sql)
  Duplicate alias cte_item_composicao_base for WITH subquery at [54:3]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_composicao_produto.sql
[0m21:21:14.033910 [info ] [MainThread]: 
[0m21:21:14.035914 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m21:21:14.039422 [debug] [MainThread]: Command `dbt run` failed at 21:21:14.039422 after 6.27 seconds
[0m21:21:14.040427 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA3CD1460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA73627C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026AA7783820>]}
[0m21:21:14.042416 [debug] [MainThread]: Flushing usage events
[0m21:21:47.274947 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285EF8BB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285EE8499D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285EE849B80>]}


============================== 21:21:47.277698 | a8252cdd-19fb-4f47-8627-0982d64571c6 ==============================
[0m21:21:47.277698 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:21:47.278738 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_composicao_produto', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m21:21:47.624323 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a8252cdd-19fb-4f47-8627-0982d64571c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F1A0BB80>]}
[0m21:21:47.684957 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a8252cdd-19fb-4f47-8627-0982d64571c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F2F29460>]}
[0m21:21:47.685959 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:21:47.692523 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:21:47.798862 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:21:47.799866 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_composicao_produto.sql
[0m21:21:47.899863 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a8252cdd-19fb-4f47-8627-0982d64571c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F32A3190>]}
[0m21:21:47.907819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a8252cdd-19fb-4f47-8627-0982d64571c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F31B74F0>]}
[0m21:21:47.908875 [info ] [MainThread]: Found 6 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:21:47.909812 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a8252cdd-19fb-4f47-8627-0982d64571c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F31B7370>]}
[0m21:21:47.909812 [info ] [MainThread]: 
[0m21:21:47.910945 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:21:47.912867 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:21:47.912867 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:21:48.617680 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:21:48.619838 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:21:48.621833 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m21:21:48.622914 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:21:49.309908 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m21:21:49.312849 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:21:50.044761 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a8252cdd-19fb-4f47-8627-0982d64571c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F2EBDD90>]}
[0m21:21:50.044761 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:21:50.045761 [info ] [MainThread]: 
[0m21:21:50.049092 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:21:50.049092 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m21:21:50.050093 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_composicao_produto'
[0m21:21:50.051108 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m21:21:50.057483 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m21:21:50.058475 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 21:21:50.051108 => 21:21:50.058475
[0m21:21:50.058475 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m21:21:50.072482 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:21:50.791518 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m21:21:50.792499 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
    where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto              as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m21:21:51.483836 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e646e4b2-660b-409c-877a-eac26a53b271&page=queryresults
[0m21:21:56.691075 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 21:21:50.059488 => 21:21:56.691075
[0m21:21:56.693070 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a8252cdd-19fb-4f47-8627-0982d64571c6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F3393760>]}
[0m21:21:56.694062 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 103.3 KiB processed)[0m in 6.64s]
[0m21:21:56.694062 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:21:56.697057 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:21:56.698056 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:21:56.698056 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m21:21:56.699054 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:21:56.699054 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m21:21:56.699054 [info ] [MainThread]: 
[0m21:21:56.700059 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 8.79 seconds (8.79s).
[0m21:21:56.701058 [debug] [MainThread]: Command end result
[0m21:21:56.708149 [info ] [MainThread]: 
[0m21:21:56.709075 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:21:56.709075 [info ] [MainThread]: 
[0m21:21:56.710069 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:21:56.711087 [debug] [MainThread]: Command `dbt run` succeeded at 21:21:56.711087 after 9.49 seconds
[0m21:21:56.711087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285EF8BB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F3371700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000285F31E61F0>]}
[0m21:21:56.711087 [debug] [MainThread]: Flushing usage events
[0m21:24:22.055334 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C293849460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2927D59D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2927D5B80>]}


============================== 21:24:22.058029 | ea6be0e2-87bc-436d-bb90-816556ba95bc ==============================
[0m21:24:22.058029 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:24:22.059044 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_composicao_produto', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:24:22.412971 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ea6be0e2-87bc-436d-bb90-816556ba95bc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C2927CC130>]}
[0m21:24:22.473209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ea6be0e2-87bc-436d-bb90-816556ba95bc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C296E65340>]}
[0m21:24:22.474211 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:24:22.481622 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:24:22.583881 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:24:22.584879 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_composicao_produto.sql
[0m21:24:22.679737 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ea6be0e2-87bc-436d-bb90-816556ba95bc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C29720AEE0>]}
[0m21:24:22.688401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ea6be0e2-87bc-436d-bb90-816556ba95bc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C29715B430>]}
[0m21:24:22.689403 [info ] [MainThread]: Found 6 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:24:22.690343 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ea6be0e2-87bc-436d-bb90-816556ba95bc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C29715B2B0>]}
[0m21:24:22.691404 [info ] [MainThread]: 
[0m21:24:22.691404 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:24:22.693402 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:24:22.693402 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:24:23.444152 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m21:24:23.445152 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:24:23.447120 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m21:24:23.447733 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:24:24.115217 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m21:24:24.118227 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:24:24.776622 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ea6be0e2-87bc-436d-bb90-816556ba95bc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C296F2B6D0>]}
[0m21:24:24.778510 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:24:24.779526 [info ] [MainThread]: 
[0m21:24:24.787487 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:24:24.788143 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m21:24:24.790156 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_composicao_produto'
[0m21:24:24.790156 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m21:24:24.805718 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m21:24:24.807443 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 21:24:24.791154 => 21:24:24.806709
[0m21:24:24.808463 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m21:24:24.821752 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:24:25.525561 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m21:24:25.526447 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m21:24:26.315832 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:87d2edd5-dbd8-430a-836a-1533b8330a75&page=queryresults
[0m21:24:28.203298 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 21:24:24.808463 => 21:24:28.203298
[0m21:24:28.204299 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ea6be0e2-87bc-436d-bb90-816556ba95bc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C29732C520>]}
[0m21:24:28.205297 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 103.3 KiB processed)[0m in 3.42s]
[0m21:24:28.206802 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:24:28.208570 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:24:28.208570 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:24:28.208570 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m21:24:28.208570 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:24:28.209602 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m21:24:28.209602 [info ] [MainThread]: 
[0m21:24:28.210590 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.52 seconds (5.52s).
[0m21:24:28.211511 [debug] [MainThread]: Command end result
[0m21:24:28.219510 [info ] [MainThread]: 
[0m21:24:28.220502 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:24:28.221545 [info ] [MainThread]: 
[0m21:24:28.222531 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:24:28.222835 [debug] [MainThread]: Command `dbt run` succeeded at 21:24:28.222835 after 6.22 seconds
[0m21:24:28.223945 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C293849460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C296E34070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001C297179D30>]}
[0m21:24:28.223945 [debug] [MainThread]: Flushing usage events
[0m21:25:48.016285 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001882CB6D400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001882BAE7910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001882BAE7B80>]}


============================== 21:25:48.018284 | 9f88bc40-db82-4222-99f5-17958702cbde ==============================
[0m21:25:48.018284 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:25:48.019303 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models dm_produto+', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:25:48.389039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9f88bc40-db82-4222-99f5-17958702cbde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001882BAF67C0>]}
[0m21:25:48.450953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9f88bc40-db82-4222-99f5-17958702cbde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000188301E2AC0>]}
[0m21:25:48.452012 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:25:48.458643 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:25:48.556059 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:25:48.557065 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\2.dw\dm_produto.sql
[0m21:25:48.655615 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9f88bc40-db82-4222-99f5-17958702cbde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018830537400>]}
[0m21:25:48.664315 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9f88bc40-db82-4222-99f5-17958702cbde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018830467760>]}
[0m21:25:48.664315 [info ] [MainThread]: Found 6 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:25:48.665378 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9f88bc40-db82-4222-99f5-17958702cbde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001883043C550>]}
[0m21:25:48.666395 [info ] [MainThread]: 
[0m21:25:48.667312 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:25:48.668976 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:25:48.668976 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:25:48.694427 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:25:48.695431 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:25:50.046956 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m21:25:50.048072 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:25:50.078789 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m21:25:50.078789 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:25:50.755656 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m21:25:50.757654 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:25:51.454550 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9f88bc40-db82-4222-99f5-17958702cbde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000188302A2460>]}
[0m21:25:51.456643 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:25:51.457432 [info ] [MainThread]: 
[0m21:25:51.465079 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m21:25:51.467097 [info ] [Thread-1  ]: 1 of 3 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m21:25:51.469119 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.dm_produto'
[0m21:25:51.469119 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m21:25:51.485634 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m21:25:51.487119 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 21:25:51.470115 => 21:25:51.487119
[0m21:25:51.488126 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m21:25:51.504141 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:25:52.255684 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m21:25:52.256681 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao' ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m21:25:52.634969 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7c40dd30-69e0-495a-a1e5-56dd99a642ae&page=queryresults
[0m21:25:52.635968 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Syntax error: Expected ")" but got identifier "ds_variacao" at [128:104]')
[0m21:25:53.864243 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:08197888-bf96-4824-ac1c-ac4dea2233b8&page=queryresults
[0m21:25:53.866239 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:08197888-bf96-4824-ac1c-ac4dea2233b8&page=queryresults
[0m21:25:53.867559 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 21:25:51.488126 => 21:25:53.867559
[0m21:25:53.875878 [debug] [Thread-1  ]: Database Error in model dm_produto (models\2.dw\dm_produto.sql)
  Syntax error: Expected ")" but got identifier "ds_variacao" at [128:104]
  compiled Code at target\run\shibaribrasil\models\2.dw\dm_produto.sql
[0m21:25:53.877734 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f88bc40-db82-4222-99f5-17958702cbde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018831695F10>]}
[0m21:25:53.878848 [error] [Thread-1  ]: 1 of 3 ERROR creating sql table model dbt_dw_dw.dm_produto ..................... [[31mERROR[0m in 2.41s]
[0m21:25:53.880762 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m21:25:53.882751 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m21:25:53.882751 [info ] [Thread-2  ]: 2 of 3 SKIP relation dbt_dw_az.tb_produto ...................................... [[33mSKIP[0m]
[0m21:25:53.884205 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m21:25:53.886273 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:25:53.887310 [info ] [Thread-1  ]: 3 of 3 SKIP relation dbt_dw_az.tb_composicao_produto ........................... [[33mSKIP[0m]
[0m21:25:53.888870 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:25:53.892779 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:25:53.892779 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:25:53.893824 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:25:53.893824 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m21:25:53.893824 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:25:53.894814 [debug] [MainThread]: Connection 'model.shibaribrasil.dm_produto' was properly closed.
[0m21:25:53.895824 [info ] [MainThread]: 
[0m21:25:53.896779 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 5.23 seconds (5.23s).
[0m21:25:53.897779 [debug] [MainThread]: Command end result
[0m21:25:53.909825 [info ] [MainThread]: 
[0m21:25:53.911832 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:25:53.912830 [info ] [MainThread]: 
[0m21:25:53.915000 [error] [MainThread]:   Database Error in model dm_produto (models\2.dw\dm_produto.sql)
  Syntax error: Expected ")" but got identifier "ds_variacao" at [128:104]
  compiled Code at target\run\shibaribrasil\models\2.dw\dm_produto.sql
[0m21:25:53.916017 [info ] [MainThread]: 
[0m21:25:53.916017 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=2 TOTAL=3
[0m21:25:53.917009 [debug] [MainThread]: Command `dbt run` failed at 21:25:53.917009 after 5.96 seconds
[0m21:25:53.918004 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001882CB6D400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000188301E2AC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000188302896A0>]}
[0m21:25:53.918004 [debug] [MainThread]: Flushing usage events
[0m21:26:06.086859 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020000D9D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200038436A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020003843DC0>]}


============================== 21:26:06.089857 | fa148bc6-8fd2-4de8-9d80-e72ca074a45a ==============================
[0m21:26:06.089857 [info ] [MainThread]: Running with dbt=1.7.4
[0m21:26:06.091137 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models dm_produto+', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m21:26:06.475627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020003832BB0>]}
[0m21:26:06.536139 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002000457E940>]}
[0m21:26:06.537145 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m21:26:06.543595 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m21:26:06.631776 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m21:26:06.631776 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\2.dw\dm_produto.sql
[0m21:26:06.725204 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200048CCB20>]}
[0m21:26:06.734848 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200046B2CA0>]}
[0m21:26:06.734848 [info ] [MainThread]: Found 6 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m21:26:06.735874 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002000450ECA0>]}
[0m21:26:06.736848 [info ] [MainThread]: 
[0m21:26:06.737409 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:26:06.738480 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:26:06.739498 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:26:06.761789 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m21:26:06.762852 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:26:07.943482 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m21:26:07.945492 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:26:07.947048 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m21:26:07.949091 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:26:08.618318 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m21:26:08.619438 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:26:09.277242 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200049B3250>]}
[0m21:26:09.281364 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m21:26:09.283368 [info ] [MainThread]: 
[0m21:26:09.294358 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m21:26:09.295380 [info ] [Thread-1  ]: 1 of 3 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m21:26:09.297365 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.dm_produto'
[0m21:26:09.297365 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m21:26:09.308818 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m21:26:09.309787 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 21:26:09.298362 => 21:26:09.309787
[0m21:26:09.310790 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m21:26:09.320613 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m21:26:10.072561 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m21:26:10.073557 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m21:26:10.760413 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:79b6755b-2dda-4373-8b00-1b0df65eca8d&page=queryresults
[0m21:26:13.236367 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 21:26:09.310790 => 21:26:13.236367
[0m21:26:13.237373 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020004A0CCA0>]}
[0m21:26:13.237966 [info ] [Thread-1  ]: 1 of 3 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 3.94s]
[0m21:26:13.238978 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m21:26:13.239476 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m21:26:13.240484 [info ] [Thread-2  ]: 2 of 3 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m21:26:13.241482 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_produto'
[0m21:26:13.241482 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m21:26:13.244589 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m21:26:13.245487 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 21:26:13.241482 => 21:26:13.244589
[0m21:26:13.245487 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m21:26:13.247904 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m21:26:13.935038 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m21:26:13.938038 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m21:26:14.651069 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6bc578ce-29d1-42b7-b782-132337dac852&page=queryresults
[0m21:26:16.640440 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 21:26:13.245487 => 21:26:16.640440
[0m21:26:16.642438 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020005A20CA0>]}
[0m21:26:16.643439 [info ] [Thread-2  ]: 2 of 3 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.40s]
[0m21:26:16.645452 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m21:26:16.646879 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m21:26:16.647921 [info ] [Thread-1  ]: 3 of 3 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m21:26:16.650921 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m21:26:16.651926 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m21:26:16.659918 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m21:26:16.662922 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 21:26:16.651926 => 21:26:16.662003
[0m21:26:16.662922 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m21:26:16.672451 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:26:17.328267 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m21:26:17.330285 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m21:26:17.993827 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a3df1375-e1e3-47ea-b7b9-7f62d2193f15&page=queryresults
[0m21:26:20.087302 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 21:26:16.664010 => 21:26:20.086690
[0m21:26:20.088445 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fa148bc6-8fd2-4de8-9d80-e72ca074a45a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200048AE400>]}
[0m21:26:20.089452 [info ] [Thread-1  ]: 3 of 3 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.44s]
[0m21:26:20.091392 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m21:26:20.095335 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:26:20.096241 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:26:20.096241 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m21:26:20.097237 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m21:26:20.097960 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m21:26:20.097960 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m21:26:20.099072 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m21:26:20.099987 [info ] [MainThread]: 
[0m21:26:20.100980 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 13.36 seconds (13.36s).
[0m21:26:20.102980 [debug] [MainThread]: Command end result
[0m21:26:20.121510 [info ] [MainThread]: 
[0m21:26:20.123507 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:26:20.124506 [info ] [MainThread]: 
[0m21:26:20.125508 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m21:26:20.128072 [debug] [MainThread]: Command `dbt run` succeeded at 21:26:20.127056 after 14.10 seconds
[0m21:26:20.128072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020000D9D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000200044BF220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020004839880>]}
[0m21:26:20.129072 [debug] [MainThread]: Flushing usage events
[0m22:00:03.598557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D68723D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D57F99D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D57F9B80>]}


============================== 22:00:03.601591 | 305f2aab-1fc9-4c8c-99fc-fa94de359d02 ==============================
[0m22:00:03.601591 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:00:03.601591 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'send_anonymous_usage_stats': 'True'}
[0m22:00:03.946974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D89BAAF0>]}
[0m22:00:04.005222 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D9EE16A0>]}
[0m22:00:04.006228 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:00:04.012649 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:00:04.057684 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:00:04.057684 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:00:04.061692 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DA179670>]}
[0m22:00:04.071083 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DA097310>]}
[0m22:00:04.072081 [info ] [MainThread]: Found 6 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:00:04.072081 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DA097220>]}
[0m22:00:04.074098 [info ] [MainThread]: 
[0m22:00:04.074427 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:00:04.076450 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:00:04.076450 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:04.077490 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:00:04.099187 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:04.895428 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:00:05.576056 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:00:05.577715 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:05.579736 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:00:05.581741 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:06.226240 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m22:00:06.227223 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:00:06.997729 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D9F5FE50>]}
[0m22:00:07.001769 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:00:07.002778 [info ] [MainThread]: 
[0m22:00:07.009738 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m22:00:07.010724 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m22:00:07.010724 [info ] [Thread-1  ]: 1 of 6 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m22:00:07.012717 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m22:00:07.011732 [info ] [Thread-2  ]: 2 of 6 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m22:00:07.014729 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m22:00:07.015719 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_composicao_produto'
[0m22:00:07.022722 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m22:00:07.022722 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m22:00:07.025721 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m22:00:07.027719 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 22:00:07.023716 => 22:00:07.027719
[0m22:00:07.027719 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m22:00:07.036749 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 22:00:07.016727 => 22:00:07.035806
[0m22:00:07.036749 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m22:00:07.058191 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m22:00:07.059198 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m22:00:07.061273 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m22:00:07.062248 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m22:00:07.084403 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:00:07.086753 [debug] [Thread-1  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m22:00:07.987675 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:03178061-87ed-48e0-a935-e513986cc2a1&page=queryresults
[0m22:00:08.022223 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:26a48e51-e451-44ab-b536-69c675b325e7&page=queryresults
[0m22:00:08.484547 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 22:00:07.027719 => 22:00:08.484547
[0m22:00:08.485555 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DA219D00>]}
[0m22:00:08.489437 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 22:00:07.037137 => 22:00:08.489437
[0m22:00:08.490388 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DA1C8820>]}
[0m22:00:08.485555 [info ] [Thread-2  ]: 2 of 6 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m22:00:08.491427 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m22:00:08.491427 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m22:00:08.490388 [info ] [Thread-1  ]: 1 of 6 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.48s]
[0m22:00:08.492656 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m22:00:08.492387 [info ] [Thread-2  ]: 3 of 6 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m22:00:08.493663 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_produto)
[0m22:00:08.493663 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m22:00:08.495663 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m22:00:08.497172 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 22:00:08.493663 => 22:00:08.497172
[0m22:00:08.497172 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m22:00:08.499180 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m22:00:08.500184 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m22:00:08.501182 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m22:00:09.386828 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7d1604a5-064f-49a1-a302-ce94e59bacb6&page=queryresults
[0m22:00:09.780159 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 22:00:08.497172 => 22:00:09.780159
[0m22:00:09.782153 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DA1C8820>]}
[0m22:00:09.784677 [info ] [Thread-2  ]: 3 of 6 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m22:00:09.786474 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m22:00:09.788077 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m22:00:09.789188 [info ] [Thread-1  ]: 4 of 6 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m22:00:09.791145 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.dm_produto)
[0m22:00:09.791145 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m22:00:09.796178 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m22:00:09.797572 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 22:00:09.792143 => 22:00:09.797209
[0m22:00:09.797572 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m22:00:09.804668 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:00:10.515805 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m22:00:10.516805 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m22:00:11.121290 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6c9c2352-d1dc-4970-807c-e57dd89f55ea&page=queryresults
[0m22:00:13.944269 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 22:00:09.797572 => 22:00:13.943268
[0m22:00:13.944269 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DA1798B0>]}
[0m22:00:13.945267 [info ] [Thread-1  ]: 4 of 6 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.15s]
[0m22:00:13.946269 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m22:00:13.947269 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m22:00:13.947600 [info ] [Thread-2  ]: 5 of 6 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m22:00:13.952605 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m22:00:13.952605 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m22:00:13.955602 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m22:00:13.957201 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 22:00:13.953605 => 22:00:13.957201
[0m22:00:13.957201 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m22:00:13.959198 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m22:00:14.633165 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m22:00:14.635166 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m22:00:15.224417 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fbd94d89-d117-4c1c-96a4-f560528ffc44&page=queryresults
[0m22:00:17.367261 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 22:00:13.957201 => 22:00:17.367261
[0m22:00:17.368264 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DB297D60>]}
[0m22:00:17.369265 [info ] [Thread-2  ]: 5 of 6 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.42s]
[0m22:00:17.372260 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m22:00:17.373256 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m22:00:17.374257 [info ] [Thread-1  ]: 6 of 6 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m22:00:17.375255 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m22:00:17.375255 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m22:00:17.379273 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m22:00:17.380264 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 22:00:17.375255 => 22:00:17.380264
[0m22:00:17.381257 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m22:00:17.384254 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:00:18.016898 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m22:00:18.018905 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m22:00:18.765270 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7bc63069-0d07-4209-8404-6892716a89f9&page=queryresults
[0m22:00:21.061460 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 22:00:17.381257 => 22:00:21.060454
[0m22:00:21.063456 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '305f2aab-1fc9-4c8c-99fc-fa94de359d02', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295DB2C8D60>]}
[0m22:00:21.064458 [info ] [Thread-1  ]: 6 of 6 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.69s]
[0m22:00:21.067201 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m22:00:21.072213 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:00:21.073289 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:00:21.074231 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:00:21.075260 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:00:21.075260 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:00:21.076220 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m22:00:21.076220 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m22:00:21.077218 [info ] [MainThread]: 
[0m22:00:21.078228 [info ] [MainThread]: Finished running 3 view models, 3 table models in 0 hours 0 minutes and 17.00 seconds (17.00s).
[0m22:00:21.081218 [debug] [MainThread]: Command end result
[0m22:00:21.103042 [info ] [MainThread]: 
[0m22:00:21.104055 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:00:21.105052 [info ] [MainThread]: 
[0m22:00:21.106061 [info ] [MainThread]: Done. PASS=6 WARN=0 ERROR=0 SKIP=0 TOTAL=6
[0m22:00:21.107050 [debug] [MainThread]: Command `dbt run` succeeded at 22:00:21.107050 after 17.57 seconds
[0m22:00:21.107050 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D68723D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D9EE16A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000295D9F9C6D0>]}
[0m22:00:21.107050 [debug] [MainThread]: Flushing usage events
[0m22:35:10.588876 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E4892430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E38239D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E3823B80>]}


============================== 22:35:10.592870 | 6e7c7602-ca9b-4801-9507-8a4ef0a16c41 ==============================
[0m22:35:10.592870 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:35:10.592870 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:35:11.062210 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6e7c7602-ca9b-4801-9507-8a4ef0a16c41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E69FBAC0>]}
[0m22:35:11.123759 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6e7c7602-ca9b-4801-9507-8a4ef0a16c41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E7F22760>]}
[0m22:35:11.124820 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:35:11.131769 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:35:11.203397 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m22:35:11.203397 [debug] [MainThread]: Partial parsing: added file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:35:11.297696 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6e7c7602-ca9b-4801-9507-8a4ef0a16c41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E8329520>]}
[0m22:35:11.301599 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6e7c7602-ca9b-4801-9507-8a4ef0a16c41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E81AB1F0>]}
[0m22:35:11.301599 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:35:11.301599 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6e7c7602-ca9b-4801-9507-8a4ef0a16c41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E81AB220>]}
[0m22:35:11.301599 [info ] [MainThread]: 
[0m22:35:11.301599 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:35:11.301599 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:35:11.301599 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:35:12.103074 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:35:12.103074 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:35:12.103074 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:35:12.103074 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:35:12.752241 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m22:35:12.753332 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:35:13.434031 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6e7c7602-ca9b-4801-9507-8a4ef0a16c41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E7F7B610>]}
[0m22:35:13.436586 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:35:13.437736 [info ] [MainThread]: 
[0m22:35:13.447958 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:35:13.448957 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:35:13.449963 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:35:13.451382 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:35:13.476255 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:35:13.478271 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:35:13.452400 => 22:35:13.477368
[0m22:35:13.478271 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:35:13.508182 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:35:13.508182 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:35:13.508182 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as int64)            as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as int64)                as cd_valor
          ,cast(json_value(a.json_element, '$.item') as int64)                 as ds_valor_campo
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m22:35:14.763304 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:86ed5a13-1efe-4133-8257-3ad0a574b6b1&page=queryresults
[0m22:35:15.283681 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:35:13.479371 => 22:35:15.283681
[0m22:35:15.283681 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e7c7602-ca9b-4801-9507-8a4ef0a16c41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E93ADE80>]}
[0m22:35:15.283681 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.83s]
[0m22:35:15.283681 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:35:15.283681 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:35:15.283681 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:35:15.283681 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:35:15.283681 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:35:15.283681 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:35:15.283681 [info ] [MainThread]: 
[0m22:35:15.283681 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.98 seconds (3.98s).
[0m22:35:15.283681 [debug] [MainThread]: Command end result
[0m22:35:15.304978 [info ] [MainThread]: 
[0m22:35:15.304978 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:35:15.306112 [info ] [MainThread]: 
[0m22:35:15.306112 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:35:15.306112 [debug] [MainThread]: Command `dbt run` succeeded at 22:35:15.306112 after 4.81 seconds
[0m22:35:15.306112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E4892430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E7FEB370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000185E81D64F0>]}
[0m22:35:15.306112 [debug] [MainThread]: Flushing usage events
[0m22:36:00.035210 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944C0813D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944B0202E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944B020760>]}


============================== 22:36:00.037676 | c6a2a5e2-7e24-4d83-9e77-1926d01edb96 ==============================
[0m22:36:00.037676 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:36:00.038676 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:36:00.396320 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c6a2a5e2-7e24-4d83-9e77-1926d01edb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944B00C0D0>]}
[0m22:36:00.455313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c6a2a5e2-7e24-4d83-9e77-1926d01edb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944F69EEB0>]}
[0m22:36:00.455313 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:36:00.462165 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:36:00.562870 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:36:00.562870 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:36:00.656733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c6a2a5e2-7e24-4d83-9e77-1926d01edb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944FA826D0>]}
[0m22:36:00.665406 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c6a2a5e2-7e24-4d83-9e77-1926d01edb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944F85AB50>]}
[0m22:36:00.665406 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:36:00.666376 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c6a2a5e2-7e24-4d83-9e77-1926d01edb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944F6AAC70>]}
[0m22:36:00.667416 [info ] [MainThread]: 
[0m22:36:00.668059 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:36:00.669127 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:36:00.669127 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:36:01.642135 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:36:01.643136 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:36:01.645234 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:36:01.645234 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:36:02.382229 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m22:36:02.384187 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:36:03.064894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c6a2a5e2-7e24-4d83-9e77-1926d01edb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944F738400>]}
[0m22:36:03.066925 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:36:03.067712 [info ] [MainThread]: 
[0m22:36:03.078002 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:36:03.079116 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:36:03.081021 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:36:03.082025 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:36:03.102246 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:36:03.104243 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:36:03.083022 => 22:36:03.104243
[0m22:36:03.106271 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:36:03.127004 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:36:03.128013 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:36:03.129023 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m22:36:04.017979 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2f9ca8ae-68ab-41fd-97e3-50edd5e34ee7&page=queryresults
[0m22:36:04.508223 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:36:03.106271 => 22:36:04.508223
[0m22:36:04.509210 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6a2a5e2-7e24-4d83-9e77-1926d01edb96', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944FB86FA0>]}
[0m22:36:04.510206 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.43s]
[0m22:36:04.511144 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:36:04.513120 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:36:04.514176 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:36:04.514176 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:36:04.514176 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:36:04.514176 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:36:04.515171 [info ] [MainThread]: 
[0m22:36:04.515171 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.85 seconds (3.85s).
[0m22:36:04.516123 [debug] [MainThread]: Command end result
[0m22:36:04.523615 [info ] [MainThread]: 
[0m22:36:04.524600 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:36:04.525599 [info ] [MainThread]: 
[0m22:36:04.526591 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:36:04.527592 [debug] [MainThread]: Command `dbt run` succeeded at 22:36:04.527592 after 4.55 seconds
[0m22:36:04.527592 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944C0813D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944F75E220>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001944F9CA760>]}
[0m22:36:04.527592 [debug] [MainThread]: Flushing usage events
[0m22:40:01.076792 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C9C75460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C8BF39A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C8BF3D30>]}


============================== 22:40:01.080085 | 43995b8f-e682-4c1a-b6e9-31a3129fe18d ==============================
[0m22:40:01.080085 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:40:01.080085 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:40:01.458341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '43995b8f-e682-4c1a-b6e9-31a3129fe18d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CBDC0B80>]}
[0m22:40:01.523026 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '43995b8f-e682-4c1a-b6e9-31a3129fe18d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CD2E29D0>]}
[0m22:40:01.524133 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:40:01.530608 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:40:01.616177 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:40:01.617177 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:01.719011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '43995b8f-e682-4c1a-b6e9-31a3129fe18d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CD6387F0>]}
[0m22:40:01.728832 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '43995b8f-e682-4c1a-b6e9-31a3129fe18d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CD3F4A60>]}
[0m22:40:01.728832 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:40:01.729831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '43995b8f-e682-4c1a-b6e9-31a3129fe18d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CD3F4A00>]}
[0m22:40:01.730848 [info ] [MainThread]: 
[0m22:40:01.731111 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:40:01.733171 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:40:01.733171 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:02.414332 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:40:02.415325 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:02.417924 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:40:02.419043 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:03.333246 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m22:40:03.335232 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:40:04.054492 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '43995b8f-e682-4c1a-b6e9-31a3129fe18d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CD305640>]}
[0m22:40:04.057499 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:40:04.059247 [info ] [MainThread]: 
[0m22:40:04.070251 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:04.071244 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:40:04.074250 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:40:04.075249 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:04.093298 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:40:04.095302 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:40:04.076258 => 22:40:04.095302
[0m22:40:04.096321 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:04.125251 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:40:04.126254 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:40:04.127253 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo as (
  select a.cd_produto_bling
        ,a.cd_produto
        ,cd_campo_customizado
        ,case 
          when cd_campo_customizado = '3435243' then 'Classificação Produto'
          when cd_campo_customizado = '3435246' then 'Ajuste de Preço'
          else null end ds_campo_customizado
        ,ds_valor_campo
)

select *
  from cte_campo;


[0m22:40:04.952806 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2dc15d95-0484-4e4c-b97f-ed01ef46699c&page=queryresults
[0m22:40:05.483512 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Duplicate alias cte_campo for WITH subquery at [35:3]')
[0m22:40:06.555465 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0d241ea4-5427-49d3-bda0-2709054075de&page=queryresults
[0m22:40:06.980047 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0d241ea4-5427-49d3-bda0-2709054075de&page=queryresults
[0m22:40:06.983042 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:40:04.096321 => 22:40:06.982041
[0m22:40:06.992043 [debug] [Thread-1  ]: Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  Duplicate alias cte_campo for WITH subquery at [35:3]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:06.993038 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '43995b8f-e682-4c1a-b6e9-31a3129fe18d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CD73B4F0>]}
[0m22:40:06.995048 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_campo_customizado_produto .. [[31mERROR[0m in 2.92s]
[0m22:40:06.997046 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:07.004049 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:40:07.006045 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:40:07.008988 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:40:07.009978 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:40:07.010978 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:40:07.010978 [info ] [MainThread]: 
[0m22:40:07.013977 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 5.28 seconds (5.28s).
[0m22:40:07.016977 [debug] [MainThread]: Command end result
[0m22:40:07.035286 [info ] [MainThread]: 
[0m22:40:07.036286 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:40:07.036286 [info ] [MainThread]: 
[0m22:40:07.037290 [error] [MainThread]:   Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  Duplicate alias cte_campo for WITH subquery at [35:3]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:07.037290 [info ] [MainThread]: 
[0m22:40:07.038292 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:40:07.039293 [debug] [MainThread]: Command `dbt run` failed at 22:40:07.039293 after 6.02 seconds
[0m22:40:07.039293 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5C9C75460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CD2E29D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F5CD329340>]}
[0m22:40:07.040293 [debug] [MainThread]: Flushing usage events
[0m22:40:26.910546 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B570D413D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B56FCCD2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B56FCCD760>]}


============================== 22:40:26.913548 | f82c79ea-4feb-4cb0-a94d-3acd4ef03345 ==============================
[0m22:40:26.913548 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:40:26.914109 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:40:27.278372 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f82c79ea-4feb-4cb0-a94d-3acd4ef03345', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B572EB0AF0>]}
[0m22:40:27.341225 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f82c79ea-4feb-4cb0-a94d-3acd4ef03345', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5743053D0>]}
[0m22:40:27.342262 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:40:27.348092 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:40:27.468558 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:40:27.468558 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:27.562587 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f82c79ea-4feb-4cb0-a94d-3acd4ef03345', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5747B8490>]}
[0m22:40:27.571414 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f82c79ea-4feb-4cb0-a94d-3acd4ef03345', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5745BB7F0>]}
[0m22:40:27.571414 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:40:27.572409 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f82c79ea-4feb-4cb0-a94d-3acd4ef03345', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5745BB670>]}
[0m22:40:27.573477 [info ] [MainThread]: 
[0m22:40:27.574402 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:40:27.575376 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:40:27.575376 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:28.349980 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:40:28.351012 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:28.352985 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:40:28.354742 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:29.020169 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m22:40:29.024282 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:40:29.671698 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f82c79ea-4feb-4cb0-a94d-3acd4ef03345', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B574359EE0>]}
[0m22:40:29.673692 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:40:29.674697 [info ] [MainThread]: 
[0m22:40:29.685950 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:29.687040 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:40:29.689949 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:40:29.690950 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:29.705941 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:40:29.707947 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:40:29.691951 => 22:40:29.706937
[0m22:40:29.708703 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:29.728819 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:40:29.729819 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:40:29.731821 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo as (
  select a.cd_produto_bling
        ,a.cd_produto
        ,cd_campo_customizado
        ,case 
          when cd_campo_customizado = '3435243' then 'Classificação Produto'
          when cd_campo_customizado = '3435246' then 'Ajuste de Preço'
          else null end ds_campo_customizado
        ,ds_valor_campo
    from cte_campo_expandido_base
)

select *
  from cte_campo;


[0m22:40:30.551311 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0765b92b-ffda-4aa4-b544-1259cf6981dc&page=queryresults
[0m22:40:30.980979 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Duplicate alias cte_campo for WITH subquery at [35:3]')
[0m22:40:31.982764 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0cc0374a-9b48-4cc7-955f-09e9b472f5f9&page=queryresults
[0m22:40:32.332817 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0cc0374a-9b48-4cc7-955f-09e9b472f5f9&page=queryresults
[0m22:40:32.335850 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:40:29.708703 => 22:40:32.334857
[0m22:40:32.343046 [debug] [Thread-1  ]: Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  Duplicate alias cte_campo for WITH subquery at [35:3]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:32.344042 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f82c79ea-4feb-4cb0-a94d-3acd4ef03345', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5747DE790>]}
[0m22:40:32.346047 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_campo_customizado_produto .. [[31mERROR[0m in 2.66s]
[0m22:40:32.347642 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:32.352662 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:40:32.353658 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:40:32.354701 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:40:32.354701 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:40:32.355750 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:40:32.355750 [info ] [MainThread]: 
[0m22:40:32.357655 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.78 seconds (4.78s).
[0m22:40:32.359656 [debug] [MainThread]: Command end result
[0m22:40:32.371145 [info ] [MainThread]: 
[0m22:40:32.372151 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:40:32.373148 [info ] [MainThread]: 
[0m22:40:32.374143 [error] [MainThread]:   Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  Duplicate alias cte_campo for WITH subquery at [35:3]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:32.375145 [info ] [MainThread]: 
[0m22:40:32.376145 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:40:32.377146 [debug] [MainThread]: Command `dbt run` failed at 22:40:32.376145 after 5.52 seconds
[0m22:40:32.377146 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B570D413D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5743053D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B57436A7F0>]}
[0m22:40:32.377146 [debug] [MainThread]: Flushing usage events
[0m22:40:39.924215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F31D113D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F30CB42E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F30CB4760>]}


============================== 22:40:39.926899 | 84734e52-dda3-4c7e-8883-d105d97d6661 ==============================
[0m22:40:39.926899 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:40:39.927958 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'send_anonymous_usage_stats': 'True'}
[0m22:40:40.288271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '84734e52-dda3-4c7e-8883-d105d97d6661', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F33E7BBE0>]}
[0m22:40:40.348770 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '84734e52-dda3-4c7e-8883-d105d97d6661', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F352D28E0>]}
[0m22:40:40.349775 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:40:40.355870 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:40:40.442740 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:40:40.442740 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:40.546066 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '84734e52-dda3-4c7e-8883-d105d97d6661', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F35712850>]}
[0m22:40:40.554688 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '84734e52-dda3-4c7e-8883-d105d97d6661', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F354B5BE0>]}
[0m22:40:40.555674 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:40:40.555674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '84734e52-dda3-4c7e-8883-d105d97d6661', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F3538BB20>]}
[0m22:40:40.557006 [info ] [MainThread]: 
[0m22:40:40.558044 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:40:40.559004 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:40:40.559004 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:41.249260 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:40:41.250300 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:41.283050 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:40:41.283050 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:41.937922 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m22:40:41.939039 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:40:42.658035 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '84734e52-dda3-4c7e-8883-d105d97d6661', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F353C4A00>]}
[0m22:40:42.660035 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:40:42.662035 [info ] [MainThread]: 
[0m22:40:42.672714 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:42.672714 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:40:42.676738 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:40:42.676738 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:42.692573 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:40:42.694580 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:40:42.676738 => 22:40:42.694580
[0m22:40:42.694580 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:42.714190 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:40:42.714190 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:40:42.716204 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select a.cd_produto_bling
        ,a.cd_produto
        ,cd_campo_customizado
        ,case 
          when cd_campo_customizado = '3435243' then 'Classificação Produto'
          when cd_campo_customizado = '3435246' then 'Ajuste de Preço'
          else null end ds_campo_customizado
        ,ds_valor_campo
    from cte_campo_expandido_base
)

select *
  from cte_campo_base;


[0m22:40:43.484443 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3d90beb3-c0ac-4402-bb51-27bc12a7748c&page=queryresults
[0m22:40:43.985864 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: a at [36:10]')
[0m22:40:45.010487 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3c4939a2-4aaa-4612-9f8b-e178a2490e78&page=queryresults
[0m22:40:45.418160 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3c4939a2-4aaa-4612-9f8b-e178a2490e78&page=queryresults
[0m22:40:45.420153 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:40:42.694580 => 22:40:45.420153
[0m22:40:45.427154 [debug] [Thread-1  ]: Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  Unrecognized name: a at [36:10]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:45.428663 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '84734e52-dda3-4c7e-8883-d105d97d6661', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F36813BB0>]}
[0m22:40:45.428663 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_campo_customizado_produto .. [[31mERROR[0m in 2.75s]
[0m22:40:45.430122 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:45.434232 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:40:45.435138 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:40:45.435138 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:40:45.435138 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:40:45.436138 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:40:45.436138 [info ] [MainThread]: 
[0m22:40:45.437138 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.88 seconds (4.88s).
[0m22:40:45.438500 [debug] [MainThread]: Command end result
[0m22:40:45.447974 [info ] [MainThread]: 
[0m22:40:45.448983 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:40:45.450075 [info ] [MainThread]: 
[0m22:40:45.450643 [error] [MainThread]:   Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  Unrecognized name: a at [36:10]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:45.450643 [info ] [MainThread]: 
[0m22:40:45.451652 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:40:45.452652 [debug] [MainThread]: Command `dbt run` failed at 22:40:45.452652 after 5.58 seconds
[0m22:40:45.453652 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F31D113D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F352D28E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029F35817D00>]}
[0m22:40:45.453652 [debug] [MainThread]: Flushing usage events
[0m22:40:55.804107 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028694E05430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028693D796A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028693D79DC0>]}


============================== 22:40:55.807169 | 48e1647b-5fd3-40e7-8fca-1fedf6a11fd2 ==============================
[0m22:40:55.807169 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:40:55.807704 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:40:56.181116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '48e1647b-5fd3-40e7-8fca-1fedf6a11fd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002869845E520>]}
[0m22:40:56.240825 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '48e1647b-5fd3-40e7-8fca-1fedf6a11fd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286983538E0>]}
[0m22:40:56.241830 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:40:56.248482 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:40:56.328921 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:40:56.329922 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:40:56.425563 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '48e1647b-5fd3-40e7-8fca-1fedf6a11fd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286987AAA00>]}
[0m22:40:56.435634 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '48e1647b-5fd3-40e7-8fca-1fedf6a11fd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286986400D0>]}
[0m22:40:56.435634 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:40:56.436633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '48e1647b-5fd3-40e7-8fca-1fedf6a11fd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002869838DD90>]}
[0m22:40:56.437633 [info ] [MainThread]: 
[0m22:40:56.438104 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:40:56.439109 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:40:56.440110 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:57.142445 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:40:57.143442 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:57.145443 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:40:57.145443 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:40:57.811545 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m22:40:57.813468 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:40:58.410862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '48e1647b-5fd3-40e7-8fca-1fedf6a11fd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286984CB220>]}
[0m22:40:58.413093 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:40:58.413986 [info ] [MainThread]: 
[0m22:40:58.423480 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:58.424480 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:40:58.425480 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:40:58.427477 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:58.436999 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:40:58.438008 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:40:58.427477 => 22:40:58.438008
[0m22:40:58.439010 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:58.459426 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:40:58.460425 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:40:58.462426 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        ,cd_campo_customizado
        ,case 
          when cd_campo_customizado = '3435243' then 'Classificação Produto'
          when cd_campo_customizado = '3435246' then 'Ajuste de Preço'
          else null end ds_campo_customizado
        ,ds_valor_campo
    from cte_campo_expandido_base
)

select *
  from cte_campo_base;


[0m22:40:59.347065 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:038a3381-8cc7-4a7d-a4f7-33ed383a6da2&page=queryresults
[0m22:40:59.873165 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:40:58.439010 => 22:40:59.873165
[0m22:40:59.873165 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '48e1647b-5fd3-40e7-8fca-1fedf6a11fd2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000286988D7F40>]}
[0m22:40:59.874221 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m22:40:59.875172 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:40:59.876177 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:40:59.877173 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:40:59.877173 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:40:59.877173 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:40:59.877173 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:40:59.878220 [info ] [MainThread]: 
[0m22:40:59.878220 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.44 seconds (3.44s).
[0m22:40:59.879152 [debug] [MainThread]: Command end result
[0m22:40:59.886131 [info ] [MainThread]: 
[0m22:40:59.887128 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:40:59.887128 [info ] [MainThread]: 
[0m22:40:59.888132 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:40:59.889130 [debug] [MainThread]: Command `dbt run` succeeded at 22:40:59.888132 after 4.15 seconds
[0m22:40:59.889130 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028694E05430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000028698502E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002869839E100>]}
[0m22:40:59.889130 [debug] [MainThread]: Flushing usage events
[0m22:44:07.985527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB50CB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB40539A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB4053D30>]}


============================== 22:44:07.988541 | 7c03d8b9-0a01-4358-95e4-18afd646314e ==============================
[0m22:44:07.988541 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:44:07.988541 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:44:08.341561 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7c03d8b9-0a01-4358-95e4-18afd646314e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB8727520>]}
[0m22:44:08.401461 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7c03d8b9-0a01-4358-95e4-18afd646314e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB862B8E0>]}
[0m22:44:08.401461 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:44:08.417404 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:44:08.510075 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:44:08.510075 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:44:08.605494 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7c03d8b9-0a01-4358-95e4-18afd646314e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB8A58A00>]}
[0m22:44:08.605494 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7c03d8b9-0a01-4358-95e4-18afd646314e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB89100D0>]}
[0m22:44:08.605494 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:44:08.605494 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7c03d8b9-0a01-4358-95e4-18afd646314e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB8663DC0>]}
[0m22:44:08.621273 [info ] [MainThread]: 
[0m22:44:08.621273 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:44:08.621273 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:44:08.621273 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:44:09.327703 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:44:09.327703 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:44:09.327703 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:44:09.327703 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:44:10.018385 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m22:44:10.020399 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:44:10.765014 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7c03d8b9-0a01-4358-95e4-18afd646314e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB89100D0>]}
[0m22:44:10.771674 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:44:10.772796 [info ] [MainThread]: 
[0m22:44:10.779155 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:44:10.781393 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:44:10.783667 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:44:10.784656 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:44:10.792092 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:44:10.792092 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:44:10.784656 => 22:44:10.792092
[0m22:44:10.792092 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:44:10.826634 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:44:10.826994 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:44:10.826994 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        ,cd_campo_customizado
        ,case 
          when cd_campo_customizado = '3435243' then 'Classificação Produto'
          when cd_campo_customizado = '3435246' then 'Ajuste de Preço'
          else null end ds_campo_customizado
        ,ds_valor_campo
    from cte_campo_expandido_base
)

select 
    cd_produto_bling,
    cd_produto,
    -- Pivoteia os campos
    MAX(IF(cd_campo_customizado = '3435243', ds_valor_campo, NULL)) as classificacao_produto,
    MAX(IF(cd_campo_customizado = '3435246', ds_valor_campo, NULL)) as ajuste_preco

from cte_campo_base
group by cd_produto_bling, cd_produto;


[0m22:44:11.822251 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:07b19556-4060-4ee8-a882-09b54e998c2b&page=queryresults
[0m22:44:12.272170 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:44:10.792092 => 22:44:12.272170
[0m22:44:12.272170 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7c03d8b9-0a01-4358-95e4-18afd646314e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB9BEE790>]}
[0m22:44:12.272170 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.49s]
[0m22:44:12.272170 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:44:12.272170 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:44:12.272170 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:44:12.272170 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:44:12.272170 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:44:12.272170 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:44:12.272170 [info ] [MainThread]: 
[0m22:44:12.272170 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.65 seconds (3.65s).
[0m22:44:12.272170 [debug] [MainThread]: Command end result
[0m22:44:12.287254 [info ] [MainThread]: 
[0m22:44:12.288239 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:44:12.288239 [info ] [MainThread]: 
[0m22:44:12.289249 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:44:12.290308 [debug] [MainThread]: Command `dbt run` succeeded at 22:44:12.290308 after 4.37 seconds
[0m22:44:12.290308 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB50CB460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB87D6E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001ABB866E100>]}
[0m22:44:12.290308 [debug] [MainThread]: Flushing usage events
[0m22:45:56.646976 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F61F8D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F60F006A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F60F00DC0>]}


============================== 22:45:56.648979 | 1b19b359-a79f-4ead-adcd-7506cf2c9617 ==============================
[0m22:45:56.648979 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:45:56.649935 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:45:56.999202 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1b19b359-a79f-4ead-adcd-7506cf2c9617', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F60F01BB0>]}
[0m22:45:57.063395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1b19b359-a79f-4ead-adcd-7506cf2c9617', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F656C01C0>]}
[0m22:45:57.063395 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:45:57.079546 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:45:57.181178 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:45:57.181178 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:45:57.277901 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1b19b359-a79f-4ead-adcd-7506cf2c9617', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F6595A0D0>]}
[0m22:45:57.287538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1b19b359-a79f-4ead-adcd-7506cf2c9617', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F657E4400>]}
[0m22:45:57.287538 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:45:57.288538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1b19b359-a79f-4ead-adcd-7506cf2c9617', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F657E43A0>]}
[0m22:45:57.289537 [info ] [MainThread]: 
[0m22:45:57.291044 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:45:57.292355 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:45:57.293356 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:45:58.152315 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:45:58.152315 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:45:58.168426 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:45:58.168426 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:45:58.862807 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m22:45:58.874385 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:45:59.579246 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1b19b359-a79f-4ead-adcd-7506cf2c9617', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F6562FA30>]}
[0m22:45:59.579246 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:45:59.579246 [info ] [MainThread]: 
[0m22:45:59.597921 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:45:59.597921 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:45:59.597921 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:45:59.597921 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:45:59.627346 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:45:59.629352 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:45:59.607252 => 22:45:59.628440
[0m22:45:59.629352 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:45:59.653712 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:45:59.654818 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:45:59.655715 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        ,cd_campo_customizado
        -- Pivoteia os campos
        ,MAX(IF(cd_campo_customizado = '3435243', ds_valor_campo, NULL)) as ds_classificacao_produto
        ,MAX(IF(cd_campo_customizado = '3435246', ds_valor_campo, NULL)) as fg_ajuste_preco  
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

select *
from cte_campo_base;


[0m22:46:00.609754 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:385d704e-78f7-4aa6-8718-edb818c5b61e&page=queryresults
[0m22:46:01.124967 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('SELECT list expression references column cd_campo_customizado which is neither grouped nor aggregated at [38:10]')
[0m22:46:01.619181 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d750a5c2-669e-4db9-b338-b11738cda41b&page=queryresults
[0m22:46:02.003585 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d750a5c2-669e-4db9-b338-b11738cda41b&page=queryresults
[0m22:46:02.011314 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:45:59.629352 => 22:46:02.003585
[0m22:46:02.019761 [debug] [Thread-1  ]: Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  SELECT list expression references column cd_campo_customizado which is neither grouped nor aggregated at [38:10]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:46:02.019761 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1b19b359-a79f-4ead-adcd-7506cf2c9617', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F65A60E80>]}
[0m22:46:02.019761 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_campo_customizado_produto .. [[31mERROR[0m in 2.42s]
[0m22:46:02.024572 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:46:02.029412 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:46:02.029412 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:46:02.030419 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:46:02.032023 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:46:02.032023 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:46:02.032023 [info ] [MainThread]: 
[0m22:46:02.032023 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.74 seconds (4.74s).
[0m22:46:02.038259 [debug] [MainThread]: Command end result
[0m22:46:02.048709 [info ] [MainThread]: 
[0m22:46:02.049801 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:46:02.049801 [info ] [MainThread]: 
[0m22:46:02.050775 [error] [MainThread]:   Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  SELECT list expression references column cd_campo_customizado which is neither grouped nor aggregated at [38:10]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:46:02.051720 [info ] [MainThread]: 
[0m22:46:02.052115 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:46:02.052115 [debug] [MainThread]: Command `dbt run` failed at 22:46:02.052115 after 5.47 seconds
[0m22:46:02.052115 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F61F8D430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F65673B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019F65A88280>]}
[0m22:46:02.052115 [debug] [MainThread]: Flushing usage events
[0m22:46:17.076097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023478D2A3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023477CB02E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023477CB0760>]}


============================== 22:46:17.079110 | 08eed5b5-54ff-46e2-ace6-989f244059db ==============================
[0m22:46:17.079110 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:46:17.079110 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:46:17.426504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '08eed5b5-54ff-46e2-ace6-989f244059db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023477C9C0D0>]}
[0m22:46:17.490219 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '08eed5b5-54ff-46e2-ace6-989f244059db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002347C393850>]}
[0m22:46:17.490219 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:46:17.490219 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:46:17.593407 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:46:17.593407 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:46:17.687180 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '08eed5b5-54ff-46e2-ace6-989f244059db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002347C714700>]}
[0m22:46:17.692078 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '08eed5b5-54ff-46e2-ace6-989f244059db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002347C4EA040>]}
[0m22:46:17.692078 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:46:17.692078 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '08eed5b5-54ff-46e2-ace6-989f244059db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002347C65A790>]}
[0m22:46:17.692078 [info ] [MainThread]: 
[0m22:46:17.692078 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:46:17.692078 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:46:17.692078 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:46:18.381025 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:46:18.381025 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:46:18.381025 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:46:18.381025 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:46:19.066131 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m22:46:19.066131 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:46:19.713455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '08eed5b5-54ff-46e2-ace6-989f244059db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002347C31C340>]}
[0m22:46:19.713455 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:46:19.713455 [info ] [MainThread]: 
[0m22:46:19.727948 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:46:19.728963 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:46:19.731573 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:46:19.732945 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:46:19.752229 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:46:19.754234 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:46:19.733951 => 22:46:19.753233
[0m22:46:19.754234 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:46:19.777361 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:46:19.778466 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:46:19.779403 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,MAX(IF(cd_campo_customizado = '3435243', ds_valor_campo, NULL)) as ds_classificacao_produto
        ,MAX(IF(cd_campo_customizado = '3435246', ds_valor_campo, NULL)) as fg_ajuste_preco  
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

select *
from cte_campo_base;


[0m22:46:20.787043 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fa04f64c-dc62-420a-922e-88978b9c6fa6&page=queryresults
[0m22:46:21.205137 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:46:19.755243 => 22:46:21.205137
[0m22:46:21.205137 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '08eed5b5-54ff-46e2-ace6-989f244059db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002347C801D90>]}
[0m22:46:21.205137 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m22:46:21.221194 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:46:21.221194 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:46:21.221194 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:46:21.221194 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:46:21.221194 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:46:21.221194 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:46:21.221194 [info ] [MainThread]: 
[0m22:46:21.225163 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.53 seconds (3.53s).
[0m22:46:21.225163 [debug] [MainThread]: Command end result
[0m22:46:21.233909 [info ] [MainThread]: 
[0m22:46:21.233909 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:46:21.233909 [info ] [MainThread]: 
[0m22:46:21.233909 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:46:21.238504 [debug] [MainThread]: Command `dbt run` succeeded at 22:46:21.238504 after 4.23 seconds
[0m22:46:21.238504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023478D2A3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002347D82CF70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002347C65A790>]}
[0m22:46:21.239540 [debug] [MainThread]: Flushing usage events
[0m22:49:10.825601 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D254C12430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D253BB99D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D253BB9B80>]}


============================== 22:49:10.827649 | 69e59ca5-0100-4351-b6a7-7e447c2d4727 ==============================
[0m22:49:10.827649 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:49:10.828682 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:49:11.181067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '69e59ca5-0100-4351-b6a7-7e447c2d4727', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D253B9CA30>]}
[0m22:49:11.241730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '69e59ca5-0100-4351-b6a7-7e447c2d4727', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2581CB040>]}
[0m22:49:11.242735 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:49:11.248409 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:49:11.327536 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:49:11.328639 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:49:11.428341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '69e59ca5-0100-4351-b6a7-7e447c2d4727', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2585E7B20>]}
[0m22:49:11.437306 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '69e59ca5-0100-4351-b6a7-7e447c2d4727', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D258470FA0>]}
[0m22:49:11.437890 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:49:11.437890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '69e59ca5-0100-4351-b6a7-7e447c2d4727', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D258253D90>]}
[0m22:49:11.439021 [info ] [MainThread]: 
[0m22:49:11.440069 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:49:11.441099 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:49:11.442036 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:49:12.499356 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:49:12.500328 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:49:12.502253 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:49:12.503255 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:49:13.127823 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m22:49:13.129926 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:49:13.777389 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '69e59ca5-0100-4351-b6a7-7e447c2d4727', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2585E7B50>]}
[0m22:49:13.778389 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:49:13.779383 [info ] [MainThread]: 
[0m22:49:13.787393 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:49:13.787801 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:49:13.788809 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:49:13.789804 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:49:13.805470 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:49:13.808184 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:49:13.790813 => 22:49:13.807179
[0m22:49:13.809305 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:49:13.835351 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:49:13.837350 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:49:13.838359 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

select *
  from cte_campo_base;


[0m22:49:14.655891 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ffc9ddc2-a36d-434b-8508-c2de5eee1204&page=queryresults
[0m22:49:15.174071 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:49:13.809305 => 22:49:15.174071
[0m22:49:15.175069 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69e59ca5-0100-4351-b6a7-7e447c2d4727', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D258470E50>]}
[0m22:49:15.176063 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.39s]
[0m22:49:15.177064 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:49:15.178406 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:49:15.179405 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:49:15.179405 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:49:15.180423 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:49:15.180423 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:49:15.181406 [info ] [MainThread]: 
[0m22:49:15.182405 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.74 seconds (3.74s).
[0m22:49:15.182722 [debug] [MainThread]: Command end result
[0m22:49:15.190993 [info ] [MainThread]: 
[0m22:49:15.192986 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:49:15.193988 [info ] [MainThread]: 
[0m22:49:15.194989 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:49:15.195979 [debug] [MainThread]: Command `dbt run` succeeded at 22:49:15.195979 after 4.43 seconds
[0m22:49:15.195979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D254C12430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D2586FA940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D25851FAF0>]}
[0m22:49:15.196978 [debug] [MainThread]: Flushing usage events
[0m22:50:04.328917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E1EF11430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E1DEA49D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E1DEA4B80>]}


============================== 22:50:04.330932 | c2b2dc8e-7c89-4ef7-87bf-43ef6e8baa2a ==============================
[0m22:50:04.330932 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:50:04.331919 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'send_anonymous_usage_stats': 'True'}
[0m22:50:04.797771 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c2b2dc8e-7c89-4ef7-87bf-43ef6e8baa2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E2107BAC0>]}
[0m22:50:04.858296 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c2b2dc8e-7c89-4ef7-87bf-43ef6e8baa2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E225B66D0>]}
[0m22:50:04.859297 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:50:04.865297 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:50:04.956268 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:50:04.957272 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:50:05.050834 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c2b2dc8e-7c89-4ef7-87bf-43ef6e8baa2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E22998490>]}
[0m22:50:05.059312 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c2b2dc8e-7c89-4ef7-87bf-43ef6e8baa2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E2279B7F0>]}
[0m22:50:05.060313 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:50:05.060313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c2b2dc8e-7c89-4ef7-87bf-43ef6e8baa2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E2279B670>]}
[0m22:50:05.061311 [info ] [MainThread]: 
[0m22:50:05.062310 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:50:05.063238 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:50:05.064254 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:50:05.870125 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:50:05.872054 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:50:05.874040 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:50:05.876045 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:50:06.537685 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m22:50:06.538261 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:50:07.168088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c2b2dc8e-7c89-4ef7-87bf-43ef6e8baa2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E22616C40>]}
[0m22:50:07.171105 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:50:07.173115 [info ] [MainThread]: 
[0m22:50:07.186844 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:50:07.188566 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:50:07.192552 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:50:07.194561 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:50:07.226273 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:50:07.227885 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:50:07.195547 => 22:50:07.227885
[0m22:50:07.228896 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:50:07.264461 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:50:07.265460 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:50:07.267459 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,cast(dt_ajuste_preco as date) dt_ajuste_preco
   from cte_campo_base;


[0m22:50:08.085947 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:23a15041-e87b-48c4-9ac5-558dd6482cc4&page=queryresults
[0m22:50:08.515734 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:50:07.229896 => 22:50:08.515734
[0m22:50:08.516731 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2b2dc8e-7c89-4ef7-87bf-43ef6e8baa2a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E23A52970>]}
[0m22:50:08.517384 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m22:50:08.518462 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:50:08.520478 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:50:08.521456 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:50:08.521456 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:50:08.521456 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:50:08.521456 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:50:08.521456 [info ] [MainThread]: 
[0m22:50:08.522463 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.46 seconds (3.46s).
[0m22:50:08.523463 [debug] [MainThread]: Command end result
[0m22:50:08.535957 [info ] [MainThread]: 
[0m22:50:08.537919 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:50:08.538915 [info ] [MainThread]: 
[0m22:50:08.540962 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:50:08.542971 [debug] [MainThread]: Command `dbt run` succeeded at 22:50:08.542971 after 4.28 seconds
[0m22:50:08.542971 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E1EF11430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E229BE490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000017E2286A520>]}
[0m22:50:08.543963 [debug] [MainThread]: Flushing usage events
[0m22:50:31.768992 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216868113D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216857B42E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216857B4760>]}


============================== 22:50:31.771990 | e7ac5189-e977-4095-bd63-8bbb07948645 ==============================
[0m22:50:31.771990 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:50:31.771990 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m22:50:32.132853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e7ac5189-e977-4095-bd63-8bbb07948645', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002168579CA60>]}
[0m22:50:32.193740 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e7ac5189-e977-4095-bd63-8bbb07948645', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021689DCBCA0>]}
[0m22:50:32.194744 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:50:32.201188 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:50:32.312039 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:50:32.312039 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:50:32.404258 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e7ac5189-e977-4095-bd63-8bbb07948645', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002168A1C2B20>]}
[0m22:50:32.412890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e7ac5189-e977-4095-bd63-8bbb07948645', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002168A070280>]}
[0m22:50:32.412890 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:50:32.414004 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7ac5189-e977-4095-bd63-8bbb07948645', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021689F11970>]}
[0m22:50:32.414891 [info ] [MainThread]: 
[0m22:50:32.415896 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:50:32.417529 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:50:32.417529 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:50:33.086974 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:50:33.087612 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:50:33.089643 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:50:33.090636 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:50:33.748034 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m22:50:33.753403 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:50:34.646582 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e7ac5189-e977-4095-bd63-8bbb07948645', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021689EEE220>]}
[0m22:50:34.648568 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:50:34.650591 [info ] [MainThread]: 
[0m22:50:34.658982 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:50:34.661088 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:50:34.662977 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:50:34.663980 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:50:34.678977 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:50:34.680977 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:50:34.664981 => 22:50:34.679978
[0m22:50:34.680977 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:50:34.705780 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:50:34.706783 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:50:34.707351 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,dt_ajuste_preco
   from cte_campo_base;


[0m22:50:35.587905 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2d5d6a57-3f91-45dc-9551-d09d6d32111e&page=queryresults
[0m22:50:36.085005 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:50:34.681986 => 22:50:36.085005
[0m22:50:36.086005 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e7ac5189-e977-4095-bd63-8bbb07948645', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002168A2D6FD0>]}
[0m22:50:36.086005 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m22:50:36.087029 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:50:36.089284 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:50:36.089284 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:50:36.089284 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:50:36.089284 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:50:36.089284 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:50:36.090271 [info ] [MainThread]: 
[0m22:50:36.090680 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.67 seconds (3.67s).
[0m22:50:36.091116 [debug] [MainThread]: Command end result
[0m22:50:36.098569 [info ] [MainThread]: 
[0m22:50:36.098569 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:50:36.099567 [info ] [MainThread]: 
[0m22:50:36.100566 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:50:36.101568 [debug] [MainThread]: Command `dbt run` succeeded at 22:50:36.101568 after 4.39 seconds
[0m22:50:36.102567 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000216868113D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000021689E399A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002168A14E880>]}
[0m22:50:36.102567 [debug] [MainThread]: Flushing usage events
[0m22:51:35.367437 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282DD1B3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282DC14D9D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282DC14DB80>]}


============================== 22:51:35.370955 | 6a34ca80-9fbb-4d7a-81cf-549b6bb76384 ==============================
[0m22:51:35.370955 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:51:35.370955 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m22:51:35.771969 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6a34ca80-9fbb-4d7a-81cf-549b6bb76384', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282DF320AC0>]}
[0m22:51:35.839442 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6a34ca80-9fbb-4d7a-81cf-549b6bb76384', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282E08466D0>]}
[0m22:51:35.840461 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:51:35.847772 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:51:35.952464 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:51:35.953458 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:51:36.060680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6a34ca80-9fbb-4d7a-81cf-549b6bb76384', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282E0C28490>]}
[0m22:51:36.070124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6a34ca80-9fbb-4d7a-81cf-549b6bb76384', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282E0A2B7F0>]}
[0m22:51:36.071153 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:51:36.071666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6a34ca80-9fbb-4d7a-81cf-549b6bb76384', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282E0A2B670>]}
[0m22:51:36.072679 [info ] [MainThread]: 
[0m22:51:36.073672 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:51:36.074673 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:51:36.075698 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:51:36.892625 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:51:36.893628 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:51:36.930769 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:51:36.931726 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:51:37.569915 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m22:51:37.569915 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:51:38.221339 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6a34ca80-9fbb-4d7a-81cf-549b6bb76384', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282E07C35E0>]}
[0m22:51:38.223346 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:51:38.225337 [info ] [MainThread]: 
[0m22:51:38.237996 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:51:38.240005 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:51:38.243987 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:51:38.244994 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:51:38.271986 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:51:38.274985 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:51:38.246998 => 22:51:38.273987
[0m22:51:38.275980 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:51:38.303639 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:51:38.305640 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:51:38.307634 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,cast(repalce(dt_ajuste_preco, '/', '-') as date) dt_ajuste_preco
   from cte_campo_base;


[0m22:51:39.169850 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:355f00c4-41f9-493b-96ff-02615c01b206&page=queryresults
[0m22:51:39.532730 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Function not found: repalce; Did you mean replace? at [50:15]')
[0m22:51:40.390598 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9139e4b7-8e35-4aa5-8df1-69b20ed86b91&page=queryresults
[0m22:51:40.740170 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9139e4b7-8e35-4aa5-8df1-69b20ed86b91&page=queryresults
[0m22:51:40.743163 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:51:38.276979 => 22:51:40.742211
[0m22:51:40.749800 [debug] [Thread-1  ]: Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  Function not found: repalce; Did you mean replace? at [50:15]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:51:40.750797 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a34ca80-9fbb-4d7a-81cf-549b6bb76384', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282E0C4E6A0>]}
[0m22:51:40.752800 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model dbt_dw_stg.stg_campo_customizado_produto .. [[31mERROR[0m in 2.51s]
[0m22:51:40.754799 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:51:40.758808 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:51:40.759803 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:51:40.760855 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:51:40.761801 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:51:40.761801 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:51:40.762796 [info ] [MainThread]: 
[0m22:51:40.764806 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 4.69 seconds (4.69s).
[0m22:51:40.766797 [debug] [MainThread]: Command end result
[0m22:51:40.780409 [info ] [MainThread]: 
[0m22:51:40.781409 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:51:40.781409 [info ] [MainThread]: 
[0m22:51:40.783443 [error] [MainThread]:   Database Error in model stg_campo_customizado_produto (models\1.stg\stg_campo_customizado_produto.sql)
  Function not found: repalce; Did you mean replace? at [50:15]
  compiled Code at target\run\shibaribrasil\models\1.stg\stg_campo_customizado_produto.sql
[0m22:51:40.784423 [info ] [MainThread]: 
[0m22:51:40.784423 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:51:40.786423 [debug] [MainThread]: Command `dbt run` failed at 22:51:40.785424 after 5.48 seconds
[0m22:51:40.786423 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282DD1B3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282E08466D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000282E0AC0940>]}
[0m22:51:40.786876 [debug] [MainThread]: Flushing usage events
[0m22:51:50.736222 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E9E139460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E9D0C39A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E9D0C3D30>]}


============================== 22:51:50.738933 | ceaef6ae-fea4-4260-9eba-942967076913 ==============================
[0m22:51:50.738933 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:51:50.738933 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:51:51.082864 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ceaef6ae-fea4-4260-9eba-942967076913', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E9D0B5B20>]}
[0m22:51:51.144653 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ceaef6ae-fea4-4260-9eba-942967076913', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA1874250>]}
[0m22:51:51.145656 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:51:51.152246 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:51:51.251504 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:51:51.252528 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:51:51.347287 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ceaef6ae-fea4-4260-9eba-942967076913', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA1B37760>]}
[0m22:51:51.355297 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ceaef6ae-fea4-4260-9eba-942967076913', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA18C40D0>]}
[0m22:51:51.355297 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:51:51.356858 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ceaef6ae-fea4-4260-9eba-942967076913', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA1B28E20>]}
[0m22:51:51.356858 [info ] [MainThread]: 
[0m22:51:51.358145 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:51:51.359284 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:51:51.360300 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:51:52.190640 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:51:52.191635 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:51:52.228551 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m22:51:52.228551 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:51:52.829269 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m22:51:52.832339 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:51:53.457912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ceaef6ae-fea4-4260-9eba-942967076913', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA182E7F0>]}
[0m22:51:53.460028 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:51:53.460934 [info ] [MainThread]: 
[0m22:51:53.469835 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:51:53.470918 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:51:53.472861 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:51:53.473809 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:51:53.492878 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:51:53.494860 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:51:53.474806 => 22:51:53.494860
[0m22:51:53.495857 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:51:53.518098 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:51:53.518098 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:51:53.520217 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,cast(replace(dt_ajuste_preco, '/', '-') as date) dt_ajuste_preco
   from cte_campo_base;


[0m22:51:54.314046 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:39add8c0-86ee-494b-9ada-79394a5cfd95&page=queryresults
[0m22:51:54.745528 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:51:53.496871 => 22:51:54.744521
[0m22:51:54.746536 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ceaef6ae-fea4-4260-9eba-942967076913', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA1BE6C10>]}
[0m22:51:54.747102 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m22:51:54.748164 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:51:54.750157 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:51:54.750157 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:51:54.750157 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m22:51:54.751726 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:51:54.751726 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:51:54.751726 [info ] [MainThread]: 
[0m22:51:54.752803 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.39 seconds (3.39s).
[0m22:51:54.753850 [debug] [MainThread]: Command end result
[0m22:51:54.763751 [info ] [MainThread]: 
[0m22:51:54.764747 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:51:54.766801 [info ] [MainThread]: 
[0m22:51:54.767742 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:51:54.770811 [debug] [MainThread]: Command `dbt run` succeeded at 22:51:54.769782 after 4.09 seconds
[0m22:51:54.770811 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E9E139460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA1718130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA1A6A7F0>]}
[0m22:51:54.770811 [debug] [MainThread]: Flushing usage events
[0m22:52:08.769658 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D4129B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D402159A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D40215D30>]}


============================== 22:52:08.774672 | f009a406-3aa0-4127-8651-3e41e9549a8c ==============================
[0m22:52:08.774672 [info ] [MainThread]: Running with dbt=1.7.4
[0m22:52:08.775129 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --models stg_campo_customizado_produto', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m22:52:09.255984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f009a406-3aa0-4127-8651-3e41e9549a8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D433EBA90>]}
[0m22:52:09.366782 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f009a406-3aa0-4127-8651-3e41e9549a8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D449124F0>]}
[0m22:52:09.367798 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m22:52:09.376270 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m22:52:09.457356 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m22:52:09.458854 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_campo_customizado_produto.sql
[0m22:52:09.571303 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f009a406-3aa0-4127-8651-3e41e9549a8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D44CF6460>]}
[0m22:52:09.580029 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f009a406-3aa0-4127-8651-3e41e9549a8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D44AFB6D0>]}
[0m22:52:09.581031 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m22:52:09.582029 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f009a406-3aa0-4127-8651-3e41e9549a8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D44AFB670>]}
[0m22:52:09.582029 [info ] [MainThread]: 
[0m22:52:09.583026 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:52:09.585027 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m22:52:09.585027 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:52:10.220567 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m22:52:10.220567 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:52:10.222512 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m22:52:10.222512 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:52:10.841447 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m22:52:10.842448 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:52:11.512795 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f009a406-3aa0-4127-8651-3e41e9549a8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D4499BA30>]}
[0m22:52:11.513795 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m22:52:11.514809 [info ] [MainThread]: 
[0m22:52:11.518790 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:52:11.518790 [info ] [Thread-1  ]: 1 of 1 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m22:52:11.519790 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m22:52:11.519790 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m22:52:11.528793 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:52:11.529794 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 22:52:11.520796 => 22:52:11.529794
[0m22:52:11.530793 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m22:52:11.552340 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m22:52:11.553341 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m22:52:11.554340 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m22:52:12.341659 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2859b75b-c73c-4e1f-9163-b5f2234fed08&page=queryresults
[0m22:52:12.745383 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 22:52:11.530793 => 22:52:12.745383
[0m22:52:12.745383 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f009a406-3aa0-4127-8651-3e41e9549a8c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D44D7BA90>]}
[0m22:52:12.746383 [info ] [Thread-1  ]: 1 of 1 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m22:52:12.747347 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m22:52:12.748696 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:52:12.749831 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m22:52:12.749831 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m22:52:12.750824 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m22:52:12.750824 [debug] [MainThread]: Connection 'model.shibaribrasil.stg_campo_customizado_produto' was properly closed.
[0m22:52:12.750824 [info ] [MainThread]: 
[0m22:52:12.751825 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 3.17 seconds (3.17s).
[0m22:52:12.752735 [debug] [MainThread]: Command end result
[0m22:52:12.760123 [info ] [MainThread]: 
[0m22:52:12.761118 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:52:12.763131 [info ] [MainThread]: 
[0m22:52:12.765122 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:52:12.767149 [debug] [MainThread]: Command `dbt run` succeeded at 22:52:12.767149 after 4.06 seconds
[0m22:52:12.767149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D4129B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D44975310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019D44BCA4F0>]}
[0m22:52:12.767149 [debug] [MainThread]: Flushing usage events
[0m23:00:03.498819 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B08F233D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B07EA99D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B07EA9B80>]}


============================== 23:00:03.500942 | 17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e ==============================
[0m23:00:03.500942 [info ] [MainThread]: Running with dbt=1.7.4
[0m23:00:03.501943 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m23:00:03.843063 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0B06ABE0>]}
[0m23:00:03.901426 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C590A00>]}
[0m23:00:03.902435 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m23:00:03.908852 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m23:00:03.953775 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m23:00:03.954777 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m23:00:03.958514 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C82AEB0>]}
[0m23:00:03.966513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C6A29A0>]}
[0m23:00:03.966513 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m23:00:03.967102 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C6A20A0>]}
[0m23:00:03.968155 [info ] [MainThread]: 
[0m23:00:03.969362 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m23:00:03.970476 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m23:00:03.971367 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:03.992160 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m23:00:03.993118 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:04.816283 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:00:05.502102 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m23:00:05.503095 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:05.504571 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m23:00:05.505715 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m23:00:06.157865 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m23:00:06.158897 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m23:00:06.817221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C5DDEE0>]}
[0m23:00:06.818336 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m23:00:06.819285 [info ] [MainThread]: 
[0m23:00:06.827757 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m23:00:06.829773 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m23:00:06.828774 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m23:00:06.832786 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m23:00:06.833780 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m23:00:06.847090 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m23:00:06.830770 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m23:00:06.849102 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m23:00:06.850174 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m23:00:06.854199 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m23:00:06.856117 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 23:00:06.850174 => 23:00:06.855165
[0m23:00:06.857104 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m23:00:06.857729 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 23:00:06.834778 => 23:00:06.857104
[0m23:00:06.883587 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m23:00:06.884605 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m23:00:06.889827 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m23:00:06.890829 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m23:00:06.892726 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m23:00:06.911892 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m23:00:06.915415 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m23:00:07.950174 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d5c69572-4cec-4607-a6f8-054eb1639de6&page=queryresults
[0m23:00:07.952082 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ad9139d2-ce82-477c-8890-03e0e424dcd7&page=queryresults
[0m23:00:08.410061 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 23:00:06.857729 => 23:00:08.410061
[0m23:00:08.410985 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C5E27F0>]}
[0m23:00:08.414059 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 23:00:06.885075 => 23:00:08.414059
[0m23:00:08.414956 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C529760>]}
[0m23:00:08.411964 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.56s]
[0m23:00:08.415958 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m23:00:08.415958 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m23:00:08.414956 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.58s]
[0m23:00:08.417589 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m23:00:08.417589 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m23:00:08.415958 [info ] [Thread-2  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m23:00:08.418872 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m23:00:08.418872 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m23:00:08.421881 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m23:00:08.417589 [info ] [Thread-1  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m23:00:08.423887 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_produto)
[0m23:00:08.423887 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m23:00:08.428397 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m23:00:08.430358 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 23:00:08.418872 => 23:00:08.429353
[0m23:00:08.430358 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m23:00:08.433355 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m23:00:08.434355 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m23:00:08.435369 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m23:00:08.457521 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 23:00:08.424894 => 23:00:08.456800
[0m23:00:08.457521 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m23:00:08.459531 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m23:00:08.461533 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m23:00:08.462537 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m23:00:09.217880 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:99354433-855c-4c65-a2a1-84b0f1dc986e&page=queryresults
[0m23:00:09.262748 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:998e8d96-bd23-415b-8036-270b0957f11b&page=queryresults
[0m23:00:09.630128 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 23:00:08.430358 => 23:00:09.630128
[0m23:00:09.631113 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C82AF70>]}
[0m23:00:09.632734 [info ] [Thread-2  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m23:00:09.634857 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m23:00:09.640833 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 23:00:08.457521 => 23:00:09.640833
[0m23:00:09.642741 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0D997490>]}
[0m23:00:09.642741 [info ] [Thread-1  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m23:00:09.644376 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m23:00:09.646390 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m23:00:09.647390 [info ] [Thread-2  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m23:00:09.649119 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m23:00:09.649119 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m23:00:09.655121 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m23:00:09.657669 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 23:00:09.650077 => 23:00:09.657021
[0m23:00:09.657669 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m23:00:09.677289 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m23:00:10.340242 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m23:00:10.341245 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m23:00:10.943490 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7146ffcf-4e55-4840-8416-e722c14bed10&page=queryresults
[0m23:00:13.467463 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 23:00:09.668278 => 23:00:13.467463
[0m23:00:13.469582 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C6A2BE0>]}
[0m23:00:13.470578 [info ] [Thread-2  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 3.82s]
[0m23:00:13.472483 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m23:00:13.474493 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m23:00:13.475489 [info ] [Thread-1  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m23:00:13.478044 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m23:00:13.478044 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m23:00:13.485038 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m23:00:13.487533 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 23:00:13.479043 => 23:00:13.487050
[0m23:00:13.488540 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m23:00:13.492536 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m23:00:14.118488 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m23:00:14.120548 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m23:00:14.776939 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fe1d4e27-7cf7-4bc6-9fea-ea9ea3a9b53e&page=queryresults
[0m23:00:16.501393 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 23:00:13.488540 => 23:00:16.500394
[0m23:00:16.503398 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0D8D34F0>]}
[0m23:00:16.504399 [info ] [Thread-1  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.03s]
[0m23:00:16.505398 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m23:00:16.507791 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m23:00:16.507791 [info ] [Thread-2  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m23:00:16.509792 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m23:00:16.509792 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m23:00:16.514792 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m23:00:16.515789 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 23:00:16.509792 => 23:00:16.515789
[0m23:00:16.515789 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m23:00:16.518792 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m23:00:17.141235 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m23:00:17.143229 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m23:00:17.921848 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f7dc9fc2-1864-4f98-9e65-8a4a473dd500&page=queryresults
[0m23:00:19.935637 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 23:00:16.516791 => 23:00:19.935637
[0m23:00:19.937539 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '17e87ef2-02c3-4a19-b7ee-0e4abfa9ab0e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0D9C7D60>]}
[0m23:00:19.938539 [info ] [Thread-2  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.43s]
[0m23:00:19.938857 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m23:00:19.943113 [debug] [MainThread]: Connection 'master' was properly closed.
[0m23:00:19.943113 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m23:00:19.944113 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m23:00:19.945110 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m23:00:19.945110 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m23:00:19.945110 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m23:00:19.946110 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m23:00:19.947110 [info ] [MainThread]: 
[0m23:00:19.947809 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 15.98 seconds (15.98s).
[0m23:00:19.951039 [debug] [MainThread]: Command end result
[0m23:00:19.966474 [info ] [MainThread]: 
[0m23:00:19.967474 [info ] [MainThread]: [32mCompleted successfully[0m
[0m23:00:19.968539 [info ] [MainThread]: 
[0m23:00:19.970155 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m23:00:19.972170 [debug] [MainThread]: Command `dbt run` succeeded at 23:00:19.971170 after 16.53 seconds
[0m23:00:19.972170 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B08F233D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C652DF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019B0C5FD760>]}
[0m23:00:19.973168 [debug] [MainThread]: Flushing usage events
[0m00:00:04.451572 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3B4744C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3A4052E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3A405760>]}


============================== 00:00:04.451572 | 73a2c17d-0661-4ec0-9efc-0423716848fd ==============================
[0m00:00:04.451572 [info ] [MainThread]: Running with dbt=1.7.4
[0m00:00:04.451572 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m00:00:05.009009 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3BC712E0>]}
[0m00:00:05.104957 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EAE30D0>]}
[0m00:00:05.104957 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m00:00:05.120964 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m00:00:05.200366 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m00:00:05.200366 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m00:00:05.216224 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3ED9AAC0>]}
[0m00:00:05.231860 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EC4C730>]}
[0m00:00:05.231860 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m00:00:05.231860 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EC4C6D0>]}
[0m00:00:05.231860 [info ] [MainThread]: 
[0m00:00:05.231860 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m00:00:05.231860 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m00:00:05.231860 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:05.231860 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m00:00:05.231860 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:06.158150 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:00:07.065932 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m00:00:07.065932 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:07.067948 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m00:00:07.069968 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m00:00:07.819689 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m00:00:07.825935 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m00:00:08.554374 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EB57B80>]}
[0m00:00:08.554374 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m00:00:08.559415 [info ] [MainThread]: 
[0m00:00:08.559415 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m00:00:08.559415 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m00:00:08.559415 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m00:00:08.575384 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m00:00:08.575384 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m00:00:08.582477 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m00:00:08.582477 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m00:00:08.607131 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m00:00:08.613687 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m00:00:08.623187 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m00:00:08.629418 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 00:00:08.582477 => 00:00:08.626240
[0m00:00:08.629418 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 00:00:08.607131 => 00:00:08.629418
[0m00:00:08.631442 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m00:00:08.631442 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m00:00:08.723230 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m00:00:08.729490 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m00:00:08.733675 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m00:00:08.736368 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m00:00:08.739437 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m00:00:08.771778 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m00:00:09.675771 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:51a7812a-a24e-4b49-872f-a56a1f08240e&page=queryresults
[0m00:00:09.675771 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8a654d3d-e082-4bc8-b80b-65f6b2d8ce8a&page=queryresults
[0m00:00:10.356799 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 00:00:08.654846 => 00:00:10.356799
[0m00:00:10.360559 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 00:00:08.631442 => 00:00:10.358549
[0m00:00:10.360559 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3ED7DBB0>]}
[0m00:00:10.362572 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EB57B80>]}
[0m00:00:10.362572 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.78s]
[0m00:00:10.364578 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m00:00:10.362572 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.79s]
[0m00:00:10.364578 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m00:00:10.364578 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m00:00:10.366586 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m00:00:10.366586 [info ] [Thread-2  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m00:00:10.368592 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m00:00:10.366586 [info ] [Thread-1  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m00:00:10.368592 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m00:00:10.368592 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_produto)
[0m00:00:10.374702 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m00:00:10.374702 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m00:00:10.374702 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m00:00:10.374702 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 00:00:10.368592 => 00:00:10.374702
[0m00:00:10.374702 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 00:00:10.374702 => 00:00:10.374702
[0m00:00:10.374702 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m00:00:10.374702 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m00:00:10.374702 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m00:00:10.390700 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m00:00:10.390700 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:10.390700 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:10.390700 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m00:00:10.423113 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m00:00:11.187937 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:13ae62b1-9164-4e36-9662-2de6ba79ea0e&page=queryresults
[0m00:00:11.220128 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c4b50aac-1458-4181-a2cf-d6a1f2515d05&page=queryresults
[0m00:00:11.600731 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 00:00:10.374702 => 00:00:11.600731
[0m00:00:11.600731 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3ED7DAC0>]}
[0m00:00:11.600731 [info ] [Thread-2  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m00:00:11.600731 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m00:00:11.616485 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 00:00:10.374702 => 00:00:11.616485
[0m00:00:11.616485 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3FF16D90>]}
[0m00:00:11.632294 [info ] [Thread-1  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m00:00:11.632294 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m00:00:11.632294 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m00:00:11.632294 [info ] [Thread-2  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m00:00:11.632294 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m00:00:11.632294 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m00:00:11.648061 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m00:00:11.648061 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 00:00:11.632294 => 00:00:11.648061
[0m00:00:11.648061 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m00:00:11.695630 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:12.488313 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m00:00:12.488313 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m00:00:13.153870 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4a740f93-3c35-4587-9f20-8a91ea72f7e2&page=queryresults
[0m00:00:16.274571 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 00:00:11.648061 => 00:00:16.274571
[0m00:00:16.276200 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EE28CA0>]}
[0m00:00:16.278317 [info ] [Thread-2  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.64s]
[0m00:00:16.280216 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m00:00:16.281250 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m00:00:16.282319 [info ] [Thread-1  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m00:00:16.283254 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m00:00:16.284301 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m00:00:16.289213 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m00:00:16.290208 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 00:00:16.284301 => 00:00:16.290208
[0m00:00:16.291213 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m00:00:16.291213 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m00:00:17.055600 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m00:00:17.055600 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m00:00:17.765097 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3dfbf0d8-901d-4865-9df8-12cc7e244264&page=queryresults
[0m00:00:21.117761 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 00:00:16.291213 => 00:00:21.117761
[0m00:00:21.117761 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EE28CA0>]}
[0m00:00:21.117761 [info ] [Thread-1  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 4.83s]
[0m00:00:21.132297 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m00:00:21.133861 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m00:00:21.133861 [info ] [Thread-2  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m00:00:21.133861 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m00:00:21.133861 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m00:00:21.149648 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m00:00:21.149648 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 00:00:21.133861 => 00:00:21.149648
[0m00:00:21.149648 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m00:00:21.149648 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m00:00:21.795760 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m00:00:21.795760 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m00:00:22.445656 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5792cd02-6460-4349-bb31-75c49f5d1b2c&page=queryresults
[0m00:00:24.367431 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 00:00:21.149648 => 00:00:24.366451
[0m00:00:24.369705 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '73a2c17d-0661-4ec0-9efc-0423716848fd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EDEB430>]}
[0m00:00:24.371718 [info ] [Thread-2  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.23s]
[0m00:00:24.373721 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m00:00:24.373721 [debug] [MainThread]: Connection 'master' was properly closed.
[0m00:00:24.373721 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m00:00:24.384330 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m00:00:24.386350 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m00:00:24.386931 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m00:00:24.387820 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m00:00:24.387820 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m00:00:24.387820 [info ] [MainThread]: 
[0m00:00:24.389584 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 19.16 seconds (19.16s).
[0m00:00:24.391602 [debug] [MainThread]: Command end result
[0m00:00:24.417801 [info ] [MainThread]: 
[0m00:00:24.417801 [info ] [MainThread]: [32mCompleted successfully[0m
[0m00:00:24.421278 [info ] [MainThread]: 
[0m00:00:24.421278 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m00:00:24.421278 [debug] [MainThread]: Command `dbt run` succeeded at 00:00:24.421278 after 20.04 seconds
[0m00:00:24.421278 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3B4744C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EB85880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025C3EBC6C70>]}
[0m00:00:24.424653 [debug] [MainThread]: Flushing usage events
[0m01:00:17.268853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D437363430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4362E9640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4362E9AC0>]}


============================== 01:00:17.284658 | a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b ==============================
[0m01:00:17.284658 [info ] [MainThread]: Running with dbt=1.7.4
[0m01:00:17.284658 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m01:00:18.541650 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4362E9850>]}
[0m01:00:18.605586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4394AAA60>]}
[0m01:00:18.605586 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m01:00:18.637750 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m01:00:22.042262 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m01:00:22.042262 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m01:00:22.042262 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43AC6A880>]}
[0m01:00:22.122125 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43AB18550>]}
[0m01:00:22.122125 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m01:00:22.122125 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43AB183D0>]}
[0m01:00:22.122125 [info ] [MainThread]: 
[0m01:00:22.130020 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m01:00:22.130020 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m01:00:22.130020 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:00:22.130020 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m01:00:22.130020 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:00:23.056713 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:00:23.828521 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m01:00:23.828521 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:00:23.828521 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m01:00:23.828521 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m01:00:24.549185 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m01:00:24.549185 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m01:00:25.293196 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43AC4EAF0>]}
[0m01:00:25.295141 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m01:00:25.297228 [info ] [MainThread]: 
[0m01:00:25.298193 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m01:00:25.298193 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m01:00:25.298193 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m01:00:25.298193 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m01:00:25.298193 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m01:00:25.298193 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m01:00:25.313970 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m01:00:25.313970 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m01:00:25.329923 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m01:00:25.329923 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m01:00:25.329923 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 01:00:25.313970 => 01:00:25.329923
[0m01:00:25.329923 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 01:00:25.329923 => 01:00:25.329923
[0m01:00:25.329923 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m01:00:25.329923 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m01:00:25.383835 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m01:00:25.383835 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m01:00:25.383835 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m01:00:25.393597 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m01:00:25.417682 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m01:00:25.421015 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m01:00:26.345801 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8f36d212-ef1c-407d-af0f-2c536a9cb92d&page=queryresults
[0m01:00:26.345801 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3fdbdcdc-7597-4292-bf3f-2f886b39b242&page=queryresults
[0m01:00:26.808003 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 01:00:25.329923 => 01:00:26.808003
[0m01:00:26.808003 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43AC4EAF0>]}
[0m01:00:26.808003 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.51s]
[0m01:00:26.808003 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m01:00:26.808003 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m01:00:26.808003 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m01:00:26.808003 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m01:00:26.808003 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m01:00:26.824029 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m01:00:26.824029 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 01:00:26.808003 => 01:00:26.824029
[0m01:00:26.824029 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m01:00:26.824029 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m01:00:26.824029 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:00:26.840030 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m01:00:26.871624 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 01:00:25.377749 => 01:00:26.871624
[0m01:00:26.871624 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43ACF87F0>]}
[0m01:00:26.871624 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.57s]
[0m01:00:26.871624 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m01:00:26.871624 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m01:00:26.871624 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m01:00:26.879940 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m01:00:26.879940 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m01:00:26.879940 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m01:00:26.879940 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 01:00:26.879940 => 01:00:26.879940
[0m01:00:26.879940 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m01:00:26.879940 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m01:00:26.887829 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:00:26.887829 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m01:00:27.765239 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cf24500f-dc7e-4f88-b3a4-e6da1300aad5&page=queryresults
[0m01:00:27.813944 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b32a8ef5-0cf0-405b-a8a7-b547719a0d76&page=queryresults
[0m01:00:28.214582 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 01:00:26.824029 => 01:00:28.214582
[0m01:00:28.214582 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43ACEBE80>]}
[0m01:00:28.214582 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.41s]
[0m01:00:28.230440 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m01:00:28.284243 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 01:00:26.879940 => 01:00:28.284243
[0m01:00:28.284243 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43ACF7160>]}
[0m01:00:28.284243 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m01:00:28.284243 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m01:00:28.284243 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m01:00:28.284243 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m01:00:28.284243 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m01:00:28.284243 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m01:00:28.294891 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m01:00:28.294891 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 01:00:28.294891 => 01:00:28.294891
[0m01:00:28.294891 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m01:00:28.310794 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:00:29.017175 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m01:00:29.017175 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m01:00:29.709064 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:96922049-727c-4aa0-9f64-6f32895e75d8&page=queryresults
[0m01:00:32.320739 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 01:00:28.294891 => 01:00:32.320739
[0m01:00:32.320739 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43BDC19A0>]}
[0m01:00:32.320739 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.04s]
[0m01:00:32.336687 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m01:00:32.336687 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m01:00:32.336687 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m01:00:32.336687 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m01:00:32.336687 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m01:00:32.336687 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m01:00:32.336687 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 01:00:32.336687 => 01:00:32.336687
[0m01:00:32.336687 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m01:00:32.352691 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m01:00:33.279210 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m01:00:33.281223 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m01:00:33.959045 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6055bb5b-dff5-4349-8da1-6095259de3df&page=queryresults
[0m01:00:36.966873 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 01:00:32.352691 => 01:00:36.964855
[0m01:00:36.966873 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43BDC19A0>]}
[0m01:00:36.968887 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 4.63s]
[0m01:00:36.970897 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m01:00:36.970897 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m01:00:36.972910 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m01:00:36.972910 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m01:00:36.974923 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m01:00:36.974923 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m01:00:36.974923 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 01:00:36.974923 => 01:00:36.974923
[0m01:00:36.974923 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m01:00:36.987712 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m01:00:37.627553 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m01:00:37.630110 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m01:00:38.287699 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bbc7b581-7ea1-4954-b77b-e34dd37fb1e0&page=queryresults
[0m01:00:40.446590 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 01:00:36.985075 => 01:00:40.446590
[0m01:00:40.448606 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a4d9731f-8e50-4c24-ba26-0f8ab1f5ca4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43AD0DD30>]}
[0m01:00:40.450620 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.48s]
[0m01:00:40.452171 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m01:00:40.454185 [debug] [MainThread]: Connection 'master' was properly closed.
[0m01:00:40.456263 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m01:00:40.456263 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m01:00:40.456263 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m01:00:40.456263 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m01:00:40.458276 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m01:00:40.458276 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m01:00:40.458276 [info ] [MainThread]: 
[0m01:00:40.458276 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 18.34 seconds (18.34s).
[0m01:00:40.462829 [debug] [MainThread]: Command end result
[0m01:00:40.490091 [info ] [MainThread]: 
[0m01:00:40.493351 [info ] [MainThread]: [32mCompleted successfully[0m
[0m01:00:40.493351 [info ] [MainThread]: 
[0m01:00:40.498251 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m01:00:40.501614 [debug] [MainThread]: Command `dbt run` succeeded at 01:00:40.498251 after 23.40 seconds
[0m01:00:40.501614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D437363430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D4394AAA60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D43AA03130>]}
[0m01:00:40.501614 [debug] [MainThread]: Flushing usage events
[0m02:00:06.321477 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296461C2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964512F9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964512FD30>]}


============================== 02:00:06.337186 | 0935b514-dc7b-4a46-903e-a2e09dfac3b0 ==============================
[0m02:00:06.337186 [info ] [MainThread]: Running with dbt=1.7.4
[0m02:00:06.337186 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m02:00:07.386901 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964830CAC0>]}
[0m02:00:07.482311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296498316D0>]}
[0m02:00:07.482311 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m02:00:07.498334 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m02:00:07.623583 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m02:00:07.623583 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m02:00:07.633139 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029649ACAB20>]}
[0m02:00:07.650188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296499FD790>]}
[0m02:00:07.650188 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m02:00:07.650188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296499FD730>]}
[0m02:00:07.656975 [info ] [MainThread]: 
[0m02:00:07.656975 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m02:00:07.656975 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m02:00:07.656975 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:07.656975 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m02:00:07.656975 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:08.551298 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:09.208480 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m02:00:09.208480 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:09.208480 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m02:00:09.208480 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m02:00:10.081185 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m02:00:10.092204 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m02:00:11.000252 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964989E370>]}
[0m02:00:11.015949 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m02:00:11.015949 [info ] [MainThread]: 
[0m02:00:11.024383 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:11.024383 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m02:00:11.024383 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m02:00:11.032020 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m02:00:11.032020 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:11.036415 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m02:00:11.036415 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m02:00:11.047988 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m02:00:11.047988 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m02:00:11.047988 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m02:00:11.047988 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 02:00:11.032020 => 02:00:11.047988
[0m02:00:11.047988 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:11.095769 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 02:00:11.047988 => 02:00:11.095769
[0m02:00:11.095769 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m02:00:11.095769 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m02:00:11.095769 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m02:00:11.111522 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m02:00:11.111522 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m02:00:11.111522 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m02:00:11.143521 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m02:00:12.026034 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cdccdbf2-bce2-46a7-b0ed-dda539676917&page=queryresults
[0m02:00:12.026034 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:547808b3-4277-4dce-8585-03453fa69b8c&page=queryresults
[0m02:00:12.492027 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 02:00:11.047988 => 02:00:12.492027
[0m02:00:12.492027 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964989E370>]}
[0m02:00:12.492027 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 02:00:11.095769 => 02:00:12.492027
[0m02:00:12.492027 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m02:00:12.507780 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296497B5C10>]}
[0m02:00:12.507780 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m02:00:12.507780 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m02:00:12.507780 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m02:00:12.507780 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m02:00:12.507780 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m02:00:12.507780 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m02:00:12.507780 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m02:00:12.507780 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m02:00:12.507780 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m02:00:12.507780 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m02:00:12.507780 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m02:00:12.507780 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m02:00:12.507780 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m02:00:12.523459 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 02:00:12.507780 => 02:00:12.523459
[0m02:00:12.523459 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m02:00:12.523459 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m02:00:12.523459 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:12.523459 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 02:00:12.507780 => 02:00:12.523459
[0m02:00:12.523459 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m02:00:12.535490 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m02:00:12.539299 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m02:00:12.571837 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:12.571837 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m02:00:13.345206 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:38bb79d0-b082-4d95-b62d-d645d0e2b832&page=queryresults
[0m02:00:13.425864 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3f73721d-39a5-40e4-833f-58b39a76d8bf&page=queryresults
[0m02:00:13.822488 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 02:00:12.523459 => 02:00:13.822488
[0m02:00:13.824502 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029649AD4040>]}
[0m02:00:13.826515 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m02:00:13.826515 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m02:00:13.908845 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 02:00:12.523459 => 02:00:13.908845
[0m02:00:13.910858 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000029649AAED30>]}
[0m02:00:13.910858 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m02:00:13.910858 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m02:00:13.910858 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m02:00:13.910858 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m02:00:13.910858 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m02:00:13.910858 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m02:00:13.923038 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m02:00:13.925049 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 02:00:13.910858 => 02:00:13.925049
[0m02:00:13.927059 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m02:00:13.955036 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:14.725531 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m02:00:14.735654 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m02:00:15.618634 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ef648071-530e-48b8-8792-21c6a066392b&page=queryresults
[0m02:00:18.245435 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 02:00:13.927059 => 02:00:18.243426
[0m02:00:18.245435 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964AC25DC0>]}
[0m02:00:18.245435 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.33s]
[0m02:00:18.245435 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m02:00:18.245435 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m02:00:18.245435 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m02:00:18.249914 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m02:00:18.252423 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m02:00:18.258470 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m02:00:18.258470 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 02:00:18.252423 => 02:00:18.258470
[0m02:00:18.258470 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m02:00:18.265812 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m02:00:18.905844 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m02:00:18.907860 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m02:00:19.594331 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5c5f1efa-6d0d-4d14-bbc5-7af0c0585a7c&page=queryresults
[0m02:00:21.887754 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 02:00:18.258470 => 02:00:21.887754
[0m02:00:21.889767 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964AB88400>]}
[0m02:00:21.889767 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.64s]
[0m02:00:21.891782 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m02:00:21.893794 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m02:00:21.893794 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m02:00:21.895807 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m02:00:21.895807 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m02:00:21.901843 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m02:00:21.904865 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 02:00:21.895807 => 02:00:21.902853
[0m02:00:21.904865 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m02:00:21.908893 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m02:00:22.838031 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m02:00:22.840048 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m02:00:23.495669 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:651311a0-97b9-4154-8d57-a5e47d585b23&page=queryresults
[0m02:00:25.861068 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 02:00:21.904865 => 02:00:25.861068
[0m02:00:25.863080 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0935b514-dc7b-4a46-903e-a2e09dfac3b0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964AB88400>]}
[0m02:00:25.864979 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.97s]
[0m02:00:25.864979 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m02:00:25.867528 [debug] [MainThread]: Connection 'master' was properly closed.
[0m02:00:25.870112 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m02:00:25.870112 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m02:00:25.870112 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m02:00:25.870112 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m02:00:25.872124 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m02:00:25.872124 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m02:00:25.872124 [info ] [MainThread]: 
[0m02:00:25.872124 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 18.22 seconds (18.22s).
[0m02:00:25.874135 [debug] [MainThread]: Command end result
[0m02:00:25.895816 [info ] [MainThread]: 
[0m02:00:25.902639 [info ] [MainThread]: [32mCompleted successfully[0m
[0m02:00:25.902639 [info ] [MainThread]: 
[0m02:00:25.902639 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m02:00:25.902639 [debug] [MainThread]: Command `dbt run` succeeded at 02:00:25.902639 after 19.72 seconds
[0m02:00:25.907551 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296461C2430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000296498316D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002964988D4C0>]}
[0m02:00:25.907551 [debug] [MainThread]: Flushing usage events
[0m03:00:05.338831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2AD6F3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2AC67A6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2AC67AE20>]}


============================== 03:00:05.354594 | 161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82 ==============================
[0m03:00:05.354594 [info ] [MainThread]: Running with dbt=1.7.4
[0m03:00:05.354594 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m03:00:06.371720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2AC66B220>]}
[0m03:00:06.435416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0D60A60>]}
[0m03:00:06.451386 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m03:00:06.451386 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m03:00:06.499400 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m03:00:06.499400 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m03:00:06.499400 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0FFAF10>]}
[0m03:00:06.515181 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0F2EE80>]}
[0m03:00:06.515181 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m03:00:06.515181 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0DDD310>]}
[0m03:00:06.516830 [info ] [MainThread]: 
[0m03:00:06.516830 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m03:00:06.516830 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:00:06.516830 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:00:06.516830 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:06.516830 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:07.522835 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:08.202568 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m03:00:08.207159 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:08.207159 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m03:00:08.207159 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:08.913022 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m03:00:08.913022 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:09.632051 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0FDDDF0>]}
[0m03:00:09.632051 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m03:00:09.632051 [info ] [MainThread]: 
[0m03:00:09.646304 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:09.646304 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m03:00:09.646304 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m03:00:09.646304 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m03:00:09.646304 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:09.646304 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m03:00:09.662453 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m03:00:09.662453 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m03:00:09.662453 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m03:00:09.678162 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m03:00:09.678162 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 03:00:09.646304 => 03:00:09.678162
[0m03:00:09.678162 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:09.709879 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 03:00:09.662453 => 03:00:09.709879
[0m03:00:09.725800 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m03:00:09.732279 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m03:00:09.749028 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m03:00:09.751039 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m03:00:09.755059 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m03:00:09.806022 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m03:00:09.806022 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m03:00:10.755539 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e3e6359d-5b0b-4641-bb4e-fb4b1722a557&page=queryresults
[0m03:00:11.271321 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 03:00:09.725800 => 03:00:11.271321
[0m03:00:11.271321 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:83266c30-d991-46a6-a450-062e6c5b38d5&page=queryresults
[0m03:00:11.271321 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0DB7BB0>]}
[0m03:00:11.271321 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.61s]
[0m03:00:11.287161 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m03:00:11.287161 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m03:00:11.287161 [info ] [Thread-2  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m03:00:11.287161 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m03:00:11.287161 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m03:00:11.295568 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m03:00:11.295568 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 03:00:11.291537 => 03:00:11.295568
[0m03:00:11.295568 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m03:00:11.302996 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m03:00:11.302996 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:11.302996 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m03:00:11.864876 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 03:00:09.683844 => 03:00:11.864876
[0m03:00:11.864876 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B108C610>]}
[0m03:00:11.864876 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 2.22s]
[0m03:00:11.864876 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m03:00:11.864876 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m03:00:11.864876 [info ] [Thread-1  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m03:00:11.864876 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_produto)
[0m03:00:11.864876 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m03:00:11.880680 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m03:00:11.880680 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 03:00:11.864876 => 03:00:11.880680
[0m03:00:11.880680 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m03:00:11.880680 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m03:00:11.880680 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:11.880680 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m03:00:12.275015 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:330b7f85-6486-4881-ae10-e319cde19e55&page=queryresults
[0m03:00:12.706880 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:46148dfd-456f-4cf0-9a4b-5f4927f64562&page=queryresults
[0m03:00:13.021136 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 03:00:11.295568 => 03:00:13.021136
[0m03:00:13.021136 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0F2EE20>]}
[0m03:00:13.023149 [info ] [Thread-2  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.73s]
[0m03:00:13.023149 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m03:00:13.285380 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 03:00:11.880680 => 03:00:13.285380
[0m03:00:13.287492 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B108C610>]}
[0m03:00:13.289506 [info ] [Thread-1  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m03:00:13.289506 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m03:00:13.291518 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m03:00:13.291518 [info ] [Thread-2  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m03:00:13.291518 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m03:00:13.291518 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m03:00:13.291518 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m03:00:13.291518 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 03:00:13.291518 => 03:00:13.291518
[0m03:00:13.303601 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m03:00:13.319720 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:14.056177 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m03:00:14.071210 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m03:00:14.732206 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:76e5e3e5-6a41-4eaa-a146-ff14c387c9ff&page=queryresults
[0m03:00:17.432635 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 03:00:13.303601 => 03:00:17.430615
[0m03:00:17.432635 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B21561C0>]}
[0m03:00:17.434651 [info ] [Thread-2  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.14s]
[0m03:00:17.437472 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m03:00:17.439213 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m03:00:17.441225 [info ] [Thread-1  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m03:00:17.441225 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m03:00:17.443237 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m03:00:17.447150 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m03:00:17.449250 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 03:00:17.443237 => 03:00:17.449250
[0m03:00:17.450245 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m03:00:17.453249 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:18.167927 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m03:00:18.169944 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m03:00:18.850999 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:679742c3-10bf-43bb-b062-75771f7b37c5&page=queryresults
[0m03:00:20.996130 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 03:00:17.450245 => 03:00:20.996130
[0m03:00:21.005687 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B2169BB0>]}
[0m03:00:21.005687 [info ] [Thread-1  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.56s]
[0m03:00:21.005687 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m03:00:21.005687 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m03:00:21.005687 [info ] [Thread-2  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m03:00:21.005687 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m03:00:21.005687 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m03:00:21.005687 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m03:00:21.005687 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 03:00:21.005687 => 03:00:21.005687
[0m03:00:21.005687 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m03:00:21.021676 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:21.674833 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m03:00:21.674833 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m03:00:22.333618 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8fc0a989-0255-4267-b5eb-df5cc03a2743&page=queryresults
[0m03:00:24.583758 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 03:00:21.005687 => 03:00:24.583758
[0m03:00:24.585772 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '161f14ab-c8e3-4bc4-a0c3-a23c7c93aa82', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B2130940>]}
[0m03:00:24.587284 [info ] [Thread-2  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.58s]
[0m03:00:24.587284 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m03:00:24.589933 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:00:24.592507 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:00:24.592507 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:00:24.592507 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m03:00:24.592507 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m03:00:24.592507 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m03:00:24.594518 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m03:00:24.594518 [info ] [MainThread]: 
[0m03:00:24.594518 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 18.08 seconds (18.08s).
[0m03:00:24.596530 [debug] [MainThread]: Command end result
[0m03:00:24.620920 [info ] [MainThread]: 
[0m03:00:24.620920 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:00:24.620920 [info ] [MainThread]: 
[0m03:00:24.620920 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m03:00:24.620920 [debug] [MainThread]: Command `dbt run` succeeded at 03:00:24.620920 after 19.35 seconds
[0m03:00:24.627691 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2AD6F3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0D60A60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F2B0FDDEE0>]}
[0m03:00:24.627691 [debug] [MainThread]: Flushing usage events
[0m04:00:18.096706 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5E8C073D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5E7B979D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5E7B97B80>]}


============================== 04:00:18.106563 | d5362b1f-df74-446a-8560-fc79905b4ac7 ==============================
[0m04:00:18.106563 [info ] [MainThread]: Running with dbt=1.7.4
[0m04:00:18.108541 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m04:00:20.238797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5E7B87FD0>]}
[0m04:00:20.374371 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC280B20>]}
[0m04:00:20.376487 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m04:00:20.419241 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m04:00:23.775999 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:00:23.776995 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m04:00:23.782570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC51AE20>]}
[0m04:00:23.830485 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC506970>]}
[0m04:00:23.831581 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m04:00:23.832583 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC506910>]}
[0m04:00:23.836578 [info ] [MainThread]: 
[0m04:00:23.838576 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m04:00:23.844190 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:23.845190 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:23.847297 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:23.849284 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:25.119894 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:25.852938 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m04:00:25.854041 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:25.856037 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m04:00:25.856939 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:26.555983 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m04:00:26.558971 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:27.254451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC51AFA0>]}
[0m04:00:27.255554 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m04:00:27.256548 [info ] [MainThread]: 
[0m04:00:27.276750 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:27.277714 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m04:00:27.279756 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m04:00:27.282573 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m04:00:27.283709 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:27.280715 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m04:00:27.298714 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m04:00:27.299739 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m04:00:27.301754 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m04:00:27.307597 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m04:00:27.309607 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 04:00:27.284654 => 04:00:27.309607
[0m04:00:27.310597 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:27.351362 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 04:00:27.302463 => 04:00:27.351362
[0m04:00:27.367420 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m04:00:27.370475 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m04:00:27.383996 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m04:00:27.384997 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m04:00:27.389014 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m04:00:27.427665 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m04:00:27.429735 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m04:00:28.278584 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2cc63fc2-e882-4802-94a7-7863345d629b&page=queryresults
[0m04:00:28.289395 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c8a9996e-6ce7-4970-a653-659d32601652&page=queryresults
[0m04:00:28.741655 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 04:00:27.370475 => 04:00:28.740693
[0m04:00:28.743499 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC5A40A0>]}
[0m04:00:28.752412 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 04:00:27.311596 => 04:00:28.751504
[0m04:00:28.745505 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m04:00:28.755500 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC194A00>]}
[0m04:00:28.758508 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m04:00:28.761501 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m04:00:28.759522 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m04:00:28.763451 [info ] [Thread-2  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m04:00:28.766416 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:28.768416 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m04:00:28.769428 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m04:00:28.771412 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m04:00:28.782243 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m04:00:28.772410 [info ] [Thread-1  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m04:00:28.785266 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_produto)
[0m04:00:28.787257 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m04:00:28.797359 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m04:00:28.798353 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 04:00:28.773330 => 04:00:28.798353
[0m04:00:28.799358 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m04:00:28.807017 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m04:00:28.809021 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 04:00:28.788255 => 04:00:28.809021
[0m04:00:28.811021 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m04:00:28.819026 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m04:00:28.820027 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:28.821459 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m04:00:28.865618 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:28.869558 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m04:00:29.598358 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:867ecf6a-61a8-45d0-a6db-59afdc277f14&page=queryresults
[0m04:00:29.691268 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bb559296-87d2-4048-97b6-91f4db48d6be&page=queryresults
[0m04:00:30.094612 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 04:00:28.812020 => 04:00:30.093612
[0m04:00:30.095613 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC5BDF10>]}
[0m04:00:30.097713 [info ] [Thread-1  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m04:00:30.098711 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m04:00:30.100396 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m04:00:30.101411 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m04:00:30.103251 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m04:00:30.105340 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m04:00:30.123230 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m04:00:30.126234 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 04:00:30.105340 => 04:00:30.125231
[0m04:00:30.128238 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m04:00:30.134185 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 04:00:28.800347 => 04:00:30.133183
[0m04:00:30.163064 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5ED5E4FA0>]}
[0m04:00:30.165021 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:30.167115 [info ] [Thread-2  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.39s]
[0m04:00:30.170081 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m04:00:31.196499 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m04:00:31.197506 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m04:00:31.836122 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b6d59958-d100-49e2-afbd-e59aaf83c445&page=queryresults
[0m04:00:34.389870 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 04:00:30.135175 => 04:00:34.389870
[0m04:00:34.390871 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5ED673B50>]}
[0m04:00:34.391874 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.29s]
[0m04:00:34.391874 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m04:00:34.393888 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m04:00:34.394769 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m04:00:34.396860 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.tb_produto)
[0m04:00:34.397861 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m04:00:34.404462 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m04:00:34.406552 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 04:00:34.398860 => 04:00:34.405562
[0m04:00:34.407558 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m04:00:34.411558 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:35.078513 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m04:00:35.080513 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m04:00:35.712912 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8eba6258-e4c9-4e0e-8c78-84563bb10c8c&page=queryresults
[0m04:00:37.635725 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 04:00:34.407558 => 04:00:37.635725
[0m04:00:37.637713 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC5C1340>]}
[0m04:00:37.638705 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.24s]
[0m04:00:37.639613 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m04:00:37.640612 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m04:00:37.641612 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m04:00:37.642826 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m04:00:37.642826 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m04:00:37.647916 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m04:00:37.649826 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 04:00:37.643825 => 04:00:37.648925
[0m04:00:37.649826 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m04:00:37.653824 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:38.276505 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m04:00:38.279504 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m04:00:38.999790 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:aef3ba05-d612-461f-8578-151de5eda99b&page=queryresults
[0m04:00:41.238051 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 04:00:37.650825 => 04:00:41.237052
[0m04:00:41.241056 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd5362b1f-df74-446a-8560-fc79905b4ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC194A00>]}
[0m04:00:41.242678 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.60s]
[0m04:00:41.246672 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m04:00:41.252669 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:00:41.254670 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:00:41.255672 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:00:41.256674 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m04:00:41.257673 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m04:00:41.258672 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m04:00:41.258672 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m04:00:41.259672 [info ] [MainThread]: 
[0m04:00:41.262596 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 17.42 seconds (17.42s).
[0m04:00:41.269716 [debug] [MainThread]: Command end result
[0m04:00:41.298384 [info ] [MainThread]: 
[0m04:00:41.300474 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:00:41.302182 [info ] [MainThread]: 
[0m04:00:41.303313 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m04:00:41.306305 [debug] [MainThread]: Command `dbt run` succeeded at 04:00:41.306305 after 23.37 seconds
[0m04:00:41.308291 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5E8C073D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5EC1FB070>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B5E7B97BE0>]}
[0m04:00:41.308291 [debug] [MainThread]: Flushing usage events
[0m05:00:05.159770 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BADE34C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B9D6C2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212B9D6C760>]}


============================== 05:00:05.166106 | 4afc72d3-45a4-4033-aedb-30ddee6eef4c ==============================
[0m05:00:05.166106 [info ] [MainThread]: Running with dbt=1.7.4
[0m05:00:05.167072 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m05:00:05.981576 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE3AB8B0>]}
[0m05:00:06.039709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE338A30>]}
[0m05:00:06.041718 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m05:00:06.047425 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m05:00:06.092829 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:00:06.093831 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:00:06.096831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE6ED0D0>]}
[0m05:00:06.104673 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE562EE0>]}
[0m05:00:06.105674 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m05:00:06.105674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE3605B0>]}
[0m05:00:06.107779 [info ] [MainThread]: 
[0m05:00:06.108783 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m05:00:06.111772 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:06.112671 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:06.112671 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:06.112671 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:07.120801 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:07.790101 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m05:00:07.791111 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:07.793117 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m05:00:07.795106 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:08.470981 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m05:00:08.473956 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:09.105594 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE4AB970>]}
[0m05:00:09.107600 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m05:00:09.109598 [info ] [MainThread]: 
[0m05:00:09.116600 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:09.117601 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m05:00:09.118600 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m05:00:09.120610 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m05:00:09.121595 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:09.131136 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m05:00:09.119610 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m05:00:09.133139 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m05:00:09.133139 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m05:00:09.137140 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m05:00:09.140145 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 05:00:09.122040 => 05:00:09.139152
[0m05:00:09.140145 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:09.141148 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 05:00:09.133139 => 05:00:09.140145
[0m05:00:09.165639 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m05:00:09.174640 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m05:00:09.183523 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m05:00:09.184429 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m05:00:09.186538 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m05:00:09.214155 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m05:00:09.217646 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m05:00:10.080189 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:55b2e082-4622-4f02-ae91-4286731f4f06&page=queryresults
[0m05:00:10.096723 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a756146f-6639-40ed-af59-7f3a03932a9c&page=queryresults
[0m05:00:10.535286 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 05:00:09.174640 => 05:00:10.535286
[0m05:00:10.536276 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE725D30>]}
[0m05:00:10.537283 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m05:00:10.538182 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m05:00:10.538182 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m05:00:10.539284 [info ] [Thread-2  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m05:00:10.541281 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m05:00:10.542030 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m05:00:10.548152 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m05:00:10.550115 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 05:00:10.542030 => 05:00:10.549140
[0m05:00:10.550115 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m05:00:10.554144 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m05:00:10.555150 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:10.557149 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m05:00:10.621859 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 05:00:09.141842 => 05:00:10.620866
[0m05:00:10.623386 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE4AB970>]}
[0m05:00:10.623386 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.50s]
[0m05:00:10.624404 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:10.625372 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m05:00:10.626336 [info ] [Thread-1  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m05:00:10.627397 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_produto)
[0m05:00:10.628383 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m05:00:10.633372 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m05:00:10.634371 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 05:00:10.628383 => 05:00:10.634371
[0m05:00:10.634371 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m05:00:10.638377 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m05:00:10.639370 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:10.641368 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m05:00:11.376757 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:528b53ff-90e4-4746-8145-d3d0eeb12d22&page=queryresults
[0m05:00:11.433413 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ca992188-b26e-4f31-96c9-e494e650a713&page=queryresults
[0m05:00:11.772866 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 05:00:10.635370 => 05:00:11.771869
[0m05:00:11.774872 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE4A10D0>]}
[0m05:00:11.775871 [info ] [Thread-1  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m05:00:11.776917 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m05:00:11.777922 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m05:00:11.778918 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m05:00:11.779924 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m05:00:11.780921 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m05:00:11.788822 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m05:00:11.789832 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 05:00:11.780921 => 05:00:11.789832
[0m05:00:11.789832 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m05:00:11.795825 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:12.092276 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 05:00:10.551139 => 05:00:12.091273
[0m05:00:12.093278 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BF827EE0>]}
[0m05:00:12.094276 [info ] [Thread-2  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.55s]
[0m05:00:12.096272 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m05:00:12.507786 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m05:00:12.509786 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m05:00:13.194743 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c33d0dd5-32d0-4222-8e11-e3564f083caa&page=queryresults
[0m05:00:15.782845 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 05:00:11.789832 => 05:00:15.781863
[0m05:00:15.783908 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BF7AA0A0>]}
[0m05:00:15.784868 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.00s]
[0m05:00:15.785866 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m05:00:15.786860 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m05:00:15.786860 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m05:00:15.787868 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.tb_produto)
[0m05:00:15.788865 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m05:00:15.790866 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m05:00:15.791864 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 05:00:15.788865 => 05:00:15.790866
[0m05:00:15.791864 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m05:00:15.793865 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:16.420355 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m05:00:16.422926 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m05:00:17.067866 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e3a78f69-946f-4a4d-b138-cc32d5eac79d&page=queryresults
[0m05:00:19.348082 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 05:00:15.791864 => 05:00:19.348082
[0m05:00:19.349052 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BF7AA0A0>]}
[0m05:00:19.350050 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.56s]
[0m05:00:19.351057 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m05:00:19.351057 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m05:00:19.352049 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m05:00:19.353050 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m05:00:19.353050 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m05:00:19.358099 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m05:00:19.360090 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 05:00:19.353050 => 05:00:19.360090
[0m05:00:19.361088 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m05:00:19.363755 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:19.955210 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m05:00:19.957214 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m05:00:20.518667 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a641007a-5969-4fba-8c01-9c36a90080fa&page=queryresults
[0m05:00:22.708396 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 05:00:19.361088 => 05:00:22.708396
[0m05:00:22.710406 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4afc72d3-45a4-4033-aedb-30ddee6eef4c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE4AB970>]}
[0m05:00:22.711409 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.36s]
[0m05:00:22.713426 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m05:00:22.716371 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:00:22.717375 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:00:22.718375 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:00:22.719416 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m05:00:22.720418 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m05:00:22.720418 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m05:00:22.721863 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m05:00:22.721863 [info ] [MainThread]: 
[0m05:00:22.722899 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 16.61 seconds (16.61s).
[0m05:00:22.726864 [debug] [MainThread]: Command end result
[0m05:00:22.739953 [info ] [MainThread]: 
[0m05:00:22.740957 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:00:22.740957 [info ] [MainThread]: 
[0m05:00:22.742347 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m05:00:22.744374 [debug] [MainThread]: Command `dbt run` succeeded at 05:00:22.743370 after 17.66 seconds
[0m05:00:22.744374 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BADE34C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE6D5040>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000212BE6EAFD0>]}
[0m05:00:22.745371 [debug] [MainThread]: Flushing usage events
[0m06:00:05.267887 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4AFD3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C49F4C640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C49F4CAC0>]}


============================== 06:00:05.272887 | 4c482e8a-66ac-4a77-9150-d0d950ceb005 ==============================
[0m06:00:05.272887 [info ] [MainThread]: Running with dbt=1.7.4
[0m06:00:05.273889 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m06:00:06.258902 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C49F4C850>]}
[0m06:00:06.325685 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4D915A00>]}
[0m06:00:06.327653 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m06:00:06.334627 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m06:00:06.392720 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m06:00:06.392720 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m06:00:06.396721 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4E8DACD0>]}
[0m06:00:06.405425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4E80A9A0>]}
[0m06:00:06.405425 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m06:00:06.406531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4E80A820>]}
[0m06:00:06.407524 [info ] [MainThread]: 
[0m06:00:06.409534 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m06:00:06.411524 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:06.412540 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:06.413533 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:06.414531 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:07.256031 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:08.144084 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m06:00:08.145088 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:08.147091 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m06:00:08.149052 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:08.844737 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m06:00:08.846729 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:09.504826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4E692730>]}
[0m06:00:09.506881 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m06:00:09.507886 [info ] [MainThread]: 
[0m06:00:09.516568 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:09.517634 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m06:00:09.519633 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m06:00:09.521625 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m06:00:09.522625 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:09.520634 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m06:00:09.535490 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m06:00:09.537486 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m06:00:09.537486 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m06:00:09.540486 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m06:00:09.542074 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 06:00:09.523418 => 06:00:09.542074
[0m06:00:09.543119 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:09.543119 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 06:00:09.538496 => 06:00:09.543119
[0m06:00:09.555139 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m06:00:09.571957 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m06:00:09.575955 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m06:00:09.576954 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m06:00:09.576954 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m06:00:09.579959 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m06:00:09.600743 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m06:00:10.384489 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f58fa0c4-13c3-4815-af28-17bfa518ce90&page=queryresults
[0m06:00:10.392441 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:13c7cf13-0b16-4314-9642-30b3b5e91714&page=queryresults
[0m06:00:10.849654 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 06:00:09.543119 => 06:00:10.849654
[0m06:00:10.850658 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4E692730>]}
[0m06:00:10.851653 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m06:00:10.853652 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:10.854658 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m06:00:10.861661 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 06:00:09.570950 => 06:00:10.860657
[0m06:00:10.865657 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4E67AC10>]}
[0m06:00:10.863661 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m06:00:10.868656 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m06:00:10.867659 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m06:00:10.870661 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m06:00:10.872659 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m06:00:10.880671 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m06:00:10.881643 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m06:00:10.882458 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m06:00:10.883529 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m06:00:10.884481 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m06:00:10.892542 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m06:00:10.893537 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 06:00:10.873662 => 06:00:10.892542
[0m06:00:10.894540 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m06:00:10.900526 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m06:00:10.902294 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 06:00:10.884481 => 06:00:10.901477
[0m06:00:10.903351 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m06:00:10.909439 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m06:00:10.910433 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:10.912438 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m06:00:10.931486 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:10.933482 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m06:00:11.676418 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:37e7c235-3d9e-49a3-9a38-30510eec22ac&page=queryresults
[0m06:00:11.678411 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a853016b-294d-4ddd-adfc-6f17b1369f31&page=queryresults
[0m06:00:12.069539 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 06:00:10.895526 => 06:00:12.068539
[0m06:00:12.070536 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4F97EFA0>]}
[0m06:00:12.071536 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m06:00:12.073572 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m06:00:12.115456 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 06:00:10.904358 => 06:00:12.114457
[0m06:00:12.117459 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4E8BDD00>]}
[0m06:00:12.118458 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m06:00:12.120462 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m06:00:12.121456 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m06:00:12.122335 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m06:00:12.124444 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m06:00:12.125447 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m06:00:12.137347 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m06:00:12.138346 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 06:00:12.126447 => 06:00:12.138346
[0m06:00:12.139387 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m06:00:12.146115 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:12.812097 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m06:00:12.813110 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m06:00:13.430603 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1a4b5994-5220-4288-b69f-eb84afe27dcf&page=queryresults
[0m06:00:15.954462 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 06:00:12.139387 => 06:00:15.953459
[0m06:00:15.956460 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4F9EC370>]}
[0m06:00:15.957461 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 3.83s]
[0m06:00:15.959463 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m06:00:15.961456 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m06:00:15.963309 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m06:00:15.965312 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m06:00:15.966309 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m06:00:15.973310 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m06:00:15.975261 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 06:00:15.967310 => 06:00:15.975261
[0m06:00:15.976262 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m06:00:15.980261 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:16.613365 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m06:00:16.615345 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m06:00:17.198365 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b3d29de9-7548-4ef8-8ab1-3d5c9e23931a&page=queryresults
[0m06:00:19.183796 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 06:00:15.976262 => 06:00:19.182680
[0m06:00:19.185796 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4F9DAF40>]}
[0m06:00:19.186793 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.22s]
[0m06:00:19.187814 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m06:00:19.188786 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m06:00:19.190695 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m06:00:19.191695 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m06:00:19.191695 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m06:00:19.199779 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m06:00:19.202352 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 06:00:19.192797 => 06:00:19.202352
[0m06:00:19.203380 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m06:00:19.207373 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:20.028834 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m06:00:20.031941 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m06:00:20.583709 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c1b60177-7440-4dde-bac7-a64e1b400cd5&page=queryresults
[0m06:00:23.151439 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 06:00:19.204376 => 06:00:23.150514
[0m06:00:23.153470 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4c482e8a-66ac-4a77-9150-d0d950ceb005', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4FA88F40>]}
[0m06:00:23.154491 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.96s]
[0m06:00:23.155547 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m06:00:23.159530 [debug] [MainThread]: Connection 'master' was properly closed.
[0m06:00:23.160526 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:00:23.161530 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:00:23.163409 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m06:00:23.163409 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m06:00:23.164507 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m06:00:23.165506 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m06:00:23.166501 [info ] [MainThread]: 
[0m06:00:23.167509 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 16.76 seconds (16.76s).
[0m06:00:23.171502 [debug] [MainThread]: Command end result
[0m06:00:23.183407 [info ] [MainThread]: 
[0m06:00:23.184398 [info ] [MainThread]: [32mCompleted successfully[0m
[0m06:00:23.185299 [info ] [MainThread]: 
[0m06:00:23.187317 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m06:00:23.189312 [debug] [MainThread]: Command `dbt run` succeeded at 06:00:23.189312 after 17.97 seconds
[0m06:00:23.191311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4AFD3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4D915A00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019C4E69CDC0>]}
[0m06:00:23.192312 [debug] [MainThread]: Flushing usage events
[0m07:00:15.222113 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC400A3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC3F01C8E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC3F01C5E0>]}


============================== 07:00:15.236758 | 7730b1c5-be08-4d9c-85ef-4893684c87ca ==============================
[0m07:00:15.236758 [info ] [MainThread]: Running with dbt=1.7.4
[0m07:00:15.238758 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m07:00:16.959230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC421E5A00>]}
[0m07:00:17.039983 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC437216D0>]}
[0m07:00:17.041925 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m07:00:17.051643 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m07:00:17.288722 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m07:00:17.288722 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m07:00:17.293722 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC439BAB20>]}
[0m07:00:17.308565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC438ED7C0>]}
[0m07:00:17.309621 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m07:00:17.310617 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC438ED6D0>]}
[0m07:00:17.312621 [info ] [MainThread]: 
[0m07:00:17.314681 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m07:00:17.317636 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:17.317636 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:17.318632 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:17.318632 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:18.282580 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:18.984586 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m07:00:18.986544 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:18.987577 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m07:00:18.989545 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:19.655149 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m07:00:19.659055 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:20.279666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC437D73D0>]}
[0m07:00:20.280674 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m07:00:20.282507 [info ] [MainThread]: 
[0m07:00:20.297796 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:20.299777 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m07:00:20.300788 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m07:00:20.304707 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m07:00:20.302591 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m07:00:20.306721 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:20.308720 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m07:00:20.323761 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m07:00:20.324760 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m07:00:20.330761 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m07:00:20.333763 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 07:00:20.309617 => 07:00:20.332671
[0m07:00:20.334794 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:20.369497 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 07:00:20.324760 => 07:00:20.369497
[0m07:00:20.374497 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m07:00:20.375496 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m07:00:20.383164 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m07:00:20.390179 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m07:00:20.393178 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m07:00:20.417176 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m07:00:20.419221 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m07:00:21.300716 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:64d34540-638d-4644-8133-ab7e0f215c6c&page=queryresults
[0m07:00:21.304631 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0178c6b1-4cb7-4212-91b8-1ec4336ef831&page=queryresults
[0m07:00:21.766871 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 07:00:20.375496 => 07:00:21.766871
[0m07:00:21.766871 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC4399ED30>]}
[0m07:00:21.774861 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 07:00:20.334794 => 07:00:21.774861
[0m07:00:21.768856 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.46s]
[0m07:00:21.776856 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC437D73D0>]}
[0m07:00:21.777861 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m07:00:21.778864 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m07:00:21.778864 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m07:00:21.780861 [info ] [Thread-2  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m07:00:21.781844 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:21.782285 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m07:00:21.783306 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m07:00:21.784333 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m07:00:21.789287 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m07:00:21.785324 [info ] [Thread-1  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m07:00:21.790287 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_produto)
[0m07:00:21.791287 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m07:00:21.794413 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m07:00:21.795420 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 07:00:21.785324 => 07:00:21.794413
[0m07:00:21.795420 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m07:00:21.798294 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m07:00:21.798294 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 07:00:21.791287 => 07:00:21.798294
[0m07:00:21.799349 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m07:00:21.803658 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m07:00:21.804656 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:21.806624 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m07:00:21.836976 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:21.838937 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m07:00:22.813293 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3d88d7c2-2bb1-4439-b9dd-cae0e2b18c12&page=queryresults
[0m07:00:22.847712 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ce7ae08b-e192-4975-a026-089b48159299&page=queryresults
[0m07:00:23.239093 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 07:00:21.799349 => 07:00:23.238087
[0m07:00:23.241087 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC44B18280>]}
[0m07:00:23.242805 [info ] [Thread-1  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m07:00:23.243751 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m07:00:23.244797 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m07:00:23.245756 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m07:00:23.246754 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m07:00:23.246754 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m07:00:23.262513 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m07:00:23.265572 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 07:00:23.247800 => 07:00:23.264526
[0m07:00:23.266535 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m07:00:23.278586 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:23.281575 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 07:00:21.795420 => 07:00:23.281575
[0m07:00:23.282430 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC43A3F8E0>]}
[0m07:00:23.283494 [info ] [Thread-2  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.50s]
[0m07:00:23.302210 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m07:00:23.933495 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m07:00:23.934493 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m07:00:24.545186 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:efe9d64f-0909-4358-ba8f-ea31c69c747d&page=queryresults
[0m07:00:27.363404 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 07:00:23.267568 => 07:00:27.363404
[0m07:00:27.364379 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC43A3F8E0>]}
[0m07:00:27.365391 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.12s]
[0m07:00:27.367491 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m07:00:27.369483 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m07:00:27.371482 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m07:00:27.373491 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.tb_produto)
[0m07:00:27.375484 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m07:00:27.382242 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m07:00:27.383261 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 07:00:27.375484 => 07:00:27.383261
[0m07:00:27.384261 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m07:00:27.387262 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:27.980400 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m07:00:27.984219 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m07:00:28.695681 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b4c4f861-eb4b-4245-97a2-b229494a830b&page=queryresults
[0m07:00:30.683250 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 07:00:27.384261 => 07:00:30.682323
[0m07:00:30.685368 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC43A64040>]}
[0m07:00:30.687359 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.31s]
[0m07:00:30.688373 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m07:00:30.690263 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m07:00:30.691368 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m07:00:30.693271 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m07:00:30.694269 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m07:00:30.702117 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m07:00:30.704146 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 07:00:30.694269 => 07:00:30.703140
[0m07:00:30.705142 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m07:00:30.710244 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:31.348148 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m07:00:31.351152 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m07:00:31.937010 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f8c2d697-82cd-4559-8608-ed15986c6141&page=queryresults
[0m07:00:35.163653 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 07:00:30.705142 => 07:00:35.162592
[0m07:00:35.165649 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7730b1c5-be08-4d9c-85ef-4893684c87ca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC44BE9D90>]}
[0m07:00:35.166610 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 4.47s]
[0m07:00:35.168611 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m07:00:35.171650 [debug] [MainThread]: Connection 'master' was properly closed.
[0m07:00:35.171650 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:00:35.172649 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:00:35.173658 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m07:00:35.174659 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m07:00:35.174659 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m07:00:35.176665 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m07:00:35.177676 [info ] [MainThread]: 
[0m07:00:35.178610 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 17.86 seconds (17.86s).
[0m07:00:35.182144 [debug] [MainThread]: Command end result
[0m07:00:35.193176 [info ] [MainThread]: 
[0m07:00:35.194139 [info ] [MainThread]: [32mCompleted successfully[0m
[0m07:00:35.195139 [info ] [MainThread]: 
[0m07:00:35.196178 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m07:00:35.197173 [debug] [MainThread]: Command `dbt run` succeeded at 07:00:35.197173 after 20.07 seconds
[0m07:00:35.197173 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC400A3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC437216D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001EC44A5CD00>]}
[0m07:00:35.198171 [debug] [MainThread]: Flushing usage events
[0m08:00:05.625561 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089BE03430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089AD789A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089AD78D30>]}


============================== 08:00:05.633515 | e6b41468-2089-4194-8834-2b3bf1a8ae28 ==============================
[0m08:00:05.633515 [info ] [MainThread]: Running with dbt=1.7.4
[0m08:00:05.634508 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m08:00:06.550559 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089AD7E370>]}
[0m08:00:06.613530 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F38B250>]}
[0m08:00:06.615200 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m08:00:06.622339 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m08:00:06.675888 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m08:00:06.675888 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m08:00:06.679890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F70B460>]}
[0m08:00:06.687627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F6FB100>]}
[0m08:00:06.687627 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m08:00:06.688588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F4EF850>]}
[0m08:00:06.689622 [info ] [MainThread]: 
[0m08:00:06.690782 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m08:00:06.692602 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:06.693641 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:06.694609 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:06.695647 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:07.748259 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:08.984981 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m08:00:08.986888 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m08:00:08.987979 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:08.988992 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:09.942544 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m08:00:09.943658 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:10.593592 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F4C9400>]}
[0m08:00:10.593592 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m08:00:10.594481 [info ] [MainThread]: 
[0m08:00:10.602146 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:10.603145 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m08:00:10.605144 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m08:00:10.607162 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m08:00:10.608159 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:10.606147 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m08:00:10.620269 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m08:00:10.621601 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m08:00:10.622203 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m08:00:10.627345 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m08:00:10.628222 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 08:00:10.609157 => 08:00:10.628222
[0m08:00:10.629226 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:10.636261 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 08:00:10.622203 => 08:00:10.636261
[0m08:00:10.659372 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m08:00:10.659372 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m08:00:10.662207 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m08:00:10.665220 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m08:00:10.668219 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m08:00:10.700790 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m08:00:10.702649 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m08:00:11.551856 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:84a1b4f5-ca1b-4b9e-8263-a6d545fc1a29&page=queryresults
[0m08:00:11.615111 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b6be8133-c22a-4444-b9ee-df45e22ed227&page=queryresults
[0m08:00:12.009152 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 08:00:10.629226 => 08:00:12.009152
[0m08:00:12.010150 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F799FD0>]}
[0m08:00:12.011151 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m08:00:12.012152 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:12.013253 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m08:00:12.013253 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m08:00:12.014242 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m08:00:12.015241 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m08:00:12.018237 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m08:00:12.019248 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 08:00:12.015241 => 08:00:12.019248
[0m08:00:12.019248 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m08:00:12.021247 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m08:00:12.022173 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:12.023237 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m08:00:12.091369 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 08:00:10.659372 => 08:00:12.090373
[0m08:00:12.092460 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F75B9A0>]}
[0m08:00:12.093471 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m08:00:12.095458 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m08:00:12.095458 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m08:00:12.096466 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m08:00:12.098455 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m08:00:12.098455 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m08:00:12.103509 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m08:00:12.106515 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 08:00:12.099449 => 08:00:12.105521
[0m08:00:12.107513 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m08:00:12.114511 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m08:00:12.116514 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:12.119511 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m08:00:12.734823 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cdce8290-1710-4a39-ba86-795ff8c67f7f&page=queryresults
[0m08:00:12.834328 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1cf3d9a5-ef5e-4071-840f-26c893b52a42&page=queryresults
[0m08:00:13.141173 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 08:00:12.019248 => 08:00:13.140172
[0m08:00:13.141173 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F70B550>]}
[0m08:00:13.142549 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m08:00:13.142549 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m08:00:13.237210 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 08:00:12.107513 => 08:00:13.237210
[0m08:00:13.239219 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F75B9A0>]}
[0m08:00:13.240222 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m08:00:13.241112 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m08:00:13.242761 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m08:00:13.243838 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m08:00:13.244836 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m08:00:13.245836 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m08:00:13.260837 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m08:00:13.262839 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 08:00:13.245836 => 08:00:13.262839
[0m08:00:13.263840 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m08:00:13.285267 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:14.025834 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m08:00:14.027843 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m08:00:14.729970 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:457b453b-06a3-49d6-a20b-aa380aa0a63f&page=queryresults
[0m08:00:17.811055 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 08:00:13.263840 => 08:00:17.811055
[0m08:00:17.813055 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F70BF70>]}
[0m08:00:17.814054 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.57s]
[0m08:00:17.814648 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m08:00:17.816735 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m08:00:17.817732 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m08:00:17.819735 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m08:00:17.819735 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m08:00:17.826755 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m08:00:17.828751 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 08:00:17.820732 => 08:00:17.828751
[0m08:00:17.829655 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m08:00:17.833758 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:18.463725 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m08:00:18.465738 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m08:00:19.193137 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9992e2e6-9488-4b18-8d7e-68cc54ccbe5f&page=queryresults
[0m08:00:21.438164 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 08:00:17.829655 => 08:00:21.437158
[0m08:00:21.439163 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208A0794760>]}
[0m08:00:21.440163 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.62s]
[0m08:00:21.441856 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m08:00:21.443176 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m08:00:21.444257 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m08:00:21.445252 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m08:00:21.446252 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m08:00:21.451252 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m08:00:21.452251 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 08:00:21.446252 => 08:00:21.452251
[0m08:00:21.453261 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m08:00:21.456352 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:22.104069 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m08:00:22.106084 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m08:00:22.876290 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b642f035-423d-45a9-b0ff-84e21bf39bcf&page=queryresults
[0m08:00:25.135394 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 08:00:21.453261 => 08:00:25.135394
[0m08:00:25.136288 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b41468-2089-4194-8834-2b3bf1a8ae28', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208A089B190>]}
[0m08:00:25.136288 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.69s]
[0m08:00:25.137289 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m08:00:25.139292 [debug] [MainThread]: Connection 'master' was properly closed.
[0m08:00:25.140290 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:00:25.140290 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:00:25.141401 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m08:00:25.141401 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m08:00:25.142392 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m08:00:25.142761 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m08:00:25.142761 [info ] [MainThread]: 
[0m08:00:25.143865 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 18.45 seconds (18.45s).
[0m08:00:25.146760 [debug] [MainThread]: Command end result
[0m08:00:25.158764 [info ] [MainThread]: 
[0m08:00:25.159766 [info ] [MainThread]: [32mCompleted successfully[0m
[0m08:00:25.160765 [info ] [MainThread]: 
[0m08:00:25.162304 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m08:00:25.163338 [debug] [MainThread]: Command `dbt run` succeeded at 08:00:25.163338 after 19.65 seconds
[0m08:00:25.164341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089BE03430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F4EF3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002089F4D3970>]}
[0m08:00:25.165338 [debug] [MainThread]: Flushing usage events
[0m09:00:06.805163 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6FCA3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6EC2A6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6EC2AE20>]}


============================== 09:00:06.814128 | 75c566b4-81fa-4f33-bdb0-914ec8723b00 ==============================
[0m09:00:06.814128 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:00:06.814815 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m09:00:07.728530 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6EC1E070>]}
[0m09:00:07.785684 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A73305850>]}
[0m09:00:07.788058 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:00:07.798106 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:00:07.868091 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:00:07.868091 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:00:07.872098 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A735ABD90>]}
[0m09:00:07.879023 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A7359FA30>]}
[0m09:00:07.880023 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:00:07.880023 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A7359F940>]}
[0m09:00:07.882394 [info ] [MainThread]: 
[0m09:00:07.883427 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:00:07.885425 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:07.885425 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:07.886425 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:07.920079 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:08.905394 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:09.579359 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m09:00:09.580366 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m09:00:09.581369 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:09.582364 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:10.254025 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m09:00:10.255019 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:10.888003 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A73373D60>]}
[0m09:00:10.889093 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:00:10.891100 [info ] [MainThread]: 
[0m09:00:10.898797 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:10.899842 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m09:00:10.900796 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m09:00:10.904626 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m09:00:10.902457 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m09:00:10.905626 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:10.906505 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m09:00:10.920621 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:00:10.922339 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m09:00:10.927442 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m09:00:10.929451 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 09:00:10.907630 => 09:00:10.928441
[0m09:00:10.929451 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:10.957636 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 09:00:10.922339 => 09:00:10.957636
[0m09:00:10.972474 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:00:10.973630 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m09:00:10.985374 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m09:00:10.986375 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:00:10.990374 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m09:00:11.031107 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m09:00:11.033099 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m09:00:11.892246 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:58534a6b-2c30-4538-808e-61d3d8ced6c2&page=queryresults
[0m09:00:11.901774 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:589b6941-17ba-4cc6-b4cd-56fd31b37051&page=queryresults
[0m09:00:12.302546 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 09:00:10.930439 => 09:00:12.302546
[0m09:00:12.303652 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A73373D60>]}
[0m09:00:12.304652 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m09:00:12.305586 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:12.306565 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m09:00:12.307560 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m09:00:12.308562 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m09:00:12.308562 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m09:00:12.313563 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m09:00:12.314566 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 09:00:12.309565 => 09:00:12.314566
[0m09:00:12.315568 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m09:00:12.319562 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m09:00:12.320565 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:12.322348 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m09:00:12.369659 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 09:00:10.974892 => 09:00:12.369659
[0m09:00:12.371658 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A735F93D0>]}
[0m09:00:12.372669 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m09:00:12.374668 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m09:00:12.376574 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m09:00:12.377572 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m09:00:12.380564 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m09:00:12.382072 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m09:00:12.390092 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m09:00:12.392102 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 09:00:12.382072 => 09:00:12.391102
[0m09:00:12.393100 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m09:00:12.398183 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m09:00:12.400088 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:12.402252 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m09:00:13.090747 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1964f3c8-dfc9-42e7-8e51-67d380a275e4&page=queryresults
[0m09:00:13.221786 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:33f57a20-a07b-4d65-9a3b-54af92e49f95&page=queryresults
[0m09:00:13.486417 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 09:00:12.315568 => 09:00:13.486417
[0m09:00:13.487416 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A735ABF10>]}
[0m09:00:13.488417 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m09:00:13.489417 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m09:00:13.633329 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 09:00:12.393100 => 09:00:13.633329
[0m09:00:13.635330 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A735F93D0>]}
[0m09:00:13.635330 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m09:00:13.637229 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m09:00:13.638534 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m09:00:13.638534 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m09:00:13.639666 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m09:00:13.640699 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m09:00:13.654139 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m09:00:13.656048 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 09:00:13.640699 => 09:00:13.655141
[0m09:00:13.656048 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m09:00:13.669545 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:14.616015 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m09:00:14.617019 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m09:00:15.354272 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a474d895-ec3d-46a8-8b35-0c490cd4d39f&page=queryresults
[0m09:00:17.672603 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 09:00:13.657149 => 09:00:17.672603
[0m09:00:17.673608 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A74718B50>]}
[0m09:00:17.674613 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.03s]
[0m09:00:17.676605 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m09:00:17.677506 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m09:00:17.678507 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m09:00:17.679506 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m09:00:17.680614 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m09:00:17.685956 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m09:00:17.686843 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 09:00:17.680614 => 09:00:17.686843
[0m09:00:17.687848 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m09:00:17.690961 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:18.345257 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m09:00:18.347160 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m09:00:19.004621 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:db9253e2-c30e-485a-99ef-4c007fa0fc91&page=queryresults
[0m09:00:21.213544 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 09:00:17.687848 => 09:00:21.212394
[0m09:00:21.214536 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A74718B50>]}
[0m09:00:21.215544 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.54s]
[0m09:00:21.216441 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m09:00:21.217439 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m09:00:21.218440 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m09:00:21.219441 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m09:00:21.219441 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m09:00:21.224438 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m09:00:21.226442 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 09:00:21.220440 => 09:00:21.225438
[0m09:00:21.226892 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m09:00:21.230012 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:21.861318 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m09:00:21.863322 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m09:00:22.515749 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:773074f4-763a-4bcf-bdb9-b495422d22dd&page=queryresults
[0m09:00:24.696477 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 09:00:21.226892 => 09:00:24.696477
[0m09:00:24.698477 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '75c566b4-81fa-4f33-bdb0-914ec8723b00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A7475AB20>]}
[0m09:00:24.698477 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.48s]
[0m09:00:24.700570 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m09:00:24.703270 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:00:24.703270 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:00:24.704380 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:00:24.704380 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m09:00:24.705385 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m09:00:24.705385 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m09:00:24.705385 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m09:00:24.706385 [info ] [MainThread]: 
[0m09:00:24.707433 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 16.82 seconds (16.82s).
[0m09:00:24.709623 [debug] [MainThread]: Command end result
[0m09:00:24.722553 [info ] [MainThread]: 
[0m09:00:24.723566 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:00:24.724566 [info ] [MainThread]: 
[0m09:00:24.725558 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m09:00:24.727763 [debug] [MainThread]: Command `dbt run` succeeded at 09:00:24.726650 after 18.01 seconds
[0m09:00:24.728700 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A6FCA3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A73305850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022A7358DE20>]}
[0m09:00:24.728700 [debug] [MainThread]: Flushing usage events
[0m10:00:05.634347 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023108AB24C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023107A372E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023107A37760>]}


============================== 10:00:05.644250 | f6086596-4fb4-467f-9d1c-0db0138b90d1 ==============================
[0m10:00:05.644250 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:00:05.644250 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m10:00:06.294307 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023107A14130>]}
[0m10:00:06.362455 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C1F2D30>]}
[0m10:00:06.363883 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:00:06.370098 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:00:06.416032 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:00:06.416032 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:00:06.420034 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C3BAF10>]}
[0m10:00:06.428923 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C232220>]}
[0m10:00:06.429823 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:00:06.429823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C232250>]}
[0m10:00:06.430824 [info ] [MainThread]: 
[0m10:00:06.431825 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:00:06.433902 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:06.433902 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:06.434933 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:06.434933 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:07.285326 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:07.986322 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:00:07.987320 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m10:00:07.988421 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:07.989789 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:08.855088 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m10:00:08.856084 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:09.507823 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C174BE0>]}
[0m10:00:09.509889 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:00:09.510841 [info ] [MainThread]: 
[0m10:00:09.517919 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:09.518919 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m10:00:09.519920 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m10:00:09.521920 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m10:00:09.523295 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m10:00:09.525293 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m10:00:09.525293 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:09.526291 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m10:00:09.537421 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:00:09.543005 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m10:00:09.544945 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 10:00:09.527292 => 10:00:09.544945
[0m10:00:09.545948 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:09.546946 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 10:00:09.538440 => 10:00:09.546946
[0m10:00:09.558941 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m10:00:09.609434 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m10:00:09.622149 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:00:09.623162 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:00:09.626207 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m10:00:09.674897 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:00:09.679036 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m10:00:10.565874 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bc476d6f-4acf-482a-9f5e-69d84673cd35&page=queryresults
[0m10:00:10.593000 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d28e45de-45ff-476c-936b-8ded9c9402f2&page=queryresults
[0m10:00:11.026588 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 10:00:09.547996 => 10:00:11.025585
[0m10:00:11.027580 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C156400>]}
[0m10:00:11.028584 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.51s]
[0m10:00:11.029585 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:11.029585 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m10:00:11.030588 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m10:00:11.031579 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m10:00:11.031579 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m10:00:11.034594 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m10:00:11.035590 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 10:00:11.031579 => 10:00:11.035590
[0m10:00:11.035590 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m10:00:11.037600 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m10:00:11.038593 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:11.039457 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m10:00:11.233059 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 10:00:09.559973 => 10:00:11.233059
[0m10:00:11.234057 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C174BE0>]}
[0m10:00:11.235960 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.71s]
[0m10:00:11.238058 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m10:00:11.239058 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m10:00:11.240061 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m10:00:11.240960 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m10:00:11.242841 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m10:00:11.248858 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m10:00:11.249863 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 10:00:11.242841 => 10:00:11.249863
[0m10:00:11.250862 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m10:00:11.254857 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m10:00:11.255861 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:11.258859 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m10:00:11.750202 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a3ce70cd-5316-44ab-b508-0c746facb3f9&page=queryresults
[0m10:00:11.951670 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:40f7cae9-55d3-4640-a7e4-d8a930e95160&page=queryresults
[0m10:00:12.222143 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 10:00:11.035590 => 10:00:12.222143
[0m10:00:12.223247 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C232100>]}
[0m10:00:12.224244 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m10:00:12.226148 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m10:00:12.406812 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 10:00:11.250862 => 10:00:12.405810
[0m10:00:12.407812 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310D447D00>]}
[0m10:00:12.408811 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m10:00:12.409812 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m10:00:12.411124 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m10:00:12.411124 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m10:00:12.413249 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m10:00:12.413249 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m10:00:12.419244 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m10:00:12.420247 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 10:00:12.414255 => 10:00:12.420247
[0m10:00:12.421715 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m10:00:12.448726 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:13.139965 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m10:00:13.142560 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m10:00:13.740822 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f5b28b9a-0f59-4e9d-a2e7-baa403cc5629&page=queryresults
[0m10:00:16.663744 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 10:00:12.421715 => 10:00:16.663744
[0m10:00:16.664742 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310D49FA30>]}
[0m10:00:16.665742 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.25s]
[0m10:00:16.666743 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m10:00:16.668644 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m10:00:16.668644 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m10:00:16.670657 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m10:00:16.670657 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m10:00:16.674681 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m10:00:16.676691 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 10:00:16.670657 => 10:00:16.676691
[0m10:00:16.678707 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m10:00:16.681647 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:17.316698 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m10:00:17.318699 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

select *
    from cte_tratamentos
  order by nm_produto_completo
    );
  
[0m10:00:17.997015 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0aa937fc-1bef-4c1d-b3a7-f6e092ea7eb2&page=queryresults
[0m10:00:20.010518 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 10:00:16.678707 => 10:00:20.010518
[0m10:00:20.011517 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C462700>]}
[0m10:00:20.012517 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 84.5 KiB processed)[0m in 3.34s]
[0m10:00:20.013424 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m10:00:20.014423 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m10:00:20.015423 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m10:00:20.016423 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m10:00:20.016423 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m10:00:20.022906 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m10:00:20.024911 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 10:00:20.016423 => 10:00:20.024006
[0m10:00:20.024911 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m10:00:20.029003 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:20.781562 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m10:00:20.783979 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m10:00:21.476599 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6476fb02-358b-4182-942b-4d7be1a0fe4d&page=queryresults
[0m10:00:23.725942 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 10:00:20.026003 => 10:00:23.723928
[0m10:00:23.725942 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6086596-4fb4-467f-9d1c-0db0138b90d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C462670>]}
[0m10:00:23.728483 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.71s]
[0m10:00:23.729497 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m10:00:23.732497 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:00:23.732497 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:23.732497 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:23.733496 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m10:00:23.733496 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m10:00:23.734494 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m10:00:23.734494 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m10:00:23.735494 [info ] [MainThread]: 
[0m10:00:23.735494 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 17.30 seconds (17.30s).
[0m10:00:23.737494 [debug] [MainThread]: Command end result
[0m10:00:23.761121 [info ] [MainThread]: 
[0m10:00:23.761121 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:00:23.761121 [info ] [MainThread]: 
[0m10:00:23.761121 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m10:00:23.767770 [debug] [MainThread]: Command `dbt run` succeeded at 10:00:23.767770 after 18.19 seconds
[0m10:00:23.768770 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000023108AB24C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C1DF550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002310C0ACC70>]}
[0m10:00:23.769768 [debug] [MainThread]: Flushing usage events
[0m10:48:00.874012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239A7A5430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000223997206A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022399720DC0>]}


============================== 10:48:00.874012 | e9bb99f2-981c-47a5-8533-75263fcf8658 ==============================
[0m10:48:00.874012 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:48:00.878490 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --models tb_produto', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m10:48:01.446627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e9bb99f2-981c-47a5-8533-75263fcf8658', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022399711940>]}
[0m10:48:01.511401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e9bb99f2-981c-47a5-8533-75263fcf8658', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239DE15790>]}
[0m10:48:01.511401 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:48:01.525639 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:48:01.596266 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m10:48:01.596266 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_produto.sql
[0m10:48:01.811436 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e9bb99f2-981c-47a5-8533-75263fcf8658', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239E134520>]}
[0m10:48:01.832933 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e9bb99f2-981c-47a5-8533-75263fcf8658', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239DFFC7C0>]}
[0m10:48:01.832933 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:48:01.832933 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e9bb99f2-981c-47a5-8533-75263fcf8658', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239DFFC760>]}
[0m10:48:01.832933 [info ] [MainThread]: 
[0m10:48:01.832933 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:48:01.838683 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:48:01.838683 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:48:02.621577 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:48:02.623453 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:48:02.623453 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m10:48:02.631459 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:48:03.311680 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m10:48:03.311680 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:48:04.021528 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e9bb99f2-981c-47a5-8533-75263fcf8658', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239DDA9FD0>]}
[0m10:48:04.021528 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:48:04.021528 [info ] [MainThread]: 
[0m10:48:04.051704 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m10:48:04.056746 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m10:48:04.062833 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_produto'
[0m10:48:04.063834 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m10:48:04.075448 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m10:48:04.076448 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 10:48:04.063834 => 10:48:04.076448
[0m10:48:04.076448 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m10:48:04.094042 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:48:04.781534 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m10:48:04.781534 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

select *
    from cte_join_campos_customizados
  order by nm_produto_completo
    );
  
[0m10:48:05.631272 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5a9d5dda-6e3d-4154-aaa7-31b60e19985d&page=queryresults
[0m10:48:08.251584 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 10:48:04.078066 => 10:48:08.251584
[0m10:48:08.262716 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e9bb99f2-981c-47a5-8533-75263fcf8658', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239E21E3A0>]}
[0m10:48:08.263557 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 93.1 KiB processed)[0m in 4.20s]
[0m10:48:08.263557 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m10:48:08.267747 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:48:08.267747 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:48:08.267747 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m10:48:08.267747 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m10:48:08.267747 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m10:48:08.267747 [info ] [MainThread]: 
[0m10:48:08.271467 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.43 seconds (6.43s).
[0m10:48:08.271467 [debug] [MainThread]: Command end result
[0m10:48:08.298059 [info ] [MainThread]: 
[0m10:48:08.301287 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:48:08.304464 [info ] [MainThread]: 
[0m10:48:08.305462 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m10:48:08.311338 [debug] [MainThread]: Command `dbt run` succeeded at 10:48:08.309825 after 7.50 seconds
[0m10:48:08.312468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239A7A5430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239E278EB0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002239E0BDD30>]}
[0m10:48:08.313478 [debug] [MainThread]: Flushing usage events
[0m11:00:03.883857 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261EFC92400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261EEC138E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261EEC135E0>]}


============================== 11:00:03.883857 | dd1ec695-cd33-4a25-8388-07fc16734951 ==============================
[0m11:00:03.883857 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:00:03.883857 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:00:04.518453 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261EEBFF100>]}
[0m11:00:04.590018 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F32F8790>]}
[0m11:00:04.592102 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:00:04.598478 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:00:04.663238 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:00:04.679423 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:00:04.679423 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F3598FA0>]}
[0m11:00:04.679423 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F3430B80>]}
[0m11:00:04.679423 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:00:04.679423 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F3430280>]}
[0m11:00:04.695128 [info ] [MainThread]: 
[0m11:00:04.695128 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:00:04.695128 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:04.695128 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:04.695128 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:04.695128 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:05.495875 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:06.172027 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m11:00:06.173439 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:06.175124 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m11:00:06.175124 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:06.801129 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m11:00:06.801129 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:07.422443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F33367F0>]}
[0m11:00:07.423441 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:00:07.424439 [info ] [MainThread]: 
[0m11:00:07.431572 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:07.433218 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m11:00:07.434227 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m11:00:07.435943 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m11:00:07.435943 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:07.443827 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m11:00:07.434736 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m11:00:07.444826 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m11:00:07.444826 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m11:00:07.447822 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m11:00:07.449927 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 11:00:07.445870 => 11:00:07.448921
[0m11:00:07.450544 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m11:00:07.456889 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 11:00:07.436943 => 11:00:07.456889
[0m11:00:07.471257 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:07.476064 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m11:00:07.481425 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m11:00:07.483427 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:00:07.484427 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m11:00:07.486403 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m11:00:07.509702 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m11:00:08.528773 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:96c04bdb-f321-4418-b130-c3d336894778&page=queryresults
[0m11:00:08.549825 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1162ea6f-4c47-4883-92db-4142500338fd&page=queryresults
[0m11:00:08.998665 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 11:00:07.476064 => 11:00:08.998665
[0m11:00:08.999225 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F33367F0>]}
[0m11:00:08.999225 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.56s]
[0m11:00:09.000535 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:09.001519 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m11:00:09.002460 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m11:00:09.002460 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m11:00:09.002460 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m11:00:09.005455 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m11:00:09.006799 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 11:00:09.003523 => 11:00:09.005455
[0m11:00:09.008808 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 11:00:07.451712 => 11:00:09.008808
[0m11:00:09.008808 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m11:00:09.010159 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F3430070>]}
[0m11:00:09.012150 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m11:00:09.013110 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.57s]
[0m11:00:09.014108 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m11:00:09.014108 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m11:00:09.014579 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m11:00:09.014579 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:09.015802 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m11:00:09.015802 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m11:00:09.018933 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m11:00:09.021169 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m11:00:09.043082 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 11:00:09.015802 => 11:00:09.042135
[0m11:00:09.043082 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m11:00:09.045080 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m11:00:09.047133 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:09.049071 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m11:00:09.715174 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7967f35c-095f-439d-8d9f-7741cb0c2b67&page=queryresults
[0m11:00:09.865929 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:20b67da0-f053-4ad2-a9e9-0913b2f04c2d&page=queryresults
[0m11:00:10.136569 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 11:00:09.010159 => 11:00:10.136569
[0m11:00:10.137569 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F35DD820>]}
[0m11:00:10.138847 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m11:00:10.139846 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m11:00:10.578600 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 11:00:09.043082 => 11:00:10.578600
[0m11:00:10.588063 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F359BCD0>]}
[0m11:00:10.589040 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.57s]
[0m11:00:10.589040 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m11:00:10.589040 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m11:00:10.589040 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m11:00:10.589040 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m11:00:10.589040 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m11:00:10.600780 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m11:00:10.600780 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 11:00:10.589040 => 11:00:10.600780
[0m11:00:10.600780 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m11:00:10.608714 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:11.243355 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m11:00:11.244355 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m11:00:11.962027 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ac212a7e-fcf9-4dea-8e91-2e84f06394ca&page=queryresults
[0m11:00:19.234187 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 11:00:10.600780 => 11:00:19.234187
[0m11:00:19.234187 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F3641670>]}
[0m11:00:19.234187 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 8.65s]
[0m11:00:19.243011 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m11:00:19.243011 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m11:00:19.243011 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m11:00:19.243011 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m11:00:19.243011 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m11:00:19.243011 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m11:00:19.243011 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 11:00:19.243011 => 11:00:19.243011
[0m11:00:19.243011 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m11:00:19.259125 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:19.890859 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m11:00:19.890859 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

select *
    from cte_join_campos_customizados
  order by nm_produto_completo
    );
  
[0m11:00:20.702254 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:74275b34-a50a-459e-a0b9-dc53c99ee9be&page=queryresults
[0m11:00:23.513948 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 11:00:19.243011 => 11:00:23.513948
[0m11:00:23.513948 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F4720790>]}
[0m11:00:23.526940 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 93.1 KiB processed)[0m in 4.27s]
[0m11:00:23.526940 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m11:00:23.526940 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m11:00:23.526940 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m11:00:23.526940 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m11:00:23.526940 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m11:00:23.526940 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m11:00:23.526940 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 11:00:23.526940 => 11:00:23.526940
[0m11:00:23.542831 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m11:00:23.546661 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:24.158376 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m11:00:24.158376 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m11:00:24.842994 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3865999a-3ad6-442a-8cc9-5e2641eea5f1&page=queryresults
[0m11:00:27.161735 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 11:00:23.542831 => 11:00:27.161735
[0m11:00:27.162251 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd1ec695-cd33-4a25-8388-07fc16734951', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F4720790>]}
[0m11:00:27.162946 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.64s]
[0m11:00:27.163704 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m11:00:27.168159 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:00:27.169514 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:00:27.169514 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:00:27.169514 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m11:00:27.170533 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m11:00:27.170533 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m11:00:27.170533 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m11:00:27.170533 [info ] [MainThread]: 
[0m11:00:27.171528 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 22.48 seconds (22.48s).
[0m11:00:27.173546 [debug] [MainThread]: Command end result
[0m11:00:27.180992 [info ] [MainThread]: 
[0m11:00:27.182199 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:00:27.182199 [info ] [MainThread]: 
[0m11:00:27.183205 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m11:00:27.184209 [debug] [MainThread]: Command `dbt run` succeeded at 11:00:27.184209 after 23.35 seconds
[0m11:00:27.184209 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261EFC92400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F3313F70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000261F34CD040>]}
[0m11:00:27.185229 [debug] [MainThread]: Flushing usage events
[0m12:00:13.868293 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B4849430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B37D0640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B37D0AC0>]}


============================== 12:00:13.875386 | 420b8252-6b45-49c3-b6c8-3892ffa7a703 ==============================
[0m12:00:13.875386 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:00:13.875386 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m12:00:14.667234 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B37D0850>]}
[0m12:00:14.737525 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B7EC2550>]}
[0m12:00:14.737525 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:00:14.770207 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:00:18.026675 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:00:18.026675 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:00:18.042912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B8158BB0>]}
[0m12:00:18.074862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B8145880>]}
[0m12:00:18.074862 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:00:18.090957 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B8145700>]}
[0m12:00:18.090957 [info ] [MainThread]: 
[0m12:00:18.090957 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:00:18.090957 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:18.090957 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:18.090957 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:18.090957 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:18.975927 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:19.641992 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m12:00:19.643937 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:19.644454 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m12:00:19.646591 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:20.310213 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m12:00:20.310213 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:20.961399 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B7F22EB0>]}
[0m12:00:20.963655 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:00:20.964705 [info ] [MainThread]: 
[0m12:00:20.972642 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:20.974362 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m12:00:20.975653 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m12:00:20.978751 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m12:00:20.979709 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:20.977653 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m12:00:20.993979 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m12:00:20.994921 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m12:00:20.995912 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m12:00:20.999395 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m12:00:20.999395 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 12:00:20.979709 => 12:00:20.999395
[0m12:00:20.999395 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:21.027485 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m12:00:21.028225 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 12:00:20.995912 => 12:00:21.028225
[0m12:00:21.028225 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m12:00:21.028225 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m12:00:21.028225 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:00:21.037837 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m12:00:21.063562 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m12:00:21.066467 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m12:00:21.952395 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e033ae82-aba8-4a01-b305-c4cdedc77fdc&page=queryresults
[0m12:00:21.960134 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4fecc196-ebeb-4b2b-a868-201ed0553fc0&page=queryresults
[0m12:00:22.393993 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 12:00:20.999395 => 12:00:22.393993
[0m12:00:22.394957 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B7F22EB0>]}
[0m12:00:22.394957 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m12:00:22.396010 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:22.396901 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m12:00:22.396901 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m12:00:22.397903 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m12:00:22.397903 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m12:00:22.398901 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m12:00:22.398901 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 12:00:22.398901 => 12:00:22.398901
[0m12:00:22.398901 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m12:00:22.398901 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m12:00:22.398901 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:22.406569 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m12:00:22.430631 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 12:00:21.028225 => 12:00:22.430631
[0m12:00:22.431520 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B81EE3D0>]}
[0m12:00:22.431520 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m12:00:22.432519 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m12:00:22.432519 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m12:00:22.432519 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m12:00:22.434518 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m12:00:22.434518 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m12:00:22.437682 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m12:00:22.438467 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 12:00:22.434518 => 12:00:22.438467
[0m12:00:22.438467 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m12:00:22.441187 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m12:00:22.443194 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:22.443194 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m12:00:23.190169 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cf3a7c9a-15cc-48ef-b0b3-52ab90e73551&page=queryresults
[0m12:00:23.208170 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:72bdd97e-8a4e-453b-8da0-a76caf4f936b&page=queryresults
[0m12:00:23.586065 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 12:00:22.398901 => 12:00:23.586065
[0m12:00:23.587090 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B9293E50>]}
[0m12:00:23.587755 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m12:00:23.587755 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m12:00:23.641733 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 12:00:22.438467 => 12:00:23.641733
[0m12:00:23.642912 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B81EE3D0>]}
[0m12:00:23.642912 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m12:00:23.644111 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m12:00:23.645157 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m12:00:23.645157 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m12:00:23.646153 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m12:00:23.646683 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m12:00:23.654490 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m12:00:23.655485 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 12:00:23.646683 => 12:00:23.655485
[0m12:00:23.656477 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m12:00:23.663820 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:24.296360 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m12:00:24.297212 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
      from cte_produto
)


--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m12:00:24.996690 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7058f136-a05c-435d-99e7-d5cd8d209d75&page=queryresults
[0m12:00:28.104123 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 12:00:23.656477 => 12:00:28.104123
[0m12:00:28.105115 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B81FD8B0>]}
[0m12:00:28.105910 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 56.7 KiB processed)[0m in 4.46s]
[0m12:00:28.106617 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m12:00:28.107685 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m12:00:28.108694 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m12:00:28.109896 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m12:00:28.111026 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m12:00:28.115626 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m12:00:28.116507 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 12:00:28.111026 => 12:00:28.116507
[0m12:00:28.116507 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m12:00:28.119628 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:28.728187 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m12:00:28.730190 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

select *
    from cte_join_campos_customizados
  order by nm_produto_completo
    );
  
[0m12:00:29.417783 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d8ebca36-31fd-4de8-a5c5-a8f6ff9671a6&page=queryresults
[0m12:00:31.965235 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 12:00:28.117634 => 12:00:31.965235
[0m12:00:31.965235 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B929BA60>]}
[0m12:00:31.965235 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 93.1 KiB processed)[0m in 3.86s]
[0m12:00:31.965235 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m12:00:31.965235 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m12:00:31.965235 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m12:00:31.965235 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m12:00:31.965235 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m12:00:31.965235 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m12:00:31.965235 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 12:00:31.965235 => 12:00:31.965235
[0m12:00:31.981437 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m12:00:31.984277 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:32.650199 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m12:00:32.653142 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m12:00:33.262133 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:321714c2-fbfe-466f-a172-f4da9cf0c29d&page=queryresults
[0m12:00:35.259849 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 12:00:31.981437 => 12:00:35.259849
[0m12:00:35.261853 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '420b8252-6b45-49c3-b6c8-3892ffa7a703', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B930DAC0>]}
[0m12:00:35.262849 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.30s]
[0m12:00:35.264849 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m12:00:35.268884 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:00:35.268884 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:00:35.270908 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:00:35.270908 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m12:00:35.272928 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m12:00:35.272928 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m12:00:35.274947 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m12:00:35.274947 [info ] [MainThread]: 
[0m12:00:35.274947 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 17.18 seconds (17.18s).
[0m12:00:35.274947 [debug] [MainThread]: Command end result
[0m12:00:35.285044 [info ] [MainThread]: 
[0m12:00:35.285044 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:00:35.298033 [info ] [MainThread]: 
[0m12:00:35.298033 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m12:00:35.303727 [debug] [MainThread]: Command `dbt run` succeeded at 12:00:35.302960 after 21.58 seconds
[0m12:00:35.303727 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B4849430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B7EC2550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F9B7F87FA0>]}
[0m12:00:35.303727 [debug] [MainThread]: Flushing usage events
[0m12:03:56.623849 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292F8DF03D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292F7D942E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292F7D94760>]}


============================== 12:03:56.627548 | 03de64f8-d280-4eae-9be7-1e2b3f0fd587 ==============================
[0m12:03:56.627548 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:03:56.629673 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --models stg_produto+', 'send_anonymous_usage_stats': 'True'}
[0m12:03:57.077329 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FAF5BAF0>]}
[0m12:03:57.137221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FB75E4C0>]}
[0m12:03:57.137221 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:03:57.147271 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:03:57.237534 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 3 files changed.
[0m12:03:57.237534 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\1.stg\stg_produto.sql
[0m12:03:57.237534 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\2.dw\dm_produto.sql
[0m12:03:57.237534 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_produto.sql
[0m12:03:57.347201 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC888970>]}
[0m12:03:57.357309 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC66E7F0>]}
[0m12:03:57.357309 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:03:57.357309 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC66E790>]}
[0m12:03:57.367073 [info ] [MainThread]: 
[0m12:03:57.367073 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:03:57.367073 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:03:57.367073 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:03:57.367073 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:03:57.367073 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:03:58.231968 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:03:58.926470 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m12:03:58.927470 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:03:58.957867 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m12:03:58.959339 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:03:59.584527 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m12:03:59.586523 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:04:00.242138 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC89A550>]}
[0m12:04:00.244044 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:04:00.244793 [info ] [MainThread]: 
[0m12:04:00.248964 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m12:04:00.248964 [info ] [Thread-1  ]: 1 of 4 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m12:04:00.248964 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_produto'
[0m12:04:00.256729 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m12:04:00.265757 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m12:04:00.266740 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 12:04:00.256729 => 12:04:00.266740
[0m12:04:00.266740 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m12:04:00.289985 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m12:04:00.289985 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:04:00.289985 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m12:04:01.125252 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b423b073-23f9-471c-9322-a6d298ab6add&page=queryresults
[0m12:04:01.582879 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 12:04:00.267756 => 12:04:01.582879
[0m12:04:01.582879 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FD937FD0>]}
[0m12:04:01.584069 [info ] [Thread-1  ]: 1 of 4 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m12:04:01.584069 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m12:04:01.585119 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m12:04:01.585119 [info ] [Thread-2  ]: 2 of 4 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m12:04:01.586965 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.dm_produto'
[0m12:04:01.586965 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m12:04:01.590038 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m12:04:01.590738 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 12:04:01.586965 => 12:04:01.590738
[0m12:04:01.590738 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m12:04:01.599623 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m12:04:02.225702 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m12:04:02.225702 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m12:04:03.007608 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:388d6bac-1654-4394-ae58-3955c07b22ed&page=queryresults
[0m12:04:05.629170 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 12:04:01.590738 => 12:04:05.629170
[0m12:04:05.629170 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC890D60>]}
[0m12:04:05.629170 [info ] [Thread-2  ]: 2 of 4 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.04s]
[0m12:04:05.629170 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m12:04:05.629170 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m12:04:05.629170 [info ] [Thread-1  ]: 3 of 4 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m12:04:05.629170 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m12:04:05.629170 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m12:04:05.651270 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m12:04:05.654505 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 12:04:05.629170 => 12:04:05.653262
[0m12:04:05.656522 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m12:04:05.662524 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:04:06.268953 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m12:04:06.268953 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

select *
    from cte_join_campos_customizados
  order by nm_produto_completo
    );
  
[0m12:04:06.887920 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4c70fe92-e195-4640-a822-0c9051ae5d71&page=queryresults
[0m12:04:09.448656 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 12:04:05.658532 => 12:04:09.448656
[0m12:04:09.448656 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FD8E8AC0>]}
[0m12:04:09.461010 [info ] [Thread-1  ]: 3 of 4 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.4 MiB processed)[0m in 3.82s]
[0m12:04:09.461010 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m12:04:09.464169 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m12:04:09.464169 [info ] [Thread-2  ]: 4 of 4 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m12:04:09.464169 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m12:04:09.468602 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m12:04:09.474309 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m12:04:09.475708 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 12:04:09.468602 => 12:04:09.475708
[0m12:04:09.478089 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m12:04:09.484531 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:04:10.354963 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m12:04:10.356117 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m12:04:10.982093 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:54a82f4d-a93e-4d46-a20b-247537e2251d&page=queryresults
[0m12:04:13.262969 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 12:04:09.479250 => 12:04:13.262969
[0m12:04:13.264986 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03de64f8-d280-4eae-9be7-1e2b3f0fd587', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC8C8760>]}
[0m12:04:13.267003 [info ] [Thread-2  ]: 4 of 4 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.80s]
[0m12:04:13.267003 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m12:04:13.267003 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:04:13.267003 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:04:13.267003 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:04:13.274819 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m12:04:13.274819 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m12:04:13.274819 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m12:04:13.274819 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m12:04:13.274819 [info ] [MainThread]: 
[0m12:04:13.274819 [info ] [MainThread]: Finished running 1 view model, 3 table models in 0 hours 0 minutes and 15.91 seconds (15.91s).
[0m12:04:13.282308 [debug] [MainThread]: Command end result
[0m12:04:13.340762 [info ] [MainThread]: 
[0m12:04:13.342174 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:04:13.344355 [info ] [MainThread]: 
[0m12:04:13.346577 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m12:04:13.352025 [debug] [MainThread]: Command `dbt run` succeeded at 12:04:13.351030 after 16.79 seconds
[0m12:04:13.354074 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292F8DF03D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC54B6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000292FC72BE80>]}
[0m12:04:13.355078 [debug] [MainThread]: Flushing usage events
[0m13:00:16.401161 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964BAF3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964AA6C9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964AA6CD30>]}


============================== 13:00:16.416901 | 3b1a7040-2923-45d9-a2cc-da3972883190 ==============================
[0m13:00:16.416901 [info ] [MainThread]: Running with dbt=1.7.4
[0m13:00:16.416901 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m13:00:17.737462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964DC3DAC0>]}
[0m13:00:17.848612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F1616D0>]}
[0m13:00:17.854916 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m13:00:17.897785 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m13:00:21.294909 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:00:21.294909 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:00:21.294909 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F3F8B80>]}
[0m13:00:21.354898 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F3E67F0>]}
[0m13:00:21.354898 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m13:00:21.354898 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F3E6790>]}
[0m13:00:21.354898 [info ] [MainThread]: 
[0m13:00:21.354898 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:00:21.370756 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:00:21.370756 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:21.370756 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:00:21.370756 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:22.315392 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:23.018603 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m13:00:23.018603 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m13:00:23.018603 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:23.018603 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:23.686958 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m13:00:23.702688 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:24.358956 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F476EE0>]}
[0m13:00:24.358956 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:00:24.358956 [info ] [MainThread]: 
[0m13:00:24.358956 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:24.358956 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m13:00:24.358956 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m13:00:24.374957 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m13:00:24.374957 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m13:00:24.374957 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:24.374957 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m13:00:24.391039 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m13:00:24.391039 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m13:00:24.391039 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m13:00:24.391039 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 13:00:24.374957 => 13:00:24.391039
[0m13:00:24.406900 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:24.406900 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 13:00:24.391039 => 13:00:24.406900
[0m13:00:24.454746 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m13:00:24.454746 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m13:00:24.470834 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m13:00:24.470834 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m13:00:24.470834 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m13:00:24.502370 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m13:00:24.518099 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m13:00:25.367941 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fc9ee004-71fb-4b5b-b2ff-0ae234dc32bb&page=queryresults
[0m13:00:25.383826 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:19790341-a715-4281-986f-f2cd427470f9&page=queryresults
[0m13:00:25.847008 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 13:00:24.406900 => 13:00:25.847008
[0m13:00:25.862939 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 13:00:24.454746 => 13:00:25.862939
[0m13:00:25.862939 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F0E5B80>]}
[0m13:00:25.862939 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F47ED00>]}
[0m13:00:25.862939 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.49s]
[0m13:00:25.862939 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:25.862939 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.49s]
[0m13:00:25.862939 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m13:00:25.862939 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m13:00:25.862939 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m13:00:25.862939 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m13:00:25.862939 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m13:00:25.862939 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m13:00:25.862939 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m13:00:25.862939 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m13:00:25.862939 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m13:00:25.862939 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m13:00:25.862939 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m13:00:25.878646 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 13:00:25.862939 => 13:00:25.878646
[0m13:00:25.862939 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 13:00:25.862939 => 13:00:25.862939
[0m13:00:25.878646 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m13:00:25.878646 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m13:00:25.878646 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m13:00:25.884518 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m13:00:25.884518 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:25.884518 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:25.884518 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m13:00:25.910887 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m13:00:26.716177 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9c52a665-010d-409c-80df-86a4771a9edc&page=queryresults
[0m13:00:26.893376 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:71abef9e-3a2b-48d5-87fc-c2e006435bcb&page=queryresults
[0m13:00:27.173478 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 13:00:25.882508 => 13:00:27.171461
[0m13:00:27.173478 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F4A1760>]}
[0m13:00:27.175489 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m13:00:27.177504 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m13:00:27.177504 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m13:00:27.180325 [info ] [Thread-2  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m13:00:27.181342 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m13:00:27.183360 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m13:00:27.199279 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m13:00:27.208198 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 13:00:27.183360 => 13:00:27.208198
[0m13:00:27.208198 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m13:00:27.235351 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:27.310611 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 13:00:25.878646 => 13:00:27.310611
[0m13:00:27.312629 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F48B2E0>]}
[0m13:00:27.312629 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m13:00:27.312629 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m13:00:27.964305 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m13:00:27.964305 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m13:00:28.655449 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:43112fa6-1a6e-4610-b4e6-1b679528aa9c&page=queryresults
[0m13:00:31.171559 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 13:00:27.208198 => 13:00:31.171559
[0m13:00:31.173073 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F4A16A0>]}
[0m13:00:31.175086 [info ] [Thread-2  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 3.99s]
[0m13:00:31.175086 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m13:00:31.177974 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m13:00:31.177974 [info ] [Thread-1  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m13:00:31.177974 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.tb_produto)
[0m13:00:31.177974 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m13:00:31.177974 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m13:00:31.188989 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 13:00:31.177974 => 13:00:31.188989
[0m13:00:31.188989 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m13:00:31.193333 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:31.875183 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m13:00:31.875183 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

select *
    from cte_join_campos_customizados
  order by nm_produto_completo
    );
  
[0m13:00:32.565499 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:534aeedc-7aee-4af9-a921-b752ccea7cf8&page=queryresults
[0m13:00:35.150754 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 13:00:31.188989 => 13:00:35.150754
[0m13:00:35.152755 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F4A1670>]}
[0m13:00:35.153758 [info ] [Thread-1  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.4 MiB processed)[0m in 3.97s]
[0m13:00:35.155683 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m13:00:35.157964 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m13:00:35.158955 [info ] [Thread-2  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m13:00:35.160961 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m13:00:35.161952 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m13:00:35.165729 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m13:00:35.167827 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 13:00:35.161952 => 13:00:35.166828
[0m13:00:35.167827 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m13:00:35.169827 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:35.785461 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m13:00:35.786656 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m13:00:36.426733 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4cf85e6d-3281-45fa-a0fc-2b575f5e2aa7&page=queryresults
[0m13:00:38.746595 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 13:00:35.167827 => 13:00:38.746595
[0m13:00:38.746595 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3b1a7040-2923-45d9-a2cc-da3972883190', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019650600F10>]}
[0m13:00:38.746595 [info ] [Thread-2  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.59s]
[0m13:00:38.746595 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m13:00:38.746595 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:00:38.746595 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:00:38.746595 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:00:38.746595 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m13:00:38.746595 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m13:00:38.746595 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m13:00:38.746595 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m13:00:38.746595 [info ] [MainThread]: 
[0m13:00:38.755467 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 17.39 seconds (17.39s).
[0m13:00:38.756635 [debug] [MainThread]: Command end result
[0m13:00:38.766761 [info ] [MainThread]: 
[0m13:00:38.766761 [info ] [MainThread]: [32mCompleted successfully[0m
[0m13:00:38.775737 [info ] [MainThread]: 
[0m13:00:38.777092 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m13:00:38.780522 [debug] [MainThread]: Command `dbt run` succeeded at 13:00:38.780003 after 22.56 seconds
[0m13:00:38.780522 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964BAF3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F1EB430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001964F1CDCA0>]}
[0m13:00:38.780522 [debug] [MainThread]: Flushing usage events
[0m14:00:05.384795 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244C043460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244AFBB730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244AFBBE50>]}


============================== 14:00:05.400738 | 16ee36eb-9aec-4cef-aa9e-be4b53bdf21c ==============================
[0m14:00:05.400738 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:00:05.402753 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:00:06.208894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244AFAE340>]}
[0m14:00:06.288127 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F6B0AC0>]}
[0m14:00:06.288127 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m14:00:06.288127 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m14:00:06.336006 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:00:06.336006 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:00:06.336006 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F948F40>]}
[0m14:00:06.357573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F93E190>]}
[0m14:00:06.357573 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m14:00:06.357573 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F93ED90>]}
[0m14:00:06.357573 [info ] [MainThread]: 
[0m14:00:06.357573 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:00:06.357573 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:06.357573 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:06.357573 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:06.357573 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:07.210420 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:07.877413 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m14:00:07.877413 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:07.893297 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m14:00:07.893297 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:08.542896 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m14:00:08.542896 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:09.197322 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F600F70>]}
[0m14:00:09.203052 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:00:09.203052 [info ] [MainThread]: 
[0m14:00:09.213064 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m14:00:09.213064 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:09.213064 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m14:00:09.213064 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m14:00:09.213064 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m14:00:09.213064 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m14:00:09.213064 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m14:00:09.228875 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m14:00:09.244776 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:09.244776 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m14:00:09.244776 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 14:00:09.213064 => 14:00:09.244776
[0m14:00:09.244776 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m14:00:09.276812 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m14:00:09.276812 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 14:00:09.244776 => 14:00:09.276812
[0m14:00:09.276812 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:09.276812 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m14:00:09.276812 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m14:00:09.292996 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m14:00:09.292996 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m14:00:09.324776 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m14:00:10.408722 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7919a253-651f-4282-ad93-2f1339151a0f&page=queryresults
[0m14:00:10.408722 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dae71698-02ff-4843-af76-79004a184bdf&page=queryresults
[0m14:00:10.855830 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 14:00:09.244776 => 14:00:10.855830
[0m14:00:10.855830 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F600F70>]}
[0m14:00:10.855830 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.64s]
[0m14:00:10.855830 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m14:00:10.855830 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m14:00:10.855830 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 14:00:09.276812 => 14:00:10.855830
[0m14:00:10.871590 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F9DB190>]}
[0m14:00:10.855830 [info ] [Thread-2  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m14:00:10.871590 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m14:00:10.871590 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m14:00:10.871590 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m14:00:10.871590 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.64s]
[0m14:00:10.871590 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:10.871590 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m14:00:10.871590 [info ] [Thread-1  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m14:00:10.871590 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 14:00:10.871590 => 14:00:10.871590
[0m14:00:10.871590 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_produto)
[0m14:00:10.871590 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m14:00:10.871590 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m14:00:10.871590 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m14:00:10.887766 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m14:00:10.887766 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 14:00:10.887766 => 14:00:10.887766
[0m14:00:10.887766 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m14:00:10.887766 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m14:00:10.887766 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:10.887766 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m14:00:10.919870 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:10.919870 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m14:00:11.639027 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:16330f00-183f-424b-8dce-3870d8f866fe&page=queryresults
[0m14:00:11.672792 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9f196700-379f-4309-bb01-883d5531993f&page=queryresults
[0m14:00:12.055393 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 14:00:10.871590 => 14:00:12.055393
[0m14:00:12.055393 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000224509F15E0>]}
[0m14:00:12.055393 [info ] [Thread-2  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m14:00:12.055393 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m14:00:12.069961 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 14:00:10.887766 => 14:00:12.069961
[0m14:00:12.069961 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022450A52040>]}
[0m14:00:12.086048 [info ] [Thread-1  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m14:00:12.086048 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m14:00:12.086048 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m14:00:12.086048 [info ] [Thread-2  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m14:00:12.086048 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m14:00:12.086048 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m14:00:12.102044 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m14:00:12.118019 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 14:00:12.086048 => 14:00:12.118019
[0m14:00:12.118019 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m14:00:12.118019 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:12.786015 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m14:00:12.801794 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m14:00:13.503792 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3f99fa70-29be-406a-9be4-877964065d7a&page=queryresults
[0m14:00:17.265985 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 14:00:12.118019 => 14:00:17.265985
[0m14:00:17.268003 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022450AA9790>]}
[0m14:00:17.268003 [info ] [Thread-2  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 5.18s]
[0m14:00:17.269758 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m14:00:17.269758 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m14:00:17.269758 [info ] [Thread-1  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m14:00:17.269758 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m14:00:17.276314 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m14:00:17.280337 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m14:00:17.282346 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 14:00:17.276314 => 14:00:17.280337
[0m14:00:17.282346 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m14:00:17.284356 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:17.906842 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m14:00:17.922596 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

select *
    from cte_join_campos_customizados
  order by nm_produto_completo
    );
  
[0m14:00:18.576719 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:670ba73d-d772-411c-a80d-8a07705b56ba&page=queryresults
[0m14:00:20.835021 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 14:00:17.282346 => 14:00:20.835021
[0m14:00:20.835021 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F9EF550>]}
[0m14:00:20.835021 [info ] [Thread-1  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.4 MiB processed)[0m in 3.57s]
[0m14:00:20.835021 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m14:00:20.850960 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m14:00:20.850960 [info ] [Thread-2  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m14:00:20.850960 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m14:00:20.856509 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m14:00:20.864582 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m14:00:20.866590 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 14:00:20.856509 => 14:00:20.864582
[0m14:00:20.866590 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m14:00:20.868601 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:21.568312 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m14:00:21.568312 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m14:00:22.197553 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4848afb2-870d-4f93-a95b-cbab9794812d&page=queryresults
[0m14:00:24.432497 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 14:00:20.866590 => 14:00:24.429462
[0m14:00:24.432497 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '16ee36eb-9aec-4cef-aa9e-be4b53bdf21c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000022450AFC3A0>]}
[0m14:00:24.434509 [info ] [Thread-2  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.58s]
[0m14:00:24.436517 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m14:00:24.436517 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:00:24.440553 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:00:24.440553 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:00:24.440553 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m14:00:24.442572 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m14:00:24.442572 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m14:00:24.444596 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m14:00:24.444596 [info ] [MainThread]: 
[0m14:00:24.444596 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 18.09 seconds (18.09s).
[0m14:00:24.448641 [debug] [MainThread]: Command end result
[0m14:00:24.460791 [info ] [MainThread]: 
[0m14:00:24.460791 [info ] [MainThread]: [32mCompleted successfully[0m
[0m14:00:24.460791 [info ] [MainThread]: 
[0m14:00:24.460791 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m14:00:24.460791 [debug] [MainThread]: Command `dbt run` succeeded at 14:00:24.460791 after 19.14 seconds
[0m14:00:24.460791 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244C043460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F92EF70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002244F5D0040>]}
[0m14:00:24.460791 [debug] [MainThread]: Flushing usage events
[0m15:00:04.591443 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAAA02400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EA9985910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EA9985B80>]}


============================== 15:00:04.607547 | a134a497-19c4-48ab-a40a-44b1b6561f62 ==============================
[0m15:00:04.607547 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:00:04.607547 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:00:05.417028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EA99887C0>]}
[0m15:00:05.472124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EADF43B80>]}
[0m15:00:05.474130 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:00:05.474130 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:00:05.533434 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:00:05.533434 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:00:05.537188 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAE308EB0>]}
[0m15:00:05.545210 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAE2FE0A0>]}
[0m15:00:05.545210 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:00:05.545210 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAE2FE0D0>]}
[0m15:00:05.545210 [info ] [MainThread]: 
[0m15:00:05.545210 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:00:05.551106 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:05.551106 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:05.551106 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:05.551106 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:06.348173 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:07.024787 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m15:00:07.024787 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:00:07.024787 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:07.024787 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:07.658484 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m15:00:07.660502 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:08.451527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EADFCEBE0>]}
[0m15:00:08.451527 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:00:08.451527 [info ] [MainThread]: 
[0m15:00:08.451527 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:08.467267 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m15:00:08.467267 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m15:00:08.467267 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m15:00:08.467267 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m15:00:08.467267 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:08.467267 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m15:00:08.467267 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m15:00:08.467267 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m15:00:08.467267 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m15:00:08.467267 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 15:00:08.467267 => 15:00:08.467267
[0m15:00:08.482993 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 15:00:08.467267 => 15:00:08.482993
[0m15:00:08.482993 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:08.482993 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m15:00:08.498794 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m15:00:08.498794 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m15:00:08.498794 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:00:08.498794 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m15:00:08.530718 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m15:00:08.530718 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m15:00:09.475882 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2156e149-7325-4fe0-a037-b880ea8fb2e6&page=queryresults
[0m15:00:09.493780 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b2937dd0-db1b-45f5-b20b-479fcfaaab9d&page=queryresults
[0m15:00:09.940313 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 15:00:08.482993 => 15:00:09.940313
[0m15:00:09.940313 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EADFCEBE0>]}
[0m15:00:09.956221 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 15:00:08.498794 => 15:00:09.956221
[0m15:00:09.956221 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m15:00:09.956221 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAE39C7C0>]}
[0m15:00:09.956221 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:09.956221 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m15:00:09.956221 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.49s]
[0m15:00:09.956221 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m15:00:09.956221 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m15:00:09.956221 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m15:00:09.956221 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m15:00:09.956221 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m15:00:09.956221 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m15:00:09.956221 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m15:00:09.956221 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m15:00:09.956221 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m15:00:09.956221 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m15:00:09.956221 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 15:00:09.956221 => 15:00:09.956221
[0m15:00:09.956221 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m15:00:09.956221 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m15:00:09.972247 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 15:00:09.956221 => 15:00:09.972247
[0m15:00:09.972247 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m15:00:09.972247 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m15:00:09.972247 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:09.972247 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:09.972247 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m15:00:09.988296 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m15:00:10.728935 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0220cc8e-7593-43a3-8820-1c119b677761&page=queryresults
[0m15:00:10.777637 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0428e925-ab56-4fe9-bba8-63fd9700a281&page=queryresults
[0m15:00:11.163325 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 15:00:09.956221 => 15:00:11.163325
[0m15:00:11.163325 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAE0A4940>]}
[0m15:00:11.163325 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m15:00:11.163325 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m15:00:11.221942 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 15:00:09.972247 => 15:00:11.221942
[0m15:00:11.221942 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAF397910>]}
[0m15:00:11.221942 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m15:00:11.221942 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m15:00:11.221942 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m15:00:11.221942 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m15:00:11.221942 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m15:00:11.237938 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m15:00:11.237938 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m15:00:11.237938 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 15:00:11.237938 => 15:00:11.237938
[0m15:00:11.254040 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m15:00:11.269732 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:11.910247 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m15:00:11.910247 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m15:00:12.544741 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:eba82d4f-035e-4f25-b946-50b8505a4e5e&page=queryresults
[0m15:00:15.368113 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 15:00:11.254040 => 15:00:15.368113
[0m15:00:15.368113 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAE3ABA30>]}
[0m15:00:15.368113 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.15s]
[0m15:00:15.368113 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m15:00:15.368113 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m15:00:15.368113 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m15:00:15.368113 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m15:00:15.368113 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m15:00:15.368113 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m15:00:15.368113 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 15:00:15.368113 => 15:00:15.368113
[0m15:00:15.368113 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m15:00:15.368113 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:16.035426 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m15:00:16.037436 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

select *
    from cte_join_campos_customizados
  order by nm_produto_completo
    );
  
[0m15:00:16.649284 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8f357ffc-454f-494d-a9c3-f1f03180689f&page=queryresults
[0m15:00:18.941624 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 15:00:15.368113 => 15:00:18.941624
[0m15:00:18.943638 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAE3ABA60>]}
[0m15:00:18.943638 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.4 MiB processed)[0m in 3.57s]
[0m15:00:18.945651 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m15:00:18.945651 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m15:00:18.947406 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m15:00:18.947406 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m15:00:18.949419 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m15:00:18.953444 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m15:00:18.959473 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 15:00:18.949419 => 15:00:18.959473
[0m15:00:18.960892 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m15:00:18.962906 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:19.640329 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m15:00:19.640329 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m15:00:20.224855 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f4dfe7ec-e383-43ec-b483-6f8f557f013f&page=queryresults
[0m15:00:22.393947 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 15:00:18.960892 => 15:00:22.393947
[0m15:00:22.399976 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a134a497-19c4-48ab-a40a-44b1b6561f62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAF3B1820>]}
[0m15:00:22.399976 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.45s]
[0m15:00:22.401988 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m15:00:22.401988 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:00:22.401988 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:00:22.405599 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:00:22.405599 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:00:22.405599 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m15:00:22.405599 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m15:00:22.405599 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m15:00:22.407609 [info ] [MainThread]: 
[0m15:00:22.407609 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 16.86 seconds (16.86s).
[0m15:00:22.409621 [debug] [MainThread]: Command end result
[0m15:00:22.421484 [info ] [MainThread]: 
[0m15:00:22.421484 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:00:22.421484 [info ] [MainThread]: 
[0m15:00:22.421484 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m15:00:22.421484 [debug] [MainThread]: Command `dbt run` succeeded at 15:00:22.421484 after 17.88 seconds
[0m15:00:22.421484 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAAA02400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EADFCE340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019EAE009070>]}
[0m15:00:22.421484 [debug] [MainThread]: Flushing usage events
[0m16:00:04.188096 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217F7603430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217F6583640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217F6583AC0>]}


============================== 16:00:04.197547 | 624326b4-24cc-46fe-8fbe-685e00cb93a1 ==============================
[0m16:00:04.197547 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:00:04.199377 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:00:04.823314 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217F6583850>]}
[0m16:00:04.882669 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FAC6B460>]}
[0m16:00:04.883490 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:00:04.888985 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:00:04.936067 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:00:04.936067 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:00:04.936067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FAF08940>]}
[0m16:00:04.952012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FAD88610>]}
[0m16:00:04.952012 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:00:04.952012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FAD88490>]}
[0m16:00:04.952012 [info ] [MainThread]: 
[0m16:00:04.952012 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:00:04.952012 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:00:04.952012 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:04.970651 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:00:04.970651 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:05.870733 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:06.627078 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:00:06.627078 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:06.627078 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:00:06.627078 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:07.370795 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m16:00:07.370795 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:08.198706 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FACA1880>]}
[0m16:00:08.198706 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:00:08.198706 [info ] [MainThread]: 
[0m16:00:08.207070 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:08.207070 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m16:00:08.207070 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m16:00:08.207070 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m16:00:08.214425 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:08.207070 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m16:00:08.216964 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m16:00:08.226903 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m16:00:08.226903 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m16:00:08.230163 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m16:00:08.230163 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 16:00:08.214425 => 16:00:08.230163
[0m16:00:08.230163 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:08.257083 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m16:00:08.261326 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 16:00:08.226903 => 16:00:08.257083
[0m16:00:08.261326 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m16:00:08.261326 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:00:08.267111 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m16:00:08.267111 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m16:00:08.286963 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m16:00:08.286963 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m16:00:09.136870 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e711f931-71f7-4d8b-8ea6-72516bc7caee&page=queryresults
[0m16:00:09.151972 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:02de3d65-11b8-4948-b403-6a7aac8b3c2b&page=queryresults
[0m16:00:09.580860 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 16:00:08.230163 => 16:00:09.580860
[0m16:00:09.581849 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FACFA7C0>]}
[0m16:00:09.583854 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 16:00:08.261326 => 16:00:09.583854
[0m16:00:09.581849 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m16:00:09.584859 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FACA1880>]}
[0m16:00:09.584859 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:09.585850 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m16:00:09.584859 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m16:00:09.587119 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m16:00:09.586796 [info ] [Thread-1  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m16:00:09.587119 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m16:00:09.588187 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m16:00:09.588187 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m16:00:09.588187 [info ] [Thread-2  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m16:00:09.591180 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m16:00:09.591180 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_produto)
[0m16:00:09.592187 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m16:00:09.594180 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m16:00:09.595126 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 16:00:09.589180 => 16:00:09.594180
[0m16:00:09.595126 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m16:00:09.597700 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m16:00:09.598904 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 16:00:09.592187 => 16:00:09.598904
[0m16:00:09.598904 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m16:00:09.601237 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m16:00:09.602179 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:09.603546 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m16:00:09.630991 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:09.633968 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m16:00:10.337601 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5604f0fe-1edd-4ee3-9f12-8fafc3165f24&page=queryresults
[0m16:00:10.487279 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b791504f-753a-4d8a-afb6-9803e95c047a&page=queryresults
[0m16:00:10.747005 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 16:00:09.595126 => 16:00:10.747005
[0m16:00:10.747005 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FBFACCD0>]}
[0m16:00:10.747005 [info ] [Thread-1  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m16:00:10.747005 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m16:00:10.926716 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 16:00:09.598904 => 16:00:10.926716
[0m16:00:10.926716 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FBF9F730>]}
[0m16:00:10.931880 [info ] [Thread-2  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m16:00:10.931880 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m16:00:10.931880 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m16:00:10.931880 [info ] [Thread-1  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m16:00:10.936982 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m16:00:10.936982 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m16:00:10.946843 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m16:00:10.946843 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 16:00:10.938092 => 16:00:10.946843
[0m16:00:10.946843 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m16:00:10.957054 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:11.886987 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m16:00:11.891827 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m16:00:12.517355 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ed0ce6a8-a610-4db8-a22b-91653b0f43b5&page=queryresults
[0m16:00:15.067042 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 16:00:10.946843 => 16:00:15.067042
[0m16:00:15.067042 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FAFAFBE0>]}
[0m16:00:15.067042 [info ] [Thread-1  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.14s]
[0m16:00:15.067042 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m16:00:15.067042 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m16:00:15.073147 [info ] [Thread-2  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m16:00:15.073147 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m16:00:15.075933 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m16:00:15.079095 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m16:00:15.081106 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 16:00:15.075933 => 16:00:15.081106
[0m16:00:15.081106 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m16:00:15.083116 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:16.017239 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m16:00:16.023294 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

select *
    from cte_join_campos_customizados
  order by nm_produto_completo
    );
  
[0m16:00:16.620030 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:32887400-4f2c-4cf9-a4b9-33603fb7f5b3&page=queryresults
[0m16:00:19.389470 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 16:00:15.081106 => 16:00:19.387456
[0m16:00:19.389470 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FAFAFFD0>]}
[0m16:00:19.391481 [info ] [Thread-2  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.4 MiB processed)[0m in 4.32s]
[0m16:00:19.391481 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m16:00:19.393491 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m16:00:19.393491 [info ] [Thread-1  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m16:00:19.393491 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m16:00:19.395503 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m16:00:19.399526 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m16:00:19.406564 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 16:00:19.395503 => 16:00:19.404553
[0m16:00:19.406564 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m16:00:19.408576 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:20.303805 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m16:00:20.306838 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m16:00:20.875004 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:65268a8a-8c52-4441-9f81-bc40d18d462c&page=queryresults
[0m16:00:23.141003 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 16:00:19.406564 => 16:00:23.138984
[0m16:00:23.141003 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '624326b4-24cc-46fe-8fbe-685e00cb93a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FC0BED30>]}
[0m16:00:23.143020 [info ] [Thread-1  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 3.75s]
[0m16:00:23.144034 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m16:00:23.144034 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:00:23.149077 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:00:23.149077 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:00:23.149077 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m16:00:23.149077 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:00:23.149077 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m16:00:23.149077 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m16:00:23.149077 [info ] [MainThread]: 
[0m16:00:23.149077 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 18.20 seconds (18.20s).
[0m16:00:23.149077 [debug] [MainThread]: Command end result
[0m16:00:23.172318 [info ] [MainThread]: 
[0m16:00:23.173557 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:00:23.175579 [info ] [MainThread]: 
[0m16:00:23.175579 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m16:00:23.177608 [debug] [MainThread]: Command `dbt run` succeeded at 16:00:23.177608 after 19.08 seconds
[0m16:00:23.179627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217F7603430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FAC89FD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000217FABF4B20>]}
[0m16:00:23.179627 [debug] [MainThread]: Flushing usage events
[0m17:00:04.233165 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB5ECB3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB5DC33640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB5DC33AC0>]}


============================== 17:00:04.237706 | 0b6fe523-86b8-4238-b507-746dbcbd5530 ==============================
[0m17:00:04.237706 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:00:04.237706 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --profiles-dir C:\\Git\\sb_loja_virtual', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m17:00:04.848930 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB621EEEE0>]}
[0m17:00:04.921663 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB622144C0>]}
[0m17:00:04.923191 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:00:04.929839 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:00:04.998060 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m17:00:04.999568 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_produto.sql
[0m17:00:05.129919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB62664E80>]}
[0m17:00:05.142160 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB625A92B0>]}
[0m17:00:05.143745 [info ] [MainThread]: Found 7 models, 7 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:00:05.145796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB625A9130>]}
[0m17:00:05.149800 [info ] [MainThread]: 
[0m17:00:05.150805 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:00:05.153368 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:05.153368 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:05.155442 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:05.156436 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:06.180468 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:06.887761 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:00:06.889817 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:06.943656 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:00:06.945867 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:07.644855 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m17:00:07.649547 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:08.353343 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB6236A280>]}
[0m17:00:08.356037 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:00:08.358508 [info ] [MainThread]: 
[0m17:00:08.372173 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:08.373691 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.376812 [info ] [Thread-1  ]: 1 of 7 START sql view model dbt_dw_stg.stg_campo_customizado_produto ........... [RUN]
[0m17:00:08.388463 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m17:00:08.397816 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:08.395756 [info ] [Thread-2  ]: 2 of 7 START sql view model dbt_dw_stg.stg_categoria_produto ................... [RUN]
[0m17:00:08.433306 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m17:00:08.437151 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m17:00:08.439140 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.449225 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m17:00:08.451252 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 17:00:08.398810 => 17:00:08.450250
[0m17:00:08.453263 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:08.489466 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m17:00:08.490493 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 17:00:08.441201 => 17:00:08.490493
[0m17:00:08.491470 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.492989 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m17:00:08.494577 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:00:08.495606 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:00:08.499608 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3435246', ds_valor_campo, null)) as fg_ajuste_preco
        ,max(if(cd_campo_customizado = '3435249', cd_valor, null))       as dt_ajuste_preco
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,fg_ajuste_preco
        ,replace(dt_ajuste_preco, '/', '-') dt_ajuste_preco
   from cte_campo_base;


[0m17:00:08.533297 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m17:00:09.721589 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f0798acc-a942-4d7f-b1e6-aacde15e9cf5&page=queryresults
[0m17:00:09.736500 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5d763c27-d4f3-4a7f-820a-dc9db64f4b44&page=queryresults
[0m17:00:10.180516 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 17:00:08.491470 => 17:00:10.179515
[0m17:00:10.180516 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB623401F0>]}
[0m17:00:10.181516 [info ] [Thread-2  ]: 2 of 7 OK created sql view model dbt_dw_stg.stg_categoria_produto .............. [[32mCREATE VIEW (0 processed)[0m in 1.75s]
[0m17:00:10.183041 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m17:00:10.183041 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m17:00:10.183041 [info ] [Thread-2  ]: 3 of 7 START sql view model dbt_dw_stg.stg_composicao_produto .................. [RUN]
[0m17:00:10.184662 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m17:00:10.185710 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m17:00:10.189706 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m17:00:10.191695 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 17:00:08.454224 => 17:00:10.191695
[0m17:00:10.193209 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB6273C9A0>]}
[0m17:00:10.193209 [info ] [Thread-1  ]: 1 of 7 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ...... [[32mCREATE VIEW (0 processed)[0m in 1.81s]
[0m17:00:10.194875 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:10.194875 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m17:00:10.195900 [info ] [Thread-1  ]: 4 of 7 START sql view model dbt_dw_stg.stg_produto ............................. [RUN]
[0m17:00:10.197895 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 17:00:10.185710 => 17:00:10.196893
[0m17:00:10.198902 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_produto)
[0m17:00:10.198902 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m17:00:10.199905 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m17:00:10.206454 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m17:00:10.215003 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m17:00:10.219552 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 17:00:10.207454 => 17:00:10.218554
[0m17:00:10.221548 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:10.223066 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m17:00:10.228264 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m17:00:10.232271 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m17:00:10.261015 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:10.263531 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m17:00:11.023286 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:94fea64d-1a2b-45d4-b459-f1f019f0622f&page=queryresults
[0m17:00:11.028908 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:98521dc3-f27c-4f3b-a92d-206ab6576098&page=queryresults
[0m17:00:11.423127 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 17:00:10.199905 => 17:00:11.421608
[0m17:00:11.424767 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB5DC33700>]}
[0m17:00:11.425781 [info ] [Thread-2  ]: 3 of 7 OK created sql view model dbt_dw_stg.stg_composicao_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m17:00:11.427794 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m17:00:11.433370 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 17:00:10.229273 => 17:00:11.433370
[0m17:00:11.433370 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB6277D4F0>]}
[0m17:00:11.435132 [info ] [Thread-1  ]: 4 of 7 OK created sql view model dbt_dw_stg.stg_produto ........................ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m17:00:11.436142 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m17:00:11.437145 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m17:00:11.439432 [info ] [Thread-2  ]: 5 of 7 START sql table model dbt_dw_dw.dm_produto .............................. [RUN]
[0m17:00:11.442453 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.dm_produto)
[0m17:00:11.443454 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m17:00:11.448938 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m17:00:11.449957 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 17:00:11.443454 => 17:00:11.449957
[0m17:00:11.450940 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m17:00:11.458703 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:12.148667 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m17:00:12.149659 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variações
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variação e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m17:00:12.955623 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a718562c-2bd7-412c-afdf-3346d4631374&page=queryresults
[0m17:00:16.130286 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 17:00:11.450940 => 17:00:16.128800
[0m17:00:16.133469 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB63788130>]}
[0m17:00:16.136017 [info ] [Thread-2  ]: 5 of 7 OK created sql table model dbt_dw_dw.dm_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.3 MiB processed)[0m in 4.69s]
[0m17:00:16.140085 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m17:00:16.143612 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m17:00:16.145687 [info ] [Thread-1  ]: 6 of 7 START sql table model dbt_dw_az.tb_produto .............................. [RUN]
[0m17:00:16.148683 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.tb_produto)
[0m17:00:16.150498 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m17:00:16.162060 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m17:00:16.163062 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 17:00:16.150498 => 17:00:16.162060
[0m17:00:16.163582 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m17:00:16.165666 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:16.800174 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m17:00:16.802193 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,fg_ajuste_preco
          ,dt_ajuste_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_join_campos_customizados as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.fg_ajuste_preco
          ,b.dt_ajuste_preco
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling     
)

  select *
    from cte_join_campos_customizados
order by nm_produto_completo
    );
  
[0m17:00:17.481644 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5f4302c0-b2a3-46a8-9eff-700b59e98608&page=queryresults
[0m17:00:20.040294 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 17:00:16.163582 => 17:00:20.038658
[0m17:00:20.041169 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB63784BE0>]}
[0m17:00:20.043261 [info ] [Thread-1  ]: 6 of 7 OK created sql table model dbt_dw_az.tb_produto ......................... [[32mCREATE TABLE (346.0 rows, 1.4 MiB processed)[0m in 3.89s]
[0m17:00:20.044792 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m17:00:20.045791 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m17:00:20.045791 [info ] [Thread-2  ]: 7 of 7 START sql table model dbt_dw_az.tb_composicao_produto ................... [RUN]
[0m17:00:20.047811 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m17:00:20.048794 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m17:00:20.055044 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m17:00:20.056056 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 17:00:20.049788 => 17:00:20.056056
[0m17:00:20.057057 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m17:00:20.060052 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:21.073303 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m17:00:21.076051 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai

          ,b.cd_produto_bling_componente

          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m17:00:21.642186 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fafbf092-6512-452e-80e4-7f27166911ad&page=queryresults
[0m17:00:24.230741 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 17:00:20.057057 => 17:00:24.229697
[0m17:00:24.233286 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0b6fe523-86b8-4238-b507-746dbcbd5530', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB637BC6A0>]}
[0m17:00:24.235950 [info ] [Thread-2  ]: 7 of 7 OK created sql table model dbt_dw_az.tb_composicao_produto .............. [[32mCREATE TABLE (233.0 rows, 105.2 KiB processed)[0m in 4.19s]
[0m17:00:24.238951 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m17:00:24.245102 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:00:24.247055 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:00:24.248049 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:00:24.250064 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m17:00:24.251054 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m17:00:24.252054 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_produto' was properly closed.
[0m17:00:24.253050 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_composicao_produto' was properly closed.
[0m17:00:24.253567 [info ] [MainThread]: 
[0m17:00:24.255650 [info ] [MainThread]: Finished running 4 view models, 3 table models in 0 hours 0 minutes and 19.10 seconds (19.10s).
[0m17:00:24.257606 [debug] [MainThread]: Command end result
[0m17:00:24.277810 [info ] [MainThread]: 
[0m17:00:24.278854 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:00:24.279936 [info ] [MainThread]: 
[0m17:00:24.280808 [info ] [MainThread]: Done. PASS=7 WARN=0 ERROR=0 SKIP=0 TOTAL=7
[0m17:00:24.281793 [debug] [MainThread]: Command `dbt run` succeeded at 17:00:24.281793 after 20.11 seconds
[0m17:00:24.281793 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB5ECB3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB623E0370>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DB625C5B50>]}
[0m17:00:24.281793 [debug] [MainThread]: Flushing usage events
