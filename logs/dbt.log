[0m03:00:35.884244 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3f5dcbde-3618-4294-be1d-351424c8da5c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C45B25E7F0>]}
[0m03:00:35.889161 [info ] [Thread-2  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.03s]
[0m03:00:35.891148 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m03:00:35.893150 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m03:00:35.894148 [info ] [Thread-2  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m03:00:35.895200 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m03:00:35.896259 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m03:00:35.902243 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m03:00:35.904187 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 03:00:35.897259 => 03:00:35.903246
[0m03:00:35.904187 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m03:00:35.919248 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:36.569665 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m03:00:36.571664 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m03:00:36.966954 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1823e327-cc62-4f0c-8ae3-a508978c2ed0&page=queryresults
[0m03:00:37.999546 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 03:00:34.428570 => 03:00:37.999546
[0m03:00:38.000547 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3f5dcbde-3618-4294-be1d-351424c8da5c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C45C3261C0>]}
[0m03:00:38.001548 [info ] [Thread-1  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 3.58s]
[0m03:00:38.003547 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m03:00:38.004501 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m03:00:38.005596 [info ] [Thread-1  ]: 22 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m03:00:38.006670 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m03:00:38.006670 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m03:00:38.092868 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m03:00:38.093852 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 03:00:38.007705 => 03:00:38.092868
[0m03:00:38.093852 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m03:00:38.095868 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:38.720970 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m03:00:38.722855 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m03:00:38.897126 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 03:00:35.905240 => 03:00:38.896121
[0m03:00:38.899119 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3f5dcbde-3618-4294-be1d-351424c8da5c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C45C2F2340>]}
[0m03:00:38.900222 [info ] [Thread-2  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.2 KiB processed)[0m in 3.00s]
[0m03:00:38.902219 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m03:00:38.904193 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m03:00:38.904193 [info ] [Thread-2  ]: 23 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m03:00:38.906124 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m03:00:38.907124 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m03:00:38.913221 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m03:00:38.915223 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 03:00:38.907124 => 03:00:38.915223
[0m03:00:38.916221 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m03:00:38.919228 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:39.330221 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c527cd89-19e7-4b45-9d72-2855354cd2a1&page=queryresults
[0m03:00:39.583336 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m03:00:39.585348 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m03:00:39.969400 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cd4a7421-ba8e-468b-b73c-bc380bce1321&page=queryresults
[0m03:00:41.931732 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 03:00:38.916221 => 03:00:41.931732
[0m03:00:41.932728 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3f5dcbde-3618-4294-be1d-351424c8da5c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C459CECD90>]}
[0m03:00:41.934727 [info ] [Thread-2  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.3 KiB processed)[0m in 3.03s]
[0m03:00:41.936551 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m03:00:41.938550 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m03:00:41.939555 [info ] [Thread-2  ]: 24 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m03:00:41.940442 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m03:00:41.941553 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m03:00:41.950539 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m03:00:41.952539 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 03:00:41.942539 => 03:00:41.952539
[0m03:00:41.953543 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m03:00:41.960682 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:42.129332 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 03:00:38.093852 => 03:00:42.129332
[0m03:00:42.131955 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3f5dcbde-3618-4294-be1d-351424c8da5c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C459D3C6A0>]}
[0m03:00:42.611590 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m03:00:42.614488 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m03:00:42.851646 [info ] [Thread-1  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 4.13s]
[0m03:00:42.853653 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m03:00:42.855719 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m03:00:42.856756 [info ] [Thread-1  ]: 25 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m03:00:42.857650 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m03:00:42.858745 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m03:00:42.865746 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m03:00:42.867648 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 03:00:42.858745 => 03:00:42.866748
[0m03:00:42.867648 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m03:00:42.870758 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m03:00:43.087080 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:386c9600-e618-4ef1-9a98-4fa1a954d73c&page=queryresults
[0m03:00:43.828120 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m03:00:43.830120 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m03:00:44.410142 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1358bf4a-a092-4519-ae31-a9f063605b7e&page=queryresults
[0m03:00:45.663813 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 03:00:41.953543 => 03:00:45.663813
[0m03:00:45.664798 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3f5dcbde-3618-4294-be1d-351424c8da5c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C45B0F0430>]}
[0m03:00:45.665795 [info ] [Thread-2  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 3.72s]
[0m03:00:45.667707 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m03:00:45.668763 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m03:00:45.668763 [info ] [Thread-2  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m03:00:45.670706 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m03:00:45.670706 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m03:00:45.676705 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m03:00:45.677706 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 03:00:45.670706 => 03:00:45.677706
[0m03:00:45.678704 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m03:00:45.681702 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m03:00:46.312859 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m03:00:46.315762 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m03:00:46.894071 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 03:00:42.867648 => 03:00:46.893090
[0m03:00:46.896084 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3f5dcbde-3618-4294-be1d-351424c8da5c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C45B21FBB0>]}
[0m03:00:46.897082 [info ] [Thread-1  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 4.04s]
[0m03:00:46.899082 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m03:00:46.901081 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d80ddf8d-19bf-4d84-b465-7a98fcb7f3c6&page=queryresults
[0m03:00:50.113673 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 03:00:45.678704 => 03:00:50.112672
[0m03:00:50.116673 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3f5dcbde-3618-4294-be1d-351424c8da5c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C45B0F7DF0>]}
[0m03:00:50.117781 [info ] [Thread-2  ]: 26 of 26 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 4.45s]
[0m03:00:50.119674 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m03:00:50.123260 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:00:50.124261 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:00:50.125261 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:00:50.125261 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m03:00:50.126259 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m03:00:50.126259 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m03:00:50.127257 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto_base' was properly closed.
[0m03:00:50.127257 [info ] [MainThread]: 
[0m03:00:50.128414 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 42.96 seconds (42.96s).
[0m03:00:50.135506 [debug] [MainThread]: Command end result
[0m03:00:50.169368 [info ] [MainThread]: 
[0m03:00:50.170371 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:00:50.172056 [info ] [MainThread]: 
[0m03:00:50.173244 [info ] [MainThread]: Done. PASS=26 WARN=0 ERROR=0 SKIP=0 TOTAL=26
[0m03:00:50.175540 [debug] [MainThread]: Command `dbt run` succeeded at 03:00:50.175540 after 44.07 seconds
[0m03:00:50.176538 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C4566F3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C459C34D00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002C459CECD90>]}
[0m03:00:50.176538 [debug] [MainThread]: Flushing usage events
[0m03:00:54.317625 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAD4D34C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAC4542E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAC454760>]}


============================== 03:00:54.325627 | 9863373f-a31e-4e5f-a379-6432e1348df4 ==============================
[0m03:00:54.325627 [info ] [MainThread]: Running with dbt=1.7.4
[0m03:00:54.326632 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt snapshot', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m03:00:55.147987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9863373f-a31e-4e5f-a379-6432e1348df4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAF61DC10>]}
[0m03:00:55.205068 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9863373f-a31e-4e5f-a379-6432e1348df4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AB0A61160>]}
[0m03:00:55.206633 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m03:00:55.214769 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m03:00:55.268734 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m03:00:55.268734 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m03:00:55.273733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9863373f-a31e-4e5f-a379-6432e1348df4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AB0E36190>]}
[0m03:00:55.287683 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9863373f-a31e-4e5f-a379-6432e1348df4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AB0D4BFD0>]}
[0m03:00:55.288677 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m03:00:55.289678 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9863373f-a31e-4e5f-a379-6432e1348df4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AB0D4B1C0>]}
[0m03:00:55.291679 [info ] [MainThread]: 
[0m03:00:55.292716 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m03:00:55.294718 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:00:55.294718 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:56.244333 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m03:00:56.246331 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m03:00:56.247329 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:56.248333 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:00:56.870660 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m03:00:56.872680 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:56.917981 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m03:00:56.919980 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:00:57.532530 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9863373f-a31e-4e5f-a379-6432e1348df4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AB0A5F520>]}
[0m03:00:57.534531 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m03:00:57.535482 [info ] [MainThread]: 
[0m03:00:57.543436 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m03:00:57.544434 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m03:00:57.546437 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m03:00:57.547436 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m03:00:57.562484 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 03:00:57.548435 => 03:00:57.561545
[0m03:00:57.562484 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m03:00:57.611682 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m03:00:57.612681 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m03:00:58.478549 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:80994c34-cf74-40b6-a84f-4ac3691907a4&page=queryresults
[0m03:00:59.565014 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m03:01:00.009061 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cac642c5-08ce-4f6a-a56d-02eb1b3736e5&page=queryresults
[0m03:01:02.740833 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m03:01:03.489472 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m03:01:03.491486 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m03:01:03.889536 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d87d27e7-a0eb-4c87-a751-9a2f88631d6d&page=queryresults
[0m03:01:05.854246 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 03:00:57.562484 => 03:01:05.854246
[0m03:01:05.856242 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9863373f-a31e-4e5f-a379-6432e1348df4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AB1EDB280>]}
[0m03:01:05.858239 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 96.0 KiB processed)[0m in 8.31s]
[0m03:01:05.859883 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m03:01:05.863989 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:01:05.865020 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:01:05.866037 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m03:01:05.866037 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m03:01:05.867032 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m03:01:05.867032 [info ] [MainThread]: 
[0m03:01:05.868032 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.58 seconds (10.58s).
[0m03:01:05.870135 [debug] [MainThread]: Command end result
[0m03:01:05.894033 [info ] [MainThread]: 
[0m03:01:05.895031 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:01:05.896139 [info ] [MainThread]: 
[0m03:01:05.898140 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m03:01:05.900132 [debug] [MainThread]: Command `dbt snapshot` succeeded at 03:01:05.899092 after 11.64 seconds
[0m03:01:05.901141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AAD4D34C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AB0A61160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016AB0AB0550>]}
[0m03:01:05.902130 [debug] [MainThread]: Flushing usage events
[0m03:01:09.901869 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024028467460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000240273F09A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000240273F0D30>]}


============================== 03:01:09.909790 | dd3e5ad6-b71d-4111-b9ef-bfe6d9d1e535 ==============================
[0m03:01:09.909790 [info ] [MainThread]: Running with dbt=1.7.4
[0m03:01:09.910891 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select tag:snaps', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m03:01:10.686117 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dd3e5ad6-b71d-4111-b9ef-bfe6d9d1e535', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000240273E5970>]}
[0m03:01:10.746116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dd3e5ad6-b71d-4111-b9ef-bfe6d9d1e535', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002402B9F3E20>]}
[0m03:01:10.749018 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m03:01:10.754110 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m03:01:10.803928 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m03:01:10.803928 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m03:01:10.807935 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dd3e5ad6-b71d-4111-b9ef-bfe6d9d1e535', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002402BDD5A30>]}
[0m03:01:10.819875 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dd3e5ad6-b71d-4111-b9ef-bfe6d9d1e535', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002402BCEB550>]}
[0m03:01:10.820867 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m03:01:10.821843 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dd3e5ad6-b71d-4111-b9ef-bfe6d9d1e535', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002402BCEB640>]}
[0m03:01:10.822918 [info ] [MainThread]: 
[0m03:01:10.822918 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m03:01:10.824933 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m03:01:10.824933 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:01:11.513780 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m03:01:11.514774 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m03:01:11.514774 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:01:11.515770 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m03:01:12.168841 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m03:01:12.170911 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:01:12.202608 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m03:01:12.203688 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m03:01:12.854894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dd3e5ad6-b71d-4111-b9ef-bfe6d9d1e535', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002402BB002B0>]}
[0m03:01:12.856884 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m03:01:12.857880 [info ] [MainThread]: 
[0m03:01:12.865099 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m03:01:12.866094 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m03:01:12.867155 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m03:01:12.868175 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m03:01:12.882316 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m03:01:12.883316 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 03:01:12.868175 => 03:01:12.883316
[0m03:01:12.884235 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m03:01:12.900828 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m03:01:13.589515 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m03:01:13.590113 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m03:01:14.044990 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e3cf381d-3143-4776-b904-e05c69bd238e&page=queryresults
[0m03:01:16.249293 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 03:01:12.884235 => 03:01:16.249293
[0m03:01:16.249293 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd3e5ad6-b71d-4111-b9ef-bfe6d9d1e535', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002402CE4DE80>]}
[0m03:01:16.250300 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (443.0 rows, 81.5 KiB processed)[0m in 3.38s]
[0m03:01:16.251193 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m03:01:16.251828 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m03:01:16.251828 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m03:01:16.252823 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m03:01:16.252823 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m03:01:16.254834 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m03:01:16.255834 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 03:01:16.252823 => 03:01:16.255834
[0m03:01:16.256835 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m03:01:16.257835 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m03:01:16.847002 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m03:01:16.849029 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m03:01:17.208464 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bd769f8f-16d4-411a-b8e5-cb137c3fc391&page=queryresults
[0m03:01:19.155424 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 03:01:16.256835 => 03:01:19.155424
[0m03:01:19.156460 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dd3e5ad6-b71d-4111-b9ef-bfe6d9d1e535', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002402CE769D0>]}
[0m03:01:19.158414 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (355.0 rows, 107.7 KiB processed)[0m in 2.90s]
[0m03:01:19.159412 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m03:01:19.161384 [debug] [MainThread]: Connection 'master' was properly closed.
[0m03:01:19.162473 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m03:01:19.163468 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m03:01:19.163468 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m03:01:19.164470 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m03:01:19.164470 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m03:01:19.165474 [info ] [MainThread]: 
[0m03:01:19.166476 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 8.34 seconds (8.34s).
[0m03:01:19.167470 [debug] [MainThread]: Command end result
[0m03:01:19.185481 [info ] [MainThread]: 
[0m03:01:19.186467 [info ] [MainThread]: [32mCompleted successfully[0m
[0m03:01:19.186467 [info ] [MainThread]: 
[0m03:01:19.187502 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m03:01:19.188470 [debug] [MainThread]: Command `dbt run` succeeded at 03:01:19.188470 after 9.35 seconds
[0m03:01:19.188470 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024028467460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002402BBA41F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002402B9D85B0>]}
[0m03:01:19.189473 [debug] [MainThread]: Flushing usage events
[0m04:00:05.578102 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F31C33D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F214F2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F214F760>]}


============================== 04:00:05.586100 | 0ff2db2a-a72e-42cb-8485-3096087d8bc4 ==============================
[0m04:00:05.586100 [info ] [MainThread]: Running with dbt=1.7.4
[0m04:00:05.587139 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m04:00:06.489744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F214F940>]}
[0m04:00:06.547513 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F6830700>]}
[0m04:00:06.549525 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m04:00:06.559462 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m04:00:06.612551 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:00:06.612551 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m04:00:06.616556 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F6B281C0>]}
[0m04:00:06.627606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F6A39EB0>]}
[0m04:00:06.627606 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m04:00:06.628608 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F6A391F0>]}
[0m04:00:06.631640 [info ] [MainThread]: 
[0m04:00:06.632639 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m04:00:06.635640 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:06.636645 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:06.638639 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:06.657960 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:07.549020 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:08.705485 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m04:00:08.707491 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m04:00:08.708493 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:08.709489 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:09.343773 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m04:00:09.344765 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:09.421865 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m04:00:09.427853 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:00:10.077712 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F688EE80>]}
[0m04:00:10.078786 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m04:00:10.079720 [info ] [MainThread]: 
[0m04:00:10.087745 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:10.088745 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m04:00:10.089748 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m04:00:10.090747 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m04:00:10.095747 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m04:00:10.098746 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m04:00:10.110742 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m04:00:10.115504 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m04:00:10.115504 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:10.119541 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m04:00:10.120535 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 04:00:10.098746 => 04:00:10.120535
[0m04:00:10.121537 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m04:00:10.159673 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m04:00:10.161192 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 04:00:10.116503 => 04:00:10.160668
[0m04:00:10.163208 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:10.170215 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m04:00:10.171215 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m04:00:10.174215 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m04:00:10.209307 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m04:00:10.213318 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m04:00:11.055127 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7bdc5767-bfe2-4d95-943a-3707de18fe6b&page=queryresults
[0m04:00:11.091928 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b8189146-2e60-49b0-9680-b697b0f3acd2&page=queryresults
[0m04:00:11.527537 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 04:00:10.121537 => 04:00:11.527537
[0m04:00:11.531581 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 04:00:10.164206 => 04:00:11.531581
[0m04:00:11.533534 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F6B7A760>]}
[0m04:00:11.536937 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7C259D0>]}
[0m04:00:11.538475 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m04:00:11.541504 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m04:00:11.540551 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m04:00:11.543545 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m04:00:11.544482 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m04:00:11.546523 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_compra
[0m04:00:11.545523 [info ] [Thread-2  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m04:00:11.549476 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m04:00:11.547520 [info ] [Thread-1  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m04:00:11.550534 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m04:00:11.551522 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_compra)
[0m04:00:11.558579 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m04:00:11.559535 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_compra
[0m04:00:11.567622 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 04:00:11.552525 => 04:00:11.566533
[0m04:00:11.575308 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m04:00:11.576308 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m04:00:11.582316 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m04:00:11.585271 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (compile): 04:00:11.560533 => 04:00:11.584318
[0m04:00:11.586257 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_compra
[0m04:00:11.590314 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m04:00:11.591321 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:11.592318 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m04:00:11.625252 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:11.627245 [debug] [Thread-1  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m04:00:12.337291 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2bb6d5e2-c14f-463b-83ac-9ea7e9abf3ef&page=queryresults
[0m04:00:12.382583 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4c35bacd-8dd5-45e8-878a-213cb95b6522&page=queryresults
[0m04:00:12.764153 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (execute): 04:00:11.586257 => 04:00:12.764153
[0m04:00:12.765151 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7C1E4C0>]}
[0m04:00:12.765151 [info ] [Thread-1  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m04:00:12.767070 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_compra
[0m04:00:12.768058 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m04:00:12.769059 [info ] [Thread-1  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m04:00:12.771145 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_forma_pagamento)
[0m04:00:12.771145 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m04:00:12.776148 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m04:00:12.777851 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 04:00:12.772145 => 04:00:12.777851
[0m04:00:12.777851 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m04:00:12.780923 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m04:00:12.781930 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:12.782844 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m04:00:12.807935 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 04:00:11.577318 => 04:00:12.807935
[0m04:00:12.808932 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7BA9FA0>]}
[0m04:00:12.808932 [info ] [Thread-2  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m04:00:12.809927 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m04:00:12.810926 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m04:00:12.810926 [info ] [Thread-2  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m04:00:12.811862 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m04:00:12.811862 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m04:00:12.813927 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m04:00:12.814923 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 04:00:12.811862 => 04:00:12.814923
[0m04:00:12.814923 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m04:00:12.819939 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m04:00:12.820929 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:12.821802 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m04:00:13.535163 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:af9fea29-0adb-4ee8-b683-414e2ec383a9&page=queryresults
[0m04:00:13.545119 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:49176f22-c481-4048-946e-595511b0d874&page=queryresults
[0m04:00:14.018341 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 04:00:12.778812 => 04:00:14.017405
[0m04:00:14.020455 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7C89100>]}
[0m04:00:14.028426 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 04:00:12.815849 => 04:00:14.027461
[0m04:00:14.022460 [info ] [Thread-1  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m04:00:14.030445 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7BA9FD0>]}
[0m04:00:14.031372 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m04:00:14.033418 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m04:00:14.032416 [info ] [Thread-2  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m04:00:14.034417 [info ] [Thread-1  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m04:00:14.036374 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m04:00:14.038421 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m04:00:14.039373 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m04:00:14.040342 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m04:00:14.048428 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m04:00:14.041421 [info ] [Thread-2  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m04:00:14.050417 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m04:00:14.051441 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m04:00:14.055369 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m04:00:14.056367 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 04:00:14.042427 => 04:00:14.055369
[0m04:00:14.057329 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m04:00:14.062328 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m04:00:14.064329 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 04:00:14.051441 => 04:00:14.064329
[0m04:00:14.065331 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m04:00:14.071345 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m04:00:14.072340 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:14.074338 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m04:00:14.103029 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:14.107039 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m04:00:15.059114 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4dc198c7-9c16-42c0-b095-ef21e5d5b668&page=queryresults
[0m04:00:15.068878 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:beebd558-50c2-461f-931d-7bdbb43293ff&page=queryresults
[0m04:00:15.458087 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 04:00:14.057329 => 04:00:15.457091
[0m04:00:15.459094 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7BC4AF0>]}
[0m04:00:15.461090 [info ] [Thread-1  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.42s]
[0m04:00:15.462033 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m04:00:15.463083 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:15.464095 [info ] [Thread-1  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m04:00:15.466059 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m04:00:15.467061 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:15.473060 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m04:00:15.477056 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 04:00:14.066330 => 04:00:15.477056
[0m04:00:15.478156 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7BAF760>]}
[0m04:00:15.480164 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 04:00:15.468061 => 04:00:15.479164
[0m04:00:15.479164 [info ] [Thread-2  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.43s]
[0m04:00:15.480164 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:15.481167 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m04:00:15.484166 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m04:00:15.485162 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m04:00:15.486166 [info ] [Thread-2  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m04:00:15.489099 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:15.487064 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m04:00:15.494864 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m04:00:15.494864 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m04:00:15.497806 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m04:00:15.524850 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 04:00:15.494864 => 04:00:15.524850
[0m04:00:15.524850 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m04:00:15.527861 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m04:00:15.529810 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:15.530865 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m04:00:16.205384 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bcec1119-4cb8-44b5-be06-fed0bec40390&page=queryresults
[0m04:00:16.225103 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f9631db1-ea45-4723-8d36-cd613c84f555&page=queryresults
[0m04:00:16.623677 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 04:00:15.524850 => 04:00:16.623677
[0m04:00:16.624677 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7CBB8E0>]}
[0m04:00:16.625679 [info ] [Thread-2  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m04:00:16.627783 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m04:00:16.628781 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m04:00:16.630756 [info ] [Thread-2  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m04:00:16.632700 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto)
[0m04:00:16.633693 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m04:00:16.641690 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m04:00:16.643679 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 04:00:16.634693 => 04:00:16.642686
[0m04:00:16.643679 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m04:00:16.647678 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m04:00:16.651701 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 04:00:15.481167 => 04:00:16.650691
[0m04:00:16.652701 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7BDAD30>]}
[0m04:00:16.653679 [info ] [Thread-1  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m04:00:16.654792 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m04:00:16.654792 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m04:00:16.655776 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:16.656686 [info ] [Thread-1  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m04:00:16.657718 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto_fabricado)
[0m04:00:16.658770 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m04:00:16.664778 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m04:00:16.668717 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m04:00:16.703654 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 04:00:16.658770 => 04:00:16.702645
[0m04:00:16.704655 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m04:00:16.709654 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m04:00:16.711653 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:16.714654 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m04:00:17.397505 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ae8d4703-3b91-43d8-82a3-65cb58012e21&page=queryresults
[0m04:00:17.465087 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:db978d04-d8b0-42e6-b7d4-2d3bc155afeb&page=queryresults
[0m04:00:17.799975 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 04:00:16.704655 => 04:00:17.799975
[0m04:00:17.800986 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7D1CDF0>]}
[0m04:00:17.801988 [info ] [Thread-1  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m04:00:17.803625 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m04:00:17.804609 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m04:00:17.806610 [info ] [Thread-1  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m04:00:17.808175 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_tempo)
[0m04:00:17.809245 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m04:00:17.816239 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m04:00:17.817244 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 04:00:17.809245 => 04:00:17.817244
[0m04:00:17.818384 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m04:00:17.821426 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m04:00:17.822423 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:17.823425 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m04:00:17.862423 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 04:00:16.644684 => 04:00:17.862423
[0m04:00:17.864393 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7D17EE0>]}
[0m04:00:17.864393 [info ] [Thread-2  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m04:00:17.865630 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m04:00:17.866671 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m04:00:17.866671 [info ] [Thread-2  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m04:00:17.867637 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m04:00:17.868668 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m04:00:17.872674 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m04:00:17.873670 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 04:00:17.868668 => 04:00:17.873670
[0m04:00:17.873670 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m04:00:17.884670 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:18.534654 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m04:00:18.536592 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m04:00:18.573234 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fd87ec14-824d-4da2-8bd8-8ffe27284fb0&page=queryresults
[0m04:00:18.982478 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 04:00:17.818384 => 04:00:18.981481
[0m04:00:18.984024 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7D173D0>]}
[0m04:00:18.986137 [info ] [Thread-1  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m04:00:18.988144 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m04:00:19.189495 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:807c6d04-dc54-4416-8260-0a68d7f81eb8&page=queryresults
[0m04:00:21.643894 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 04:00:17.874670 => 04:00:21.642893
[0m04:00:21.644893 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7D13C10>]}
[0m04:00:21.646895 [info ] [Thread-2  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 3.78s]
[0m04:00:21.647898 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m04:00:21.649897 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m04:00:21.651898 [info ] [Thread-1  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m04:00:21.653899 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m04:00:21.653899 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m04:00:21.659897 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m04:00:21.661897 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 04:00:21.654897 => 04:00:21.660897
[0m04:00:21.661897 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m04:00:21.670888 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:22.378865 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m04:00:22.380851 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m04:00:23.138362 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:65377497-6561-4aca-b1e8-db491c71d2d2&page=queryresults
[0m04:00:25.963221 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 04:00:21.662888 => 04:00:25.962223
[0m04:00:25.964222 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7BA9F70>]}
[0m04:00:25.965223 [info ] [Thread-1  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 4.31s]
[0m04:00:25.967228 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m04:00:25.968222 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m04:00:25.969228 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m04:00:25.970215 [info ] [Thread-2  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m04:00:25.973129 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m04:00:25.971090 [info ] [Thread-1  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m04:00:25.974139 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m04:00:25.975061 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m04:00:25.982119 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m04:00:25.984075 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m04:00:25.990830 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m04:00:25.992846 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 04:00:25.976078 => 04:00:25.991833
[0m04:00:25.992846 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m04:00:25.993858 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 04:00:25.984699 => 04:00:25.993858
[0m04:00:25.997837 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:25.998858 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m04:00:26.003838 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:26.864370 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m04:00:26.867363 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m04:00:26.869286 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m04:00:26.871286 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m04:00:27.465223 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5a052b28-aaf4-45f3-9bbd-585e529cb0bd&page=queryresults
[0m04:00:27.477521 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:06839605-230a-46c2-b1b8-f72a4f3480d9&page=queryresults
[0m04:00:29.935172 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 04:00:25.994843 => 04:00:29.934175
[0m04:00:29.936161 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7D395E0>]}
[0m04:00:29.936161 [info ] [Thread-2  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 3.96s]
[0m04:00:29.937179 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m04:00:29.938681 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m04:00:29.939672 [info ] [Thread-2  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m04:00:29.941672 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m04:00:29.942687 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m04:00:29.948673 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m04:00:29.950544 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 04:00:29.942687 => 04:00:29.949673
[0m04:00:29.950544 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m04:00:29.957665 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:29.985478 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 04:00:25.999850 => 04:00:29.984471
[0m04:00:29.985478 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7C94C70>]}
[0m04:00:29.986488 [info ] [Thread-1  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 4.01s]
[0m04:00:29.987497 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m04:00:29.987497 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m04:00:29.988376 [info ] [Thread-1  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m04:00:29.989434 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m04:00:29.989434 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m04:00:29.994474 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m04:00:29.995469 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 04:00:29.989434 => 04:00:29.995469
[0m04:00:29.996476 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m04:00:29.998475 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:30.566573 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m04:00:30.567575 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m04:00:30.575193 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m04:00:30.577746 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m04:00:30.936129 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0182a851-7f91-4191-9367-93b9092a0f36&page=queryresults
[0m04:00:31.143923 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7c5b31df-811c-4b24-9676-68d50a761080&page=queryresults
[0m04:00:32.938645 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 04:00:29.950544 => 04:00:32.938645
[0m04:00:32.939633 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F68FCD30>]}
[0m04:00:32.939633 [info ] [Thread-2  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 3.00s]
[0m04:00:32.940640 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m04:00:32.942542 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m04:00:32.943500 [info ] [Thread-2  ]: 20 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m04:00:32.945737 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m04:00:32.946747 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m04:00:32.952003 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m04:00:32.953011 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 04:00:32.947747 => 04:00:32.953011
[0m04:00:32.954018 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m04:00:32.958013 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:33.692122 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m04:00:33.694056 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m04:00:33.942612 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 04:00:29.996476 => 04:00:33.942612
[0m04:00:33.943606 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7CC60D0>]}
[0m04:00:33.943606 [info ] [Thread-1  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.95s]
[0m04:00:33.944537 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m04:00:33.944537 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m04:00:33.946616 [info ] [Thread-1  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m04:00:33.947484 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m04:00:33.948610 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m04:00:33.954605 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m04:00:33.955601 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 04:00:33.948610 => 04:00:33.955601
[0m04:00:33.956597 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m04:00:33.961611 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:34.041516 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f288d57f-92a2-4118-aa65-33ecfd97f03e&page=queryresults
[0m04:00:34.594204 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m04:00:34.595346 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m04:00:34.991637 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3d71d892-3746-43f7-82da-7f1904c6ff9a&page=queryresults
[0m04:00:36.786014 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 04:00:32.954018 => 04:00:36.786014
[0m04:00:36.788014 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7D5B0D0>]}
[0m04:00:36.789018 [info ] [Thread-2  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 3.84s]
[0m04:00:36.790015 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m04:00:36.791020 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m04:00:36.792013 [info ] [Thread-2  ]: 22 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m04:00:36.793014 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m04:00:36.794016 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m04:00:36.800014 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m04:00:36.802559 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 04:00:36.794016 => 04:00:36.802559
[0m04:00:36.803532 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m04:00:36.807545 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:37.465099 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m04:00:37.467109 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m04:00:38.031006 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d694245c-3c9c-47e8-b47c-1120d513f83b&page=queryresults
[0m04:00:41.074826 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 04:00:36.803532 => 04:00:41.073727
[0m04:00:41.075827 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7C992E0>]}
[0m04:00:41.076829 [info ] [Thread-2  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 4.28s]
[0m04:00:41.078729 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m04:00:41.079730 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m04:00:41.080728 [info ] [Thread-2  ]: 23 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m04:00:41.081729 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m04:00:41.082822 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m04:00:41.091829 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m04:00:41.093826 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 04:00:41.082822 => 04:00:41.093826
[0m04:00:41.094821 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m04:00:41.097819 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:41.425472 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 04:00:33.956597 => 04:00:41.424474
[0m04:00:41.426470 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7CC6340>]}
[0m04:00:41.427469 [info ] [Thread-1  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.2 KiB processed)[0m in 7.48s]
[0m04:00:41.428535 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m04:00:41.430470 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m04:00:41.430470 [info ] [Thread-1  ]: 24 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m04:00:41.432470 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m04:00:41.433469 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m04:00:41.438468 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m04:00:41.440469 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 04:00:41.433469 => 04:00:41.439564
[0m04:00:41.440469 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m04:00:41.443469 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:41.758992 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m04:00:41.761897 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m04:00:42.078103 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m04:00:42.080048 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m04:00:42.333778 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2f31d325-cc1e-4b0c-b5e2-f5ca5df43f81&page=queryresults
[0m04:00:42.413890 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:252dcca9-e371-4648-85bd-7df7c7618ee2&page=queryresults
[0m04:00:44.512986 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 04:00:41.441469 => 04:00:44.512986
[0m04:00:44.513986 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F7CD5B80>]}
[0m04:00:45.475283 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 04:00:41.094821 => 04:00:45.475283
[0m04:00:45.477279 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F8DAC580>]}
[0m04:00:45.478279 [info ] [Thread-1  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.3 KiB processed)[0m in 3.08s]
[0m04:00:45.480279 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m04:00:45.479281 [info ] [Thread-2  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 4.39s]
[0m04:00:45.482281 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m04:00:45.483282 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m04:00:45.484286 [info ] [Thread-1  ]: 25 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m04:00:45.486283 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m04:00:45.486283 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m04:00:45.495323 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m04:00:45.498328 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 04:00:45.487282 => 04:00:45.497328
[0m04:00:45.498328 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m04:00:45.503325 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m04:00:46.125472 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m04:00:46.128363 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m04:00:46.544158 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1d23d19a-fee8-40d0-914b-46a9a283c291&page=queryresults
[0m04:00:49.366768 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 04:00:45.499326 => 04:00:49.365769
[0m04:00:49.367768 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F8DFF7F0>]}
[0m04:00:49.368767 [info ] [Thread-1  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 3.88s]
[0m04:00:49.369767 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m04:00:49.371324 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m04:00:49.371324 [info ] [Thread-2  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m04:00:49.372487 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m04:00:49.373500 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m04:00:49.378498 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m04:00:49.384501 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 04:00:49.373500 => 04:00:49.384501
[0m04:00:49.385423 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m04:00:49.387601 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m04:00:50.050752 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m04:00:50.052772 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m04:00:50.660545 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3eb303d7-a36c-4995-a3ee-82ff6fcdae25&page=queryresults
[0m04:00:54.317831 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 04:00:49.385423 => 04:00:54.316828
[0m04:00:54.318829 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0ff2db2a-a72e-42cb-8485-3096087d8bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F8DFF4F0>]}
[0m04:00:54.319829 [info ] [Thread-2  ]: 26 of 26 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 4.95s]
[0m04:00:54.320829 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m04:00:54.323182 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:00:54.324193 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:00:54.324193 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:00:54.324193 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m04:00:54.325192 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m04:00:54.325192 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m04:00:54.325192 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m04:00:54.326191 [info ] [MainThread]: 
[0m04:00:54.327194 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 47.69 seconds (47.69s).
[0m04:00:54.332189 [debug] [MainThread]: Command end result
[0m04:00:54.357546 [info ] [MainThread]: 
[0m04:00:54.358494 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:00:54.359495 [info ] [MainThread]: 
[0m04:00:54.360605 [info ] [MainThread]: Done. PASS=26 WARN=0 ERROR=0 SKIP=0 TOTAL=26
[0m04:00:54.362606 [debug] [MainThread]: Command `dbt run` succeeded at 04:00:54.362606 after 48.85 seconds
[0m04:00:54.363603 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F31C33D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F6830700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F6BB8910>]}
[0m04:00:54.363603 [debug] [MainThread]: Flushing usage events
[0m04:00:58.129744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5410C3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B54004F9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B54004FD30>]}


============================== 04:00:58.138744 | f7bf31f3-8f2c-4bd7-8112-b176ccc90e80 ==============================
[0m04:00:58.138744 [info ] [MainThread]: Running with dbt=1.7.4
[0m04:00:58.140787 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt snapshot', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m04:00:58.898485 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f7bf31f3-8f2c-4bd7-8112-b176ccc90e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B54003F970>]}
[0m04:00:58.957001 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f7bf31f3-8f2c-4bd7-8112-b176ccc90e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B544720AC0>]}
[0m04:00:58.959019 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m04:00:58.968001 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m04:00:59.018833 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:00:59.018833 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m04:00:59.023832 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f7bf31f3-8f2c-4bd7-8112-b176ccc90e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B544A26340>]}
[0m04:00:59.033770 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f7bf31f3-8f2c-4bd7-8112-b176ccc90e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5447A1250>]}
[0m04:00:59.033770 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m04:00:59.034927 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f7bf31f3-8f2c-4bd7-8112-b176ccc90e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5446AA160>]}
[0m04:00:59.036935 [info ] [MainThread]: 
[0m04:00:59.037677 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m04:00:59.039890 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:00:59.039890 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:59.707626 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m04:00:59.709554 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:00:59.710641 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m04:00:59.711623 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:01:00.356006 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m04:01:00.356006 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:01:00.359008 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m04:01:00.360007 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:01:01.000707 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f7bf31f3-8f2c-4bd7-8112-b176ccc90e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B544A04C10>]}
[0m04:01:01.002707 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m04:01:01.003707 [info ] [MainThread]: 
[0m04:01:01.011721 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m04:01:01.012713 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m04:01:01.015745 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m04:01:01.016746 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m04:01:01.037254 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 04:01:01.017730 => 04:01:01.036273
[0m04:01:01.037254 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m04:01:01.110354 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m04:01:01.111303 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m04:01:01.869632 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:93e68a8a-578d-437f-83d1-3a715964de4f&page=queryresults
[0m04:01:02.992533 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m04:01:03.498304 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ce1b74a6-4866-41c6-ac33-8f5104863681&page=queryresults
[0m04:01:05.810189 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m04:01:06.561308 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m04:01:06.563343 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m04:01:06.990132 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:43ffa5a2-9c46-4186-a228-94bdae43e9db&page=queryresults
[0m04:01:09.081140 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 04:01:01.038254 => 04:01:09.080071
[0m04:01:09.083130 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7bf31f3-8f2c-4bd7-8112-b176ccc90e80', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B545AD63D0>]}
[0m04:01:09.085131 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 96.0 KiB processed)[0m in 8.07s]
[0m04:01:09.087135 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m04:01:09.091141 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:01:09.092140 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:01:09.092140 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m04:01:09.093124 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m04:01:09.094125 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m04:01:09.094125 [info ] [MainThread]: 
[0m04:01:09.095296 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.06 seconds (10.06s).
[0m04:01:09.095958 [debug] [MainThread]: Command end result
[0m04:01:09.119953 [info ] [MainThread]: 
[0m04:01:09.120930 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:01:09.121941 [info ] [MainThread]: 
[0m04:01:09.122950 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m04:01:09.124948 [debug] [MainThread]: Command `dbt snapshot` succeeded at 04:01:09.124948 after 11.05 seconds
[0m04:01:09.125946 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5410C3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B544720AC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002B5447A1CA0>]}
[0m04:01:09.126946 [debug] [MainThread]: Flushing usage events
[0m04:01:13.319949 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283E7963430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283E68DF9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283E68DFD30>]}


============================== 04:01:13.328002 | 99a58c05-12c5-4ff0-91d3-2f1479805cc2 ==============================
[0m04:01:13.328002 [info ] [MainThread]: Running with dbt=1.7.4
[0m04:01:13.330036 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m04:01:14.114080 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '99a58c05-12c5-4ff0-91d3-2f1479805cc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283E68C5970>]}
[0m04:01:14.171073 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '99a58c05-12c5-4ff0-91d3-2f1479805cc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283EAFCB490>]}
[0m04:01:14.171972 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m04:01:14.180081 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m04:01:14.230562 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m04:01:14.230562 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m04:01:14.235564 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '99a58c05-12c5-4ff0-91d3-2f1479805cc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283EB2C5F10>]}
[0m04:01:14.247678 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '99a58c05-12c5-4ff0-91d3-2f1479805cc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283EB1D8AC0>]}
[0m04:01:14.247678 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m04:01:14.248660 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '99a58c05-12c5-4ff0-91d3-2f1479805cc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283EB1D8BB0>]}
[0m04:01:14.250660 [info ] [MainThread]: 
[0m04:01:14.251619 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m04:01:14.253668 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m04:01:14.253668 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:01:14.998374 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m04:01:15.000445 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:01:15.002241 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m04:01:15.003235 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m04:01:15.834745 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m04:01:15.835739 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:01:15.863732 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m04:01:15.864733 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m04:01:16.476868 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '99a58c05-12c5-4ff0-91d3-2f1479805cc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283EB04D430>]}
[0m04:01:16.477820 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m04:01:16.478875 [info ] [MainThread]: 
[0m04:01:16.483771 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m04:01:16.484772 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m04:01:16.485773 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m04:01:16.485773 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m04:01:16.493895 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m04:01:16.494931 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 04:01:16.485773 => 04:01:16.493895
[0m04:01:16.494931 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m04:01:16.507900 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m04:01:17.167627 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m04:01:17.169604 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m04:01:17.510536 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3cfcd3e3-f237-44b4-be73-0643860e1b0e&page=queryresults
[0m04:01:19.499106 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 04:01:16.494931 => 04:01:19.498100
[0m04:01:19.500106 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '99a58c05-12c5-4ff0-91d3-2f1479805cc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283EC33F610>]}
[0m04:01:19.500106 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (443.0 rows, 81.5 KiB processed)[0m in 3.01s]
[0m04:01:19.501150 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m04:01:19.502107 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m04:01:19.503109 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m04:01:19.503998 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m04:01:19.503998 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m04:01:19.508102 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m04:01:19.509002 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 04:01:19.505113 => 04:01:19.509002
[0m04:01:19.510012 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m04:01:19.515114 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m04:01:20.161832 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m04:01:20.163833 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m04:01:20.481192 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0c162fdf-2e8c-43c3-9222-b14efaafc609&page=queryresults
[0m04:01:22.405749 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 04:01:19.511102 => 04:01:22.405749
[0m04:01:22.406742 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '99a58c05-12c5-4ff0-91d3-2f1479805cc2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283EC362B20>]}
[0m04:01:22.406742 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (355.0 rows, 107.7 KiB processed)[0m in 2.90s]
[0m04:01:22.407736 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m04:01:22.410702 [debug] [MainThread]: Connection 'master' was properly closed.
[0m04:01:22.411702 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m04:01:22.411702 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m04:01:22.412699 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m04:01:22.412699 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m04:01:22.412699 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m04:01:22.412699 [info ] [MainThread]: 
[0m04:01:22.413836 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 8.16 seconds (8.16s).
[0m04:01:22.415310 [debug] [MainThread]: Command end result
[0m04:01:22.436308 [info ] [MainThread]: 
[0m04:01:22.438392 [info ] [MainThread]: [32mCompleted successfully[0m
[0m04:01:22.439383 [info ] [MainThread]: 
[0m04:01:22.440432 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m04:01:22.442125 [debug] [MainThread]: Command `dbt run` succeeded at 04:01:22.442125 after 9.18 seconds
[0m04:01:22.443235 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283E7963430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283EAFCB490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000283EAF77C10>]}
[0m04:01:22.444254 [debug] [MainThread]: Flushing usage events
[0m05:00:04.555600 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA390B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA28899A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA2889D30>]}


============================== 05:00:04.563647 | adcc35c9-9967-4ddd-b897-dba6e158f7db ==============================
[0m05:00:04.563647 [info ] [MainThread]: Running with dbt=1.7.4
[0m05:00:04.564662 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --exclude tag:snaps', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m05:00:05.419109 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA288D8B0>]}
[0m05:00:05.475187 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA6F81970>]}
[0m05:00:05.477105 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m05:00:05.484467 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m05:00:05.538465 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:00:05.538465 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:00:05.542466 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA7278220>]}
[0m05:00:05.553519 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA7189DC0>]}
[0m05:00:05.554591 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m05:00:05.555589 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA6F1A850>]}
[0m05:00:05.558568 [info ] [MainThread]: 
[0m05:00:05.559566 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m05:00:05.561586 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:05.562657 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:05.563626 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:05.563626 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:06.429186 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:07.185468 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m05:00:07.187367 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m05:00:07.188368 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:07.189365 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:07.902612 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m05:00:07.905603 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m05:00:07.906609 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:07.910603 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:08.570315 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA6FCB6D0>]}
[0m05:00:08.572323 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m05:00:08.573413 [info ] [MainThread]: 
[0m05:00:08.580313 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:08.581323 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m05:00:08.582324 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m05:00:08.584323 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m05:00:08.589340 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m05:00:08.591339 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m05:00:08.604800 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m05:00:08.608719 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m05:00:08.609717 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:08.616816 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m05:00:08.617810 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 05:00:08.593202 => 05:00:08.617810
[0m05:00:08.618810 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m05:00:08.643711 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m05:00:08.644711 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 05:00:08.609717 => 05:00:08.644711
[0m05:00:08.644711 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:08.647711 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m05:00:08.647711 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m05:00:08.648711 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m05:00:08.650820 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m05:00:08.674714 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m05:00:09.502005 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6b14aab8-1fb8-4466-9444-5fbf56f33828&page=queryresults
[0m05:00:09.605260 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b2504969-a68e-493d-b30f-ae246e2238ef&page=queryresults
[0m05:00:10.054457 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 05:00:08.645712 => 05:00:10.054457
[0m05:00:10.055456 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA8393D30>]}
[0m05:00:10.055456 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m05:00:10.056477 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m05:00:10.057367 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m05:00:10.057367 [info ] [Thread-1  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m05:00:10.058363 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m05:00:10.059364 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m05:00:10.063367 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m05:00:10.065415 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 05:00:10.059364 => 05:00:10.064405
[0m05:00:10.065415 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m05:00:10.069413 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m05:00:10.070426 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:10.071413 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m05:00:10.147965 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 05:00:08.619817 => 05:00:10.146970
[0m05:00:10.149980 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA8351FD0>]}
[0m05:00:10.150972 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.56s]
[0m05:00:10.152967 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m05:00:10.153975 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_compra
[0m05:00:10.154968 [info ] [Thread-2  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m05:00:10.156954 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_compra)
[0m05:00:10.158877 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_compra
[0m05:00:10.163871 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m05:00:10.165871 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (compile): 05:00:10.158877 => 05:00:10.164873
[0m05:00:10.166869 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_compra
[0m05:00:10.169868 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m05:00:10.170868 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:10.172868 [debug] [Thread-2  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m05:00:11.109603 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e6d2f1d5-42d6-41b8-a13f-035d09b8ff7a&page=queryresults
[0m05:00:11.174201 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1c615fde-be8a-433f-ab9e-8ba537894dc4&page=queryresults
[0m05:00:11.534231 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (execute): 05:00:10.166869 => 05:00:11.533233
[0m05:00:11.535231 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA82FCFD0>]}
[0m05:00:11.536237 [info ] [Thread-2  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.38s]
[0m05:00:11.538102 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_compra
[0m05:00:11.539098 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m05:00:11.540100 [info ] [Thread-2  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m05:00:11.542216 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_forma_pagamento)
[0m05:00:11.543221 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m05:00:11.549224 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m05:00:11.550229 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 05:00:11.544226 => 05:00:11.550229
[0m05:00:11.551225 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m05:00:11.554232 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m05:00:11.555220 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:11.556223 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m05:00:11.586898 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 05:00:10.065415 => 05:00:11.586898
[0m05:00:11.587971 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA7282D60>]}
[0m05:00:11.587971 [info ] [Thread-1  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.53s]
[0m05:00:11.588905 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m05:00:11.588905 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m05:00:11.589968 [info ] [Thread-1  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m05:00:11.590937 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m05:00:11.591934 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m05:00:11.594936 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m05:00:11.596930 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 05:00:11.591934 => 05:00:11.595935
[0m05:00:11.597942 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m05:00:11.604942 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m05:00:11.605935 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:11.608042 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m05:00:12.299005 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:32fdcb76-b45a-4ba0-97e4-fe00e86ef68d&page=queryresults
[0m05:00:12.307936 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a366b975-2f53-4162-a482-611fd33c9a22&page=queryresults
[0m05:00:12.704488 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 05:00:11.551225 => 05:00:12.703480
[0m05:00:12.705480 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA83342E0>]}
[0m05:00:12.707481 [info ] [Thread-2  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m05:00:12.709346 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m05:00:12.711381 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_compra
[0m05:00:12.716361 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 05:00:11.597942 => 05:00:12.716361
[0m05:00:12.717766 [info ] [Thread-2  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m05:00:12.719825 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA83FDA00>]}
[0m05:00:12.721826 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m05:00:12.722832 [info ] [Thread-1  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m05:00:12.723820 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m05:00:12.725901 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m05:00:12.729694 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m05:00:12.730705 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m05:00:12.730705 [info ] [Thread-1  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m05:00:12.731696 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m05:00:12.731696 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m05:00:12.733686 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m05:00:12.734684 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 05:00:12.725901 => 05:00:12.734684
[0m05:00:12.734684 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m05:00:12.740707 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m05:00:12.741706 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 05:00:12.731696 => 05:00:12.740707
[0m05:00:12.742723 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m05:00:12.748771 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m05:00:12.750737 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:12.753769 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m05:00:12.794736 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:12.796832 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m05:00:13.545673 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9dc04dc8-48e2-4b8d-a5ee-80f86ae7925f&page=queryresults
[0m05:00:13.550680 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:313d7a42-8e04-48de-a40f-fc57d64214b3&page=queryresults
[0m05:00:13.925755 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 05:00:12.734684 => 05:00:13.925755
[0m05:00:13.926757 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA82FCE50>]}
[0m05:00:13.926757 [info ] [Thread-2  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m05:00:13.927752 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m05:00:13.928715 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:13.929721 [info ] [Thread-2  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m05:00:13.930719 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m05:00:13.931718 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:13.937493 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m05:00:13.939361 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 05:00:13.931718 => 05:00:13.938489
[0m05:00:13.939361 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:13.950485 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 05:00:12.743778 => 05:00:13.950485
[0m05:00:13.953410 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m05:00:13.953410 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA844D0A0>]}
[0m05:00:13.954412 [info ] [Thread-1  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m05:00:13.955387 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:13.955387 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m05:00:13.955387 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m05:00:13.956417 [info ] [Thread-1  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m05:00:13.957415 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m05:00:13.958415 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m05:00:13.963412 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m05:00:13.964416 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m05:00:13.999743 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 05:00:13.958415 => 05:00:13.998737
[0m05:00:13.999743 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m05:00:14.001742 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m05:00:14.002739 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:14.003741 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m05:00:14.750026 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:563ca2db-e424-4fe8-b4f7-009ab6a91554&page=queryresults
[0m05:00:14.839392 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bc5a0043-4155-4833-97cd-b34c68f2aa94&page=queryresults
[0m05:00:15.182001 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 05:00:13.940435 => 05:00:15.181014
[0m05:00:15.182001 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA8393490>]}
[0m05:00:15.183002 [info ] [Thread-2  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m05:00:15.183400 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m05:00:15.184450 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m05:00:15.185418 [info ] [Thread-2  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m05:00:15.187465 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m05:00:15.188472 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m05:00:15.195551 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m05:00:15.196548 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 05:00:15.188472 => 05:00:15.196548
[0m05:00:15.197462 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m05:00:15.201554 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m05:00:15.202537 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:15.204552 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m05:00:15.228451 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 05:00:13.999743 => 05:00:15.228451
[0m05:00:15.229448 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA844D6D0>]}
[0m05:00:15.229448 [info ] [Thread-1  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m05:00:15.231472 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m05:00:15.231472 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m05:00:15.232520 [info ] [Thread-1  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m05:00:15.233518 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m05:00:15.234539 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m05:00:15.236578 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m05:00:15.237577 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 05:00:15.234539 => 05:00:15.237577
[0m05:00:15.237577 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m05:00:15.239547 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m05:00:15.240547 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:15.241492 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m05:00:16.006160 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3f1c0364-716d-453e-b460-2199fc60da89&page=queryresults
[0m05:00:16.014094 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:71d9d27d-3fa6-4934-a72b-80182f04ca59&page=queryresults
[0m05:00:16.410645 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 05:00:15.237577 => 05:00:16.410645
[0m05:00:16.411638 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA84BBD60>]}
[0m05:00:16.411638 [info ] [Thread-1  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m05:00:16.413586 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m05:00:16.414543 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m05:00:16.415578 [info ] [Thread-1  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m05:00:16.417580 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_tempo)
[0m05:00:16.418582 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m05:00:16.424083 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m05:00:16.425091 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 05:00:16.419593 => 05:00:16.425091
[0m05:00:16.426090 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m05:00:16.431086 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m05:00:16.432086 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:16.434084 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m05:00:16.512658 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 05:00:15.197462 => 05:00:16.511695
[0m05:00:16.513698 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA8393490>]}
[0m05:00:16.514697 [info ] [Thread-2  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m05:00:16.517649 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m05:00:16.518647 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m05:00:16.520648 [info ] [Thread-2  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m05:00:16.521597 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m05:00:16.522599 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m05:00:16.530599 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m05:00:16.532598 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 05:00:16.523597 => 05:00:16.532598
[0m05:00:16.533596 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m05:00:16.544600 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:17.318935 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m05:00:17.319931 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m05:00:17.327940 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:44c67bcd-0eaf-43f5-a614-0db1c39e398a&page=queryresults
[0m05:00:17.686817 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 05:00:16.426090 => 05:00:17.686817
[0m05:00:17.689832 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA8362D00>]}
[0m05:00:17.690829 [info ] [Thread-1  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m05:00:17.692838 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m05:00:17.908473 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ec968eb3-19d5-47a7-83df-ca80490cd26d&page=queryresults
[0m05:00:21.065103 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 05:00:16.533596 => 05:00:21.064109
[0m05:00:21.066107 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA849B730>]}
[0m05:00:21.067113 [info ] [Thread-2  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 4.54s]
[0m05:00:21.069126 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m05:00:21.070164 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m05:00:21.072173 [info ] [Thread-1  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m05:00:21.073169 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m05:00:21.075165 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m05:00:21.083478 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m05:00:21.085499 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 05:00:21.075165 => 05:00:21.085499
[0m05:00:21.086481 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m05:00:21.096518 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:21.759433 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m05:00:21.762340 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m05:00:22.482858 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:87fe1230-a674-4879-9573-ded234b2e974&page=queryresults
[0m05:00:25.288913 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 05:00:21.086481 => 05:00:25.288913
[0m05:00:25.289881 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA83117C0>]}
[0m05:00:25.289881 [info ] [Thread-1  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 4.22s]
[0m05:00:25.291802 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m05:00:25.293496 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m05:00:25.294545 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m05:00:25.295553 [info ] [Thread-2  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m05:00:25.298562 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m05:00:25.299620 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m05:00:25.296551 [info ] [Thread-1  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m05:00:25.305703 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m05:00:25.306697 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m05:00:25.307698 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m05:00:25.313472 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m05:00:25.314417 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 05:00:25.300617 => 05:00:25.313472
[0m05:00:25.315387 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m05:00:25.317478 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:25.318482 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 05:00:25.308694 => 05:00:25.318482
[0m05:00:25.337472 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m05:00:25.338470 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:25.921169 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m05:00:25.922160 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m05:00:25.935059 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m05:00:25.937062 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m05:00:26.539473 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:459ccba5-49bd-4cc7-bb60-5eba61bc7c5f&page=queryresults
[0m05:00:26.551158 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8a36ee91-b380-4905-81be-9c6b0efdfa52&page=queryresults
[0m05:00:28.789400 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 05:00:25.315387 => 05:00:28.788379
[0m05:00:28.790375 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA9530A90>]}
[0m05:00:28.791375 [info ] [Thread-2  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 3.49s]
[0m05:00:28.792278 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m05:00:28.793279 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m05:00:28.794278 [info ] [Thread-2  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m05:00:28.795279 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m05:00:28.795279 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m05:00:28.801381 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m05:00:28.802372 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 05:00:28.796277 => 05:00:28.802372
[0m05:00:28.803375 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m05:00:28.814375 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:29.471046 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 05:00:25.337472 => 05:00:29.471046
[0m05:00:29.472049 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA830F4F0>]}
[0m05:00:29.473049 [info ] [Thread-1  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 4.17s]
[0m05:00:29.475026 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m05:00:29.475946 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m05:00:29.475946 [info ] [Thread-1  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m05:00:29.477943 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m05:00:29.477943 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m05:00:29.484047 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m05:00:29.486132 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 05:00:29.478940 => 05:00:29.486132
[0m05:00:29.487132 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m05:00:29.490131 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:29.660140 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m05:00:29.666134 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m05:00:30.103829 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c2c18352-ab7b-4307-ac75-5fc01e907e03&page=queryresults
[0m05:00:30.248293 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m05:00:30.251293 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m05:00:30.828623 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0f4ae835-8d90-47f1-8872-261d349c04d1&page=queryresults
[0m05:00:32.070439 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 05:00:28.803375 => 05:00:32.069433
[0m05:00:32.071434 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA833AFA0>]}
[0m05:00:32.072439 [info ] [Thread-2  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 3.28s]
[0m05:00:32.074432 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m05:00:32.075389 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m05:00:32.075389 [info ] [Thread-2  ]: 20 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m05:00:32.076358 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m05:00:32.077433 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m05:00:32.082433 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m05:00:32.084331 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 05:00:32.077433 => 05:00:32.083429
[0m05:00:32.084331 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m05:00:32.088336 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:32.714387 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m05:00:32.716284 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m05:00:33.074602 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bea71fe7-60d3-4906-b2bc-27ee6e057735&page=queryresults
[0m05:00:33.296043 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 05:00:29.487132 => 05:00:33.295040
[0m05:00:33.298041 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA8366040>]}
[0m05:00:33.298041 [info ] [Thread-1  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.82s]
[0m05:00:33.300042 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m05:00:33.301096 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m05:00:33.301096 [info ] [Thread-1  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m05:00:33.303043 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m05:00:33.303043 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m05:00:33.308768 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m05:00:33.309776 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 05:00:33.304042 => 05:00:33.309776
[0m05:00:33.310660 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m05:00:33.320775 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:33.972106 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m05:00:33.974999 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m05:00:34.324187 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:75bcaf89-8c6c-4d9c-b9ea-125425ddfe5f&page=queryresults
[0m05:00:36.863673 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 05:00:33.310660 => 05:00:36.863673
[0m05:00:36.866574 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA9510880>]}
[0m05:00:36.869674 [info ] [Thread-1  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.2 KiB processed)[0m in 3.56s]
[0m05:00:36.875569 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m05:00:36.878673 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m05:00:36.882584 [info ] [Thread-1  ]: 22 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m05:00:36.888634 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m05:00:36.891670 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m05:00:36.901669 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m05:00:36.918667 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 05:00:32.085329 => 05:00:36.917675
[0m05:00:36.919635 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA831F9A0>]}
[0m05:00:36.922391 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 05:00:36.893670 => 05:00:36.922391
[0m05:00:36.923412 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m05:00:36.929507 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:36.921174 [info ] [Thread-2  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 4.84s]
[0m05:00:36.931466 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m05:00:36.934481 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m05:00:36.990089 [info ] [Thread-2  ]: 23 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m05:00:36.994202 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m05:00:36.995201 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m05:00:37.003210 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m05:00:37.006202 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 05:00:36.996205 => 05:00:37.006202
[0m05:00:37.007199 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m05:00:37.012196 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:37.615659 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m05:00:37.618554 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m05:00:37.673103 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m05:00:37.676020 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m05:00:37.956795 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:20e193ff-6f45-4740-9624-a820e97a3e65&page=queryresults
[0m05:00:38.235131 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:351fd128-f919-4ca0-916f-50d4034a6b2f&page=queryresults
[0m05:00:40.518967 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 05:00:36.924405 => 05:00:40.518967
[0m05:00:40.520979 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA84C3520>]}
[0m05:00:40.520979 [info ] [Thread-1  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.3 KiB processed)[0m in 3.63s]
[0m05:00:40.520979 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m05:00:40.520979 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m05:00:40.520979 [info ] [Thread-1  ]: 24 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m05:00:40.520979 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m05:00:40.520979 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m05:00:40.534512 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m05:00:40.537147 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 05:00:40.528472 => 05:00:40.537147
[0m05:00:40.537147 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m05:00:40.537147 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:41.200024 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m05:00:41.203024 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m05:00:41.476181 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 05:00:37.008210 => 05:00:41.476181
[0m05:00:41.477806 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA836A880>]}
[0m05:00:41.621601 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d2a77a15-2577-4b38-b69d-ea4832436bed&page=queryresults
[0m05:00:42.392348 [info ] [Thread-2  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 4.48s]
[0m05:00:42.394359 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m05:00:42.396337 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m05:00:42.397348 [info ] [Thread-2  ]: 25 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m05:00:42.399362 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m05:00:42.400348 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m05:00:42.418340 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m05:00:42.420353 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 05:00:42.400348 => 05:00:42.419352
[0m05:00:42.420353 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m05:00:42.423343 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m05:00:43.045235 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m05:00:43.046217 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m05:00:43.691944 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c9091c9e-714c-4a61-9fe3-9f4f1e5ed494&page=queryresults
[0m05:00:44.479732 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 05:00:40.537147 => 05:00:44.479732
[0m05:00:44.480731 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA84BBB50>]}
[0m05:00:44.480731 [info ] [Thread-1  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 3.96s]
[0m05:00:44.481779 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m05:00:44.482823 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m05:00:44.482823 [info ] [Thread-1  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m05:00:44.486815 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m05:00:44.487873 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m05:00:44.494861 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m05:00:44.496857 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 05:00:44.488882 => 05:00:44.495879
[0m05:00:44.496857 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m05:00:44.501479 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m05:00:45.173793 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m05:00:45.175792 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m05:00:45.887111 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:090f9f2d-9c32-4af0-a227-7cd0d5ab9f25&page=queryresults
[0m05:00:46.798731 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 05:00:42.421339 => 05:00:46.797586
[0m05:00:46.800739 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA72F76D0>]}
[0m05:00:46.803743 [info ] [Thread-2  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 4.40s]
[0m05:00:46.805729 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m05:00:51.537131 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 05:00:44.497865 => 05:00:51.537131
[0m05:00:51.539119 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'adcc35c9-9967-4ddd-b897-dba6e158f7db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA84BFBB0>]}
[0m05:00:51.540131 [info ] [Thread-1  ]: 26 of 26 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 7.05s]
[0m05:00:51.541022 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m05:00:51.544113 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:00:51.544113 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:00:51.544113 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:00:51.545114 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m05:00:51.545114 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m05:00:51.546116 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto_base' was properly closed.
[0m05:00:51.546116 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m05:00:51.546116 [info ] [MainThread]: 
[0m05:00:51.547114 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 45.99 seconds (45.99s).
[0m05:00:51.553016 [debug] [MainThread]: Command end result
[0m05:00:51.575841 [info ] [MainThread]: 
[0m05:00:51.576847 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:00:51.577749 [info ] [MainThread]: 
[0m05:00:51.578845 [info ] [MainThread]: Done. PASS=26 WARN=0 ERROR=0 SKIP=0 TOTAL=26
[0m05:00:51.580849 [debug] [MainThread]: Command `dbt run` succeeded at 05:00:51.580849 after 47.09 seconds
[0m05:00:51.581847 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA390B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA6FE9F10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FEA8421430>]}
[0m05:00:51.582846 [debug] [MainThread]: Flushing usage events
[0m05:00:56.060457 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC36E53400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC35DD4940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC35DD4B80>]}


============================== 05:00:56.067466 | 9f8332f0-d1b3-4ade-a223-6445ea7a4606 ==============================
[0m05:00:56.067466 [info ] [MainThread]: Running with dbt=1.7.4
[0m05:00:56.068442 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m05:00:56.911694 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9f8332f0-d1b3-4ade-a223-6445ea7a4606', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC35DB98E0>]}
[0m05:00:56.969686 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9f8332f0-d1b3-4ade-a223-6445ea7a4606', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC3A4AF490>]}
[0m05:00:56.971650 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m05:00:56.981098 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m05:00:57.035007 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:00:57.035007 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:00:57.040008 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9f8332f0-d1b3-4ade-a223-6445ea7a4606', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC3A7B4F10>]}
[0m05:00:57.053791 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9f8332f0-d1b3-4ade-a223-6445ea7a4606', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC3A6CFAC0>]}
[0m05:00:57.054736 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m05:00:57.054736 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9f8332f0-d1b3-4ade-a223-6445ea7a4606', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC3A6CFBB0>]}
[0m05:00:57.056766 [info ] [MainThread]: 
[0m05:00:57.058736 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m05:00:57.059767 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:00:57.060953 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:57.750480 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m05:00:57.752492 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m05:00:57.753487 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:57.753487 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:00:58.392967 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m05:00:58.395964 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:58.402742 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m05:00:58.430724 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:00:59.044899 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9f8332f0-d1b3-4ade-a223-6445ea7a4606', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC3A56EB80>]}
[0m05:00:59.045942 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m05:00:59.046930 [info ] [MainThread]: 
[0m05:00:59.053930 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m05:00:59.054942 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m05:00:59.056884 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m05:00:59.057891 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m05:00:59.075964 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 05:00:59.057891 => 05:00:59.074963
[0m05:00:59.075964 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m05:00:59.122832 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m05:00:59.123833 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m05:00:59.906978 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:84fdc1fb-1062-45fb-8cda-cadd8cbce843&page=queryresults
[0m05:01:01.140596 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m05:01:01.596355 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:77bbb655-ef3e-4d9d-ab9a-aed69a8121b9&page=queryresults
[0m05:01:03.952871 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m05:01:04.649498 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m05:01:04.651501 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m05:01:05.072284 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1d7723c1-05b2-4e9b-bb8d-9268e4c4d19f&page=queryresults
[0m05:01:07.638003 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 05:00:59.075964 => 05:01:07.638003
[0m05:01:07.640810 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9f8332f0-d1b3-4ade-a223-6445ea7a4606', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC3B85D400>]}
[0m05:01:07.642811 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 96.0 KiB processed)[0m in 8.58s]
[0m05:01:07.644801 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m05:01:07.648763 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:01:07.649759 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:01:07.649759 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m05:01:07.650759 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m05:01:07.651768 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m05:01:07.652768 [info ] [MainThread]: 
[0m05:01:07.653709 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.59 seconds (10.59s).
[0m05:01:07.654779 [debug] [MainThread]: Command end result
[0m05:01:07.678733 [info ] [MainThread]: 
[0m05:01:07.679778 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:01:07.680639 [info ] [MainThread]: 
[0m05:01:07.681651 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m05:01:07.683977 [debug] [MainThread]: Command `dbt snapshot` succeeded at 05:01:07.683977 after 11.69 seconds
[0m05:01:07.684976 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC36E53400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC3A3E5100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FC3A46FC10>]}
[0m05:01:07.685926 [debug] [MainThread]: Flushing usage events
[0m05:01:12.469110 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DD716C3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DD70636640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DD70636AC0>]}


============================== 05:01:12.477156 | 4891c403-01ce-48a8-9c76-edd0a8572683 ==============================
[0m05:01:12.477156 [info ] [MainThread]: Running with dbt=1.7.4
[0m05:01:12.479158 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m05:01:13.282798 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '4891c403-01ce-48a8-9c76-edd0a8572683', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DD7061F970>]}
[0m05:01:13.340799 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '4891c403-01ce-48a8-9c76-edd0a8572683', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DD74C26520>]}
[0m05:01:13.343131 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m05:01:13.348280 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m05:01:13.399100 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m05:01:13.399100 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m05:01:13.404101 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4891c403-01ce-48a8-9c76-edd0a8572683', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DD75025EE0>]}
[0m05:01:13.415894 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4891c403-01ce-48a8-9c76-edd0a8572683', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DD74F3BEB0>]}
[0m05:01:13.416885 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m05:01:13.417818 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4891c403-01ce-48a8-9c76-edd0a8572683', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DD74F3BC10>]}
[0m05:01:13.418848 [info ] [MainThread]: 
[0m05:01:13.420463 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m05:01:13.422564 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m05:01:13.422564 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:01:14.103277 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m05:01:14.104154 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:01:14.104154 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m05:01:14.107410 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m05:01:14.727661 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m05:01:14.729640 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:01:14.772381 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m05:01:14.775376 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m05:01:15.412342 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '4891c403-01ce-48a8-9c76-edd0a8572683', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DD74D5DFA0>]}
[0m05:01:15.413340 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m05:01:15.415300 [info ] [MainThread]: 
[0m05:01:15.422976 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m05:01:15.423965 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m05:01:15.426959 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m05:01:15.427956 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m05:01:15.443029 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m05:01:15.445914 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 05:01:15.427956 => 05:01:15.444960
[0m05:01:15.446960 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m05:01:15.460080 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m05:01:16.154689 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m05:01:16.155690 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m05:01:16.576462 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:67b3f756-7d75-48fa-b189-60ca624a8036&page=queryresults
[0m05:01:19.133416 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 05:01:15.447963 => 05:01:19.133416
[0m05:01:19.134413 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4891c403-01ce-48a8-9c76-edd0a8572683', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DD7609B520>]}
[0m05:01:19.134413 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (443.0 rows, 81.5 KiB processed)[0m in 3.71s]
[0m05:01:19.135438 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m05:01:19.136326 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m05:01:19.137362 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m05:01:19.138087 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m05:01:19.138087 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m05:01:19.141093 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m05:01:19.141093 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 05:01:19.138087 => 05:01:19.141093
[0m05:01:19.142094 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m05:01:19.143094 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m05:01:19.939576 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m05:01:19.942491 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m05:01:20.336710 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ad367f59-4e11-4979-89b5-0af6ef536e55&page=queryresults
[0m05:01:22.547949 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 05:01:19.142094 => 05:01:22.547949
[0m05:01:22.549938 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4891c403-01ce-48a8-9c76-edd0a8572683', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DD760C7490>]}
[0m05:01:22.549938 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (355.0 rows, 107.7 KiB processed)[0m in 3.41s]
[0m05:01:22.551951 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m05:01:22.554881 [debug] [MainThread]: Connection 'master' was properly closed.
[0m05:01:22.555891 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m05:01:22.555891 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m05:01:22.556899 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m05:01:22.557886 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m05:01:22.557886 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m05:01:22.558896 [info ] [MainThread]: 
[0m05:01:22.559866 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 9.14 seconds (9.14s).
[0m05:01:22.560866 [debug] [MainThread]: Command end result
[0m05:01:22.584865 [info ] [MainThread]: 
[0m05:01:22.585835 [info ] [MainThread]: [32mCompleted successfully[0m
[0m05:01:22.585835 [info ] [MainThread]: 
[0m05:01:22.586866 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m05:01:22.587878 [debug] [MainThread]: Command `dbt run` succeeded at 05:01:22.587878 after 10.18 seconds
[0m05:01:22.588867 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DD716C3400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DD74DAA460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DD70636130>]}
[0m05:01:22.588867 [debug] [MainThread]: Flushing usage events
[0m06:00:05.094753 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014866553460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148654DF9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000148654DFD30>]}


============================== 06:00:05.103755 | ff701472-cae6-425b-9cc0-d3dc6c40aa09 ==============================
[0m06:00:05.103755 [info ] [MainThread]: Running with dbt=1.7.4
[0m06:00:05.104755 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --exclude tag:snaps', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m06:00:05.961304 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486869AA90>]}
[0m06:00:06.017816 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014868E99A60>]}
[0m06:00:06.019816 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m06:00:06.025695 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m06:00:06.087202 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m06:00:06.087202 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m06:00:06.091203 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014869EB5E80>]}
[0m06:00:06.106207 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014869DC89A0>]}
[0m06:00:06.107205 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m06:00:06.107205 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014869DC8A90>]}
[0m06:00:06.110237 [info ] [MainThread]: 
[0m06:00:06.111255 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m06:00:06.114222 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:06.115244 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:06.137220 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:06.138217 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:06.988260 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:07.752406 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m06:00:07.752406 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m06:00:07.753405 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:07.753405 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:08.609584 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m06:00:08.610587 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:08.725463 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m06:00:08.728460 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:09.342985 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014869B51A00>]}
[0m06:00:09.344073 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m06:00:09.345987 [info ] [MainThread]: 
[0m06:00:09.355211 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:09.356211 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m06:00:09.357172 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m06:00:09.358206 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m06:00:09.364305 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m06:00:09.366296 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m06:00:09.379229 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m06:00:09.381305 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m06:00:09.381305 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:09.384299 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m06:00:09.385179 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 06:00:09.368300 => 06:00:09.385179
[0m06:00:09.386169 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m06:00:09.394233 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 06:00:09.381305 => 06:00:09.394233
[0m06:00:09.409485 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:09.418485 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m06:00:09.421487 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m06:00:09.421487 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m06:00:09.422489 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m06:00:09.424487 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m06:00:09.424487 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m06:00:10.293472 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:008af3a9-ecf4-421d-ab25-998469c829d3&page=queryresults
[0m06:00:10.552093 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f9b19ec5-6ba0-4f4c-b9b4-9f8fb87207f9&page=queryresults
[0m06:00:10.736187 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 06:00:09.418485 => 06:00:10.735186
[0m06:00:10.736187 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486AFC67C0>]}
[0m06:00:10.737187 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.38s]
[0m06:00:10.738158 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m06:00:10.739212 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m06:00:10.741211 [info ] [Thread-1  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m06:00:10.743203 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m06:00:10.745206 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m06:00:10.754194 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m06:00:10.756148 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 06:00:10.746162 => 06:00:10.755150
[0m06:00:10.756148 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m06:00:10.763200 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m06:00:10.764150 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:10.767147 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m06:00:11.001371 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 06:00:09.386169 => 06:00:11.001371
[0m06:00:11.003378 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486AFE8670>]}
[0m06:00:11.004374 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.64s]
[0m06:00:11.005328 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m06:00:11.006367 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_compra
[0m06:00:11.007377 [info ] [Thread-2  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m06:00:11.008373 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_compra)
[0m06:00:11.009375 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_compra
[0m06:00:11.014090 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m06:00:11.015000 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (compile): 06:00:11.009375 => 06:00:11.015000
[0m06:00:11.015000 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_compra
[0m06:00:11.017083 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m06:00:11.018095 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:11.019057 [debug] [Thread-2  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m06:00:11.508972 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:066d1dc9-351c-433e-a709-2ec3d19ce9f1&page=queryresults
[0m06:00:11.792692 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b0af9a55-e8ae-414b-91c1-b1693b84e11a&page=queryresults
[0m06:00:11.931803 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 06:00:10.757183 => 06:00:11.930794
[0m06:00:11.932797 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486AFAB100>]}
[0m06:00:11.933799 [info ] [Thread-1  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m06:00:11.935711 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m06:00:11.937714 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m06:00:11.938714 [info ] [Thread-1  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m06:00:11.940708 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m06:00:11.941703 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m06:00:11.947581 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m06:00:11.948581 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 06:00:11.941703 => 06:00:11.948581
[0m06:00:11.949582 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m06:00:11.953577 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m06:00:11.954580 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:11.955576 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m06:00:12.191539 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (execute): 06:00:11.015000 => 06:00:12.191539
[0m06:00:12.192540 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486AF40E50>]}
[0m06:00:12.192540 [info ] [Thread-2  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m06:00:12.194621 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_compra
[0m06:00:12.195614 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m06:00:12.196613 [info ] [Thread-2  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m06:00:12.198661 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m06:00:12.199658 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m06:00:12.206849 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m06:00:12.209841 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 06:00:12.199658 => 06:00:12.209841
[0m06:00:12.210817 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m06:00:12.217805 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m06:00:12.218427 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:12.219465 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m06:00:12.721382 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ebe8764e-519d-4aa1-b384-6ab27a637420&page=queryresults
[0m06:00:12.952611 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6a0e4366-e61f-4cf6-a428-0da016d32c81&page=queryresults
[0m06:00:13.159918 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 06:00:11.950583 => 06:00:13.159918
[0m06:00:13.161860 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486AF40D30>]}
[0m06:00:13.162867 [info ] [Thread-1  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m06:00:13.164823 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m06:00:13.165822 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m06:00:13.165822 [info ] [Thread-1  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m06:00:13.166822 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m06:00:13.167848 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m06:00:13.169852 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m06:00:13.170821 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 06:00:13.167848 => 06:00:13.170821
[0m06:00:13.171822 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m06:00:13.173821 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m06:00:13.174822 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:13.175822 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m06:00:13.440221 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 06:00:12.211797 => 06:00:13.440221
[0m06:00:13.441216 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486AF40FD0>]}
[0m06:00:13.441216 [info ] [Thread-2  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m06:00:13.443392 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m06:00:13.444383 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m06:00:13.445446 [info ] [Thread-2  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m06:00:13.447383 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m06:00:13.447383 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m06:00:13.451377 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m06:00:13.452378 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 06:00:13.448378 => 06:00:13.452378
[0m06:00:13.453377 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m06:00:13.456378 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m06:00:13.457378 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:13.459378 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m06:00:14.139481 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e83cbc00-643b-4708-bb69-deda2f51f253&page=queryresults
[0m06:00:14.372625 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:97f2bac1-c0a8-4b34-858d-e71fe52818c5&page=queryresults
[0m06:00:14.564154 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 06:00:13.171822 => 06:00:14.564154
[0m06:00:14.565150 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486B07D670>]}
[0m06:00:14.566154 [info ] [Thread-1  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m06:00:14.567152 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m06:00:14.569161 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:14.570158 [info ] [Thread-1  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m06:00:14.572083 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m06:00:14.573125 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:14.579124 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m06:00:14.580126 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 06:00:14.573125 => 06:00:14.580126
[0m06:00:14.581025 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:14.589123 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m06:00:14.589123 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:14.590024 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m06:00:14.806154 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 06:00:13.453377 => 06:00:14.806154
[0m06:00:14.807152 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486B077580>]}
[0m06:00:14.807152 [info ] [Thread-2  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m06:00:14.809165 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m06:00:14.810162 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m06:00:14.811162 [info ] [Thread-2  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m06:00:14.813113 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m06:00:14.814122 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m06:00:14.819129 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m06:00:14.820235 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 06:00:14.814122 => 06:00:14.820235
[0m06:00:14.821237 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m06:00:14.825239 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m06:00:14.827235 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:14.829239 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m06:00:15.322478 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:47726d3b-ced5-4dcc-b2b1-11ec0589800a&page=queryresults
[0m06:00:15.501455 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:764e76f7-6538-4303-8a7b-7f56d5196375&page=queryresults
[0m06:00:15.720521 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 06:00:14.581025 => 06:00:15.720521
[0m06:00:15.722520 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486B01C3A0>]}
[0m06:00:15.723519 [info ] [Thread-1  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m06:00:15.725259 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m06:00:15.726351 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m06:00:15.727274 [info ] [Thread-1  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m06:00:15.727930 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m06:00:15.728940 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m06:00:15.731937 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m06:00:15.732937 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 06:00:15.728940 => 06:00:15.731937
[0m06:00:15.732937 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m06:00:15.734936 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m06:00:15.734936 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:15.735937 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m06:00:15.862142 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 06:00:14.821237 => 06:00:15.862142
[0m06:00:15.863143 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486B01C490>]}
[0m06:00:15.864142 [info ] [Thread-2  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.05s]
[0m06:00:15.865147 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m06:00:15.865147 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m06:00:15.866039 [info ] [Thread-2  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m06:00:15.867141 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m06:00:15.868149 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m06:00:15.874145 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m06:00:15.876042 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 06:00:15.868149 => 06:00:15.875042
[0m06:00:15.876042 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m06:00:15.881041 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m06:00:15.882041 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:15.884039 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m06:00:16.425758 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:86856284-76fe-48d2-b5c1-5a1e316f8459&page=queryresults
[0m06:00:16.597830 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f16e880b-d1aa-45d1-9ddb-3fa1c703a3f7&page=queryresults
[0m06:00:16.838733 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 06:00:15.732937 => 06:00:16.838733
[0m06:00:16.839722 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486C0C8700>]}
[0m06:00:16.841826 [info ] [Thread-1  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.11s]
[0m06:00:16.841826 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m06:00:16.841826 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m06:00:16.843483 [info ] [Thread-1  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m06:00:16.844654 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m06:00:16.844654 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m06:00:16.849585 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m06:00:16.850626 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 06:00:16.845570 => 06:00:16.850626
[0m06:00:16.850626 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m06:00:16.853900 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m06:00:16.854891 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:16.858359 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m06:00:16.966621 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 06:00:15.877042 => 06:00:16.965617
[0m06:00:16.968631 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486B01BAF0>]}
[0m06:00:16.969629 [info ] [Thread-2  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.10s]
[0m06:00:16.972623 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m06:00:16.973640 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m06:00:16.974617 [info ] [Thread-2  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m06:00:16.976613 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.dm_produto)
[0m06:00:16.977619 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m06:00:16.982619 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m06:00:16.984514 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 06:00:16.978631 => 06:00:16.983615
[0m06:00:16.984514 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m06:00:16.994513 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:17.569084 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:053c31c8-d649-46df-9c48-d9cfada6163f&page=queryresults
[0m06:00:17.638437 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m06:00:17.640428 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m06:00:17.946529 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 06:00:16.851877 => 06:00:17.946529
[0m06:00:17.947528 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486B01BE20>]}
[0m06:00:17.948527 [info ] [Thread-1  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.10s]
[0m06:00:17.950504 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m06:00:18.330378 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:78b26e3f-c340-4f65-aa9f-adc33fb465f3&page=queryresults
[0m06:00:21.166285 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 06:00:16.984514 => 06:00:21.166285
[0m06:00:21.167277 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486AFFCCD0>]}
[0m06:00:21.168193 [info ] [Thread-2  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 4.19s]
[0m06:00:21.169202 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m06:00:21.170188 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m06:00:21.171657 [info ] [Thread-1  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m06:00:21.172671 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m06:00:21.172671 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m06:00:21.178703 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m06:00:21.180666 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 06:00:21.173697 => 06:00:21.179704
[0m06:00:21.180666 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m06:00:21.186708 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:21.805968 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m06:00:21.810836 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m06:00:22.492402 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0107eb57-8672-4ca0-976c-2142ef35421a&page=queryresults
[0m06:00:25.956767 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 06:00:21.180666 => 06:00:25.956767
[0m06:00:25.957768 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486B03AFD0>]}
[0m06:00:25.958778 [info ] [Thread-1  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 4.79s]
[0m06:00:25.960670 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m06:00:25.961669 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m06:00:25.961669 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m06:00:25.962668 [info ] [Thread-2  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m06:00:25.964669 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m06:00:25.964669 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m06:00:25.969761 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m06:00:25.963668 [info ] [Thread-1  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m06:00:25.971669 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m06:00:25.971669 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m06:00:25.977668 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m06:00:25.979668 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 06:00:25.972668 => 06:00:25.978669
[0m06:00:25.979668 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m06:00:25.983769 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:26.026283 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 06:00:25.965668 => 06:00:26.026283
[0m06:00:26.027445 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m06:00:26.030389 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:26.834338 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m06:00:26.836238 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m06:00:26.865225 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m06:00:26.868119 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m06:00:27.494059 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:05631281-4370-45f3-84bf-af3867647579&page=queryresults
[0m06:00:27.521139 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2b9a7218-2769-478f-a0ac-dfc50358095e&page=queryresults
[0m06:00:29.435519 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 06:00:26.027445 => 06:00:29.435519
[0m06:00:29.437134 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486B0DC8B0>]}
[0m06:00:29.438257 [info ] [Thread-2  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 3.47s]
[0m06:00:29.439144 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m06:00:29.439144 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m06:00:29.439144 [info ] [Thread-2  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m06:00:29.441148 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m06:00:29.441148 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m06:00:29.445144 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m06:00:29.447525 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 06:00:29.441148 => 06:00:29.447525
[0m06:00:29.447525 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m06:00:29.457626 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:29.745160 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 06:00:25.980668 => 06:00:29.745160
[0m06:00:29.746263 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486C1869A0>]}
[0m06:00:29.747255 [info ] [Thread-1  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 3.78s]
[0m06:00:29.749225 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m06:00:29.750262 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m06:00:29.751158 [info ] [Thread-1  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m06:00:29.752155 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m06:00:29.754159 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m06:00:29.760251 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m06:00:29.762210 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 06:00:29.754159 => 06:00:29.762210
[0m06:00:29.763159 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m06:00:29.766157 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:30.188217 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m06:00:30.190223 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m06:00:30.416135 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m06:00:30.419033 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m06:00:30.583435 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3d75c7ad-c9e2-45d4-b851-1bb4e4b77d52&page=queryresults
[0m06:00:30.977003 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:37d1b14c-e83f-48ed-8f8a-c83fb75c5fe6&page=queryresults
[0m06:00:32.619581 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 06:00:29.448629 => 06:00:32.619581
[0m06:00:32.620574 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486AFE4160>]}
[0m06:00:32.621573 [info ] [Thread-2  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 3.18s]
[0m06:00:32.623480 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m06:00:32.623480 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m06:00:32.624478 [info ] [Thread-2  ]: 20 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m06:00:32.626479 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m06:00:32.626479 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m06:00:32.631477 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m06:00:32.632478 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 06:00:32.626479 => 06:00:32.632478
[0m06:00:32.633576 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m06:00:32.636584 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:33.314976 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m06:00:33.317884 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m06:00:33.699577 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4f6fd3cd-256d-4436-a05b-3c17f104a71b&page=queryresults
[0m06:00:33.795642 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 06:00:29.763159 => 06:00:33.794659
[0m06:00:33.796643 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486C1A1AF0>]}
[0m06:00:33.797644 [info ] [Thread-1  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.04s]
[0m06:00:33.799642 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m06:00:33.801697 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m06:00:33.802706 [info ] [Thread-1  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m06:00:33.804605 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m06:00:33.805603 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m06:00:33.811599 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m06:00:33.813602 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 06:00:33.805603 => 06:00:33.812601
[0m06:00:33.814602 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m06:00:33.826666 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:34.500585 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m06:00:34.504585 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m06:00:34.919829 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8ae3a90b-ae4b-46de-88ce-9781aaa5f5d3&page=queryresults
[0m06:00:35.884036 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 06:00:32.633576 => 06:00:35.882916
[0m06:00:35.885030 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486B0DCD90>]}
[0m06:00:35.886029 [info ] [Thread-2  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 3.26s]
[0m06:00:35.887985 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m06:00:35.889038 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m06:00:35.890026 [info ] [Thread-2  ]: 22 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m06:00:35.890973 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m06:00:35.892021 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m06:00:35.963777 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m06:00:35.965779 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 06:00:35.892021 => 06:00:35.964822
[0m06:00:35.965779 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m06:00:35.967778 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:36.575575 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m06:00:36.577574 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m06:00:37.146521 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 06:00:33.814602 => 06:00:37.146521
[0m06:00:37.147525 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486C1254F0>]}
[0m06:00:37.148522 [info ] [Thread-1  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.2 KiB processed)[0m in 3.34s]
[0m06:00:37.149416 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m06:00:37.150483 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m06:00:37.150483 [info ] [Thread-1  ]: 23 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m06:00:37.152420 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m06:00:37.152420 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m06:00:37.158417 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m06:00:37.160419 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:80c784bf-6dd6-4b65-8527-175febcfeb23&page=queryresults
[0m06:00:37.164422 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 06:00:37.152420 => 06:00:37.164422
[0m06:00:37.165417 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m06:00:37.168418 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:37.938383 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m06:00:37.941497 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m06:00:38.378212 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:acc65a88-e73a-4e5e-847d-add7907dc157&page=queryresults
[0m06:00:39.935497 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 06:00:35.965779 => 06:00:39.935497
[0m06:00:39.937502 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486B0D96D0>]}
[0m06:00:39.938501 [info ] [Thread-2  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 4.05s]
[0m06:00:39.939910 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m06:00:39.940921 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m06:00:39.942016 [info ] [Thread-2  ]: 24 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m06:00:39.942923 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m06:00:39.943923 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m06:00:39.950921 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m06:00:39.953244 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 06:00:39.943923 => 06:00:39.951921
[0m06:00:39.953244 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m06:00:39.956257 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:40.618015 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m06:00:40.621016 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m06:00:41.199282 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 06:00:37.165417 => 06:00:41.198280
[0m06:00:41.200281 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486C0CD4F0>]}
[0m06:00:41.275084 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6d710cc2-2bbb-4eaa-8a75-ecccaaed543b&page=queryresults
[0m06:00:41.923438 [info ] [Thread-1  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.3 KiB processed)[0m in 4.05s]
[0m06:00:41.925436 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m06:00:41.926534 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m06:00:41.928440 [info ] [Thread-1  ]: 25 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m06:00:41.929521 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m06:00:41.930535 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m06:00:41.937434 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m06:00:41.939433 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 06:00:41.930535 => 06:00:41.939433
[0m06:00:41.940436 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m06:00:41.944533 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m06:00:42.572717 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m06:00:42.575612 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m06:00:42.999874 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a7d0bd98-d68b-42a0-a314-768465134d8f&page=queryresults
[0m06:00:43.816544 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 06:00:39.954257 => 06:00:43.815548
[0m06:00:43.817545 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486AF32100>]}
[0m06:00:43.818544 [info ] [Thread-2  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 3.87s]
[0m06:00:43.819446 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m06:00:46.106352 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 06:00:41.941538 => 06:00:46.106352
[0m06:00:46.107342 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486B01B310>]}
[0m06:00:46.108347 [info ] [Thread-1  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 4.18s]
[0m06:00:46.108347 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m06:00:46.110289 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m06:00:46.110289 [info ] [Thread-2  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m06:00:46.111335 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m06:00:46.112338 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m06:00:46.117341 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m06:00:46.119243 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 06:00:46.112338 => 06:00:46.118243
[0m06:00:46.119243 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m06:00:46.123242 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m06:00:46.807379 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m06:00:46.809380 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m06:00:47.440072 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:26fc71c5-b1fc-40ae-a9a1-3924769ecac6&page=queryresults
[0m06:00:50.575513 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 06:00:46.120244 => 06:00:50.574505
[0m06:00:50.576497 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff701472-cae6-425b-9cc0-d3dc6c40aa09', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001486C1253D0>]}
[0m06:00:50.577511 [info ] [Thread-2  ]: 26 of 26 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 4.47s]
[0m06:00:50.577511 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m06:00:50.580745 [debug] [MainThread]: Connection 'master' was properly closed.
[0m06:00:50.580745 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:00:50.580745 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:00:50.581745 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m06:00:50.581745 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m06:00:50.582743 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m06:00:50.582743 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m06:00:50.582743 [info ] [MainThread]: 
[0m06:00:50.583743 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 44.47 seconds (44.47s).
[0m06:00:50.588740 [debug] [MainThread]: Command end result
[0m06:00:50.615871 [info ] [MainThread]: 
[0m06:00:50.617873 [info ] [MainThread]: [32mCompleted successfully[0m
[0m06:00:50.618920 [info ] [MainThread]: 
[0m06:00:50.619873 [info ] [MainThread]: Done. PASS=26 WARN=0 ERROR=0 SKIP=0 TOTAL=26
[0m06:00:50.621605 [debug] [MainThread]: Command `dbt run` succeeded at 06:00:50.620419 after 45.59 seconds
[0m06:00:50.621605 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014866553460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014868E99A60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000014869F37BE0>]}
[0m06:00:50.622605 [debug] [MainThread]: Flushing usage events
[0m06:00:54.426631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F375834C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F365042E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F36504760>]}


============================== 06:00:54.435506 | 64f52dad-0599-4b75-95fe-f6ebe9533b0f ==============================
[0m06:00:54.435506 [info ] [MainThread]: Running with dbt=1.7.4
[0m06:00:54.436550 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt snapshot', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m06:00:55.280223 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '64f52dad-0599-4b75-95fe-f6ebe9533b0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F37DCD2E0>]}
[0m06:00:55.337011 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '64f52dad-0599-4b75-95fe-f6ebe9533b0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F3ABF05B0>]}
[0m06:00:55.338883 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m06:00:55.344969 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m06:00:55.394819 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m06:00:55.394819 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m06:00:55.398821 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '64f52dad-0599-4b75-95fe-f6ebe9533b0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F3AEE4F10>]}
[0m06:00:55.413811 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '64f52dad-0599-4b75-95fe-f6ebe9533b0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F3ADFB070>]}
[0m06:00:55.414739 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m06:00:55.415750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '64f52dad-0599-4b75-95fe-f6ebe9533b0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F3ADFBC40>]}
[0m06:00:55.416780 [info ] [MainThread]: 
[0m06:00:55.417456 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m06:00:55.419409 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:00:55.419409 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:56.339106 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m06:00:56.341104 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m06:00:56.341104 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:56.342099 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:00:57.007415 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m06:00:57.010412 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:57.037407 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m06:00:57.038407 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:00:57.667584 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '64f52dad-0599-4b75-95fe-f6ebe9533b0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F3AB82AC0>]}
[0m06:00:57.668624 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m06:00:57.669599 [info ] [MainThread]: 
[0m06:00:57.677585 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m06:00:57.678584 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m06:00:57.680594 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m06:00:57.681609 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m06:00:57.694758 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 06:00:57.681609 => 06:00:57.694758
[0m06:00:57.694758 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m06:00:57.738276 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m06:00:57.739279 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m06:00:58.544581 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:46d7c4fe-682a-402c-ba95-fe3673bf2ad6&page=queryresults
[0m06:00:59.652827 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m06:01:00.062560 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2c4cd5e7-c030-45e2-859c-1899ffa5c3ac&page=queryresults
[0m06:01:02.467730 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m06:01:03.237611 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m06:01:03.239616 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m06:01:03.647108 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f34eae21-dfdf-4a71-855c-7bf421111931&page=queryresults
[0m06:01:06.147954 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 06:00:57.695741 => 06:01:06.147954
[0m06:01:06.148949 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '64f52dad-0599-4b75-95fe-f6ebe9533b0f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F3BF8B100>]}
[0m06:01:06.149955 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 96.0 KiB processed)[0m in 8.47s]
[0m06:01:06.151369 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m06:01:06.154739 [debug] [MainThread]: Connection 'master' was properly closed.
[0m06:01:06.154739 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:01:06.154739 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m06:01:06.155739 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m06:01:06.155739 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m06:01:06.156742 [info ] [MainThread]: 
[0m06:01:06.157739 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.74 seconds (10.74s).
[0m06:01:06.158739 [debug] [MainThread]: Command end result
[0m06:01:06.171740 [info ] [MainThread]: 
[0m06:01:06.172745 [info ] [MainThread]: [32mCompleted successfully[0m
[0m06:01:06.173211 [info ] [MainThread]: 
[0m06:01:06.174264 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m06:01:06.175262 [debug] [MainThread]: Command `dbt snapshot` succeeded at 06:01:06.175262 after 11.83 seconds
[0m06:01:06.176269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F375834C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F3AB7E7C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018F3AAEBEE0>]}
[0m06:01:06.177265 [debug] [MainThread]: Flushing usage events
[0m06:01:10.348414 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F732553460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F7314C99A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F7314C9D30>]}


============================== 06:01:10.357635 | f306d92f-9a01-49ed-8a72-72e5fe59c6ad ==============================
[0m06:01:10.357635 [info ] [MainThread]: Running with dbt=1.7.4
[0m06:01:10.358669 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select tag:snaps', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m06:01:11.193851 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f306d92f-9a01-49ed-8a72-72e5fe59c6ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F7314C2970>]}
[0m06:01:11.250857 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f306d92f-9a01-49ed-8a72-72e5fe59c6ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F735BC12B0>]}
[0m06:01:11.253477 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m06:01:11.258935 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m06:01:11.309714 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m06:01:11.310714 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m06:01:11.315612 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f306d92f-9a01-49ed-8a72-72e5fe59c6ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F735EB5C70>]}
[0m06:01:11.330580 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f306d92f-9a01-49ed-8a72-72e5fe59c6ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F735DCB760>]}
[0m06:01:11.331677 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m06:01:11.332692 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f306d92f-9a01-49ed-8a72-72e5fe59c6ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F735DCB880>]}
[0m06:01:11.333676 [info ] [MainThread]: 
[0m06:01:11.334661 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m06:01:11.336615 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m06:01:11.336615 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:01:12.019753 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m06:01:12.021173 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:01:12.022316 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m06:01:12.023320 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m06:01:12.635970 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m06:01:12.637993 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:01:12.641273 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m06:01:12.644198 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m06:01:13.301849 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f306d92f-9a01-49ed-8a72-72e5fe59c6ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F735B0C9D0>]}
[0m06:01:13.302861 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m06:01:13.303961 [info ] [MainThread]: 
[0m06:01:13.311855 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m06:01:13.312868 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m06:01:13.315869 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m06:01:13.315869 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m06:01:13.333861 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m06:01:13.337865 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 06:01:13.316868 => 06:01:13.336863
[0m06:01:13.338858 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m06:01:13.358955 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m06:01:14.117733 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m06:01:14.119601 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m06:01:14.564920 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9982a5d9-168d-488c-abe5-3477b4b368a9&page=queryresults
[0m06:01:20.327246 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 06:01:13.339860 => 06:01:20.327246
[0m06:01:20.328846 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f306d92f-9a01-49ed-8a72-72e5fe59c6ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F735F3FDF0>]}
[0m06:01:20.328846 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (443.0 rows, 81.5 KiB processed)[0m in 7.01s]
[0m06:01:20.329949 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m06:01:20.331947 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m06:01:20.331947 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m06:01:20.332951 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m06:01:20.333949 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m06:01:20.338947 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m06:01:20.339945 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 06:01:20.333949 => 06:01:20.339945
[0m06:01:20.340854 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m06:01:20.343951 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m06:01:21.068782 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m06:01:21.069774 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m06:01:21.497118 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:24616b0f-9400-4d15-8545-fb5735c96223&page=queryresults
[0m06:01:23.700068 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 06:01:20.340854 => 06:01:23.700068
[0m06:01:23.702067 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f306d92f-9a01-49ed-8a72-72e5fe59c6ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F735F3FB50>]}
[0m06:01:23.704070 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (355.0 rows, 107.7 KiB processed)[0m in 3.37s]
[0m06:01:23.705066 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m06:01:23.709115 [debug] [MainThread]: Connection 'master' was properly closed.
[0m06:01:23.710113 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m06:01:23.711114 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m06:01:23.712111 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m06:01:23.712111 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m06:01:23.713119 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m06:01:23.714114 [info ] [MainThread]: 
[0m06:01:23.716115 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 12.38 seconds (12.38s).
[0m06:01:23.719118 [debug] [MainThread]: Command end result
[0m06:01:23.747647 [info ] [MainThread]: 
[0m06:01:23.748751 [info ] [MainThread]: [32mCompleted successfully[0m
[0m06:01:23.749707 [info ] [MainThread]: 
[0m06:01:23.749707 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m06:01:23.751705 [debug] [MainThread]: Command `dbt run` succeeded at 06:01:23.750704 after 13.47 seconds
[0m06:01:23.751705 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F732553460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F7301D76D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F735BEDFD0>]}
[0m06:01:23.752705 [debug] [MainThread]: Flushing usage events
[0m07:00:04.991425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFB8B13460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFB7A9F6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFB7A9FE20>]}


============================== 07:00:04.998969 | cd366da6-dc79-4e32-934b-1f4dec323270 ==============================
[0m07:00:04.998969 [info ] [MainThread]: Running with dbt=1.7.4
[0m07:00:05.000973 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m07:00:05.827214 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFB7A85BB0>]}
[0m07:00:05.902634 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBC0AB130>]}
[0m07:00:05.904603 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m07:00:05.914601 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m07:00:05.997167 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m07:00:05.997167 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m07:00:06.004392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBC475F10>]}
[0m07:00:06.020411 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBC388A00>]}
[0m07:00:06.021394 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m07:00:06.021394 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBC388B20>]}
[0m07:00:06.023494 [info ] [MainThread]: 
[0m07:00:06.024517 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m07:00:06.026490 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:06.026490 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:06.027479 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:06.028470 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:07.157310 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:07.906469 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m07:00:07.908081 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:07.909136 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m07:00:07.911381 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:08.627778 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m07:00:08.635784 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:08.668790 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m07:00:08.669781 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:09.363742 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBC1D0B80>]}
[0m07:00:09.365705 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m07:00:09.366708 [info ] [MainThread]: 
[0m07:00:09.376749 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:09.377755 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m07:00:09.379747 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m07:00:09.380748 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m07:00:09.387706 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m07:00:09.390731 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m07:00:09.408777 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m07:00:09.415346 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m07:00:09.415346 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:09.421400 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m07:00:09.423354 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 07:00:09.393754 => 07:00:09.422360
[0m07:00:09.423354 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m07:00:09.462359 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m07:00:09.464357 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 07:00:09.416389 => 07:00:09.463365
[0m07:00:09.465359 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:09.473361 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m07:00:09.475354 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m07:00:09.477389 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m07:00:09.502534 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m07:00:09.504617 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m07:00:10.406388 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c18c6b18-2d50-487b-b00f-02a1020d6e14&page=queryresults
[0m07:00:10.409489 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2ea7f000-27a6-4307-bc8f-45b5d0bbf1de&page=queryresults
[0m07:00:10.866747 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 07:00:09.466363 => 07:00:10.865709
[0m07:00:10.867720 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD572370>]}
[0m07:00:10.870714 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 07:00:09.424354 => 07:00:10.869708
[0m07:00:10.871615 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.49s]
[0m07:00:10.872611 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBC4D94F0>]}
[0m07:00:10.874614 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m07:00:10.875615 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m07:00:10.874614 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.49s]
[0m07:00:10.877617 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m07:00:10.877617 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_compra
[0m07:00:10.876611 [info ] [Thread-1  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m07:00:10.879619 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m07:00:10.878622 [info ] [Thread-2  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m07:00:10.881618 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m07:00:10.882623 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_compra)
[0m07:00:10.889705 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m07:00:10.890591 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_compra
[0m07:00:10.898581 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 07:00:10.883636 => 07:00:10.898581
[0m07:00:10.907100 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m07:00:10.908098 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m07:00:10.915115 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m07:00:10.916119 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (compile): 07:00:10.891613 => 07:00:10.916119
[0m07:00:10.916119 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_compra
[0m07:00:10.918055 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:10.923562 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m07:00:10.925669 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m07:00:10.957667 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:10.960668 [debug] [Thread-2  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m07:00:11.727536 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bc383f2e-49d2-4801-9522-672327e2fba6&page=queryresults
[0m07:00:11.786758 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:abe45141-de9c-4e14-83db-5694d92cd258&page=queryresults
[0m07:00:12.130506 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 07:00:10.909110 => 07:00:12.130506
[0m07:00:12.133107 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBC4D94F0>]}
[0m07:00:12.135141 [info ] [Thread-1  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m07:00:12.136134 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m07:00:12.136134 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m07:00:12.137146 [info ] [Thread-1  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m07:00:12.139130 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m07:00:12.139130 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m07:00:12.143124 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m07:00:12.145124 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 07:00:12.140125 => 07:00:12.144125
[0m07:00:12.145124 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m07:00:12.148125 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m07:00:12.149125 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:12.151125 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m07:00:12.191810 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (execute): 07:00:10.919002 => 07:00:12.190808
[0m07:00:12.192428 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD50C040>]}
[0m07:00:12.194713 [info ] [Thread-2  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m07:00:12.195784 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_compra
[0m07:00:12.196761 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m07:00:12.197725 [info ] [Thread-2  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m07:00:12.198756 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m07:00:12.199758 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m07:00:12.202753 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m07:00:12.204725 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 07:00:12.199758 => 07:00:12.203761
[0m07:00:12.204725 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m07:00:12.212753 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m07:00:12.213756 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:12.215762 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m07:00:13.024238 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c91b729c-f46e-491a-9772-50e5c001183c&page=queryresults
[0m07:00:13.333840 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:266be5b1-fb8e-4e11-a4d4-b90dcfeb0484&page=queryresults
[0m07:00:13.467004 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 07:00:12.145124 => 07:00:13.467004
[0m07:00:13.469004 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD5A14C0>]}
[0m07:00:13.470004 [info ] [Thread-1  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m07:00:13.472041 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m07:00:13.473049 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m07:00:13.474221 [info ] [Thread-1  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m07:00:13.476293 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m07:00:13.476293 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m07:00:13.481285 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m07:00:13.483287 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 07:00:13.477290 => 07:00:13.482287
[0m07:00:13.483287 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m07:00:13.487334 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m07:00:13.488330 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:13.491341 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m07:00:13.740060 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 07:00:12.204725 => 07:00:13.739059
[0m07:00:13.742144 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD528F10>]}
[0m07:00:13.744932 [info ] [Thread-2  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m07:00:13.746935 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m07:00:13.749941 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m07:00:13.750936 [info ] [Thread-2  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m07:00:13.752933 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m07:00:13.753937 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m07:00:13.760803 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m07:00:13.762808 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 07:00:13.754853 => 07:00:13.762808
[0m07:00:13.763806 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m07:00:13.770809 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m07:00:13.772806 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:13.775802 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m07:00:14.248922 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:556166e1-c23b-4d4b-ba6e-97bcd6485aa7&page=queryresults
[0m07:00:14.607532 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:848b9b23-9cfe-4f09-af39-f3738dd26ba9&page=queryresults
[0m07:00:14.652590 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 07:00:13.484286 => 07:00:14.652590
[0m07:00:14.653595 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD614F40>]}
[0m07:00:14.653595 [info ] [Thread-1  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m07:00:14.655592 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m07:00:14.656595 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:14.657594 [info ] [Thread-1  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m07:00:14.659567 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m07:00:14.660555 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:14.664559 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m07:00:14.665564 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 07:00:14.660555 => 07:00:14.665564
[0m07:00:14.666473 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:14.673596 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m07:00:14.675511 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:14.677565 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m07:00:15.009307 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 07:00:13.764805 => 07:00:15.008299
[0m07:00:15.010265 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD52A3D0>]}
[0m07:00:15.011309 [info ] [Thread-2  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m07:00:15.013258 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m07:00:15.014256 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m07:00:15.015259 [info ] [Thread-2  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m07:00:15.016293 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m07:00:15.017309 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m07:00:15.024983 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m07:00:15.029091 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 07:00:15.018313 => 07:00:15.028078
[0m07:00:15.030194 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m07:00:15.035187 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m07:00:15.036302 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:15.038295 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m07:00:15.396164 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fdc115d6-8cec-4980-bac8-83d73ea647eb&page=queryresults
[0m07:00:15.769821 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 07:00:14.666473 => 07:00:15.769821
[0m07:00:15.769821 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD5A14C0>]}
[0m07:00:15.770817 [info ] [Thread-1  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.11s]
[0m07:00:15.771767 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m07:00:15.771767 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m07:00:15.772821 [info ] [Thread-1  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m07:00:15.774755 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m07:00:15.775786 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m07:00:15.782778 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m07:00:15.783785 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 07:00:15.776776 => 07:00:15.783785
[0m07:00:15.784722 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m07:00:15.786769 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m07:00:15.787775 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:15.789697 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m07:00:15.813551 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2aeca2b8-bf71-49b0-bf5b-6a12cf1d30c2&page=queryresults
[0m07:00:16.206101 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 07:00:15.030194 => 07:00:16.206101
[0m07:00:16.208099 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD65BA30>]}
[0m07:00:16.209099 [info ] [Thread-2  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m07:00:16.210271 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m07:00:16.211304 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m07:00:16.212297 [info ] [Thread-2  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m07:00:16.214444 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m07:00:16.214444 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m07:00:16.219518 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m07:00:16.221516 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 07:00:16.215439 => 07:00:16.220518
[0m07:00:16.221516 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m07:00:16.226516 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m07:00:16.227512 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:16.229521 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m07:00:16.517798 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:aa6df870-14c4-4200-9d28-6aa126336784&page=queryresults
[0m07:00:16.952260 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8eafe270-2aa4-46e5-99f4-2e982f899f3e&page=queryresults
[0m07:00:16.970012 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 07:00:15.784722 => 07:00:16.969012
[0m07:00:16.972014 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD696FD0>]}
[0m07:00:16.972995 [info ] [Thread-1  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m07:00:16.974011 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m07:00:16.975024 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m07:00:16.975024 [info ] [Thread-1  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m07:00:16.976028 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m07:00:16.977022 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m07:00:16.978972 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m07:00:16.980958 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 07:00:16.977022 => 07:00:16.979994
[0m07:00:16.980958 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m07:00:16.983054 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m07:00:16.984054 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:16.985013 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m07:00:17.365161 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 07:00:16.222518 => 07:00:17.364153
[0m07:00:17.367155 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD691EB0>]}
[0m07:00:17.368153 [info ] [Thread-2  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m07:00:17.370797 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m07:00:17.372795 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m07:00:17.373769 [info ] [Thread-2  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m07:00:17.376014 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.dm_produto)
[0m07:00:17.377007 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m07:00:17.383771 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m07:00:17.385773 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 07:00:17.377007 => 07:00:17.385773
[0m07:00:17.386774 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m07:00:17.399764 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:17.707424 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0355e943-754a-4ff3-a707-d7d64b855027&page=queryresults
[0m07:00:18.033183 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m07:00:18.034168 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m07:00:18.097277 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 07:00:16.980958 => 07:00:18.097277
[0m07:00:18.098325 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD6677C0>]}
[0m07:00:18.099321 [info ] [Thread-1  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m07:00:18.101332 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m07:00:18.637727 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:991297e5-e90f-4a19-80bc-77038413d2ea&page=queryresults
[0m07:00:22.705519 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 07:00:17.387775 => 07:00:22.704514
[0m07:00:22.707523 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD500B50>]}
[0m07:00:22.709519 [info ] [Thread-2  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 5.33s]
[0m07:00:22.712429 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m07:00:22.714447 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m07:00:22.716389 [info ] [Thread-1  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m07:00:22.719517 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m07:00:22.720517 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m07:00:22.731479 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m07:00:22.733489 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 07:00:22.721518 => 07:00:22.733489
[0m07:00:22.734462 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m07:00:22.739450 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:23.396828 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m07:00:23.398829 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m07:00:24.134029 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b83cb9ed-e06d-4831-bb47-98747ef027f0&page=queryresults
[0m07:00:27.542487 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 07:00:22.734462 => 07:00:27.542487
[0m07:00:27.542487 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD66B0D0>]}
[0m07:00:27.543496 [info ] [Thread-1  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 4.82s]
[0m07:00:27.544494 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m07:00:27.546416 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m07:00:27.548421 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m07:00:27.549459 [info ] [Thread-2  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m07:00:27.551454 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m07:00:27.550407 [info ] [Thread-1  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m07:00:27.552456 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m07:00:27.553448 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m07:00:27.558452 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m07:00:27.559455 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m07:00:27.562453 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m07:00:27.563453 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 07:00:27.554451 => 07:00:27.563453
[0m07:00:27.563453 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m07:00:27.565447 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:27.565447 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 07:00:27.559455 => 07:00:27.565447
[0m07:00:27.565447 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m07:00:27.567449 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:28.241069 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m07:00:28.244073 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m07:00:28.246973 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m07:00:28.248939 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m07:00:28.900218 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:55bd69ea-7529-46fb-b28e-8b6a29092d9e&page=queryresults
[0m07:00:28.969998 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:22ceb02d-6578-4f2c-bc0d-d69df0fa6946&page=queryresults
[0m07:00:31.148237 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 07:00:27.563453 => 07:00:31.148237
[0m07:00:31.149231 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD6694C0>]}
[0m07:00:31.149868 [info ] [Thread-2  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 3.60s]
[0m07:00:31.149868 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m07:00:31.151002 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m07:00:31.151998 [info ] [Thread-2  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m07:00:31.151998 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m07:00:31.152999 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m07:00:31.155008 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m07:00:31.156008 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 07:00:31.152999 => 07:00:31.156008
[0m07:00:31.156008 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m07:00:31.162875 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:31.557653 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 07:00:27.566447 => 07:00:31.557653
[0m07:00:31.559645 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD50E6A0>]}
[0m07:00:31.560648 [info ] [Thread-1  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 4.01s]
[0m07:00:31.561526 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m07:00:31.562657 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m07:00:31.563656 [info ] [Thread-1  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m07:00:31.564665 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m07:00:31.565655 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m07:00:31.571642 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m07:00:31.573643 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 07:00:31.565655 => 07:00:31.573643
[0m07:00:31.574597 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m07:00:31.576640 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:31.892721 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m07:00:31.894729 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m07:00:32.226165 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m07:00:32.229228 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m07:00:32.292154 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d962cda3-a9e8-409a-a0e4-f485de03549b&page=queryresults
[0m07:00:32.859361 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:43b31bb0-dddb-4ede-ab5b-de8b08d11893&page=queryresults
[0m07:00:34.227829 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 07:00:31.156008 => 07:00:34.226832
[0m07:00:34.228827 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD529E50>]}
[0m07:00:34.230836 [info ] [Thread-2  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 3.08s]
[0m07:00:34.231859 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m07:00:34.232828 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m07:00:34.234828 [info ] [Thread-2  ]: 20 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m07:00:34.236828 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m07:00:34.237829 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m07:00:34.248837 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m07:00:34.250928 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 07:00:34.238829 => 07:00:34.250928
[0m07:00:34.251941 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m07:00:34.255931 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:34.932126 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m07:00:34.935127 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m07:00:35.329948 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:72dfdc6a-389e-4102-b064-cb4df14c91a4&page=queryresults
[0m07:00:35.689625 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 07:00:31.574597 => 07:00:35.688631
[0m07:00:35.691243 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD62B820>]}
[0m07:00:35.692359 [info ] [Thread-1  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.13s]
[0m07:00:35.694347 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m07:00:35.695339 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m07:00:35.696352 [info ] [Thread-1  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m07:00:35.697256 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m07:00:35.698256 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m07:00:35.704351 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m07:00:35.706353 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 07:00:35.698256 => 07:00:35.705352
[0m07:00:35.707257 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m07:00:35.717255 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:36.384675 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m07:00:36.387668 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m07:00:36.793465 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:740e5c6a-59be-48fc-a3d5-9ef3390bd95b&page=queryresults
[0m07:00:37.621782 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 07:00:34.251941 => 07:00:37.621782
[0m07:00:37.622776 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBE6B5250>]}
[0m07:00:37.623785 [info ] [Thread-2  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 3.39s]
[0m07:00:37.624680 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m07:00:37.626678 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m07:00:37.627676 [info ] [Thread-2  ]: 22 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m07:00:37.628681 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m07:00:37.628681 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m07:00:37.634680 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m07:00:37.636679 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 07:00:37.629681 => 07:00:37.635680
[0m07:00:37.636679 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m07:00:37.639680 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:38.268811 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m07:00:38.271807 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m07:00:38.856407 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:de105086-19c6-45a7-92e6-e35fa38e512b&page=queryresults
[0m07:00:39.006298 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 07:00:35.707257 => 07:00:39.005294
[0m07:00:39.007296 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBE6EB040>]}
[0m07:00:39.009193 [info ] [Thread-1  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.2 KiB processed)[0m in 3.31s]
[0m07:00:39.010189 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m07:00:39.011789 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m07:00:39.012902 [info ] [Thread-1  ]: 23 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m07:00:39.013548 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m07:00:39.014747 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m07:00:39.021154 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m07:00:39.022154 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 07:00:39.014747 => 07:00:39.022154
[0m07:00:39.023156 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m07:00:39.026155 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:39.660875 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m07:00:39.663302 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m07:00:40.030910 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1b8e3ffd-aca0-4062-b701-5d981d3d6336&page=queryresults
[0m07:00:41.642482 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 07:00:37.636679 => 07:00:41.642482
[0m07:00:41.644084 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD66B490>]}
[0m07:00:41.645187 [info ] [Thread-2  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 4.02s]
[0m07:00:41.646093 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m07:00:41.646093 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m07:00:41.647193 [info ] [Thread-2  ]: 24 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m07:00:41.648098 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m07:00:41.649098 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m07:00:41.656189 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m07:00:41.657188 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 07:00:41.649098 => 07:00:41.657188
[0m07:00:41.658096 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m07:00:41.667685 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:42.256975 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 07:00:39.023156 => 07:00:42.256975
[0m07:00:42.258974 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBE75C520>]}
[0m07:00:42.445524 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m07:00:42.448420 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m07:00:43.041682 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:02d5603a-dfac-4c0b-a938-eb1eb5dc54d8&page=queryresults
[0m07:00:43.085356 [info ] [Thread-1  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.3 KiB processed)[0m in 3.25s]
[0m07:00:43.087344 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m07:00:43.089359 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m07:00:43.089359 [info ] [Thread-1  ]: 25 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m07:00:43.091348 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m07:00:43.091348 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m07:00:43.098345 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m07:00:43.099346 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 07:00:43.092346 => 07:00:43.099346
[0m07:00:43.100347 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m07:00:43.103347 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m07:00:43.815191 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m07:00:43.817189 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m07:00:44.164994 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c7f6a484-a1c3-4ecf-82bc-e29bf873bb70&page=queryresults
[0m07:00:46.154630 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 07:00:41.658096 => 07:00:46.153628
[0m07:00:46.155628 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBE74BF10>]}
[0m07:00:46.156627 [info ] [Thread-2  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 4.51s]
[0m07:00:46.157628 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m07:00:47.229946 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 07:00:43.100347 => 07:00:47.228944
[0m07:00:47.231946 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD5DB160>]}
[0m07:00:47.232944 [info ] [Thread-1  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 4.14s]
[0m07:00:47.235401 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m07:00:47.236495 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m07:00:47.238498 [info ] [Thread-2  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m07:00:47.239398 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m07:00:47.240398 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m07:00:47.246396 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m07:00:47.248398 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 07:00:47.240398 => 07:00:47.247397
[0m07:00:47.248398 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m07:00:47.252396 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m07:00:47.879700 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m07:00:47.881594 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m07:00:48.461811 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:39769e70-36c6-4d93-865d-bd1049af76a2&page=queryresults
[0m07:00:51.276304 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 07:00:47.249397 => 07:00:51.275315
[0m07:00:51.277314 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cd366da6-dc79-4e32-934b-1f4dec323270', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBD5D1490>]}
[0m07:00:51.279308 [info ] [Thread-2  ]: 26 of 26 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 4.04s]
[0m07:00:51.280209 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m07:00:51.283205 [debug] [MainThread]: Connection 'master' was properly closed.
[0m07:00:51.284206 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:00:51.284206 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:00:51.284206 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m07:00:51.285204 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m07:00:51.285204 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m07:00:51.286203 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m07:00:51.286203 [info ] [MainThread]: 
[0m07:00:51.287244 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 45.26 seconds (45.26s).
[0m07:00:51.293201 [debug] [MainThread]: Command end result
[0m07:00:51.318370 [info ] [MainThread]: 
[0m07:00:51.319475 [info ] [MainThread]: [32mCompleted successfully[0m
[0m07:00:51.321361 [info ] [MainThread]: 
[0m07:00:51.321829 [info ] [MainThread]: Done. PASS=26 WARN=0 ERROR=0 SKIP=0 TOTAL=26
[0m07:00:51.324078 [debug] [MainThread]: Command `dbt run` succeeded at 07:00:51.324078 after 46.39 seconds
[0m07:00:51.325078 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFB8B13460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBC1F2940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001FFBC1F23D0>]}
[0m07:00:51.325078 [debug] [MainThread]: Flushing usage events
[0m07:00:55.754627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001683F8F3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001683E87F670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001683E87FD90>]}


============================== 07:00:55.762633 | 8dbf3673-99c3-4cdb-bcb1-35b7596b9bac ==============================
[0m07:00:55.762633 [info ] [MainThread]: Running with dbt=1.7.4
[0m07:00:55.764640 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m07:00:56.630952 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8dbf3673-99c3-4cdb-bcb1-35b7596b9bac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001683E868940>]}
[0m07:00:56.687726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8dbf3673-99c3-4cdb-bcb1-35b7596b9bac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016842243160>]}
[0m07:00:56.689691 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m07:00:56.698306 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m07:00:56.749315 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m07:00:56.749315 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m07:00:56.753316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8dbf3673-99c3-4cdb-bcb1-35b7596b9bac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016843254820>]}
[0m07:00:56.767426 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8dbf3673-99c3-4cdb-bcb1-35b7596b9bac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016843157220>]}
[0m07:00:56.769039 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m07:00:56.769039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8dbf3673-99c3-4cdb-bcb1-35b7596b9bac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016843157430>]}
[0m07:00:56.771153 [info ] [MainThread]: 
[0m07:00:56.773148 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m07:00:56.774045 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:00:56.775144 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:57.525350 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m07:00:57.527344 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m07:00:57.527344 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:57.528351 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:00:58.153256 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m07:00:58.161246 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:58.206477 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m07:00:58.209506 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:00:58.881051 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8dbf3673-99c3-4cdb-bcb1-35b7596b9bac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016843254EB0>]}
[0m07:00:58.883072 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m07:00:58.884728 [info ] [MainThread]: 
[0m07:00:58.892373 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m07:00:58.893415 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m07:00:58.895367 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m07:00:58.896367 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m07:00:58.913361 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 07:00:58.897367 => 07:00:58.913361
[0m07:00:58.913361 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m07:00:58.973365 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m07:00:58.975365 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m07:01:00.252849 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:51bb7cd7-b879-4240-ab85-be5721d36f47&page=queryresults
[0m07:01:01.367235 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m07:01:01.787559 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d43e07cd-5ca8-418b-bfdd-abdb20d77b8d&page=queryresults
[0m07:01:04.429605 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m07:01:05.121341 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m07:01:05.122352 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m07:01:05.522489 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:798086ad-ebdf-43da-95ec-ac5f7fcac671&page=queryresults
[0m07:01:07.749730 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 07:00:58.914361 => 07:01:07.748748
[0m07:01:07.751723 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8dbf3673-99c3-4cdb-bcb1-35b7596b9bac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016844347340>]}
[0m07:01:07.752727 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 96.0 KiB processed)[0m in 8.86s]
[0m07:01:07.753222 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m07:01:07.757280 [debug] [MainThread]: Connection 'master' was properly closed.
[0m07:01:07.758294 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:01:07.759277 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m07:01:07.759277 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m07:01:07.760277 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m07:01:07.761286 [info ] [MainThread]: 
[0m07:01:07.762283 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.99 seconds (10.99s).
[0m07:01:07.764567 [debug] [MainThread]: Command end result
[0m07:01:07.787523 [info ] [MainThread]: 
[0m07:01:07.788564 [info ] [MainThread]: [32mCompleted successfully[0m
[0m07:01:07.788564 [info ] [MainThread]: 
[0m07:01:07.789558 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m07:01:07.791661 [debug] [MainThread]: Command `dbt snapshot` succeeded at 07:01:07.791661 after 12.12 seconds
[0m07:01:07.791661 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001683F8F3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016842FADE20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000016842F90220>]}
[0m07:01:07.792672 [debug] [MainThread]: Flushing usage events
[0m07:01:12.010043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D4B5C6460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D4A55F6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D4A55FE20>]}


============================== 07:01:12.015044 | e3d3f8ef-f67f-4538-81a4-6ef3adb5ca4a ==============================
[0m07:01:12.015044 [info ] [MainThread]: Running with dbt=1.7.4
[0m07:01:12.016065 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select tag:snaps', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m07:01:12.864589 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e3d3f8ef-f67f-4538-81a4-6ef3adb5ca4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D4A545BB0>]}
[0m07:01:12.927555 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e3d3f8ef-f67f-4538-81a4-6ef3adb5ca4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D4EC2F940>]}
[0m07:01:12.929588 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m07:01:12.939651 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m07:01:12.993367 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m07:01:12.993367 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m07:01:12.997365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e3d3f8ef-f67f-4538-81a4-6ef3adb5ca4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D4EF35A60>]}
[0m07:01:13.008385 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e3d3f8ef-f67f-4538-81a4-6ef3adb5ca4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D4EE4B580>]}
[0m07:01:13.008385 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m07:01:13.009373 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e3d3f8ef-f67f-4538-81a4-6ef3adb5ca4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D4EE4B670>]}
[0m07:01:13.011373 [info ] [MainThread]: 
[0m07:01:13.012318 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m07:01:13.014378 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m07:01:13.014378 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:01:13.830299 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m07:01:13.831345 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:01:13.833346 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m07:01:13.834295 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m07:01:14.485704 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m07:01:14.487684 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:01:14.491693 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m07:01:14.498708 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m07:01:15.156718 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e3d3f8ef-f67f-4538-81a4-6ef3adb5ca4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D4EF35DF0>]}
[0m07:01:15.157766 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m07:01:15.158750 [info ] [MainThread]: 
[0m07:01:15.166691 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m07:01:15.167693 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m07:01:15.169692 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m07:01:15.170693 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m07:01:15.186721 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m07:01:15.188692 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 07:01:15.170693 => 07:01:15.188692
[0m07:01:15.188692 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m07:01:15.204729 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m07:01:15.854143 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m07:01:15.855061 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m07:01:16.251006 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b1ce774b-e726-493a-998c-5a9dff4619e6&page=queryresults
[0m07:01:18.567284 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 07:01:15.189723 => 07:01:18.567284
[0m07:01:18.569357 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3d3f8ef-f67f-4538-81a4-6ef3adb5ca4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D4FFABFD0>]}
[0m07:01:18.569357 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (443.0 rows, 81.5 KiB processed)[0m in 3.40s]
[0m07:01:18.571295 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m07:01:18.572331 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m07:01:18.572331 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m07:01:18.573334 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m07:01:18.574334 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m07:01:18.578328 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m07:01:18.579327 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 07:01:18.574334 => 07:01:18.579327
[0m07:01:18.580328 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m07:01:18.582574 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m07:01:19.545161 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m07:01:19.547151 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m07:01:19.990621 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c7c1bb0b-fb35-4cd7-b8c1-9b6d71096e5e&page=queryresults
[0m07:01:23.034136 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 07:01:18.580328 => 07:01:23.034136
[0m07:01:23.036145 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e3d3f8ef-f67f-4538-81a4-6ef3adb5ca4a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D4FFD6E50>]}
[0m07:01:23.038151 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (355.0 rows, 107.7 KiB processed)[0m in 4.46s]
[0m07:01:23.040155 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m07:01:23.043138 [debug] [MainThread]: Connection 'master' was properly closed.
[0m07:01:23.044136 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m07:01:23.045136 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m07:01:23.045136 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m07:01:23.045136 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m07:01:23.046135 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m07:01:23.046135 [info ] [MainThread]: 
[0m07:01:23.048135 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 10.03 seconds (10.03s).
[0m07:01:23.050140 [debug] [MainThread]: Command end result
[0m07:01:23.071148 [info ] [MainThread]: 
[0m07:01:23.071148 [info ] [MainThread]: [32mCompleted successfully[0m
[0m07:01:23.072106 [info ] [MainThread]: 
[0m07:01:23.073115 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m07:01:23.074107 [debug] [MainThread]: Command `dbt run` succeeded at 07:01:23.074107 after 11.12 seconds
[0m07:01:23.075106 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D4B5C6460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D4EC93640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020D4ECA14F0>]}
[0m07:01:23.075106 [debug] [MainThread]: Flushing usage events
[0m08:00:05.111176 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D407BB3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D40F629A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D3F74FE20>]}


============================== 08:00:05.118732 | 67b50173-5f66-4be1-a3f9-f3f8c087581c ==============================
[0m08:00:05.118732 [info ] [MainThread]: Running with dbt=1.7.4
[0m08:00:05.119778 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m08:00:06.010719 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D3F72F370>]}
[0m08:00:06.109849 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D43E260A0>]}
[0m08:00:06.111407 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m08:00:06.121445 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m08:00:06.220275 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m08:00:06.220275 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m08:00:06.229260 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D44125CD0>]}
[0m08:00:06.249266 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D440387C0>]}
[0m08:00:06.250261 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m08:00:06.250261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D440388E0>]}
[0m08:00:06.253163 [info ] [MainThread]: 
[0m08:00:06.254164 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m08:00:06.257164 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:06.258166 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:06.294313 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:00:06.295308 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:07.131503 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:07.807663 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m08:00:07.808661 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:07.810657 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m08:00:07.812667 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:00:08.539013 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m08:00:08.542009 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m08:00:08.544005 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:08.544005 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:00:09.589321 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D44130C10>]}
[0m08:00:09.591313 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m08:00:09.591313 [info ] [MainThread]: 
[0m08:00:09.598334 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:09.601396 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m08:00:09.600387 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m08:00:09.602466 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m08:00:09.607399 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m08:00:09.609378 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m08:00:09.626938 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m08:00:09.630946 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m08:00:09.631917 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:09.635874 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m08:00:09.637871 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 08:00:09.610392 => 08:00:09.636871
[0m08:00:09.637871 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m08:00:09.679996 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 08:00:09.631917 => 08:00:09.679996
[0m08:00:09.681003 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m08:00:09.681003 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:09.685091 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m08:00:09.685964 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m08:00:09.688084 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m08:00:09.715371 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m08:00:09.718451 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m08:00:10.585147 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:30524dd9-4818-418b-a4b4-2afa7a775a67&page=queryresults
[0m08:00:10.634296 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ad86d8dc-c7d6-4056-8a06-02eed529965f&page=queryresults
[0m08:00:11.040857 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 08:00:09.638869 => 08:00:11.039863
[0m08:00:11.041793 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D4418C2B0>]}
[0m08:00:11.042855 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m08:00:11.045854 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 08:00:09.681998 => 08:00:11.045854
[0m08:00:11.046796 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m08:00:11.046796 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D4522BA30>]}
[0m08:00:11.047857 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m08:00:11.048804 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m08:00:11.050797 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m08:00:11.050797 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_compra
[0m08:00:11.049856 [info ] [Thread-2  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m08:00:11.051848 [info ] [Thread-1  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m08:00:11.053798 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m08:00:11.054809 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_compra)
[0m08:00:11.055811 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m08:00:11.055811 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_compra
[0m08:00:11.062816 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m08:00:11.077670 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m08:00:11.079670 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 08:00:11.056810 => 08:00:11.078668
[0m08:00:11.080668 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m08:00:11.086668 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m08:00:11.088665 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (compile): 08:00:11.062816 => 08:00:11.088665
[0m08:00:11.089681 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_compra
[0m08:00:11.097666 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:11.096668 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m08:00:11.101670 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m08:00:11.136461 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:11.139443 [debug] [Thread-1  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m08:00:11.921545 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b7d20c30-0088-4f06-9a1a-542e43db36cf&page=queryresults
[0m08:00:11.941894 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fa34d73c-b1d3-4a58-bd6e-4198025a6010&page=queryresults
[0m08:00:12.348048 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (execute): 08:00:11.090662 => 08:00:12.348048
[0m08:00:12.349043 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D451AA970>]}
[0m08:00:12.349043 [info ] [Thread-1  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m08:00:12.350037 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_compra
[0m08:00:12.350945 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m08:00:12.351956 [info ] [Thread-1  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m08:00:12.358150 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_forma_pagamento)
[0m08:00:12.359153 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m08:00:12.361970 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 08:00:11.080668 => 08:00:12.361970
[0m08:00:12.373989 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m08:00:12.376988 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D451C42E0>]}
[0m08:00:12.377989 [info ] [Thread-2  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m08:00:12.380528 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m08:00:12.381667 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m08:00:12.382668 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 08:00:12.363007 => 08:00:12.382668
[0m08:00:12.384663 [info ] [Thread-2  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m08:00:12.386673 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m08:00:12.388660 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m08:00:12.396658 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m08:00:12.397654 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m08:00:12.406624 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m08:00:12.408531 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:12.412530 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m08:00:12.414605 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 08:00:12.398661 => 08:00:12.413548
[0m08:00:12.452138 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m08:00:12.463117 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m08:00:12.465068 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:12.469120 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m08:00:13.221531 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f46c6b5c-1f12-44d5-a255-1a3e300dbcbe&page=queryresults
[0m08:00:13.266034 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0c76ddc5-4481-4403-bff0-dd2e560b848a&page=queryresults
[0m08:00:13.614223 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 08:00:12.389661 => 08:00:13.614223
[0m08:00:13.615227 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D451DF520>]}
[0m08:00:13.615227 [info ] [Thread-1  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m08:00:13.616224 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m08:00:13.616224 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m08:00:13.616224 [info ] [Thread-1  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m08:00:13.617364 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m08:00:13.617364 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m08:00:13.619372 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m08:00:13.620365 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 08:00:13.617364 => 08:00:13.620365
[0m08:00:13.620365 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m08:00:13.622370 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m08:00:13.623366 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:13.624283 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m08:00:13.677863 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 08:00:12.454111 => 08:00:13.677863
[0m08:00:13.678969 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D451B0E50>]}
[0m08:00:13.679969 [info ] [Thread-2  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m08:00:13.680877 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m08:00:13.681976 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m08:00:13.683898 [info ] [Thread-2  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m08:00:13.685980 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m08:00:13.685980 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m08:00:13.689970 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m08:00:13.692000 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 08:00:13.686973 => 08:00:13.690967
[0m08:00:13.692000 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m08:00:13.694976 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m08:00:13.695972 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:13.697991 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m08:00:14.419935 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1ae76e38-e8ac-4d5d-ae8a-491f668e50be&page=queryresults
[0m08:00:14.421881 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d6ba9de6-460c-4bd7-9d01-ee241de87ba4&page=queryresults
[0m08:00:14.926304 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 08:00:13.620365 => 08:00:14.925306
[0m08:00:14.928304 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D4527EAF0>]}
[0m08:00:14.934258 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 08:00:13.692000 => 08:00:14.933301
[0m08:00:14.936263 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D451AAEB0>]}
[0m08:00:14.935269 [info ] [Thread-1  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m08:00:14.938921 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m08:00:14.937866 [info ] [Thread-2  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m08:00:14.939978 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:14.940972 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m08:00:14.942939 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m08:00:14.941985 [info ] [Thread-1  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m08:00:14.944923 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m08:00:14.943927 [info ] [Thread-2  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m08:00:14.946022 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:14.946971 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m08:00:14.947995 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m08:00:14.950977 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m08:00:14.954931 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m08:00:14.955933 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 08:00:14.948968 => 08:00:14.955933
[0m08:00:14.955933 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 08:00:14.946971 => 08:00:14.955933
[0m08:00:14.956928 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m08:00:14.956928 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:14.959938 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m08:00:14.966004 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m08:00:14.967009 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:14.967884 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m08:00:14.987004 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:14.989999 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m08:00:15.940454 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:08d49033-3ee0-4861-99d2-fff56b04650a&page=queryresults
[0m08:00:16.023416 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:efbc7f39-3f19-469f-b616-577518ff4012&page=queryresults
[0m08:00:16.342988 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 08:00:14.957935 => 08:00:16.341986
[0m08:00:16.343988 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D452BC7C0>]}
[0m08:00:16.344986 [info ] [Thread-1  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m08:00:16.345985 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m08:00:16.347609 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m08:00:16.349728 [info ] [Thread-1  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m08:00:16.350683 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m08:00:16.351722 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m08:00:16.358721 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m08:00:16.359724 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 08:00:16.352722 => 08:00:16.359724
[0m08:00:16.360682 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m08:00:16.363728 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m08:00:16.364735 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:16.366727 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m08:00:16.456973 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 08:00:14.956928 => 08:00:16.456973
[0m08:00:16.458979 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D45217370>]}
[0m08:00:16.461966 [info ] [Thread-2  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.51s]
[0m08:00:16.463963 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m08:00:16.464962 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m08:00:16.465964 [info ] [Thread-2  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m08:00:16.466959 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m08:00:16.466959 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m08:00:16.474974 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m08:00:16.476964 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 08:00:16.467959 => 08:00:16.476964
[0m08:00:16.477899 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m08:00:16.481963 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m08:00:16.483966 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:16.484945 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m08:00:17.078498 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0579560d-7324-4548-849d-f8e1f03cefe0&page=queryresults
[0m08:00:17.236540 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2beb936f-f95d-4ae5-bfbe-531fc1b78ca4&page=queryresults
[0m08:00:17.509723 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 08:00:16.360682 => 08:00:17.508719
[0m08:00:17.511721 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D452E1FD0>]}
[0m08:00:17.512722 [info ] [Thread-1  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m08:00:17.514679 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m08:00:17.515672 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m08:00:17.516676 [info ] [Thread-1  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m08:00:17.518676 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m08:00:17.519678 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m08:00:17.527718 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m08:00:17.529724 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 08:00:17.520684 => 08:00:17.529724
[0m08:00:17.530683 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m08:00:17.541830 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m08:00:17.543811 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:17.545834 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m08:00:17.676026 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 08:00:16.478965 => 08:00:17.676026
[0m08:00:17.677026 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D451AAE50>]}
[0m08:00:17.678025 [info ] [Thread-2  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m08:00:17.679026 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m08:00:17.680025 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m08:00:17.681026 [info ] [Thread-2  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m08:00:17.682026 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.dm_produto)
[0m08:00:17.682026 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m08:00:17.686026 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m08:00:17.688026 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 08:00:17.682026 => 08:00:17.687026
[0m08:00:17.688026 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m08:00:17.704033 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:18.280256 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:133a5d1a-62bc-40c7-9d5e-ea8329fcfa7a&page=queryresults
[0m08:00:18.378217 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m08:00:18.380094 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m08:00:18.764053 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 08:00:17.530683 => 08:00:18.764053
[0m08:00:18.765052 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D451AAAC0>]}
[0m08:00:18.766051 [info ] [Thread-1  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m08:00:18.766959 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m08:00:19.084376 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0d633af9-6db8-42b4-984e-fbd553cd07f5&page=queryresults
[0m08:00:21.720428 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 08:00:17.688026 => 08:00:21.720428
[0m08:00:21.721421 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D45282FA0>]}
[0m08:00:21.722417 [info ] [Thread-2  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 4.04s]
[0m08:00:21.723837 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m08:00:21.725827 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m08:00:21.726784 [info ] [Thread-1  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m08:00:21.728788 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m08:00:21.730825 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m08:00:21.738821 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m08:00:21.741782 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 08:00:21.730825 => 08:00:21.740835
[0m08:00:21.741782 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m08:00:21.743975 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:22.374231 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m08:00:22.375220 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m08:00:23.053237 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dc04b7a3-fc23-414e-b380-4e09e33c2a75&page=queryresults
[0m08:00:25.604301 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 08:00:21.742820 => 08:00:25.603313
[0m08:00:25.605297 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D45295790>]}
[0m08:00:25.605297 [info ] [Thread-1  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 3.88s]
[0m08:00:25.607299 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m08:00:25.610216 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m08:00:25.611176 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m08:00:25.612144 [info ] [Thread-2  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m08:00:25.615211 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m08:00:25.616208 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m08:00:25.613162 [info ] [Thread-1  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m08:00:25.624282 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m08:00:25.625284 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m08:00:25.626280 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m08:00:25.633871 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 08:00:25.617193 => 08:00:25.632158
[0m08:00:25.635933 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m08:00:25.642939 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:25.650914 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m08:00:25.683922 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 08:00:25.627281 => 08:00:25.683922
[0m08:00:25.684939 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m08:00:25.687953 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:26.315791 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m08:00:26.318779 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m08:00:26.336583 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m08:00:26.338550 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m08:00:26.932393 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ae147329-4939-45eb-b693-f1a47b92b931&page=queryresults
[0m08:00:27.055387 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9bd0e5d0-ffc3-4ab4-b0fb-98dfcf8bbc0d&page=queryresults
[0m08:00:29.156406 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 08:00:25.638884 => 08:00:29.156406
[0m08:00:29.157407 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D453172E0>]}
[0m08:00:29.157407 [info ] [Thread-2  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 3.54s]
[0m08:00:29.159391 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m08:00:29.159391 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m08:00:29.160311 [info ] [Thread-2  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m08:00:29.161278 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m08:00:29.162370 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m08:00:29.165375 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m08:00:29.166377 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 08:00:29.162370 => 08:00:29.166377
[0m08:00:29.167326 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m08:00:29.168314 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:29.303488 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 08:00:25.684939 => 08:00:29.303488
[0m08:00:29.304480 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D45398DC0>]}
[0m08:00:29.304480 [info ] [Thread-1  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 3.68s]
[0m08:00:29.305386 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m08:00:29.307371 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m08:00:29.308350 [info ] [Thread-1  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m08:00:29.310366 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m08:00:29.311365 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m08:00:29.318490 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m08:00:29.320362 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 08:00:29.311365 => 08:00:29.319491
[0m08:00:29.320362 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m08:00:29.324235 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:29.814342 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m08:00:29.816443 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m08:00:29.967052 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m08:00:29.968049 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m08:00:30.212387 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c35765e2-1ea0-4829-8c94-e064bd22b346&page=queryresults
[0m08:00:30.711787 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0983a5e4-e552-4b5e-a963-2fb25da9ce8d&page=queryresults
[0m08:00:33.414839 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 08:00:29.167326 => 08:00:33.414839
[0m08:00:33.415843 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D4532B040>]}
[0m08:00:33.415843 [info ] [Thread-2  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 4.25s]
[0m08:00:33.417754 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m08:00:33.417754 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m08:00:33.419846 [info ] [Thread-2  ]: 20 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m08:00:33.421840 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m08:00:33.422836 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m08:00:33.430718 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m08:00:33.433722 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 08:00:33.423842 => 08:00:33.432720
[0m08:00:33.434719 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m08:00:33.438715 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:33.501240 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 08:00:29.320362 => 08:00:33.501240
[0m08:00:33.502235 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D45398DC0>]}
[0m08:00:33.502235 [info ] [Thread-1  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.19s]
[0m08:00:33.503231 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m08:00:33.505100 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m08:00:33.506117 [info ] [Thread-1  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m08:00:33.507158 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m08:00:33.508165 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m08:00:33.515101 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m08:00:33.517115 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 08:00:33.509166 => 08:00:33.517115
[0m08:00:33.518116 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m08:00:33.521113 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:34.115655 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m08:00:34.118738 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m08:00:34.170588 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m08:00:34.171652 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m08:00:34.526749 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cd55413c-661d-4161-8486-fbb985280c2f&page=queryresults
[0m08:00:34.559390 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5e451144-db46-4adf-adbe-6999e9be3f91&page=queryresults
[0m08:00:36.508825 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 08:00:33.435719 => 08:00:36.507927
[0m08:00:36.509823 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D45282D90>]}
[0m08:00:36.510823 [info ] [Thread-2  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 3.09s]
[0m08:00:36.511822 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m08:00:36.512822 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m08:00:36.513917 [info ] [Thread-2  ]: 22 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m08:00:36.514822 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m08:00:36.515823 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m08:00:36.520820 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m08:00:36.521822 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 08:00:36.515823 => 08:00:36.521822
[0m08:00:36.523306 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m08:00:36.526783 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:37.177203 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m08:00:37.178101 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m08:00:37.499543 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 08:00:33.518116 => 08:00:37.498545
[0m08:00:37.500543 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D45366760>]}
[0m08:00:37.502542 [info ] [Thread-1  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.2 KiB processed)[0m in 3.99s]
[0m08:00:37.503171 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m08:00:37.505266 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m08:00:37.506266 [info ] [Thread-1  ]: 23 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m08:00:37.507266 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m08:00:37.508265 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m08:00:37.513263 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m08:00:37.515265 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 08:00:37.508265 => 08:00:37.514264
[0m08:00:37.515265 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m08:00:37.519263 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:37.722236 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:de2313bf-191e-4d5c-b42c-c81f42491c0a&page=queryresults
[0m08:00:38.136378 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m08:00:38.139280 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m08:00:38.603103 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c7152a55-5a33-45aa-a7da-a97775e83a16&page=queryresults
[0m08:00:41.635520 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 08:00:37.516265 => 08:00:41.635520
[0m08:00:41.636528 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D453206A0>]}
[0m08:00:41.637522 [info ] [Thread-1  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.3 KiB processed)[0m in 4.13s]
[0m08:00:41.638550 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m08:00:41.639422 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m08:00:41.639422 [info ] [Thread-1  ]: 24 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m08:00:41.640521 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m08:00:41.641518 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m08:00:41.647528 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m08:00:41.648531 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 08:00:41.641518 => 08:00:41.648531
[0m08:00:41.649474 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m08:00:41.652529 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:42.303457 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m08:00:42.305479 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m08:00:42.648889 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7dec2313-026b-41d9-bf6e-91daf2979782&page=queryresults
[0m08:00:46.525216 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 08:00:36.523306 => 08:00:46.525216
[0m08:00:46.526200 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D4531B9A0>]}
[0m08:00:47.257660 [info ] [Thread-2  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 10.01s]
[0m08:00:47.259741 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m08:00:47.260645 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m08:00:47.261749 [info ] [Thread-2  ]: 25 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m08:00:47.262646 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m08:00:47.263643 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m08:00:47.271267 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m08:00:47.273164 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 08:00:47.263643 => 08:00:47.273164
[0m08:00:47.274165 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m08:00:47.277162 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m08:00:47.879556 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m08:00:47.883448 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m08:00:48.488816 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:73ae466d-8dc2-4f8a-9e2d-e4fd4e3c5585&page=queryresults
[0m08:00:52.176334 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 08:00:41.649474 => 08:00:52.176334
[0m08:00:52.177333 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D463D2A60>]}
[0m08:00:52.178335 [info ] [Thread-1  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 10.54s]
[0m08:00:52.179239 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m08:00:52.180241 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m08:00:52.181335 [info ] [Thread-1  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m08:00:52.256799 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m08:00:52.257777 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m08:00:52.260791 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m08:00:52.261775 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 08:00:52.257777 => 08:00:52.260791
[0m08:00:52.261775 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m08:00:52.263792 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m08:00:52.913260 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m08:00:52.915263 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m08:00:53.136062 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 08:00:47.274165 => 08:00:53.135065
[0m08:00:53.138061 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D45282F70>]}
[0m08:00:53.141149 [info ] [Thread-2  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 5.88s]
[0m08:00:53.144239 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m08:00:53.480423 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:96e3b78c-93ac-4e93-aa3f-fe66c14d432b&page=queryresults
[0m08:00:56.936010 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 08:00:52.261775 => 08:00:56.936010
[0m08:00:56.937020 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '67b50173-5f66-4be1-a3f9-f3f8c087581c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D45199A00>]}
[0m08:00:56.938022 [info ] [Thread-1  ]: 26 of 26 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 4.75s]
[0m08:00:56.940023 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m08:00:56.942020 [debug] [MainThread]: Connection 'master' was properly closed.
[0m08:00:56.943021 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:00:56.943021 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:00:56.944020 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m08:00:56.944020 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m08:00:56.945020 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto_base' was properly closed.
[0m08:00:56.945020 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m08:00:56.946019 [info ] [MainThread]: 
[0m08:00:56.946019 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 50.69 seconds (50.69s).
[0m08:00:56.952528 [debug] [MainThread]: Command end result
[0m08:00:56.967531 [info ] [MainThread]: 
[0m08:00:56.968531 [info ] [MainThread]: [32mCompleted successfully[0m
[0m08:00:56.969530 [info ] [MainThread]: 
[0m08:00:56.970575 [info ] [MainThread]: Done. PASS=26 WARN=0 ERROR=0 SKIP=0 TOTAL=26
[0m08:00:56.971532 [debug] [MainThread]: Command `dbt run` succeeded at 08:00:56.971532 after 51.97 seconds
[0m08:00:56.971532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D407BB3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D43E260A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000024D4640B730>]}
[0m08:00:56.972532 [debug] [MainThread]: Flushing usage events
[0m08:01:01.254572 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A67D133430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A67C0AC6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A67C0ACAF0>]}


============================== 08:01:01.260566 | 6101ea6e-5a70-4b80-af18-71a1a0020860 ==============================
[0m08:01:01.260566 [info ] [MainThread]: Running with dbt=1.7.4
[0m08:01:01.261575 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'warn_error': 'None', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m08:01:02.096340 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6101ea6e-5a70-4b80-af18-71a1a0020860', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A67C0AC880>]}
[0m08:01:02.169371 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6101ea6e-5a70-4b80-af18-71a1a0020860', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A6007A0B20>]}
[0m08:01:02.171323 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m08:01:02.178030 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m08:01:02.227029 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m08:01:02.227029 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m08:01:02.231029 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6101ea6e-5a70-4b80-af18-71a1a0020860', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A600AA61F0>]}
[0m08:01:02.246076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6101ea6e-5a70-4b80-af18-71a1a0020860', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A6009BBD90>]}
[0m08:01:02.246076 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m08:01:02.247124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6101ea6e-5a70-4b80-af18-71a1a0020860', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A6009840D0>]}
[0m08:01:02.249107 [info ] [MainThread]: 
[0m08:01:02.250076 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m08:01:02.252531 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:01:02.252531 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:01:03.030968 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m08:01:03.033897 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:01:03.035958 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m08:01:03.037841 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:01:03.878525 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m08:01:03.884503 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:01:03.941255 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m08:01:03.942152 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:01:04.596898 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6101ea6e-5a70-4b80-af18-71a1a0020860', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A600808B20>]}
[0m08:01:04.598991 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m08:01:04.600978 [info ] [MainThread]: 
[0m08:01:04.608481 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m08:01:04.609481 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m08:01:04.611534 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m08:01:04.612530 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m08:01:04.627748 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 08:01:04.612530 => 08:01:04.626742
[0m08:01:04.628812 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m08:01:04.688761 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m08:01:04.690754 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m08:01:05.511568 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:de1fbcc3-4eb3-4fa0-a1d8-4a74f2cab7b5&page=queryresults
[0m08:01:06.581659 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m08:01:07.025339 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9a070237-4915-4004-9171-a476935f20db&page=queryresults
[0m08:01:09.737835 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m08:01:10.449961 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m08:01:10.451963 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m08:01:10.852140 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6a79e76b-97af-44db-8530-45d2f18cb716&page=queryresults
[0m08:01:13.056471 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 08:01:04.628812 => 08:01:13.055472
[0m08:01:13.057470 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6101ea6e-5a70-4b80-af18-71a1a0020860', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A601B541C0>]}
[0m08:01:13.058469 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 96.0 KiB processed)[0m in 8.45s]
[0m08:01:13.059469 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m08:01:13.061865 [debug] [MainThread]: Connection 'master' was properly closed.
[0m08:01:13.062959 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:01:13.062959 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m08:01:13.063970 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m08:01:13.063970 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m08:01:13.063970 [info ] [MainThread]: 
[0m08:01:13.064969 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.81 seconds (10.81s).
[0m08:01:13.065971 [debug] [MainThread]: Command end result
[0m08:01:13.085000 [info ] [MainThread]: 
[0m08:01:13.085996 [info ] [MainThread]: [32mCompleted successfully[0m
[0m08:01:13.086906 [info ] [MainThread]: 
[0m08:01:13.088005 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m08:01:13.089998 [debug] [MainThread]: Command `dbt snapshot` succeeded at 08:01:13.089998 after 11.92 seconds
[0m08:01:13.090999 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A67D133430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A6007FB280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001A600707C40>]}
[0m08:01:13.090999 [debug] [MainThread]: Flushing usage events
[0m08:01:17.918908 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3701933D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3709329A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D36F107E50>]}


============================== 08:01:17.927881 | 70716d49-faaf-4106-b1dc-8af951c31914 ==============================
[0m08:01:17.927881 [info ] [MainThread]: Running with dbt=1.7.4
[0m08:01:17.928833 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --select tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m08:01:18.720742 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '70716d49-faaf-4106-b1dc-8af951c31914', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D36F10BBB0>]}
[0m08:01:18.777259 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '70716d49-faaf-4106-b1dc-8af951c31914', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3722DAAC0>]}
[0m08:01:18.779385 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m08:01:18.785262 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m08:01:18.836259 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m08:01:18.836259 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m08:01:18.841261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '70716d49-faaf-4106-b1dc-8af951c31914', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D373AF5BE0>]}
[0m08:01:18.853371 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '70716d49-faaf-4106-b1dc-8af951c31914', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D373A0B700>]}
[0m08:01:18.853371 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m08:01:18.854383 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '70716d49-faaf-4106-b1dc-8af951c31914', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D373A0B7F0>]}
[0m08:01:18.856492 [info ] [MainThread]: 
[0m08:01:18.857490 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m08:01:18.858412 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m08:01:18.859499 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:01:19.531790 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m08:01:19.532790 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m08:01:19.532790 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:01:19.533783 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m08:01:20.212205 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m08:01:20.213192 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m08:01:20.216190 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:01:20.216190 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m08:01:21.012057 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '70716d49-faaf-4106-b1dc-8af951c31914', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D373ADEFA0>]}
[0m08:01:21.014050 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m08:01:21.015050 [info ] [MainThread]: 
[0m08:01:21.021925 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m08:01:21.023009 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m08:01:21.023950 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m08:01:21.025017 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m08:01:21.041017 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m08:01:21.042009 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 08:01:21.025017 => 08:01:21.042009
[0m08:01:21.043013 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m08:01:21.056009 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m08:01:22.150776 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m08:01:22.151779 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m08:01:22.531125 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a71878bc-4063-4ced-95d3-6bb0a0e1212e&page=queryresults
[0m08:01:24.607453 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 08:01:21.043013 => 08:01:24.607453
[0m08:01:24.608973 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '70716d49-faaf-4106-b1dc-8af951c31914', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D374B6AEE0>]}
[0m08:01:24.608973 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (443.0 rows, 81.5 KiB processed)[0m in 3.59s]
[0m08:01:24.609997 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m08:01:24.611990 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m08:01:24.612995 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m08:01:24.613992 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m08:01:24.614993 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m08:01:24.622996 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m08:01:24.624989 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 08:01:24.614993 => 08:01:24.624989
[0m08:01:24.625993 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m08:01:24.629001 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m08:01:25.286365 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m08:01:25.288344 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m08:01:25.699916 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cff275cb-83e0-482d-a50d-3e537508a246&page=queryresults
[0m08:01:27.739037 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 08:01:24.625993 => 08:01:27.739037
[0m08:01:27.741040 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '70716d49-faaf-4106-b1dc-8af951c31914', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D374B6AC10>]}
[0m08:01:27.742037 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (355.0 rows, 107.7 KiB processed)[0m in 3.13s]
[0m08:01:27.744146 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m08:01:27.747255 [debug] [MainThread]: Connection 'master' was properly closed.
[0m08:01:27.748240 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m08:01:27.749234 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m08:01:27.749234 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m08:01:27.750234 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m08:01:27.750234 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m08:01:27.751237 [info ] [MainThread]: 
[0m08:01:27.752156 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 8.89 seconds (8.89s).
[0m08:01:27.754307 [debug] [MainThread]: Command end result
[0m08:01:27.783146 [info ] [MainThread]: 
[0m08:01:27.783146 [info ] [MainThread]: [32mCompleted successfully[0m
[0m08:01:27.784211 [info ] [MainThread]: 
[0m08:01:27.785051 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m08:01:27.786093 [debug] [MainThread]: Command `dbt run` succeeded at 08:01:27.786093 after 9.94 seconds
[0m08:01:27.787098 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3701933D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3738C8670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3738641C0>]}
[0m08:01:27.787098 [debug] [MainThread]: Flushing usage events
[0m09:00:05.678290 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BAFEA3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BAEE196D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BAEE19E20>]}


============================== 09:00:05.684806 | 9209f884-73a6-4578-afb6-44c41cff1a3a ==============================
[0m09:00:05.684806 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:00:05.685807 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --exclude tag:snaps', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m09:00:06.499305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB1FEAA60>]}
[0m09:00:06.588116 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB27E7A30>]}
[0m09:00:06.590122 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:00:06.601115 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:00:06.706932 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:00:06.706932 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:00:06.710929 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB3805E80>]}
[0m09:00:06.721963 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB37189A0>]}
[0m09:00:06.721963 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:00:06.722928 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB3718A90>]}
[0m09:00:06.725936 [info ] [MainThread]: 
[0m09:00:06.726938 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:00:06.729939 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:06.730905 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:06.730905 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:00:06.731938 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:07.750943 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:08.519299 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m09:00:08.520297 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:08.522297 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m09:00:08.523298 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:00:09.212200 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m09:00:09.214152 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:09.252205 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m09:00:09.253205 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:00:09.928771 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB35636A0>]}
[0m09:00:09.930767 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:00:09.931792 [info ] [MainThread]: 
[0m09:00:09.940782 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:09.941777 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m09:00:09.942787 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m09:00:09.944784 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m09:00:09.952782 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m09:00:09.955741 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m09:00:09.967743 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m09:00:09.970735 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m09:00:09.970735 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:09.975724 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:00:09.976671 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 09:00:09.957725 => 09:00:09.975724
[0m09:00:09.976671 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m09:00:10.001482 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 09:00:09.971725 => 09:00:10.001482
[0m09:00:10.002421 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:10.015537 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m09:00:10.016504 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m09:00:10.019387 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m09:00:10.019387 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:00:10.021420 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m09:00:10.051463 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m09:00:10.847863 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c4cbf5f9-b5b1-4a71-806d-969b951e8118&page=queryresults
[0m09:00:10.857862 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:931dbe25-c14c-4288-ab20-3fdd4475d24b&page=queryresults
[0m09:00:11.311906 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 09:00:09.977746 => 09:00:11.310885
[0m09:00:11.311906 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB38870A0>]}
[0m09:00:11.317911 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 09:00:10.002421 => 09:00:11.316910
[0m09:00:11.312894 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m09:00:11.319916 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB4906CA0>]}
[0m09:00:11.320905 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m09:00:11.322910 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m09:00:11.321910 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m09:00:11.323899 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m09:00:11.323899 [info ] [Thread-2  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m09:00:11.324869 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_compra
[0m09:00:11.324869 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m09:00:11.325869 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m09:00:11.328771 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m09:00:11.325869 [info ] [Thread-1  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m09:00:11.329770 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_compra)
[0m09:00:11.329770 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_compra
[0m09:00:11.334780 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 09:00:11.326868 => 09:00:11.334780
[0m09:00:11.335772 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m09:00:11.338771 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m09:00:11.343823 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m09:00:11.344825 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:11.347825 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m09:00:11.348764 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (compile): 09:00:11.330762 => 09:00:11.347825
[0m09:00:11.389017 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_compra
[0m09:00:11.394022 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m09:00:11.397722 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:11.400733 [debug] [Thread-1  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m09:00:12.133622 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:46321a7a-9ace-4954-bb96-a48d2a43b8e5&page=queryresults
[0m09:00:12.207446 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:40b42eb4-a37b-4580-9c8f-2cf42ae737a3&page=queryresults
[0m09:00:12.575944 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (execute): 09:00:11.389017 => 09:00:12.574947
[0m09:00:12.576949 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB48EA7C0>]}
[0m09:00:12.578953 [info ] [Thread-1  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m09:00:12.580993 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_compra
[0m09:00:12.581987 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m09:00:12.582996 [info ] [Thread-1  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m09:00:12.586057 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_forma_pagamento)
[0m09:00:12.587065 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m09:00:12.594048 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m09:00:12.597006 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 09:00:12.587065 => 09:00:12.596047
[0m09:00:12.597006 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m09:00:12.604728 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m09:00:12.607735 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:12.612735 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m09:00:12.650735 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 09:00:11.336772 => 09:00:12.650735
[0m09:00:12.652730 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB48BB070>]}
[0m09:00:12.652730 [info ] [Thread-2  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m09:00:12.653741 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m09:00:12.653741 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m09:00:12.654739 [info ] [Thread-2  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m09:00:12.654739 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m09:00:12.655743 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m09:00:12.657728 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m09:00:12.659744 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 09:00:12.655743 => 09:00:12.659744
[0m09:00:12.659744 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m09:00:12.661735 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m09:00:12.662731 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:12.663694 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m09:00:13.420067 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:de81b206-552f-4f3b-9c12-e72368475da4&page=queryresults
[0m09:00:13.423107 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fc1b6645-a349-44d2-b0dc-912a39820728&page=queryresults
[0m09:00:13.882361 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 09:00:12.598623 => 09:00:13.881363
[0m09:00:13.883369 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB48F74F0>]}
[0m09:00:13.884361 [info ] [Thread-1  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m09:00:13.886350 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m09:00:13.887391 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m09:00:13.888402 [info ] [Thread-1  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m09:00:13.890397 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m09:00:13.891402 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m09:00:13.905229 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m09:00:13.907236 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 09:00:13.892393 => 09:00:13.906230
[0m09:00:13.907236 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m09:00:13.913233 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m09:00:13.915227 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:13.916228 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m09:00:13.996391 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 09:00:12.659744 => 09:00:13.996391
[0m09:00:13.998356 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB3810C10>]}
[0m09:00:13.999356 [info ] [Thread-2  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m09:00:14.000349 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m09:00:14.002887 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m09:00:14.003924 [info ] [Thread-2  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m09:00:14.006888 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m09:00:14.007888 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m09:00:14.014961 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m09:00:14.016942 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 09:00:14.008887 => 09:00:14.016942
[0m09:00:14.017939 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m09:00:14.021939 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m09:00:14.022938 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:14.027945 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m09:00:14.766288 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:99917ea2-fb84-412d-ab7b-e52688acdfc9&page=queryresults
[0m09:00:14.827542 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6e74fd6d-7fab-4fea-8c96-beab0a77b16d&page=queryresults
[0m09:00:15.159092 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 09:00:13.907236 => 09:00:15.158092
[0m09:00:15.161090 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB48AD250>]}
[0m09:00:15.162090 [info ] [Thread-1  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m09:00:15.164092 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m09:00:15.165092 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:15.166097 [info ] [Thread-1  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m09:00:15.167097 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m09:00:15.168095 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:15.171218 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m09:00:15.172086 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 09:00:15.168095 => 09:00:15.171218
[0m09:00:15.172086 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:15.174089 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m09:00:15.174089 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:15.175213 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m09:00:15.256199 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 09:00:14.017939 => 09:00:15.256199
[0m09:00:15.257115 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB49881C0>]}
[0m09:00:15.258125 [info ] [Thread-2  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m09:00:15.259120 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m09:00:15.261066 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m09:00:15.262068 [info ] [Thread-2  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m09:00:15.264062 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m09:00:15.265062 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m09:00:15.286062 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m09:00:15.290079 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 09:00:15.265062 => 09:00:15.290079
[0m09:00:15.291204 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m09:00:15.294200 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m09:00:15.295195 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:15.296135 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m09:00:15.883786 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1b3c28dc-20d9-4969-9c33-0fe04aee431a&page=queryresults
[0m09:00:16.027259 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bb26b44b-d0f9-4d23-868b-fe5d276bc7a3&page=queryresults
[0m09:00:16.284660 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 09:00:15.172086 => 09:00:16.283659
[0m09:00:16.286660 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB48933D0>]}
[0m09:00:16.287659 [info ] [Thread-1  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m09:00:16.289708 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m09:00:16.289708 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m09:00:16.290705 [info ] [Thread-1  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m09:00:16.292770 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m09:00:16.292770 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m09:00:16.298774 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m09:00:16.298774 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 09:00:16.293768 => 09:00:16.298774
[0m09:00:16.299715 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m09:00:16.301776 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m09:00:16.301776 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:16.302716 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m09:00:16.422122 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 09:00:15.291204 => 09:00:16.421113
[0m09:00:16.424114 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB48A2250>]}
[0m09:00:16.424114 [info ] [Thread-2  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m09:00:16.426055 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m09:00:16.426055 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m09:00:16.427062 [info ] [Thread-2  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m09:00:16.429059 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m09:00:16.429059 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m09:00:16.433057 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m09:00:16.435056 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 09:00:16.430059 => 09:00:16.434059
[0m09:00:16.435056 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m09:00:16.439099 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m09:00:16.441104 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:16.445086 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m09:00:17.012881 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:27dc45bc-f0e2-4044-b016-ab3e4e8f8836&page=queryresults
[0m09:00:17.202870 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d3f5bec7-d5be-4a78-9e86-1e478362cee5&page=queryresults
[0m09:00:17.400004 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 09:00:16.299715 => 09:00:17.399006
[0m09:00:17.401014 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB49B7250>]}
[0m09:00:17.402006 [info ] [Thread-1  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.11s]
[0m09:00:17.405020 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m09:00:17.406033 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m09:00:17.407020 [info ] [Thread-1  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m09:00:17.410651 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m09:00:17.410651 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m09:00:17.414639 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m09:00:17.415647 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 09:00:17.411648 => 09:00:17.415647
[0m09:00:17.416667 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m09:00:17.428625 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m09:00:17.430586 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:17.432623 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m09:00:17.590456 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 09:00:16.436115 => 09:00:17.590456
[0m09:00:17.592456 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB3810C10>]}
[0m09:00:17.594464 [info ] [Thread-2  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m09:00:17.595472 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m09:00:17.596464 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m09:00:17.597463 [info ] [Thread-2  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m09:00:17.599468 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.dm_produto)
[0m09:00:17.601471 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m09:00:17.611005 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m09:00:17.613002 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 09:00:17.601471 => 09:00:17.613002
[0m09:00:17.614005 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m09:00:17.629999 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:18.185643 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:01761d90-ae70-433c-9c8b-1fa23054aed4&page=queryresults
[0m09:00:18.283814 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m09:00:18.284806 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m09:00:18.567020 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 09:00:17.416667 => 09:00:18.566025
[0m09:00:18.569019 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB48DC0A0>]}
[0m09:00:18.570025 [info ] [Thread-1  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m09:00:18.572066 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m09:00:18.991321 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d7935d45-f611-4944-b811-37257e6dec13&page=queryresults
[0m09:00:23.041554 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 09:00:17.615006 => 09:00:23.041554
[0m09:00:23.043564 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB48DDE50>]}
[0m09:00:23.045552 [info ] [Thread-2  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 5.45s]
[0m09:00:23.047571 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m09:00:23.049555 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m09:00:23.050554 [info ] [Thread-1  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m09:00:23.052557 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m09:00:23.053558 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m09:00:23.063454 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m09:00:23.065561 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 09:00:23.054554 => 09:00:23.064564
[0m09:00:23.066552 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m09:00:23.071575 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:23.700719 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m09:00:23.703741 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m09:00:24.286174 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a740dfb7-f3f7-453e-97cd-fc6e6a6c93d3&page=queryresults
[0m09:00:26.815539 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 09:00:23.066552 => 09:00:26.814484
[0m09:00:26.816533 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB48DCDC0>]}
[0m09:00:26.817655 [info ] [Thread-1  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 3.76s]
[0m09:00:26.819601 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m09:00:26.821638 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m09:00:26.822550 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m09:00:26.823612 [info ] [Thread-2  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m09:00:26.826586 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m09:00:26.824614 [info ] [Thread-1  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m09:00:26.828574 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m09:00:26.830606 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m09:00:26.835163 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m09:00:26.847216 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m09:00:26.866189 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m09:00:26.867192 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 09:00:26.835163 => 09:00:26.867192
[0m09:00:26.868187 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m09:00:26.872202 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:26.902155 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 09:00:26.830606 => 09:00:26.901154
[0m09:00:26.902155 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m09:00:26.906191 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:27.491529 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m09:00:27.494527 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m09:00:27.504575 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m09:00:27.508577 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m09:00:28.098053 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b3947108-cff8-4096-a1e5-d927615b435f&page=queryresults
[0m09:00:28.179921 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3ec1fdc8-ec03-4999-ac21-cbd24196884c&page=queryresults
[0m09:00:30.338584 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 09:00:26.904187 => 09:00:30.337576
[0m09:00:30.339585 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB4A72130>]}
[0m09:00:30.340584 [info ] [Thread-2  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 3.51s]
[0m09:00:30.341195 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m09:00:30.341195 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m09:00:30.343300 [info ] [Thread-2  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m09:00:30.344298 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m09:00:30.346308 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m09:00:30.354302 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m09:00:30.356307 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 09:00:30.346308 => 09:00:30.356307
[0m09:00:30.357309 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m09:00:30.361314 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:30.679831 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 09:00:26.868187 => 09:00:30.679831
[0m09:00:30.680834 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB4A721C0>]}
[0m09:00:30.681849 [info ] [Thread-1  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 3.85s]
[0m09:00:30.682830 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m09:00:30.682830 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m09:00:30.683829 [info ] [Thread-1  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m09:00:30.683829 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m09:00:30.684834 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m09:00:30.687823 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m09:00:30.688815 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 09:00:30.684834 => 09:00:30.688815
[0m09:00:30.688815 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m09:00:30.693828 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:31.002754 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m09:00:31.004752 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m09:00:31.323941 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m09:00:31.325840 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b06d1b75-7076-47c2-901b-146fc83d51f3&page=queryresults
[0m09:00:31.330055 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m09:00:31.880642 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9940b284-7a3e-44ad-ac05-c608a9e8f0da&page=queryresults
[0m09:00:33.248810 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 09:00:30.358208 => 09:00:33.248810
[0m09:00:33.250812 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB48B07F0>]}
[0m09:00:33.251813 [info ] [Thread-2  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 2.91s]
[0m09:00:33.252805 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m09:00:33.254907 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m09:00:33.255921 [info ] [Thread-2  ]: 20 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m09:00:33.257914 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m09:00:33.259909 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m09:00:33.267909 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m09:00:33.269908 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 09:00:33.259909 => 09:00:33.269908
[0m09:00:33.270918 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m09:00:33.273899 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:33.899441 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m09:00:33.902437 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m09:00:34.259951 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d7f7c228-c462-4082-8cd2-e48c4dd45e5e&page=queryresults
[0m09:00:34.405176 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 09:00:30.689823 => 09:00:34.404173
[0m09:00:34.407174 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB38870A0>]}
[0m09:00:34.408177 [info ] [Thread-1  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.72s]
[0m09:00:34.410079 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m09:00:34.412178 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m09:00:34.413080 [info ] [Thread-1  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m09:00:34.415175 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m09:00:34.416178 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m09:00:34.424181 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m09:00:34.426074 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 09:00:34.417176 => 09:00:34.425183
[0m09:00:34.426074 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m09:00:34.429181 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:35.050935 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m09:00:35.052934 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m09:00:35.403725 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6a7a64b9-88b3-4324-8f3e-133823d5df0d&page=queryresults
[0m09:00:36.207026 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 09:00:33.270918 => 09:00:36.206028
[0m09:00:36.208025 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB4A36DF0>]}
[0m09:00:36.210049 [info ] [Thread-2  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 2.95s]
[0m09:00:36.211050 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m09:00:36.212048 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m09:00:36.213044 [info ] [Thread-2  ]: 22 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m09:00:36.214941 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m09:00:36.215984 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m09:00:36.221969 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m09:00:36.223971 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 09:00:36.216994 => 09:00:36.223971
[0m09:00:36.223971 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m09:00:36.231976 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:36.822513 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m09:00:36.824516 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m09:00:37.532706 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5f89f717-561b-4978-9b62-d9d915122ddc&page=queryresults
[0m09:00:40.712266 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 09:00:34.426074 => 09:00:40.712266
[0m09:00:40.714279 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB4A584F0>]}
[0m09:00:40.714279 [info ] [Thread-1  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.2 KiB processed)[0m in 6.30s]
[0m09:00:40.715263 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m09:00:40.716265 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m09:00:40.717262 [info ] [Thread-1  ]: 23 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m09:00:40.718272 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m09:00:40.719270 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m09:00:40.726265 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m09:00:40.728142 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 09:00:40.720270 => 09:00:40.727263
[0m09:00:40.728142 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m09:00:40.731267 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:41.244760 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 09:00:36.224977 => 09:00:41.244760
[0m09:00:41.245753 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB49AD790>]}
[0m09:00:41.246757 [info ] [Thread-2  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 5.03s]
[0m09:00:41.247773 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m09:00:41.248776 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m09:00:41.248776 [info ] [Thread-2  ]: 24 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m09:00:41.250770 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m09:00:41.251770 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m09:00:41.262284 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m09:00:41.264297 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 09:00:41.252773 => 09:00:41.264297
[0m09:00:41.265300 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m09:00:41.267296 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:41.379058 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m09:00:41.382004 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m09:00:41.781532 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2a5bd02e-dff2-47fa-b7d0-d58aaf6cf0b3&page=queryresults
[0m09:00:41.903338 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m09:00:41.906305 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m09:00:42.592975 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cb425b64-06d5-4509-9221-d6dec807f23e&page=queryresults
[0m09:00:44.065056 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 09:00:40.728142 => 09:00:44.064053
[0m09:00:44.067053 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB4A65BE0>]}
[0m09:00:44.785948 [info ] [Thread-1  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.3 KiB processed)[0m in 3.35s]
[0m09:00:44.787947 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m09:00:44.788946 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m09:00:44.790200 [info ] [Thread-1  ]: 25 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m09:00:44.791248 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m09:00:44.792263 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m09:00:44.800249 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m09:00:44.802209 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 09:00:44.792263 => 09:00:44.801247
[0m09:00:44.802209 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m09:00:44.814303 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m09:00:45.441157 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m09:00:45.445155 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m09:00:45.779239 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:375df0ba-8b2a-4526-b068-6771f677a86c&page=queryresults
[0m09:00:47.569949 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 09:00:41.265300 => 09:00:47.568945
[0m09:00:47.570945 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB5AAA040>]}
[0m09:00:47.572944 [info ] [Thread-2  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 6.32s]
[0m09:00:47.574947 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m09:00:49.194259 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 09:00:44.803242 => 09:00:49.193259
[0m09:00:49.196263 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB5A95CD0>]}
[0m09:00:49.197262 [info ] [Thread-1  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 4.41s]
[0m09:00:49.199262 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m09:00:49.201261 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m09:00:49.202264 [info ] [Thread-2  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m09:00:49.204259 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m09:00:49.205262 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m09:00:49.213257 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m09:00:49.215253 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 09:00:49.206261 => 09:00:49.215253
[0m09:00:49.216251 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m09:00:49.218252 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m09:00:50.085252 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m09:00:50.088238 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m09:00:50.803814 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e9d3c7b6-26ea-4230-9049-9458006fcb32&page=queryresults
[0m09:00:54.842704 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 09:00:49.216251 => 09:00:54.842704
[0m09:00:54.844730 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9209f884-73a6-4578-afb6-44c41cff1a3a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB5AAAFD0>]}
[0m09:00:54.844730 [info ] [Thread-2  ]: 26 of 26 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 5.64s]
[0m09:00:54.845699 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m09:00:54.848705 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:00:54.849703 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:00:54.849703 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:00:54.850698 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m09:00:54.851707 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m09:00:54.851707 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m09:00:54.852701 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m09:00:54.853697 [info ] [MainThread]: 
[0m09:00:54.854700 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 48.13 seconds (48.13s).
[0m09:00:54.862749 [debug] [MainThread]: Command end result
[0m09:00:54.875747 [info ] [MainThread]: 
[0m09:00:54.876680 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:00:54.877680 [info ] [MainThread]: 
[0m09:00:54.877680 [info ] [MainThread]: Done. PASS=26 WARN=0 ERROR=0 SKIP=0 TOTAL=26
[0m09:00:54.879814 [debug] [MainThread]: Command `dbt run` succeeded at 09:00:54.878820 after 49.29 seconds
[0m09:00:54.879814 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BAFEA3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB3599E50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020BB3475DC0>]}
[0m09:00:54.879814 [debug] [MainThread]: Flushing usage events
[0m09:00:59.388353 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D63ECA3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D63DC2C9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D63DC2CD30>]}


============================== 09:00:59.397361 | fcb80859-04d6-4018-a7a8-ca7341629baa ==============================
[0m09:00:59.397361 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:00:59.398364 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'invocation_command': 'dbt snapshot', 'send_anonymous_usage_stats': 'True'}
[0m09:01:00.385327 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fcb80859-04d6-4018-a7a8-ca7341629baa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D640DEDBB0>]}
[0m09:01:00.486623 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fcb80859-04d6-4018-a7a8-ca7341629baa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D642300A30>]}
[0m09:01:00.488671 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:01:00.498670 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:01:00.553343 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:01:00.553343 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:01:00.557343 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fcb80859-04d6-4018-a7a8-ca7341629baa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D6426062B0>]}
[0m09:01:00.570320 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fcb80859-04d6-4018-a7a8-ca7341629baa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D642518C40>]}
[0m09:01:00.570320 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:01:00.571313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fcb80859-04d6-4018-a7a8-ca7341629baa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D6424E40A0>]}
[0m09:01:00.572337 [info ] [MainThread]: 
[0m09:01:00.573336 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:01:00.575308 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:01:00.576308 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:01:01.257314 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m09:01:01.258295 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:01:01.259282 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m09:01:01.260305 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:01:02.043065 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m09:01:02.053067 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:01:02.057068 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m09:01:02.058090 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:01:02.824154 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fcb80859-04d6-4018-a7a8-ca7341629baa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D6423CA7C0>]}
[0m09:01:02.826160 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:01:02.826160 [info ] [MainThread]: 
[0m09:01:02.833154 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:01:02.834156 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m09:01:02.836155 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m09:01:02.838155 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:01:02.861151 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 09:01:02.838155 => 09:01:02.861151
[0m09:01:02.862149 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:01:02.927687 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:01:02.929686 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m09:01:03.730389 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f4d0c7bd-7079-42a0-b875-434c78eb7065&page=queryresults
[0m09:01:04.832940 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m09:01:05.187773 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a77f7b00-4c2c-46f7-805a-42f4c1a3d64b&page=queryresults
[0m09:01:07.639028 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m09:01:08.403531 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m09:01:08.405537 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m09:01:08.878384 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2a13d9d7-b63c-403d-a8dc-eefa78f52aa4&page=queryresults
[0m09:01:10.970061 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 09:01:02.862149 => 09:01:10.970061
[0m09:01:10.972060 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fcb80859-04d6-4018-a7a8-ca7341629baa', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D643677880>]}
[0m09:01:10.974063 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 96.0 KiB processed)[0m in 8.14s]
[0m09:01:10.976064 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m09:01:10.980065 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:01:10.981062 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:01:10.982064 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m09:01:10.983068 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m09:01:10.984069 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m09:01:10.985066 [info ] [MainThread]: 
[0m09:01:10.986066 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.41 seconds (10.41s).
[0m09:01:10.989064 [debug] [MainThread]: Command end result
[0m09:01:11.008070 [info ] [MainThread]: 
[0m09:01:11.009056 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:01:11.009056 [info ] [MainThread]: 
[0m09:01:11.010059 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m09:01:11.012071 [debug] [MainThread]: Command `dbt snapshot` succeeded at 09:01:11.011058 after 11.69 seconds
[0m09:01:11.012071 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D63ECA3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D642285580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D64222CB50>]}
[0m09:01:11.013060 [debug] [MainThread]: Flushing usage events
[0m09:01:16.683660 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3547A7460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D35371D9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D35371DD30>]}


============================== 09:01:16.688660 | bdddbeab-14cc-4750-b3c6-58ba40d31bc4 ==============================
[0m09:01:16.688660 [info ] [MainThread]: Running with dbt=1.7.4
[0m09:01:16.689659 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m09:01:17.612464 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bdddbeab-14cc-4750-b3c6-58ba40d31bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D353715040>]}
[0m09:01:17.718993 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bdddbeab-14cc-4750-b3c6-58ba40d31bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3536DFF10>]}
[0m09:01:17.721009 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m09:01:17.730019 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m09:01:17.783535 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m09:01:17.783535 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m09:01:17.788539 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bdddbeab-14cc-4750-b3c6-58ba40d31bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D358115F40>]}
[0m09:01:17.804532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bdddbeab-14cc-4750-b3c6-58ba40d31bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D358028AF0>]}
[0m09:01:17.805532 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m09:01:17.806531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bdddbeab-14cc-4750-b3c6-58ba40d31bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D358028BE0>]}
[0m09:01:17.808534 [info ] [MainThread]: 
[0m09:01:17.809530 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m09:01:17.811544 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m09:01:17.812531 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:01:18.781197 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m09:01:18.783193 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:01:18.784244 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m09:01:18.786190 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m09:01:19.453650 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m09:01:19.454639 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:01:19.499627 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m09:01:19.500627 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m09:01:20.280504 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bdddbeab-14cc-4750-b3c6-58ba40d31bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D357DCAC70>]}
[0m09:01:20.282561 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m09:01:20.283505 [info ] [MainThread]: 
[0m09:01:20.291538 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:01:20.293542 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m09:01:20.295546 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m09:01:20.296553 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:01:20.312549 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m09:01:20.315491 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 09:01:20.297549 => 09:01:20.314545
[0m09:01:20.316548 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:01:20.333572 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m09:01:21.194899 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m09:01:21.196866 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m09:01:21.600559 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b73f281d-765a-4a34-b6cb-0b056ccbf6ed&page=queryresults
[0m09:01:23.831529 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 09:01:20.316548 => 09:01:23.831529
[0m09:01:23.832527 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bdddbeab-14cc-4750-b3c6-58ba40d31bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D359191400>]}
[0m09:01:23.833529 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (443.0 rows, 81.5 KiB processed)[0m in 3.54s]
[0m09:01:23.834553 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m09:01:23.834553 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m09:01:23.835528 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m09:01:23.836557 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m09:01:23.837496 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m09:01:23.846514 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m09:01:23.849555 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 09:01:23.838503 => 09:01:23.848577
[0m09:01:23.850584 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m09:01:23.856652 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m09:01:24.479132 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m09:01:24.483134 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m09:01:24.871465 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fe7b50eb-a8b5-48be-9bc0-2fda6a0b9a21&page=queryresults
[0m09:01:27.107739 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 09:01:23.851577 => 09:01:27.106745
[0m09:01:27.108724 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bdddbeab-14cc-4750-b3c6-58ba40d31bc4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3591BA280>]}
[0m09:01:27.109722 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (355.0 rows, 107.7 KiB processed)[0m in 3.27s]
[0m09:01:27.109722 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m09:01:27.113135 [debug] [MainThread]: Connection 'master' was properly closed.
[0m09:01:27.114084 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m09:01:27.114084 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m09:01:27.115088 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m09:01:27.115088 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m09:01:27.116082 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m09:01:27.117090 [info ] [MainThread]: 
[0m09:01:27.118078 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 9.31 seconds (9.31s).
[0m09:01:27.120146 [debug] [MainThread]: Command end result
[0m09:01:27.140740 [info ] [MainThread]: 
[0m09:01:27.141778 [info ] [MainThread]: [32mCompleted successfully[0m
[0m09:01:27.141778 [info ] [MainThread]: 
[0m09:01:27.142745 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m09:01:27.143778 [debug] [MainThread]: Command `dbt run` succeeded at 09:01:27.143778 after 10.52 seconds
[0m09:01:27.143778 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D3547A7460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D357E7CC40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001D357E96A00>]}
[0m09:01:27.144822 [debug] [MainThread]: Flushing usage events
[0m10:00:03.667681 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB1DCC3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB1CC419D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB1CC41B80>]}


============================== 10:00:03.671693 | 2d8a7694-128b-4e85-9df0-4864d7f424e5 ==============================
[0m10:00:03.671693 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:00:03.672695 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:00:04.869294 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB212549A0>]}
[0m10:00:04.976328 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB2132ED00>]}
[0m10:00:04.978888 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:00:04.989036 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:00:05.151913 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:00:05.152830 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:00:05.159351 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB216264C0>]}
[0m10:00:05.176144 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB2151B2B0>]}
[0m10:00:05.177710 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:00:05.178772 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB21345DF0>]}
[0m10:00:05.180748 [info ] [MainThread]: 
[0m10:00:05.181747 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:00:05.184749 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:05.184749 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:05.186267 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:05.186267 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:06.069642 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:06.894715 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m10:00:06.894715 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:06.898956 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m10:00:06.901935 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:07.610497 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m10:00:07.612436 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:07.615966 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m10:00:07.618616 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:08.459167 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB2151B2E0>]}
[0m10:00:08.462249 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:00:08.463198 [info ] [MainThread]: 
[0m10:00:08.480407 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:08.482389 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m10:00:08.481469 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m10:00:08.489438 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m10:00:08.492457 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:08.517012 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:00:08.518666 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m10:00:08.520658 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m10:00:08.520658 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m10:00:08.524655 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m10:00:08.529728 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 10:00:08.521723 => 10:00:08.528717
[0m10:00:08.529728 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m10:00:08.547711 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 10:00:08.497650 => 10:00:08.547711
[0m10:00:08.563012 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:08.619757 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m10:00:08.621707 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:00:08.623711 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:00:08.624702 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:00:08.628049 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m10:00:08.656074 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m10:00:09.879172 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b4a6daa2-6a96-4054-b465-91e00f655526&page=queryresults
[0m10:00:09.973527 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5460cf59-a78c-4b49-98eb-6e7d1c01bdc7&page=queryresults
[0m10:00:10.426018 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 10:00:08.564004 => 10:00:10.426018
[0m10:00:10.429694 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 10:00:08.532194 => 10:00:10.429694
[0m10:00:10.430661 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB21678DC0>]}
[0m10:00:10.430661 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB2151B2E0>]}
[0m10:00:10.431734 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.94s]
[0m10:00:10.433633 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:00:10.432628 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.91s]
[0m10:00:10.434632 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m10:00:10.434632 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m10:00:10.436140 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_compra
[0m10:00:10.434632 [info ] [Thread-1  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m10:00:10.438554 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m10:00:10.436140 [info ] [Thread-2  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m10:00:10.438554 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m10:00:10.439672 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_compra)
[0m10:00:10.444225 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m10:00:10.445223 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_compra
[0m10:00:10.456747 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m10:00:10.458270 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 10:00:10.439672 => 10:00:10.456747
[0m10:00:10.459273 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m10:00:10.462287 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m10:00:10.464286 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (compile): 10:00:10.445223 => 10:00:10.463290
[0m10:00:10.464286 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_compra
[0m10:00:10.467843 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m10:00:10.468448 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:10.469763 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m10:00:10.495985 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:10.498087 [debug] [Thread-2  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m10:00:11.312980 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3f7ef1c8-86d6-4b97-b6ac-90945706c459&page=queryresults
[0m10:00:11.321015 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:85a1855c-542a-4816-a662-3ebd92129325&page=queryresults
[0m10:00:11.756153 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 10:00:10.459273 => 10:00:11.754637
[0m10:00:11.758697 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB226C5FA0>]}
[0m10:00:11.766226 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (execute): 10:00:10.464286 => 10:00:11.766226
[0m10:00:11.767782 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB226DEFA0>]}
[0m10:00:11.760707 [info ] [Thread-1  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m10:00:11.770807 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m10:00:11.768805 [info ] [Thread-2  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m10:00:11.771803 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m10:00:11.775802 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_compra
[0m10:00:11.778130 [info ] [Thread-1  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m10:00:11.779149 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m10:00:11.780142 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m10:00:11.782142 [info ] [Thread-2  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m10:00:11.783154 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m10:00:11.784720 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m10:00:11.788827 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m10:00:11.800589 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m10:00:11.824354 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m10:00:11.826881 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 10:00:11.789827 => 10:00:11.825865
[0m10:00:11.828465 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m10:00:11.832474 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m10:00:11.837016 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 10:00:11.786278 => 10:00:11.834472
[0m10:00:11.838011 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m10:00:11.841209 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m10:00:11.846219 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:11.855957 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:11.856959 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m10:00:11.892009 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m10:00:12.666688 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:647995de-e2f5-4c60-98ba-f0e1b43eaa73&page=queryresults
[0m10:00:12.704035 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:292e9dc9-be5a-438b-bbd7-7d899cc019db&page=queryresults
[0m10:00:13.076129 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 10:00:11.828465 => 10:00:13.075110
[0m10:00:13.076129 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB22768B80>]}
[0m10:00:13.077638 [info ] [Thread-2  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m10:00:13.077638 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m10:00:13.077638 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_compra
[0m10:00:13.079164 [info ] [Thread-2  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m10:00:13.079164 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_compra)
[0m10:00:13.080188 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m10:00:13.084722 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m10:00:13.086255 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 10:00:13.080188 => 10:00:13.086255
[0m10:00:13.086255 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m10:00:13.090814 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m10:00:13.091817 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:13.096800 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m10:00:13.140631 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 10:00:11.838011 => 10:00:13.139644
[0m10:00:13.142145 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB21658CD0>]}
[0m10:00:13.142633 [info ] [Thread-1  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m10:00:13.143632 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m10:00:13.144638 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m10:00:13.146162 [info ] [Thread-1  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m10:00:13.147676 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m10:00:13.148687 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m10:00:13.152694 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m10:00:13.154699 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 10:00:13.148687 => 10:00:13.153701
[0m10:00:13.154699 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m10:00:13.158742 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m10:00:13.159741 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:13.161753 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m10:00:13.835964 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:029853b9-b3aa-475f-9c33-83a442391d2b&page=queryresults
[0m10:00:13.911200 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:928621a9-4313-4016-8c38-0b2215e97533&page=queryresults
[0m10:00:14.306868 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 10:00:13.087783 => 10:00:14.305785
[0m10:00:14.307805 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB227C2220>]}
[0m10:00:14.320541 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 10:00:13.156217 => 10:00:14.319499
[0m10:00:14.324429 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB226DAE80>]}
[0m10:00:14.322422 [info ] [Thread-2  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m10:00:14.326962 [info ] [Thread-1  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m10:00:14.328474 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m10:00:14.329484 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m10:00:14.330485 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:14.331484 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m10:00:14.332492 [info ] [Thread-2  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m10:00:14.336028 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m10:00:14.337539 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:14.334509 [info ] [Thread-1  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m10:00:14.344582 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m10:00:14.346096 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m10:00:14.348645 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m10:00:14.354643 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m10:00:14.356159 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 10:00:14.337539 => 10:00:14.356159
[0m10:00:14.357778 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:14.366818 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 10:00:14.349664 => 10:00:14.366818
[0m10:00:14.369307 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m10:00:14.384396 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m10:00:14.387908 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m10:00:14.388413 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:14.390538 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m10:00:14.414550 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:14.417588 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m10:00:15.371810 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fae7b960-f679-432c-b23e-370d49da56a0&page=queryresults
[0m10:00:15.378331 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:05a0f434-2567-4da4-83b2-d3e36bad1307&page=queryresults
[0m10:00:15.770901 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 10:00:14.358819 => 10:00:15.770901
[0m10:00:15.773965 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB226C0340>]}
[0m10:00:15.776936 [info ] [Thread-2  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m10:00:15.779062 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m10:00:15.782780 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m10:00:15.786286 [info ] [Thread-2  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m10:00:15.790937 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m10:00:15.794922 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m10:00:15.803455 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 10:00:14.384396 => 10:00:15.802459
[0m10:00:15.813767 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m10:00:15.817884 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB226DAE80>]}
[0m10:00:15.820533 [info ] [Thread-1  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m10:00:15.823522 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m10:00:15.826049 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 10:00:15.803455 => 10:00:15.824521
[0m10:00:15.827793 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m10:00:15.828352 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m10:00:15.829420 [info ] [Thread-1  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m10:00:15.834368 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m10:00:15.836930 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m10:00:15.838447 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m10:00:15.842463 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m10:00:15.844455 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 10:00:15.838447 => 10:00:15.843451
[0m10:00:15.844455 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m10:00:15.848503 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m10:00:15.849519 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:15.851528 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m10:00:15.879714 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:15.881221 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m10:00:16.599995 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:935315d9-f18c-426a-8d37-7c15079c4aaa&page=queryresults
[0m10:00:16.673832 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e0c81eb1-b0d5-4a95-a2bd-81ad9072a9b3&page=queryresults
[0m10:00:17.015879 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 10:00:15.830399 => 10:00:17.014867
[0m10:00:17.016935 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB227C81C0>]}
[0m10:00:17.018377 [info ] [Thread-2  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m10:00:17.020406 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m10:00:17.021396 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m10:00:17.022434 [info ] [Thread-2  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m10:00:17.024393 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m10:00:17.024393 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m10:00:17.051603 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m10:00:17.054594 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 10:00:17.025913 => 10:00:17.054594
[0m10:00:17.056176 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m10:00:17.066263 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m10:00:17.070848 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:17.077866 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m10:00:17.106178 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 10:00:15.844455 => 10:00:17.106178
[0m10:00:17.107686 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB216A43A0>]}
[0m10:00:17.108736 [info ] [Thread-1  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m10:00:17.109694 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m10:00:17.109694 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m10:00:17.110731 [info ] [Thread-1  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m10:00:17.110731 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.dm_produto)
[0m10:00:17.111697 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m10:00:17.114696 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m10:00:17.116238 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 10:00:17.111697 => 10:00:17.116238
[0m10:00:17.116238 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m10:00:17.124785 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:17.823724 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m10:00:17.824726 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m10:00:17.886024 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4a255870-447c-4509-9bd8-9b3a7d133998&page=queryresults
[0m10:00:18.259530 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 10:00:17.057709 => 10:00:18.258486
[0m10:00:18.262533 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB226E37F0>]}
[0m10:00:18.268109 [info ] [Thread-2  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m10:00:18.271145 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m10:00:18.433309 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7b25f5f2-6b7a-4408-be3c-60b69de90a8a&page=queryresults
[0m10:00:21.367777 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 10:00:17.116238 => 10:00:21.366246
[0m10:00:21.371360 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB227A6AC0>]}
[0m10:00:21.374376 [info ] [Thread-1  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 4.26s]
[0m10:00:21.379500 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m10:00:21.381413 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m10:00:21.383418 [info ] [Thread-2  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m10:00:21.387577 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m10:00:21.389656 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m10:00:21.406933 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m10:00:21.410490 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 10:00:21.390665 => 10:00:21.409529
[0m10:00:21.412478 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m10:00:21.434849 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:22.114001 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m10:00:22.117014 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m10:00:22.726275 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:245c2651-42cf-45e9-9900-712531f69d83&page=queryresults
[0m10:00:25.838753 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 10:00:21.414486 => 10:00:25.837684
[0m10:00:25.840978 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB227B87C0>]}
[0m10:00:25.843850 [info ] [Thread-2  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 4.45s]
[0m10:00:25.847880 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m10:00:25.854001 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m10:00:25.857029 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_compra
[0m10:00:25.859559 [info ] [Thread-1  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m10:00:25.866137 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m10:00:25.861591 [info ] [Thread-2  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m10:00:25.868757 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m10:00:25.871851 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m10:00:25.888025 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m10:00:25.889117 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_compra
[0m10:00:25.901752 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m10:00:25.910883 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 10:00:25.874831 => 10:00:25.906272
[0m10:00:25.914499 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m10:00:25.917063 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (compile): 10:00:25.890053 => 10:00:25.914499
[0m10:00:25.926160 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:25.928720 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_compra
[0m10:00:25.940764 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:26.960374 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m10:00:26.962361 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m10:00:26.964324 [debug] [Thread-2  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m10:00:26.965832 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m10:00:27.513687 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:59d9a668-0619-439a-9eae-743c856cef75&page=queryresults
[0m10:00:27.660227 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bd642652-643a-4cee-9c56-cabc3901026d&page=queryresults
[0m10:00:29.588595 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 10:00:25.918593 => 10:00:29.588595
[0m10:00:29.589572 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB226D2190>]}
[0m10:00:29.590595 [info ] [Thread-1  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 3.72s]
[0m10:00:29.592100 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m10:00:29.593113 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m10:00:29.595110 [info ] [Thread-1  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m10:00:29.596119 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m10:00:29.596119 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m10:00:29.600667 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m10:00:29.601666 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 10:00:29.596119 => 10:00:29.600667
[0m10:00:29.602672 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m10:00:29.610694 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:30.020966 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (execute): 10:00:25.930734 => 10:00:30.019956
[0m10:00:30.021955 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB228907F0>]}
[0m10:00:30.023867 [info ] [Thread-2  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 4.15s]
[0m10:00:30.023867 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_compra
[0m10:00:30.025376 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m10:00:30.025376 [info ] [Thread-2  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m10:00:30.027920 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m10:00:30.027920 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m10:00:30.034991 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m10:00:30.038840 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 10:00:30.027920 => 10:00:30.037548
[0m10:00:30.039861 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m10:00:30.043873 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:30.208989 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m10:00:30.210031 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m10:00:30.636973 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cb51346d-4122-4027-86f6-03c479c961e7&page=queryresults
[0m10:00:30.694688 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m10:00:30.701461 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m10:00:31.325286 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6d170b10-7393-4c44-b83c-646e2e20b406&page=queryresults
[0m10:00:32.677714 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 10:00:29.603669 => 10:00:32.677714
[0m10:00:32.679733 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB226F3220>]}
[0m10:00:32.680750 [info ] [Thread-1  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 3.08s]
[0m10:00:32.681740 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m10:00:32.682751 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m10:00:32.683749 [info ] [Thread-1  ]: 20 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m10:00:32.686248 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m10:00:32.686248 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m10:00:32.696300 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m10:00:32.706929 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 10:00:32.686248 => 10:00:32.704392
[0m10:00:32.707930 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m10:00:32.713206 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:33.466512 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m10:00:33.468049 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m10:00:33.838684 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 10:00:30.039861 => 10:00:33.838684
[0m10:00:33.840700 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB226F3D30>]}
[0m10:00:33.842698 [info ] [Thread-2  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.81s]
[0m10:00:33.844696 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m10:00:33.847724 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m10:00:33.848737 [info ] [Thread-2  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m10:00:33.851739 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m10:00:33.853749 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m10:00:33.861784 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m10:00:33.865812 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 10:00:33.854737 => 10:00:33.864784
[0m10:00:33.866833 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m10:00:33.873343 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:33.897537 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:addb46b6-6b64-437a-bf3d-cb6cafb8e367&page=queryresults
[0m10:00:34.516335 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m10:00:34.517894 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m10:00:35.017676 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:83f1333f-5d5e-47a0-80c9-0cc7df5c9b84&page=queryresults
[0m10:00:35.865462 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 10:00:32.707930 => 10:00:35.865462
[0m10:00:35.866469 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB227B87C0>]}
[0m10:00:35.866469 [info ] [Thread-1  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 3.18s]
[0m10:00:35.867974 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m10:00:35.867974 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m10:00:35.867974 [info ] [Thread-1  ]: 22 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m10:00:35.868981 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m10:00:35.868981 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m10:00:35.871986 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m10:00:35.872988 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 10:00:35.868981 => 10:00:35.872988
[0m10:00:35.873989 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m10:00:35.875987 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:36.500596 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m10:00:36.506113 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m10:00:37.171692 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 10:00:33.866833 => 10:00:37.171692
[0m10:00:37.174694 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB226F3430>]}
[0m10:00:37.177719 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2f2c62cf-79a2-42e8-b849-821d190d0004&page=queryresults
[0m10:00:37.180730 [info ] [Thread-2  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.2 KiB processed)[0m in 3.32s]
[0m10:00:37.183729 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m10:00:37.187742 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:00:37.189748 [info ] [Thread-2  ]: 23 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m10:00:37.191749 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m10:00:37.192751 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:00:37.200273 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m10:00:37.202271 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 10:00:37.194750 => 10:00:37.202271
[0m10:00:37.202271 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:00:37.207800 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:37.887612 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m10:00:37.889634 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m10:00:38.357665 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2dae2301-34c3-4c50-9577-82a0e3f5d224&page=queryresults
[0m10:00:40.306281 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 10:00:35.873989 => 10:00:40.306281
[0m10:00:40.306281 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB22824700>]}
[0m10:00:40.307789 [info ] [Thread-1  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 4.44s]
[0m10:00:40.309801 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m10:00:40.310797 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m10:00:40.311795 [info ] [Thread-1  ]: 24 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m10:00:40.313797 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m10:00:40.315803 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m10:00:40.322331 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m10:00:40.324341 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 10:00:40.316822 => 10:00:40.323339
[0m10:00:40.324341 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m10:00:40.337896 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:40.663497 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 10:00:37.203271 => 10:00:40.660490
[0m10:00:40.668092 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB227A86D0>]}
[0m10:00:41.086138 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m10:00:41.088669 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m10:00:41.751843 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:39660afc-e547-4674-a881-976a6052a3f2&page=queryresults
[0m10:00:41.749904 [info ] [Thread-2  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.3 KiB processed)[0m in 3.47s]
[0m10:00:41.757887 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:00:41.759177 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m10:00:41.760272 [info ] [Thread-2  ]: 25 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m10:00:41.761175 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m10:00:41.762171 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m10:00:41.768140 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m10:00:41.770429 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 10:00:41.762171 => 10:00:41.768866
[0m10:00:41.771920 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m10:00:41.777584 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:00:42.451713 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m10:00:42.459783 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m10:00:42.871355 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:49e3ecd0-033f-49f7-a2ec-1ff01990aabc&page=queryresults
[0m10:00:44.304978 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 10:00:40.324341 => 10:00:44.304978
[0m10:00:44.305980 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB238F3D00>]}
[0m10:00:44.305980 [info ] [Thread-1  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 3.99s]
[0m10:00:44.307002 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m10:00:46.608566 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 10:00:41.773031 => 10:00:46.607550
[0m10:00:46.608566 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB22891760>]}
[0m10:00:46.609558 [info ] [Thread-2  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 4.85s]
[0m10:00:46.610567 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m10:00:46.611564 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m10:00:46.612571 [info ] [Thread-1  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m10:00:46.614581 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m10:00:46.616100 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m10:00:46.620722 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m10:00:46.621631 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 10:00:46.617613 => 10:00:46.620722
[0m10:00:46.621631 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m10:00:46.623630 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:00:47.240669 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m10:00:47.243195 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m10:00:47.821686 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a6a53b37-7696-40c9-a532-2f003554c95f&page=queryresults
[0m10:00:51.866300 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 10:00:46.621631 => 10:00:51.866300
[0m10:00:51.867828 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2d8a7694-128b-4e85-9df0-4864d7f424e5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB22891CA0>]}
[0m10:00:51.867828 [info ] [Thread-1  ]: 26 of 26 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 5.25s]
[0m10:00:51.868844 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m10:00:51.870872 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:00:51.871862 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:51.871862 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:00:51.872856 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m10:00:51.872856 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m10:00:51.872856 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m10:00:51.872856 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m10:00:51.873847 [info ] [MainThread]: 
[0m10:00:51.874850 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 46.69 seconds (46.69s).
[0m10:00:51.878377 [debug] [MainThread]: Command end result
[0m10:00:51.984531 [info ] [MainThread]: 
[0m10:00:51.986042 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:00:51.986042 [info ] [MainThread]: 
[0m10:00:51.986042 [info ] [MainThread]: Done. PASS=26 WARN=0 ERROR=0 SKIP=0 TOTAL=26
[0m10:00:51.987581 [debug] [MainThread]: Command `dbt run` succeeded at 10:00:51.987581 after 48.39 seconds
[0m10:00:51.987581 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB1DCC3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB212DCF40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BB210C9D30>]}
[0m10:00:51.988591 [debug] [MainThread]: Flushing usage events
[0m10:00:55.702746 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AAA1513430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AAA048D670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AAA048DAC0>]}


============================== 10:00:55.707877 | ad63b428-59ef-41a4-af79-c047cabe9146 ==============================
[0m10:00:55.707877 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:00:55.708441 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:00:56.502969 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ad63b428-59ef-41a4-af79-c047cabe9146', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AAA0479FD0>]}
[0m10:00:56.584417 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ad63b428-59ef-41a4-af79-c047cabe9146', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AAA4B717C0>]}
[0m10:00:56.586239 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:00:56.592889 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:00:56.666035 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:00:56.666035 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:00:56.673575 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ad63b428-59ef-41a4-af79-c047cabe9146', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AAA4E763A0>]}
[0m10:00:56.688679 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ad63b428-59ef-41a4-af79-c047cabe9146', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AAA4D883D0>]}
[0m10:00:56.689681 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:00:56.689681 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ad63b428-59ef-41a4-af79-c047cabe9146', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AAA4D551C0>]}
[0m10:00:56.690706 [info ] [MainThread]: 
[0m10:00:56.695191 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:00:56.696757 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:00:56.697778 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:57.531510 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:00:57.532454 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:57.533504 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m10:00:57.534453 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:00:58.337608 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m10:00:58.342092 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m10:00:58.343626 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:58.346347 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:00:59.078594 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ad63b428-59ef-41a4-af79-c047cabe9146', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AAA4A8E2B0>]}
[0m10:00:59.079594 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:00:59.081101 [info ] [MainThread]: 
[0m10:00:59.088627 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:00:59.088627 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m10:00:59.089628 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m10:00:59.089628 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:00:59.102404 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 10:00:59.090659 => 10:00:59.101404
[0m10:00:59.102404 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:00:59.156205 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:00:59.158718 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m10:01:00.017889 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:59e7cf52-c245-409d-8c8c-459e2d693d67&page=queryresults
[0m10:01:01.248294 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m10:01:01.679208 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:53965696-b718-45e1-88f9-ee07a9705d4d&page=queryresults
[0m10:01:04.655915 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m10:01:05.501340 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m10:01:05.509578 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m10:01:05.963952 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:78bce290-2669-4e51-843a-bf2afc435263&page=queryresults
[0m10:01:08.372451 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 10:00:59.102404 => 10:01:08.371465
[0m10:01:08.374455 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ad63b428-59ef-41a4-af79-c047cabe9146', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AAA5F1D4F0>]}
[0m10:01:08.379498 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 96.0 KiB processed)[0m in 9.28s]
[0m10:01:08.383501 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:01:08.392559 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:01:08.394562 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:01:08.397582 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m10:01:08.399590 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m10:01:08.402602 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m10:01:08.403601 [info ] [MainThread]: 
[0m10:01:08.404590 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 11.71 seconds (11.71s).
[0m10:01:08.409619 [debug] [MainThread]: Command end result
[0m10:01:08.452867 [info ] [MainThread]: 
[0m10:01:08.457643 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:01:08.459722 [info ] [MainThread]: 
[0m10:01:08.461705 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m10:01:08.465709 [debug] [MainThread]: Command `dbt snapshot` succeeded at 10:01:08.464722 after 12.85 seconds
[0m10:01:08.466709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AAA1513430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AAA4B717C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002AAA5F18E50>]}
[0m10:01:08.468288 [debug] [MainThread]: Flushing usage events
[0m10:01:12.750397 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DDF4BE7430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DDF3B7E6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DDF3B7EE20>]}


============================== 10:01:12.759703 | 6e98c9bb-90fc-40c6-8fbd-78bb82f663ee ==============================
[0m10:01:12.759703 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:01:12.760667 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m10:01:13.838727 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6e98c9bb-90fc-40c6-8fbd-78bb82f663ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DDF3B65940>]}
[0m10:01:13.948980 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6e98c9bb-90fc-40c6-8fbd-78bb82f663ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DDF8142280>]}
[0m10:01:13.950981 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:01:13.963562 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:01:14.049484 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:01:14.049484 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:01:14.057674 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6e98c9bb-90fc-40c6-8fbd-78bb82f663ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DDF8555EE0>]}
[0m10:01:14.083761 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6e98c9bb-90fc-40c6-8fbd-78bb82f663ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DDF8468A90>]}
[0m10:01:14.083761 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:01:14.084710 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6e98c9bb-90fc-40c6-8fbd-78bb82f663ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DDF8468B80>]}
[0m10:01:14.086790 [info ] [MainThread]: 
[0m10:01:14.087776 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:01:14.089369 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:01:14.090559 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:01:14.984643 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:01:14.984643 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:01:15.019288 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m10:01:15.022289 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:01:15.626116 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m10:01:15.634657 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:01:15.681778 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m10:01:15.681778 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:01:16.346195 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6e98c9bb-90fc-40c6-8fbd-78bb82f663ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DDF82B4850>]}
[0m10:01:16.348751 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:01:16.349799 [info ] [MainThread]: 
[0m10:01:16.356243 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:01:16.356243 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m10:01:16.358944 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m10:01:16.359893 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:01:16.370706 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m10:01:16.371719 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 10:01:16.359893 => 10:01:16.371719
[0m10:01:16.373907 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:01:16.387707 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:01:17.019627 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m10:01:17.020663 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m10:01:17.374354 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1fca7bd0-73b8-4ba2-88ed-f7c711ee0aa2&page=queryresults
[0m10:01:19.696033 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 10:01:16.374853 => 10:01:19.696033
[0m10:01:19.700588 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e98c9bb-90fc-40c6-8fbd-78bb82f663ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DDF95CB9D0>]}
[0m10:01:19.703441 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (443.0 rows, 81.5 KiB processed)[0m in 3.34s]
[0m10:01:19.706971 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:01:19.709489 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m10:01:19.711494 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m10:01:19.714494 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m10:01:19.716002 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m10:01:19.724519 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m10:01:19.726025 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 10:01:19.717511 => 10:01:19.724519
[0m10:01:19.726025 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m10:01:19.728577 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:01:20.598497 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m10:01:20.601010 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m10:01:21.014527 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:97e6e071-f7b2-45d1-b76e-5a00e3bfef3d&page=queryresults
[0m10:01:23.277970 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 10:01:19.726025 => 10:01:23.276401
[0m10:01:23.281041 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6e98c9bb-90fc-40c6-8fbd-78bb82f663ee', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DDF85DFD30>]}
[0m10:01:23.285052 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (355.0 rows, 107.7 KiB processed)[0m in 3.57s]
[0m10:01:23.289711 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m10:01:23.294697 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:01:23.296278 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:01:23.297857 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m10:01:23.298927 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m10:01:23.300879 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m10:01:23.302931 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m10:01:23.303920 [info ] [MainThread]: 
[0m10:01:23.305462 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 9.22 seconds (9.22s).
[0m10:01:23.310135 [debug] [MainThread]: Command end result
[0m10:01:23.370566 [info ] [MainThread]: 
[0m10:01:23.374834 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:01:23.377887 [info ] [MainThread]: 
[0m10:01:23.388513 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m10:01:23.397717 [debug] [MainThread]: Command `dbt run` succeeded at 10:01:23.396090 after 10.77 seconds
[0m10:01:23.400787 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DDF4BE7430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DDF81D6040>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DDF8328AF0>]}
[0m10:01:23.404791 [debug] [MainThread]: Flushing usage events
[0m11:00:20.506744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251EC2833D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251EB20F2E0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251EB20F760>]}


============================== 11:00:20.510348 | 3c271fad-ffb5-496e-ad44-344756546e86 ==============================
[0m11:00:20.510348 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:00:20.511404 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --exclude tag:snaps', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m11:00:21.124479 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251EB1EBA30>]}
[0m11:00:21.200598 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251EB20F7C0>]}
[0m11:00:21.202573 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:00:21.222626 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:00:25.508036 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:00:25.508036 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:00:25.516097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251EFBE6430>]}
[0m11:00:25.584454 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251EFAF6460>]}
[0m11:00:25.588030 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:00:25.589043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251EFACD280>]}
[0m11:00:25.592041 [info ] [MainThread]: 
[0m11:00:25.596093 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:00:25.603120 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:25.605106 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:25.606109 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:00:25.608176 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:26.997636 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:27.949568 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m11:00:27.950609 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:27.954827 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m11:00:27.956373 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:00:28.833429 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m11:00:28.840988 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:28.841990 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m11:00:28.844507 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:00:29.575334 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251EF85C160>]}
[0m11:00:29.576322 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:00:29.576863 [info ] [MainThread]: 
[0m11:00:29.581867 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:29.582899 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m11:00:29.582899 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m11:00:29.584411 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m11:00:29.586022 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m11:00:29.587069 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m11:00:29.595033 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m11:00:29.600066 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m11:00:29.600066 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:29.603065 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m11:00:29.604616 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 11:00:29.588083 => 11:00:29.604616
[0m11:00:29.604616 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m11:00:29.639564 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m11:00:29.640565 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 11:00:29.601068 => 11:00:29.640565
[0m11:00:29.641566 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:29.646111 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m11:00:29.646111 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m11:00:29.650202 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m11:00:29.679890 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:00:29.684401 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m11:00:30.587199 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6d8ec6fb-15b2-45b3-91db-f9ecb76d5130&page=queryresults
[0m11:00:30.606259 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2a494554-3ac3-406f-a40a-6a57c4988a2b&page=queryresults
[0m11:00:31.116605 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 11:00:29.604616 => 11:00:31.116605
[0m11:00:31.120608 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 11:00:29.642563 => 11:00:31.120608
[0m11:00:31.121638 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0D01670>]}
[0m11:00:31.122628 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0CF3100>]}
[0m11:00:31.125161 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.53s]
[0m11:00:31.126695 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m11:00:31.127725 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m11:00:31.126695 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m11:00:31.127725 [info ] [Thread-2  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m11:00:31.130698 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m11:00:31.133183 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m11:00:31.134200 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_compra
[0m11:00:31.135214 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m11:00:31.136216 [info ] [Thread-1  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m11:00:31.140399 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m11:00:31.142405 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_compra)
[0m11:00:31.144408 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_compra
[0m11:00:31.158067 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m11:00:31.159065 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 11:00:31.136216 => 11:00:31.159065
[0m11:00:31.160070 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m11:00:31.167611 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m11:00:31.169624 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:31.170643 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (compile): 11:00:31.145937 => 11:00:31.169624
[0m11:00:31.171622 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_compra
[0m11:00:31.179721 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m11:00:31.180722 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m11:00:31.208127 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:31.210085 [debug] [Thread-1  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m11:00:32.061680 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9891f0c6-a606-4a0e-a4d6-72092146e628&page=queryresults
[0m11:00:32.067663 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3592e093-556d-4dac-8bc9-afbf44f64232&page=queryresults
[0m11:00:32.478546 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (execute): 11:00:31.176707 => 11:00:32.478004
[0m11:00:32.479547 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0C6D190>]}
[0m11:00:32.480579 [info ] [Thread-1  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m11:00:32.481583 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_compra
[0m11:00:32.481583 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m11:00:32.482556 [info ] [Thread-1  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m11:00:32.484551 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_forma_pagamento)
[0m11:00:32.484551 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m11:00:32.490123 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m11:00:32.493095 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 11:00:32.486063 => 11:00:32.492089
[0m11:00:32.494089 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m11:00:32.496106 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m11:00:32.496646 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:32.498667 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m11:00:32.583176 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 11:00:31.160070 => 11:00:32.582180
[0m11:00:32.585175 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0C6D1F0>]}
[0m11:00:32.586171 [info ] [Thread-2  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m11:00:32.587697 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m11:00:32.587697 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m11:00:32.588695 [info ] [Thread-2  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m11:00:32.589699 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m11:00:32.590697 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m11:00:32.597834 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m11:00:32.599850 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 11:00:32.590697 => 11:00:32.599850
[0m11:00:32.601372 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m11:00:32.615204 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m11:00:32.616701 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:32.618728 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m11:00:33.510289 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:09e09ecb-6fa6-4305-ab89-e5f6a14e411a&page=queryresults
[0m11:00:33.736866 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:68c9a494-3380-45d3-8841-f8332d45adfe&page=queryresults
[0m11:00:34.090626 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 11:00:32.494089 => 11:00:34.089628
[0m11:00:34.092639 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0CCFD30>]}
[0m11:00:34.094162 [info ] [Thread-1  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.61s]
[0m11:00:34.095186 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m11:00:34.096202 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m11:00:34.096746 [info ] [Thread-1  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m11:00:34.098780 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m11:00:34.098780 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m11:00:34.104420 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m11:00:34.106462 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 11:00:34.099779 => 11:00:34.105930
[0m11:00:34.107492 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m11:00:34.113059 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m11:00:34.117318 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:34.126033 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m11:00:34.162959 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 11:00:32.602406 => 11:00:34.161953
[0m11:00:34.164475 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0C72520>]}
[0m11:00:34.165984 [info ] [Thread-2  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.57s]
[0m11:00:34.166995 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m11:00:34.166995 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m11:00:34.167991 [info ] [Thread-2  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m11:00:34.168992 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m11:00:34.168992 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m11:00:34.173965 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m11:00:34.175980 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 11:00:34.168992 => 11:00:34.174984
[0m11:00:34.175980 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m11:00:34.179323 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m11:00:34.180276 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:34.181275 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m11:00:34.882987 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b002cebf-6396-4fb9-8e60-d95a765d0baf&page=queryresults
[0m11:00:34.921026 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0bd4c107-c736-4088-a00f-5f71b30f99cd&page=queryresults
[0m11:00:35.310638 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 11:00:34.109032 => 11:00:35.308995
[0m11:00:35.316200 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0C7D7C0>]}
[0m11:00:35.318742 [info ] [Thread-1  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m11:00:35.321737 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m11:00:35.324300 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:35.328924 [info ] [Thread-1  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m11:00:35.334451 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m11:00:35.339013 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:35.372882 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m11:00:35.380016 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 11:00:35.343558 => 11:00:35.377015
[0m11:00:35.384537 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:35.429927 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m11:00:35.449026 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 11:00:34.175980 => 11:00:35.448017
[0m11:00:35.451025 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0DBED90>]}
[0m11:00:35.453543 [info ] [Thread-2  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m11:00:35.454554 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:35.457069 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m11:00:35.458076 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m11:00:35.459074 [info ] [Thread-2  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m11:00:35.460075 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m11:00:35.460075 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m11:00:35.468608 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m11:00:35.469605 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m11:00:35.501741 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 11:00:35.462077 => 11:00:35.500736
[0m11:00:35.501741 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m11:00:35.506266 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m11:00:35.506778 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:35.508780 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m11:00:36.225211 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d322febe-2d29-46c2-a859-6fc0af7e1a15&page=queryresults
[0m11:00:36.297927 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6c2aa313-2e70-4bfb-8475-99db6ba112e8&page=queryresults
[0m11:00:36.657812 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 11:00:35.387081 => 11:00:36.656791
[0m11:00:36.657812 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0CD1580>]}
[0m11:00:36.658811 [info ] [Thread-1  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m11:00:36.660812 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m11:00:36.661794 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m11:00:36.662816 [info ] [Thread-1  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m11:00:36.667936 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m11:00:36.669952 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m11:00:36.676041 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m11:00:36.678059 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 11:00:36.669952 => 11:00:36.678059
[0m11:00:36.679093 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m11:00:36.687746 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m11:00:36.690772 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:36.696375 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m11:00:36.741601 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 11:00:35.503254 => 11:00:36.741601
[0m11:00:36.742607 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0CF8550>]}
[0m11:00:36.742607 [info ] [Thread-2  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m11:00:36.746140 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m11:00:36.748561 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m11:00:36.750110 [info ] [Thread-2  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m11:00:36.751153 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m11:00:36.751153 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m11:00:36.755144 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m11:00:36.757477 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 11:00:36.751153 => 11:00:36.756137
[0m11:00:36.758465 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m11:00:36.760482 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m11:00:36.763489 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:36.766017 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m11:00:37.567864 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:963a3de3-0b84-4225-8d71-ef1f9023ccbe&page=queryresults
[0m11:00:37.577948 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7fd77056-5bd2-4623-9fff-0eca19a0ecb5&page=queryresults
[0m11:00:37.987036 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 11:00:36.680206 => 11:00:37.986483
[0m11:00:37.988049 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0DFC370>]}
[0m11:00:37.990135 [info ] [Thread-1  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m11:00:37.991053 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m11:00:37.992047 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m11:00:37.993049 [info ] [Thread-1  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m11:00:37.996181 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m11:00:37.997191 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m11:00:38.001199 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m11:00:38.009508 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 11:00:36.758465 => 11:00:38.008341
[0m11:00:38.012505 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0DF5FD0>]}
[0m11:00:38.017225 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 11:00:37.997191 => 11:00:38.016210
[0m11:00:38.014693 [info ] [Thread-2  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m11:00:38.019236 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m11:00:38.019236 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m11:00:38.022234 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m11:00:38.023232 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m11:00:38.024235 [info ] [Thread-2  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m11:00:38.025234 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.dm_produto)
[0m11:00:38.025234 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m11:00:38.028753 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m11:00:38.028753 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:38.030795 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m11:00:38.059650 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 11:00:38.025234 => 11:00:38.059650
[0m11:00:38.060754 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m11:00:38.068776 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:38.866665 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m11:00:38.868673 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m11:00:38.934167 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:57c723f6-ac46-48f7-b3e7-3f4a06e766ad&page=queryresults
[0m11:00:39.397874 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 11:00:38.020234 => 11:00:39.397874
[0m11:00:39.398854 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0DD9610>]}
[0m11:00:39.398854 [info ] [Thread-1  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m11:00:39.399878 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m11:00:39.645812 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:866fa6ca-38cf-41ca-8bba-830f33972033&page=queryresults
[0m11:00:42.181838 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 11:00:38.060754 => 11:00:42.181838
[0m11:00:42.182863 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0DFA610>]}
[0m11:00:42.184379 [info ] [Thread-2  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 4.16s]
[0m11:00:42.185886 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m11:00:42.185886 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m11:00:42.186896 [info ] [Thread-1  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m11:00:42.187895 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m11:00:42.187895 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m11:00:42.191895 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m11:00:42.194408 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 11:00:42.187895 => 11:00:42.192901
[0m11:00:42.194408 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m11:00:42.200982 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:42.814266 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m11:00:42.820800 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m11:00:43.546067 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dbd140ab-de0e-4ec8-aaed-bd2fd243814f&page=queryresults
[0m11:00:46.199085 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 11:00:42.194408 => 11:00:46.195994
[0m11:00:46.203828 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0E0C0D0>]}
[0m11:00:46.207122 [info ] [Thread-1  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 4.02s]
[0m11:00:46.210721 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m11:00:46.214260 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m11:00:46.217857 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m11:00:46.220861 [info ] [Thread-2  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m11:00:46.227999 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m11:00:46.221834 [info ] [Thread-1  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m11:00:46.231992 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m11:00:46.242715 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m11:00:46.249852 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m11:00:46.250826 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m11:00:46.269140 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m11:00:46.271122 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 11:00:46.244246 => 11:00:46.270130
[0m11:00:46.276793 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m11:00:46.280847 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:46.282847 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 11:00:46.254381 => 11:00:46.282847
[0m11:00:46.286965 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m11:00:46.298927 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:47.282571 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m11:00:47.287667 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m11:00:47.296800 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m11:00:47.304447 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m11:00:48.020754 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:815cf91c-cf5a-4186-ba99-df3d733531ac&page=queryresults
[0m11:00:48.027881 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d2176231-2f41-4953-9883-eeedbd164655&page=queryresults
[0m11:00:50.294285 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 11:00:46.278821 => 11:00:50.292765
[0m11:00:50.297871 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0E0CE80>]}
[0m11:00:50.300898 [info ] [Thread-2  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 4.07s]
[0m11:00:50.305935 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m11:00:50.308970 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m11:00:50.311966 [info ] [Thread-2  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m11:00:50.319132 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m11:00:50.321166 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m11:00:50.336715 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m11:00:50.348882 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 11:00:50.323154 => 11:00:50.341756
[0m11:00:50.359449 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m11:00:50.385276 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:51.132513 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 11:00:46.290945 => 11:00:51.132513
[0m11:00:51.134054 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0E33EB0>]}
[0m11:00:51.135082 [info ] [Thread-1  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 4.89s]
[0m11:00:51.136573 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m11:00:51.136573 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m11:00:51.137581 [info ] [Thread-1  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m11:00:51.139575 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m11:00:51.141574 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m11:00:51.154197 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m11:00:51.156214 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 11:00:51.142580 => 11:00:51.155216
[0m11:00:51.156734 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m11:00:51.165854 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:51.376105 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m11:00:51.379631 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m11:00:51.761539 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:30ba6cfb-110d-4e7c-a127-6881e754a8a4&page=queryresults
[0m11:00:52.090000 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m11:00:52.092013 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m11:00:52.778984 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2684d39f-4710-4018-bf40-b9dff10bff5f&page=queryresults
[0m11:00:54.011338 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 11:00:50.361451 => 11:00:54.009347
[0m11:00:54.018972 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0D83F70>]}
[0m11:00:54.021505 [info ] [Thread-2  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 3.70s]
[0m11:00:54.030960 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m11:00:54.039317 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m11:00:54.044579 [info ] [Thread-2  ]: 20 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m11:00:54.048142 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m11:00:54.050134 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m11:00:54.057278 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m11:00:54.062631 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 11:00:54.051133 => 11:00:54.061105
[0m11:00:54.065907 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m11:00:54.077042 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:54.783108 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m11:00:54.788342 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m11:00:55.169341 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ecb317e0-0cd4-460c-a4b9-22c5db8f5d0a&page=queryresults
[0m11:00:55.614292 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 11:00:51.157736 => 11:00:55.612766
[0m11:00:55.617812 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0C9F5B0>]}
[0m11:00:55.619833 [info ] [Thread-1  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.48s]
[0m11:00:55.621806 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m11:00:55.624358 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m11:00:55.626906 [info ] [Thread-1  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m11:00:55.629897 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m11:00:55.632706 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m11:00:55.650957 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m11:00:55.658244 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 11:00:55.634263 => 11:00:55.656034
[0m11:00:55.661273 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m11:00:55.696224 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:00:56.510135 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m11:00:56.516834 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m11:00:56.879947 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5b76cf3d-086d-4d81-a889-9c637cb3cd38&page=queryresults
[0m11:00:58.017878 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 11:00:54.066934 => 11:00:58.016877
[0m11:00:58.017878 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0C9EA60>]}
[0m11:00:58.018884 [info ] [Thread-2  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 3.97s]
[0m11:00:58.020013 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m11:00:58.020900 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m11:00:58.020900 [info ] [Thread-2  ]: 22 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m11:00:58.021888 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m11:00:58.022893 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m11:00:58.025979 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m11:00:58.026989 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 11:00:58.022893 => 11:00:58.026989
[0m11:00:58.028039 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m11:00:58.030053 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:00:58.692706 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m11:00:58.696272 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m11:00:59.253456 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5acf2b30-417f-43b1-b765-a982ee94b98b&page=queryresults
[0m11:00:59.457871 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 11:00:55.664388 => 11:00:59.457871
[0m11:00:59.458884 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0C9F3D0>]}
[0m11:00:59.459882 [info ] [Thread-1  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.4 KiB processed)[0m in 3.83s]
[0m11:00:59.461885 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m11:00:59.464451 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m11:00:59.464451 [info ] [Thread-1  ]: 23 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m11:00:59.466029 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m11:00:59.467038 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m11:00:59.472040 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m11:00:59.476052 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 11:00:59.467038 => 11:00:59.475048
[0m11:00:59.476052 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m11:00:59.479343 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:01:00.136870 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m11:01:00.142028 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m11:01:00.521869 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8cef46e5-e5d2-47c5-aacb-941f8b30bdce&page=queryresults
[0m11:01:02.647100 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 11:00:58.028039 => 11:01:02.646079
[0m11:01:02.649122 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0C9BBB0>]}
[0m11:01:02.656159 [info ] [Thread-2  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 4.63s]
[0m11:01:02.660581 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m11:01:02.664102 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m11:01:02.666221 [info ] [Thread-2  ]: 24 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m11:01:02.670646 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m11:01:02.672553 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m11:01:02.698831 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m11:01:02.702819 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 11:01:02.676626 => 11:01:02.702819
[0m11:01:02.705892 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m11:01:02.740651 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:01:02.815080 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 11:00:59.477384 => 11:01:02.815080
[0m11:01:02.816584 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0CA2C40>]}
[0m11:01:03.617601 [info ] [Thread-1  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.3 KiB processed)[0m in 3.35s]
[0m11:01:03.618596 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m11:01:03.619597 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m11:01:03.619597 [info ] [Thread-1  ]: 25 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m11:01:03.620601 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m11:01:03.621596 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m11:01:03.685080 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m11:01:03.695182 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m11:01:03.709480 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m11:01:03.710468 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 11:01:03.621596 => 11:01:03.710468
[0m11:01:03.710468 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m11:01:03.713468 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m11:01:04.392925 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ead04e91-c6b7-48ab-998d-3d1182aceb42&page=queryresults
[0m11:01:04.509822 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m11:01:04.515878 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m11:01:04.887352 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b96920fb-8d7c-477d-ac6a-5115fd17fb72&page=queryresults
[0m11:01:07.479727 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 11:01:02.706920 => 11:01:07.479727
[0m11:01:07.481712 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0D7DC10>]}
[0m11:01:07.484243 [info ] [Thread-2  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 4.81s]
[0m11:01:07.486809 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m11:01:08.268074 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 11:01:03.710468 => 11:01:08.267078
[0m11:01:08.269765 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0C7FA60>]}
[0m11:01:08.273292 [info ] [Thread-1  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 4.65s]
[0m11:01:08.277847 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m11:01:08.280878 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m11:01:08.285897 [info ] [Thread-2  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m11:01:08.289938 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m11:01:08.292935 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m11:01:08.309747 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m11:01:08.310749 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 11:01:08.294445 => 11:01:08.310749
[0m11:01:08.311747 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m11:01:08.322497 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m11:01:09.114188 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m11:01:09.120747 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m11:01:09.730022 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e9fd3e85-ff92-4160-96ab-eb9997a30839&page=queryresults
[0m11:01:13.439573 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 11:01:08.314267 => 11:01:13.439573
[0m11:01:13.442596 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3c271fad-ffb5-496e-ad44-344756546e86', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251F0DF5FD0>]}
[0m11:01:13.444611 [info ] [Thread-2  ]: 26 of 26 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 5.15s]
[0m11:01:13.448151 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m11:01:13.453179 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:01:13.456087 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:01:13.456087 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:01:13.457325 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m11:01:13.458350 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m11:01:13.459325 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m11:01:13.460331 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m11:01:13.463334 [info ] [MainThread]: 
[0m11:01:13.466925 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 47.87 seconds (47.87s).
[0m11:01:13.486608 [debug] [MainThread]: Command end result
[0m11:01:13.545996 [info ] [MainThread]: 
[0m11:01:13.548038 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:01:13.552601 [info ] [MainThread]: 
[0m11:01:13.556175 [info ] [MainThread]: Done. PASS=26 WARN=0 ERROR=0 SKIP=0 TOTAL=26
[0m11:01:13.564301 [debug] [MainThread]: Command `dbt run` succeeded at 11:01:13.561762 after 53.18 seconds
[0m11:01:13.567987 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251EC2833D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251EF882B20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000251EF9B1B80>]}
[0m11:01:13.568955 [debug] [MainThread]: Flushing usage events
[0m11:01:22.502902 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDF3942400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDF28B4940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDF28B4B80>]}


============================== 11:01:22.509524 | 68774e84-785e-422f-8e3e-ea9c306e6fc5 ==============================
[0m11:01:22.509524 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:01:22.510526 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:01:25.331497 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '68774e84-785e-422f-8e3e-ea9c306e6fc5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDF2899F70>]}
[0m11:01:25.928141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '68774e84-785e-422f-8e3e-ea9c306e6fc5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDF6EEB5E0>]}
[0m11:01:25.934648 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:01:25.999935 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:01:26.258285 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:01:26.259285 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:01:26.277971 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '68774e84-785e-422f-8e3e-ea9c306e6fc5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDF72B54F0>]}
[0m11:01:26.347925 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '68774e84-785e-422f-8e3e-ea9c306e6fc5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDF7293EE0>]}
[0m11:01:26.353446 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:01:26.359139 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '68774e84-785e-422f-8e3e-ea9c306e6fc5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDF7293E50>]}
[0m11:01:26.368658 [info ] [MainThread]: 
[0m11:01:26.370667 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:01:26.380813 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:01:26.386537 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:01:27.248057 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m11:01:27.250057 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:01:27.256053 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m11:01:27.265643 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:01:28.376993 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_az)
[0m11:01:28.387064 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:01:28.469897 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m11:01:28.472870 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:01:29.116989 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '68774e84-785e-422f-8e3e-ea9c306e6fc5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDF72EBFA0>]}
[0m11:01:29.117991 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:01:29.118987 [info ] [MainThread]: 
[0m11:01:29.126011 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:01:29.128025 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m11:01:29.129918 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m11:01:29.133456 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:01:29.153065 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 11:01:29.133456 => 11:01:29.151068
[0m11:01:29.155079 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:01:29.240781 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:01:29.242746 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m11:01:30.179750 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ea3ba4ac-446d-4205-9f84-92fe2fe5027c&page=queryresults
[0m11:01:31.492610 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m11:01:31.902797 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e129197a-2957-40b2-b46c-ff8375587ad8&page=queryresults
[0m11:01:34.699058 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m11:01:35.512018 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m11:01:35.518158 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m11:01:35.930626 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4455c226-c385-4fa7-9d63-5734bc84ee7d&page=queryresults
[0m11:01:37.873037 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 11:01:29.156082 => 11:01:37.872021
[0m11:01:37.875025 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68774e84-785e-422f-8e3e-ea9c306e6fc5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDF835E4F0>]}
[0m11:01:37.876545 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 96.0 KiB processed)[0m in 8.75s]
[0m11:01:37.877548 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m11:01:37.879547 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:01:37.880565 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:01:37.881548 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m11:01:37.881548 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m11:01:37.881548 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m11:01:37.882560 [info ] [MainThread]: 
[0m11:01:37.882560 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 11.51 seconds (11.51s).
[0m11:01:37.884104 [debug] [MainThread]: Command end result
[0m11:01:37.898426 [info ] [MainThread]: 
[0m11:01:37.899422 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:01:37.900421 [info ] [MainThread]: 
[0m11:01:37.901440 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m11:01:37.902422 [debug] [MainThread]: Command `dbt snapshot` succeeded at 11:01:37.902422 after 15.50 seconds
[0m11:01:37.903424 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDF3942400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDF6F2AC10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BDF6FDCE20>]}
[0m11:01:37.903424 [debug] [MainThread]: Flushing usage events
[0m11:01:41.354129 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208D277B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208D16FD9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208D16FDD30>]}


============================== 11:01:41.366169 | 2e762a82-b9eb-42db-92b7-266f56969cf8 ==============================
[0m11:01:41.366169 [info ] [MainThread]: Running with dbt=1.7.4
[0m11:01:41.368221 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt run --select tag:snaps', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m11:01:43.684328 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2e762a82-b9eb-42db-92b7-266f56969cf8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208D16FDD90>]}
[0m11:01:43.759449 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2e762a82-b9eb-42db-92b7-266f56969cf8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208D5D15D30>]}
[0m11:01:43.761386 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m11:01:43.773053 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m11:01:43.930601 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:01:43.931450 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:01:43.940840 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2e762a82-b9eb-42db-92b7-266f56969cf8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208D60E5F10>]}
[0m11:01:43.973393 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2e762a82-b9eb-42db-92b7-266f56969cf8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208D5FFC970>]}
[0m11:01:43.974403 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m11:01:43.976952 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2e762a82-b9eb-42db-92b7-266f56969cf8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208D5FFCC40>]}
[0m11:01:43.982953 [info ] [MainThread]: 
[0m11:01:43.986046 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m11:01:43.989122 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m11:01:43.990076 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:01:44.694211 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m11:01:44.695335 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:01:44.700926 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m11:01:44.706164 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:01:45.421044 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m11:01:45.430362 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:01:45.501079 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m11:01:45.508828 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:01:46.366059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2e762a82-b9eb-42db-92b7-266f56969cf8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208D5E2D640>]}
[0m11:01:46.368105 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m11:01:46.370143 [info ] [MainThread]: 
[0m11:01:46.380549 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:01:46.384101 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m11:01:46.387662 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m11:01:46.389637 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:01:46.417285 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m11:01:46.418298 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 11:01:46.390644 => 11:01:46.418298
[0m11:01:46.419313 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:01:46.439953 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m11:01:47.365182 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m11:01:47.366707 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m11:01:47.747109 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e22b0efe-3e4b-439d-a908-d70fe91bbd5d&page=queryresults
[0m11:01:50.074451 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 11:01:46.419313 => 11:01:50.074451
[0m11:01:50.076261 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2e762a82-b9eb-42db-92b7-266f56969cf8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208D7160790>]}
[0m11:01:50.078295 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (443.0 rows, 81.5 KiB processed)[0m in 3.69s]
[0m11:01:50.080335 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m11:01:50.082314 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m11:01:50.084355 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m11:01:50.086819 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m11:01:50.087835 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m11:01:50.106406 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m11:01:50.108863 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 11:01:50.089880 => 11:01:50.108863
[0m11:01:50.109862 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m11:01:50.112871 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m11:01:50.899059 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m11:01:50.901086 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m11:01:51.278417 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:595dc4d4-f379-481f-a781-d844f283902c&page=queryresults
[0m11:01:54.641098 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 11:01:50.110894 => 11:01:54.637411
[0m11:01:54.645092 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2e762a82-b9eb-42db-92b7-266f56969cf8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208D7160520>]}
[0m11:01:54.648578 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (355.0 rows, 107.7 KiB processed)[0m in 4.56s]
[0m11:01:54.649589 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m11:01:54.655132 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:01:54.656124 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m11:01:54.657259 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m11:01:54.659270 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m11:01:54.660277 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m11:01:54.662269 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m11:01:54.664269 [info ] [MainThread]: 
[0m11:01:54.668828 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 10.68 seconds (10.68s).
[0m11:01:54.673112 [debug] [MainThread]: Command end result
[0m11:01:54.722970 [info ] [MainThread]: 
[0m11:01:54.724599 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:01:54.726247 [info ] [MainThread]: 
[0m11:01:54.727259 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m11:01:54.729263 [debug] [MainThread]: Command `dbt run` succeeded at 11:01:54.728382 after 13.47 seconds
[0m11:01:54.730742 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208D277B460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208D04076D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000208D5EBF790>]}
[0m11:01:54.732262 [debug] [MainThread]: Flushing usage events
[0m12:00:05.621556 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992ABC2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019929B4F9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019929B4FD30>]}


============================== 12:00:05.632630 | 69efcc24-1ceb-45bd-99a8-5739b2de546e ==============================
[0m12:00:05.632630 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:00:05.633637 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m12:00:06.420101 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000019929B3D1F0>]}
[0m12:00:06.478661 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992E232B20>]}
[0m12:00:06.480251 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:00:06.487359 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:00:06.581368 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:00:06.581368 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_preco_produto_base.sql
[0m12:00:06.685846 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992E6E2CA0>]}
[0m12:00:06.707946 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992E43CA00>]}
[0m12:00:06.708948 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:00:06.710401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992E14F610>]}
[0m12:00:06.713547 [info ] [MainThread]: 
[0m12:00:06.714544 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:00:06.717277 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:06.717277 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:06.767995 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:06.769015 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:07.713998 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:08.455989 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m12:00:08.457996 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:08.458996 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m12:00:08.460999 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:09.224372 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m12:00:09.225375 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:09.272695 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m12:00:09.274697 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:00:10.001341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992E27A7F0>]}
[0m12:00:10.003346 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:00:10.004343 [info ] [MainThread]: 
[0m12:00:10.013351 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:10.014347 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m12:00:10.015348 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m12:00:10.018709 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m12:00:10.020752 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:10.016344 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m12:00:10.034623 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m12:00:10.040563 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m12:00:10.042562 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m12:00:10.052559 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 12:00:10.021761 => 12:00:10.051560
[0m12:00:10.054603 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:10.069032 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m12:00:10.098622 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m12:00:10.099620 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 12:00:10.043560 => 12:00:10.098622
[0m12:00:10.099620 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m12:00:10.106028 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m12:00:10.107979 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:00:10.110009 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m12:00:10.110009 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m12:00:10.141253 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m12:00:11.347884 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:391fa19c-9e6d-4513-b4d5-571d2e534992&page=queryresults
[0m12:00:11.349854 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6e9249e1-1b2a-4cfe-88e8-debde610858f&page=queryresults
[0m12:00:11.820951 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 12:00:10.100622 => 12:00:11.819555
[0m12:00:11.826957 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 12:00:10.056598 => 12:00:11.825961
[0m12:00:11.827955 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F7BF940>]}
[0m12:00:11.828958 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F7ACBB0>]}
[0m12:00:11.832194 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.79s]
[0m12:00:11.835194 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m12:00:11.837066 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m12:00:11.833167 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.81s]
[0m12:00:11.840683 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m12:00:11.839219 [info ] [Thread-2  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m12:00:11.842813 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_compra
[0m12:00:11.845804 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m12:00:11.847807 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m12:00:11.853331 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m12:00:11.846808 [info ] [Thread-1  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m12:00:11.855319 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_compra)
[0m12:00:11.856324 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_compra
[0m12:00:11.864751 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m12:00:11.866748 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 12:00:11.848804 => 12:00:11.865750
[0m12:00:11.867790 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m12:00:11.876251 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m12:00:11.878212 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (compile): 12:00:11.857326 => 12:00:11.877259
[0m12:00:11.879258 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_compra
[0m12:00:11.886675 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m12:00:11.889623 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:11.897165 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:11.903577 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m12:00:11.936283 [debug] [Thread-1  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m12:00:12.729662 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4ac39b62-cadd-451b-a9e1-0d4cd4c499bc&page=queryresults
[0m12:00:12.749188 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0f2a3771-3956-433b-9692-8ce464980ec3&page=queryresults
[0m12:00:13.125620 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (execute): 12:00:11.880258 => 12:00:13.125620
[0m12:00:13.126618 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F727C10>]}
[0m12:00:13.127611 [info ] [Thread-1  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m12:00:13.128615 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_compra
[0m12:00:13.130031 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m12:00:13.131154 [info ] [Thread-1  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m12:00:13.132783 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_forma_pagamento)
[0m12:00:13.133929 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m12:00:13.146100 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m12:00:13.149170 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 12:00:13.134931 => 12:00:13.148175
[0m12:00:13.149170 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m12:00:13.153164 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m12:00:13.154163 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:13.156163 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m12:00:13.207166 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 12:00:11.868792 => 12:00:13.207166
[0m12:00:13.208164 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F82EA00>]}
[0m12:00:13.209165 [info ] [Thread-2  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m12:00:13.210163 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m12:00:13.211166 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m12:00:13.212168 [info ] [Thread-2  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m12:00:13.213167 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m12:00:13.213167 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m12:00:13.217168 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m12:00:13.218174 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 12:00:13.213167 => 12:00:13.218174
[0m12:00:13.219178 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m12:00:13.222179 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m12:00:13.223177 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:13.225172 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m12:00:13.973505 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:694b64b9-d049-4609-b18c-96bee12ad92d&page=queryresults
[0m12:00:14.038544 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:238b8759-5747-4beb-81a1-434bf6034ccc&page=queryresults
[0m12:00:14.447900 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 12:00:13.150169 => 12:00:14.446897
[0m12:00:14.448902 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F7F9F10>]}
[0m12:00:14.449903 [info ] [Thread-1  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m12:00:14.451898 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m12:00:14.452901 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m12:00:14.453902 [info ] [Thread-1  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m12:00:14.455903 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m12:00:14.456899 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m12:00:14.463240 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m12:00:14.466199 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 12:00:14.457897 => 12:00:14.465243
[0m12:00:14.467230 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m12:00:14.479611 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m12:00:14.480773 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:14.483737 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m12:00:14.514396 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 12:00:13.219178 => 12:00:14.514396
[0m12:00:14.515397 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F7EA3D0>]}
[0m12:00:14.515397 [info ] [Thread-2  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m12:00:14.516403 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m12:00:14.517397 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m12:00:14.517397 [info ] [Thread-2  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m12:00:14.518441 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m12:00:14.518441 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m12:00:14.522665 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m12:00:14.524687 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 12:00:14.519410 => 12:00:14.524687
[0m12:00:14.524687 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m12:00:14.528662 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m12:00:14.531196 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:14.534179 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m12:00:15.276388 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3d4074b5-3207-428b-8261-e01b26beec4a&page=queryresults
[0m12:00:15.286271 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:32c207f1-017d-4cfb-a8bb-c91107435879&page=queryresults
[0m12:00:15.749653 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 12:00:14.468240 => 12:00:15.748661
[0m12:00:15.751550 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F734310>]}
[0m12:00:15.753617 [info ] [Thread-1  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m12:00:15.759651 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 12:00:14.525670 => 12:00:15.759651
[0m12:00:15.760985 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m12:00:15.763088 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F7345E0>]}
[0m12:00:15.764086 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:15.766044 [info ] [Thread-2  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m12:00:15.769084 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m12:00:15.767080 [info ] [Thread-1  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m12:00:15.770500 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m12:00:15.771503 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m12:00:15.773605 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:15.772604 [info ] [Thread-2  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m12:00:15.779868 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m12:00:15.780869 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m12:00:15.781874 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m12:00:15.786871 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m12:00:15.788882 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 12:00:15.774508 => 12:00:15.787871
[0m12:00:15.790409 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:15.796568 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m12:00:15.797562 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 12:00:15.781874 => 12:00:15.796568
[0m12:00:15.798563 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m12:00:15.801772 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m12:00:15.802772 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:15.804766 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m12:00:15.824286 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:15.826297 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m12:00:16.694654 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b1131698-6ca0-4a14-bdd0-89b6a9a82224&page=queryresults
[0m12:00:16.696641 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c7648069-3e97-42e3-81c4-3074c5ca6827&page=queryresults
[0m12:00:17.191451 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 12:00:15.798563 => 12:00:17.190170
[0m12:00:17.195444 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F8A5970>]}
[0m12:00:17.198580 [info ] [Thread-2  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.41s]
[0m12:00:17.202211 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m12:00:17.203120 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m12:00:17.206254 [info ] [Thread-2  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m12:00:17.210158 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto)
[0m12:00:17.211620 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m12:00:17.230679 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m12:00:17.238596 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 12:00:15.791574 => 12:00:17.236640
[0m12:00:17.241602 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F869B20>]}
[0m12:00:17.243599 [info ] [Thread-1  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m12:00:17.245885 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m12:00:17.247930 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m12:00:17.249029 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 12:00:17.215657 => 12:00:17.247930
[0m12:00:17.250944 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m12:00:17.257018 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m12:00:17.250023 [info ] [Thread-1  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m12:00:17.259014 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto_fabricado)
[0m12:00:17.259014 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m12:00:17.262978 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m12:00:17.263969 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:17.264989 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m12:00:17.286203 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 12:00:17.259922 => 12:00:17.285247
[0m12:00:17.286203 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m12:00:17.288208 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m12:00:17.290253 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:17.292697 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m12:00:18.075388 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:19b6af38-19aa-44a9-8a65-58b49ba7eeb8&page=queryresults
[0m12:00:18.164384 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:57105807-fdfe-4c29-9a56-c01a2b3c68a8&page=queryresults
[0m12:00:18.510268 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 12:00:17.250944 => 12:00:18.510268
[0m12:00:18.512616 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F7B5820>]}
[0m12:00:18.513609 [info ] [Thread-2  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m12:00:18.515608 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m12:00:18.516610 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m12:00:18.518614 [info ] [Thread-2  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m12:00:18.520929 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m12:00:18.520929 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m12:00:18.526929 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m12:00:18.528929 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 12:00:18.521929 => 12:00:18.527929
[0m12:00:18.528929 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m12:00:18.534634 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m12:00:18.535746 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:18.538743 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m12:00:18.596186 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 12:00:17.286203 => 12:00:18.596186
[0m12:00:18.598205 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F884370>]}
[0m12:00:18.599206 [info ] [Thread-1  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m12:00:18.600506 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m12:00:18.601589 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m12:00:18.602597 [info ] [Thread-1  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m12:00:18.603594 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.dm_produto)
[0m12:00:18.604604 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m12:00:18.617971 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m12:00:18.618973 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 12:00:18.604604 => 12:00:18.618973
[0m12:00:18.619920 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m12:00:18.639276 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:19.296373 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9adee57a-1bd5-4fa4-9947-e857c9503e3d&page=queryresults
[0m12:00:19.365666 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m12:00:19.368667 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m12:00:19.696525 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 12:00:18.530023 => 12:00:19.695526
[0m12:00:19.697525 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F89B4F0>]}
[0m12:00:19.698525 [info ] [Thread-2  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m12:00:19.700799 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m12:00:20.051314 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1dc23dd1-e1cf-487c-8999-d453361a0e29&page=queryresults
[0m12:00:22.664967 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 12:00:18.619920 => 12:00:22.664967
[0m12:00:22.665966 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F73C640>]}
[0m12:00:22.665966 [info ] [Thread-1  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 4.06s]
[0m12:00:22.666960 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m12:00:22.667937 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m12:00:22.668926 [info ] [Thread-2  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m12:00:22.671372 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m12:00:22.671928 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m12:00:22.681489 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m12:00:22.684425 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 12:00:22.673030 => 12:00:22.683488
[0m12:00:22.685486 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m12:00:22.690480 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:23.586953 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m12:00:23.589904 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m12:00:24.226688 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6730e937-0b03-4bcd-8acb-f69202497d3c&page=queryresults
[0m12:00:26.732541 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 12:00:22.685486 => 12:00:26.732541
[0m12:00:26.734541 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F73CAF0>]}
[0m12:00:26.735539 [info ] [Thread-2  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 4.06s]
[0m12:00:26.736543 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m12:00:26.738547 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m12:00:26.740068 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_compra
[0m12:00:26.741769 [info ] [Thread-1  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m12:00:26.744792 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m12:00:26.745788 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m12:00:26.751365 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m12:00:26.742795 [info ] [Thread-2  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m12:00:26.753365 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m12:00:26.754365 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_compra
[0m12:00:26.763361 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m12:00:26.766366 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (compile): 12:00:26.754365 => 12:00:26.765362
[0m12:00:26.766366 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_compra
[0m12:00:26.767396 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 12:00:26.745788 => 12:00:26.766366
[0m12:00:26.819442 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m12:00:26.823714 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:26.825716 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:27.583121 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m12:00:27.587098 [debug] [Thread-2  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m12:00:27.627506 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m12:00:27.630730 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m12:00:28.226385 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8bc10a28-ad36-4689-a283-c89a36a15c6f&page=queryresults
[0m12:00:28.312965 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d07c5598-4c6b-48c1-8867-577c9a33daed&page=queryresults
[0m12:00:30.567243 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 12:00:26.824751 => 12:00:30.566235
[0m12:00:30.568240 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F8BD2E0>]}
[0m12:00:30.570239 [info ] [Thread-1  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 3.82s]
[0m12:00:30.572539 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m12:00:30.573545 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m12:00:30.574546 [info ] [Thread-1  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m12:00:30.576542 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m12:00:30.578545 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m12:00:30.585248 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m12:00:30.588280 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 12:00:30.578545 => 12:00:30.587362
[0m12:00:30.590364 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m12:00:30.595830 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:30.808013 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (execute): 12:00:26.768386 => 12:00:30.808013
[0m12:00:30.810023 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992E2AED60>]}
[0m12:00:30.811022 [info ] [Thread-2  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 4.06s]
[0m12:00:30.813025 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_compra
[0m12:00:30.814034 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m12:00:30.815016 [info ] [Thread-2  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m12:00:30.817026 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m12:00:30.818023 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m12:00:30.828722 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m12:00:30.831319 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 12:00:30.819018 => 12:00:30.831319
[0m12:00:30.833413 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m12:00:30.839415 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:31.366247 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m12:00:31.368216 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m12:00:31.557443 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m12:00:31.560788 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m12:00:31.773801 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1745a9bf-4716-4bb1-86e3-4196964d3683&page=queryresults
[0m12:00:32.233470 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e1d6045d-9334-40b3-b066-140abbe93d46&page=queryresults
[0m12:00:33.758207 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 12:00:30.590725 => 12:00:33.757202
[0m12:00:33.759203 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992E5B1910>]}
[0m12:00:33.760623 [info ] [Thread-1  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 3.18s]
[0m12:00:33.762717 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m12:00:33.764705 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m12:00:33.765704 [info ] [Thread-1  ]: 20 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m12:00:33.767708 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m12:00:33.768711 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m12:00:33.777208 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m12:00:33.780210 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 12:00:33.768711 => 12:00:33.779208
[0m12:00:33.780622 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m12:00:33.785704 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:34.464713 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m12:00:34.465717 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m12:00:34.860709 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 12:00:30.834377 => 12:00:34.860709
[0m12:00:34.863765 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F8BD3A0>]}
[0m12:00:34.864711 [info ] [Thread-2  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.05s]
[0m12:00:34.867710 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m12:00:34.870060 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m12:00:34.872147 [info ] [Thread-2  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m12:00:34.874179 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m12:00:34.875185 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m12:00:34.880522 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m12:00:34.882653 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 12:00:34.875185 => 12:00:34.882653
[0m12:00:34.883573 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m12:00:34.887647 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:34.960585 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:59014d87-8eb7-4bfd-b72f-bd994f8cdd7e&page=queryresults
[0m12:00:35.813350 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m12:00:35.816350 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m12:00:36.165389 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:86e40eb6-1a38-44fd-8ca7-f59559bd6559&page=queryresults
[0m12:00:37.196384 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 12:00:33.781713 => 12:00:37.195391
[0m12:00:37.198383 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F73C490>]}
[0m12:00:37.199385 [info ] [Thread-1  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 3.43s]
[0m12:00:37.201839 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m12:00:37.204892 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m12:00:37.205918 [info ] [Thread-1  ]: 22 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m12:00:37.208968 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m12:00:37.210760 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m12:00:37.222441 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m12:00:37.227205 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 12:00:37.211866 => 12:00:37.226260
[0m12:00:37.228253 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m12:00:37.243556 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:37.957491 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m12:00:37.960565 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m12:00:38.664774 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fb4a57ca-80ad-4200-b04a-3b1fa5e9a5d7&page=queryresults
[0m12:00:38.697888 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 12:00:34.883573 => 12:00:38.696884
[0m12:00:38.699891 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F761AC0>]}
[0m12:00:38.701194 [info ] [Thread-2  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.4 KiB processed)[0m in 3.83s]
[0m12:00:38.703246 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m12:00:38.705243 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m12:00:38.706324 [info ] [Thread-2  ]: 23 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m12:00:38.709241 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m12:00:38.710672 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m12:00:38.719956 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m12:00:38.723433 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 12:00:38.711760 => 12:00:38.722432
[0m12:00:38.724514 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m12:00:38.730478 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:39.436917 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m12:00:39.439830 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m12:00:39.834796 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:606c8d1d-29fd-4f01-b7b8-fb405c63b995&page=queryresults
[0m12:00:42.375381 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 12:00:38.725513 => 12:00:42.375381
[0m12:00:42.377376 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992F89E190>]}
[0m12:00:42.379372 [info ] [Thread-2  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.3 KiB processed)[0m in 3.67s]
[0m12:00:42.380380 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m12:00:42.383743 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m12:00:42.384744 [info ] [Thread-2  ]: 24 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m12:00:42.386748 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m12:00:42.387743 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m12:00:42.399386 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m12:00:42.403358 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 12:00:42.388743 => 12:00:42.402372
[0m12:00:42.405407 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m12:00:42.409383 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:42.709065 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 12:00:37.229250 => 12:00:42.708063
[0m12:00:42.711714 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992E574F40>]}
[0m12:00:43.117754 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m12:00:43.121273 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m12:00:43.430367 [info ] [Thread-1  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 5.50s]
[0m12:00:43.432362 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m12:00:43.432362 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m12:00:43.432362 [info ] [Thread-1  ]: 25 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m12:00:43.433367 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m12:00:43.434470 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m12:00:43.438472 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m12:00:43.439365 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 12:00:43.434470 => 12:00:43.439365
[0m12:00:43.440459 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m12:00:43.454894 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m12:00:43.578801 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5602bb17-735c-4392-a3c6-29ff69261934&page=queryresults
[0m12:00:44.128636 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m12:00:44.132398 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m12:00:44.837465 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:122ae00c-5306-4ed5-bc6e-be3746c65f54&page=queryresults
[0m12:00:47.624501 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 12:00:42.405407 => 12:00:47.623494
[0m12:00:47.626509 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992E53AFA0>]}
[0m12:00:47.627505 [info ] [Thread-2  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 5.24s]
[0m12:00:47.630409 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m12:00:47.631831 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m12:00:47.633831 [info ] [Thread-2  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m12:00:47.635839 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m12:00:47.636833 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m12:00:47.647408 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:00:47.650370 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 12:00:47.636833 => 12:00:47.649409
[0m12:00:47.651430 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m12:00:47.656413 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m12:00:48.324994 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:00:48.327901 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m12:00:48.945280 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c2b15722-2766-4ea2-8bc5-3c9d683a2dcb&page=queryresults
[0m12:00:49.198940 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 12:00:43.440459 => 12:00:49.197931
[0m12:00:49.200435 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992E5B1910>]}
[0m12:00:49.202523 [info ] [Thread-1  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 5.77s]
[0m12:00:49.203519 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m12:00:53.035724 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 12:00:47.652417 => 12:00:53.034726
[0m12:00:53.035724 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '69efcc24-1ceb-45bd-99a8-5739b2de546e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992E5FD1F0>]}
[0m12:00:53.036726 [info ] [Thread-2  ]: 26 of 26 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 5.40s]
[0m12:00:53.037725 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m12:00:53.039724 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:00:53.040257 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:00:53.040257 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:00:53.040257 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m12:00:53.040257 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m12:00:53.041264 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto_base' was properly closed.
[0m12:00:53.041264 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m12:00:53.041264 [info ] [MainThread]: 
[0m12:00:53.042261 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 46.33 seconds (46.33s).
[0m12:00:53.045261 [debug] [MainThread]: Command end result
[0m12:00:53.055542 [info ] [MainThread]: 
[0m12:00:53.056542 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:00:53.057537 [info ] [MainThread]: 
[0m12:00:53.058552 [info ] [MainThread]: Done. PASS=26 WARN=0 ERROR=0 SKIP=0 TOTAL=26
[0m12:00:53.059570 [debug] [MainThread]: Command `dbt run` succeeded at 12:00:53.059570 after 47.53 seconds
[0m12:00:53.060779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992ABC2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992E27A850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001992E14F610>]}
[0m12:00:53.060779 [debug] [MainThread]: Flushing usage events
[0m12:00:57.438837 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E664D3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E6545B670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E6545BAC0>]}


============================== 12:00:57.444388 | 849410ac-f5ae-4fea-95ea-7df021783787 ==============================
[0m12:00:57.444388 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:00:57.445370 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'warn_error': 'None', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m12:00:58.299709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '849410ac-f5ae-4fea-95ea-7df021783787', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E6861AA60>]}
[0m12:00:58.376659 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '849410ac-f5ae-4fea-95ea-7df021783787', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E69B40520>]}
[0m12:00:58.378660 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:00:58.387033 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:00:58.613358 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:00:58.614356 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:00:58.626802 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '849410ac-f5ae-4fea-95ea-7df021783787', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E69E34EB0>]}
[0m12:00:58.659690 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '849410ac-f5ae-4fea-95ea-7df021783787', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E69D4B850>]}
[0m12:00:58.660217 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:00:58.661510 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '849410ac-f5ae-4fea-95ea-7df021783787', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E69D4BAC0>]}
[0m12:00:58.664516 [info ] [MainThread]: 
[0m12:00:58.666516 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:00:58.669540 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:00:58.670537 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:59.658870 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m12:00:59.659773 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:00:59.660776 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m12:00:59.661772 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:01:00.434042 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m12:01:00.435049 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:01:00.478612 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m12:01:00.478612 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:01:01.156375 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '849410ac-f5ae-4fea-95ea-7df021783787', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E69E34FA0>]}
[0m12:01:01.158358 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:01:01.160361 [info ] [MainThread]: 
[0m12:01:01.170545 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m12:01:01.172618 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m12:01:01.175662 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m12:01:01.177669 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m12:01:01.194454 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 12:01:01.178662 => 12:01:01.194454
[0m12:01:01.195464 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m12:01:01.274482 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:01:01.276486 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m12:01:02.214956 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:683ab9cb-3be0-4cbb-8707-b4af9e5abd6d&page=queryresults
[0m12:01:03.334776 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m12:01:03.814864 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fef87ca4-f04d-4a92-bcd3-fcef7eca1cec&page=queryresults
[0m12:01:06.828473 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m12:01:07.591445 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m12:01:07.594459 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m12:01:07.995436 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:152ccddc-1948-4bd3-bda3-70142eab8a20&page=queryresults
[0m12:01:10.601601 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 12:01:01.196462 => 12:01:10.600562
[0m12:01:10.602563 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '849410ac-f5ae-4fea-95ea-7df021783787', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E6AEA6FA0>]}
[0m12:01:10.603561 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (94.0 rows, 117.4 KiB processed)[0m in 9.43s]
[0m12:01:10.604561 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m12:01:10.607683 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:01:10.608686 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:01:10.608686 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m12:01:10.609700 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m12:01:10.610129 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m12:01:10.611256 [info ] [MainThread]: 
[0m12:01:10.611853 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 11.94 seconds (11.94s).
[0m12:01:10.613999 [debug] [MainThread]: Command end result
[0m12:01:10.640979 [info ] [MainThread]: 
[0m12:01:10.641872 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:01:10.642968 [info ] [MainThread]: 
[0m12:01:10.642968 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m12:01:10.644962 [debug] [MainThread]: Command `dbt snapshot` succeeded at 12:01:10.643962 after 13.28 seconds
[0m12:01:10.644962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E664D3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E69C0A2B0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025E69AD6130>]}
[0m12:01:10.645955 [debug] [MainThread]: Flushing usage events
[0m12:01:15.178831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002542A823400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254297A1640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254297A1AC0>]}


============================== 12:01:15.186267 | 0d1f9177-65a9-4f3b-b058-297c557e4b25 ==============================
[0m12:01:15.186267 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:01:15.188262 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'invocation_command': 'dbt run --select tag:snaps', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:01:16.164157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0d1f9177-65a9-4f3b-b058-297c557e4b25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002542978F910>]}
[0m12:01:16.289841 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0d1f9177-65a9-4f3b-b058-297c557e4b25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002542DD72280>]}
[0m12:01:16.291043 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:01:16.299069 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:01:16.360032 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m12:01:16.360032 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m12:01:16.365350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0d1f9177-65a9-4f3b-b058-297c557e4b25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002542E185EE0>]}
[0m12:01:16.378086 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0d1f9177-65a9-4f3b-b058-297c557e4b25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002542E098A90>]}
[0m12:01:16.378086 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:01:16.379199 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0d1f9177-65a9-4f3b-b058-297c557e4b25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002542E098B80>]}
[0m12:01:16.380161 [info ] [MainThread]: 
[0m12:01:16.381540 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:01:16.382546 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:01:16.383423 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:01:17.248347 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m12:01:17.249808 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:01:17.252283 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m12:01:17.253276 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:01:18.017276 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m12:01:18.021881 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:01:18.064809 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m12:01:18.066806 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:01:18.698531 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0d1f9177-65a9-4f3b-b058-297c557e4b25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002542E193CA0>]}
[0m12:01:18.701017 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:01:18.702018 [info ] [MainThread]: 
[0m12:01:18.709096 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m12:01:18.710097 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m12:01:18.712349 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m12:01:18.713362 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m12:01:18.732350 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m12:01:18.734268 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 12:01:18.713362 => 12:01:18.733312
[0m12:01:18.735185 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m12:01:18.767444 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:01:19.460407 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m12:01:19.462433 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m12:01:19.837100 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:202721dc-165f-4b48-88cf-07120ccae538&page=queryresults
[0m12:01:22.371435 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 12:01:18.736190 => 12:01:22.371435
[0m12:01:22.372433 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d1f9177-65a9-4f3b-b058-297c557e4b25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002542F2007C0>]}
[0m12:01:22.373430 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (493.0 rows, 90.5 KiB processed)[0m in 3.66s]
[0m12:01:22.375306 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m12:01:22.377302 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m12:01:22.378302 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m12:01:22.380349 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m12:01:22.380349 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m12:01:22.388303 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m12:01:22.390648 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 12:01:22.381300 => 12:01:22.389303
[0m12:01:22.390648 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m12:01:22.394774 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m12:01:23.254967 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m12:01:23.257978 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m12:01:23.650494 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:04ae9c3b-0b17-4791-bbc9-575ea4165f6e&page=queryresults
[0m12:01:27.052085 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 12:01:22.391780 => 12:01:27.052085
[0m12:01:27.053420 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0d1f9177-65a9-4f3b-b058-297c557e4b25', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002542F2002E0>]}
[0m12:01:27.054423 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (356.0 rows, 110.4 KiB processed)[0m in 4.67s]
[0m12:01:27.056320 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m12:01:27.059318 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:01:27.060876 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:01:27.060876 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m12:01:27.061892 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m12:01:27.061892 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m12:01:27.061892 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m12:01:27.062999 [info ] [MainThread]: 
[0m12:01:27.063893 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 10.68 seconds (10.68s).
[0m12:01:27.066001 [debug] [MainThread]: Command end result
[0m12:01:27.096450 [info ] [MainThread]: 
[0m12:01:27.097449 [info ] [MainThread]: [32mCompleted successfully[0m
[0m12:01:27.098550 [info ] [MainThread]: 
[0m12:01:27.099456 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m12:01:27.102418 [debug] [MainThread]: Command `dbt run` succeeded at 12:01:27.101907 after 12.01 seconds
[0m12:01:27.102928 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002542A823400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002542DF0D460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002542DF59AF0>]}
[0m12:01:27.103945 [debug] [MainThread]: Flushing usage events
[0m12:37:57.301875 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237E76AA3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237E6638310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237E6638790>]}


============================== 12:37:57.312050 | cbeb0afe-f228-4c47-af35-0d353cccd46a ==============================
[0m12:37:57.312050 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:37:57.312050 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --models tb_estoque_produto_base', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m12:37:57.780974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cbeb0afe-f228-4c47-af35-0d353cccd46a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237E97FDBE0>]}
[0m12:37:57.841758 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cbeb0afe-f228-4c47-af35-0d353cccd46a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237EAD157C0>]}
[0m12:37:57.841758 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:37:57.855540 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:37:57.934234 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:37:57.935234 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_estoque_produto_base.sql
[0m12:37:58.035395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cbeb0afe-f228-4c47-af35-0d353cccd46a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237EB1CEC10>]}
[0m12:37:58.047441 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cbeb0afe-f228-4c47-af35-0d353cccd46a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237EAF2EAF0>]}
[0m12:37:58.049449 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:37:58.049449 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cbeb0afe-f228-4c47-af35-0d353cccd46a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237EAF2EB20>]}
[0m12:37:58.050991 [info ] [MainThread]: 
[0m12:37:58.050991 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:37:58.050991 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:37:58.050991 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:37:58.928376 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m12:37:58.929368 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m12:37:58.929368 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:37:58.930368 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:37:59.606107 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m12:37:59.607108 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:37:59.637055 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m12:37:59.637055 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:38:00.262261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cbeb0afe-f228-4c47-af35-0d353cccd46a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237EAC85700>]}
[0m12:38:00.262261 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:38:00.271335 [info ] [MainThread]: 
[0m12:38:00.272046 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m12:38:00.272046 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_estoque_produto_base ................. [RUN]
[0m12:38:00.272046 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_estoque_produto_base'
[0m12:38:00.272046 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m12:38:00.287595 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:38:00.288589 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 12:38:00.272046 => 12:38:00.288589
[0m12:38:00.288589 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m12:38:00.291576 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:38:01.006366 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:38:01.006795 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_produto_bling
          ,qt_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    where ds_status_compra in ('EM ABERTO')
)

, cte_joins as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,a.qt_estoque_minimo                as qt_estoque_minimo
         ,a.qt_estoque_atual                 as qt_estoque_atual
         ,a.vl_custo_total                   as vl_custo_total
         ,a.vl_preco_venda                   as vl_preco_venda
         ,sum(b.qt_item)                     as qt_item_compra_pendente
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,a.qt_estoque_minimo                as qt_estoque_minimo
         ,a.qt_estoque_atual                 as qt_estoque_atual
         ,a.vl_custo_total                   as vl_custo_total
         ,a.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses               as qt_dias_tres_meses
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m12:38:01.341576 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:634f62c0-fac5-4a70-8033-9f1b710dfb72&page=queryresults
[0m12:38:01.341576 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Syntax error: Expected ")" but got keyword AS at [161:46]')
[0m12:38:02.379071 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c7775736-afe5-4b27-8abe-51fafd1a13f4&page=queryresults
[0m12:38:02.379071 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c7775736-afe5-4b27-8abe-51fafd1a13f4&page=queryresults
[0m12:38:02.379071 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 12:38:00.289589 => 12:38:02.379071
[0m12:38:02.515236 [debug] [Thread-1  ]: Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Syntax error: Expected ")" but got keyword AS at [161:46]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m12:38:02.516267 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cbeb0afe-f228-4c47-af35-0d353cccd46a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237EC213100>]}
[0m12:38:02.516267 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_estoque_produto_base ........ [[31mERROR[0m in 2.24s]
[0m12:38:02.517251 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m12:38:02.519234 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:38:02.520250 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:38:02.520250 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m12:38:02.520250 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m12:38:02.521238 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m12:38:02.521238 [info ] [MainThread]: 
[0m12:38:02.521941 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 4.47 seconds (4.47s).
[0m12:38:02.522947 [debug] [MainThread]: Command end result
[0m12:38:02.529945 [info ] [MainThread]: 
[0m12:38:02.530948 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:38:02.532082 [info ] [MainThread]: 
[0m12:38:02.533086 [error] [MainThread]:   Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Syntax error: Expected ")" but got keyword AS at [161:46]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m12:38:02.533504 [info ] [MainThread]: 
[0m12:38:02.534570 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m12:38:02.535551 [debug] [MainThread]: Command `dbt run` failed at 12:38:02.535551 after 5.31 seconds
[0m12:38:02.535551 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237E76AA3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237EAD157C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000237E53386D0>]}
[0m12:38:02.535551 [debug] [MainThread]: Flushing usage events
[0m12:46:09.037366 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD50636460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD4F5B29D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD4F5B2B80>]}


============================== 12:46:09.037366 | d95309c2-88f9-4fd7-8e49-d6a99f78dea4 ==============================
[0m12:46:09.037366 [info ] [MainThread]: Running with dbt=1.7.4
[0m12:46:09.037366 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --models tb_estoque_produto_base', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m12:46:09.466858 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd95309c2-88f9-4fd7-8e49-d6a99f78dea4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD4F59C130>]}
[0m12:46:09.530197 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd95309c2-88f9-4fd7-8e49-d6a99f78dea4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD53BCF640>]}
[0m12:46:09.533613 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m12:46:09.534638 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m12:46:09.622727 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m12:46:09.622727 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_estoque_produto_base.sql
[0m12:46:09.700526 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd95309c2-88f9-4fd7-8e49-d6a99f78dea4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD54123850>]}
[0m12:46:09.722495 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd95309c2-88f9-4fd7-8e49-d6a99f78dea4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD53E9F790>]}
[0m12:46:09.722495 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m12:46:09.722495 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd95309c2-88f9-4fd7-8e49-d6a99f78dea4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD53E9F7C0>]}
[0m12:46:09.722495 [info ] [MainThread]: 
[0m12:46:09.722495 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m12:46:09.722495 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m12:46:09.722495 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:46:10.770203 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m12:46:10.771198 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:46:10.774206 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m12:46:10.774785 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m12:46:11.435501 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m12:46:11.435501 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:46:11.465529 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m12:46:11.465529 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m12:46:12.143548 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd95309c2-88f9-4fd7-8e49-d6a99f78dea4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD53C38820>]}
[0m12:46:12.143548 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m12:46:12.144549 [info ] [MainThread]: 
[0m12:46:12.147547 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m12:46:12.148547 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_estoque_produto_base ................. [RUN]
[0m12:46:12.149549 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_estoque_produto_base'
[0m12:46:12.149549 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m12:46:12.156550 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:46:12.157551 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 12:46:12.150548 => 12:46:12.157551
[0m12:46:12.158552 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m12:46:12.174548 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m12:46:12.799508 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m12:46:12.801510 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_produto_bling
          ,qt_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    where ds_status_compra in ('EM ABERTO')
)

, cte_joins as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,a.qt_estoque_minimo                as qt_estoque_minimo
         ,a.qt_estoque_atual                 as qt_estoque_atual
         ,a.vl_custo_total                   as vl_custo_total
         ,a.vl_preco_venda                   as vl_preco_venda
         ,sum(b.qt_item)                     as qt_item_compra_pendente
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m12:46:13.654564 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:97db64bd-c104-4823-9e50-6385c7383521&page=queryresults
[0m12:46:14.064454 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: dt_prevista_compra at [126:12]')
[0m12:46:15.084325 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dd5c0607-7486-42ab-adba-39b4809fb555&page=queryresults
[0m12:46:15.520906 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dd5c0607-7486-42ab-adba-39b4809fb555&page=queryresults
[0m12:46:15.523936 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 12:46:12.158552 => 12:46:15.522909
[0m12:46:15.540739 [debug] [Thread-1  ]: Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Unrecognized name: dt_prevista_compra at [126:12]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m12:46:15.543753 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd95309c2-88f9-4fd7-8e49-d6a99f78dea4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD551C2190>]}
[0m12:46:15.546757 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_estoque_produto_base ........ [[31mERROR[0m in 3.39s]
[0m12:46:15.558110 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m12:46:15.569477 [debug] [MainThread]: Connection 'master' was properly closed.
[0m12:46:15.570438 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m12:46:15.572479 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m12:46:15.574907 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m12:46:15.575868 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m12:46:15.576936 [info ] [MainThread]: 
[0m12:46:15.578927 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.85 seconds (5.85s).
[0m12:46:15.584292 [debug] [MainThread]: Command end result
[0m12:46:15.653813 [info ] [MainThread]: 
[0m12:46:15.658818 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m12:46:15.664811 [info ] [MainThread]: 
[0m12:46:15.668810 [error] [MainThread]:   Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Unrecognized name: dt_prevista_compra at [126:12]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m12:46:15.677825 [info ] [MainThread]: 
[0m12:46:15.681815 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m12:46:15.687817 [debug] [MainThread]: Command `dbt run` failed at 12:46:15.686811 after 6.70 seconds
[0m12:46:15.689811 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD50636460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD53BCF640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001BD53F7E670>]}
[0m12:46:15.692978 [debug] [MainThread]: Flushing usage events
[0m13:00:13.905279 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B92B763460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B92A6E36D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B92A6E3E20>]}


============================== 13:00:13.910622 | 6121668a-d971-4445-9faf-c1f5eba9fe84 ==============================
[0m13:00:13.910622 [info ] [MainThread]: Running with dbt=1.7.4
[0m13:00:13.911940 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --exclude tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m13:00:14.616181 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B92D8AAB80>]}
[0m13:00:14.676432 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B92EDD1640>]}
[0m13:00:14.678451 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m13:00:14.710398 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m13:00:18.488591 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:00:18.488591 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:00:18.494585 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B92F0C8250>]}
[0m13:00:18.542215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B92EFDDEE0>]}
[0m13:00:18.543213 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m13:00:18.544218 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B92EFDD190>]}
[0m13:00:18.547210 [info ] [MainThread]: 
[0m13:00:18.547792 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:00:18.550788 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:00:18.551780 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:18.552216 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m13:00:18.553278 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:19.537377 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:20.442288 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m13:00:20.444283 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:20.445278 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m13:00:20.446282 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:00:21.099620 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m13:00:21.105203 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:21.142664 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m13:00:21.143664 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:00:21.817981 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B92ED2E6A0>]}
[0m13:00:21.818986 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m13:00:21.820335 [info ] [MainThread]: 
[0m13:00:21.828271 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:21.830392 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m13:00:21.829380 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m13:00:21.831274 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m13:00:21.840717 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m13:00:21.842047 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m13:00:21.850152 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m13:00:21.851648 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m13:00:21.851648 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:21.854649 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m13:00:21.857655 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 13:00:21.852648 => 13:00:21.857655
[0m13:00:21.858723 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:21.873354 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 13:00:21.842047 => 13:00:21.873354
[0m13:00:21.873354 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m13:00:21.881735 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m13:00:21.883829 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m13:00:21.886165 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m13:00:21.886165 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m13:00:21.888165 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m13:00:21.910173 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m13:00:22.781558 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:806bf006-0a3d-4d80-8dc4-290f79965656&page=queryresults
[0m13:00:22.820158 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3d764e94-89cd-41e4-8884-d7c42dbd0d0d&page=queryresults
[0m13:00:23.306699 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 13:00:21.858723 => 13:00:23.305706
[0m13:00:23.306699 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B9301DDD30>]}
[0m13:00:23.307703 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.47s]
[0m13:00:23.308563 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m13:00:23.308563 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m13:00:23.309572 [info ] [Thread-1  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m13:00:23.310572 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m13:00:23.310909 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m13:00:23.313123 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m13:00:23.314124 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 13:00:23.310909 => 13:00:23.314124
[0m13:00:23.314124 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m13:00:23.318455 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m13:00:23.319454 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:23.320916 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m13:00:23.357570 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 13:00:21.873354 => 13:00:23.357570
[0m13:00:23.358578 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B93016F730>]}
[0m13:00:23.359579 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.52s]
[0m13:00:23.360043 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m13:00:23.361041 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_compra
[0m13:00:23.361041 [info ] [Thread-2  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m13:00:23.362041 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_compra)
[0m13:00:23.363044 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_compra
[0m13:00:23.366036 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m13:00:23.367038 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (compile): 13:00:23.363044 => 13:00:23.367038
[0m13:00:23.368038 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_compra
[0m13:00:23.370035 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m13:00:23.370035 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:23.371879 [debug] [Thread-2  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m13:00:24.049242 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:009487ce-021d-46e1-94a0-4fd9f8d8bdc1&page=queryresults
[0m13:00:24.128600 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8750f22c-e0ba-44f9-aabd-da74c5912799&page=queryresults
[0m13:00:24.465793 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 13:00:23.314124 => 13:00:24.464786
[0m13:00:24.466786 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B9301FD1F0>]}
[0m13:00:24.467845 [info ] [Thread-1  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m13:00:24.469845 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m13:00:24.470355 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m13:00:24.471397 [info ] [Thread-1  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m13:00:24.472395 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m13:00:24.473394 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m13:00:24.479397 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m13:00:24.481410 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 13:00:24.474395 => 13:00:24.481410
[0m13:00:24.482354 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m13:00:24.487947 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m13:00:24.490251 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:24.493475 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m13:00:24.566944 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (execute): 13:00:23.368038 => 13:00:24.566944
[0m13:00:24.569064 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B9301FD640>]}
[0m13:00:24.570060 [info ] [Thread-2  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m13:00:24.570959 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_compra
[0m13:00:24.571963 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m13:00:24.572962 [info ] [Thread-2  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m13:00:24.575045 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m13:00:24.575045 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m13:00:24.580454 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m13:00:24.583201 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 13:00:24.576036 => 13:00:24.581579
[0m13:00:24.584229 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m13:00:24.597759 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m13:00:24.600073 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:24.603197 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m13:00:25.243549 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4d3b5cbb-1d46-4382-ad0c-9006617a268e&page=queryresults
[0m13:00:25.449595 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:197c620c-0a06-402c-bf9a-551c08e379c3&page=queryresults
[0m13:00:25.687433 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 13:00:24.482926 => 13:00:25.686430
[0m13:00:25.689432 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B92F11A2E0>]}
[0m13:00:25.690430 [info ] [Thread-1  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m13:00:25.693139 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m13:00:25.693139 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m13:00:25.694097 [info ] [Thread-1  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m13:00:25.697092 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m13:00:25.698092 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m13:00:25.703645 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m13:00:25.706550 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 13:00:25.698092 => 13:00:25.705582
[0m13:00:25.707644 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m13:00:25.712258 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m13:00:25.714118 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:25.716187 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m13:00:25.923805 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 13:00:24.584229 => 13:00:25.921801
[0m13:00:25.925793 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B92F0C89A0>]}
[0m13:00:25.928790 [info ] [Thread-2  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.35s]
[0m13:00:25.931367 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m13:00:25.932439 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m13:00:25.934530 [info ] [Thread-2  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m13:00:25.936515 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m13:00:25.937527 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m13:00:25.943516 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m13:00:25.945387 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 13:00:25.937527 => 13:00:25.944514
[0m13:00:25.945387 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m13:00:25.948512 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m13:00:25.949504 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:25.951876 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m13:00:26.572050 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:49f81ae3-4638-49ca-a19e-23435c1a3555&page=queryresults
[0m13:00:26.732511 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1e0dab02-2800-4641-8889-7298c15578cc&page=queryresults
[0m13:00:27.004264 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 13:00:25.707644 => 13:00:27.004264
[0m13:00:27.006275 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B930177220>]}
[0m13:00:27.007266 [info ] [Thread-1  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m13:00:27.008171 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m13:00:27.009277 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:27.010176 [info ] [Thread-1  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m13:00:27.011798 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m13:00:27.011798 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:27.017845 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m13:00:27.018849 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 13:00:27.012846 => 13:00:27.018849
[0m13:00:27.019858 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:27.030201 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m13:00:27.031278 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:27.033182 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m13:00:27.140420 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 13:00:25.945387 => 13:00:27.139422
[0m13:00:27.141431 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B9302315E0>]}
[0m13:00:27.142493 [info ] [Thread-2  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m13:00:27.144497 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m13:00:27.144497 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m13:00:27.145508 [info ] [Thread-2  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m13:00:27.147499 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m13:00:27.147499 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m13:00:27.153498 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m13:00:27.155501 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 13:00:27.148499 => 13:00:27.154500
[0m13:00:27.156500 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m13:00:27.160496 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m13:00:27.162480 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:27.164499 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m13:00:27.753864 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a9157a36-452f-40ce-b111-02428b60881f&page=queryresults
[0m13:00:27.817231 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:01eb8148-5667-41ee-ab9d-b50da78f0168&page=queryresults
[0m13:00:28.195530 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 13:00:27.020177 => 13:00:28.195530
[0m13:00:28.197534 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B9301526D0>]}
[0m13:00:28.202876 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 13:00:27.156500 => 13:00:28.201872
[0m13:00:28.202876 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B9302CA550>]}
[0m13:00:28.198437 [info ] [Thread-1  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m13:00:28.205698 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m13:00:28.206712 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m13:00:28.204394 [info ] [Thread-2  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.06s]
[0m13:00:28.208463 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m13:00:28.210146 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m13:00:28.207709 [info ] [Thread-1  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m13:00:28.212285 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m13:00:28.212285 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m13:00:28.219283 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m13:00:28.211291 [info ] [Thread-2  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m13:00:28.221292 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m13:00:28.221292 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m13:00:28.226386 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m13:00:28.228358 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 13:00:28.222354 => 13:00:28.228358
[0m13:00:28.229284 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m13:00:28.233989 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m13:00:28.234934 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 13:00:28.213283 => 13:00:28.234934
[0m13:00:28.235902 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m13:00:28.240233 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m13:00:28.241871 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:28.244882 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m13:00:28.269875 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:28.271879 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m13:00:28.994905 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ee0a0440-ff59-4517-b453-ca92d6690d65&page=queryresults
[0m13:00:29.004523 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ed209a8c-7371-416e-9b46-4193b306b3e8&page=queryresults
[0m13:00:29.411838 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 13:00:28.229284 => 13:00:29.411838
[0m13:00:29.412840 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B9302F44C0>]}
[0m13:00:29.413840 [info ] [Thread-2  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m13:00:29.414865 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m13:00:29.415842 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m13:00:29.415842 [info ] [Thread-2  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m13:00:29.416873 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_tempo)
[0m13:00:29.417845 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m13:00:29.424400 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m13:00:29.426404 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 13:00:29.417845 => 13:00:29.425402
[0m13:00:29.427409 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m13:00:29.432395 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m13:00:29.433394 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:29.436394 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m13:00:29.461738 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 13:00:28.235902 => 13:00:29.461738
[0m13:00:29.462786 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B9302FB250>]}
[0m13:00:29.462786 [info ] [Thread-1  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m13:00:29.463829 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m13:00:29.464686 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m13:00:29.464686 [info ] [Thread-1  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m13:00:29.465792 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m13:00:29.465792 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m13:00:29.467782 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m13:00:29.468784 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 13:00:29.465792 => 13:00:29.468784
[0m13:00:29.468784 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m13:00:29.478790 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:30.179325 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m13:00:30.180685 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m13:00:30.232310 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:503d5bab-d484-494a-9d64-6effa0a9c3e6&page=queryresults
[0m13:00:30.606334 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 13:00:29.427409 => 13:00:30.605335
[0m13:00:30.607343 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B930311FA0>]}
[0m13:00:30.608347 [info ] [Thread-2  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m13:00:30.609374 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m13:00:30.919993 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8c24fca5-db79-4e9c-8c5f-4a50f9c7c57c&page=queryresults
[0m13:00:33.443879 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 13:00:29.469784 => 13:00:33.442873
[0m13:00:33.444877 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B9302A7E50>]}
[0m13:00:33.445881 [info ] [Thread-1  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 3.98s]
[0m13:00:33.448081 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m13:00:33.449009 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m13:00:33.450098 [info ] [Thread-2  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m13:00:33.451477 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m13:00:33.452566 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m13:00:33.458568 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m13:00:33.460849 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 13:00:33.452566 => 13:00:33.459570
[0m13:00:33.460849 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m13:00:33.469923 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:34.106778 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m13:00:34.108780 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m13:00:34.801683 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ffbf4b6c-8784-4dd1-b115-e50c7b170bac&page=queryresults
[0m13:00:37.396401 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 13:00:33.460849 => 13:00:37.395485
[0m13:00:37.397494 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B930394040>]}
[0m13:00:37.398499 [info ] [Thread-2  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 3.95s]
[0m13:00:37.400387 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m13:00:37.402156 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m13:00:37.403798 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_compra
[0m13:00:37.403168 [info ] [Thread-1  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m13:00:37.405871 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m13:00:37.405871 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m13:00:37.411348 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m13:00:37.404820 [info ] [Thread-2  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m13:00:37.413441 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m13:00:37.413441 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_compra
[0m13:00:37.419439 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m13:00:37.421349 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (compile): 13:00:37.414428 => 13:00:37.420348
[0m13:00:37.421349 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_compra
[0m13:00:37.425346 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:37.464531 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 13:00:37.406870 => 13:00:37.463519
[0m13:00:37.464531 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m13:00:37.466518 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:38.248993 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m13:00:38.253041 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m13:00:38.254945 [debug] [Thread-2  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m13:00:38.258940 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m13:00:38.864665 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:35912b1a-d6ff-45ec-9fbc-d3a121e6970f&page=queryresults
[0m13:00:38.903208 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ab353341-726f-4963-a500-6697f1c1f84b&page=queryresults
[0m13:00:41.353590 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 13:00:37.464531 => 13:00:41.352571
[0m13:00:41.354579 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B930305A90>]}
[0m13:00:41.356575 [info ] [Thread-1  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 3.95s]
[0m13:00:41.357467 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m13:00:41.358575 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m13:00:41.359469 [info ] [Thread-1  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m13:00:41.359469 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m13:00:41.360685 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m13:00:41.365588 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m13:00:41.367598 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 13:00:41.361591 => 13:00:41.366595
[0m13:00:41.367598 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m13:00:41.378314 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:41.442276 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (execute): 13:00:37.422347 => 13:00:41.442276
[0m13:00:41.443289 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B9301B5DF0>]}
[0m13:00:41.444290 [info ] [Thread-2  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 4.03s]
[0m13:00:41.446390 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_compra
[0m13:00:41.447301 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m13:00:41.447301 [info ] [Thread-2  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m13:00:41.449346 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m13:00:41.450291 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m13:00:41.457534 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m13:00:41.460552 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 13:00:41.450291 => 13:00:41.459544
[0m13:00:41.461439 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m13:00:41.464554 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:42.005552 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m13:00:42.007551 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m13:00:42.117116 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m13:00:42.120024 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m13:00:42.423377 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:10f1f30c-87ba-41da-8464-17d308e1cb28&page=queryresults
[0m13:00:42.837010 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3e30c2db-a9fb-450d-b91f-017fbf1c49a3&page=queryresults
[0m13:00:44.389573 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 13:00:41.368596 => 13:00:44.389573
[0m13:00:44.391475 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B93038AD30>]}
[0m13:00:44.392580 [info ] [Thread-1  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 3.03s]
[0m13:00:44.393535 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m13:00:44.394588 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m13:00:44.394588 [info ] [Thread-1  ]: 20 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m13:00:44.398139 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m13:00:44.398139 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m13:00:44.402937 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m13:00:44.404926 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 13:00:44.399136 => 13:00:44.404926
[0m13:00:44.405835 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m13:00:44.409828 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:45.042657 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m13:00:45.044660 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m13:00:45.366848 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 13:00:41.461439 => 13:00:45.365849
[0m13:00:45.367852 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B930167AC0>]}
[0m13:00:45.369852 [info ] [Thread-2  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.92s]
[0m13:00:45.371800 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m13:00:45.373504 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m13:00:45.374522 [info ] [Thread-2  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m13:00:45.376520 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m13:00:45.376520 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m13:00:45.384803 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m13:00:45.387827 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 13:00:45.377519 => 13:00:45.386804
[0m13:00:45.387827 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m13:00:45.396381 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:45.428588 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ebbc7cba-5273-43c7-bff1-eb0fee27517c&page=queryresults
[0m13:00:46.016960 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m13:00:46.019909 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m13:00:46.417823 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a1bb98c8-8fa1-44ff-a8c4-536bb8bd4527&page=queryresults
[0m13:00:47.437636 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 13:00:44.405835 => 13:00:47.436643
[0m13:00:47.438638 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B93035B100>]}
[0m13:00:47.440070 [info ] [Thread-1  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 3.04s]
[0m13:00:47.442241 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m13:00:47.443382 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m13:00:47.444398 [info ] [Thread-1  ]: 22 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m13:00:47.445061 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m13:00:47.446185 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m13:00:47.452170 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m13:00:47.453169 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 13:00:47.446185 => 13:00:47.453169
[0m13:00:47.454185 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m13:00:47.456169 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:48.182007 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m13:00:48.184014 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m13:00:48.635777 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 13:00:45.388823 => 13:00:48.635777
[0m13:00:48.637776 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B9301B5DF0>]}
[0m13:00:48.638777 [info ] [Thread-2  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.4 KiB processed)[0m in 3.26s]
[0m13:00:48.640328 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m13:00:48.642142 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m13:00:48.643158 [info ] [Thread-2  ]: 23 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m13:00:48.645156 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m13:00:48.645156 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m13:00:48.651154 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m13:00:48.653155 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 13:00:48.646155 => 13:00:48.652154
[0m13:00:48.653155 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m13:00:48.656152 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:48.753908 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1902eca2-9c47-45f4-96db-0e84f8730272&page=queryresults
[0m13:00:49.503526 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m13:00:49.505526 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m13:00:49.916778 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9b3453bc-47fb-40e5-851c-b01680fdafc6&page=queryresults
[0m13:00:53.336601 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 13:00:48.654154 => 13:00:53.335602
[0m13:00:53.337602 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B9313D0070>]}
[0m13:00:53.339598 [info ] [Thread-2  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.3 KiB processed)[0m in 4.69s]
[0m13:00:53.340922 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m13:00:53.341984 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m13:00:53.343050 [info ] [Thread-2  ]: 24 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m13:00:53.344969 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m13:00:53.346009 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m13:00:53.353636 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m13:00:53.355656 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 13:00:53.346009 => 13:00:53.355656
[0m13:00:53.356544 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m13:00:53.366177 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:53.819697 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 13:00:47.454185 => 13:00:53.818693
[0m13:00:53.820713 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B930167160>]}
[0m13:00:54.077643 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m13:00:54.078644 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m13:00:54.524406 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2a62fead-0eff-4aca-a46d-3a51b06e38c1&page=queryresults
[0m13:00:54.617067 [info ] [Thread-1  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 6.38s]
[0m13:00:54.618956 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m13:00:54.620604 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m13:00:54.621625 [info ] [Thread-1  ]: 25 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m13:00:54.624709 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m13:00:54.624709 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m13:00:54.634622 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m13:00:54.636622 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 13:00:54.625720 => 13:00:54.635624
[0m13:00:54.636622 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m13:00:54.641620 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m13:00:55.525059 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m13:00:55.528070 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m13:00:56.213978 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:47f91a9a-a42b-47ea-b50c-f92729f660f9&page=queryresults
[0m13:00:57.314072 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 13:00:53.356544 => 13:00:57.313071
[0m13:00:57.315070 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B930136F10>]}
[0m13:00:57.316070 [info ] [Thread-2  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 3.97s]
[0m13:00:57.317523 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m13:00:57.319592 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m13:00:57.320608 [info ] [Thread-2  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m13:00:57.321620 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m13:00:57.322614 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m13:00:57.329956 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m13:00:57.330969 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 13:00:57.322614 => 13:00:57.330969
[0m13:00:57.331972 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m13:00:57.335962 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m13:00:57.943280 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m13:00:57.946286 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_produto_bling
          ,qt_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    where ds_status_compra in ('EM ABERTO')
)

, cte_joins as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,a.qt_estoque_minimo                as qt_estoque_minimo
         ,a.qt_estoque_atual                 as qt_estoque_atual
         ,a.vl_custo_total                   as vl_custo_total
         ,a.vl_preco_venda                   as vl_preco_venda
         ,sum(b.qt_item)                     as qt_item_compra_pendente
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m13:00:58.560816 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:98544237-7a2d-4ce0-8bd6-61c721548c33&page=queryresults
[0m13:00:58.940688 [debug] [Thread-2  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: dt_prevista_compra at [126:12]')
[0m13:00:59.027148 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 13:00:54.637622 => 13:00:59.027148
[0m13:00:59.029150 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B92F14F8B0>]}
[0m13:00:59.030151 [info ] [Thread-1  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 4.40s]
[0m13:00:59.031756 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m13:00:59.653443 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:50de6fd0-12bc-4583-8662-6d2a622cce6b&page=queryresults
[0m13:01:00.000155 [error] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:50de6fd0-12bc-4583-8662-6d2a622cce6b&page=queryresults
[0m13:01:00.001192 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 13:00:57.331972 => 13:01:00.001192
[0m13:01:00.392292 [debug] [Thread-2  ]: Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Unrecognized name: dt_prevista_compra at [126:12]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m13:01:00.393295 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6121668a-d971-4445-9faf-c1f5eba9fe84', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B9303A4AF0>]}
[0m13:01:00.394293 [error] [Thread-2  ]: 26 of 26 ERROR creating sql table model dbt_dw_az.tb_estoque_produto_base ...... [[31mERROR[0m in 3.07s]
[0m13:01:00.396392 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m13:01:00.400294 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:01:00.401970 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:01:00.403087 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m13:01:00.403087 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m13:01:00.404086 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m13:01:00.404086 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto_base' was properly closed.
[0m13:01:00.405088 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m13:01:00.406092 [info ] [MainThread]: 
[0m13:01:00.407088 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 41.86 seconds (41.86s).
[0m13:01:00.416691 [debug] [MainThread]: Command end result
[0m13:01:00.449482 [info ] [MainThread]: 
[0m13:01:00.450433 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m13:01:00.452491 [info ] [MainThread]: 
[0m13:01:00.453388 [error] [MainThread]:   Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Unrecognized name: dt_prevista_compra at [126:12]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m13:01:00.454380 [info ] [MainThread]: 
[0m13:01:00.456385 [info ] [MainThread]: Done. PASS=25 WARN=0 ERROR=1 SKIP=0 TOTAL=26
[0m13:01:00.458383 [debug] [MainThread]: Command `dbt run` failed at 13:01:00.458383 after 46.70 seconds
[0m13:01:00.459383 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B92B763460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B92A6E3580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B930219AF0>]}
[0m13:01:00.460382 [debug] [MainThread]: Flushing usage events
[0m14:00:04.684425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF39734C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF28F0310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF28F0790>]}


============================== 14:00:04.691632 | 541c8395-96c1-40b0-99f0-550bb0e36aa4 ==============================
[0m14:00:04.691632 [info ] [MainThread]: Running with dbt=1.7.4
[0m14:00:04.693629 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --exclude tag:snaps', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m14:00:05.888358 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF28DA190>]}
[0m14:00:06.018876 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF6F110D0>]}
[0m14:00:06.020903 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m14:00:06.033380 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m14:00:06.176315 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:00:06.177312 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:00:06.188421 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF72D6520>]}
[0m14:00:06.206723 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF72B7FD0>]}
[0m14:00:06.207724 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m14:00:06.208311 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF72B7EE0>]}
[0m14:00:06.210350 [info ] [MainThread]: 
[0m14:00:06.212549 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m14:00:06.217545 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:06.218547 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:06.219528 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m14:00:06.219528 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:07.218995 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:08.182993 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m14:00:08.185001 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m14:00:08.186000 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:08.186000 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:00:08.858492 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m14:00:08.864991 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:08.905831 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m14:00:08.907834 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m14:00:09.605085 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF6F72A00>]}
[0m14:00:09.607085 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m14:00:09.608081 [info ] [MainThread]: 
[0m14:00:09.615058 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:09.616057 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m14:00:09.617358 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m14:00:09.618410 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m14:00:09.622497 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m14:00:09.624495 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m14:00:09.641191 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m14:00:09.645182 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m14:00:09.645182 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:09.653180 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m14:00:09.654180 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 14:00:09.625501 => 14:00:09.654180
[0m14:00:09.655181 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m14:00:09.696332 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 14:00:09.646182 => 14:00:09.695282
[0m14:00:09.724081 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m14:00:09.724081 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:09.730613 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m14:00:09.732043 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m14:00:09.736154 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m14:00:09.737142 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m14:00:09.774736 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m14:00:10.644737 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:75e2dfcb-84d1-48dc-ba10-0a7f6cca0e62&page=queryresults
[0m14:00:10.648737 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:13da9363-4e6f-4c0f-9c4b-da514a016e92&page=queryresults
[0m14:00:11.141082 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 14:00:09.656234 => 14:00:11.140082
[0m14:00:11.143086 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF7328880>]}
[0m14:00:11.149004 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 14:00:09.725593 => 14:00:11.149004
[0m14:00:11.144083 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.52s]
[0m14:00:11.151060 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF83D0F40>]}
[0m14:00:11.153061 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m14:00:11.155964 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m14:00:11.154062 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.53s]
[0m14:00:11.159026 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m14:00:11.157962 [info ] [Thread-2  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m14:00:11.160002 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_compra
[0m14:00:11.161494 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m14:00:11.162486 [info ] [Thread-1  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m14:00:11.163488 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m14:00:11.164485 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_compra)
[0m14:00:11.169485 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m14:00:11.169485 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_compra
[0m14:00:11.174959 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 14:00:11.165485 => 14:00:11.173959
[0m14:00:11.174959 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m14:00:11.176957 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m14:00:11.177961 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:11.180309 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m14:00:11.221844 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m14:00:11.224796 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (compile): 14:00:11.170814 => 14:00:11.224796
[0m14:00:11.225923 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_compra
[0m14:00:11.230240 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m14:00:11.231484 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:11.234494 [debug] [Thread-1  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m14:00:11.987721 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3f6f6246-6d31-4091-aeb4-09fb99e441b1&page=queryresults
[0m14:00:12.011363 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d2bd4786-92ce-4cd3-a237-765a2b5430f1&page=queryresults
[0m14:00:12.387419 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (execute): 14:00:11.225923 => 14:00:12.386416
[0m14:00:12.388418 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF8405370>]}
[0m14:00:12.389419 [info ] [Thread-1  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m14:00:12.390508 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_compra
[0m14:00:12.391509 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m14:00:12.392517 [info ] [Thread-1  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m14:00:12.393511 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_forma_pagamento)
[0m14:00:12.393511 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m14:00:12.397516 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m14:00:12.399802 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 14:00:12.393511 => 14:00:12.399802
[0m14:00:12.399802 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m14:00:12.405163 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 14:00:11.174959 => 14:00:12.404166
[0m14:00:12.409167 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m14:00:12.410175 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF8405700>]}
[0m14:00:12.411536 [info ] [Thread-2  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m14:00:12.412485 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m14:00:12.412485 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m14:00:12.413536 [info ] [Thread-2  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m14:00:12.415533 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m14:00:12.415533 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m14:00:12.420526 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m14:00:12.421434 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:12.423432 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m14:00:12.465914 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 14:00:12.416535 => 14:00:12.465914
[0m14:00:12.465914 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m14:00:12.470035 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m14:00:12.470853 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:12.472970 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m14:00:13.137780 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5e2b44f5-bcbc-4dc1-a60c-62fac30f15ef&page=queryresults
[0m14:00:13.251515 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ad2b5749-8d8d-49f2-ab6f-7faeeb0fccbe&page=queryresults
[0m14:00:13.610353 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 14:00:12.405163 => 14:00:13.610353
[0m14:00:13.611714 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF83981C0>]}
[0m14:00:13.612721 [info ] [Thread-1  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m14:00:13.613607 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m14:00:13.614608 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m14:00:13.615606 [info ] [Thread-1  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m14:00:13.616606 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m14:00:13.616606 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m14:00:13.632397 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m14:00:13.634355 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 14:00:13.617606 => 14:00:13.633308
[0m14:00:13.634355 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m14:00:13.640403 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m14:00:13.642359 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:13.644401 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m14:00:13.746818 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 14:00:12.466964 => 14:00:13.746311
[0m14:00:13.747826 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF7328880>]}
[0m14:00:13.748826 [info ] [Thread-2  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m14:00:13.749826 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m14:00:13.750826 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m14:00:13.751826 [info ] [Thread-2  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m14:00:13.752826 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m14:00:13.752826 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m14:00:13.758788 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m14:00:13.760395 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 14:00:13.753826 => 14:00:13.760395
[0m14:00:13.760395 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m14:00:13.765685 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m14:00:13.766663 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:13.770040 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m14:00:14.513599 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:546c73c8-8a9d-4011-b099-616df5d158be&page=queryresults
[0m14:00:14.709761 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c675d247-20e3-494a-b2f6-e44520fcc144&page=queryresults
[0m14:00:14.948907 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 14:00:13.635306 => 14:00:14.948907
[0m14:00:14.949906 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF8415FA0>]}
[0m14:00:14.950896 [info ] [Thread-1  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m14:00:14.952795 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m14:00:14.952795 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:14.953792 [info ] [Thread-1  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m14:00:14.954791 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m14:00:14.954791 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:14.959791 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m14:00:14.960797 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 14:00:14.955791 => 14:00:14.960797
[0m14:00:14.961928 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:14.966050 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m14:00:14.967054 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:14.969415 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m14:00:15.108906 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 14:00:13.760395 => 14:00:15.108906
[0m14:00:15.109908 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF8393F40>]}
[0m14:00:15.110919 [info ] [Thread-2  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m14:00:15.111924 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m14:00:15.112912 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m14:00:15.113856 [info ] [Thread-2  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m14:00:15.114813 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m14:00:15.114813 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m14:00:15.120811 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m14:00:15.122135 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 14:00:15.115915 => 14:00:15.121628
[0m14:00:15.122135 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m14:00:15.132895 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m14:00:15.134902 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:15.137793 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m14:00:15.733971 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:65b422ec-27b9-4649-aaee-620766b1e6c6&page=queryresults
[0m14:00:15.922346 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1aee3790-4a23-4d64-8980-37dff5716b2d&page=queryresults
[0m14:00:16.153517 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 14:00:14.961928 => 14:00:16.153517
[0m14:00:16.155518 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF8403970>]}
[0m14:00:16.156520 [info ] [Thread-1  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m14:00:16.158520 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m14:00:16.158520 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m14:00:16.159518 [info ] [Thread-1  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m14:00:16.162521 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m14:00:16.163519 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m14:00:16.169217 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m14:00:16.170217 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 14:00:16.163519 => 14:00:16.170217
[0m14:00:16.171219 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m14:00:16.175218 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m14:00:16.176230 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:16.179323 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m14:00:16.361068 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 14:00:15.123148 => 14:00:16.361068
[0m14:00:16.362624 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF8390DF0>]}
[0m14:00:16.363938 [info ] [Thread-2  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m14:00:16.365888 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m14:00:16.366997 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m14:00:16.367987 [info ] [Thread-2  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m14:00:16.370304 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m14:00:16.371578 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m14:00:16.375589 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m14:00:16.377604 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 14:00:16.371578 => 14:00:16.377604
[0m14:00:16.378655 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m14:00:16.385705 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m14:00:16.386697 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:16.388901 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m14:00:16.906369 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b97076b0-f41e-4d7f-81b7-3e46ffd4f6aa&page=queryresults
[0m14:00:17.187391 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c9f62cbd-5140-4aa7-ba46-88fceb6e40ff&page=queryresults
[0m14:00:17.338743 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 14:00:16.171219 => 14:00:17.338743
[0m14:00:17.340551 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF843A820>]}
[0m14:00:17.341563 [info ] [Thread-1  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m14:00:17.342290 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m14:00:17.343395 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m14:00:17.344301 [info ] [Thread-1  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m14:00:17.345399 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m14:00:17.345399 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m14:00:17.350405 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m14:00:17.351334 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 14:00:17.345399 => 14:00:17.351334
[0m14:00:17.352346 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m14:00:17.364650 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m14:00:17.366696 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:17.368791 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m14:00:17.579146 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 14:00:16.380574 => 14:00:17.579146
[0m14:00:17.581045 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF849D4F0>]}
[0m14:00:17.582042 [info ] [Thread-2  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m14:00:17.592050 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m14:00:17.593050 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m14:00:17.594050 [info ] [Thread-2  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m14:00:17.596055 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.dm_produto)
[0m14:00:17.596528 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m14:00:17.604482 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m14:00:17.606500 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 14:00:17.597728 => 14:00:17.606500
[0m14:00:17.607475 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m14:00:17.622001 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:18.083009 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:30a7ef5b-b6f0-46fe-a548-51a91a6e3066&page=queryresults
[0m14:00:18.323553 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m14:00:18.327459 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m14:00:18.501783 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 14:00:17.352346 => 14:00:18.501273
[0m14:00:18.502796 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF848F1C0>]}
[0m14:00:18.502796 [info ] [Thread-1  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m14:00:18.505417 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m14:00:18.974294 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5b1f23e2-6b90-4b1f-90bb-ee99f5beed0f&page=queryresults
[0m14:00:21.822368 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 14:00:17.607475 => 14:00:21.821414
[0m14:00:21.823410 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF8498A60>]}
[0m14:00:21.825415 [info ] [Thread-2  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 4.23s]
[0m14:00:21.828410 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m14:00:21.829411 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m14:00:21.831840 [info ] [Thread-1  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m14:00:21.834898 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m14:00:21.835901 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m14:00:21.844697 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m14:00:21.846643 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 14:00:21.837018 => 14:00:21.845696
[0m14:00:21.846643 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m14:00:21.851443 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:22.500874 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m14:00:22.504010 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m14:00:23.143678 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:76a49a3b-5173-47f1-b2d2-722068b43cd2&page=queryresults
[0m14:00:25.800590 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 14:00:21.847697 => 14:00:25.799600
[0m14:00:25.802240 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF84D6430>]}
[0m14:00:25.804385 [info ] [Thread-1  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 3.97s]
[0m14:00:25.806261 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m14:00:25.808972 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m14:00:25.810393 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m14:00:25.811466 [info ] [Thread-2  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m14:00:25.814480 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m14:00:25.812485 [info ] [Thread-1  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m14:00:25.815531 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m14:00:25.817525 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m14:00:25.820810 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m14:00:25.827891 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m14:00:25.835406 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 14:00:25.821770 => 14:00:25.834410
[0m14:00:25.842404 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m14:00:25.843404 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m14:00:25.847399 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:25.870104 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 14:00:25.818522 => 14:00:25.870104
[0m14:00:25.870512 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m14:00:25.871631 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:26.691737 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m14:00:26.694195 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m14:00:26.712627 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m14:00:26.715904 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m14:00:27.312740 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:74d6c70c-4d01-4574-8481-faaabbbaf087&page=queryresults
[0m14:00:27.337485 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4beedda1-f4ef-41d8-8cef-12a6c682869a&page=queryresults
[0m14:00:30.167226 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 14:00:25.844407 => 14:00:30.167226
[0m14:00:30.168227 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF8542610>]}
[0m14:00:30.169227 [info ] [Thread-1  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 4.35s]
[0m14:00:30.171327 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m14:00:30.171327 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m14:00:30.172329 [info ] [Thread-1  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m14:00:30.174228 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_estoque_geral)
[0m14:00:30.174228 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m14:00:30.180227 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m14:00:30.181136 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 14:00:30.175228 => 14:00:30.181136
[0m14:00:30.182398 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m14:00:30.185513 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:30.397062 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 14:00:25.870512 => 14:00:30.396061
[0m14:00:30.398060 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF8540850>]}
[0m14:00:30.400491 [info ] [Thread-2  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 4.58s]
[0m14:00:30.403611 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m14:00:30.404634 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m14:00:30.406626 [info ] [Thread-2  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m14:00:30.408626 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_pedido)
[0m14:00:30.409961 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m14:00:30.417186 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m14:00:30.418190 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 14:00:30.409961 => 14:00:30.418190
[0m14:00:30.419198 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m14:00:30.428424 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:30.865427 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m14:00:30.867489 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m14:00:31.027112 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m14:00:31.029117 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m14:00:31.240765 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b9f2fa48-b6d0-4d67-bd2d-2e86699a3ee9&page=queryresults
[0m14:00:31.693417 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:411086f8-f61f-4d3a-a585-9e7a6e0fadb8&page=queryresults
[0m14:00:34.356285 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 14:00:30.182398 => 14:00:34.356285
[0m14:00:34.358284 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF735E280>]}
[0m14:00:34.359284 [info ] [Thread-1  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 4.18s]
[0m14:00:34.360815 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m14:00:34.361929 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m14:00:34.362919 [info ] [Thread-1  ]: 20 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m14:00:34.363813 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m14:00:34.364914 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m14:00:34.370815 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m14:00:34.372322 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 14:00:34.364914 => 14:00:34.371312
[0m14:00:34.372322 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m14:00:34.376319 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:35.087049 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m14:00:35.089038 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m14:00:35.499960 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bd3e2e07-fa20-41c6-a50b-cc414bc0138b&page=queryresults
[0m14:00:36.026225 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 14:00:30.419198 => 14:00:36.025224
[0m14:00:36.027231 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF843EE50>]}
[0m14:00:36.029219 [info ] [Thread-2  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 5.62s]
[0m14:00:36.031228 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m14:00:36.032338 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m14:00:36.033354 [info ] [Thread-2  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m14:00:36.035410 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m14:00:36.035410 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m14:00:36.042747 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m14:00:36.044802 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 14:00:36.036393 => 14:00:36.043745
[0m14:00:36.045744 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m14:00:36.049752 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:36.737901 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m14:00:36.741331 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m14:00:37.102420 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:32d1c2eb-da07-47a3-8744-8a0eca6447cf&page=queryresults
[0m14:00:37.802624 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 14:00:34.373321 => 14:00:37.801624
[0m14:00:37.803623 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF8496D90>]}
[0m14:00:37.804621 [info ] [Thread-1  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 3.44s]
[0m14:00:37.807154 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m14:00:37.808488 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m14:00:37.809504 [info ] [Thread-1  ]: 22 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m14:00:37.811007 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m14:00:37.812141 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m14:00:37.818140 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m14:00:37.819274 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 14:00:37.812141 => 14:00:37.819274
[0m14:00:37.820691 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m14:00:37.832221 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:38.862999 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m14:00:38.864907 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m14:00:39.301440 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 14:00:36.045744 => 14:00:39.300002
[0m14:00:39.303440 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF849D4F0>]}
[0m14:00:39.304434 [info ] [Thread-2  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.5 KiB processed)[0m in 3.27s]
[0m14:00:39.306437 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m14:00:39.307843 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m14:00:39.308858 [info ] [Thread-2  ]: 23 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m14:00:39.310858 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m14:00:39.311857 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m14:00:39.317854 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m14:00:39.320857 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 14:00:39.311857 => 14:00:39.319857
[0m14:00:39.321405 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m14:00:39.325446 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:39.569597 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2b90143a-5a41-4e07-8996-fb8b9ce32bcd&page=queryresults
[0m14:00:40.006031 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m14:00:40.008033 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m14:00:40.358446 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c4fe3a8b-94f3-4d39-8433-19d237b29561&page=queryresults
[0m14:00:42.592331 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 14:00:39.321405 => 14:00:42.592331
[0m14:00:42.593329 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF852F820>]}
[0m14:00:42.594328 [info ] [Thread-2  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.6 KiB processed)[0m in 3.28s]
[0m14:00:42.595236 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m14:00:42.596237 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m14:00:42.597238 [info ] [Thread-2  ]: 24 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m14:00:42.598238 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m14:00:42.599337 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m14:00:42.605335 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m14:00:42.607357 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 14:00:42.599337 => 14:00:42.607357
[0m14:00:42.608340 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m14:00:42.611332 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:43.271428 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m14:00:43.280455 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 14:00:37.820691 => 14:00:43.279441
[0m14:00:43.282796 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF8384AF0>]}
[0m14:00:43.289807 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m14:00:43.820696 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0ad93c61-861c-4bc2-b868-b3a9e8a4cb35&page=queryresults
[0m14:00:44.104458 [info ] [Thread-1  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 5.47s]
[0m14:00:44.106353 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m14:00:44.106353 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m14:00:44.107454 [info ] [Thread-1  ]: 25 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m14:00:44.109360 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m14:00:44.109360 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m14:00:44.116598 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m14:00:44.118501 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 14:00:44.110358 => 14:00:44.117606
[0m14:00:44.118501 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m14:00:44.128340 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m14:00:44.873014 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m14:00:44.875012 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m14:00:45.527882 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:edac4654-1410-460f-a1d4-6b5c8eb30fc9&page=queryresults
[0m14:00:47.323214 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 14:00:42.608340 => 14:00:47.323214
[0m14:00:47.324212 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF9580100>]}
[0m14:00:47.325214 [info ] [Thread-2  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 4.73s]
[0m14:00:47.326307 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m14:00:47.327412 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m14:00:47.328413 [info ] [Thread-2  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m14:00:47.329424 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m14:00:47.330324 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m14:00:47.336643 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m14:00:47.338646 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 14:00:47.330324 => 14:00:47.337644
[0m14:00:47.338646 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m14:00:47.342508 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m14:00:48.003519 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m14:00:48.006423 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_produto_bling
          ,qt_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    where ds_status_compra in ('EM ABERTO')
)

, cte_joins as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,a.qt_estoque_minimo                as qt_estoque_minimo
         ,a.qt_estoque_atual                 as qt_estoque_atual
         ,a.vl_custo_total                   as vl_custo_total
         ,a.vl_preco_venda                   as vl_preco_venda
         ,sum(b.qt_item)                     as qt_item_compra_pendente
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m14:00:48.593793 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 14:00:44.118501 => 14:00:48.592790
[0m14:00:48.594790 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF843A2E0>]}
[0m14:00:48.595791 [info ] [Thread-1  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 4.49s]
[0m14:00:48.597793 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m14:00:48.698084 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a0c8b655-7d61-4484-bce6-2fd75ea0c427&page=queryresults
[0m14:00:49.070141 [debug] [Thread-2  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: dt_prevista_compra at [126:12]')
[0m14:00:50.029220 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e98d6446-747c-4f13-b4ab-2b6b10e2c6b2&page=queryresults
[0m14:00:50.500941 [error] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e98d6446-747c-4f13-b4ab-2b6b10e2c6b2&page=queryresults
[0m14:00:50.503044 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 14:00:47.339645 => 14:00:50.503044
[0m14:00:50.509041 [debug] [Thread-2  ]: Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Unrecognized name: dt_prevista_compra at [126:12]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m14:00:50.510041 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '541c8395-96c1-40b0-99f0-550bb0e36aa4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF9563C70>]}
[0m14:00:50.510041 [error] [Thread-2  ]: 26 of 26 ERROR creating sql table model dbt_dw_az.tb_estoque_produto_base ...... [[31mERROR[0m in 3.18s]
[0m14:00:50.512040 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m14:00:50.515040 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:00:50.516041 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:00:50.516041 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m14:00:50.516041 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m14:00:50.517040 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m14:00:50.517040 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m14:00:50.517040 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto_base' was properly closed.
[0m14:00:50.518038 [info ] [MainThread]: 
[0m14:00:50.519040 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 44.31 seconds (44.31s).
[0m14:00:50.524853 [debug] [MainThread]: Command end result
[0m14:00:50.541485 [info ] [MainThread]: 
[0m14:00:50.542558 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m14:00:50.542558 [info ] [MainThread]: 
[0m14:00:50.543557 [error] [MainThread]:   Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Unrecognized name: dt_prevista_compra at [126:12]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m14:00:50.544554 [info ] [MainThread]: 
[0m14:00:50.545602 [info ] [MainThread]: Done. PASS=25 WARN=0 ERROR=1 SKIP=0 TOTAL=26
[0m14:00:50.546555 [debug] [MainThread]: Command `dbt run` failed at 14:00:50.546555 after 45.92 seconds
[0m14:00:50.547557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF39734C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF6F110D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000025FF95846A0>]}
[0m14:00:50.547557 [debug] [MainThread]: Flushing usage events
[0m15:00:05.118655 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA2F2C94C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA2E245310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA2E245790>]}


============================== 15:00:05.127115 | 3eab1b79-df3b-440e-9f28-a845f0ad6fd3 ==============================
[0m15:00:05.127115 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:00:05.128034 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --exclude tag:snaps', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m15:00:06.018672 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA2E245970>]}
[0m15:00:06.077721 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA32940700>]}
[0m15:00:06.080015 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:00:06.087103 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:00:06.140867 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:00:06.141203 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:00:06.148410 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA32C381F0>]}
[0m15:00:06.166450 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA32B49FA0>]}
[0m15:00:06.167422 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:00:06.168463 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA32B49250>]}
[0m15:00:06.171596 [info ] [MainThread]: 
[0m15:00:06.172724 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:00:06.174646 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:06.174646 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:06.175626 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:00:06.175626 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:07.034871 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:07.770054 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:00:07.771054 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:00:07.771054 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:07.772061 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:00:08.453411 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m15:00:08.459406 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:08.494703 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:00:08.495706 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:00:09.147447 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA328B08B0>]}
[0m15:00:09.147447 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:00:09.148508 [info ] [MainThread]: 
[0m15:00:09.154381 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:09.154381 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m15:00:09.155434 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m15:00:09.156382 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m15:00:09.158515 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m15:00:09.158515 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m15:00:09.163522 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m15:00:09.169413 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m15:00:09.169413 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 15:00:09.159513 => 15:00:09.169413
[0m15:00:09.170663 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:09.171322 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m15:00:09.174511 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m15:00:09.204127 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m15:00:09.205764 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m15:00:09.206810 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 15:00:09.171322 => 15:00:09.206810
[0m15:00:09.207772 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:09.210805 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m15:00:09.212771 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m15:00:09.248146 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:00:09.250194 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m15:00:10.095054 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fcd8b6ed-453a-4e69-a52d-0c97b59b4b91&page=queryresults
[0m15:00:10.130422 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c51998ae-2986-41c6-81c4-dca4e8abf4db&page=queryresults
[0m15:00:10.522267 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 15:00:09.207772 => 15:00:10.522267
[0m15:00:10.524265 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33D34280>]}
[0m15:00:10.524265 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m15:00:10.525280 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m15:00:10.527224 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m15:00:10.528161 [info ] [Thread-1  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m15:00:10.530231 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m15:00:10.530605 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m15:00:10.534695 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m15:00:10.535692 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 15:00:10.530605 => 15:00:10.535692
[0m15:00:10.535692 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m15:00:10.542153 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m15:00:10.543159 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:10.545155 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m15:00:10.605931 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 15:00:09.175519 => 15:00:10.604935
[0m15:00:10.606940 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33CEF3D0>]}
[0m15:00:10.607934 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m15:00:10.609894 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m15:00:10.610898 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_compra
[0m15:00:10.610898 [info ] [Thread-2  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m15:00:10.611892 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_compra)
[0m15:00:10.612902 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_compra
[0m15:00:10.616892 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m15:00:10.618908 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (compile): 15:00:10.612902 => 15:00:10.618908
[0m15:00:10.619861 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_compra
[0m15:00:10.623305 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m15:00:10.624311 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:10.626235 [debug] [Thread-2  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m15:00:11.270038 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b8394337-3339-4066-9050-d9ab85aa3617&page=queryresults
[0m15:00:11.517607 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5571e1b3-3dd3-40d5-ab7e-647d62ab5e57&page=queryresults
[0m15:00:11.721949 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 15:00:10.536699 => 15:00:11.720705
[0m15:00:11.722946 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33CC2F40>]}
[0m15:00:11.723959 [info ] [Thread-1  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m15:00:11.725957 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m15:00:11.727956 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m15:00:11.729941 [info ] [Thread-1  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m15:00:11.731541 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m15:00:11.731541 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m15:00:11.736132 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m15:00:11.737143 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 15:00:11.732555 => 15:00:11.737143
[0m15:00:11.738144 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m15:00:11.744553 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m15:00:11.746555 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:11.749626 [debug] [Thread-1  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m15:00:11.959411 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (execute): 15:00:10.619861 => 15:00:11.959411
[0m15:00:11.961412 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33CC2100>]}
[0m15:00:11.962413 [info ] [Thread-2  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.35s]
[0m15:00:11.964972 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_compra
[0m15:00:11.965933 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m15:00:11.966973 [info ] [Thread-2  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m15:00:11.970325 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m15:00:11.971370 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m15:00:11.976358 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m15:00:11.978318 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 15:00:11.971370 => 15:00:11.978318
[0m15:00:11.978318 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m15:00:11.985615 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m15:00:11.986606 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:11.987480 [debug] [Thread-2  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m15:00:12.654602 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ca6f266f-bf2b-4ac7-8986-83f4d708c335&page=queryresults
[0m15:00:12.743618 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:13c506bb-4319-4ea7-9e6b-c121f6389631&page=queryresults
[0m15:00:13.078822 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 15:00:11.739145 => 15:00:13.077827
[0m15:00:13.081239 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33CC2FD0>]}
[0m15:00:13.082237 [info ] [Thread-1  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.35s]
[0m15:00:13.084248 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m15:00:13.085248 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m15:00:13.086237 [info ] [Thread-1  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m15:00:13.088242 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m15:00:13.089243 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m15:00:13.098241 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m15:00:13.100139 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 15:00:13.090236 => 15:00:13.099235
[0m15:00:13.100445 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m15:00:13.104542 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m15:00:13.105542 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:13.108539 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m15:00:13.175085 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 15:00:11.979350 => 15:00:13.174084
[0m15:00:13.175085 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33CEF3D0>]}
[0m15:00:13.176084 [info ] [Thread-2  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m15:00:13.177093 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m15:00:13.178090 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m15:00:13.179090 [info ] [Thread-2  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m15:00:13.180091 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m15:00:13.181092 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m15:00:13.185068 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m15:00:13.187122 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 15:00:13.181092 => 15:00:13.186175
[0m15:00:13.187122 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m15:00:13.190169 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m15:00:13.191168 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:13.192461 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m15:00:13.935022 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d3801fad-db28-4fd3-9a36-ed28e1c22273&page=queryresults
[0m15:00:14.072426 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f80489b1-b95f-49c9-8ddb-6a7d6cea53ba&page=queryresults
[0m15:00:14.377634 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 15:00:13.101539 => 15:00:14.376634
[0m15:00:14.378635 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33CB2D00>]}
[0m15:00:14.379634 [info ] [Thread-1  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m15:00:14.380928 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m15:00:14.382138 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:14.383132 [info ] [Thread-1  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m15:00:14.385137 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m15:00:14.386139 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:14.390146 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m15:00:14.391607 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 15:00:14.386139 => 15:00:14.390596
[0m15:00:14.391607 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:14.400596 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m15:00:14.401598 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:14.403599 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m15:00:14.497105 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 15:00:13.187122 => 15:00:14.496101
[0m15:00:14.498112 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33DA0E50>]}
[0m15:00:14.499121 [info ] [Thread-2  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.32s]
[0m15:00:14.501451 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m15:00:14.502445 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m15:00:14.503444 [info ] [Thread-2  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m15:00:14.505443 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m15:00:14.506443 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m15:00:14.513953 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m15:00:14.514950 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 15:00:14.506443 => 15:00:14.514950
[0m15:00:14.515884 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m15:00:14.518958 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m15:00:14.519873 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:14.519873 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m15:00:15.232187 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:eaf5830c-7b24-4c0a-815b-f11ccf9b4771&page=queryresults
[0m15:00:15.293967 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fffa3cce-90a4-4982-b78a-95fdd7808173&page=queryresults
[0m15:00:15.638206 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 15:00:14.515884 => 15:00:15.638206
[0m15:00:15.639141 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33D69AC0>]}
[0m15:00:15.639141 [info ] [Thread-2  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m15:00:15.640537 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m15:00:15.641666 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m15:00:15.641666 [info ] [Thread-2  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m15:00:15.642564 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto)
[0m15:00:15.643667 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m15:00:15.649677 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m15:00:15.652606 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 15:00:15.643667 => 15:00:15.651682
[0m15:00:15.652606 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m15:00:15.656632 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m15:00:15.657631 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:15.659633 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m15:00:15.717738 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 15:00:14.392603 => 15:00:15.716732
[0m15:00:15.718730 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33D244C0>]}
[0m15:00:15.720274 [info ] [Thread-1  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m15:00:15.722341 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m15:00:15.723329 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m15:00:15.724330 [info ] [Thread-1  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m15:00:15.726293 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto_fabricado)
[0m15:00:15.727293 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m15:00:15.734293 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m15:00:15.736290 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 15:00:15.728292 => 15:00:15.736290
[0m15:00:15.737330 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m15:00:15.741587 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m15:00:15.742582 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:15.744342 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m15:00:16.444454 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d2feda2f-e280-46b5-bb9b-7a6d2bb3dcf8&page=queryresults
[0m15:00:16.522690 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:60ce0134-14d4-42c6-9325-883aa06c169e&page=queryresults
[0m15:00:16.888305 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 15:00:15.653634 => 15:00:16.887296
[0m15:00:16.890580 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33E42CD0>]}
[0m15:00:16.891771 [info ] [Thread-2  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m15:00:16.894753 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m15:00:16.895751 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m15:00:16.896792 [info ] [Thread-2  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m15:00:16.897539 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m15:00:16.901060 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 15:00:15.737330 => 15:00:16.901060
[0m15:00:16.902094 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m15:00:16.902933 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33E79F70>]}
[0m15:00:16.908064 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m15:00:16.909996 [info ] [Thread-1  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m15:00:16.912376 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m15:00:16.913412 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m15:00:16.916376 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 15:00:16.903973 => 15:00:16.915422
[0m15:00:16.914413 [info ] [Thread-1  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m15:00:16.917369 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m15:00:16.918417 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.dm_produto)
[0m15:00:16.925628 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m15:00:16.926633 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m15:00:16.935055 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m15:00:16.936958 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:16.940320 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m15:00:16.982498 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 15:00:16.927631 => 15:00:16.981438
[0m15:00:16.983506 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m15:00:17.003314 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:18.013902 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m15:00:18.014897 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m15:00:18.103493 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:53effa25-fbcb-45ca-8296-0eb8aa1a4308&page=queryresults
[0m15:00:18.487045 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 15:00:16.919408 => 15:00:18.486045
[0m15:00:18.487045 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33D1CA60>]}
[0m15:00:18.487045 [info ] [Thread-2  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.59s]
[0m15:00:18.488945 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m15:00:18.633863 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6bd10cd3-566c-4776-bc41-fc55656bd1fe&page=queryresults
[0m15:00:21.158581 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 15:00:16.984496 => 15:00:21.157585
[0m15:00:21.159586 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33D73F40>]}
[0m15:00:21.160584 [info ] [Thread-1  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 4.24s]
[0m15:00:21.162572 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m15:00:21.164497 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m15:00:21.165532 [info ] [Thread-2  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m15:00:21.167531 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m15:00:21.168531 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m15:00:21.175976 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m15:00:21.178022 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 15:00:21.168531 => 15:00:21.178022
[0m15:00:21.179006 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m15:00:21.186566 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:21.880612 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m15:00:21.882835 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m15:00:22.637413 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:eb73432a-d05d-40cd-af7c-5a9e86948554&page=queryresults
[0m15:00:25.467924 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 15:00:21.180480 => 15:00:25.467924
[0m15:00:25.468915 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33E5EC10>]}
[0m15:00:25.468915 [info ] [Thread-2  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 4.30s]
[0m15:00:25.470368 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m15:00:25.472374 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m15:00:25.474481 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_compra
[0m15:00:25.473475 [info ] [Thread-1  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m15:00:25.477374 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m15:00:25.475482 [info ] [Thread-2  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m15:00:25.477374 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m15:00:25.478889 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m15:00:25.483900 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m15:00:25.484902 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_compra
[0m15:00:25.487900 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m15:00:25.488897 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 15:00:25.478889 => 15:00:25.488897
[0m15:00:25.488897 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m15:00:25.489897 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (compile): 15:00:25.484902 => 15:00:25.489897
[0m15:00:25.490898 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:25.490898 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_compra
[0m15:00:25.492900 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:26.146837 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m15:00:26.148762 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m15:00:26.168878 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m15:00:26.169878 [debug] [Thread-2  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m15:00:26.775523 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fdc4f7fb-8e70-4f74-9fbf-2c4978a11fd0&page=queryresults
[0m15:00:26.803024 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fe7c30dc-9ddf-4ae0-a1a7-b88bd99e7cd0&page=queryresults
[0m15:00:28.734478 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 15:00:25.489897 => 15:00:28.733479
[0m15:00:28.735477 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33D2BA00>]}
[0m15:00:28.736477 [info ] [Thread-1  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 3.26s]
[0m15:00:28.738478 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m15:00:28.738478 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m15:00:28.739476 [info ] [Thread-1  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m15:00:28.740477 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m15:00:28.740477 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m15:00:28.745475 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m15:00:28.746475 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 15:00:28.741477 => 15:00:28.746475
[0m15:00:28.747763 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m15:00:28.757567 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:29.338582 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (execute): 15:00:25.491899 => 15:00:29.338582
[0m15:00:29.340580 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA34F00B20>]}
[0m15:00:29.341540 [info ] [Thread-2  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 3.86s]
[0m15:00:29.342798 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_compra
[0m15:00:29.343832 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m15:00:29.343832 [info ] [Thread-2  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m15:00:29.345847 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m15:00:29.345847 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m15:00:29.352860 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m15:00:29.354769 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 15:00:29.346841 => 15:00:29.354769
[0m15:00:29.355765 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m15:00:29.358763 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:29.437881 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m15:00:29.439881 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m15:00:29.790045 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8ff16785-f878-43e4-b172-94badbdb0b15&page=queryresults
[0m15:00:30.190413 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m15:00:30.193985 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m15:00:30.796884 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0e161d2d-d427-4d59-b7b8-fecc418e40b4&page=queryresults
[0m15:00:31.711813 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 15:00:28.747763 => 15:00:31.711813
[0m15:00:31.712881 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA34E732E0>]}
[0m15:00:31.712881 [info ] [Thread-1  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 2.97s]
[0m15:00:31.713777 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m15:00:31.713777 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m15:00:31.714776 [info ] [Thread-1  ]: 20 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m15:00:31.714776 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m15:00:31.714776 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m15:00:31.717880 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m15:00:31.718779 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 15:00:31.715876 => 15:00:31.717880
[0m15:00:31.718779 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m15:00:31.719875 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:32.344561 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m15:00:32.346571 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m15:00:32.763327 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8ca6ed4e-952e-4180-9a66-8dd71fd258c3&page=queryresults
[0m15:00:33.316850 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 15:00:29.355765 => 15:00:33.315848
[0m15:00:33.317849 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33E558E0>]}
[0m15:00:33.318849 [info ] [Thread-2  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.97s]
[0m15:00:33.320849 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m15:00:33.321723 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m15:00:33.321723 [info ] [Thread-2  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m15:00:33.323140 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m15:00:33.324154 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m15:00:33.329151 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m15:00:33.330153 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 15:00:33.324154 => 15:00:33.330153
[0m15:00:33.331214 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m15:00:33.340522 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:34.085304 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m15:00:34.088302 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m15:00:34.566120 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:00171405-ad24-4855-b089-97aee61debbe&page=queryresults
[0m15:00:34.753515 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 15:00:31.718779 => 15:00:34.753515
[0m15:00:34.755518 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA34E9C4C0>]}
[0m15:00:34.756518 [info ] [Thread-1  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 3.04s]
[0m15:00:34.757517 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m15:00:34.758518 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m15:00:34.759615 [info ] [Thread-1  ]: 22 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m15:00:34.760732 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m15:00:34.761732 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m15:00:34.863269 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m15:00:34.864261 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 15:00:34.761732 => 15:00:34.864261
[0m15:00:34.864261 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m15:00:34.866258 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:35.764968 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m15:00:35.766979 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m15:00:36.382556 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b82c7948-13ab-41aa-9191-878427153da2&page=queryresults
[0m15:00:37.078627 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 15:00:33.331214 => 15:00:37.078627
[0m15:00:37.080624 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA34EA9580>]}
[0m15:00:37.081628 [info ] [Thread-2  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.5 KiB processed)[0m in 3.76s]
[0m15:00:37.083446 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m15:00:37.084499 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:00:37.085592 [info ] [Thread-2  ]: 23 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m15:00:37.086500 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m15:00:37.087498 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:00:37.093017 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m15:00:37.095019 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 15:00:37.087498 => 15:00:37.094018
[0m15:00:37.095019 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:00:37.098018 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:37.784250 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m15:00:37.787261 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m15:00:38.174246 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:818b2667-ac21-4565-84a1-497a430a6bdc&page=queryresults
[0m15:00:39.174489 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 15:00:34.864261 => 15:00:39.174489
[0m15:00:39.175490 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33D97A90>]}
[0m15:00:39.176492 [info ] [Thread-1  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 4.41s]
[0m15:00:39.176492 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m15:00:39.177494 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m15:00:39.178490 [info ] [Thread-1  ]: 24 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m15:00:39.178490 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m15:00:39.179489 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m15:00:39.183487 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m15:00:39.183487 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 15:00:39.179489 => 15:00:39.183487
[0m15:00:39.184487 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m15:00:39.186487 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:39.860521 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m15:00:39.862545 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m15:00:40.364741 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 15:00:37.096018 => 15:00:40.364741
[0m15:00:40.365737 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33CD7C70>]}
[0m15:00:40.491522 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:91ed506a-1ccc-47b5-9242-25bd5065eba4&page=queryresults
[0m15:00:41.256425 [info ] [Thread-2  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.6 KiB processed)[0m in 3.28s]
[0m15:00:41.258328 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m15:00:41.260698 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m15:00:41.261812 [info ] [Thread-2  ]: 25 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m15:00:41.262704 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m15:00:41.263807 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m15:00:41.269809 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m15:00:41.272064 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 15:00:41.264807 => 15:00:41.271158
[0m15:00:41.272064 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m15:00:41.275159 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m15:00:42.158771 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m15:00:42.161082 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m15:00:42.548594 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1e2355fe-0569-480a-bcf7-9539cfb58e99&page=queryresults
[0m15:00:42.983819 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 15:00:39.184487 => 15:00:42.982821
[0m15:00:42.985824 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33D763D0>]}
[0m15:00:42.986824 [info ] [Thread-1  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 3.81s]
[0m15:00:42.988776 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m15:00:45.078475 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 15:00:41.272064 => 15:00:45.077484
[0m15:00:45.079469 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33E55BB0>]}
[0m15:00:45.080477 [info ] [Thread-2  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 3.82s]
[0m15:00:45.082832 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m15:00:45.083736 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m15:00:45.084859 [info ] [Thread-1  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m15:00:45.086972 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m15:00:45.086972 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m15:00:45.093632 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:00:45.095541 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 15:00:45.087975 => 15:00:45.094633
[0m15:00:45.095541 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m15:00:45.098536 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m15:00:45.721203 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:00:45.723087 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_produto_bling
          ,qt_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    where ds_status_compra in ('EM ABERTO')
)

, cte_joins as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,a.qt_estoque_minimo                as qt_estoque_minimo
         ,a.qt_estoque_atual                 as qt_estoque_atual
         ,a.vl_custo_total                   as vl_custo_total
         ,a.vl_preco_venda                   as vl_preco_venda
         ,sum(b.qt_item)                     as qt_item_compra_pendente
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m15:00:46.289123 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8861fa4c-0f9c-4720-9c8c-237dfcb39d45&page=queryresults
[0m15:00:46.644409 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: dt_prevista_compra at [126:12]')
[0m15:00:47.607170 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:147cd737-9420-493c-8ae1-bad5ae5f0d23&page=queryresults
[0m15:00:48.046481 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:147cd737-9420-493c-8ae1-bad5ae5f0d23&page=queryresults
[0m15:00:48.048378 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 15:00:45.095541 => 15:00:48.048378
[0m15:00:48.055853 [debug] [Thread-1  ]: Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Unrecognized name: dt_prevista_compra at [126:12]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m15:00:48.056966 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3eab1b79-df3b-440e-9f28-a845f0ad6fd3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33E221C0>]}
[0m15:00:48.056966 [error] [Thread-1  ]: 26 of 26 ERROR creating sql table model dbt_dw_az.tb_estoque_produto_base ...... [[31mERROR[0m in 2.97s]
[0m15:00:48.058869 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m15:00:48.061336 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:00:48.062345 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:00:48.062345 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:00:48.063344 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m15:00:48.063344 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:00:48.063344 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m15:00:48.064346 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m15:00:48.064346 [info ] [MainThread]: 
[0m15:00:48.065346 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 41.89 seconds (41.89s).
[0m15:00:48.071707 [debug] [MainThread]: Command end result
[0m15:00:48.091771 [info ] [MainThread]: 
[0m15:00:48.093061 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:00:48.093742 [info ] [MainThread]: 
[0m15:00:48.093742 [error] [MainThread]:   Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Unrecognized name: dt_prevista_compra at [126:12]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m15:00:48.095136 [info ] [MainThread]: 
[0m15:00:48.096200 [info ] [MainThread]: Done. PASS=25 WARN=0 ERROR=1 SKIP=0 TOTAL=26
[0m15:00:48.096621 [debug] [MainThread]: Command `dbt run` failed at 15:00:48.096621 after 43.04 seconds
[0m15:00:48.097774 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA2F2C94C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA32C42250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001AA33CAA9A0>]}
[0m15:00:48.097774 [debug] [MainThread]: Flushing usage events
[0m15:22:25.814666 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E238E2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E228659D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E22865B80>]}


============================== 15:22:25.814666 | 49cbecca-ac7d-427d-9d46-8faebcf7cfe2 ==============================
[0m15:22:25.814666 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:22:25.814666 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'invocation_command': 'dbt run --models tb_estoque_produto_base', 'introspect': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m15:22:26.254699 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '49cbecca-ac7d-427d-9d46-8faebcf7cfe2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E2284C130>]}
[0m15:22:26.319733 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '49cbecca-ac7d-427d-9d46-8faebcf7cfe2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E2285E280>]}
[0m15:22:26.319733 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:22:26.329135 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:22:26.379580 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:22:26.384676 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:22:26.389406 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '49cbecca-ac7d-427d-9d46-8faebcf7cfe2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E27257FA0>]}
[0m15:22:26.394728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '49cbecca-ac7d-427d-9d46-8faebcf7cfe2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E2716EFD0>]}
[0m15:22:26.394728 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:22:26.394728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49cbecca-ac7d-427d-9d46-8faebcf7cfe2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E2716E0D0>]}
[0m15:22:26.394728 [info ] [MainThread]: 
[0m15:22:26.404489 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:22:26.405744 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:22:26.405744 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:22:27.224567 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m15:22:27.224567 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:22:27.224567 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m15:22:27.231733 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:22:27.868733 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m15:22:27.868733 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:22:27.916366 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m15:22:27.916366 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:22:28.574693 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '49cbecca-ac7d-427d-9d46-8faebcf7cfe2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E27263CD0>]}
[0m15:22:28.574693 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:22:28.574693 [info ] [MainThread]: 
[0m15:22:28.574693 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m15:22:28.574693 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_estoque_produto_base ................. [RUN]
[0m15:22:28.574693 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_estoque_produto_base'
[0m15:22:28.574693 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m15:22:28.598183 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:22:28.599185 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 15:22:28.574693 => 15:22:28.598183
[0m15:22:28.599185 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m15:22:28.618815 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:22:29.292357 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:22:29.294417 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_produto_bling
          ,qt_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    where ds_status_compra in ('EM ABERTO')
)

, cte_joins as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,a.qt_estoque_minimo                as qt_estoque_minimo
         ,a.qt_estoque_atual                 as qt_estoque_atual
         ,a.vl_custo_total                   as vl_custo_total
         ,a.vl_preco_venda                   as vl_preco_venda
         ,sum(b.qt_item)                     as qt_item_compra_pendente
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m15:22:30.122291 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9590e9cd-2162-406a-afa6-3dd6cc6c30e8&page=queryresults
[0m15:22:30.575872 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: dt_prevista_compra at [126:12]')
[0m15:22:32.134968 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:492e9407-e2bc-45ba-9816-08a08a481d49&page=queryresults
[0m15:22:32.518867 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:492e9407-e2bc-45ba-9816-08a08a481d49&page=queryresults
[0m15:22:32.523292 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 15:22:28.599185 => 15:22:32.522741
[0m15:22:32.539152 [debug] [Thread-1  ]: Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Unrecognized name: dt_prevista_compra at [126:12]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m15:22:32.541155 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '49cbecca-ac7d-427d-9d46-8faebcf7cfe2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E2830DFA0>]}
[0m15:22:32.543413 [error] [Thread-1  ]: 1 of 1 ERROR creating sql table model dbt_dw_az.tb_estoque_produto_base ........ [[31mERROR[0m in 3.97s]
[0m15:22:32.547172 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m15:22:32.554709 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:22:32.555734 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:22:32.557739 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m15:22:32.558781 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m15:22:32.560782 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m15:22:32.561779 [info ] [MainThread]: 
[0m15:22:32.564662 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 6.16 seconds (6.16s).
[0m15:22:32.568297 [debug] [MainThread]: Command end result
[0m15:22:32.619128 [info ] [MainThread]: 
[0m15:22:32.623220 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m15:22:32.624748 [info ] [MainThread]: 
[0m15:22:32.624748 [error] [MainThread]:   Database Error in model tb_estoque_produto_base (models\3.az\tb_estoque_produto_base.sql)
  Unrecognized name: dt_prevista_compra at [126:12]
  compiled Code at target\run\shibaribrasil\models\3.az\tb_estoque_produto_base.sql
[0m15:22:32.624748 [info ] [MainThread]: 
[0m15:22:32.634682 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m15:22:32.642551 [debug] [MainThread]: Command `dbt run` failed at 15:22:32.638483 after 6.88 seconds
[0m15:22:32.644831 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E238E2460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E2285E280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020E27263E20>]}
[0m15:22:32.644831 [debug] [MainThread]: Flushing usage events
[0m15:32:45.865148 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E55B1E6460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E55A1699D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E55A169B80>]}


============================== 15:32:45.868149 | 71e0d908-c9e3-4b9e-9d4b-60f358c5a62d ==============================
[0m15:32:45.868149 [info ] [MainThread]: Running with dbt=1.7.4
[0m15:32:45.869184 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt run --models tb_estoque_produto_base', 'send_anonymous_usage_stats': 'True'}
[0m15:32:46.342886 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '71e0d908-c9e3-4b9e-9d4b-60f358c5a62d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E55D32CB80>]}
[0m15:32:46.412586 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '71e0d908-c9e3-4b9e-9d4b-60f358c5a62d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E55E7EA130>]}
[0m15:32:46.414636 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m15:32:46.420820 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m15:32:46.497296 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:32:46.498296 [debug] [MainThread]: Partial parsing: updated file: shibaribrasil://models\3.az\tb_estoque_produto_base.sql
[0m15:32:46.605742 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '71e0d908-c9e3-4b9e-9d4b-60f358c5a62d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E55ECFECD0>]}
[0m15:32:46.617971 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '71e0d908-c9e3-4b9e-9d4b-60f358c5a62d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E55EA5BB20>]}
[0m15:32:46.618973 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m15:32:46.618973 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '71e0d908-c9e3-4b9e-9d4b-60f358c5a62d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E55EA5BC40>]}
[0m15:32:46.620002 [info ] [MainThread]: 
[0m15:32:46.621033 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:32:46.622961 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m15:32:46.622961 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:32:47.574742 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m15:32:47.577777 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:32:47.578773 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m15:32:47.579772 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:32:48.521445 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m15:32:48.522440 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:32:48.558005 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m15:32:48.558005 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:32:49.202485 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '71e0d908-c9e3-4b9e-9d4b-60f358c5a62d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E55E8B1F70>]}
[0m15:32:49.204460 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m15:32:49.206096 [info ] [MainThread]: 
[0m15:32:49.212587 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m15:32:49.213602 [info ] [Thread-1  ]: 1 of 1 START sql table model dbt_dw_az.tb_estoque_produto_base ................. [RUN]
[0m15:32:49.214586 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_estoque_produto_base'
[0m15:32:49.216084 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m15:32:49.228608 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:32:49.229602 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 15:32:49.216084 => 15:32:49.229602
[0m15:32:49.229602 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m15:32:49.240227 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m15:32:49.844655 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m15:32:49.845168 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    where ds_status_compra in ('EM ABERTO')
)

, cte_joins as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,a.qt_estoque_minimo                as qt_estoque_minimo
         ,a.qt_estoque_atual                 as qt_estoque_atual
         ,a.vl_custo_total                   as vl_custo_total
         ,a.vl_preco_venda                   as vl_preco_venda
         ,sum(b.qt_item)                     as qt_item_compra_pendente
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m15:32:50.629249 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ef8be0a2-59c3-41ac-b5c3-43abc71aa480&page=queryresults
[0m15:32:54.759486 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 15:32:49.229602 => 15:32:54.758405
[0m15:32:54.761452 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '71e0d908-c9e3-4b9e-9d4b-60f358c5a62d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E55ED5CFA0>]}
[0m15:32:54.762455 [info ] [Thread-1  ]: 1 of 1 OK created sql table model dbt_dw_az.tb_estoque_produto_base ............ [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 5.55s]
[0m15:32:54.764982 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m15:32:54.769032 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:32:54.770028 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m15:32:54.771040 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m15:32:54.772035 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m15:32:54.772983 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m15:32:54.772983 [info ] [MainThread]: 
[0m15:32:54.775569 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 8.15 seconds (8.15s).
[0m15:32:54.778693 [debug] [MainThread]: Command end result
[0m15:32:54.807066 [info ] [MainThread]: 
[0m15:32:54.811354 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:32:54.813342 [info ] [MainThread]: 
[0m15:32:54.814878 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m15:32:54.821471 [debug] [MainThread]: Command `dbt run` succeeded at 15:32:54.820473 after 9.03 seconds
[0m15:32:54.823480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E55B1E6460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E55E7EA130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E55FD6BDF0>]}
[0m15:32:54.826010 [debug] [MainThread]: Flushing usage events
[0m16:00:04.173121 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B128A03430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12798F6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12798FE20>]}


============================== 16:00:04.173121 | a00a4386-0f7a-4e16-9655-eabb94be5d54 ==============================
[0m16:00:04.173121 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:00:04.178885 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --exclude tag:snaps', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:00:04.737791 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B1279759A0>]}
[0m16:00:04.800708 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12BF58520>]}
[0m16:00:04.800708 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:00:04.800708 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:00:04.896507 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:00:04.896507 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:00:04.901072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12C365F10>]}
[0m16:00:04.912658 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12C27B8E0>]}
[0m16:00:04.912658 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:00:04.912658 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12C27BB80>]}
[0m16:00:04.912658 [info ] [MainThread]: 
[0m16:00:04.912658 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:00:04.912658 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:00:04.912658 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:04.912658 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:00:04.912658 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:05.794876 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:06.596778 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m16:00:06.603924 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:06.603924 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:00:06.612795 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:07.309281 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m16:00:07.309281 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:07.388804 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m16:00:07.388804 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:08.132489 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12C0EAE80>]}
[0m16:00:08.136470 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:00:08.138655 [info ] [MainThread]: 
[0m16:00:08.146904 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:08.147901 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m16:00:08.147901 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m16:00:08.147901 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m16:00:08.152470 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m16:00:08.154708 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m16:00:08.154708 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m16:00:08.163880 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m16:00:08.163880 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:08.166875 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m16:00:08.167871 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 16:00:08.154708 => 16:00:08.167871
[0m16:00:08.167871 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m16:00:08.190737 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m16:00:08.190737 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 16:00:08.163880 => 16:00:08.190737
[0m16:00:08.191756 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:08.194758 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m16:00:08.195752 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m16:00:08.196755 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m16:00:08.219167 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:00:08.220164 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m16:00:09.022064 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:dfe98818-75d1-4001-a6d3-abf4232c4844&page=queryresults
[0m16:00:09.041485 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:776f6ad2-515e-41ac-afc4-e09915feb1ca&page=queryresults
[0m16:00:09.492382 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 16:00:08.191756 => 16:00:09.492382
[0m16:00:09.492382 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D48AB50>]}
[0m16:00:09.492382 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.34s]
[0m16:00:09.492382 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m16:00:09.492382 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m16:00:09.492382 [info ] [Thread-1  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m16:00:09.510462 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 16:00:08.167871 => 16:00:09.510462
[0m16:00:09.510462 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m16:00:09.510462 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12BFFF310>]}
[0m16:00:09.510462 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m16:00:09.510462 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m16:00:09.523066 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m16:00:09.523066 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m16:00:09.523066 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_compra
[0m16:00:09.523066 [info ] [Thread-2  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m16:00:09.523066 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_compra)
[0m16:00:09.523066 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_compra
[0m16:00:09.539095 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m16:00:09.539095 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 16:00:09.510462 => 16:00:09.539095
[0m16:00:09.539095 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m16:00:09.539095 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m16:00:09.539095 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (compile): 16:00:09.523066 => 16:00:09.539095
[0m16:00:09.539095 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_compra
[0m16:00:09.554902 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m16:00:09.554902 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:09.554902 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:09.554902 [debug] [Thread-2  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m16:00:09.571029 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m16:00:10.557724 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e45cf76c-a9ca-4742-9065-16dae9d2a9ce&page=queryresults
[0m16:00:10.724523 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9a1975b5-9737-4091-8024-de719903c276&page=queryresults
[0m16:00:10.963421 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (execute): 16:00:09.539095 => 16:00:10.963421
[0m16:00:10.963421 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D4043D0>]}
[0m16:00:10.963421 [info ] [Thread-2  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.44s]
[0m16:00:10.963421 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_compra
[0m16:00:10.963421 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m16:00:10.963421 [info ] [Thread-2  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m16:00:10.963421 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_forma_pagamento)
[0m16:00:10.963421 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m16:00:10.974167 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m16:00:10.974167 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 16:00:10.963421 => 16:00:10.974167
[0m16:00:10.982393 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m16:00:10.984765 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m16:00:10.984765 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:10.984765 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m16:00:11.166362 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 16:00:09.539095 => 16:00:11.165397
[0m16:00:11.167251 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D4238B0>]}
[0m16:00:11.167251 [info ] [Thread-1  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.66s]
[0m16:00:11.173481 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m16:00:11.175524 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m16:00:11.176556 [info ] [Thread-1  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m16:00:11.178562 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m16:00:11.179561 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m16:00:11.185793 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m16:00:11.187843 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 16:00:11.179561 => 16:00:11.187843
[0m16:00:11.188836 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m16:00:11.198272 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m16:00:11.199326 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:11.201630 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m16:00:11.738896 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8bed5fe1-ce67-4610-80ed-a1cf8d229c6c&page=queryresults
[0m16:00:11.970090 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:48107df4-9540-47ba-8582-6f8f14c810e3&page=queryresults
[0m16:00:12.144607 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 16:00:10.982393 => 16:00:12.144607
[0m16:00:12.146608 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D4CC1F0>]}
[0m16:00:12.147611 [info ] [Thread-2  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m16:00:12.149627 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m16:00:12.150619 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_compra
[0m16:00:12.151614 [info ] [Thread-2  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m16:00:12.152460 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m16:00:12.153806 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m16:00:12.160809 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m16:00:12.163577 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 16:00:12.153806 => 16:00:12.162714
[0m16:00:12.163577 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m16:00:12.168644 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m16:00:12.169637 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:12.171639 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m16:00:12.374461 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 16:00:11.188836 => 16:00:12.374461
[0m16:00:12.376466 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D4B67C0>]}
[0m16:00:12.377456 [info ] [Thread-1  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m16:00:12.379452 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m16:00:12.379452 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m16:00:12.380468 [info ] [Thread-1  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m16:00:12.382369 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m16:00:12.383285 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m16:00:12.389614 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m16:00:12.392328 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 16:00:12.383285 => 16:00:12.391601
[0m16:00:12.392328 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m16:00:12.397519 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m16:00:12.398520 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:12.400534 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m16:00:12.919429 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c01f8a11-d0cb-4d98-a851-2e0cf410f69f&page=queryresults
[0m16:00:13.184893 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:875da829-55b3-4a84-8d2e-bd2d3464248e&page=queryresults
[0m16:00:13.342137 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 16:00:12.164599 => 16:00:13.341140
[0m16:00:13.343556 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D3FE1F0>]}
[0m16:00:13.344604 [info ] [Thread-2  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m16:00:13.347055 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m16:00:13.347055 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m16:00:13.348120 [info ] [Thread-2  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m16:00:13.349129 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m16:00:13.350039 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m16:00:13.354086 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m16:00:13.355075 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 16:00:13.350039 => 16:00:13.355075
[0m16:00:13.355075 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m16:00:13.358032 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m16:00:13.358979 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:13.360256 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m16:00:13.555506 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 16:00:12.393530 => 16:00:13.554500
[0m16:00:13.556499 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D4238B0>]}
[0m16:00:13.558495 [info ] [Thread-1  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m16:00:13.559511 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m16:00:13.560490 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m16:00:13.561490 [info ] [Thread-1  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m16:00:13.563738 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m16:00:13.564731 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m16:00:13.571728 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m16:00:13.573857 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 16:00:13.564731 => 16:00:13.572827
[0m16:00:13.573857 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m16:00:13.577903 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m16:00:13.578900 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:13.579875 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m16:00:14.063728 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:035ee2b9-19b2-4ecf-bbdd-cbb97c81d910&page=queryresults
[0m16:00:14.330791 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1ad020c5-bd1f-4970-9ccb-d43de5d9435c&page=queryresults
[0m16:00:14.452402 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 16:00:13.356021 => 16:00:14.451720
[0m16:00:14.454640 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D4C7250>]}
[0m16:00:14.455730 [info ] [Thread-2  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.11s]
[0m16:00:14.458694 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m16:00:14.459701 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m16:00:14.460722 [info ] [Thread-2  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m16:00:14.462536 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m16:00:14.462536 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m16:00:14.470891 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m16:00:14.473889 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 16:00:14.463899 => 16:00:14.472531
[0m16:00:14.474897 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m16:00:14.481890 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m16:00:14.484089 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:14.487076 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m16:00:14.710132 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 16:00:13.573857 => 16:00:14.710132
[0m16:00:14.712131 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D4C75E0>]}
[0m16:00:14.713875 [info ] [Thread-1  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.15s]
[0m16:00:14.715965 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m16:00:14.716965 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m16:00:14.717967 [info ] [Thread-1  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m16:00:14.719972 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m16:00:14.720967 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m16:00:14.728004 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m16:00:14.732005 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 16:00:14.720967 => 16:00:14.731006
[0m16:00:14.732952 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m16:00:14.737171 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m16:00:14.740077 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:14.743372 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m16:00:15.174237 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:686ce60b-78a0-42a4-b559-bbceaa239f9e&page=queryresults
[0m16:00:15.502026 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:055bd0f2-c002-4659-93f2-4fe61a5b1517&page=queryresults
[0m16:00:15.565256 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 16:00:14.474897 => 16:00:15.565256
[0m16:00:15.565256 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D57E1C0>]}
[0m16:00:15.565256 [info ] [Thread-2  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.10s]
[0m16:00:15.565256 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m16:00:15.565256 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m16:00:15.565256 [info ] [Thread-2  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m16:00:15.581404 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m16:00:15.581404 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m16:00:15.581404 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m16:00:15.581404 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 16:00:15.581404 => 16:00:15.581404
[0m16:00:15.581404 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m16:00:15.597199 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m16:00:15.597199 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:15.597199 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m16:00:15.888547 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 16:00:14.732952 => 16:00:15.872572
[0m16:00:15.888547 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D57E7F0>]}
[0m16:00:15.888547 [info ] [Thread-1  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m16:00:15.888547 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m16:00:15.888547 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m16:00:15.888547 [info ] [Thread-1  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m16:00:15.888547 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.dm_produto)
[0m16:00:15.888547 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m16:00:15.904307 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m16:00:15.904307 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 16:00:15.888547 => 16:00:15.904307
[0m16:00:15.904307 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m16:00:15.920122 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:16.432078 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:309f802d-1b45-4b8f-b849-8a9c759fd9c9&page=queryresults
[0m16:00:16.750821 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m16:00:16.750821 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m16:00:16.863011 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 16:00:15.581404 => 16:00:16.863011
[0m16:00:16.863011 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12E56A1C0>]}
[0m16:00:16.863011 [info ] [Thread-2  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m16:00:16.863011 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m16:00:17.344797 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:312e8a6f-76ed-400e-b3fb-7a9b90aa8e72&page=queryresults
[0m16:00:19.880264 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 16:00:15.904307 => 16:00:19.880264
[0m16:00:19.880264 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D5434F0>]}
[0m16:00:19.880264 [info ] [Thread-1  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 3.99s]
[0m16:00:19.880264 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m16:00:19.880264 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m16:00:19.880264 [info ] [Thread-2  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m16:00:19.880264 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m16:00:19.880264 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m16:00:19.896167 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m16:00:19.896167 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 16:00:19.880264 => 16:00:19.896167
[0m16:00:19.896167 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m16:00:19.912249 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:20.535156 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m16:00:20.537897 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m16:00:21.188636 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8eb9edc9-2588-4089-af8c-5f9bd7d3a284&page=queryresults
[0m16:00:23.434711 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 16:00:19.896167 => 16:00:23.434711
[0m16:00:23.436708 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D4F7F70>]}
[0m16:00:23.437709 [info ] [Thread-2  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 3.56s]
[0m16:00:23.439718 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m16:00:23.441644 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m16:00:23.442375 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_compra
[0m16:00:23.442375 [info ] [Thread-1  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m16:00:23.445153 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m16:00:23.445153 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m16:00:23.445153 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m16:00:23.442375 [info ] [Thread-2  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m16:00:23.445153 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m16:00:23.445153 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_compra
[0m16:00:23.454291 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m16:00:23.457600 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 16:00:23.445153 => 16:00:23.456372
[0m16:00:23.457600 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m16:00:23.460683 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:23.476700 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (compile): 16:00:23.445153 => 16:00:23.476700
[0m16:00:23.487755 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_compra
[0m16:00:23.489700 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:24.132953 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m16:00:24.137947 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m16:00:24.165148 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m16:00:24.168088 [debug] [Thread-2  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m16:00:24.741232 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7607e852-a1e9-4dc0-8e3c-6281ea6a47c3&page=queryresults
[0m16:00:24.775454 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:838063d6-92e8-4ef2-bcf9-31cafdb9478c&page=queryresults
[0m16:00:26.993522 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 16:00:23.458673 => 16:00:26.993522
[0m16:00:26.993522 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12E585070>]}
[0m16:00:26.993522 [info ] [Thread-1  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 3.55s]
[0m16:00:27.002853 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m16:00:27.003921 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m16:00:27.004930 [info ] [Thread-1  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m16:00:27.006924 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m16:00:27.006924 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m16:00:27.013366 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m16:00:27.014407 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 16:00:27.006924 => 16:00:27.014407
[0m16:00:27.014407 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m16:00:27.021280 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:27.688701 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m16:00:27.690598 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m16:00:28.095575 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bb6ba32f-01fd-48eb-969b-8ac832dadded&page=queryresults
[0m16:00:28.543554 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (execute): 16:00:23.487755 => 16:00:28.542321
[0m16:00:28.544564 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D547AF0>]}
[0m16:00:28.545562 [info ] [Thread-2  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 5.10s]
[0m16:00:28.547566 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_compra
[0m16:00:28.548565 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m16:00:28.549560 [info ] [Thread-2  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m16:00:28.552356 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m16:00:28.553640 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m16:00:28.562341 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m16:00:28.563614 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 16:00:28.553640 => 16:00:28.563614
[0m16:00:28.563614 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m16:00:28.565610 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:29.344040 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m16:00:29.347126 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m16:00:29.983929 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f3b1b6b6-d505-4ca2-86ef-b223183979b6&page=queryresults
[0m16:00:30.040738 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 16:00:27.015363 => 16:00:30.040738
[0m16:00:30.042435 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D4F7F40>]}
[0m16:00:30.043668 [info ] [Thread-1  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 3.04s]
[0m16:00:30.045758 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m16:00:30.046759 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m16:00:30.047779 [info ] [Thread-1  ]: 20 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m16:00:30.048764 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m16:00:30.049761 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m16:00:30.057791 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m16:00:30.058793 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 16:00:30.050757 => 16:00:30.058793
[0m16:00:30.060309 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m16:00:30.063717 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:30.697040 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m16:00:30.699038 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m16:00:31.002458 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d192d025-5244-4faf-8a90-eda10cf40a87&page=queryresults
[0m16:00:32.786144 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 16:00:28.563614 => 16:00:32.786144
[0m16:00:32.786144 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12E597250>]}
[0m16:00:32.796676 [info ] [Thread-2  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.24s]
[0m16:00:32.797525 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m16:00:32.797525 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m16:00:32.798736 [info ] [Thread-2  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m16:00:32.799641 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m16:00:32.799641 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m16:00:32.803165 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m16:00:32.805445 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 16:00:32.799641 => 16:00:32.804334
[0m16:00:32.806461 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m16:00:32.819962 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:32.914243 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 16:00:30.061427 => 16:00:32.914243
[0m16:00:32.914243 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D4238B0>]}
[0m16:00:32.914243 [info ] [Thread-1  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 2.87s]
[0m16:00:32.914243 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m16:00:32.914243 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m16:00:32.914243 [info ] [Thread-1  ]: 22 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m16:00:32.929957 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m16:00:32.929957 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m16:00:32.929957 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m16:00:32.929957 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 16:00:32.929957 => 16:00:32.929957
[0m16:00:32.929957 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m16:00:32.946047 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:33.432326 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m16:00:33.434593 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m16:00:33.527079 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m16:00:33.530179 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m16:00:33.811872 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c1b9ecd7-8e4f-492b-9a6f-c6f164ffb986&page=queryresults
[0m16:00:34.244857 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:be99da92-95be-4cd1-bf7f-1b091b168b72&page=queryresults
[0m16:00:36.284200 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 16:00:32.806461 => 16:00:36.284200
[0m16:00:36.288240 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D43A460>]}
[0m16:00:36.290262 [info ] [Thread-2  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.5 KiB processed)[0m in 3.49s]
[0m16:00:36.290262 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m16:00:36.292281 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m16:00:36.294303 [info ] [Thread-2  ]: 23 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m16:00:36.296072 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m16:00:36.296072 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m16:00:36.296072 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m16:00:36.296072 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 16:00:36.296072 => 16:00:36.296072
[0m16:00:36.296072 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m16:00:36.296072 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:36.967059 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m16:00:36.967059 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m16:00:37.380274 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7149f287-d026-482b-85f4-e82ba665739b&page=queryresults
[0m16:00:38.848868 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 16:00:32.929957 => 16:00:38.848868
[0m16:00:38.848868 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12E58E280>]}
[0m16:00:38.848868 [info ] [Thread-1  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 5.93s]
[0m16:00:38.848868 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m16:00:38.848868 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m16:00:38.848868 [info ] [Thread-1  ]: 24 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m16:00:38.848868 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m16:00:38.865000 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m16:00:38.865000 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m16:00:38.865000 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 16:00:38.865000 => 16:00:38.865000
[0m16:00:38.865000 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m16:00:38.865000 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:39.462479 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m16:00:39.466529 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m16:00:39.535041 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 16:00:36.296072 => 16:00:39.535041
[0m16:00:39.535041 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12E62F400>]}
[0m16:00:40.160557 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ce24c764-81a3-473b-adf8-9e194fef9721&page=queryresults
[0m16:00:40.304701 [info ] [Thread-2  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.6 KiB processed)[0m in 3.24s]
[0m16:00:40.304701 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m16:00:40.304701 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m16:00:40.304701 [info ] [Thread-2  ]: 25 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m16:00:40.304701 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m16:00:40.304701 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m16:00:40.320932 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m16:00:40.320932 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 16:00:40.304701 => 16:00:40.320932
[0m16:00:40.320932 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m16:00:40.320932 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m16:00:41.200901 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m16:00:41.203542 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m16:00:41.599825 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3fbc98e0-fc6b-4610-be62-05bb2aad73ee&page=queryresults
[0m16:00:43.032285 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 16:00:38.865000 => 16:00:43.032285
[0m16:00:43.034303 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12E5DAE50>]}
[0m16:00:43.034303 [info ] [Thread-1  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 4.19s]
[0m16:00:43.034303 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m16:00:44.051405 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 16:00:40.320932 => 16:00:44.051405
[0m16:00:44.051405 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12E64C2B0>]}
[0m16:00:44.051405 [info ] [Thread-2  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 3.75s]
[0m16:00:44.051405 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m16:00:44.051405 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m16:00:44.067190 [info ] [Thread-1  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m16:00:44.067190 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m16:00:44.067190 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m16:00:44.067190 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m16:00:44.067190 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 16:00:44.067190 => 16:00:44.067190
[0m16:00:44.067190 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m16:00:44.083276 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m16:00:44.725366 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m16:00:44.725366 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    where ds_status_compra in ('EM ABERTO')
)

, cte_joins as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,a.qt_estoque_minimo                as qt_estoque_minimo
         ,a.qt_estoque_atual                 as qt_estoque_atual
         ,a.vl_custo_total                   as vl_custo_total
         ,a.vl_preco_venda                   as vl_preco_venda
         ,sum(b.qt_item)                     as qt_item_compra_pendente
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m16:00:45.334885 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:63fc0ae5-34fa-4f23-a44f-6ee69da7ddec&page=queryresults
[0m16:00:48.352298 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 16:00:44.083276 => 16:00:48.352298
[0m16:00:48.354495 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a00a4386-0f7a-4e16-9655-eabb94be5d54', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12D4C3460>]}
[0m16:00:48.355924 [info ] [Thread-1  ]: 26 of 26 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 4.29s]
[0m16:00:48.357918 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m16:00:48.361907 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:00:48.362446 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:00:48.363742 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:00:48.364742 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:00:48.364742 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m16:00:48.365741 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m16:00:48.366740 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m16:00:48.366740 [info ] [MainThread]: 
[0m16:00:48.368739 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 43.45 seconds (43.45s).
[0m16:00:48.376360 [debug] [MainThread]: Command end result
[0m16:00:48.399251 [info ] [MainThread]: 
[0m16:00:48.400250 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:00:48.400250 [info ] [MainThread]: 
[0m16:00:48.401251 [info ] [MainThread]: Done. PASS=26 WARN=0 ERROR=0 SKIP=0 TOTAL=26
[0m16:00:48.403422 [debug] [MainThread]: Command `dbt run` succeeded at 16:00:48.403422 after 44.28 seconds
[0m16:00:48.404419 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B128A03430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12C0CD1C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001B12C365F40>]}
[0m16:00:48.404419 [debug] [MainThread]: Flushing usage events
[0m16:00:51.811784 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9B8BF3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9B7B77670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9B7B77D90>]}


============================== 16:00:51.816657 | ffd17f35-3447-49a7-b816-f232ab210c91 ==============================
[0m16:00:51.816657 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:00:51.817658 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'invocation_command': 'dbt snapshot', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m16:00:52.382917 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ffd17f35-3447-49a7-b816-f232ab210c91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9B7B777C0>]}
[0m16:00:52.442058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ffd17f35-3447-49a7-b816-f232ab210c91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9BC194130>]}
[0m16:00:52.442058 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:00:52.448393 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:00:52.501500 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:00:52.501500 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:00:52.505516 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ffd17f35-3447-49a7-b816-f232ab210c91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9BC554E20>]}
[0m16:00:52.516799 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ffd17f35-3447-49a7-b816-f232ab210c91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9BC46A970>]}
[0m16:00:52.516799 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:00:52.516799 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ffd17f35-3447-49a7-b816-f232ab210c91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9BC46A910>]}
[0m16:00:52.516799 [info ] [MainThread]: 
[0m16:00:52.516799 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:00:52.516799 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:00:52.516799 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:53.362011 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m16:00:53.362011 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:53.362011 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m16:00:53.368635 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:00:54.017197 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m16:00:54.017197 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:54.083411 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m16:00:54.083411 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:00:54.766529 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ffd17f35-3447-49a7-b816-f232ab210c91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9BC2D3130>]}
[0m16:00:54.768759 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:00:54.769758 [info ] [MainThread]: 
[0m16:00:54.780615 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m16:00:54.782601 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m16:00:54.783361 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m16:00:54.783361 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m16:00:54.815619 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 16:00:54.783361 => 16:00:54.814610
[0m16:00:54.816609 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m16:00:54.888321 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:00:54.888321 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m16:00:55.671233 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:245430a0-db86-47c5-a679-225fac4bddb7&page=queryresults
[0m16:00:56.762155 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m16:00:57.218736 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:aa3604ec-5d0e-4b1f-b385-8f1706772f3e&page=queryresults
[0m16:00:59.907471 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m16:01:00.625547 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m16:01:00.629123 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m16:01:01.071426 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5fbc1097-53dc-4f8a-8a5e-c45515c2c119&page=queryresults
[0m16:01:03.438785 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 16:00:54.817617 => 16:01:03.438785
[0m16:01:03.438785 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ffd17f35-3447-49a7-b816-f232ab210c91', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9BD626C40>]}
[0m16:01:03.442775 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 106.5 KiB processed)[0m in 8.66s]
[0m16:01:03.442775 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m16:01:03.442775 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:01:03.442775 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:01:03.442775 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m16:01:03.442775 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m16:01:03.442775 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m16:01:03.442775 [info ] [MainThread]: 
[0m16:01:03.442775 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 10.93 seconds (10.93s).
[0m16:01:03.454673 [debug] [MainThread]: Command end result
[0m16:01:03.470730 [info ] [MainThread]: 
[0m16:01:03.470730 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:01:03.486667 [info ] [MainThread]: 
[0m16:01:03.486667 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m16:01:03.486667 [debug] [MainThread]: Command `dbt snapshot` succeeded at 16:01:03.486667 after 11.75 seconds
[0m16:01:03.486667 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9B8BF3460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9BC2C2280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E9BC2BAD00>]}
[0m16:01:03.486667 [debug] [MainThread]: Flushing usage events
[0m16:01:07.059233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002209BC42400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002209ABBF910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002209ABBFB80>]}


============================== 16:01:07.059233 | 56609233-0335-4b3d-bcb9-d96f919b2da5 ==============================
[0m16:01:07.059233 [info ] [MainThread]: Running with dbt=1.7.4
[0m16:01:07.059233 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'invocation_command': 'dbt run --select tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m16:01:07.586677 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '56609233-0335-4b3d-bcb9-d96f919b2da5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002209ABABF70>]}
[0m16:01:07.645809 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '56609233-0335-4b3d-bcb9-d96f919b2da5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002209F192790>]}
[0m16:01:07.645809 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m16:01:07.653500 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m16:01:07.701103 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:01:07.703109 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:01:07.707121 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '56609233-0335-4b3d-bcb9-d96f919b2da5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002209F5A5CD0>]}
[0m16:01:07.717305 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '56609233-0335-4b3d-bcb9-d96f919b2da5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002209F4B07F0>]}
[0m16:01:07.719232 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m16:01:07.719232 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '56609233-0335-4b3d-bcb9-d96f919b2da5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002209F4B0820>]}
[0m16:01:07.719232 [info ] [MainThread]: 
[0m16:01:07.719232 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m16:01:07.719232 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m16:01:07.719232 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:01:08.376812 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m16:01:08.376812 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:01:08.392949 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m16:01:08.392949 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:01:08.981600 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m16:01:08.981600 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:01:09.029461 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_az)
[0m16:01:09.029461 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:01:09.638082 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '56609233-0335-4b3d-bcb9-d96f919b2da5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002209F32F460>]}
[0m16:01:09.638082 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m16:01:09.638082 [info ] [MainThread]: 
[0m16:01:09.656625 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m16:01:09.656625 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m16:01:09.656625 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m16:01:09.656625 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m16:01:09.669800 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m16:01:09.684487 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 16:01:09.656625 => 16:01:09.684487
[0m16:01:09.685510 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m16:01:09.701398 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m16:01:10.374499 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m16:01:10.374499 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m16:01:10.806921 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:43e9cab7-64b8-45f4-910c-f7400b44f95f&page=queryresults
[0m16:01:13.023417 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 16:01:09.685510 => 16:01:13.023417
[0m16:01:13.023417 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '56609233-0335-4b3d-bcb9-d96f919b2da5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000220A061DE50>]}
[0m16:01:13.023417 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (493.0 rows, 90.5 KiB processed)[0m in 3.37s]
[0m16:01:13.023417 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m16:01:13.023417 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m16:01:13.023417 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m16:01:13.023417 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m16:01:13.023417 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m16:01:13.039242 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m16:01:13.039242 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 16:01:13.023417 => 16:01:13.039242
[0m16:01:13.039242 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m16:01:13.039242 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m16:01:13.712477 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m16:01:13.712477 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m16:01:14.195566 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:066a076f-1fe9-4874-bd65-e15b43ff6612&page=queryresults
[0m16:01:16.437310 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 16:01:13.039242 => 16:01:16.437310
[0m16:01:16.437310 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '56609233-0335-4b3d-bcb9-d96f919b2da5', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000220A06435E0>]}
[0m16:01:16.437310 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (356.0 rows, 110.4 KiB processed)[0m in 3.41s]
[0m16:01:16.437310 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m16:01:16.437310 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:01:16.437310 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m16:01:16.437310 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m16:01:16.453502 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m16:01:16.453502 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m16:01:16.453502 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m16:01:16.453502 [info ] [MainThread]: 
[0m16:01:16.453502 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 8.73 seconds (8.73s).
[0m16:01:16.453502 [debug] [MainThread]: Command end result
[0m16:01:16.492353 [info ] [MainThread]: 
[0m16:01:16.492353 [info ] [MainThread]: [32mCompleted successfully[0m
[0m16:01:16.501517 [info ] [MainThread]: 
[0m16:01:16.501517 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m16:01:16.501517 [debug] [MainThread]: Command `dbt run` succeeded at 16:01:16.501517 after 9.50 seconds
[0m16:01:16.501517 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002209BC42400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002209F309B50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002209F26E3D0>]}
[0m16:01:16.501517 [debug] [MainThread]: Flushing usage events
[0m17:00:03.970377 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245DE2F2400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245DD29C910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245DD29CB80>]}


============================== 17:00:03.974924 | e6b3fe3c-8fa9-4101-b380-3608ef243922 ==============================
[0m17:00:03.974924 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:00:03.975578 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --exclude tag:snaps', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:00:04.606572 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245DD29C820>]}
[0m17:00:04.694471 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E19760D0>]}
[0m17:00:04.696390 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:00:04.704191 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:00:04.776135 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:00:04.776135 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:00:04.785264 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E1C75D30>]}
[0m17:00:04.806058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E1B88850>]}
[0m17:00:04.806058 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:00:04.808624 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E1B88880>]}
[0m17:00:04.814692 [info ] [MainThread]: 
[0m17:00:04.815695 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:00:04.817281 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:04.818443 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:04.818443 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:04.819396 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:06.011607 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:06.761133 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m17:00:06.762132 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:06.765131 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m17:00:06.765131 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:07.477308 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m17:00:07.496755 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:07.500310 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m17:00:07.539666 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:08.322219 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E1C80820>]}
[0m17:00:08.324217 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:00:08.326237 [info ] [MainThread]: 
[0m17:00:08.341443 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:08.343451 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.345444 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m17:00:08.348541 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m17:00:08.361058 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m17:00:08.364063 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m17:00:08.365060 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:08.366061 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.378083 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m17:00:08.381088 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m17:00:08.386213 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 17:00:08.367567 => 17:00:08.384215
[0m17:00:08.386213 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:08.417843 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m17:00:08.418849 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 17:00:08.378598 => 17:00:08.418849
[0m17:00:08.418849 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m17:00:08.421874 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m17:00:08.422856 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:00:08.423860 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:00:08.424892 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m17:00:08.461520 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m17:00:09.406257 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:268c0071-7e33-4b7b-a310-4da0d01bb79e&page=queryresults
[0m17:00:09.491373 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:6320075a-7d6a-4577-b9b7-fcb5a58e284c&page=queryresults
[0m17:00:09.875068 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 17:00:08.386213 => 17:00:09.874078
[0m17:00:09.875068 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2D3BFD0>]}
[0m17:00:09.876070 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.52s]
[0m17:00:09.876070 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m17:00:09.876070 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m17:00:09.877688 [info ] [Thread-1  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m17:00:09.877688 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m17:00:09.877688 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m17:00:09.883699 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m17:00:09.883699 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 17:00:09.877688 => 17:00:09.883699
[0m17:00:09.885208 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m17:00:09.887725 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m17:00:09.888735 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:09.891735 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m17:00:09.928319 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 17:00:08.419854 => 17:00:09.928319
[0m17:00:09.929317 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2D99C10>]}
[0m17:00:09.929317 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.57s]
[0m17:00:09.930612 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m17:00:09.930612 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_compra
[0m17:00:09.931298 [info ] [Thread-2  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m17:00:09.931298 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_compra)
[0m17:00:09.931298 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_compra
[0m17:00:09.935834 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m17:00:09.935834 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (compile): 17:00:09.932807 => 17:00:09.935834
[0m17:00:09.937350 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_compra
[0m17:00:09.942363 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m17:00:09.943360 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:09.944362 [debug] [Thread-2  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m17:00:10.641903 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ac289cc0-dd52-4611-a556-03756702994f&page=queryresults
[0m17:00:10.680328 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:23ebcd3e-cf91-4379-be37-12d23e735cd3&page=queryresults
[0m17:00:11.233969 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (execute): 17:00:09.937350 => 17:00:11.233969
[0m17:00:11.235074 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2DC7DC0>]}
[0m17:00:11.237647 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 17:00:09.885208 => 17:00:11.237647
[0m17:00:11.238694 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E1C808B0>]}
[0m17:00:11.238694 [info ] [Thread-2  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m17:00:11.240692 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_compra
[0m17:00:11.240692 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m17:00:11.239747 [info ] [Thread-1  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m17:00:11.242671 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m17:00:11.244658 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m17:00:11.240692 [info ] [Thread-2  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m17:00:11.244658 [info ] [Thread-1  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m17:00:11.246167 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_forma_pagamento)
[0m17:00:11.246167 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m17:00:11.248725 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m17:00:11.248725 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m17:00:11.253717 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m17:00:11.255719 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m17:00:11.257247 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 17:00:11.249703 => 17:00:11.257247
[0m17:00:11.258266 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m17:00:11.261262 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m17:00:11.262267 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 17:00:11.253717 => 17:00:11.261262
[0m17:00:11.263266 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m17:00:11.263266 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:11.270795 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m17:00:11.273778 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m17:00:11.296041 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:11.298562 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m17:00:12.166658 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f7261036-8c4d-4020-b1c3-45612e94eb56&page=queryresults
[0m17:00:12.205417 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:50dc67ee-a522-4f32-8d4c-4a6a096ec35a&page=queryresults
[0m17:00:12.550623 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 17:00:11.258266 => 17:00:12.549616
[0m17:00:12.552571 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2D07E20>]}
[0m17:00:12.553572 [info ] [Thread-2  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m17:00:12.554632 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m17:00:12.555617 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_compra
[0m17:00:12.555617 [info ] [Thread-2  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m17:00:12.556598 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m17:00:12.557677 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m17:00:12.560388 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m17:00:12.561392 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 17:00:12.557677 => 17:00:12.561392
[0m17:00:12.562293 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m17:00:12.564388 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m17:00:12.565395 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:12.567324 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m17:00:12.600963 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 17:00:11.264264 => 17:00:12.600963
[0m17:00:12.601942 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2D44A00>]}
[0m17:00:12.601942 [info ] [Thread-1  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m17:00:12.603093 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m17:00:12.603093 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m17:00:12.604128 [info ] [Thread-1  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m17:00:12.604128 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m17:00:12.604128 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m17:00:12.607681 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m17:00:12.611692 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 17:00:12.605197 => 17:00:12.610731
[0m17:00:12.612737 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m17:00:12.615735 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m17:00:12.617280 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:12.618296 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m17:00:13.310857 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:115ec026-ed13-4402-ab75-1886443dcd73&page=queryresults
[0m17:00:13.380911 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:b600bcdf-31c9-4f90-a83f-84e318051995&page=queryresults
[0m17:00:13.736571 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 17:00:12.612737 => 17:00:13.736571
[0m17:00:13.737559 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2D02B50>]}
[0m17:00:13.739337 [info ] [Thread-1  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m17:00:13.739896 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m17:00:13.739896 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m17:00:13.741404 [info ] [Thread-1  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m17:00:13.743417 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_meta_margem_preco)
[0m17:00:13.744466 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m17:00:13.749691 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m17:00:13.750684 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 17:00:13.744466 => 17:00:13.750684
[0m17:00:13.751591 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m17:00:13.758289 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m17:00:13.758289 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:13.760383 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m17:00:13.854290 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 17:00:12.562293 => 17:00:13.854290
[0m17:00:13.856292 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2E472B0>]}
[0m17:00:13.857294 [info ] [Thread-2  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m17:00:13.858817 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m17:00:13.859825 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m17:00:13.859825 [info ] [Thread-2  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m17:00:13.860825 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_pedido)
[0m17:00:13.861825 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m17:00:13.865938 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m17:00:13.867449 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 17:00:13.861825 => 17:00:13.867449
[0m17:00:13.869469 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m17:00:13.873472 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m17:00:13.874462 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:13.875462 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m17:00:14.510657 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8ef9cf0e-f5ef-4221-91e1-73faa8654a58&page=queryresults
[0m17:00:14.670889 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:082fa3e9-e1e4-455e-8ede-10126399c8a5&page=queryresults
[0m17:00:14.903549 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 17:00:13.751591 => 17:00:14.903549
[0m17:00:14.904547 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2D3BFD0>]}
[0m17:00:14.904547 [info ] [Thread-1  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m17:00:14.905584 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m17:00:14.905584 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m17:00:14.905584 [info ] [Thread-1  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m17:00:14.907279 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m17:00:14.907279 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m17:00:14.910381 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m17:00:14.911347 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 17:00:14.907279 => 17:00:14.911347
[0m17:00:14.912298 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m17:00:14.915377 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m17:00:14.916332 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:14.917854 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m17:00:15.068735 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 17:00:13.869469 => 17:00:15.067661
[0m17:00:15.070761 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2E26B50>]}
[0m17:00:15.072743 [info ] [Thread-2  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m17:00:15.074797 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m17:00:15.074797 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m17:00:15.075809 [info ] [Thread-2  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m17:00:15.075809 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m17:00:15.075809 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m17:00:15.079404 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m17:00:15.080469 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 17:00:15.075809 => 17:00:15.080469
[0m17:00:15.080469 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m17:00:15.087974 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m17:00:15.088976 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:15.090018 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m17:00:15.651475 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7c4b03a4-436c-44cd-9185-cec7486e5d3e&page=queryresults
[0m17:00:15.768600 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:061b0041-b8d9-48c8-96d1-6d620e75a086&page=queryresults
[0m17:00:16.083772 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 17:00:14.912298 => 17:00:16.083772
[0m17:00:16.084994 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2E5DBE0>]}
[0m17:00:16.086008 [info ] [Thread-1  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m17:00:16.086008 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m17:00:16.086008 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m17:00:16.087513 [info ] [Thread-1  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m17:00:16.088519 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m17:00:16.088519 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m17:00:16.091520 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m17:00:16.093053 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 17:00:16.088519 => 17:00:16.093053
[0m17:00:16.094075 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m17:00:16.098573 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m17:00:16.100577 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:16.101578 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m17:00:16.140780 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 17:00:15.080469 => 17:00:16.140780
[0m17:00:16.140780 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2CFED30>]}
[0m17:00:16.141781 [info ] [Thread-2  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.06s]
[0m17:00:16.142781 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m17:00:16.143782 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m17:00:16.143782 [info ] [Thread-2  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m17:00:16.144287 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.dm_produto)
[0m17:00:16.145295 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m17:00:16.148815 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m17:00:16.149817 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 17:00:16.145295 => 17:00:16.148815
[0m17:00:16.149817 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m17:00:16.157323 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:16.792572 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m17:00:16.794559 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m17:00:16.881452 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bed2bc94-2874-419b-8025-7db39147ffbe&page=queryresults
[0m17:00:17.268907 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 17:00:16.095061 => 17:00:17.267896
[0m17:00:17.269912 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2DD4520>]}
[0m17:00:17.270947 [info ] [Thread-1  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.18s]
[0m17:00:17.273911 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m17:00:17.594599 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5801eae3-d583-4295-9fd1-6ab6fa0e93f9&page=queryresults
[0m17:00:20.684760 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 17:00:16.149817 => 17:00:20.683701
[0m17:00:20.685746 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2E26D00>]}
[0m17:00:20.685746 [info ] [Thread-2  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 4.54s]
[0m17:00:20.688410 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m17:00:20.689393 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m17:00:20.690405 [info ] [Thread-1  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m17:00:20.691404 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m17:00:20.692356 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m17:00:20.697989 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m17:00:20.699032 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 17:00:20.693403 => 17:00:20.697989
[0m17:00:20.699032 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m17:00:20.705043 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:21.384126 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m17:00:21.386125 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m17:00:21.987347 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bf1ba835-2ad1-4b9b-b008-fb0b65f3f701&page=queryresults
[0m17:00:26.328769 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 17:00:20.699032 => 17:00:26.328769
[0m17:00:26.329872 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2DDD8B0>]}
[0m17:00:26.329872 [info ] [Thread-1  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 5.64s]
[0m17:00:26.330878 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m17:00:26.331772 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m17:00:26.332791 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m17:00:26.332791 [info ] [Thread-2  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m17:00:26.333791 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m17:00:26.333791 [info ] [Thread-1  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m17:00:26.334770 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m17:00:26.334770 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m17:00:26.338301 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m17:00:26.339286 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m17:00:26.342290 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m17:00:26.344287 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 17:00:26.339286 => 17:00:26.343288
[0m17:00:26.344287 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m17:00:26.346306 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:26.347285 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 17:00:26.335773 => 17:00:26.347285
[0m17:00:26.348542 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m17:00:26.350539 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:27.005424 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m17:00:27.006413 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m17:00:27.011928 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m17:00:27.013909 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m17:00:27.590602 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:49dda37c-2e54-409d-8176-2cac43d0bff4&page=queryresults
[0m17:00:27.618363 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5be14db3-606d-436c-b981-93ca5503aac2&page=queryresults
[0m17:00:29.627259 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 17:00:26.348542 => 17:00:29.627259
[0m17:00:29.627770 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2D02580>]}
[0m17:00:29.628781 [info ] [Thread-2  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 3.29s]
[0m17:00:29.629799 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m17:00:29.630801 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m17:00:29.631793 [info ] [Thread-2  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m17:00:29.633800 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m17:00:29.633800 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m17:00:29.638332 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m17:00:29.639331 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 17:00:29.634801 => 17:00:29.639331
[0m17:00:29.640327 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m17:00:29.646325 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:29.852585 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 17:00:26.344287 => 17:00:29.852585
[0m17:00:29.853602 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2DFE4C0>]}
[0m17:00:29.854587 [info ] [Thread-1  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 3.52s]
[0m17:00:29.855592 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m17:00:29.855592 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m17:00:29.856583 [info ] [Thread-1  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m17:00:29.857591 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m17:00:29.858103 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m17:00:29.861107 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m17:00:29.862109 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 17:00:29.858103 => 17:00:29.862109
[0m17:00:29.863109 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m17:00:29.864207 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:30.236346 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m17:00:30.237302 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m17:00:30.444637 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m17:00:30.445639 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m17:00:30.634390 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:cff6b3a9-eac9-480b-9636-759641712263&page=queryresults
[0m17:00:31.119792 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1d01aa0d-b076-4dcf-a74f-09dca49d4f82&page=queryresults
[0m17:00:32.311828 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 17:00:29.640327 => 17:00:32.311828
[0m17:00:32.314826 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2D3CDF0>]}
[0m17:00:32.315826 [info ] [Thread-2  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 2.68s]
[0m17:00:32.317348 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m17:00:32.319370 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m17:00:32.319370 [info ] [Thread-2  ]: 20 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m17:00:32.320362 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m17:00:32.321370 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m17:00:32.324370 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m17:00:32.325368 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 17:00:32.321370 => 17:00:32.324370
[0m17:00:32.325368 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m17:00:32.326372 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:32.947299 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m17:00:32.948561 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m17:00:33.319204 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4629ccb8-7829-44f8-ae28-f62a4b50d224&page=queryresults
[0m17:00:33.322189 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 17:00:29.863109 => 17:00:33.321210
[0m17:00:33.324194 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2D99790>]}
[0m17:00:33.324194 [info ] [Thread-1  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.47s]
[0m17:00:33.326192 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m17:00:33.327202 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m17:00:33.327202 [info ] [Thread-1  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m17:00:33.327777 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m17:00:33.327777 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m17:00:33.330836 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m17:00:33.332840 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 17:00:33.328832 => 17:00:33.331797
[0m17:00:33.332840 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m17:00:33.338468 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:33.968349 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m17:00:33.969360 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m17:00:34.393700 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e565360c-b051-4941-8ddf-d25aa04ffbea&page=queryresults
[0m17:00:35.075482 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 17:00:32.325368 => 17:00:35.075482
[0m17:00:35.076497 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2DFCE50>]}
[0m17:00:35.077479 [info ] [Thread-2  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 2.76s]
[0m17:00:35.077767 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m17:00:35.078823 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m17:00:35.078823 [info ] [Thread-2  ]: 22 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m17:00:35.079813 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m17:00:35.079813 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m17:00:35.082820 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m17:00:35.083879 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 17:00:35.079813 => 17:00:35.083879
[0m17:00:35.083879 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m17:00:35.087453 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:36.039807 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m17:00:36.042829 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m17:00:36.624154 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 17:00:33.332840 => 17:00:36.624154
[0m17:00:36.625155 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2D99CA0>]}
[0m17:00:36.625155 [info ] [Thread-1  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.5 KiB processed)[0m in 3.30s]
[0m17:00:36.626152 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m17:00:36.627151 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m17:00:36.627151 [info ] [Thread-1  ]: 23 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m17:00:36.628418 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m17:00:36.628418 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m17:00:36.632423 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m17:00:36.633420 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 17:00:36.629423 => 17:00:36.633420
[0m17:00:36.634424 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m17:00:36.637471 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:36.712151 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0852c1ca-f22b-4833-88a4-2d1338950077&page=queryresults
[0m17:00:37.306508 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m17:00:37.307507 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m17:00:37.653866 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9d62261c-35ac-4d70-bb78-7d5e5bbf3613&page=queryresults
[0m17:00:39.757581 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 17:00:35.083879 => 17:00:39.757581
[0m17:00:39.758636 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2EEC7C0>]}
[0m17:00:39.759621 [info ] [Thread-2  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 4.68s]
[0m17:00:39.760674 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m17:00:39.760674 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m17:00:39.761627 [info ] [Thread-2  ]: 24 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m17:00:39.762628 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m17:00:39.762628 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m17:00:39.766691 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m17:00:39.767631 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 17:00:39.762628 => 17:00:39.767631
[0m17:00:39.767631 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m17:00:39.835749 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:40.455245 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m17:00:40.456246 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m17:00:40.769859 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 17:00:36.635427 => 17:00:40.769859
[0m17:00:40.770868 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E3F52E20>]}
[0m17:00:41.098990 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a1bde373-318d-4ccf-a8e6-533ff1dff68b&page=queryresults
[0m17:00:41.611557 [info ] [Thread-1  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.6 KiB processed)[0m in 4.14s]
[0m17:00:41.612558 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m17:00:41.613586 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m17:00:41.614576 [info ] [Thread-1  ]: 25 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m17:00:41.615571 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m17:00:41.615571 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m17:00:41.620044 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m17:00:41.621040 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 17:00:41.615571 => 17:00:41.621040
[0m17:00:41.622041 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m17:00:41.624038 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m17:00:42.243229 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m17:00:42.245232 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m17:00:42.642300 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4fe01807-b2b9-4382-a840-038b8722e25d&page=queryresults
[0m17:00:43.621561 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 17:00:39.767631 => 17:00:43.621561
[0m17:00:43.623470 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2F1FEE0>]}
[0m17:00:43.623470 [info ] [Thread-2  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 3.86s]
[0m17:00:43.624488 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m17:00:45.242155 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 17:00:41.622041 => 17:00:45.242155
[0m17:00:45.244149 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2ED9430>]}
[0m17:00:45.244149 [info ] [Thread-1  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 3.63s]
[0m17:00:45.245170 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m17:00:45.246415 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m17:00:45.246415 [info ] [Thread-2  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m17:00:45.247415 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m17:00:45.247415 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m17:00:45.250507 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m17:00:45.252511 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 17:00:45.247415 => 17:00:45.252511
[0m17:00:45.252511 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m17:00:45.255509 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m17:00:45.892253 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m17:00:45.894247 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    where ds_status_compra in ('EM ABERTO')
)

, cte_joins as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,a.qt_estoque_minimo                as qt_estoque_minimo
         ,a.qt_estoque_atual                 as qt_estoque_atual
         ,a.vl_custo_total                   as vl_custo_total
         ,a.vl_preco_venda                   as vl_preco_venda
         ,sum(b.qt_item)                     as qt_item_compra_pendente
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m17:00:46.678174 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:05b792b3-8260-49a3-aad8-9a2b5d5c467f&page=queryresults
[0m17:00:50.050402 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 17:00:45.253512 => 17:00:50.050402
[0m17:00:50.051401 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e6b3fe3c-8fa9-4101-b380-3608ef243922', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E2D583A0>]}
[0m17:00:50.051401 [info ] [Thread-2  ]: 26 of 26 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 4.80s]
[0m17:00:50.053400 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m17:00:50.055512 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:00:50.055512 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:00:50.055512 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:00:50.056491 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m17:00:50.056491 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m17:00:50.057397 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m17:00:50.057397 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m17:00:50.057902 [info ] [MainThread]: 
[0m17:00:50.061425 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 45.24 seconds (45.24s).
[0m17:00:50.073418 [debug] [MainThread]: Command end result
[0m17:00:50.090447 [info ] [MainThread]: 
[0m17:00:50.091446 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:00:50.092448 [info ] [MainThread]: 
[0m17:00:50.092448 [info ] [MainThread]: Done. PASS=26 WARN=0 ERROR=0 SKIP=0 TOTAL=26
[0m17:00:50.094447 [debug] [MainThread]: Command `dbt run` succeeded at 17:00:50.094447 after 46.19 seconds
[0m17:00:50.095446 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245DE2F2400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E187CC40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000245E1A4E790>]}
[0m17:00:50.095446 [debug] [MainThread]: Flushing usage events
[0m17:00:53.684358 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA10D88430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA0FD14670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA0FD14D90>]}


============================== 17:00:53.689080 | 9d58abe0-1e84-4e55-af92-e225ffeb5bf3 ==============================
[0m17:00:53.689080 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:00:53.689080 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m17:00:54.653064 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9d58abe0-1e84-4e55-af92-e225ffeb5bf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA0FD09940>]}
[0m17:00:54.736058 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9d58abe0-1e84-4e55-af92-e225ffeb5bf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA143F07C0>]}
[0m17:00:54.738595 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:00:54.747144 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:00:54.815696 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:00:54.815696 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:00:54.821362 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9d58abe0-1e84-4e55-af92-e225ffeb5bf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA146F63D0>]}
[0m17:00:54.838663 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9d58abe0-1e84-4e55-af92-e225ffeb5bf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA14608400>]}
[0m17:00:54.839677 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:00:54.840689 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9d58abe0-1e84-4e55-af92-e225ffeb5bf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA14470220>]}
[0m17:00:54.842756 [info ] [MainThread]: 
[0m17:00:54.843692 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:00:54.845697 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:00:54.845697 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:55.555050 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m17:00:55.555971 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:55.555971 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:00:55.557568 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:00:56.221046 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m17:00:56.224111 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:56.267307 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m17:00:56.270594 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:00:56.921030 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9d58abe0-1e84-4e55-af92-e225ffeb5bf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA1445F100>]}
[0m17:00:56.935732 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:00:56.940818 [info ] [MainThread]: 
[0m17:00:56.957421 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m17:00:56.958979 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m17:00:56.960007 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m17:00:56.960007 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m17:00:56.977270 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 17:00:56.961015 => 17:00:56.977270
[0m17:00:56.978391 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m17:00:57.030123 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:00:57.032144 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m17:00:57.861817 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0b5acac0-c850-4166-b6b9-f8f2287dfdde&page=queryresults
[0m17:00:58.985278 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m17:00:59.411473 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:181504c4-ff7d-44f8-9509-15ab3ba06e55&page=queryresults
[0m17:01:01.782925 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m17:01:02.556489 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m17:01:02.559043 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m17:01:02.893150 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fd2caec1-0140-40fd-abe9-e8d58c62047b&page=queryresults
[0m17:01:04.719847 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 17:00:56.978391 => 17:01:04.719847
[0m17:01:04.720864 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d58abe0-1e84-4e55-af92-e225ffeb5bf3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA15797A90>]}
[0m17:01:04.721851 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 106.5 KiB processed)[0m in 7.76s]
[0m17:01:04.723851 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m17:01:04.725847 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:01:04.725847 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:01:04.727351 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m17:01:04.727351 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m17:01:04.727351 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m17:01:04.728356 [info ] [MainThread]: 
[0m17:01:04.729356 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 9.88 seconds (9.88s).
[0m17:01:04.730374 [debug] [MainThread]: Command end result
[0m17:01:04.752157 [info ] [MainThread]: 
[0m17:01:04.754164 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:01:04.755174 [info ] [MainThread]: 
[0m17:01:04.756168 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m17:01:04.757697 [debug] [MainThread]: Command `dbt snapshot` succeeded at 17:01:04.757151 after 11.17 seconds
[0m17:01:04.757697 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA10D88430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA14425130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DA144C0B80>]}
[0m17:01:04.758690 [debug] [MainThread]: Flushing usage events
[0m17:01:08.424802 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001815403B400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018152FCE910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018152FCEB80>]}


============================== 17:01:08.428490 | 02a16a17-1e00-4547-a40a-0b1151d5709b ==============================
[0m17:01:08.428490 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:01:08.429410 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:01:09.252773 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '02a16a17-1e00-4547-a40a-0b1151d5709b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001815618AB20>]}
[0m17:01:09.337576 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '02a16a17-1e00-4547-a40a-0b1151d5709b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000181576B07C0>]}
[0m17:01:09.339650 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:01:09.345719 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:01:09.418368 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:01:09.418368 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:01:09.424429 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '02a16a17-1e00-4547-a40a-0b1151d5709b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000181579A80D0>]}
[0m17:01:09.441551 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '02a16a17-1e00-4547-a40a-0b1151d5709b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000181578BCFD0>]}
[0m17:01:09.442534 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m17:01:09.442534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '02a16a17-1e00-4547-a40a-0b1151d5709b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000181578BCAF0>]}
[0m17:01:09.443607 [info ] [MainThread]: 
[0m17:01:09.444595 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:01:09.445596 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m17:01:09.445596 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:10.152235 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m17:01:10.155295 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:10.159602 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m17:01:10.163309 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:11.135646 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m17:01:11.138232 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:01:11.144350 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m17:01:11.147788 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:01:11.982399 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '02a16a17-1e00-4547-a40a-0b1151d5709b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018157638EB0>]}
[0m17:01:11.983403 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m17:01:11.984417 [info ] [MainThread]: 
[0m17:01:11.994922 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m17:01:11.995914 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m17:01:11.997422 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m17:01:11.998429 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m17:01:12.019175 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m17:01:12.022188 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 17:01:11.999450 => 17:01:12.021185
[0m17:01:12.024189 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m17:01:12.045133 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m17:01:12.713214 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m17:01:12.722265 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m17:01:13.115226 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:42d142d5-03c4-4d9c-8b2c-c487e216f532&page=queryresults
[0m17:01:15.364579 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 17:01:12.025187 => 17:01:15.364579
[0m17:01:15.365580 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '02a16a17-1e00-4547-a40a-0b1151d5709b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018158A21640>]}
[0m17:01:15.365580 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (493.0 rows, 90.5 KiB processed)[0m in 3.37s]
[0m17:01:15.367477 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m17:01:15.368518 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m17:01:15.369517 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m17:01:15.371532 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m17:01:15.372532 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m17:01:15.377223 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m17:01:15.379294 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 17:01:15.373091 => 17:01:15.379294
[0m17:01:15.380266 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m17:01:15.383266 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m17:01:16.019111 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m17:01:16.023094 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m17:01:16.475390 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a6991d40-522a-4844-9414-090c8439c789&page=queryresults
[0m17:01:18.164464 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 17:01:15.380266 => 17:01:18.162467
[0m17:01:18.170678 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '02a16a17-1e00-4547-a40a-0b1151d5709b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000018158A44B80>]}
[0m17:01:18.176668 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (356.0 rows, 110.4 KiB processed)[0m in 2.80s]
[0m17:01:18.182251 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m17:01:18.194809 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:01:18.197337 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m17:01:18.199367 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m17:01:18.201349 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m17:01:18.204153 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m17:01:18.209672 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m17:01:18.213166 [info ] [MainThread]: 
[0m17:01:18.217169 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 8.77 seconds (8.77s).
[0m17:01:18.225915 [debug] [MainThread]: Command end result
[0m17:01:18.322526 [info ] [MainThread]: 
[0m17:01:18.325583 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:01:18.327571 [info ] [MainThread]: 
[0m17:01:18.330956 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m17:01:18.336506 [debug] [MainThread]: Command `dbt run` succeeded at 17:01:18.335508 after 9.99 seconds
[0m17:01:18.337561 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001815403B400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000181576B07C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000181576D9250>]}
[0m17:01:18.340812 [debug] [MainThread]: Flushing usage events
[0m18:00:04.435741 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258D8E634C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258D7DD7310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258D7DD7790>]}


============================== 18:00:04.440262 | f7286506-c30e-4f50-b217-fa92294c9971 ==============================
[0m18:00:04.440262 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:00:04.440262 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'invocation_command': 'dbt run --exclude tag:snaps', 'send_anonymous_usage_stats': 'True'}
[0m18:00:05.046445 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DAFAAC10>]}
[0m18:00:05.117631 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DB80EBB0>]}
[0m18:00:05.119175 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:00:05.126325 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:00:05.187865 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:00:05.188893 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:00:05.194828 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DC7C8280>]}
[0m18:00:05.209390 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DC6D60A0>]}
[0m18:00:05.209390 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:00:05.210373 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DC448C10>]}
[0m18:00:05.211903 [info ] [MainThread]: 
[0m18:00:05.212896 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:00:05.214881 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:00:05.215915 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:00:05.215915 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:05.216882 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:05.895679 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:00:06.633451 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m18:00:06.633451 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:06.637450 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m18:00:06.639451 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:07.541296 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m18:00:07.543296 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:00:07.590169 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m18:00:07.593217 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:00:08.270341 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DC7D2F10>]}
[0m18:00:08.272638 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:00:08.274633 [info ] [MainThread]: 
[0m18:00:08.283505 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m18:00:08.285479 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m18:00:08.287475 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m18:00:08.288519 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m18:00:08.294832 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m18:00:08.303949 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m18:00:08.329253 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m18:00:08.332858 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m18:00:08.332858 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m18:00:08.340330 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m18:00:08.342535 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 18:00:08.307946 => 18:00:08.342535
[0m18:00:08.343586 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m18:00:08.372708 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m18:00:08.373706 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 18:00:08.332858 => 18:00:08.372708
[0m18:00:08.373706 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m18:00:08.376613 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m18:00:08.377610 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m18:00:08.378609 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m18:00:08.378609 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:00:08.412494 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m18:00:09.253528 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0308c1ae-a373-4ced-a50f-8a72f57bc9e9&page=queryresults
[0m18:00:09.258523 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:02c401fd-cdf7-4750-a630-18160a659710&page=queryresults
[0m18:00:09.726260 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 18:00:08.344537 => 18:00:09.723272
[0m18:00:09.728345 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD8E2E50>]}
[0m18:00:09.738920 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 18:00:08.374613 => 18:00:09.738920
[0m18:00:09.740503 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD8D5E20>]}
[0m18:00:09.731771 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.43s]
[0m18:00:09.742592 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m18:00:09.742592 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m18:00:09.741833 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m18:00:09.744164 [info ] [Thread-2  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m18:00:09.748189 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m18:00:09.751612 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m18:00:09.753685 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_compra
[0m18:00:09.756702 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m18:00:09.760395 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m18:00:09.757787 [info ] [Thread-1  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m18:00:09.761545 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_compra)
[0m18:00:09.762492 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_compra
[0m18:00:09.764428 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 18:00:09.757787 => 18:00:09.763482
[0m18:00:09.765482 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m18:00:09.768501 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m18:00:09.776125 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m18:00:09.777173 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:09.780186 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m18:00:09.810894 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (compile): 18:00:09.762492 => 18:00:09.808903
[0m18:00:09.811650 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_compra
[0m18:00:09.814651 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m18:00:09.818640 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:09.820182 [debug] [Thread-1  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m18:00:10.568159 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:71eb2e78-9e85-4bd9-95a6-6847f329c720&page=queryresults
[0m18:00:10.818499 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8f58cb26-4514-4061-abe6-55aef88004ec&page=queryresults
[0m18:00:11.023938 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 18:00:09.765482 => 18:00:11.023938
[0m18:00:11.024936 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD853070>]}
[0m18:00:11.026944 [info ] [Thread-2  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m18:00:11.027936 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m18:00:11.027936 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m18:00:11.028934 [info ] [Thread-2  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m18:00:11.030442 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m18:00:11.030442 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m18:00:11.033456 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m18:00:11.034458 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 18:00:11.030442 => 18:00:11.034458
[0m18:00:11.034458 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m18:00:11.037455 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m18:00:11.038456 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:11.040456 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m18:00:11.281168 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (execute): 18:00:09.811650 => 18:00:11.280157
[0m18:00:11.281168 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD845F40>]}
[0m18:00:11.282192 [info ] [Thread-1  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.52s]
[0m18:00:11.283206 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_compra
[0m18:00:11.283206 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m18:00:11.283206 [info ] [Thread-1  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m18:00:11.284214 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m18:00:11.284214 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m18:00:11.287220 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m18:00:11.288221 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 18:00:11.284214 => 18:00:11.288221
[0m18:00:11.288221 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m18:00:11.290727 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m18:00:11.291732 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:11.293550 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m18:00:11.783220 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5c114676-070b-4120-af39-37bdf3e5949d&page=queryresults
[0m18:00:12.010043 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:97690a8d-b16a-4ef6-9051-7576c4c75f95&page=queryresults
[0m18:00:12.248580 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 18:00:11.035460 => 18:00:12.247577
[0m18:00:12.261741 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD90DFD0>]}
[0m18:00:12.263731 [info ] [Thread-2  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m18:00:12.267725 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m18:00:12.267725 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_compra
[0m18:00:12.270230 [info ] [Thread-2  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m18:00:12.271237 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_compra)
[0m18:00:12.272242 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m18:00:12.290213 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m18:00:12.291221 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 18:00:12.272242 => 18:00:12.291221
[0m18:00:12.292243 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m18:00:12.296227 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m18:00:12.297227 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:12.298228 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m18:00:12.518286 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 18:00:11.289221 => 18:00:12.518286
[0m18:00:12.519283 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD8BF070>]}
[0m18:00:12.519283 [info ] [Thread-1  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m18:00:12.520274 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m18:00:12.520816 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m18:00:12.520816 [info ] [Thread-1  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m18:00:12.521822 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_pedido)
[0m18:00:12.521822 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m18:00:12.526832 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m18:00:12.529827 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 18:00:12.522830 => 18:00:12.528837
[0m18:00:12.530357 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m18:00:12.534428 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m18:00:12.536424 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:12.542995 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m18:00:13.344440 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8fbaa66e-0004-464b-aeb5-69825f3360d5&page=queryresults
[0m18:00:13.541116 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5d8675a9-1b69-49be-8bca-1432e742905a&page=queryresults
[0m18:00:13.799884 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 18:00:12.292243 => 18:00:13.799024
[0m18:00:13.801627 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD87DD00>]}
[0m18:00:13.803957 [info ] [Thread-2  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.53s]
[0m18:00:13.806709 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m18:00:13.807875 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m18:00:13.808867 [info ] [Thread-2  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m18:00:13.812516 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m18:00:13.813523 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m18:00:13.822184 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m18:00:13.825209 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 18:00:13.813523 => 18:00:13.824335
[0m18:00:13.826271 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m18:00:13.834901 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m18:00:13.837839 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:13.840409 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m18:00:13.971188 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 18:00:12.531391 => 18:00:13.968971
[0m18:00:13.973224 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD8BF070>]}
[0m18:00:13.978217 [info ] [Thread-1  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m18:00:13.981308 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m18:00:13.981308 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m18:00:13.982300 [info ] [Thread-1  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m18:00:13.984318 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m18:00:13.985306 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m18:00:13.992733 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m18:00:13.993733 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 18:00:13.985306 => 18:00:13.993733
[0m18:00:13.993733 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m18:00:13.997323 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m18:00:13.998330 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:14.001370 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m18:00:14.602392 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9a2c75b0-f886-43dd-a01a-35609038a0ae&page=queryresults
[0m18:00:14.731085 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7a31ff30-586a-4fae-9f52-9967ca7b3881&page=queryresults
[0m18:00:14.998347 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 18:00:13.826271 => 18:00:14.998347
[0m18:00:14.999350 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD90DFD0>]}
[0m18:00:15.000350 [info ] [Thread-2  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m18:00:15.000871 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m18:00:15.000871 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m18:00:15.001899 [info ] [Thread-2  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m18:00:15.002903 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m18:00:15.003937 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m18:00:15.020177 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m18:00:15.022221 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 18:00:15.003937 => 18:00:15.021235
[0m18:00:15.023212 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m18:00:15.030742 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m18:00:15.031850 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:15.033849 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m18:00:15.099339 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 18:00:13.994718 => 18:00:15.098344
[0m18:00:15.104446 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD95BAC0>]}
[0m18:00:15.111603 [info ] [Thread-1  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m18:00:15.123294 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m18:00:15.126298 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m18:00:15.130300 [info ] [Thread-1  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m18:00:15.135849 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m18:00:15.141367 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m18:00:15.151938 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m18:00:15.154517 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 18:00:15.143354 => 18:00:15.152977
[0m18:00:15.156562 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m18:00:15.166235 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m18:00:15.169179 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:15.175735 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m18:00:15.875406 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0f9a3e8d-c4ca-4bc5-aaff-ca429236d337&page=queryresults
[0m18:00:15.948217 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:31785240-194d-45d4-a25a-0b24016db8c6&page=queryresults
[0m18:00:16.260815 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 18:00:15.024282 => 18:00:16.260309
[0m18:00:16.261823 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD845F10>]}
[0m18:00:16.262833 [info ] [Thread-2  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m18:00:16.264831 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m18:00:16.267828 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_tempo
[0m18:00:16.270338 [info ] [Thread-2  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m18:00:16.273348 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m18:00:16.273348 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m18:00:16.278351 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m18:00:16.279361 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 18:00:16.274349 => 18:00:16.279361
[0m18:00:16.279361 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_tempo
[0m18:00:16.288901 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m18:00:16.292419 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:16.294416 [debug] [Thread-2  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m18:00:16.323903 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 18:00:15.157568 => 18:00:16.322906
[0m18:00:16.324909 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD855250>]}
[0m18:00:16.324909 [info ] [Thread-1  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.19s]
[0m18:00:16.326905 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m18:00:16.326905 [debug] [Thread-1  ]: Began running node model.shibaribrasil.dm_produto
[0m18:00:16.327907 [info ] [Thread-1  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m18:00:16.328905 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.dm_produto)
[0m18:00:16.328905 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.dm_produto
[0m18:00:16.332413 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m18:00:16.333415 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (compile): 18:00:16.328905 => 18:00:16.333415
[0m18:00:16.333415 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.dm_produto
[0m18:00:16.342935 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:16.991390 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e3644f17-47fa-4b46-8143-0ca3bfac8f05&page=queryresults
[0m18:00:17.015204 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m18:00:17.020207 [debug] [Thread-1  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m18:00:17.357370 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 18:00:16.280365 => 18:00:17.357370
[0m18:00:17.357370 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD85BC40>]}
[0m18:00:17.357370 [info ] [Thread-2  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.09s]
[0m18:00:17.360609 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_tempo
[0m18:00:17.672630 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:f16d0489-8992-45a3-a2b2-e1288b8c9a7d&page=queryresults
[0m18:00:20.767082 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.dm_produto (execute): 18:00:16.334438 => 18:00:20.767082
[0m18:00:20.770258 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD9E6F40>]}
[0m18:00:20.770258 [info ] [Thread-1  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 4.44s]
[0m18:00:20.773899 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.dm_produto
[0m18:00:20.773899 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto
[0m18:00:20.773899 [info ] [Thread-2  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m18:00:20.773899 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m18:00:20.773899 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto
[0m18:00:20.780344 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m18:00:20.780344 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (compile): 18:00:20.773899 => 18:00:20.780344
[0m18:00:20.780344 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto
[0m18:00:20.780344 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:21.380238 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m18:00:21.384132 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m18:00:21.971619 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1fa79bc8-7169-42ea-9e51-8e07cf9f1a36&page=queryresults
[0m18:00:24.218146 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto (execute): 18:00:20.780344 => 18:00:24.218146
[0m18:00:24.220759 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD85BC10>]}
[0m18:00:24.221768 [info ] [Thread-2  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 3.45s]
[0m18:00:24.222741 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto
[0m18:00:24.223756 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m18:00:24.226401 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_compra
[0m18:00:24.225386 [info ] [Thread-1  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m18:00:24.227401 [info ] [Thread-2  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m18:00:24.228399 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m18:00:24.229405 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m18:00:24.230399 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m18:00:24.230908 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_compra
[0m18:00:24.234807 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m18:00:24.240484 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (compile): 18:00:24.231915 => 18:00:24.240484
[0m18:00:24.240484 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m18:00:24.240484 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_compra
[0m18:00:24.250309 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:24.250309 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 18:00:24.230908 => 18:00:24.250309
[0m18:00:24.250309 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m18:00:24.250309 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:25.190329 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m18:00:25.190329 [debug] [Thread-1  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m18:00:25.217719 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m18:00:25.220299 [debug] [Thread-2  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m18:00:25.808358 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:af694775-575e-4796-ac23-b6315f8c0cd5&page=queryresults
[0m18:00:25.862717 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7d6eb700-14ea-4ac1-8cd3-f383fc060a5b&page=queryresults
[0m18:00:28.387105 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 18:00:24.250309 => 18:00:28.387105
[0m18:00:28.389268 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD853D60>]}
[0m18:00:28.391364 [info ] [Thread-1  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 4.16s]
[0m18:00:28.394365 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m18:00:28.395291 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m18:00:28.398385 [info ] [Thread-1  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m18:00:28.398385 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m18:00:28.400475 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m18:00:28.400475 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m18:00:28.400475 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 18:00:28.400475 => 18:00:28.400475
[0m18:00:28.400475 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m18:00:28.400475 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:29.061323 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m18:00:29.065318 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m18:00:29.500368 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a59ecd68-1db3-422d-9785-f81bfc2dce40&page=queryresults
[0m18:00:31.444675 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 18:00:28.400475 => 18:00:31.443659
[0m18:00:31.448014 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD855250>]}
[0m18:00:31.450531 [info ] [Thread-1  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 3.05s]
[0m18:00:31.454540 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m18:00:31.455993 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m18:00:31.455993 [info ] [Thread-1  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m18:00:31.462202 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_pedido)
[0m18:00:31.462202 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m18:00:31.468251 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m18:00:31.475543 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 18:00:31.464221 => 18:00:31.473144
[0m18:00:31.477332 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m18:00:31.488969 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:32.145001 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m18:00:32.150528 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m18:00:32.771902 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fcb0ebc1-88cb-4d5c-a218-4ea1bfafd0a5&page=queryresults
[0m18:00:35.954016 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 18:00:31.478257 => 18:00:35.953484
[0m18:00:35.958179 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD9DBBB0>]}
[0m18:00:35.960173 [info ] [Thread-1  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 4.50s]
[0m18:00:35.962744 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m18:00:35.966655 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m18:00:35.968243 [info ] [Thread-1  ]: 20 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m18:00:35.970253 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m18:00:35.970777 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m18:00:35.981851 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m18:00:35.982851 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 18:00:35.971798 => 18:00:35.982851
[0m18:00:35.982851 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m18:00:35.986915 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:36.838166 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m18:00:36.842453 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m18:00:37.320390 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:88ece9af-5563-43b9-b2a2-93d06425f02b&page=queryresults
[0m18:00:39.538341 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 18:00:35.983849 => 18:00:39.538341
[0m18:00:39.540343 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DDA3FDC0>]}
[0m18:00:39.540865 [info ] [Thread-1  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.5 KiB processed)[0m in 3.57s]
[0m18:00:39.542880 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m18:00:39.543868 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m18:00:39.543868 [info ] [Thread-1  ]: 21 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m18:00:39.545987 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m18:00:39.547108 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m18:00:39.552127 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m18:00:39.553135 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 18:00:39.547108 => 18:00:39.553135
[0m18:00:39.554142 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m18:00:39.556411 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:40.302837 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m18:00:40.304025 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m18:00:40.768423 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:43710ca4-ea4b-4045-b838-35a8427c3d17&page=queryresults
[0m18:00:43.070316 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 18:00:39.554936 => 18:00:43.070316
[0m18:00:43.072548 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DDA34460>]}
[0m18:00:43.073545 [info ] [Thread-1  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.6 KiB processed)[0m in 3.53s]
[0m18:00:43.076157 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m18:00:43.077831 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m18:00:43.079364 [info ] [Thread-1  ]: 22 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m18:00:43.080449 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m18:00:43.081504 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m18:00:43.088384 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m18:00:43.090568 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 18:00:43.081504 => 18:00:43.088384
[0m18:00:43.090568 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m18:00:43.102443 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:43.721315 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m18:00:43.724312 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m18:00:44.096023 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:44750b4d-e3de-43bd-90eb-5d5ff2ded6e7&page=queryresults
[0m18:00:44.799943 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_compra (execute): 18:00:24.240484 => 18:00:44.799943
[0m18:00:44.801667 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD9430D0>]}
[0m18:00:44.802759 [info ] [Thread-2  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 20.57s]
[0m18:00:44.805093 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_compra
[0m18:00:44.805093 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m18:00:44.805093 [info ] [Thread-2  ]: 23 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m18:00:44.805093 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_agg_compra_produto)
[0m18:00:44.805093 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m18:00:44.816957 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m18:00:44.817465 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 18:00:44.810430 => 18:00:44.817465
[0m18:00:44.817465 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m18:00:44.823983 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:45.474603 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m18:00:45.478712 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m18:00:45.906097 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bfaf1482-ceb9-4386-b709-4143f46cc22b&page=queryresults
[0m18:00:46.920766 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 18:00:43.090568 => 18:00:46.920766
[0m18:00:46.922774 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DDA34CD0>]}
[0m18:00:46.923776 [info ] [Thread-1  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 3.84s]
[0m18:00:46.927172 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m18:00:47.890280 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 18:00:44.817465 => 18:00:47.890280
[0m18:00:47.890280 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD943970>]}
[0m18:00:48.763122 [info ] [Thread-2  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 3.09s]
[0m18:00:48.767774 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m18:00:48.771914 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m18:00:48.776774 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m18:00:48.775241 [info ] [Thread-1  ]: 24 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m18:00:48.784614 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_base, now model.shibaribrasil.tb_produto_fabricado)
[0m18:00:48.780599 [info ] [Thread-2  ]: 25 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m18:00:48.786682 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m18:00:48.787942 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_estoque_produto_base)
[0m18:00:48.793614 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m18:00:48.795058 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m18:00:48.798680 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m18:00:48.800287 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 18:00:48.788952 => 18:00:48.800287
[0m18:00:48.801341 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m18:00:48.803326 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:48.806388 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 18:00:48.796621 => 18:00:48.806388
[0m18:00:48.827294 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m18:00:48.836548 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m18:00:49.442123 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m18:00:49.445545 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m18:00:49.459026 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m18:00:49.462756 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    where ds_status_compra in ('EM ABERTO')
)

, cte_joins as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,a.qt_estoque_minimo                as qt_estoque_minimo
         ,a.qt_estoque_atual                 as qt_estoque_atual
         ,a.vl_custo_total                   as vl_custo_total
         ,a.vl_preco_venda                   as vl_preco_venda
         ,sum(b.qt_item)                     as qt_item_compra_pendente
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m18:00:50.100364 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a5d6cc17-6500-4e51-b912-fea80fd84afc&page=queryresults
[0m18:00:50.199980 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1b134cbb-45ab-4e80-a405-4244111eb95d&page=queryresults
[0m18:00:53.510289 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 18:00:48.801341 => 18:00:53.510289
[0m18:00:53.510289 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DEA4E2B0>]}
[0m18:00:53.512413 [info ] [Thread-1  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 4.73s]
[0m18:00:53.512413 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m18:00:53.514434 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m18:00:53.514434 [info ] [Thread-1  ]: 26 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m18:00:53.514434 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m18:00:53.514434 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m18:00:53.530259 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m18:00:53.530259 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 18:00:53.514434 => 18:00:53.530259
[0m18:00:53.530259 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m18:00:53.537780 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:00:54.410250 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m18:00:54.413264 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m18:00:54.663247 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 18:00:48.828273 => 18:00:54.662906
[0m18:00:54.667795 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DDA34940>]}
[0m18:00:54.671030 [info ] [Thread-2  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 5.88s]
[0m18:00:54.673760 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m18:00:55.040172 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:fac7db14-169c-4317-ba79-c31fc80dc646&page=queryresults
[0m18:00:57.530180 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 18:00:53.535191 => 18:00:57.528538
[0m18:00:57.531301 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7286506-c30e-4f50-b217-fa92294c9971', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DEA56E50>]}
[0m18:00:57.532334 [info ] [Thread-1  ]: 26 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 4.02s]
[0m18:00:57.533249 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m18:00:57.537609 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:00:57.538605 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:00:57.538605 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:00:57.538605 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m18:00:57.540153 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:00:57.540153 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m18:00:57.541218 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto_base' was properly closed.
[0m18:00:57.541780 [info ] [MainThread]: 
[0m18:00:57.542822 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 52.33 seconds (52.33s).
[0m18:00:57.544711 [debug] [MainThread]: Command end result
[0m18:00:57.560176 [info ] [MainThread]: 
[0m18:00:57.560176 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:00:57.560176 [info ] [MainThread]: 
[0m18:00:57.560176 [info ] [MainThread]: Done. PASS=26 WARN=0 ERROR=0 SKIP=0 TOTAL=26
[0m18:00:57.560176 [debug] [MainThread]: Command `dbt run` succeeded at 18:00:57.560176 after 53.20 seconds
[0m18:00:57.560176 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258D8E634C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DD90DFD0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000258DC4289A0>]}
[0m18:00:57.560176 [debug] [MainThread]: Flushing usage events
[0m18:01:01.146720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DE1C679460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DE1B604670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DE1B604D90>]}


============================== 18:01:01.151798 | ab245e02-9abc-4849-a910-b66933fd8f7f ==============================
[0m18:01:01.151798 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:01:01.154554 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'introspect': 'True', 'log_format': 'default', 'target_path': 'None', 'invocation_command': 'dbt snapshot', 'send_anonymous_usage_stats': 'True'}
[0m18:01:02.480626 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ab245e02-9abc-4849-a910-b66933fd8f7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DE1E7CBA90>]}
[0m18:01:02.548432 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ab245e02-9abc-4849-a910-b66933fd8f7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DE1EFC8A30>]}
[0m18:01:02.550589 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:01:02.555507 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:01:02.623053 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:01:02.623053 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:01:02.628899 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ab245e02-9abc-4849-a910-b66933fd8f7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DE1FFE4EB0>]}
[0m18:01:02.649009 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ab245e02-9abc-4849-a910-b66933fd8f7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DE1FEFAA00>]}
[0m18:01:02.650567 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:01:02.650567 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ab245e02-9abc-4849-a910-b66933fd8f7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DE1FEFA9A0>]}
[0m18:01:02.652630 [info ] [MainThread]: 
[0m18:01:02.656981 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:01:02.659083 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:01:02.660667 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:03.365166 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m18:01:03.365166 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:03.370492 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m18:01:03.370492 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:04.100426 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m18:01:04.105400 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:01:04.200378 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m18:01:04.203774 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:01:04.926196 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ab245e02-9abc-4849-a910-b66933fd8f7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DE1FC84F40>]}
[0m18:01:04.931600 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:01:04.933735 [info ] [MainThread]: 
[0m18:01:04.948421 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m18:01:04.950199 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m18:01:04.953978 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m18:01:04.954960 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m18:01:04.994667 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 18:01:04.957385 => 18:01:04.994231
[0m18:01:04.996139 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m18:01:05.088567 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:01:05.091727 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m18:01:06.031398 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7c7cfe96-f484-4be7-ade5-b0e7c875999c&page=queryresults
[0m18:01:07.390331 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m18:01:07.773349 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9a8b841c-ffe8-499f-936d-32709510f82c&page=queryresults
[0m18:01:10.420312 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m18:01:11.166486 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m18:01:11.174720 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m18:01:11.676493 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ee6a830c-7f74-4cba-8df8-4f924e34a851&page=queryresults
[0m18:01:14.023097 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 18:01:04.997155 => 18:01:14.022264
[0m18:01:14.026145 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ab245e02-9abc-4849-a910-b66933fd8f7f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DE2109FB80>]}
[0m18:01:14.030229 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 106.5 KiB processed)[0m in 9.07s]
[0m18:01:14.034610 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m18:01:14.045453 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:01:14.047384 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:01:14.047384 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m18:01:14.048383 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m18:01:14.050903 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m18:01:14.052916 [info ] [MainThread]: 
[0m18:01:14.054907 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 11.40 seconds (11.40s).
[0m18:01:14.060620 [debug] [MainThread]: Command end result
[0m18:01:14.122417 [info ] [MainThread]: 
[0m18:01:14.124413 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:01:14.125760 [info ] [MainThread]: 
[0m18:01:14.126411 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m18:01:14.129924 [debug] [MainThread]: Command `dbt snapshot` succeeded at 18:01:14.128924 after 13.07 seconds
[0m18:01:14.132272 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DE1C679460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DE1FFE4D90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DE1FDBA0D0>]}
[0m18:01:14.135267 [debug] [MainThread]: Flushing usage events
[0m18:01:17.862932 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254B7383460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254B632F9A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254B632FD30>]}


============================== 18:01:17.867124 | 7156461f-3f44-46cb-9632-3cbbc2463bde ==============================
[0m18:01:17.867124 [info ] [MainThread]: Running with dbt=1.7.4
[0m18:01:17.868147 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'version_check': 'True', 'debug': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'fail_fast': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select tag:snaps', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m18:01:18.540309 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7156461f-3f44-46cb-9632-3cbbc2463bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254B94EAA90>]}
[0m18:01:18.624185 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7156461f-3f44-46cb-9632-3cbbc2463bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254B9CE9A60>]}
[0m18:01:18.626213 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m18:01:18.638736 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m18:01:18.701679 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:01:18.701679 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:01:18.701679 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7156461f-3f44-46cb-9632-3cbbc2463bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254BAD05EB0>]}
[0m18:01:18.720270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7156461f-3f44-46cb-9632-3cbbc2463bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254BAC10A00>]}
[0m18:01:18.720270 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m18:01:18.720270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7156461f-3f44-46cb-9632-3cbbc2463bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254BAC109A0>]}
[0m18:01:18.720270 [info ] [MainThread]: 
[0m18:01:18.720270 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:01:18.729937 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m18:01:18.729937 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:19.456364 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m18:01:19.456364 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:19.530097 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m18:01:19.530097 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:01:20.180105 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_az)
[0m18:01:20.182677 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:01:20.260340 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m18:01:20.265705 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:01:20.930039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7156461f-3f44-46cb-9632-3cbbc2463bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254BAD12F10>]}
[0m18:01:20.937364 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m18:01:20.940406 [info ] [MainThread]: 
[0m18:01:20.960293 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m18:01:20.962698 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m18:01:20.966911 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m18:01:20.966911 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m18:01:21.000319 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m18:01:21.010469 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 18:01:20.966911 => 18:01:21.000319
[0m18:01:21.010469 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m18:01:21.040355 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m18:01:21.814208 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m18:01:21.818003 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m18:01:22.160013 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e69e04df-b126-4894-b2ed-5602c5e22e49&page=queryresults
[0m18:01:25.060742 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 18:01:21.010469 => 18:01:25.060742
[0m18:01:25.066524 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7156461f-3f44-46cb-9632-3cbbc2463bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254BBD81430>]}
[0m18:01:25.066524 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (493.0 rows, 90.5 KiB processed)[0m in 4.10s]
[0m18:01:25.070503 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m18:01:25.075455 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m18:01:25.080641 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m18:01:25.082562 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m18:01:25.082562 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m18:01:25.100346 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m18:01:25.106001 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 18:01:25.082562 => 18:01:25.106001
[0m18:01:25.110126 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m18:01:25.120634 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m18:01:25.970220 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m18:01:25.978611 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m18:01:26.330280 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8d8e4711-fec5-4afb-a50c-1da36bd2ed06&page=queryresults
[0m18:01:28.260378 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 18:01:25.110126 => 18:01:28.260378
[0m18:01:28.270427 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7156461f-3f44-46cb-9632-3cbbc2463bde', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254BAD92F10>]}
[0m18:01:28.275521 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (356.0 rows, 110.4 KiB processed)[0m in 3.19s]
[0m18:01:28.280188 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m18:01:28.280188 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:01:28.286656 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m18:01:28.286656 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_az' was properly closed.
[0m18:01:28.286656 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m18:01:28.290436 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m18:01:28.290436 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m18:01:28.290436 [info ] [MainThread]: 
[0m18:01:28.290436 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 9.57 seconds (9.57s).
[0m18:01:28.296173 [debug] [MainThread]: Command end result
[0m18:01:28.362949 [info ] [MainThread]: 
[0m18:01:28.362949 [info ] [MainThread]: [32mCompleted successfully[0m
[0m18:01:28.370278 [info ] [MainThread]: 
[0m18:01:28.370278 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m18:01:28.370278 [debug] [MainThread]: Command `dbt run` succeeded at 18:01:28.370278 after 10.58 seconds
[0m18:01:28.380250 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254B7383460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254BAA686A0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000254BA97AEB0>]}
[0m18:01:28.380250 [debug] [MainThread]: Flushing usage events
[0m10:03:00.947665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162D78733D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162D67E09D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162D67E0B80>]}


============================== 10:03:00.979454 | 049e3b02-e6ac-43ec-9862-4dbd792ee160 ==============================
[0m10:03:00.979454 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:03:00.979454 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'invocation_command': 'dbt run --exclude tag:snaps', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m10:03:02.546536 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162D67CAA30>]}
[0m10:03:02.626838 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DADCDA90>]}
[0m10:03:02.642944 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:03:02.669315 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:03:02.820502 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:03:02.821518 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:03:02.829282 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DB1D6520>]}
[0m10:03:02.841182 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DAF38B80>]}
[0m10:03:02.841182 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:03:02.841182 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DAE48D30>]}
[0m10:03:02.841182 [info ] [MainThread]: 
[0m10:03:02.841182 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:03:02.856972 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:03:02.856972 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:03:02.856972 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:03:02.856972 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:03:03.748553 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:03:04.422709 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:03:04.422709 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:03:04.454213 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m10:03:04.454721 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:03:05.074533 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m10:03:05.074533 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:03:05.122975 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m10:03:05.122975 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:03:06.035193 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DB2087C0>]}
[0m10:03:06.035193 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:03:06.035193 [info ] [MainThread]: 
[0m10:03:06.052109 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:03:06.052109 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m10:03:06.052109 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m10:03:06.052109 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m10:03:06.067849 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m10:03:06.067849 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m10:03:06.082989 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m10:03:06.098687 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m10:03:06.098687 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m10:03:06.098687 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:03:06.098687 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 10:03:06.067849 => 10:03:06.098687
[0m10:03:06.098687 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m10:03:06.130668 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 10:03:06.098687 => 10:03:06.130668
[0m10:03:06.130668 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m10:03:06.130668 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m10:03:06.130668 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:03:06.130668 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:03:06.130668 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:03:06.142314 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m10:03:06.142314 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m10:03:06.971303 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3b9e71a1-a745-4259-9d15-2882ec880253&page=queryresults
[0m10:03:06.980255 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ea2d51e6-0d1f-4e5c-a3e3-f803e62a5fc7&page=queryresults
[0m10:03:07.410645 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 10:03:06.130668 => 10:03:07.410645
[0m10:03:07.410645 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC2D1C40>]}
[0m10:03:07.410645 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.36s]
[0m10:03:07.410645 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:03:07.410645 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m10:03:07.410645 [info ] [Thread-1  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m10:03:07.410645 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_composicao_produto)
[0m10:03:07.410645 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m10:03:07.410645 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m10:03:07.410645 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 10:03:07.410645 => 10:03:07.410645
[0m10:03:07.410645 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m10:03:07.426435 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m10:03:07.426435 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:03:07.426435 [debug] [Thread-1  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m10:03:07.442094 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 10:03:06.098687 => 10:03:07.442094
[0m10:03:07.458289 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC2D12B0>]}
[0m10:03:07.458289 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.39s]
[0m10:03:07.461320 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m10:03:07.461320 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_compra
[0m10:03:07.461320 [info ] [Thread-2  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m10:03:07.461320 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_compra)
[0m10:03:07.461320 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_compra
[0m10:03:07.461320 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m10:03:07.461320 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (compile): 10:03:07.461320 => 10:03:07.461320
[0m10:03:07.461320 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_compra
[0m10:03:07.461320 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m10:03:07.461320 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:03:07.461320 [debug] [Thread-2  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m10:03:08.208799 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9e036a4e-1b46-40a1-92eb-f06ac221e958&page=queryresults
[0m10:03:08.242699 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:05722f98-b932-4ec9-8a1e-4835aee0bb3d&page=queryresults
[0m10:03:08.620889 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_compra (execute): 10:03:07.461320 => 10:03:08.620889
[0m10:03:08.622752 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC3108B0>]}
[0m10:03:08.624766 [info ] [Thread-2  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.16s]
[0m10:03:08.624766 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_compra
[0m10:03:08.624766 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m10:03:08.624766 [info ] [Thread-2  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m10:03:08.630889 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_forma_pagamento)
[0m10:03:08.630889 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m10:03:08.640877 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 10:03:07.426435 => 10:03:08.640877
[0m10:03:08.640877 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m10:03:08.640877 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC2B7430>]}
[0m10:03:08.640877 [info ] [Thread-1  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.23s]
[0m10:03:08.640877 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m10:03:08.640877 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m10:03:08.640877 [info ] [Thread-1  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m10:03:08.640877 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 10:03:08.630889 => 10:03:08.640877
[0m10:03:08.653156 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_imagem_produto)
[0m10:03:08.654568 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m10:03:08.654568 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m10:03:08.660659 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m10:03:08.660659 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m10:03:08.660659 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 10:03:08.660659 => 10:03:08.660659
[0m10:03:08.660659 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:03:08.660659 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m10:03:08.660659 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m10:03:08.686714 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m10:03:08.686714 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:03:08.703458 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m10:03:09.391065 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:5972722f-3d20-4a22-848b-4ac116608c1a&page=queryresults
[0m10:03:09.512327 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:96dcbd52-3498-4cb3-b521-1576f277fadc&page=queryresults
[0m10:03:09.757716 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 10:03:08.660659 => 10:03:09.757716
[0m10:03:09.757716 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC38D640>]}
[0m10:03:09.757716 [info ] [Thread-1  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.10s]
[0m10:03:09.757716 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m10:03:09.757716 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m10:03:09.757716 [info ] [Thread-1  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m10:03:09.773615 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_compra)
[0m10:03:09.773615 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m10:03:09.773615 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m10:03:09.785813 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 10:03:09.773615 => 10:03:09.773615
[0m10:03:09.785813 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m10:03:09.789262 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m10:03:09.789262 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:03:09.789262 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m10:03:09.907211 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 10:03:08.654568 => 10:03:09.907211
[0m10:03:09.907211 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC2AB9D0>]}
[0m10:03:09.907211 [info ] [Thread-2  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.28s]
[0m10:03:09.916304 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m10:03:09.916304 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m10:03:09.916304 [info ] [Thread-2  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m10:03:09.916304 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m10:03:09.916304 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m10:03:09.916304 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m10:03:09.916304 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 10:03:09.916304 => 10:03:09.916304
[0m10:03:09.916304 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m10:03:09.916304 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m10:03:09.916304 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:03:09.931951 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m10:03:10.636022 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e6e989c6-355e-4e31-bb44-991a362a8fd5&page=queryresults
[0m10:03:10.636022 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:eb10da0c-688b-4c11-bc52-ff0c09ad432b&page=queryresults
[0m10:03:11.036272 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 10:03:09.916304 => 10:03:11.030831
[0m10:03:11.036272 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC35AB20>]}
[0m10:03:11.036272 [info ] [Thread-2  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.12s]
[0m10:03:11.036272 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m10:03:11.036272 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m10:03:11.036272 [info ] [Thread-2  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m10:03:11.036272 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_meta_margem_preco)
[0m10:03:11.036272 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m10:03:11.036272 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m10:03:11.036272 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 10:03:11.036272 => 10:03:11.036272
[0m10:03:11.036272 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m10:03:11.052546 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m10:03:11.052546 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:03:11.055884 [debug] [Thread-2  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m10:03:11.089045 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 10:03:09.785813 => 10:03:11.089045
[0m10:03:11.090576 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC3CCE80>]}
[0m10:03:11.092108 [info ] [Thread-1  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m10:03:11.092616 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m10:03:11.092616 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_pedido
[0m10:03:11.092616 [info ] [Thread-1  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m10:03:11.092616 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_pedido)
[0m10:03:11.092616 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m10:03:11.092616 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m10:03:11.092616 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 10:03:11.092616 => 10:03:11.092616
[0m10:03:11.092616 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_pedido
[0m10:03:11.099755 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m10:03:11.099755 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:03:11.099755 [debug] [Thread-1  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m10:03:11.960803 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:49a8646e-cd5f-4445-9626-01396ede01bd&page=queryresults
[0m10:03:11.992732 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:860bda4f-cd5d-4458-83c4-1c2d6838b712&page=queryresults
[0m10:03:12.365480 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 10:03:11.036272 => 10:03:12.365480
[0m10:03:12.367494 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC2C4880>]}
[0m10:03:12.369510 [info ] [Thread-2  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.33s]
[0m10:03:12.371525 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m10:03:12.373940 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto
[0m10:03:12.373940 [info ] [Thread-2  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m10:03:12.375449 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m10:03:12.378058 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto
[0m10:03:12.385789 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m10:03:12.385789 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 10:03:11.099755 => 10:03:12.385789
[0m10:03:12.385789 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC33A100>]}
[0m10:03:12.390773 [info ] [Thread-1  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.29s]
[0m10:03:12.390773 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_pedido
[0m10:03:12.390773 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m10:03:12.390773 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (compile): 10:03:12.378058 => 10:03:12.390773
[0m10:03:12.395110 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto
[0m10:03:12.394440 [info ] [Thread-1  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m10:03:12.400799 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m10:03:12.400799 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m10:03:12.400799 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m10:03:12.406754 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m10:03:12.406754 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:03:12.406754 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 10:03:12.400799 => 10:03:12.406754
[0m10:03:12.410775 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m10:03:12.410775 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m10:03:12.414123 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m10:03:12.450800 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:03:12.454177 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m10:03:13.130773 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d1a0a650-8dc5-47de-8121-26fbe4679153&page=queryresults
[0m10:03:13.140773 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9841dea4-c9f8-43f5-ad6c-7e4802b83cf7&page=queryresults
[0m10:03:13.513976 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 10:03:12.410775 => 10:03:13.513976
[0m10:03:13.513976 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC3AA280>]}
[0m10:03:13.513976 [info ] [Thread-1  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.11s]
[0m10:03:13.520774 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m10:03:13.520774 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m10:03:13.520774 [info ] [Thread-1  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m10:03:13.525889 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.stg_tempo)
[0m10:03:13.527138 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m10:03:13.530789 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m10:03:13.530789 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 10:03:13.527138 => 10:03:13.530789
[0m10:03:13.530789 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m10:03:13.536943 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m10:03:13.538950 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:03:13.540957 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m10:03:13.582151 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto (execute): 10:03:12.395110 => 10:03:13.582151
[0m10:03:13.582151 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC2ABE20>]}
[0m10:03:13.586374 [info ] [Thread-2  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m10:03:13.586374 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto
[0m10:03:13.586374 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m10:03:13.586374 [info ] [Thread-2  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m10:03:13.590775 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.dm_produto)
[0m10:03:13.590775 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m10:03:13.597807 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m10:03:13.597807 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 10:03:13.590775 => 10:03:13.597807
[0m10:03:13.600868 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m10:03:13.613833 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:03:14.247898 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m10:03:14.260775 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m10:03:14.284412 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:26fa6026-75e2-47aa-962d-21305d2ec20b&page=queryresults
[0m10:03:14.650773 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 10:03:13.530789 => 10:03:14.650773
[0m10:03:14.650773 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC410DF0>]}
[0m10:03:14.655385 [info ] [Thread-1  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m10:03:14.655385 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m10:03:14.845558 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3da70039-4e23-4d7d-b575-c2cd754d78f2&page=queryresults
[0m10:03:17.092634 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 10:03:13.600868 => 10:03:17.092634
[0m10:03:17.092634 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC3B5580>]}
[0m10:03:17.094691 [info ] [Thread-2  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 3.50s]
[0m10:03:17.094691 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m10:03:17.094691 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m10:03:17.096747 [info ] [Thread-1  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m10:03:17.096747 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m10:03:17.096747 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m10:03:17.102914 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m10:03:17.103995 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 10:03:17.096747 => 10:03:17.103995
[0m10:03:17.103995 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m10:03:17.112076 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:03:17.825707 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m10:03:17.828303 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m10:03:18.453732 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:af16c24b-bb37-4e0d-ba5e-ef2adfb66b67&page=queryresults
[0m10:03:20.692291 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 10:03:17.106000 => 10:03:20.692291
[0m10:03:20.692291 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC2936A0>]}
[0m10:03:20.692291 [info ] [Thread-1  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 3.60s]
[0m10:03:20.692291 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m10:03:20.698224 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m10:03:20.698224 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m10:03:20.698224 [info ] [Thread-2  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m10:03:20.698224 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m10:03:20.698224 [info ] [Thread-1  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m10:03:20.698224 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m10:03:20.698224 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m10:03:20.706993 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m10:03:20.706993 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m10:03:20.708329 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m10:03:20.708329 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 10:03:20.698224 => 10:03:20.708329
[0m10:03:20.713907 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m10:03:20.713907 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:03:20.713907 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 10:03:20.708329 => 10:03:20.713907
[0m10:03:20.718230 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m10:03:20.718230 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:03:21.350676 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m10:03:21.350676 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m10:03:21.364742 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m10:03:21.364742 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m10:03:21.948539 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:24247b64-d994-47d8-9ad4-e64002342104&page=queryresults
[0m10:03:22.098587 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0dfcc163-1d87-4f98-ba2c-1ae30951f200&page=queryresults
[0m10:03:24.119155 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 10:03:20.718230 => 10:03:24.118631
[0m10:03:24.120443 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC4260A0>]}
[0m10:03:24.121727 [info ] [Thread-1  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 3.42s]
[0m10:03:24.123065 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m10:03:24.123065 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m10:03:24.123065 [info ] [Thread-1  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m10:03:24.123065 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_estoque_geral)
[0m10:03:24.128526 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m10:03:24.132251 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m10:03:24.132251 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 10:03:24.128526 => 10:03:24.132251
[0m10:03:24.132251 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m10:03:24.138425 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:03:24.380780 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 10:03:20.713907 => 10:03:24.380780
[0m10:03:24.384367 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DB25EC40>]}
[0m10:03:24.384367 [info ] [Thread-2  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 3.69s]
[0m10:03:24.384367 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m10:03:24.384367 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_pedido
[0m10:03:24.388548 [info ] [Thread-2  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m10:03:24.388548 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_pedido)
[0m10:03:24.388548 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m10:03:24.395174 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m10:03:24.396173 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 10:03:24.390487 => 10:03:24.396173
[0m10:03:24.397174 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_pedido
[0m10:03:24.399744 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:03:24.758826 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m10:03:24.758826 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m10:03:25.039808 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m10:03:25.041778 [debug] [Thread-2  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m10:03:25.068525 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e569430f-310e-4026-a560-98de7d34ddd9&page=queryresults
[0m10:03:25.630806 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3196cc6d-3437-42cc-ba75-476011d0cf5c&page=queryresults
[0m10:03:26.960869 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 10:03:24.132251 => 10:03:26.960869
[0m10:03:26.960869 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC339DF0>]}
[0m10:03:26.960869 [info ] [Thread-1  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 2.84s]
[0m10:03:26.960869 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m10:03:26.960869 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m10:03:26.960869 [info ] [Thread-1  ]: 20 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m10:03:26.968805 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m10:03:26.968805 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m10:03:26.970876 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m10:03:26.970876 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 10:03:26.968805 => 10:03:26.970876
[0m10:03:26.975620 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m10:03:26.975620 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:03:27.562149 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m10:03:27.565440 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m10:03:27.937607 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:415ba18d-06a0-473e-8afd-cf753bf6edaf&page=queryresults
[0m10:03:28.130802 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 10:03:24.397174 => 10:03:28.128630
[0m10:03:28.130802 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DD45ACA0>]}
[0m10:03:28.130802 [info ] [Thread-2  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.74s]
[0m10:03:28.130802 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_pedido
[0m10:03:28.138482 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m10:03:28.138482 [info ] [Thread-2  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m10:03:28.138482 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m10:03:28.138482 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m10:03:28.146751 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m10:03:28.146751 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 10:03:28.138482 => 10:03:28.146751
[0m10:03:28.148763 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m10:03:28.158478 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:03:29.049919 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m10:03:29.053951 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m10:03:29.438724 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:be5de110-582b-4d9c-8cb5-4833966b1e28&page=queryresults
[0m10:03:30.198744 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 10:03:26.975620 => 10:03:30.198744
[0m10:03:30.198744 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DD41C5B0>]}
[0m10:03:30.208560 [info ] [Thread-1  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 3.24s]
[0m10:03:30.208560 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m10:03:30.208560 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m10:03:30.208560 [info ] [Thread-1  ]: 22 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m10:03:30.212428 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m10:03:30.212428 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m10:03:30.212428 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m10:03:30.218571 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 10:03:30.212428 => 10:03:30.218571
[0m10:03:30.218571 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m10:03:30.218571 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:03:30.833291 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m10:03:30.833291 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m10:03:31.472950 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e04c5e1a-5dda-49e4-be28-46dc3ed776e1&page=queryresults
[0m10:03:31.889496 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 10:03:28.148763 => 10:03:31.889496
[0m10:03:31.889496 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC2936A0>]}
[0m10:03:31.897716 [info ] [Thread-2  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.5 KiB processed)[0m in 3.75s]
[0m10:03:31.898499 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m10:03:31.898499 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:03:31.900811 [info ] [Thread-2  ]: 23 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m10:03:31.900811 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m10:03:31.900811 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:03:31.909610 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m10:03:31.909610 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 10:03:31.900811 => 10:03:31.909610
[0m10:03:31.913177 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:03:31.913177 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:03:32.522534 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m10:03:32.524542 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m10:03:32.852253 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:a420a0cb-4c25-4a1f-a5da-ec8219599f44&page=queryresults
[0m10:03:34.957329 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 10:03:30.218571 => 10:03:34.957329
[0m10:03:34.957329 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC3B0940>]}
[0m10:03:34.957329 [info ] [Thread-1  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 4.75s]
[0m10:03:34.957329 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m10:03:34.957329 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m10:03:34.957329 [info ] [Thread-1  ]: 24 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m10:03:34.965017 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m10:03:34.965017 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m10:03:34.970532 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m10:03:34.972376 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 10:03:34.965017 => 10:03:34.970532
[0m10:03:34.972376 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m10:03:34.983168 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:03:35.142358 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 10:03:31.913177 => 10:03:35.139816
[0m10:03:35.142358 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC2936A0>]}
[0m10:03:35.666321 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m10:03:35.666321 [debug] [Thread-1  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m10:03:35.858266 [info ] [Thread-2  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.6 KiB processed)[0m in 3.24s]
[0m10:03:35.860269 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:03:35.860269 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m10:03:35.860269 [info ] [Thread-2  ]: 25 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m10:03:35.860269 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m10:03:35.860269 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m10:03:35.860269 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m10:03:35.860269 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 10:03:35.860269 => 10:03:35.860269
[0m10:03:35.860269 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m10:03:35.873541 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:03:36.391298 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2961b110-e481-4751-bd9e-9cec8ec980d3&page=queryresults
[0m10:03:36.502825 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m10:03:36.502825 [debug] [Thread-2  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m10:03:36.949352 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:e6eec543-32c7-472e-87e2-ff6553c77d6f&page=queryresults
[0m10:03:38.897640 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 10:03:34.972376 => 10:03:38.897640
[0m10:03:38.897640 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC253550>]}
[0m10:03:38.897640 [info ] [Thread-1  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 3.94s]
[0m10:03:38.906920 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m10:03:39.446857 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 10:03:35.860269 => 10:03:39.446857
[0m10:03:39.446857 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DD4AFA00>]}
[0m10:03:39.446857 [info ] [Thread-2  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 3.59s]
[0m10:03:39.446857 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m10:03:39.446857 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m10:03:39.446857 [info ] [Thread-1  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m10:03:39.446857 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m10:03:39.446857 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m10:03:39.463004 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m10:03:39.463004 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 10:03:39.446857 => 10:03:39.463004
[0m10:03:39.463004 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m10:03:39.467615 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:03:40.177959 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m10:03:40.177959 [debug] [Thread-1  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    where ds_status_compra in ('EM ABERTO')
)

, cte_joins as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,a.qt_estoque_minimo                as qt_estoque_minimo
         ,a.qt_estoque_atual                 as qt_estoque_atual
         ,a.vl_custo_total                   as vl_custo_total
         ,a.vl_preco_venda                   as vl_preco_venda
         ,sum(b.qt_item)                     as qt_item_compra_pendente
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m10:03:40.691887 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8187ad0a-04c5-4307-b266-01a0460dc2d4&page=queryresults
[0m10:03:45.008012 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 10:03:39.467615 => 10:03:45.007504
[0m10:03:45.009756 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '049e3b02-e6ac-43ec-9862-4dbd792ee160', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DD4473A0>]}
[0m10:03:45.010264 [info ] [Thread-1  ]: 26 of 26 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 5.56s]
[0m10:03:45.010264 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m10:03:45.010264 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:03:45.010264 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:03:45.010264 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:03:45.010264 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m10:03:45.010264 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m10:03:45.010264 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m10:03:45.010264 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m10:03:45.010264 [info ] [MainThread]: 
[0m10:03:45.010264 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 42.17 seconds (42.17s).
[0m10:03:45.019667 [debug] [MainThread]: Command end result
[0m10:03:45.042575 [info ] [MainThread]: 
[0m10:03:45.044860 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:03:45.045473 [info ] [MainThread]: 
[0m10:03:45.045473 [info ] [MainThread]: Done. PASS=26 WARN=0 ERROR=0 SKIP=0 TOTAL=26
[0m10:03:45.045473 [debug] [MainThread]: Command `dbt run` succeeded at 10:03:45.045473 after 44.17 seconds
[0m10:03:45.045473 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162D78733D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC249730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000162DC3D1D60>]}
[0m10:03:45.045473 [debug] [MainThread]: Flushing usage events
[0m10:03:47.948068 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DF22B3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DF12396D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DF1239AF0>]}


============================== 10:03:47.948068 | 082d1dc8-9812-41a7-8141-811dfbd04b52 ==============================
[0m10:03:47.948068 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:03:47.948068 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:03:48.435843 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '082d1dc8-9812-41a7-8141-811dfbd04b52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DF1219970>]}
[0m10:03:48.499668 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '082d1dc8-9812-41a7-8141-811dfbd04b52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DF5825AC0>]}
[0m10:03:48.515689 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:03:48.515689 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:03:48.563791 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:03:48.563791 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:03:48.579936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '082d1dc8-9812-41a7-8141-811dfbd04b52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DF5C14BB0>]}
[0m10:03:48.579936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '082d1dc8-9812-41a7-8141-811dfbd04b52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DF5B2F700>]}
[0m10:03:48.579936 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:03:48.596039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '082d1dc8-9812-41a7-8141-811dfbd04b52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DF5B2F6A0>]}
[0m10:03:48.596656 [info ] [MainThread]: 
[0m10:03:48.596656 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:03:48.596656 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:03:48.596656 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:03:49.234509 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:03:49.234509 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:03:49.250488 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m10:03:49.250488 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:03:49.822563 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m10:03:49.822563 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:03:49.854356 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m10:03:49.854356 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:03:50.435615 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '082d1dc8-9812-41a7-8141-811dfbd04b52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DF59DE5E0>]}
[0m10:03:50.435615 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:03:50.435615 [info ] [MainThread]: 
[0m10:03:50.435615 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:03:50.448086 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m10:03:50.448086 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m10:03:50.448086 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:03:50.459275 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 10:03:50.448086 => 10:03:50.457270
[0m10:03:50.459275 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:03:50.502866 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:03:50.504871 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m10:03:51.327729 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8aca7ebd-59ad-41af-bea4-05c92194143a&page=queryresults
[0m10:03:52.459687 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m10:03:52.874524 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:49a5e728-210c-4f31-8dfc-f0673837bb1e&page=queryresults
[0m10:03:55.175828 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m10:03:55.871247 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m10:03:55.871247 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m10:03:56.253746 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3ac5fb7f-e77d-40f3-8e70-d33ebe953aa3&page=queryresults
[0m10:03:58.472626 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 10:03:50.459275 => 10:03:58.472626
[0m10:03:58.472626 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '082d1dc8-9812-41a7-8141-811dfbd04b52', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DF6D335B0>]}
[0m10:03:58.472626 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (2.0 rows, 106.9 KiB processed)[0m in 8.02s]
[0m10:03:58.472626 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:03:58.472626 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:03:58.485600 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:03:58.485600 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m10:03:58.485600 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m10:03:58.485600 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m10:03:58.485600 [info ] [MainThread]: 
[0m10:03:58.485600 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 9.89 seconds (9.89s).
[0m10:03:58.485600 [debug] [MainThread]: Command end result
[0m10:03:58.501425 [info ] [MainThread]: 
[0m10:03:58.501425 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:03:58.501425 [info ] [MainThread]: 
[0m10:03:58.501425 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m10:03:58.501425 [debug] [MainThread]: Command `dbt snapshot` succeeded at 10:03:58.501425 after 10.61 seconds
[0m10:03:58.501425 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DF22B3430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DF5825AC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000026DF6CC70D0>]}
[0m10:03:58.501425 [debug] [MainThread]: Flushing usage events
[0m10:04:01.255271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7EA002400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E8F88640>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E8F88AC0>]}


============================== 10:04:01.255271 | 85d5d56b-f651-414d-a98e-e9a21acdd747 ==============================
[0m10:04:01.255271 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:04:01.255271 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'fail_fast': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:04:01.679509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '85d5d56b-f651-414d-a98e-e9a21acdd747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7E8F86190>]}
[0m10:04:01.743728 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '85d5d56b-f651-414d-a98e-e9a21acdd747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7ED672AF0>]}
[0m10:04:01.743728 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:04:01.743728 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:04:01.806475 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:04:01.806475 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:04:01.806475 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '85d5d56b-f651-414d-a98e-e9a21acdd747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7ED9683A0>]}
[0m10:04:01.822179 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '85d5d56b-f651-414d-a98e-e9a21acdd747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7ED868820>]}
[0m10:04:01.822179 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:04:01.822179 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '85d5d56b-f651-414d-a98e-e9a21acdd747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7ED84D220>]}
[0m10:04:01.822179 [info ] [MainThread]: 
[0m10:04:01.822179 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:04:01.822179 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:04:01.822179 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:04:02.483852 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m10:04:02.483852 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:04:02.483852 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:04:02.483852 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:04:03.073048 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_snapshots)
[0m10:04:03.073048 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:04:03.073048 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m10:04:03.073048 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:04:03.750688 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '85d5d56b-f651-414d-a98e-e9a21acdd747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7ED868D00>]}
[0m10:04:03.750688 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:04:03.754903 [info ] [MainThread]: 
[0m10:04:03.757927 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:04:03.757927 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m10:04:03.764678 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m10:04:03.764678 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:04:03.764678 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m10:04:03.764678 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 10:04:03.764678 => 10:04:03.764678
[0m10:04:03.764678 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:04:03.780728 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:04:04.379117 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m10:04:04.379117 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m10:04:04.892366 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9e31fe41-520b-409d-ae65-7ca0eb99308e&page=queryresults
[0m10:04:07.695090 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 10:04:03.764678 => 10:04:07.695090
[0m10:04:07.695090 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d5d56b-f651-414d-a98e-e9a21acdd747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7EE9DA9A0>]}
[0m10:04:07.695090 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (494.0 rows, 90.6 KiB processed)[0m in 3.93s]
[0m10:04:07.695090 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:04:07.695090 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m10:04:07.695090 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m10:04:07.695090 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m10:04:07.695090 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m10:04:07.695090 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m10:04:07.695090 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 10:04:07.695090 => 10:04:07.695090
[0m10:04:07.695090 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m10:04:07.710785 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:04:08.335915 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m10:04:08.341727 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m10:04:08.671038 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:40ff7850-becd-410c-9a98-12cc5d68585b&page=queryresults
[0m10:04:10.566175 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 10:04:07.695090 => 10:04:10.566175
[0m10:04:10.576655 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d5d56b-f651-414d-a98e-e9a21acdd747', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7EEA01DF0>]}
[0m10:04:10.576655 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (356.0 rows, 110.4 KiB processed)[0m in 2.87s]
[0m10:04:10.576655 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m10:04:10.576655 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:04:10.576655 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:04:10.576655 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m10:04:10.576655 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m10:04:10.576655 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m10:04:10.576655 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m10:04:10.576655 [info ] [MainThread]: 
[0m10:04:10.576655 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 8.75 seconds (8.75s).
[0m10:04:10.576655 [debug] [MainThread]: Command end result
[0m10:04:10.608552 [info ] [MainThread]: 
[0m10:04:10.608552 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:04:10.608552 [info ] [MainThread]: 
[0m10:04:10.608552 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m10:04:10.608552 [debug] [MainThread]: Command `dbt run` succeeded at 10:04:10.608552 after 9.41 seconds
[0m10:04:10.608552 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7EA002400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7ED672AF0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001E7ED868D30>]}
[0m10:04:10.608552 [debug] [MainThread]: Flushing usage events
[0m10:08:43.455190 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB90AAA3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8FA4F9D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8FA4FB80>]}


============================== 10:08:43.459583 | 9227c074-4748-413b-a8f1-6d9b695bb80b ==============================
[0m10:08:43.459583 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:08:43.459583 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'debug': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --exclude tag:snaps', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True'}
[0m10:08:44.023047 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8FA2A100>]}
[0m10:08:44.088128 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB94130850>]}
[0m10:08:44.089125 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:08:44.096127 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:08:44.161381 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:08:44.161381 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:08:44.166634 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB94428190>]}
[0m10:08:44.180703 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB94339F70>]}
[0m10:08:44.181712 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:08:44.181712 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB943391F0>]}
[0m10:08:44.183715 [info ] [MainThread]: 
[0m10:08:44.184709 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:08:44.188029 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:08:44.189029 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:08:44.190026 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:08:44.191024 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:08:45.073310 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:08:45.749073 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_snapshots'
[0m10:08:45.750995 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:08:45.752055 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:08:45.753060 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:08:46.484493 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m10:08:46.485491 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:08:46.525551 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_snapshots, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m10:08:46.525551 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:08:47.389463 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB9409B250>]}
[0m10:08:47.390467 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:08:47.391465 [info ] [MainThread]: 
[0m10:08:47.420993 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:08:47.422981 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_categoria_produto
[0m10:08:47.421978 [info ] [Thread-1  ]: 1 of 26 START sql view model dbt_dw_stg.stg_campo_customizado_produto .......... [RUN]
[0m10:08:47.424028 [info ] [Thread-2  ]: 2 of 26 START sql view model dbt_dw_stg.stg_categoria_produto .................. [RUN]
[0m10:08:47.428660 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_categoria_produto'
[0m10:08:47.428660 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_categoria_produto
[0m10:08:47.443209 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_categoria_produto"
[0m10:08:47.452892 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.stg_campo_customizado_produto'
[0m10:08:47.453893 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_campo_customizado_produto
[0m10:08:47.459443 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:08:47.460442 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (compile): 10:08:47.429666 => 10:08:47.459443
[0m10:08:47.460442 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_categoria_produto
[0m10:08:47.489761 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_categoria_produto"
[0m10:08:47.489761 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (compile): 10:08:47.453893 => 10:08:47.489761
[0m10:08:47.490663 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_campo_customizado_produto
[0m10:08:47.492663 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_campo_customizado_produto"
[0m10:08:47.493661 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:08:47.493661 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:08:47.495663 [debug] [Thread-1  ]: On model.shibaribrasil.stg_campo_customizado_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_campo_customizado_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_campo as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.campos_customizados                              as js_campos
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_campo_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_campo,
  unnest(json_extract_array(js_campos)) as json_element
)

, cte_campo_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.idCampoCustomizado') as string)  as cd_campo_customizado
          ,cast(json_value(a.json_element, '$.idVinculo') as string)           as cd_vinculo
          ,cast(json_value(a.json_element, '$.valor') as string)               as cd_valor
          ,cast(json_value(a.json_element, '$.item') as string)                as ds_valor_campo
      from cte_campo_expandido as a
)

, cte_campo_base as (
  select cd_produto_bling
        ,cd_produto
        -- Pivoteia os campos
        ,max(if(cd_campo_customizado = '3435243', ds_valor_campo, null)) as ds_classificacao_produto
        ,max(if(cd_campo_customizado = '3437664', ds_valor_campo, null)) as ds_origem_produto
        ,max(if(cd_campo_customizado = '3437920', cd_valor, null))       as vl_alteracao_preco

        
    from cte_campo_expandido_base
group by cd_produto_bling, cd_produto
)

  select cd_produto_bling
        ,cd_produto
        ,ds_classificacao_produto
        ,ds_origem_produto
        ,cast(replace(vl_alteracao_preco, ',', '.') as float64) vl_alteracao_preco
   from cte_campo_base;


[0m10:08:47.518974 [debug] [Thread-2  ]: On model.shibaribrasil.stg_categoria_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_categoria_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_categoria as (
   select nullif(trim(id), '')                                                                     as cd_categoria
         ,nullif(trim(descricao), '')                                                              as nm_categoria
         ,nullif(nullif(trim(categoria_pai__id), ''),'0')                                          as cd_categoria_pai
         ,if(nullif(nullif(trim(categoria_pai__id), ''),'0') is null, 'CATEGORIA', 'SUBCATEGORIA') as ds_tipo_categoria
     from `igneous-sandbox-381622`.`datalake_bling`.`categorias_produtos`
)

select *
  from cte_categoria;


[0m10:08:48.256215 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0be54b5a-8178-44d3-b8e9-0192a35fab24&page=queryresults
[0m10:08:48.260221 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:52da8a18-6f19-4da8-8d3b-9a4b013cf231&page=queryresults
[0m10:08:48.690340 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_categoria_produto (execute): 10:08:47.461487 => 10:08:48.690340
[0m10:08:48.691340 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB94478700>]}
[0m10:08:48.692340 [info ] [Thread-2  ]: 2 of 26 OK created sql view model dbt_dw_stg.stg_categoria_produto ............. [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m10:08:48.693288 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_categoria_produto
[0m10:08:48.694422 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_composicao_produto
[0m10:08:48.694422 [info ] [Thread-2  ]: 3 of 26 START sql view model dbt_dw_stg.stg_composicao_produto ................. [RUN]
[0m10:08:48.695392 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_categoria_produto, now model.shibaribrasil.stg_composicao_produto)
[0m10:08:48.696428 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_composicao_produto
[0m10:08:48.699362 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_composicao_produto"
[0m10:08:48.700331 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (compile): 10:08:48.696428 => 10:08:48.699362
[0m10:08:48.700331 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_composicao_produto
[0m10:08:48.704359 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_composicao_produto"
[0m10:08:48.705354 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:08:48.706309 [debug] [Thread-2  ]: On model.shibaribrasil.stg_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_composicao_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_composicao as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.estrutura__componentes                           as js_componentes
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_componentes_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_composicao,
  unnest(json_extract_array(js_componentes)) as json_element
)

, cte_componentes_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.produto.id') as string)      as cd_produto_bling_componente
          ,cast(json_value(a.json_element, '$.quantidade') as int64)       as qt_componente
      from cte_componentes_expandido as a
)

select *
  from cte_componentes_expandido_base;


[0m10:08:48.729391 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_campo_customizado_produto (execute): 10:08:47.490663 => 10:08:48.728364
[0m10:08:48.729391 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB95526C10>]}
[0m10:08:48.730392 [info ] [Thread-1  ]: 1 of 26 OK created sql view model dbt_dw_stg.stg_campo_customizado_produto ..... [[32mCREATE VIEW (0 processed)[0m in 1.31s]
[0m10:08:48.730392 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_campo_customizado_produto
[0m10:08:48.731336 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_compra
[0m10:08:48.731336 [info ] [Thread-1  ]: 4 of 26 START sql view model dbt_dw_stg.stg_compra ............................. [RUN]
[0m10:08:48.732329 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_campo_customizado_produto, now model.shibaribrasil.stg_compra)
[0m10:08:48.732329 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_compra
[0m10:08:48.734402 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_compra"
[0m10:08:48.735388 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (compile): 10:08:48.732329 => 10:08:48.735388
[0m10:08:48.735388 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_compra
[0m10:08:48.737389 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_compra"
[0m10:08:48.738399 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:08:48.739346 [debug] [Thread-1  ]: On model.shibaribrasil.stg_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_compra as (
  select nullif(trim(id), '')                                   as cd_codigo_interno
        ,nullif(trim(numero), '')                               as cd_compra
        ,nullif(trim(data), '')                                 as dt_compra
        ,nullif(nullif(trim(data_prevista), ''), '0000-00-00')  as dt_prevista_compra
        ,nullif(trim(fornecedor__id), '')                       as cd_fornecedor
        ,nullif(trim(total_produtos), '')                       as vl_total_item
        ,nullif(trim(total), '')                                as vl_total_compra
        ,nullif(trim(situacao__valor), '')                      as cd_situacao_valor
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras`
)

, cte_tratamentos_compra as (
  select cd_codigo_interno                                as cd_codigo_interno
        ,cd_compra                                        as cd_compra
        ,cast(dt_compra as date)                          as dt_compra
        ,cast(dt_prevista_compra as date)                 as dt_prevista_compra
        ,cd_fornecedor                                    as cd_fornecedor
        ,vl_total_item                                    as vl_total_item
        ,vl_total_compra                                  as vl_total_compra
        ,case
          when cd_situacao_valor = '2' then 'CANCELADO'
          when cd_situacao_valor = '1' then 'ATENDIDO' 
          when cd_situacao_valor = '0' then 'EM ABERTO'
          else null                                      end ds_status_compra
    from cte_compra 
)

select *
  from cte_tratamentos_compra;


[0m10:08:49.473123 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3225c80a-d080-4944-95b3-ff1d9b6ce7b7&page=queryresults
[0m10:08:49.501683 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:4c1680a0-9df9-49ef-85fc-0a35579eeb5a&page=queryresults
[0m10:08:49.912472 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_composicao_produto (execute): 10:08:48.700331 => 10:08:49.912472
[0m10:08:49.914469 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB94478A30>]}
[0m10:08:49.916472 [info ] [Thread-2  ]: 3 of 26 OK created sql view model dbt_dw_stg.stg_composicao_produto ............ [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m10:08:49.918471 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_composicao_produto
[0m10:08:49.919469 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_forma_pagamento
[0m10:08:49.920462 [info ] [Thread-2  ]: 5 of 26 START sql view model dbt_dw_stg.stg_forma_pagamento .................... [RUN]
[0m10:08:49.921582 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_composicao_produto, now model.shibaribrasil.stg_forma_pagamento)
[0m10:08:49.921582 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_forma_pagamento
[0m10:08:49.926468 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_forma_pagamento"
[0m10:08:49.928471 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (compile): 10:08:49.922562 => 10:08:49.928471
[0m10:08:49.929468 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_forma_pagamento
[0m10:08:49.934464 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_forma_pagamento"
[0m10:08:49.935467 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:08:49.937464 [debug] [Thread-2  ]: On model.shibaribrasil.stg_forma_pagamento: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_forma_pagamento"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
  OPTIONS(
      description=""""""
    )
  as 

with cte_forma_pagamento as (
   select nullif(trim(id), '')                                                          as cd_forma_pagamento
         ,nullif(trim(descricao), '')                                                   as nm_forma_pagamento
         ,nullif(trim(condicao), '')                                                    as ds_condicao_pagamento
         ,cast(taxas__prazo as float64)                                                 as qt_dias_pagamento
         ,cast(taxas__aliquota as float64)                                              as vl_taxa_aliquota
         ,cast(taxas__valor as float64)                                                 as vl_taxa_fixa
     from `igneous-sandbox-381622`.`datalake_bling`.`formas_pagamentos_detalhes`
)

select *
  from cte_forma_pagamento;


[0m10:08:49.969462 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_compra (execute): 10:08:48.736351 => 10:08:49.969462
[0m10:08:49.971463 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB954B1F10>]}
[0m10:08:49.971463 [info ] [Thread-1  ]: 4 of 26 OK created sql view model dbt_dw_stg.stg_compra ........................ [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m10:08:49.972468 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_compra
[0m10:08:49.973470 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_imagem_produto
[0m10:08:49.973470 [info ] [Thread-1  ]: 6 of 26 START sql view model dbt_dw_stg.stg_imagem_produto ..................... [RUN]
[0m10:08:49.975476 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_compra, now model.shibaribrasil.stg_imagem_produto)
[0m10:08:49.975476 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_imagem_produto
[0m10:08:49.979658 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_imagem_produto"
[0m10:08:49.980660 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (compile): 10:08:49.975476 => 10:08:49.980660
[0m10:08:49.981660 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_imagem_produto
[0m10:08:49.988660 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_imagem_produto"
[0m10:08:49.989166 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:08:49.991173 [debug] [Thread-1  ]: On model.shibaribrasil.stg_imagem_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_imagem_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_imagem as (
    select trim(a.id)                                         as cd_produto_bling
          ,nullif(trim(replace(a.codigo, '.', '')), '')       as cd_produto
          ,a.midia__imagens__internas                         as js_imagens
      from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
)

, cte_imagem_expandido as (
  select cd_produto_bling
        ,cd_produto
        ,json_element
    from cte_imagem,
  unnest(json_extract_array(js_imagens)) as json_element
)

, cte_imagem_expandido_base as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,cast(json_value(a.json_element, '$.link') as string)  as lk_imagem_produto
      from cte_imagem_expandido as a
)

  select cd_produto_bling
        ,cd_produto
        ,lk_imagem_produto
        ,row_number() over(partition by cd_produto_bling) as seq_imagem
   from cte_imagem_expandido_base;


[0m10:08:50.721373 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1e7e3e45-5959-41b6-b22f-d60a14fbc63f&page=queryresults
[0m10:08:51.098977 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:42634d13-3b90-44eb-9162-232d56b371b8&page=queryresults
[0m10:08:51.171082 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_imagem_produto (execute): 10:08:49.981660 => 10:08:51.171082
[0m10:08:51.173090 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB955B26A0>]}
[0m10:08:51.175090 [info ] [Thread-1  ]: 6 of 26 OK created sql view model dbt_dw_stg.stg_imagem_produto ................ [[32mCREATE VIEW (0 processed)[0m in 1.20s]
[0m10:08:51.177123 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_imagem_produto
[0m10:08:51.178120 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_item_compra
[0m10:08:51.178120 [info ] [Thread-1  ]: 7 of 26 START sql view model dbt_dw_stg.stg_item_compra ........................ [RUN]
[0m10:08:51.180134 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_imagem_produto, now model.shibaribrasil.stg_item_compra)
[0m10:08:51.181122 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_item_compra
[0m10:08:51.189110 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_compra"
[0m10:08:51.190108 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (compile): 10:08:51.182125 => 10:08:51.190108
[0m10:08:51.191639 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_item_compra
[0m10:08:51.194652 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_compra"
[0m10:08:51.195667 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:08:51.199089 [debug] [Thread-1  ]: On model.shibaribrasil.stg_item_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_compra"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_compra
        ,nullif(trim(data), '')                      as dt_compra
        ,nullif(trim(categoria__id), '')             as cd_categoria_financeira
        ,nullif(trim(observacoes), '')               as ds_observacoes
        ,itens
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_compras_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,cd_categoria_financeira
        ,ds_observacoes
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.cd_compra
         ,i.dt_compra
         ,i.cd_categoria_financeira
         ,i.ds_observacoes
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,json_value(i.json_item, '$.unidade')                          as ds_unidade
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
     from cte_itens_json i
)

   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.cd_categoria_financeira
         ,a.ds_observacoes
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.ds_unidade
         ,a.qt_item
         ,a.vl_item
     from cte_item               as a;


[0m10:08:51.500905 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_forma_pagamento (execute): 10:08:49.930466 => 10:08:51.500905
[0m10:08:51.501916 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB954B6340>]}
[0m10:08:51.502899 [info ] [Thread-2  ]: 5 of 26 OK created sql view model dbt_dw_stg.stg_forma_pagamento ............... [[32mCREATE VIEW (0 processed)[0m in 1.58s]
[0m10:08:51.504899 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_forma_pagamento
[0m10:08:51.505899 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_item_pedido
[0m10:08:51.506900 [info ] [Thread-2  ]: 8 of 26 START sql view model dbt_dw_stg.stg_item_pedido ........................ [RUN]
[0m10:08:51.508899 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_forma_pagamento, now model.shibaribrasil.stg_item_pedido)
[0m10:08:51.508899 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_item_pedido
[0m10:08:51.514898 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_item_pedido"
[0m10:08:51.515898 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (compile): 10:08:51.509914 => 10:08:51.515898
[0m10:08:51.516908 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_item_pedido
[0m10:08:51.519898 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_item_pedido"
[0m10:08:51.520902 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:08:51.522897 [debug] [Thread-2  ]: On model.shibaribrasil.stg_item_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_item_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_item_base as (
  select nullif(trim(id), '')                                 as cd_codigo_interno
        ,nullif(trim(data), '')                               as dt_pedido
        ,nullif(trim(desconto__unidade), '')                  as ds_tipo_desconto
        ,cast(nullif(trim(desconto__valor), '') as float64)   as vl_desconto
        ,itens
        ,parcelas
   from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas_detalhes`
)

, cte_itens_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_item
    from cte_item_base,
  unnest(json_extract_array(itens)) as json_item
)

, cte_parcelas_json as (
  select cd_codigo_interno
        ,dt_pedido
        ,ds_tipo_desconto
        ,vl_desconto
        ,json_parcela
    from cte_item_base,
  unnest(json_extract_array(parcelas)) as json_parcela
)

, cte_item as (
   select i.cd_codigo_interno
         ,i.dt_pedido
         ,i.ds_tipo_desconto
         ,i.vl_desconto
         ,trim(json_value(i.json_item, '$.produto.id'))                 as cd_produto_bling
         ,replace(trim(json_value(i.json_item, '$.codigo')), '.', '')   as cd_produto
         ,json_value(i.json_item, '$.descricao')                        as nm_produto_completo
         ,cast(json_value(i.json_item, '$.quantidade') as int64)        as qt_item
         ,cast(json_value(i.json_item, '$.valor') as float64)           as vl_item
         ,nullif(json_value(p.json_parcela, '$.observacoes'), '')       as ds_forma_pagamento
     from cte_itens_json i
left join cte_parcelas_json p
       on i.cd_codigo_interno = p.cd_codigo_interno
      and i.dt_pedido = p.dt_pedido
)

   select distinct
          a.cd_codigo_interno
         ,a.dt_pedido
         ,a.cd_produto_bling                                                         as cd_produto_bling
         ,a.cd_produto                                                               as cd_produto
         ,a.nm_produto_completo                                                      as nm_produto_completo
         ,a.qt_item                                                                  as qt_item
         ,a.vl_item                                                                  as vl_item
         ,a.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,a.vl_desconto                                                              as vl_desconto
         ,trim(replace(a.ds_forma_pagamento, 'MÃ©todo de pagamento:', ''))            as ds_forma_pagamento
     from cte_item               as a;


[0m10:08:51.889245 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d244bdef-9369-4685-83b3-878aaf341271&page=queryresults
[0m10:08:52.225110 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2363124a-782b-4cff-8d8e-d875ae3273b7&page=queryresults
[0m10:08:52.276645 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_item_compra (execute): 10:08:51.191639 => 10:08:52.276645
[0m10:08:52.277739 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB954D9B50>]}
[0m10:08:52.278842 [info ] [Thread-1  ]: 7 of 26 OK created sql view model dbt_dw_stg.stg_item_compra ................... [[32mCREATE VIEW (0 processed)[0m in 1.10s]
[0m10:08:52.280752 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_item_compra
[0m10:08:52.281751 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_meta_margem_preco
[0m10:08:52.281751 [info ] [Thread-1  ]: 9 of 26 START sql view model dbt_dw_stg.stg_meta_margem_preco .................. [RUN]
[0m10:08:52.283847 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_compra, now model.shibaribrasil.stg_meta_margem_preco)
[0m10:08:52.283847 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_meta_margem_preco
[0m10:08:52.289319 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_meta_margem_preco"
[0m10:08:52.291229 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (compile): 10:08:52.284844 => 10:08:52.291229
[0m10:08:52.292361 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_meta_margem_preco
[0m10:08:52.300440 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_meta_margem_preco"
[0m10:08:52.301500 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:08:52.303484 [debug] [Thread-1  ]: On model.shibaribrasil.stg_meta_margem_preco: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_meta_margem_preco"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
  OPTIONS(
      description=""""""
    )
  as 

with cte_meta as (
   select trim(ds_classificacao_produto)      as ds_classificacao_produto
         ,trim(ds_origem_produto)             as ds_origem_produto
         ,pr_desconto_padrao                  as pr_desconto_padrao 
         ,pr_meta_margem                      as pr_meta_margem 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_meta_margem_preco`
)

select ds_classificacao_produto
      ,ds_origem_produto
      ,pr_desconto_padrao 
      ,pr_meta_margem 
  from cte_meta;


[0m10:08:52.640404 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_item_pedido (execute): 10:08:51.516908 => 10:08:52.639420
[0m10:08:52.640404 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB95592160>]}
[0m10:08:52.641411 [info ] [Thread-2  ]: 8 of 26 OK created sql view model dbt_dw_stg.stg_item_pedido ................... [[32mCREATE VIEW (0 processed)[0m in 1.13s]
[0m10:08:52.642378 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_item_pedido
[0m10:08:52.643404 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_pedido
[0m10:08:52.643404 [info ] [Thread-2  ]: 10 of 26 START sql view model dbt_dw_stg.stg_pedido ............................ [RUN]
[0m10:08:52.644358 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_item_pedido, now model.shibaribrasil.stg_pedido)
[0m10:08:52.645413 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_pedido
[0m10:08:52.652519 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_pedido"
[0m10:08:52.656547 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (compile): 10:08:52.645413 => 10:08:52.655546
[0m10:08:52.661233 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_pedido
[0m10:08:52.668110 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_pedido"
[0m10:08:52.670052 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:08:52.672171 [debug] [Thread-2  ]: On model.shibaribrasil.stg_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_pedido"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
  OPTIONS(
      description=""""""
    )
  as 

with cte_pedido as (
  select nullif(trim(id), '')                        as cd_codigo_interno
        ,nullif(trim(numero), '')                    as cd_pedido
        ,nullif(trim(data), '')                      as dt_pedido
        ,nullif(trim(situacao__id), '')              as cd_status
        ,nullif(trim(total_produtos), '')            as vl_total_item
        ,nullif(trim(total), '')                     as vl_total_pedido
        ,nullif(trim(contato__id), '')               as cd_contato
        ,nullif(trim(contato__nome), '')             as nm_contato
        ,nullif(trim(contato__numero_documento), '') as nr_doc_contato
        ,nullif(trim(loja__id), '')                  as cd_loja
    from `igneous-sandbox-381622`.`datalake_bling`.`pedidos_vendas`
)

, cte_tratamentos_pedido as (
  select cd_codigo_interno                      as cd_codigo_interno
        ,cd_pedido                              as cd_pedido
        ,dt_pedido                              as dt_pedido
        ,cd_status                              as cd_status_pedido
        ,case
          when cd_status = '6'  then 'EM ABERTO'
          when cd_status = '12' then 'CANCELADO'
          when cd_status = '9'  then 'ATENDIDO'
          else null                            end ds_status_pedido
        ,cast(vl_total_item as float64)         as vl_total_item
        ,cast(vl_total_pedido as float64)       as vl_total_pedido
        ,cd_contato                             as cd_contato
        ,nm_contato                             as nm_contato
        ,nr_doc_contato                         as nr_doc_contato
        ,cd_loja                                as cd_loja
        ,case
          when cd_loja = '205060682' then 'Site'
          else null                            end ds_loja
    from cte_pedido 
)

select *
  from cte_tratamentos_pedido;


[0m10:08:53.336489 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:9e75bc50-05bf-426f-be56-9c5a66e8ca74&page=queryresults
[0m10:08:53.626206 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0336ae81-80a4-4518-9055-0448d7234b1f&page=queryresults
[0m10:08:53.733802 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_meta_margem_preco (execute): 10:08:52.292966 => 10:08:53.733802
[0m10:08:53.734806 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB954DC310>]}
[0m10:08:53.736797 [info ] [Thread-1  ]: 9 of 26 OK created sql view model dbt_dw_stg.stg_meta_margem_preco ............. [[32mCREATE VIEW (0 processed)[0m in 1.45s]
[0m10:08:53.738406 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_meta_margem_preco
[0m10:08:53.739402 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_produto
[0m10:08:53.740414 [info ] [Thread-1  ]: 11 of 26 START sql view model dbt_dw_stg.stg_produto ........................... [RUN]
[0m10:08:53.741407 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_meta_margem_preco, now model.shibaribrasil.stg_produto)
[0m10:08:53.742406 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_produto
[0m10:08:53.750032 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto"
[0m10:08:53.753018 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (compile): 10:08:53.743405 => 10:08:53.752031
[0m10:08:53.754033 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_produto
[0m10:08:53.759692 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto"
[0m10:08:53.761699 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:08:53.765705 [debug] [Thread-1  ]: On model.shibaribrasil.stg_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`
  OPTIONS(
      description=""""""
    )
  as 

with cte_produto as (
   select trim(a.id)                                                               as cd_produto_bling
         ,nullif(trim(replace(a.codigo, '.', '')), '')                             as cd_produto
         ,nullif(trim(a.gtin), '')                                                 as cd_codigo_barras
         ,nullif(trim(a.nome), '')                                                 as nm_produto_completo
         ,coalesce(cast(nullif(a.dimensoes__altura,'') as float64), 0)             as dm_altura
         ,coalesce(cast(nullif(a.dimensoes__largura,'') as float64), 0)            as dm_largura
         ,coalesce(cast(nullif(a.dimensoes__profundidade,'') as float64), 0)       as dm_profundidade
         ,coalesce(cast(nullif(a.peso_bruto,'') as float64), 0)                    as dm_peso_bruto
         ,coalesce(cast(nullif(a.peso_liquido,'') as float64), 0)                  as dm_peso_liquido
         ,coalesce(cast(nullif(a.estoque__minimo,'') as float64), 0)               as qt_estoque_minimo
         ,coalesce(cast(nullif(a.estoque__saldo_virtual_total,'') as float64), 0)  as qt_estoque_atual
         ,nullif(a.estrutura__tipo_estoque,'')                                     as ds_tipo_estoque
         ,cast(nullif(a.fornecedor__preco_compra,'') as float64)                   as vl_custo_compra
         ,cast(nullif(a.fornecedor__preco_custo,'') as float64)                    as vl_custo_total
         ,cast(nullif(a.preco,'') as float64)                                      as vl_preco_venda
         ,nullif(a.situacao,'')                                                    as ds_situacao
         ,nullif(a.tipo,'')                                                        as ds_tipo
         ,nullif(a.formato,'')                                                     as ds_formato
         ,nullif(a.categoria__id,'')                                               as cd_categoria
         ,nullif(a.descricao_curta,'')                                             as ds_descricao_produto
         ,nullif(trim(left(b.id_produto_pai,11)), '')                              as cd_produto_bling_pai
         ,datetime(timestamp(a._erathos_synced_at), "America/Sao_Paulo")           as dt_ultima_ingestao
     from `igneous-sandbox-381622`.`datalake_bling`.`produtos_detalhes`  as a
left join `igneous-sandbox-381622`.`datalake_bling`.`produtos`           as b 
       on trim(a.id) = trim(b.id) 
)

select *
  from cte_produto;


[0m10:08:54.017035 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_pedido (execute): 10:08:52.662231 => 10:08:54.015687
[0m10:08:54.018161 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB95523580>]}
[0m10:08:54.020162 [info ] [Thread-2  ]: 10 of 26 OK created sql view model dbt_dw_stg.stg_pedido ....................... [[32mCREATE VIEW (0 processed)[0m in 1.37s]
[0m10:08:54.021059 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_pedido
[0m10:08:54.022174 [debug] [Thread-2  ]: Began running node model.shibaribrasil.stg_produto_fabricado
[0m10:08:54.024165 [info ] [Thread-2  ]: 12 of 26 START sql view model dbt_dw_stg.stg_produto_fabricado ................. [RUN]
[0m10:08:54.026040 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_pedido, now model.shibaribrasil.stg_produto_fabricado)
[0m10:08:54.027408 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.stg_produto_fabricado
[0m10:08:54.034457 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.stg_produto_fabricado"
[0m10:08:54.040916 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (compile): 10:08:54.028462 => 10:08:54.039960
[0m10:08:54.041961 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.stg_produto_fabricado
[0m10:08:54.050913 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.stg_produto_fabricado"
[0m10:08:54.055295 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:08:54.060020 [debug] [Thread-2  ]: On model.shibaribrasil.stg_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_produto_fabricado"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
  OPTIONS(
      description=""""""
    )
  as 

with cte_base as (
   select replace(trim(cd_produto), '.', '')             as cd_produto
         ,trim(nm_produto_completo)                      as nm_produto_completo
         ,replace(trim(cd_produto_composicao), '.', '')  as cd_produto_composicao
         ,trim(nm_produto_completo_composicao)           as nm_produto_completo_composicao
         ,qt_produto_composicao                          as qt_produto_composicao 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_produto_fabricacao_propria`
    where trim(cd_produto) is not null
)

select cd_produto
      ,nm_produto_completo
      ,cd_produto_composicao 
      ,nm_produto_completo_composicao 
      ,qt_produto_composicao 
  from cte_base;


[0m10:08:54.509102 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:ecb869f5-aaf8-477e-b227-e2fecc9de28e&page=queryresults
[0m10:08:54.881668 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_produto (execute): 10:08:53.754033 => 10:08:54.881668
[0m10:08:54.882667 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB95678760>]}
[0m10:08:54.882667 [info ] [Thread-1  ]: 11 of 26 OK created sql view model dbt_dw_stg.stg_produto ...................... [[32mCREATE VIEW (0 processed)[0m in 1.14s]
[0m10:08:54.883686 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_produto
[0m10:08:54.883686 [debug] [Thread-1  ]: Began running node model.shibaribrasil.stg_tempo
[0m10:08:54.883686 [info ] [Thread-1  ]: 13 of 26 START sql view model dbt_dw_stg.stg_tempo ............................. [RUN]
[0m10:08:54.884686 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto, now model.shibaribrasil.stg_tempo)
[0m10:08:54.885686 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.stg_tempo
[0m10:08:54.888113 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.stg_tempo"
[0m10:08:54.889171 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (compile): 10:08:54.885686 => 10:08:54.889171
[0m10:08:54.890115 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.stg_tempo
[0m10:08:54.896171 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.stg_tempo"
[0m10:08:54.898802 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:44c26711-7656-49da-b1d4-8b294a62e7e6&page=queryresults
[0m10:08:54.903815 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:08:54.908483 [debug] [Thread-1  ]: On model.shibaribrasil.stg_tempo: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.stg_tempo"} */


  create or replace view `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
  OPTIONS(
      description=""""""
    )
  as 

with cte_drive as (
   select cast(dt_data as date)         as dt_data 	
         ,cast(nr_ano as int64)         as nr_ano	
         ,cast(nr_mes as int64)         as nr_mes	
         ,cast(nr_dia as int64)         as nr_dia	
         ,cast(nr_semana as int64)      as nr_semana	
         ,cast(dt_prim_dia_mes as date) as dt_prim_dia_mes	
         ,cast(dt_ult_dia_mes as date)  as dt_ult_dia_mes	
         ,ds_dia_semana                 as ds_dia_semana	
         ,ds_dia_semana_abrev           as ds_dia_semana_abreviado	
         ,ds_mes                        as ds_mes	
         ,ds_mes_abrev                  as ds_mes_abreviado	
         ,ds_trimestre                  as ds_trimestre	
         ,ds_semestre                   as ds_semestre	
         ,ds_ano_mes                    as ds_ano_mes	
         ,cast(fg_dia_util as int64)    as fg_dia_util	
         ,cast(fg_feriado as int64)     as fg_feriado	
         ,ds_feriado                    as ds_feriado 
     from `igneous-sandbox-381622`.`datalake_drive`.`drive_tempo` 
)

select *
  from cte_drive;


[0m10:08:55.286787 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.stg_produto_fabricado (execute): 10:08:54.042958 => 10:08:55.286787
[0m10:08:55.287807 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB95641D60>]}
[0m10:08:55.288805 [info ] [Thread-2  ]: 12 of 26 OK created sql view model dbt_dw_stg.stg_produto_fabricado ............ [[32mCREATE VIEW (0 processed)[0m in 1.26s]
[0m10:08:55.290806 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.stg_produto_fabricado
[0m10:08:55.291800 [debug] [Thread-2  ]: Began running node model.shibaribrasil.dm_produto
[0m10:08:55.291800 [info ] [Thread-2  ]: 14 of 26 START sql table model dbt_dw_dw.dm_produto ............................ [RUN]
[0m10:08:55.293894 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_produto_fabricado, now model.shibaribrasil.dm_produto)
[0m10:08:55.294898 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.dm_produto
[0m10:08:55.301004 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.dm_produto"
[0m10:08:55.303047 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (compile): 10:08:55.294898 => 10:08:55.302048
[0m10:08:55.304095 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.dm_produto
[0m10:08:55.318992 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:08:55.625930 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:07515e9e-147b-475c-93d8-f75333955ed7&page=queryresults
[0m10:08:55.962444 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.dm_produto"
[0m10:08:55.964439 [debug] [Thread-2  ]: On model.shibaribrasil.dm_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.dm_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto`as a
)

-- cte para tratamentos gerais nos campos de tipo de produto e tipo de estoque
, cte_tratamentos as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto_completo
          ,case 
            when ds_formato = 'S' and cd_produto_bling_pai is null then 'SIMPLES'
            when ds_formato = 'V' and cd_produto_bling_pai is null then 'PAI'
            when cd_produto_bling_pai is not null then 'FILHO'
            else 'SIMPLES'                                   end ds_tipo_produto
          ,cd_produto_bling_pai
          ,case when ds_formato = 'E' then true else false   end fg_produto_composicao
          ,if(ds_tipo_estoque = 'V' or ds_formato = 'E', 'VIRTUAL', 'FISICO') as ds_tipo_estoque
          ,qt_estoque_minimo
          ,qt_estoque_atual
          ,vl_custo_compra
          ,vl_custo_total
          ,vl_preco_venda
          ,if(ds_situacao = 'A', 'ATIVO', 'INATIVO')      as ds_situacao
          ,dm_altura
          ,dm_largura
          ,dm_profundidade
          ,dm_peso_bruto
          ,dm_peso_liquido
          ,cd_categoria
          ,ds_descricao_produto
          ,dt_ultima_ingestao
      from cte_produto
)

--normalizando os produtos pai com o mesmo tipo de estoque dos filhos
, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,coalesce(b.fg_produto_composicao, a.fg_produto_composicao) fg_produto_composicao
          ,coalesce(b.ds_tipo_estoque, a.ds_tipo_estoque) ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_tratamentos  as a
 left join cte_tratamentos  as b
        on a.cd_produto_bling = b.cd_produto_bling_pai
)

--pego o nome do produto pai pra criar uma coluna de nome de produto simples, sem as variaÃ§Ãµes
, cte_nome_simples_base as (
   select distinct
           a.cd_produto_bling_pai
          ,b.nm_produto_completo as nm_produto
      from cte_base  as a
 left join cte_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling
     where a.cd_produto_bling_pai is not null
)

--join pra trazer o nome do produto simplificado
, cte_nome_simples as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,coalesce(b.nm_produto, a.nm_produto_completo) as nm_produto
          ,a.nm_produto_completo
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_base                as a
 left join cte_nome_simples_base   as b
        on a.cd_produto_bling_pai = b.cd_produto_bling_pai
)

--retiro o nome do produto pra deixar so a variaÃ§Ã£o e criar uma coluna com esse dado
, cte_base_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,coalesce(nullif(trim(replace(a.nm_produto_completo, a.nm_produto, '')), ''), 'Sem Variacao') ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.cd_categoria
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_nome_simples   as a
)

select *
    from cte_base_final
  order by nm_produto_completo
    );
  
[0m10:08:56.051910 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.stg_tempo (execute): 10:08:54.891151 => 10:08:56.050910
[0m10:08:56.053913 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB95686760>]}
[0m10:08:56.054912 [info ] [Thread-1  ]: 13 of 26 OK created sql view model dbt_dw_stg.stg_tempo ........................ [[32mCREATE VIEW (0 processed)[0m in 1.17s]
[0m10:08:56.056922 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.stg_tempo
[0m10:08:56.569333 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:0724579a-134c-48ac-ab0f-445c07763149&page=queryresults
[0m10:08:58.802543 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.dm_produto (execute): 10:08:55.304095 => 10:08:58.802543
[0m10:08:58.803539 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB95673A00>]}
[0m10:08:58.803539 [info ] [Thread-2  ]: 14 of 26 OK created sql table model dbt_dw_dw.dm_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.4 MiB processed)[0m in 3.51s]
[0m10:08:58.804450 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.dm_produto
[0m10:08:58.805624 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_produto
[0m10:08:58.805624 [info ] [Thread-1  ]: 15 of 26 START sql table model dbt_dw_az.tb_produto ............................ [RUN]
[0m10:08:58.806631 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.stg_tempo, now model.shibaribrasil.tb_produto)
[0m10:08:58.806631 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_produto
[0m10:08:58.809689 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto"
[0m10:08:58.810644 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (compile): 10:08:58.806631 => 10:08:58.810644
[0m10:08:58.810644 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_produto
[0m10:08:58.815695 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:08:59.481552 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto"
[0m10:08:59.482543 [debug] [Thread-1  ]: On model.shibaribrasil.tb_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select *
     from `igneous-sandbox-381622`.`dbt_dw_dw`.`dm_produto`
)

, cte_categoria as (
   select cd_categoria
         ,nm_categoria
         ,cd_categoria_pai
         ,ds_tipo_categoria
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_categoria_produto`
)

-- join com a dimensao de categoria de produto
, cte_tratamentos as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.nm_categoria                           as ds_subcategoria
          ,coalesce(c.nm_categoria, b.nm_categoria) as ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,a.dt_ultima_ingestao
      from cte_produto   as a
 left join cte_categoria    as b
        on a.cd_categoria = b.cd_categoria
 left join cte_categoria    as c
        on b.cd_categoria_pai = c.cd_categoria     
)

, cte_campos_customizados as (
    select cd_produto_bling
          ,cd_produto
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,vl_alteracao_preco
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_campo_customizado_produto`
)

, cte_imagem_produto as (
    select cd_produto_bling
          ,cd_produto
          ,lk_imagem_produto
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_imagem_produto`
     where seq_imagem = 1
)

, cte_joins as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,b.vl_alteracao_preco as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
          ,a.ds_descricao_produto
          ,c.lk_imagem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from cte_tratamentos            as a
 left join cte_campos_customizados    as b
        on a.cd_produto_bling = b.cd_produto_bling 
 left join cte_imagem_produto         as c
        on a.cd_produto_bling = c.cd_produto_bling      
)

  select *
    from cte_joins
order by nm_produto_completo
    );
  
[0m10:09:00.188159 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bf23ede4-a2b8-4724-b6a5-210705db30f3&page=queryresults
[0m10:09:02.398318 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_produto (execute): 10:08:58.811654 => 10:09:02.398318
[0m10:09:02.399277 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB95647AC0>]}
[0m10:09:02.400334 [info ] [Thread-1  ]: 15 of 26 OK created sql table model dbt_dw_az.tb_produto ....................... [[32mCREATE TABLE (353.0 rows, 1.9 MiB processed)[0m in 3.59s]
[0m10:09:02.402326 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_produto
[0m10:09:02.403326 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_composicao_produto
[0m10:09:02.405338 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_compra
[0m10:09:02.404327 [info ] [Thread-2  ]: 16 of 26 START sql table model dbt_dw_az.tb_composicao_produto ................. [RUN]
[0m10:09:02.408331 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.dm_produto, now model.shibaribrasil.tb_composicao_produto)
[0m10:09:02.409338 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_composicao_produto
[0m10:09:02.414970 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_composicao_produto"
[0m10:09:02.406328 [info ] [Thread-1  ]: 17 of 26 START sql table model dbt_dw_az.tb_compra ............................. [RUN]
[0m10:09:02.417919 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto, now model.shibaribrasil.tb_compra)
[0m10:09:02.417919 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_compra
[0m10:09:02.425974 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_compra"
[0m10:09:02.427971 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (compile): 10:09:02.409338 => 10:09:02.427971
[0m10:09:02.428952 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_composicao_produto
[0m10:09:02.433975 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:09:02.461914 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (compile): 10:09:02.418960 => 10:09:02.461914
[0m10:09:02.462923 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_compra
[0m10:09:02.463969 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:09:03.018638 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_composicao_produto"
[0m10:09:03.021652 [debug] [Thread-2  ]: On model.shibaribrasil.tb_composicao_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_composicao_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_situacao
          ,a.dm_altura
          ,a.dm_largura
          ,a.dm_profundidade
          ,a.dm_peso_bruto
          ,a.dm_peso_liquido
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_produto_composicao as (
    select *
      from cte_produto
     where fg_produto_composicao is true
)

, cte_item_composicao_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_produto_bling_componente
         ,a.qt_componente
    from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_composicao_produto` as a   
)

, cte_item_composicao as (
    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,b.cd_produto_bling_componente
          ,c.cd_produto as cd_produto_componente
          ,c.cd_codigo_barras as cd_codigo_barras_componente
          ,c.nm_produto as nm_produto_componente
          ,c.nm_produto_completo as nm_produto_completo_componente
          ,c.ds_variacao as ds_variacao_componente
          ,b.qt_componente
      from cte_produto_composicao   as a
 left join cte_item_composicao_base as b
        on a.cd_produto_bling = b.cd_produto_bling
 left join cte_produto              as c
        on b.cd_produto_bling_componente = c.cd_produto_bling
)

select *
    from cte_item_composicao
  order by nm_produto_completo
    );
  
[0m10:09:03.075142 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_compra"
[0m10:09:03.076177 [debug] [Thread-1  ]: On model.shibaribrasil.tb_compra: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_compra"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
  select cd_codigo_interno
        ,cd_compra
        ,dt_compra
        ,dt_prevista_compra
        ,cd_fornecedor
        ,vl_total_item
        ,vl_total_compra
        ,ds_status_compra
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_compra`
    where ds_status_compra not in ('CANCELADO')
)

, cte_item_compra as (
   select cd_codigo_interno
         ,cd_compra
         ,dt_compra
         ,cd_categoria_financeira
         ,ds_observacoes
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,ds_unidade
         ,qt_item
         ,vl_item
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_compra`
)

, cte_compra_base as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_compra
         ,a.dt_compra
         ,a.dt_prevista_compra
         ,a.cd_fornecedor
         ,a.ds_status_compra
         ,b.cd_categoria_financeira
         ,b.ds_observacoes
         ,b.cd_produto_bling
         ,b.ds_unidade
         ,b.qt_item
         ,b.vl_item
         ,b.qt_item * b.vl_item as vl_total_item
         ,a.vl_total_compra
     from cte_compra        as a
left join cte_item_compra   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_base as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,b.cd_produto
          ,b.cd_codigo_barras
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,b.ds_tipo_produto
          ,b.ds_subcategoria
          ,b.ds_categoria
          ,b.ds_classificacao_produto
          ,b.ds_origem_produto
          ,b.fg_produto_composicao
     from cte_compra_base        as a
left join cte_produto            as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_validacao_link as (
  select *
        ,regexp_contains(ds_observacoes, r'\b\d{3,}\s*:\s*https?://') as is_padrao_valido
    from cte_compra_base
)

, cte_link_produto_base as (
  select cd_codigo_interno
        ,split(item, ': ') as partes
    from cte_validacao_link,
  unnest(
        case 
          when is_padrao_valido then split(ds_observacoes, ',') 
          else array<string>[null] 
          end
  ) as item
)

, cte_link_produto as (
    select distinct 
           cd_codigo_interno
          ,replace(trim(partes[offset(0)]), '.', '') as cd_produto
          ,trim(partes[offset(1)])                   as lk_produto_compra
      from cte_link_produto_base
)

, cte_base_link as (
    select a.cd_codigo_interno
          ,a.cd_compra
          ,a.dt_compra
          ,a.dt_prevista_compra
          ,a.cd_fornecedor
          ,a.ds_status_compra
          ,a.cd_categoria_financeira
          ,a.ds_observacoes
          ,a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_unidade
          ,a.qt_item
          ,a.vl_item
          ,a.vl_total_item
          ,a.ds_tipo_produto
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_composicao
          ,b.lk_produto_compra
     from cte_base         as a
left join cte_link_produto as b
       on a.cd_codigo_interno = b.cd_codigo_interno
      and a.cd_produto = b.cd_produto
)

  select *
    from cte_base_link
    );
  
[0m10:09:03.659318 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:34106f4a-babc-46e4-9874-b362da16eba8&page=queryresults
[0m10:09:03.664318 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:1f84e01f-a495-4bf5-8682-bf29036eb61b&page=queryresults
[0m10:09:05.583495 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_composicao_produto (execute): 10:09:02.429961 => 10:09:05.582489
[0m10:09:05.584494 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB95695760>]}
[0m10:09:05.585492 [info ] [Thread-2  ]: 16 of 26 OK created sql table model dbt_dw_az.tb_composicao_produto ............ [[32mCREATE TABLE (244.0 rows, 106.8 KiB processed)[0m in 3.18s]
[0m10:09:05.587491 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_composicao_produto
[0m10:09:05.588403 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_geral
[0m10:09:05.588403 [info ] [Thread-2  ]: 18 of 26 START sql table model dbt_dw_az.tb_estoque_geral ...................... [RUN]
[0m10:09:05.590460 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_composicao_produto, now model.shibaribrasil.tb_estoque_geral)
[0m10:09:05.591464 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_geral
[0m10:09:05.597502 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_geral"
[0m10:09:05.599491 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (compile): 10:09:05.591464 => 10:09:05.598490
[0m10:09:05.600450 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_geral
[0m10:09:05.607605 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:09:05.951402 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_compra (execute): 10:09:02.462923 => 10:09:05.950402
[0m10:09:05.954396 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB95526C10>]}
[0m10:09:05.956400 [info ] [Thread-1  ]: 17 of 26 OK created sql table model dbt_dw_az.tb_compra ........................ [[32mCREATE TABLE (152.0 rows, 108.5 KiB processed)[0m in 3.54s]
[0m10:09:05.958412 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_compra
[0m10:09:05.959403 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_pedido
[0m10:09:05.960404 [info ] [Thread-1  ]: 19 of 26 START sql table model dbt_dw_az.tb_pedido ............................. [RUN]
[0m10:09:05.963405 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_compra, now model.shibaribrasil.tb_pedido)
[0m10:09:05.963405 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_pedido
[0m10:09:05.969398 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_pedido"
[0m10:09:05.971402 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (compile): 10:09:05.964403 => 10:09:05.970398
[0m10:09:05.971402 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_pedido
[0m10:09:05.973398 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:09:06.212163 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_geral"
[0m10:09:06.214129 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_geral: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_geral"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_geral`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

  select *
    from cte_produto
order by nm_produto
        ,ds_variacao
    );
  
[0m10:09:06.574672 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:537ead26-937c-4c2d-a583-9e0bf8455d93&page=queryresults
[0m10:09:06.590789 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_pedido"
[0m10:09:06.592791 [debug] [Thread-1  ]: On model.shibaribrasil.tb_pedido: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_pedido"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_pedido as (
   select cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,cd_status_pedido
         ,ds_status_pedido
         ,vl_total_pedido
         ,vl_total_item
         ,cd_contato
         ,nm_contato
         ,nr_doc_contato
         ,cd_loja
         ,ds_loja
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_pedido`
)

, cte_item_pedido as (
   select cd_codigo_interno
         ,dt_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,ds_tipo_desconto
         ,vl_desconto
         ,ds_forma_pagamento
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_item_pedido`
)

, cte_pedido_base as (
   select distinct
          a.cd_codigo_interno                                                        as cd_codigo_interno
         ,a.cd_pedido                                                                as cd_pedido
         ,a.dt_pedido                                                                as dt_pedido
         ,a.cd_status_pedido                                                         as cd_status_pedido
         ,a.ds_status_pedido                                                         as ds_status_pedido
         ,b.cd_produto_bling                                                         as cd_produto_bling
         ,b.cd_produto                                                               as cd_produto
         ,b.nm_produto_completo                                                      as nm_produto_completo
         ,b.qt_item                                                                  as qt_item
         ,b.vl_item                                                                  as vl_item
         ,round((b.qt_item * b.vl_item), 2)                                          as vl_total_item
         ,b.ds_tipo_desconto                                                         as ds_tipo_desconto
         ,b.vl_desconto                                                              as vl_desconto
         ,a.vl_total_pedido                                                          as vl_total_pedido
         ,a.vl_total_item                                                            as vl_total_item_pedido
         ,b.ds_forma_pagamento                                                       as ds_forma_pagamento
         ,a.cd_contato                                                               as cd_contato
         ,a.nm_contato                                                               as nm_contato
         ,a.nr_doc_contato                                                           as nr_doc_contato
         ,a.ds_loja                                                                  as ds_loja
         ,count(distinct b.cd_produto_bling) over (partition by a.cd_codigo_interno) as qt_linhas_pedido
     from cte_pedido        as a
left join cte_item_pedido   as b
       on a.cd_codigo_interno = b.cd_codigo_interno
)

, cte_rateio_frete as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,round((a.vl_desconto / a.qt_linhas_pedido), 2)                                                as vl_desconto
         ,round(((a.vl_total_pedido + a.vl_desconto) - a.vl_total_item_pedido) / a.qt_linhas_pedido, 2) as vl_frete_rateio
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_base as a
)

, cte_pedido_total as (
   select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto as vl_desconto_rateio
         ,a.vl_frete_rateio
         ,round((a.vl_total_item + a.vl_frete_rateio) - a.vl_desconto, 2) as vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_rateio_frete as a
)

, cte_categoria_produto as (
    select cd_produto_bling
          ,cd_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
)

, cte_final as (
    select distinct
          a.cd_codigo_interno
         ,a.cd_pedido
         ,a.dt_pedido
         ,a.cd_status_pedido
         ,a.ds_status_pedido
         ,a.cd_produto_bling
         ,a.cd_produto
         ,a.nm_produto_completo
         ,b.ds_subcategoria
         ,b.ds_categoria
         ,b.ds_classificacao_produto
         ,b.ds_origem_produto
         ,a.qt_item
         ,a.vl_item
         ,a.vl_total_item
         ,a.vl_desconto_rateio
         ,a.vl_frete_rateio
         ,a.vl_total_pedido
         ,a.ds_forma_pagamento
         ,a.cd_contato
         ,a.nm_contato
         ,a.nr_doc_contato
         ,a.ds_loja
         ,a.qt_linhas_pedido
     from cte_pedido_total      as a
left join cte_categoria_produto as b
       on a.cd_produto_bling = b.cd_produto_bling
)
select *
    from cte_final
    );
  
[0m10:09:07.160591 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:d27883ef-941b-40fa-be43-afec9087483b&page=queryresults
[0m10:09:08.478964 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_geral (execute): 10:09:05.600450 => 10:09:08.477965
[0m10:09:08.478964 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB9671C3D0>]}
[0m10:09:08.479968 [info ] [Thread-2  ]: 18 of 26 OK created sql table model dbt_dw_az.tb_estoque_geral ................. [[32mCREATE TABLE (353.0 rows, 86.5 KiB processed)[0m in 2.89s]
[0m10:09:08.480974 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_geral
[0m10:09:08.480974 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_agg_compra_produto
[0m10:09:08.480974 [info ] [Thread-2  ]: 20 of 26 START sql table model dbt_dw_az.tb_agg_compra_produto ................. [RUN]
[0m10:09:08.481980 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_estoque_geral, now model.shibaribrasil.tb_agg_compra_produto)
[0m10:09:08.481980 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_agg_compra_produto
[0m10:09:08.484982 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_compra_produto"
[0m10:09:08.485974 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (compile): 10:09:08.482984 => 10:09:08.485974
[0m10:09:08.485974 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_agg_compra_produto
[0m10:09:08.487973 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:09:09.047477 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_compra_produto"
[0m10:09:09.050551 [debug] [Thread-2  ]: On model.shibaribrasil.tb_agg_compra_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_compra_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_compra as (
    select cd_codigo_interno
          ,cd_compra
          ,dt_compra
          ,dt_prevista_compra
          ,cd_fornecedor
          ,ds_status_compra
          ,cd_categoria_financeira
          ,ds_observacoes
          ,cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_unidade
          ,qt_item
          ,vl_item
          ,vl_total_item
          ,ds_tipo_produto
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_composicao
          ,lk_produto_compra
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_compra`
)

, cte_compra_produto as (
    select distinct 
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,qt_item
          ,vl_item
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,cd_compra
          ,dt_compra
          ,ds_status_compra
          ,fg_produto_composicao
          ,lk_produto_compra
          ,row_number() over (partition by cd_produto_bling order by dt_compra desc) as nr_seq
      from cte_compra
)

  select *
    from cte_compra_produto
    );
  
[0m10:09:09.461925 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c416c579-443d-4044-837f-6c9d76c0f599&page=queryresults
[0m10:09:09.664613 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_pedido (execute): 10:09:05.971402 => 10:09:09.664613
[0m10:09:09.665613 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB955C8370>]}
[0m10:09:09.666611 [info ] [Thread-1  ]: 19 of 26 OK created sql table model dbt_dw_az.tb_pedido ........................ [[32mCREATE TABLE (2.7k rows, 1.1 MiB processed)[0m in 3.70s]
[0m10:09:09.668613 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_pedido
[0m10:09:09.669611 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_final
[0m10:09:09.670612 [info ] [Thread-1  ]: 21 of 26 START sql table model dbt_dw_az.tb_venda_produto_final ................ [RUN]
[0m10:09:09.671611 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_pedido, now model.shibaribrasil.tb_venda_produto_final)
[0m10:09:09.671611 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_final
[0m10:09:09.675611 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_final"
[0m10:09:09.676612 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (compile): 10:09:09.672610 => 10:09:09.676612
[0m10:09:09.677610 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_final
[0m10:09:09.687611 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:09:10.383209 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_final"
[0m10:09:10.384252 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos')
)

, cte_pedido as (
    select distinct
          cd_codigo_interno
         ,cd_pedido
         ,dt_pedido
         ,date_trunc(cast(dt_pedido as date), month) as dt_prim_dia_mes
         ,cd_status_pedido
         ,ds_status_pedido
         ,cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,qt_item
         ,vl_item
         ,vl_total_item
    from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_pedido`
   where ds_status_pedido <> 'CANCELADO'
)

, cte_produto_pedido_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
         ,count(distinct b.cd_codigo_interno) as qt_pedidos
         ,sum(b.qt_item)                      as qt_item
         ,sum(b.vl_total_item)                as vl_total_item
     from cte_produto as a
left join cte_pedido  as b 
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,b.dt_pedido
         ,b.dt_prim_dia_mes
)

select *
  from cte_produto_pedido_base
    );
  
[0m10:09:10.811711 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:c48158f2-0b72-401e-b9de-5e69e8f90557&page=queryresults
[0m10:09:11.365750 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_agg_compra_produto (execute): 10:09:08.486968 => 10:09:11.365750
[0m10:09:11.365750 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB9669C490>]}
[0m10:09:11.367279 [info ] [Thread-2  ]: 20 of 26 OK created sql table model dbt_dw_az.tb_agg_compra_produto ............ [[32mCREATE TABLE (152.0 rows, 32.6 KiB processed)[0m in 2.88s]
[0m10:09:11.367279 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_agg_compra_produto
[0m10:09:11.368286 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_produto_fabricado
[0m10:09:11.368286 [info ] [Thread-2  ]: 22 of 26 START sql table model dbt_dw_az.tb_produto_fabricado .................. [RUN]
[0m10:09:11.369288 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_compra_produto, now model.shibaribrasil.tb_produto_fabricado)
[0m10:09:11.369800 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_produto_fabricado
[0m10:09:11.446201 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_produto_fabricado"
[0m10:09:11.446201 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (compile): 10:09:11.369800 => 10:09:11.446201
[0m10:09:11.447715 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_produto_fabricado
[0m10:09:11.449226 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:09:12.051080 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_produto_fabricado"
[0m10:09:12.054091 [debug] [Thread-2  ]: On model.shibaribrasil.tb_produto_fabricado: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_produto_fabricado"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto` as a
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
)

, cte_produto_fabricado as (
    select cd_produto
          ,nm_produto_completo
          ,cd_produto_composicao 
          ,nm_produto_completo_composicao 
          ,qt_produto_composicao 
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_produto_fabricado`
)

, cte_base as (
    select distinct 
           b.cd_produto_bling
          ,a.cd_produto
          ,b.nm_produto
          ,b.nm_produto_completo
          ,b.ds_variacao
          ,c.cd_produto_bling                          as cd_produto_bling_composicao
          ,a.cd_produto_composicao                     as cd_produto_composicao
          ,c.nm_produto                                as nm_produto_composicao
          ,c.nm_produto_completo                       as nm_produto_completo_composicao
          ,c.ds_variacao                               as ds_variacao_composicao
          ,a.qt_produto_composicao                     as qt_produto_composicao
          ,d.vl_item                                   as vl_custo_compra
          ,a.qt_produto_composicao * d.vl_item         as vl_custo_compra_total
      from cte_produto_fabricado as a 
 left join cte_produto           as b 
        on a.cd_produto = b.cd_produto
 left join cte_produto           as c 
        on a.cd_produto_composicao = c.cd_produto
 left join cte_compra_produto    as d 
        on c.cd_produto_bling = d.cd_produto_bling
)

select *
    from cte_base
  order by nm_produto_completo
    );
  
[0m10:09:12.614812 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:2eb4a137-e92c-42d2-987d-99f869e09f7c&page=queryresults
[0m10:09:13.076072 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_final (execute): 10:09:09.677610 => 10:09:13.073073
[0m10:09:13.086324 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB966D2040>]}
[0m10:09:13.089854 [info ] [Thread-1  ]: 21 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_final ........... [[32mCREATE TABLE (1.2k rows, 418.5 KiB processed)[0m in 3.41s]
[0m10:09:13.093888 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_final
[0m10:09:13.095881 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:09:13.097403 [info ] [Thread-1  ]: 23 of 26 START sql table model dbt_dw_az.tb_agg_venda_produto_final ............ [RUN]
[0m10:09:13.100134 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_venda_produto_final, now model.shibaribrasil.tb_agg_venda_produto_final)
[0m10:09:13.101148 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:09:13.107644 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m10:09:13.109151 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (compile): 10:09:13.101148 => 10:09:13.109151
[0m10:09:13.109684 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:09:13.112700 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:09:13.765267 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_agg_venda_produto_final"
[0m10:09:13.767793 [debug] [Thread-1  ]: On model.shibaribrasil.tb_agg_venda_produto_final: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_agg_venda_produto_final"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_venda_produto as (
   select cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
         ,dt_pedido
         ,dt_prim_dia_mes
         ,qt_pedidos
         ,qt_item
         ,vl_total_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_final`
)

, cte_pedido_mes_atual as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(cast(current_date as date), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_mes_anterior as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes = date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_tres_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 3 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_seis_meses as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where dt_prim_dia_mes >= date_trunc(date_sub(current_date(), interval 6 month), month)
     and dt_prim_dia_mes <= date_trunc(date_sub(current_date(), interval 1 month), month)
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_pedido_60_dias as (
   select cd_produto_bling
         ,cd_produto
         ,nm_produto_completo
         ,sum(qt_pedidos)     as qt_pedidos
         ,sum(qt_item)        as qt_item
         ,sum(vl_total_item)  as vl_total_item
    from cte_venda_produto
   where cast(dt_pedido as date) >= date_trunc(date_sub(current_date(), interval 59 day), day)
     and cast(dt_pedido as date) <= current_date
group by cd_produto_bling
        ,cd_produto
        ,nm_produto_completo
)

, cte_final as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,coalesce(b.qt_pedidos,0)    as qt_pedidos_mes_atual
          ,coalesce(b.qt_item,0)       as qt_pecas_mes_atual
          ,coalesce(b.vl_total_item,0) as vl_total_mes_atual
          ,coalesce(c.qt_pedidos,0)    as qt_pedidos_mes_anterior
          ,coalesce(c.qt_item,0)       as qt_pecas_mes_anterior
          ,coalesce(c.vl_total_item,0) as vl_total_mes_anterior
          ,coalesce(d.qt_pedidos,0)    as qt_pedidos_tres_meses
          ,coalesce(d.qt_item,0)       as qt_pecas_tres_meses
          ,coalesce(d.vl_total_item,0) as vl_total_tres_meses
          ,coalesce(e.qt_pedidos,0)    as qt_pedidos_seis_meses
          ,coalesce(e.qt_item,0)       as qt_pecas_seis_meses
          ,coalesce(e.vl_total_item,0) as vl_total_seis_meses
          ,coalesce(f.qt_pedidos,0)    as qt_pedidos_sessenta_dias
          ,coalesce(f.qt_item,0)       as qt_pecas_sessenta_dias
          ,coalesce(f.vl_total_item,0) as vl_total_sessenta_dias
     from cte_venda_produto               as a
left join cte_pedido_mes_atual            as b
       on a.cd_produto_bling = b.cd_produto_bling
left join cte_pedido_mes_anterior         as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_pedido_tres_meses           as d
       on a.cd_produto_bling = d.cd_produto_bling
left join cte_pedido_seis_meses           as e
       on a.cd_produto_bling = e.cd_produto_bling
left join cte_pedido_60_dias              as f
       on a.cd_produto_bling = f.cd_produto_bling
)

   select *
     from cte_final
 order by nm_produto_completo
    );
  
[0m10:09:14.130902 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:67b87ea2-eaf1-4456-bd9c-8857b502334b&page=queryresults
[0m10:09:15.404045 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_produto_fabricado (execute): 10:09:11.447715 => 10:09:15.404045
[0m10:09:15.405044 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB9556A520>]}
[0m10:09:15.406044 [info ] [Thread-2  ]: 22 of 26 OK created sql table model dbt_dw_az.tb_produto_fabricado ............. [[32mCREATE TABLE (10.0 rows, 101.0 KiB processed)[0m in 4.04s]
[0m10:09:15.406044 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_produto_fabricado
[0m10:09:15.407578 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto_base
[0m10:09:15.407578 [info ] [Thread-2  ]: 24 of 26 START sql table model dbt_dw_az.tb_preco_produto_base ................. [RUN]
[0m10:09:15.408610 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_produto_fabricado, now model.shibaribrasil.tb_preco_produto_base)
[0m10:09:15.409597 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto_base
[0m10:09:15.415237 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto_base"
[0m10:09:15.419775 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (compile): 10:09:15.409597 => 10:09:15.418267
[0m10:09:15.419775 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto_base
[0m10:09:15.423788 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:09:16.192533 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto_base"
[0m10:09:16.193534 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

--visÃ£o atual dos produtos, nÃ£o trabalho aqui com histÃ³rico do preÃ§o
with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_compra
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
    --  where a.ds_categoria not in ('Suprimentos', 'Inativos')
)

, cte_meta_margem as (
    select ds_classificacao_produto
          ,ds_origem_produto
          ,pr_desconto_padrao 
          ,pr_meta_margem 
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_meta_margem_preco`
)

, cte_forma_pagamento as (
   select cd_forma_pagamento
         ,nm_forma_pagamento
         ,ds_condicao_pagamento
         ,qt_dias_pagamento
         ,vl_taxa_aliquota
         ,vl_taxa_fixa
     from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_forma_pagamento`
    where nm_forma_pagamento in ('[Nuvem] CartÃ£o de CrÃ©dito', '[Nuvem] PIX')
)

, cte_compra_produto as (
    select cd_produto_bling
          ,cd_produto
          ,vl_item
          ,dt_compra
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
     where nr_seq = 1
       and ds_status_compra = 'ATENDIDO'
       and dt_compra >= '2025-07-01'
)

, cte_produto_base_kit as (
    select distinct cd_produto_bling_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_fabricado as (
    select cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,sum(vl_custo_compra_total) vl_custo_compra_total
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto_fabricado`
  group by cd_produto_bling
          ,cd_produto
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
)

, cte_joins as (
    select distinct
           a.cd_produto_bling                                                                                                as cd_produto_bling
          ,a.cd_produto                                                                                                      as cd_produto
          ,a.cd_codigo_barras                                                                                                as cd_codigo_barras
          ,a.nm_produto                                                                                                      as nm_produto
          ,a.ds_variacao                                                                                                     as ds_variacao
          ,a.qt_estoque_atual                                                                                                as qt_estoque_atual
          ,coalesce(a.vl_custo_total, 0)                                                                                     as vl_custo_cadastro
          ,coalesce(e.vl_custo_compra_total, c.vl_item, 0)                                                                   as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)                                                                                     as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)                                                                                 as vl_preco_venda_por
          ,a.ds_subcategoria                                                                                                 as ds_subcategoria
          ,a.ds_categoria                                                                                                    as ds_categoria
          ,a.ds_classificacao_produto                                                                                        as ds_classificacao_produto
          ,a.ds_origem_produto                                                                                               as ds_origem_produto
          ,a.ds_tipo_produto                                                                                                 as ds_tipo_produto
          ,a.fg_produto_composicao                                                                                           as fg_produto_composicao
          ,if(d.cd_produto_bling_componente is null, false, true)                                                            as fg_produto_base_composicao
          ,if(e.cd_produto_bling            is null, false, true)                                                            as fg_produto_fabricado
          ,coalesce(b.pr_desconto_padrao, 0)                                                                                 as pr_desconto_padrao 
          ,coalesce(b.pr_meta_margem, 0)                                                                                     as pr_meta_margem 
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito') as tx_aliquota_cartao
          ,(select vl_taxa_fixa     from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] CartÃ£o de CrÃ©dito')         as tx_fixa_cartao
          ,(select (vl_taxa_aliquota / 100) from cte_forma_pagamento where nm_forma_pagamento = '[Nuvem] PIX')               as tx_aliquota_pix
          --regra manual de desconto do pix
          ,0.03                                                                                                              as vl_desconto_fixo_pix
          --valor aproximado de materiais de envio por pedido
          ,2.50                                                                                                              as vl_materiais_envio
          ,c.dt_compra                                                                                                       as dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,datetime(current_timestamp(), "America/Sao_Paulo") as dt_ultima_atualizacao
     from cte_produto           as a
left join cte_meta_margem       as b
       on a.ds_classificacao_produto = b.ds_classificacao_produto
      and a.ds_origem_produto = b.ds_origem_produto
left join cte_compra_produto    as c
       on a.cd_produto_bling = c.cd_produto_bling
left join cte_produto_base_kit  as d
       on a.cd_produto_bling = d.cd_produto_bling_componente
left join cte_produto_fabricado as e
       on a.cd_produto_bling = e.cd_produto_bling
)

  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m10:09:16.395924 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_agg_venda_produto_final (execute): 10:09:13.110693 => 10:09:16.395924
[0m10:09:16.398457 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB955E96A0>]}
[0m10:09:16.856638 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:3893ba08-1dde-4b01-8d62-5ab6a1e15d3d&page=queryresults
[0m10:09:17.137596 [info ] [Thread-1  ]: 23 of 26 OK created sql table model dbt_dw_az.tb_agg_venda_produto_final ....... [[32mCREATE TABLE (312.0 rows, 295.6 KiB processed)[0m in 3.30s]
[0m10:09:17.139668 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_agg_venda_produto_final
[0m10:09:17.141350 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_venda_produto_base
[0m10:09:17.141350 [info ] [Thread-1  ]: 25 of 26 START sql table model dbt_dw_az.tb_venda_produto_base ................. [RUN]
[0m10:09:17.142719 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_agg_venda_produto_final, now model.shibaribrasil.tb_venda_produto_base)
[0m10:09:17.143751 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_venda_produto_base
[0m10:09:17.148395 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_venda_produto_base"
[0m10:09:17.149458 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (compile): 10:09:17.143751 => 10:09:17.149458
[0m10:09:17.150079 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_venda_produto_base
[0m10:09:17.152166 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m10:09:17.717377 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_venda_produto_base"
[0m10:09:17.721442 [debug] [Thread-1  ]: On model.shibaribrasil.tb_venda_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_venda_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
   select distinct
          cd_produto_bling
         ,cd_produto
         ,cd_codigo_barras
         ,nm_produto
         ,nm_produto_completo
         ,ds_variacao
         ,ds_tipo_produto
         ,cd_produto_bling_pai
         ,fg_produto_composicao
         ,ds_tipo_estoque
         ,vl_custo_total
         ,vl_preco_venda
         ,ds_subcategoria
         ,ds_categoria
         ,ds_classificacao_produto
         ,ds_origem_produto
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`
    where ds_categoria not in ('Suprimentos', 'Produtos Digitais', 'Inativos')
)

, cte_composicao as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,nm_produto_completo
          ,ds_variacao
          ,ds_tipo_produto
          ,cd_produto_bling_pai
          ,cd_produto_bling_componente
          ,cd_produto_componente
          ,cd_codigo_barras_componente
          ,nm_produto_componente
          ,nm_produto_completo_componente
          ,ds_variacao_componente
          ,qt_componente
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_composicao_produto`
)

, cte_produto_composicao as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,b.cd_produto_bling_componente
         ,b.cd_produto_componente
         ,b.cd_codigo_barras_componente
         ,b.nm_produto_componente
         ,b.nm_produto_completo_componente
         ,b.ds_variacao_componente
         ,b.qt_componente
         ,a.ds_tipo_estoque
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
     from cte_produto    as a 
left join cte_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_venda_produto as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,coalesce(qt_pedidos_mes_atual, 0)     as qt_pedidos_mes_atual
          ,coalesce(qt_pecas_mes_atual, 0)       as qt_pecas_mes_atual
          ,coalesce(vl_total_mes_atual, 0)       as vl_total_mes_atual
          ,coalesce(qt_pedidos_mes_anterior, 0)  as qt_pedidos_mes_anterior
          ,coalesce(qt_pecas_mes_anterior, 0)    as qt_pecas_mes_anterior
          ,coalesce(vl_total_mes_anterior, 0)    as vl_total_mes_anterior
          ,coalesce(qt_pedidos_tres_meses, 0)    as qt_pedidos_tres_meses
          ,coalesce(qt_pecas_tres_meses, 0)      as qt_pecas_tres_meses
          ,coalesce(vl_total_tres_meses, 0)      as vl_total_tres_meses
          ,coalesce(qt_pedidos_seis_meses, 0)    as qt_pedidos_seis_meses
          ,coalesce(qt_pecas_seis_meses, 0)      as qt_pecas_seis_meses
          ,coalesce(vl_total_seis_meses, 0)      as vl_total_seis_meses
          ,coalesce(qt_pedidos_sessenta_dias, 0) as qt_pedidos_sessenta_dias
          ,coalesce(qt_pecas_sessenta_dias, 0)   as qt_pecas_sessenta_dias
          ,coalesce(vl_total_sessenta_dias, 0)   as vl_total_sessenta_dias
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_venda_produto_final`
)

, cte_base as (
   select a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_tipo_produto
         ,a.cd_produto_bling_pai
         ,a.fg_produto_composicao
         ,coalesce(a.cd_produto_bling_componente, a.cd_produto_bling)              as cd_produto_bling_componente
         ,coalesce(a.cd_produto_componente, a.cd_produto)                          as cd_produto_componente
         ,coalesce(a.cd_codigo_barras_componente, a.cd_codigo_barras)              as cd_codigo_barras_componente
         ,coalesce(a.nm_produto_componente, a.nm_produto)                          as nm_produto_componente
         ,coalesce(a.nm_produto_completo_componente, a.nm_produto_completo)        as nm_produto_completo_componente
         ,coalesce(a.ds_variacao_componente, a.ds_variacao)                        as ds_variacao_componente
         ,coalesce(a.qt_componente, 1)                                             as qt_componente
         ,coalesce((b.qt_pecas_mes_atual * coalesce(a.qt_componente, 1)), 0)       as qt_pecas_mes_atual 
         ,coalesce((b.qt_pecas_mes_anterior * coalesce(a.qt_componente, 1)), 0)    as qt_pecas_mes_anterior 
         ,coalesce((b.qt_pecas_tres_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_tres_meses 
         ,coalesce((b.qt_pecas_seis_meses * coalesce(a.qt_componente, 1)), 0)      as qt_pecas_seis_meses 
         ,coalesce((b.qt_pecas_sessenta_dias * coalesce(a.qt_componente, 1)), 0)   as qt_pecas_sessenta_dias 
     from cte_produto_composicao    as a 
left join cte_venda_produto         as b
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_produto_base as (
   select cd_produto_bling_componente      as cd_produto_bling
         ,cd_produto_componente            as cd_produto
         ,cd_codigo_barras_componente      as cd_codigo_barras
         ,nm_produto_componente            as nm_produto
         ,nm_produto_completo_componente   as nm_produto_completo
         ,ds_variacao_componente           as ds_variacao
         ,sum(qt_pecas_mes_atual)          as qt_pecas_mes_atual 
         ,sum(qt_pecas_mes_anterior)       as qt_pecas_mes_anterior 
         ,sum(qt_pecas_tres_meses)         as qt_pecas_tres_meses 
         ,sum(qt_pecas_seis_meses)         as qt_pecas_seis_meses 
         ,sum(qt_pecas_sessenta_dias)      as qt_pecas_sessenta_dias 
     from cte_base
 group by cd_produto_bling_componente
         ,cd_produto_componente
         ,cd_codigo_barras_componente
         ,nm_produto_componente
         ,nm_produto_completo_componente
         ,ds_variacao_componente
)

, cte_base_final as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,b.ds_subcategoria                  as ds_subcategoria
         ,b.ds_categoria                     as ds_categoria
         ,b.ds_classificacao_produto         as ds_classificacao_produto
         ,b.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias 
     from cte_produto_base as a
left join cte_produto_composicao as b
       on a.cd_produto_bling = b.cd_produto_bling
    where b.fg_produto_composicao is false 
      and b.ds_tipo_produto not in ('PAI')
)

, cte_ordenada AS (
  select *
         ,sum(qt_pecas_sessenta_dias) over () as qt_total_geral
         ,sum(qt_pecas_sessenta_dias) over (order by qt_pecas_sessenta_dias desc rows between unbounded preceding and current row) as qt_acumulada
    from cte_base_final
)

, cte_classificada AS (
  select *
         ,round(qt_acumulada / qt_total_geral, 4) as vl_percentual_acumulado
         ,round(qt_pecas_sessenta_dias / qt_total_geral, 4) as vl_percentual_participacao
         ,case
           when qt_acumulada / qt_total_geral <= 0.80 then 'A'
           when qt_acumulada / qt_total_geral <= 0.95 then 'B'
           else 'C'
         end as ds_classificacao_abc
    from cte_ordenada
)

  select *
    from cte_classificada
order by nm_produto
    );
  
[0m10:09:18.132513 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:50e51da5-94ec-4797-a9a0-d40f012c2503&page=queryresults
[0m10:09:19.353623 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto_base (execute): 10:09:15.420800 => 10:09:19.353623
[0m10:09:19.354625 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB8FA4F430>]}
[0m10:09:19.355625 [info ] [Thread-2  ]: 24 of 26 OK created sql table model dbt_dw_az.tb_preco_produto_base ............ [[32mCREATE TABLE (353.0 rows, 94.5 KiB processed)[0m in 3.95s]
[0m10:09:19.355625 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto_base
[0m10:09:20.935060 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_venda_produto_base (execute): 10:09:17.151120 => 10:09:20.933543
[0m10:09:20.936086 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB954E4BB0>]}
[0m10:09:20.937616 [info ] [Thread-1  ]: 25 of 26 OK created sql table model dbt_dw_az.tb_venda_produto_base ............ [[32mCREATE TABLE (155.0 rows, 126.0 KiB processed)[0m in 3.79s]
[0m10:09:20.945233 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_venda_produto_base
[0m10:09:20.948336 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_estoque_produto_base
[0m10:09:20.951583 [info ] [Thread-2  ]: 26 of 26 START sql table model dbt_dw_az.tb_estoque_produto_base ............... [RUN]
[0m10:09:20.954636 [debug] [Thread-2  ]: Re-using an available connection from the pool (formerly model.shibaribrasil.tb_preco_produto_base, now model.shibaribrasil.tb_estoque_produto_base)
[0m10:09:20.955726 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_estoque_produto_base
[0m10:09:20.965450 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_estoque_produto_base"
[0m10:09:20.967450 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (compile): 10:09:20.955726 => 10:09:20.966446
[0m10:09:20.967450 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_estoque_produto_base
[0m10:09:20.974498 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
[0m10:09:21.739787 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_estoque_produto_base"
[0m10:09:21.741794 [debug] [Thread-2  ]: On model.shibaribrasil.tb_estoque_produto_base: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_estoque_produto_base"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_estoque_produto_base`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_produto as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.nm_produto_completo
          ,a.ds_variacao
          ,a.ds_tipo_produto
          ,a.cd_produto_bling_pai
          ,a.fg_produto_composicao
          ,a.ds_tipo_estoque
          ,a.qt_estoque_minimo
          ,a.qt_estoque_atual
          ,a.vl_custo_total
          ,a.vl_preco_venda
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.dt_ultima_ingestao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_produto`  as a   
)

, cte_venda_produto as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_seis_meses              as qt_pecas_seis_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_venda_produto_base` as a
)

, cte_tempo as (
    select dt_data
          ,dt_prim_dia_mes
      from `igneous-sandbox-381622`.`dbt_dw_stg`.`stg_tempo`
     where dt_data >= date_trunc(date_sub(current_date(), interval 6 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_atual as (
    select count(distinct dt_data) qt_dias_mes_atual
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 0 month), month)
       and dt_data <= current_date
)

, cte_tempo_mes_anterior as (
    select count(distinct dt_data) qt_dias_mes_anterior
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 1 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_tempo_tres_meses as (
    select count(distinct dt_data) qt_dias_tres_meses
      from cte_tempo
     where dt_data >= date_trunc(date_sub(current_date(), interval 3 month), month)
       and dt_data <  date_trunc(date_sub(current_date(), interval 0 month), month)
)

, cte_base as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,b.qt_estoque_minimo                as qt_estoque_minimo
         ,b.qt_estoque_atual                 as qt_estoque_atual
         ,b.vl_custo_total                   as vl_custo_total
         ,b.vl_preco_venda                   as vl_preco_venda
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,c.qt_dias_mes_atual                as qt_dias_mes_atual
         ,d.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,e.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_venda_produto  as a
        ,cte_tempo_mes_atual      as c
        ,cte_tempo_mes_anterior   as d
        ,cte_tempo_tres_meses     as e
left join cte_produto        as b 
       on a.cd_produto_bling = b.cd_produto_bling
)

, cte_compra_produto as (
    select cd_compra
          ,cd_produto_bling
          ,qt_item
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_agg_compra_produto`
    where ds_status_compra in ('EM ABERTO')
)

, cte_joins as (
   select a.cd_produto_bling                 as cd_produto_bling
         ,a.cd_produto                       as cd_produto
         ,a.cd_codigo_barras                 as cd_codigo_barras
         ,a.nm_produto                       as nm_produto
         ,a.nm_produto_completo              as nm_produto_completo
         ,a.ds_variacao                      as ds_variacao
         ,a.ds_subcategoria                  as ds_subcategoria
         ,a.ds_categoria                     as ds_categoria
         ,a.ds_classificacao_produto         as ds_classificacao_produto
         ,a.ds_origem_produto                as ds_origem_produto
         ,a.ds_classificacao_abc             as ds_classificacao_abc
         ,a.vl_percentual_participacao       as vl_percentual_participacao
         ,a.qt_estoque_minimo                as qt_estoque_minimo
         ,a.qt_estoque_atual                 as qt_estoque_atual
         ,a.vl_custo_total                   as vl_custo_total
         ,a.vl_preco_venda                   as vl_preco_venda
         ,sum(b.qt_item)                     as qt_item_compra_pendente
         ,a.qt_pecas_mes_atual               as qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior            as qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses              as qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias           as qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual                as qt_dias_mes_atual
         ,a.qt_dias_mes_anterior             as qt_dias_mes_anterior
         ,a.qt_dias_tres_meses               as qt_dias_tres_meses
     from cte_base               as a
left join cte_compra_produto     as b
       on a.cd_produto_bling = b.cd_produto_bling
 group by a.cd_produto_bling
         ,a.cd_produto
         ,a.cd_codigo_barras
         ,a.nm_produto
         ,a.nm_produto_completo
         ,a.ds_variacao
         ,a.ds_subcategoria
         ,a.ds_categoria
         ,a.ds_classificacao_produto
         ,a.ds_origem_produto
         ,a.ds_classificacao_abc
         ,a.vl_percentual_participacao
         ,a.qt_estoque_minimo
         ,a.qt_estoque_atual
         ,a.vl_custo_total
         ,a.vl_preco_venda
         ,a.qt_pecas_mes_atual 
         ,a.qt_pecas_mes_anterior 
         ,a.qt_pecas_tres_meses 
         ,a.qt_pecas_sessenta_dias
         ,a.qt_dias_mes_atual
         ,a.qt_dias_mes_anterior
         ,a.qt_dias_tres_meses
)
  select *
    from cte_joins
order by nm_produto
        ,ds_variacao
    );
  
[0m10:09:22.466218 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8343d350-f00a-439b-9443-c147af0cfcb0&page=queryresults
[0m10:09:25.855884 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_estoque_produto_base (execute): 10:09:20.968888 => 10:09:25.855884
[0m10:09:25.857933 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9227c074-4748-413b-a8f1-6d9b695bb80b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB95695CD0>]}
[0m10:09:25.863510 [info ] [Thread-2  ]: 26 of 26 OK created sql table model dbt_dw_az.tb_estoque_produto_base .......... [[32mCREATE TABLE (155.0 rows, 2.2 MiB processed)[0m in 4.90s]
[0m10:09:25.870093 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_estoque_produto_base
[0m10:09:25.876174 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:09:25.876174 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:09:25.877716 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:09:25.877716 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m10:09:25.878757 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m10:09:25.879332 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_estoque_produto_base' was properly closed.
[0m10:09:25.879332 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_venda_produto_base' was properly closed.
[0m10:09:25.880945 [info ] [MainThread]: 
[0m10:09:25.883990 [info ] [MainThread]: Finished running 13 view models, 13 table models in 0 hours 0 minutes and 41.70 seconds (41.70s).
[0m10:09:25.890879 [debug] [MainThread]: Command end result
[0m10:09:25.912042 [info ] [MainThread]: 
[0m10:09:25.913074 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:09:25.914075 [info ] [MainThread]: 
[0m10:09:25.915091 [info ] [MainThread]: Done. PASS=26 WARN=0 ERROR=0 SKIP=0 TOTAL=26
[0m10:09:25.920208 [debug] [MainThread]: Command `dbt run` succeeded at 10:09:25.919667 after 42.52 seconds
[0m10:09:25.921218 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB90AAA3D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB9417B250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001CB95517250>]}
[0m10:09:25.922244 [debug] [MainThread]: Flushing usage events
[0m10:09:30.949299 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEDF013460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEDDF8C6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEDDF8CAF0>]}


============================== 10:09:30.955470 | 8917fa02-19e4-4fd7-8ce0-9b9fe3049eaf ==============================
[0m10:09:30.955470 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:09:30.956466 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'fail_fast': 'False', 'version_check': 'True', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'warn_error': 'None', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt snapshot', 'static_parser': 'True', 'log_format': 'default', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m10:09:31.941333 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8917fa02-19e4-4fd7-8ce0-9b9fe3049eaf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEE2663FD0>]}
[0m10:09:32.035067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8917fa02-19e4-4fd7-8ce0-9b9fe3049eaf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEE2673850>]}
[0m10:09:32.038630 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:09:32.048508 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:09:32.133120 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:09:32.134112 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:09:32.144570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8917fa02-19e4-4fd7-8ce0-9b9fe3049eaf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEE29754C0>]}
[0m10:09:32.165413 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8917fa02-19e4-4fd7-8ce0-9b9fe3049eaf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEE2953FD0>]}
[0m10:09:32.166418 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:09:32.167416 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8917fa02-19e4-4fd7-8ce0-9b9fe3049eaf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEE2953EE0>]}
[0m10:09:32.170003 [info ] [MainThread]: 
[0m10:09:32.173560 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:09:32.176565 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:09:32.177562 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:09:32.868511 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_stg'
[0m10:09:32.869512 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:09:32.872018 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:09:32.873559 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:09:33.852641 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_stg, now list_igneous-sandbox-381622_snapshots)
[0m10:09:33.853642 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:09:33.891854 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_dbt_dw_dw)
[0m10:09:33.903478 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:09:34.539669 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8917fa02-19e4-4fd7-8ce0-9b9fe3049eaf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEE26D20D0>]}
[0m10:09:34.543693 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:09:34.546688 [info ] [MainThread]: 
[0m10:09:34.565257 [debug] [Thread-1  ]: Began running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:09:34.566259 [info ] [Thread-1  ]: 1 of 1 START snapshot snapshots.snapshot_preco_custo_produto ................... [RUN]
[0m10:09:34.569317 [debug] [Thread-1  ]: Acquiring new bigquery connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto'
[0m10:09:34.571331 [debug] [Thread-1  ]: Began compiling node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:09:34.589538 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (compile): 10:09:34.571331 => 10:09:34.588542
[0m10:09:34.590951 [debug] [Thread-1  ]: Began executing node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:09:34.671531 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:09:34.673602 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */
select * from (
        select vl_preco_venda, vl_custo_cadastro, vl_custo_ultima_compra, vl_preco_venda_por from (
                



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`

            ) subq
    ) as __dbt_sbq
    where false and current_timestamp() = current_timestamp()
    limit 0

    
[0m10:09:35.576759 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:7f2ae73a-8f36-4f17-b5b3-5b5f2b3a5519&page=queryresults
[0m10:09:36.871487 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

        
  
    

    create or replace table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp`
      
    
    

    OPTIONS(
      expiration_timestamp=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 12 hour)
    )
    as (
      with snapshot_query as (

        



    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra 
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base`


    ),

    snapshotted_data as (

        select *,
            cd_produto_bling as dbt_unique_key

        from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
        where dbt_valid_to is null

    ),

    insertions_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            nullif(
    current_timestamp()
, 
    current_timestamp()
) as dbt_valid_to,
            to_hex(md5(concat(coalesce(cast(cd_produto_bling as string), ''), '|',coalesce(cast(
    current_timestamp()
 as string), '')))) as dbt_scd_id

        from snapshot_query
    ),

    updates_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_valid_to

        from snapshot_query
    ),

    deletes_source_data as (

        select
            *,
            cd_produto_bling as dbt_unique_key
        from snapshot_query
    ),
    

    insertions as (

        select
            'insert' as dbt_change_type,
            source_data.*

        from insertions_source_data as source_data
        left outer join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where snapshotted_data.dbt_unique_key is null
           or (
                snapshotted_data.dbt_unique_key is not null
            and (
                (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
            )
        )

    ),

    updates as (

        select
            'update' as dbt_change_type,
            source_data.*,
            snapshotted_data.dbt_scd_id

        from updates_source_data as source_data
        join snapshotted_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where (
            (snapshotted_data.`vl_preco_venda` != source_data.`vl_preco_venda`
        or
        (
            ((snapshotted_data.`vl_preco_venda` is null) and not (source_data.`vl_preco_venda` is null))
            or
            ((not snapshotted_data.`vl_preco_venda` is null) and (source_data.`vl_preco_venda` is null))
        ) or snapshotted_data.`vl_custo_cadastro` != source_data.`vl_custo_cadastro`
        or
        (
            ((snapshotted_data.`vl_custo_cadastro` is null) and not (source_data.`vl_custo_cadastro` is null))
            or
            ((not snapshotted_data.`vl_custo_cadastro` is null) and (source_data.`vl_custo_cadastro` is null))
        ) or snapshotted_data.`vl_custo_ultima_compra` != source_data.`vl_custo_ultima_compra`
        or
        (
            ((snapshotted_data.`vl_custo_ultima_compra` is null) and not (source_data.`vl_custo_ultima_compra` is null))
            or
            ((not snapshotted_data.`vl_custo_ultima_compra` is null) and (source_data.`vl_custo_ultima_compra` is null))
        ) or snapshotted_data.`vl_preco_venda_por` != source_data.`vl_preco_venda_por`
        or
        (
            ((snapshotted_data.`vl_preco_venda_por` is null) and not (source_data.`vl_preco_venda_por` is null))
            or
            ((not snapshotted_data.`vl_preco_venda_por` is null) and (source_data.`vl_preco_venda_por` is null))
        ))
        )
    ),

    deletes as (

        select
            'delete' as dbt_change_type,
            source_data.*,
            
    current_timestamp()
 as dbt_valid_from,
            
    current_timestamp()
 as dbt_updated_at,
            
    current_timestamp()
 as dbt_valid_to,
            snapshotted_data.dbt_scd_id

        from snapshotted_data
        left join deletes_source_data as source_data on snapshotted_data.dbt_unique_key = source_data.dbt_unique_key
        where source_data.dbt_unique_key is null
    )

    select * from insertions
    union all
    select * from updates
    union all
    select * from deletes

    );
  
    
[0m10:09:37.280744 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:52d83a80-0b7a-49e4-8105-3e8d5890840e&page=queryresults
[0m10:09:39.883862 [debug] [Thread-1  ]: BigQuery adapter: Adding columns ([]) to table `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`".
[0m10:09:40.746408 [debug] [Thread-1  ]: Writing runtime sql for node "snapshot.shibaribrasil.snapshot_preco_custo_produto"
[0m10:09:40.754674 [debug] [Thread-1  ]: On snapshot.shibaribrasil.snapshot_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "snapshot.shibaribrasil.snapshot_preco_custo_produto"} */

      merge into `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto` as DBT_INTERNAL_DEST
    using `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto__dbt_tmp` as DBT_INTERNAL_SOURCE
    on DBT_INTERNAL_SOURCE.dbt_scd_id = DBT_INTERNAL_DEST.dbt_scd_id

    when matched
     and DBT_INTERNAL_DEST.dbt_valid_to is null
     and DBT_INTERNAL_SOURCE.dbt_change_type in ('update', 'delete')
        then update
        set dbt_valid_to = DBT_INTERNAL_SOURCE.dbt_valid_to

    when not matched
     and DBT_INTERNAL_SOURCE.dbt_change_type = 'insert'
        then insert (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)
        values (`cd_produto_bling`, `cd_produto`, `cd_codigo_barras`, `nm_produto`, `ds_variacao`, `vl_custo_cadastro`, `vl_custo_ultima_compra`, `vl_preco_venda`, `vl_preco_venda_por`, `ds_subcategoria`, `ds_categoria`, `ds_classificacao_produto`, `ds_origem_produto`, `fg_produto_base_composicao`, `fg_produto_composicao`, `dt_ultima_compra`, `dbt_updated_at`, `dbt_valid_from`, `dbt_valid_to`, `dbt_scd_id`)


  
[0m10:09:41.233910 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:8c7df341-15e3-4157-80d2-05db581c110e&page=queryresults
[0m10:09:43.254633 [debug] [Thread-1  ]: Timing info for snapshot.shibaribrasil.snapshot_preco_custo_produto (execute): 10:09:34.591950 => 10:09:43.251615
[0m10:09:43.264528 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8917fa02-19e4-4fd7-8ce0-9b9fe3049eaf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEE3A1E040>]}
[0m10:09:43.288347 [info ] [Thread-1  ]: 1 of 1 OK snapshotted snapshots.snapshot_preco_custo_produto ................... [[32mMERGE (0.0 rows, 106.7 KiB processed)[0m in 8.70s]
[0m10:09:43.303563 [debug] [Thread-1  ]: Finished running node snapshot.shibaribrasil.snapshot_preco_custo_produto
[0m10:09:43.315229 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:09:43.316236 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:09:43.317767 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m10:09:43.322376 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_dw' was properly closed.
[0m10:09:43.323374 [debug] [MainThread]: Connection 'snapshot.shibaribrasil.snapshot_preco_custo_produto' was properly closed.
[0m10:09:43.326372 [info ] [MainThread]: 
[0m10:09:43.333746 [info ] [MainThread]: Finished running 1 snapshot in 0 hours 0 minutes and 11.15 seconds (11.15s).
[0m10:09:43.335273 [debug] [MainThread]: Command end result
[0m10:09:43.376314 [info ] [MainThread]: 
[0m10:09:43.377826 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:09:43.380377 [info ] [MainThread]: 
[0m10:09:43.381406 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m10:09:43.386954 [debug] [MainThread]: Command `dbt snapshot` succeeded at 10:09:43.384404 after 12.54 seconds
[0m10:09:43.387931 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEDF013460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEE2713340>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001DEE26067F0>]}
[0m10:09:43.390511 [debug] [MainThread]: Flushing usage events
[0m10:09:48.633739 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F65B073460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F659FEF6D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F659FEFE20>]}


============================== 10:09:48.643185 | 1a302574-9e4f-43eb-9e6c-53d33e810269 ==============================
[0m10:09:48.643185 [info ] [MainThread]: Running with dbt=1.7.4
[0m10:09:48.645131 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': 'C:\\Git\\sb_loja_virtual', 'log_path': 'C:\\Git\\sb_loja_virtual\\logs', 'debug': 'False', 'fail_fast': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select tag:snaps', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'log_format': 'default', 'send_anonymous_usage_stats': 'True'}
[0m10:09:49.621537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1a302574-9e4f-43eb-9e6c-53d33e810269', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F65D1BEB80>]}
[0m10:09:49.705757 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1a302574-9e4f-43eb-9e6c-53d33e810269', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F65E6E07C0>]}
[0m10:09:49.706758 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m10:09:49.713491 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m10:09:49.794567 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m10:09:49.794567 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m10:09:49.801053 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1a302574-9e4f-43eb-9e6c-53d33e810269', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F65E9D80D0>]}
[0m10:09:49.814151 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1a302574-9e4f-43eb-9e6c-53d33e810269', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F65E8EDFD0>]}
[0m10:09:49.815736 [info ] [MainThread]: Found 28 models, 1 snapshot, 14 sources, 0 exposures, 0 metrics, 447 macros, 0 groups, 0 semantic models
[0m10:09:49.817808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1a302574-9e4f-43eb-9e6c-53d33e810269', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F65E8EDAF0>]}
[0m10:09:49.819465 [info ] [MainThread]: 
[0m10:09:49.820508 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m10:09:49.823602 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622'
[0m10:09:49.824666 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:09:50.508040 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_dw'
[0m10:09:50.509638 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:09:50.514777 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_igneous-sandbox-381622_dbt_dw_az'
[0m10:09:50.517152 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m10:09:51.501440 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_dw, now list_igneous-sandbox-381622_dbt_dw_stg)
[0m10:09:51.508002 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:09:51.519640 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_igneous-sandbox-381622_dbt_dw_az, now list_igneous-sandbox-381622_snapshots)
[0m10:09:51.533375 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m10:09:52.346539 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1a302574-9e4f-43eb-9e6c-53d33e810269', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F65E668EB0>]}
[0m10:09:52.352155 [info ] [MainThread]: Concurrency: 2 threads (target='dev')
[0m10:09:52.358719 [info ] [MainThread]: 
[0m10:09:52.388551 [debug] [Thread-1  ]: Began running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:09:52.396676 [info ] [Thread-1  ]: 1 of 2 START sql table model dbt_dw_az.tb_hist_preco_custo_produto ............. [RUN]
[0m10:09:52.404273 [debug] [Thread-1  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_hist_preco_custo_produto'
[0m10:09:52.406277 [debug] [Thread-1  ]: Began compiling node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:09:52.440235 [debug] [Thread-1  ]: Writing injected SQL for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m10:09:52.444253 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (compile): 10:09:52.408818 => 10:09:52.442249
[0m10:09:52.446268 [debug] [Thread-1  ]: Began executing node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:09:52.472299 [debug] [Thread-1  ]: Opening a new connection, currently in state init
[0m10:09:53.373521 [debug] [Thread-1  ]: Writing runtime sql for node "model.shibaribrasil.tb_hist_preco_custo_produto"
[0m10:09:53.378526 [debug] [Thread-1  ]: On model.shibaribrasil.tb_hist_preco_custo_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_hist_preco_custo_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_base as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,date(dbt_valid_from, "America/Sao_Paulo")                                                        as dt_ini_vigencia
          ,time(dbt_valid_from, "America/Sao_Paulo")                                                        as hr_ini_vigencia
          ,coalesce(date(dbt_valid_to, "America/Sao_Paulo"), date(dbt_updated_at, "America/Sao_Paulo"))     as dt_fim_vigencia
          ,coalesce(time(dbt_valid_to, "America/Sao_Paulo"), time(dbt_updated_at, "America/Sao_Paulo"))     as hr_fim_vigencia
          ,datetime(dbt_updated_at, "America/Sao_Paulo")                                                    as dt_ultima_atualizacao
     from `igneous-sandbox-381622`.`snapshots`.`snapshot_preco_custo_produto`
    -- where concat(date(dbt_valid_from, "America/Sao_Paulo"), ' ', time(dbt_valid_from, "America/Sao_Paulo")) not in ('2025-07-16 16:57:12.010830') --reprocessamento para incremento de coluna
)

, cte_snapshot as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,row_number() over (partition by cd_produto_bling order by dt_ini_vigencia desc, hr_ini_vigencia desc) as nr_linha
     from cte_base
)

, cte_produtos_mudanca as (
  select * 
    from cte_snapshot
   where nr_linha > 1
)

    select a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,coalesce(a.vl_custo_cadastro, 0)      as vl_custo_cadastro
          ,coalesce(a.vl_custo_ultima_compra, 0) as vl_custo_ultima_compra
          ,coalesce(a.vl_preco_venda, 0)         as vl_preco_venda
          ,coalesce(a.vl_preco_venda_por, 0)     as vl_preco_venda_por
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.fg_produto_base_composicao
          ,a.fg_produto_composicao
          ,a.dt_ultima_compra
          ,a.dt_ini_vigencia
          ,a.hr_ini_vigencia
          ,a.dt_fim_vigencia
          ,a.hr_fim_vigencia
          ,a.dt_ultima_atualizacao
          ,a.nr_linha
          ,if(b.cd_produto_bling is not null, true, false)                                               as fg_alteracao
          ,lead(a.vl_custo_cadastro)      over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_cadastro_anterior
          ,lead(a.vl_custo_ultima_compra) over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_custo_ultima_compra_anterior
          ,lead(a.vl_preco_venda)         over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_anterior
          ,lead(a.vl_preco_venda_por)     over (partition by a.cd_produto_bling order by a.nr_linha asc) as vl_preco_por_anterior
          
     from cte_snapshot         as a
left join cte_produtos_mudanca as b
       on a.cd_produto_bling = b.cd_produto_bling
 order by nm_produto
         ,ds_variacao
    );
  
[0m10:09:53.818721 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:25dcef19-5b15-411c-93b9-dbff787a9723&page=queryresults
[0m10:09:56.171405 [debug] [Thread-1  ]: Timing info for model.shibaribrasil.tb_hist_preco_custo_produto (execute): 10:09:52.446268 => 10:09:56.169840
[0m10:09:56.174385 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1a302574-9e4f-43eb-9e6c-53d33e810269', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F65FA524F0>]}
[0m10:09:56.176383 [info ] [Thread-1  ]: 1 of 2 OK created sql table model dbt_dw_az.tb_hist_preco_custo_produto ........ [[32mCREATE TABLE (494.0 rows, 90.6 KiB processed)[0m in 3.77s]
[0m10:09:56.180447 [debug] [Thread-1  ]: Finished running node model.shibaribrasil.tb_hist_preco_custo_produto
[0m10:09:56.183475 [debug] [Thread-2  ]: Began running node model.shibaribrasil.tb_preco_produto
[0m10:09:56.186472 [info ] [Thread-2  ]: 2 of 2 START sql table model dbt_dw_az.tb_preco_produto ........................ [RUN]
[0m10:09:56.191614 [debug] [Thread-2  ]: Acquiring new bigquery connection 'model.shibaribrasil.tb_preco_produto'
[0m10:09:56.193588 [debug] [Thread-2  ]: Began compiling node model.shibaribrasil.tb_preco_produto
[0m10:09:56.209707 [debug] [Thread-2  ]: Writing injected SQL for node "model.shibaribrasil.tb_preco_produto"
[0m10:09:56.215137 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (compile): 10:09:56.194584 => 10:09:56.213245
[0m10:09:56.216765 [debug] [Thread-2  ]: Began executing node model.shibaribrasil.tb_preco_produto
[0m10:09:56.225361 [debug] [Thread-2  ]: Opening a new connection, currently in state init
[0m10:09:57.215874 [debug] [Thread-2  ]: Writing runtime sql for node "model.shibaribrasil.tb_preco_produto"
[0m10:09:57.223626 [debug] [Thread-2  ]: On model.shibaribrasil.tb_preco_produto: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "shibaribrasil", "target_name": "dev", "node_id": "model.shibaribrasil.tb_preco_produto"} */

  
    

    create or replace table `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto`
      
    
    

    OPTIONS(
      description=""""""
    )
    as (
      

with cte_preco as (
    select distinct
           cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,qt_estoque_atual
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,ds_tipo_produto
          ,fg_produto_composicao
          ,fg_produto_base_composicao
          ,fg_produto_fabricado
          ,pr_desconto_padrao 
          ,pr_meta_margem 
          ,tx_aliquota_cartao
          ,tx_fixa_cartao
          ,tx_aliquota_pix
          ,vl_desconto_fixo_pix
          ,vl_materiais_envio
          ,dt_ultima_compra
          ,dt_ultima_ingestao
          ,dt_ultima_atualizacao
      from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_preco_produto_base` 
)

, cte_hist as (
    select cd_produto_bling
          ,cd_produto
          ,cd_codigo_barras
          ,nm_produto
          ,ds_variacao
          ,vl_custo_cadastro
          ,vl_custo_ultima_compra
          ,vl_preco_venda
          ,vl_preco_venda_por
          ,ds_subcategoria
          ,ds_categoria
          ,ds_classificacao_produto
          ,ds_origem_produto
          ,fg_produto_base_composicao
          ,fg_produto_composicao
          ,dt_ultima_compra
          ,dt_ini_vigencia
          ,hr_ini_vigencia
          ,dt_fim_vigencia
          ,hr_fim_vigencia
          ,dt_ultima_atualizacao
          ,nr_linha
          ,fg_alteracao
          ,vl_custo_cadastro_anterior
          ,vl_custo_ultima_compra_anterior
          ,vl_preco_anterior
          ,vl_preco_por_anterior
     from `igneous-sandbox-381622`.`dbt_dw_az`.`tb_hist_preco_custo_produto` 
    where nr_linha = 1
)

, cte_base as (
    select distinct
           a.cd_produto_bling
          ,a.cd_produto
          ,a.cd_codigo_barras
          ,a.nm_produto
          ,a.ds_variacao
          ,a.qt_estoque_atual
          ,a.vl_custo_cadastro
          ,a.vl_custo_ultima_compra
          ,a.vl_preco_venda
          ,a.vl_preco_venda_por
          ,b.vl_custo_cadastro_anterior
          ,b.vl_custo_ultima_compra_anterior
          ,b.vl_preco_anterior
          ,b.vl_preco_por_anterior
          ,a.ds_subcategoria
          ,a.ds_categoria
          ,a.ds_classificacao_produto
          ,a.ds_origem_produto
          ,a.ds_tipo_produto
          ,a.fg_produto_composicao
          ,a.fg_produto_base_composicao
          ,a.fg_produto_fabricado
          ,b.fg_alteracao
          ,a.pr_desconto_padrao 
          ,a.pr_meta_margem 
          ,a.tx_aliquota_cartao
          ,a.tx_fixa_cartao
          ,a.tx_aliquota_pix
          ,a.vl_desconto_fixo_pix
          ,a.vl_materiais_envio
          ,b.dt_ini_vigencia
          ,a.dt_ultima_compra
          ,a.dt_ultima_ingestao
          ,a.dt_ultima_atualizacao
      from cte_preco as a
 left join cte_hist  as b 
        on a.cd_produto_bling = b.cd_produto_bling
)

  select *
    from cte_base
order by nm_produto
        ,ds_variacao
    );
  
[0m10:09:57.663248 [debug] [Thread-2  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=igneous-sandbox-381622&j=bq:us-east4:bc8897a6-d29d-42f8-b0f8-28f1699582c5&page=queryresults
[0m10:09:59.564373 [debug] [Thread-2  ]: Timing info for model.shibaribrasil.tb_preco_produto (execute): 10:09:56.217783 => 10:09:59.564373
[0m10:09:59.565373 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1a302574-9e4f-43eb-9e6c-53d33e810269', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F65FA7B430>]}
[0m10:09:59.565373 [info ] [Thread-2  ]: 2 of 2 OK created sql table model dbt_dw_az.tb_preco_produto ................... [[32mCREATE TABLE (356.0 rows, 110.4 KiB processed)[0m in 3.38s]
[0m10:09:59.566382 [debug] [Thread-2  ]: Finished running node model.shibaribrasil.tb_preco_produto
[0m10:09:59.567893 [debug] [MainThread]: Connection 'master' was properly closed.
[0m10:09:59.567893 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622' was properly closed.
[0m10:09:59.569402 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_dbt_dw_stg' was properly closed.
[0m10:09:59.569402 [debug] [MainThread]: Connection 'list_igneous-sandbox-381622_snapshots' was properly closed.
[0m10:09:59.570412 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_hist_preco_custo_produto' was properly closed.
[0m10:09:59.570412 [debug] [MainThread]: Connection 'model.shibaribrasil.tb_preco_produto' was properly closed.
[0m10:09:59.572306 [info ] [MainThread]: 
[0m10:09:59.572306 [info ] [MainThread]: Finished running 2 table models in 0 hours 0 minutes and 9.75 seconds (9.75s).
[0m10:09:59.573815 [debug] [MainThread]: Command end result
[0m10:09:59.591410 [info ] [MainThread]: 
[0m10:09:59.592423 [info ] [MainThread]: [32mCompleted successfully[0m
[0m10:09:59.593424 [info ] [MainThread]: 
[0m10:09:59.594417 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m10:09:59.595450 [debug] [MainThread]: Command `dbt run` succeeded at 10:09:59.595450 after 11.08 seconds
[0m10:09:59.595450 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F65B073460>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F65E6E07C0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F65E675F10>]}
[0m10:09:59.596449 [debug] [MainThread]: Flushing usage events
